<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_ice_shelf Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('namespacemom__ice__shelf.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">mom_ice_shelf Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implements the thermodynamic aspects of ocean / ice-shelf interactions, along with a crude placeholder for a later implementation of full ice shelf dynamics, all using the MOM framework and coding style. </p>
<h1><a class="anchor" id="section_ICE_SHELF"></a>
section_ICE_SHELF</h1>
<p>This module implements the thermodynamic aspects of ocean/ice-shelf inter-actions using the MOM framework and coding style.</p>
<p>Derived from code by Chris Little, early 2010.</p>
<p>The ice-sheet dynamics subroutines do the following: initialize_shelf_mass - Initializes the ice shelf mass distribution.</p><ul>
<li>Initializes h_shelf, h_mask, area_shelf_h</li>
<li>CURRENTLY: initializes mass_shelf as well, but this is unnecessary, as mass_shelf is initialized based on h_shelf and density_ice immediately afterwards. Possibly subroutine should be renamed update_shelf_mass - updates ice shelf mass via netCDF file USER_update_shelf_mass (TODO). solo_time_step - called only in ice-only mode. shelf_calc_flux - after melt rate &amp; fluxes are calculated, ice dynamics are done. currently mass_shelf is updated immediately after ice_shelf_advect in fully dynamic mode.</li>
</ul>
<p>NOTES: be aware that hmask(:,:) has a number of functions; it is used for front advancement, for subroutines in the velocity solve, and for thickness boundary conditions (this last one may be removed). in other words, interfering with its updates will have implications you might not expect.</p>
<p>Overall issues: Many variables need better documentation and units and the subgrid on which they are discretized.</p>
<h2><a class="anchor" id="section_ICE_SHELF_equations"></a>
ICE_SHELF equations</h2>
<p>The three fundamental equations are: Heat flux </p><p class="formulaDsp">
\[ \qquad \rho_w C_{pw} \gamma_T (T_w - T_b) = \rho_i \dot{m} L_f \]
</p>
<p> Salt flux </p><p class="formulaDsp">
\[ \qquad \rho_w \gamma_s (S_w - S_b) = \rho_i \dot{m} S_b \]
</p>
<p> Freezing temperature </p><p class="formulaDsp">
\[ \qquad T_b = a S_b + b + c P \]
</p>
<p>where ....</p>
<h2><a class="anchor" id="section_ICE_SHELF_references"></a>
References</h2>
<p>Asay-Davis, Xylar S., Stephen L. Cornford, Benjamin K. Galton-Fenzi, Rupert M. Gladstone, G. Hilmar Gudmundsson, David M. Holland, Paul R. Holland, and Daniel F. Martin. Experimental design for three interrelated marine ice sheet and ocean model intercomparison projects: MISMIP v. 3 (MISMIP+), ISOMIP v. 2 (ISOMIP+) and MISOMIP v. 1 (MISOMIP1). Geoscientific Model Development 9, no. 7 (2016): 2471.</p>
<p>Goldberg, D. N., et al. Investigation of land ice-ocean interaction with a fully coupled ice-ocean model: 1. Model description and behavior. Journal of Geophysical Research: Earth Surface 117.F2 (2012).</p>
<p>Goldberg, D. N., et al. Investigation of land ice-ocean interaction with a fully coupled ice-ocean model: 2. Sensitivity to external forcings. Journal of Geophysical Research: Earth Surface 117.F2 (2012).</p>
<p>Holland, David M., and Adrian Jenkins. Modeling thermodynamic ice-ocean interactions at the base of an ice shelf. Journal of Physical Oceanography 29.8 (1999): 1787-1800. </p>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__ice__shelf_1_1ice__shelf__cs.html">ice_shelf_cs</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Control structure that contains ice shelf parameters and diagnostics handles.  <a href="structmom__ice__shelf_1_1ice__shelf__cs.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a84aff10af35c11912502a9cd7834dd50"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__ice__shelf.html#a84aff10af35c11912502a9cd7834dd50">shelf_calc_flux</a> (state, fluxes, Time, time_step, CS, forces)</td></tr>
<tr class="memdesc:a84aff10af35c11912502a9cd7834dd50"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates fluxes between the ocean and ice-shelf using the three-equations formulation (optional to use just two equations). See <a class="el" href="namespacemom__ice__shelf.html#section_ICE_SHELF_equations">ICE_SHELF equations</a>.  <a href="namespacemom__ice__shelf.html#a84aff10af35c11912502a9cd7834dd50">More...</a><br /></td></tr>
<tr class="separator:a84aff10af35c11912502a9cd7834dd50"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a48e3e45926bb7fb3a0a964d4d8a369ce"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__ice__shelf.html#a48e3e45926bb7fb3a0a964d4d8a369ce">change_thickness_using_melt</a> (ISS, G, time_step, fluxes, rho_ice, debug)</td></tr>
<tr class="memdesc:a48e3e45926bb7fb3a0a964d4d8a369ce"><td class="mdescLeft">&#160;</td><td class="mdescRight">Changes the thickness (mass) of the ice shelf based on sub-ice-shelf melting.  <a href="namespacemom__ice__shelf.html#a48e3e45926bb7fb3a0a964d4d8a369ce">More...</a><br /></td></tr>
<tr class="separator:a48e3e45926bb7fb3a0a964d4d8a369ce"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0274b25df07d5fa712d038c31f921cbc"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__ice__shelf.html#a0274b25df07d5fa712d038c31f921cbc">add_shelf_forces</a> (G, US, CS, forces, do_shelf_area)</td></tr>
<tr class="memdesc:a0274b25df07d5fa712d038c31f921cbc"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine adds the mechanical forcing fields and perhaps shelf areas, based on the ice state in ice_shelf_CS.  <a href="namespacemom__ice__shelf.html#a0274b25df07d5fa712d038c31f921cbc">More...</a><br /></td></tr>
<tr class="separator:a0274b25df07d5fa712d038c31f921cbc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aca1d1c1db015f270ce1b1f93d16dea91"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__ice__shelf.html#aca1d1c1db015f270ce1b1f93d16dea91">add_shelf_pressure</a> (G, US, CS, fluxes)</td></tr>
<tr class="memdesc:aca1d1c1db015f270ce1b1f93d16dea91"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine adds the ice shelf pressure to the fluxes type.  <a href="namespacemom__ice__shelf.html#aca1d1c1db015f270ce1b1f93d16dea91">More...</a><br /></td></tr>
<tr class="separator:aca1d1c1db015f270ce1b1f93d16dea91"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac8c626ae15bc80493e6bfa3fb9a6d01e"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__ice__shelf.html#ac8c626ae15bc80493e6bfa3fb9a6d01e">add_shelf_flux</a> (G, US, CS, state, fluxes)</td></tr>
<tr class="memdesc:ac8c626ae15bc80493e6bfa3fb9a6d01e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Updates surface fluxes that are influenced by sub-ice-shelf melting.  <a href="namespacemom__ice__shelf.html#ac8c626ae15bc80493e6bfa3fb9a6d01e">More...</a><br /></td></tr>
<tr class="separator:ac8c626ae15bc80493e6bfa3fb9a6d01e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5990f9918493ff4984245eac74e5f4d9"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__ice__shelf.html#a5990f9918493ff4984245eac74e5f4d9">initialize_ice_shelf</a> (param_file, ocn_grid, Time, CS, diag, forces, fluxes, Time_in, solo_ice_sheet_in)</td></tr>
<tr class="memdesc:a5990f9918493ff4984245eac74e5f4d9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initializes shelf model data, parameters and diagnostics.  <a href="namespacemom__ice__shelf.html#a5990f9918493ff4984245eac74e5f4d9">More...</a><br /></td></tr>
<tr class="separator:a5990f9918493ff4984245eac74e5f4d9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac478a1dd52137f8e851916bee2243fa3"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__ice__shelf.html#ac478a1dd52137f8e851916bee2243fa3">initialize_shelf_mass</a> (G, param_file, CS, ISS, new_sim)</td></tr>
<tr class="memdesc:ac478a1dd52137f8e851916bee2243fa3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initializes shelf mass based on three options (file, zero and user)  <a href="namespacemom__ice__shelf.html#ac478a1dd52137f8e851916bee2243fa3">More...</a><br /></td></tr>
<tr class="separator:ac478a1dd52137f8e851916bee2243fa3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af3b6307aa3522a6b6738f31e232ad2a5"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__ice__shelf.html#af3b6307aa3522a6b6738f31e232ad2a5">update_shelf_mass</a> (G, CS, ISS, Time)</td></tr>
<tr class="memdesc:af3b6307aa3522a6b6738f31e232ad2a5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Updates the ice shelf mass using data from a file.  <a href="namespacemom__ice__shelf.html#af3b6307aa3522a6b6738f31e232ad2a5">More...</a><br /></td></tr>
<tr class="separator:af3b6307aa3522a6b6738f31e232ad2a5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a40ae01bbe3155191647f2150903dda69"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__ice__shelf.html#a40ae01bbe3155191647f2150903dda69">ice_shelf_save_restart</a> (CS, Time, directory, time_stamped, filename_suffix)</td></tr>
<tr class="memdesc:a40ae01bbe3155191647f2150903dda69"><td class="mdescLeft">&#160;</td><td class="mdescRight">Save the ice shelf restart file.  <a href="namespacemom__ice__shelf.html#a40ae01bbe3155191647f2150903dda69">More...</a><br /></td></tr>
<tr class="separator:a40ae01bbe3155191647f2150903dda69"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6d0412c7264e0480d5144d26995dd8d3"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__ice__shelf.html#a6d0412c7264e0480d5144d26995dd8d3">ice_shelf_end</a> (CS)</td></tr>
<tr class="memdesc:a6d0412c7264e0480d5144d26995dd8d3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Deallocates all memory associated with this module.  <a href="namespacemom__ice__shelf.html#a6d0412c7264e0480d5144d26995dd8d3">More...</a><br /></td></tr>
<tr class="separator:a6d0412c7264e0480d5144d26995dd8d3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5331842e995aaf0a57772ccb5a48cdd1"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__ice__shelf.html#a5331842e995aaf0a57772ccb5a48cdd1">solo_time_step</a> (CS, time_step, nsteps, Time, min_time_step_in)</td></tr>
<tr class="memdesc:a5331842e995aaf0a57772ccb5a48cdd1"><td class="mdescLeft">&#160;</td><td class="mdescRight">This routine is for stepping a stand-alone ice shelf model without an ocean.  <a href="namespacemom__ice__shelf.html#a5331842e995aaf0a57772ccb5a48cdd1">More...</a><br /></td></tr>
<tr class="separator:a5331842e995aaf0a57772ccb5a48cdd1"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a5aff3e9a37cb5bc2b5b998bf296437ff"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__ice__shelf.html#a5aff3e9a37cb5bc2b5b998bf296437ff">id_clock_shelf</a></td></tr>
<tr class="memdesc:a5aff3e9a37cb5bc2b5b998bf296437ff"><td class="mdescLeft">&#160;</td><td class="mdescRight">CPU Clock for the ice shelf code.  <a href="namespacemom__ice__shelf.html#a5aff3e9a37cb5bc2b5b998bf296437ff">More...</a><br /></td></tr>
<tr class="separator:a5aff3e9a37cb5bc2b5b998bf296437ff"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3db8709f10aa77ed302598f3a23a608d"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__ice__shelf.html#a3db8709f10aa77ed302598f3a23a608d">id_clock_pass</a></td></tr>
<tr class="memdesc:a3db8709f10aa77ed302598f3a23a608d"><td class="mdescLeft">&#160;</td><td class="mdescRight">CPU Clock for group pass calls.  <a href="namespacemom__ice__shelf.html#a3db8709f10aa77ed302598f3a23a608d">More...</a><br /></td></tr>
<tr class="separator:a3db8709f10aa77ed302598f3a23a608d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="ac8c626ae15bc80493e6bfa3fb9a6d01e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac8c626ae15bc80493e6bfa3fb9a6d01e">&#9670;&nbsp;</a></span>add_shelf_flux()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_ice_shelf::add_shelf_flux </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__ice__shelf_1_1ice__shelf__cs.html">ice_shelf_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(surface), intent(inout)&#160;</td>
          <td class="paramname"><em>state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Updates surface fluxes that are influenced by sub-ice-shelf melting. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>This module's control structure. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">state</td><td>Surface ocean state </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>A structure of surface fluxes that may be used/updated. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__ice__shelf_8F90_source.html#l00864">864</a> of file <a class="el" href="MOM__ice__shelf_8F90_source.html">MOM_ice_shelf.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(inout)</span> :: G<span class="comment">    !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type), <span class="keywordtype">intent(in)</span>    :: US<span class="comment">   !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_CS),    <span class="keywordtype">pointer</span>       :: CS<span class="comment">   !&lt; This module&#39;s control structure.</span></div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;  <span class="keywordtype">type</span>(surface),         <span class="keywordtype">intent(inout)</span> :: state<span class="comment">!&lt; Surface ocean state</span></div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;  <span class="keywordtype">type</span>(forcing),         <span class="keywordtype">intent(inout)</span> :: fluxes<span class="comment">  !&lt; A structure of surface fluxes that may be used/updated.</span></div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160; </div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;  <span class="comment">! local variables</span></div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;<span class="keywordtype">  real</span> :: Irho0<span class="comment">           !&lt; The inverse of the mean density [m3 kg-1].</span></div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;<span class="keywordtype">  real</span> :: frac_area<span class="comment">       !&lt; The fractional area covered by the ice shelf [nondim].</span></div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;<span class="keywordtype">  real</span> :: shelf_mass0<span class="comment">     !&lt; Total ice shelf mass at previous time (Time-dt).</span></div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;<span class="keywordtype">  real</span> :: shelf_mass1<span class="comment">     !&lt; Total ice shelf mass at current time (Time).</span></div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;<span class="keywordtype">  real</span> :: delta_mass_shelf<span class="comment">!&lt; Change in ice shelf mass over one time step [kg s-1]</span></div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;<span class="keywordtype">  real</span> :: taux2, tauy2<span class="comment">    !&lt; The squared surface stresses [Pa].</span></div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;<span class="keywordtype">  real</span> :: press_ice<span class="comment">       !&lt; The pressure of the ice shelf per unit area of ocean (not ice) [Pa].</span></div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;<span class="keywordtype">  real</span> :: asu1, asu2<span class="comment">      !&lt; Ocean areas covered by ice shelves at neighboring u-</span></div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;<span class="keywordtype">  real</span> :: asv1, asv2<span class="comment">      !&lt; and v-points [m2].</span></div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;<span class="keywordtype">  real</span> :: fraz<span class="comment">            !&lt; refreezing rate [kg m-2 s-1]</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;<span class="keywordtype">  real</span> :: mean_melt_flux<span class="comment">  !&lt; spatial mean melt flux [kg s-1] or [kg m-2 s-1] at various points in the code.</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;<span class="keywordtype">  real</span> :: sponge_area<span class="comment">     !&lt; total area of sponge region [m2]</span></div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;<span class="keywordtype">  real</span> :: t0<span class="comment">              !&lt; The previous time (Time-dt) [s].</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;  <span class="keywordtype">type</span>(time_type) :: Time0<span class="comment">!&lt; The previous time (Time-dt)</span></div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZDI_(G),SZDJ_(G))</span> :: last_mass_shelf<span class="comment"> !&lt; Ice shelf mass</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;<span class="comment">                          !! at at previous time (Time-dt) [kg m-2]</span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZDI_(G),SZDJ_(G))</span>  :: last_h_shelf<span class="comment"> !&lt; Ice shelf thickness [Z ~&gt; m]</span></div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;<span class="comment">                          !! at at previous time (Time-dt)</span></div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZDI_(G),SZDJ_(G))</span>  :: last_hmask<span class="comment"> !&lt; Ice shelf mask</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;<span class="comment">                          !! at at previous time (Time-dt)</span></div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZDI_(G),SZDJ_(G))</span>  :: last_area_shelf_h<span class="comment"> !&lt; Ice shelf area [m2]</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;<span class="comment">                          !! at at previous time (Time-dt)</span></div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_state), <span class="keywordtype">pointer</span> :: ISS =&gt; null() <span class="comment">!&lt; A structure with elements that describe</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;<span class="comment">                                          !! the ice-shelf state</span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160; </div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="keywordtype">  real</span> :: kv_rho_ice <span class="comment">! The viscosity of ice divided by its density [m5 kg-1 s-1]</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: rho_fw = 1000.0 <span class="comment">! fresh water density</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;  <span class="keywordtype">character(len=160)</span> :: mesg  <span class="comment">! The text of an error message</span></div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je, isd, ied, jsd, jed</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;  isd = g%isd ; jsd = g%jsd ; ied = g%ied ; jed = g%jed</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160; </div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;  <span class="keywordflow">if</span> ((cs%grid%isc /= g%isc) .or. (cs%grid%iec /= g%iec) .or. &amp;</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;      (cs%grid%jsc /= g%jsc) .or. (cs%grid%jec /= g%jec)) &amp;</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;add_shelf_flux: Incompatible ocean and ice shelf grids.&quot;</span>)</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160; </div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;  iss =&gt; cs%ISS</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160; </div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;  <span class="keyword">call </span>add_shelf_pressure(g, us, cs, fluxes)</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160; </div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;  <span class="comment">! Determine ustar and the square magnitude of the velocity in the</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;  <span class="comment">! bottom boundary layer. Together these give the TKE source and</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;  <span class="comment">! vertical decay scale.</span></div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160; </div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(state%taux_shelf) .and. <span class="keyword">associated</span>(state%tauy_shelf)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;      <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;tau[xy]_shelf&quot;</span>, state%taux_shelf, state%tauy_shelf, &amp;</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;                    g%HI, haloshift=0)</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160; </div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(state%taux_shelf) .and. <span class="keyword">associated</span>(state%tauy_shelf)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    <span class="keyword">call </span>pass_vector(state%taux_shelf, state%tauy_shelf, g%domain, to_all, cgrid_ne)</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;  <span class="comment">! GMM: melting is computed using ustar_shelf (and not ustar), which has already</span></div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;  <span class="comment">! been passed, I so believe we do not need to update fluxes%ustar.</span></div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="comment">!  Irho0 = 1.0 / CS%Rho0</span></div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;<span class="comment">!  do j=js,je ; do i=is,ie ; if (fluxes%frac_shelf_h(i,j) &gt; 0.0) then</span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    <span class="comment">! ### THIS SHOULD BE AN AREA WEIGHTED AVERAGE OF THE ustar_shelf POINTS.</span></div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    <span class="comment">! taux2 = 0.0 ; tauy2 = 0.0</span></div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    <span class="comment">! asu1 = (ISS%area_shelf_h(i-1,j) + ISS%area_shelf_h(i,j))</span></div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    <span class="comment">! asu2 = (ISS%area_shelf_h(i,j) + ISS%area_shelf_h(i+1,j))</span></div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    <span class="comment">! asv1 = (ISS%area_shelf_h(i,j-1) + ISS%area_shelf_h(i,j))</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <span class="comment">! asv2 = (ISS%area_shelf_h(i,j) + ISS%area_shelf_h(i,j+1))</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    <span class="comment">! if ((asu1 + asu2 &gt; 0.0) .and. associated(state%taux_shelf)) &amp;</span></div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    <span class="comment">!   taux2 = (asu1 * state%taux_shelf(I-1,j)**2 + &amp;</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    <span class="comment">!            asu2 * state%taux_shelf(I,j)**2  ) / (asu1 + asu2)</span></div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;    <span class="comment">! if ((asv1 + asv2 &gt; 0.0) .and. associated(state%tauy_shelf)) &amp;</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    <span class="comment">!   tauy2 = (asv1 * state%tauy_shelf(i,J-1)**2 + &amp;</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    <span class="comment">!            asv2 * state%tauy_shelf(i,J)**2  ) / (asv1 + asv2)</span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160; </div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    <span class="comment">! fluxes%ustar(i,j) = MAX(CS%ustar_bg, US%m_to_Z*US%T_to_s*sqrt(Irho0 * sqrt(taux2 + tauy2)))</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;<span class="comment">!  endif ; enddo ; enddo</span></div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160; </div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;  <span class="keywordflow">if</span> (cs%active_shelf_dynamics .or. cs%override_shelf_movement) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;    <span class="keywordflow">do</span> j=jsd,jed ; <span class="keywordflow">do</span> i=isd,ied</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;      <span class="keywordflow">if</span> (g%areaT(i,j) &gt; 0.0) &amp;</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;        fluxes%frac_shelf_h(i,j) = iss%area_shelf_h(i,j) * us%m_to_L**2*g%IareaT(i,j)</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160; </div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (iss%area_shelf_h(i,j) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;    frac_area = fluxes%frac_shelf_h(i,j)  <span class="comment">!### Should this be 1-frac_shelf_h?</span></div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%sw)) fluxes%sw(i,j) = 0.0</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%sw_vis_dir)) fluxes%sw_vis_dir(i,j) = 0.0</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%sw_vis_dif)) fluxes%sw_vis_dif(i,j) = 0.0</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%sw_nir_dir)) fluxes%sw_nir_dir(i,j) = 0.0</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%sw_nir_dif)) fluxes%sw_nir_dif(i,j) = 0.0</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%lw)) fluxes%lw(i,j) = 0.0</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%latent)) fluxes%latent(i,j) = 0.0</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%evap)) fluxes%evap(i,j) = 0.0</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%lprec)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;      <span class="keywordflow">if</span> (iss%water_flux(i,j) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        fluxes%lprec(i,j) =  frac_area*iss%water_flux(i,j)*cs%flux_factor</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;        fluxes%lprec(i,j) = 0.0</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        fluxes%evap(i,j) = frac_area*iss%water_flux(i,j)*cs%flux_factor</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160; </div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%sens)) &amp;</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;      fluxes%sens(i,j) = -frac_area*iss%tflux_ocn(i,j)*cs%flux_factor</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%salt_flux)) &amp;</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;      fluxes%salt_flux(i,j) = frac_area * iss%salt_flux(i,j)*cs%flux_factor</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160; </div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;  <span class="comment">! keep sea level constant by removing mass in the sponge</span></div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;  <span class="comment">! region (via virtual precip, vprec). Apply additional</span></div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;  <span class="comment">! salt/heat fluxes so that the resultant surface buoyancy</span></div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;  <span class="comment">! forcing is ~ 0.</span></div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;  <span class="comment">! This is needed for some of the ISOMIP+ experiments.</span></div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160; </div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;  <span class="keywordflow">if</span> (cs%constant_sea_level) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;    <span class="comment">!### This code has lots of problems with hard coded constants and the use of</span></div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;    <span class="comment">!### of non-reproducing sums.  It needs to be refactored. -RWH</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160; </div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;    <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(fluxes%salt_flux)) <span class="keyword">allocate</span>(fluxes%salt_flux(ie,je))</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;    <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(fluxes%vprec)) <span class="keyword">allocate</span>(fluxes%vprec(ie,je))</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;    fluxes%salt_flux(:,:) = 0.0 ; fluxes%vprec(:,:) = 0.0</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160; </div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;    mean_melt_flux = 0.0; sponge_area = 0.0</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;      frac_area = fluxes%frac_shelf_h(i,j)</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;      <span class="keywordflow">if</span> (frac_area &gt; 0.0) &amp;</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;        mean_melt_flux = mean_melt_flux + (iss%water_flux(i,j)) * iss%area_shelf_h(i,j)</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160; </div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;      <span class="comment">!### These hard-coded limits need to be corrected.  They are inappropriate here.</span></div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;      <span class="keywordflow">if</span> (g%geoLonT(i,j) &gt;= 790.0 .AND. g%geoLonT(i,j) &lt;= 800.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        sponge_area = sponge_area + us%L_to_m**2*g%areaT(i,j)</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160; </div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    <span class="comment">! take into account changes in mass (or thickness) when imposing ice shelf mass</span></div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    <span class="keywordflow">if</span> (cs%override_shelf_movement .and. cs%mass_from_file) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;      t0 = time_type_to_real(cs%Time) - cs%time_step</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160; </div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;      <span class="comment">! just compute changes in mass after first time step</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;      <span class="keywordflow">if</span> (t0&gt;0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;        time0 = real_to_time(t0)</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;        last_hmask(:,:) = iss%hmask(:,:) ; last_area_shelf_h(:,:) = iss%area_shelf_h(:,:)</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;        <span class="keyword">call </span>time_interp_external(cs%id_read_mass, time0, last_mass_shelf)</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;        last_h_shelf(:,:) = last_mass_shelf(:,:) / cs%rho_ice</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160; </div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;        <span class="comment">! apply calving</span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;        <span class="keywordflow">if</span> (cs%min_thickness_simple_calve &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;          <span class="keyword">call </span>ice_shelf_min_thickness_calve(g, last_h_shelf, last_area_shelf_h, last_hmask, &amp;</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;                                       cs%min_thickness_simple_calve)</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;          <span class="comment">! convert to mass again</span></div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;          last_mass_shelf(:,:) = last_h_shelf(:,:) * cs%rho_ice</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160; </div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;        shelf_mass0 = 0.0; shelf_mass1 = 0.0</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;        <span class="comment">! get total ice shelf mass at (Time-dt) and (Time), in kg</span></div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;          <span class="comment">! just floating shelf (0.1 is a threshold for min ocean thickness)</span></div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;          <span class="keywordflow">if</span> (((1.0/cs%density_ocean_avg)*state%ocean_mass(i,j) &gt; 0.1) .and. &amp;</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;              (iss%area_shelf_h(i,j) &gt; 0.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;            shelf_mass0 = shelf_mass0 + (last_mass_shelf(i,j) * iss%area_shelf_h(i,j))</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;            shelf_mass1 = shelf_mass1 + (iss%mass_shelf(i,j) * iss%area_shelf_h(i,j))</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        <span class="keyword">call </span>sum_across_pes(shelf_mass0); <span class="keyword">call </span>sum_across_pes(shelf_mass1)</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        delta_mass_shelf = (shelf_mass1 - shelf_mass0)/cs%time_step</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;<span class="comment">!          delta_mass_shelf = (shelf_mass1 - shelf_mass0)* &amp;</span></div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="comment">!                         (rho_fw/CS%density_ice)/CS%time_step</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;<span class="comment">!        write(mesg,*)&#39;delta_mass_shelf = &#39;,delta_mass_shelf</span></div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;<span class="comment">!        call MOM_mesg(mesg,5)</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;      else<span class="comment">! first time step</span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;        delta_mass_shelf = 0.0</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;    <span class="keywordflow">else</span> <span class="comment">! ice shelf mass does not change</span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;      delta_mass_shelf = 0.0</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160; </div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;    <span class="keyword">call </span>sum_across_pes(mean_melt_flux)</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;    <span class="keyword">call </span>sum_across_pes(sponge_area)</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160; </div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;    <span class="comment">! average total melt flux over sponge area</span></div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;    mean_melt_flux = (mean_melt_flux+delta_mass_shelf) / sponge_area <span class="comment">!kg/(m^2 s)</span></div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160; </div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;    <span class="comment">! apply fluxes</span></div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;      <span class="comment">! Note the following is hard coded for ISOMIP</span></div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;      <span class="keywordflow">if</span> (g%geoLonT(i,j) &gt;= 790.0 .AND. g%geoLonT(i,j) &lt;= 800.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;        fluxes%vprec(i,j) = -mean_melt_flux * cs%density_ice/1000. <span class="comment">! evap is negative</span></div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;        fluxes%sens(i,j) = fluxes%vprec(i,j) * cs%Cp * cs%T0 <span class="comment">! W /m^2</span></div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;        fluxes%salt_flux(i,j) = fluxes%vprec(i,j) * cs%S0*1.0e-3 <span class="comment">! kg (salt)/(m^2 s)</span></div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160; </div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;      <span class="keyword">write</span>(mesg,*) <span class="stringliteral">&#39;Mean melt flux (kg/(m^2 s)), dt = &#39;</span>, mean_melt_flux, cs%time_step</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;      <span class="keyword">call </span>mom_mesg(mesg)</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;      <span class="keyword">call </span>mom_forcing_chksum(<span class="stringliteral">&quot;After constant sea level&quot;</span>, fluxes, g, cs%US, haloshift=0)</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160; </div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">!constant_sea_level</span></div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__ice__shelf_8F90_source.html#l00835">add_shelf_pressure()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00053">mom_error_handler::mom_mesg()</a>, <a class="el" href="MOM__time__manager_8F90_source.html#l00047">mom_time_manager::real_to_time()</a>, and <a class="el" href="MOM__domains_8F90_source.html#l00132">mom_domains::to_all</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__ice__shelf_8F90_source.html#l00193">shelf_calc_flux()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_ac8c626ae15bc80493e6bfa3fb9a6d01e_cgraph.svg" width="100%" height="465"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_ac8c626ae15bc80493e6bfa3fb9a6d01e_icgraph.svg" width="496" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a0274b25df07d5fa712d038c31f921cbc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0274b25df07d5fa712d038c31f921cbc">&#9670;&nbsp;</a></span>add_shelf_forces()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_ice_shelf::add_shelf_forces </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__ice__shelf_1_1ice__shelf__cs.html">ice_shelf_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(mech_forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>forces</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>do_shelf_area</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine adds the mechanical forcing fields and perhaps shelf areas, based on the ice state in ice_shelf_CS. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>This module's control structure. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">forces</td><td>A structure with the driving mechanical forces </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">do_shelf_area</td><td>If true find the shelf-covered areas. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__ice__shelf_8F90_source.html#l00754">754</a> of file <a class="el" href="MOM__ice__shelf_8F90_source.html">MOM_ice_shelf.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(inout)</span> :: G<span class="comment">    !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type), <span class="keywordtype">intent(in)</span>    :: US<span class="comment">   !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_CS),    <span class="keywordtype">pointer</span>       :: CS<span class="comment">   !&lt; This module&#39;s control structure.</span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;  <span class="keywordtype">type</span>(mech_forcing),    <span class="keywordtype">intent(inout)</span> :: forces<span class="comment"> !&lt; A structure with the driving mechanical forces</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">optional</span>,     <span class="keywordtype">intent(in)</span>    :: do_shelf_area<span class="comment"> !&lt; If true find the shelf-covered areas.</span></div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160; </div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;<span class="keywordtype">  real</span> :: kv_rho_ice <span class="comment">! The viscosity of ice divided by its density [m5 kg-1 s-1].</span></div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;<span class="keywordtype">  real</span> :: press_ice  <span class="comment">! The pressure of the ice shelf per unit area of ocean (not ice) [Pa].</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;  <span class="keywordtype">logical</span> :: find_area <span class="comment">! If true find the shelf areas at u &amp; v points.</span></div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_state), <span class="keywordtype">pointer</span> :: ISS =&gt; null() <span class="comment">! A structure with elements that describe</span></div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;                                          <span class="comment">! the ice-shelf state</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160; </div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je, isd, ied, jsd, jed</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;  isd = g%isd ; jsd = g%jsd ; ied = g%ied ; jed = g%jed</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160; </div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;  <span class="keywordflow">if</span> ((cs%grid%isc /= g%isc) .or. (cs%grid%iec /= g%iec) .or. &amp;</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;      (cs%grid%jsc /= g%jsc) .or. (cs%grid%jec /= g%jec)) &amp;</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;add_shelf_forces: Incompatible ocean and ice shelf grids.&quot;</span>)</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160; </div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;  iss =&gt; cs%ISS</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160; </div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;  find_area = .true. ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(do_shelf_area)) find_area = do_shelf_area</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160; </div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;  <span class="keywordflow">if</span> (find_area) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    <span class="comment">! The frac_shelf is set over the widest possible area. Could it be smaller?</span></div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    <span class="keywordflow">do</span> j=jsd,jed ; <span class="keywordflow">do</span> i=isd,ied-1</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;      forces%frac_shelf_u(i,j) = 0.0</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;      <span class="keywordflow">if</span> ((g%areaT(i,j) + g%areaT(i+1,j) &gt; 0.0)) &amp; <span class="comment">! .and. (G%areaCu(I,j) &gt; 0.0)) &amp;</span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;        forces%frac_shelf_u(i,j) = ((iss%area_shelf_h(i,j) + iss%area_shelf_h(i+1,j)) / &amp;</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;                                    (us%L_to_m**2*g%areaT(i,j) + us%L_to_m**2*g%areaT(i+1,j)))</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    <span class="keywordflow">do</span> j=jsd,jed-1 ; <span class="keywordflow">do</span> i=isd,ied</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;      forces%frac_shelf_v(i,j) = 0.0</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;      <span class="keywordflow">if</span> ((g%areaT(i,j) + g%areaT(i,j+1) &gt; 0.0)) &amp; <span class="comment">! .and. (G%areaCv(i,J) &gt; 0.0)) &amp;</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        forces%frac_shelf_v(i,j) = ((iss%area_shelf_h(i,j) + iss%area_shelf_h(i,j+1)) / &amp;</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;                                    (us%L_to_m**2*g%areaT(i,j) + us%L_to_m**2*g%areaT(i,j+1)))</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    <span class="keyword">call </span>pass_vector(forces%frac_shelf_u, forces%frac_shelf_v, g%domain, to_all, cgrid_ne)</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160; </div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;  <span class="comment">!### Consider working over a smaller array range.</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;  <span class="keywordflow">do</span> j=jsd,jed ; <span class="keywordflow">do</span> i=isd,ied</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    press_ice = (iss%area_shelf_h(i,j) * us%m_to_L**2*g%IareaT(i,j)) * (cs%g_Earth * iss%mass_shelf(i,j))</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(forces%p_surf)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;      <span class="keywordflow">if</span> (.not.forces%accumulate_p_surf) forces%p_surf(i,j) = 0.0</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;      forces%p_surf(i,j) = forces%p_surf(i,j) + press_ice</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(forces%p_surf_full)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;      <span class="keywordflow">if</span> (.not.forces%accumulate_p_surf) forces%p_surf_full(i,j) = 0.0</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;      forces%p_surf_full(i,j) = forces%p_surf_full(i,j) + press_ice</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160; </div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;  <span class="comment">! For various reasons, forces%rigidity_ice_[uv] is always updated here. Note</span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;  <span class="comment">! that it may have been zeroed out where IOB is translated to forces and</span></div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;  <span class="comment">! contributions from icebergs and the sea-ice pack added subsequently.</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;  <span class="comment">!### THE RIGIDITY SHOULD ALSO INCORPORATE AREAL-COVERAGE INFORMATION.</span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;  kv_rho_ice = cs%kv_ice / cs%density_ice</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    <span class="keywordflow">if</span> (.not.forces%accumulate_rigidity) forces%rigidity_ice_u(i,j) = 0.0</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    forces%rigidity_ice_u(i,j) = forces%rigidity_ice_u(i,j) + &amp;</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;            kv_rho_ice * min(iss%mass_shelf(i,j), iss%mass_shelf(i+1,j))</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;  <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    <span class="keywordflow">if</span> (.not.forces%accumulate_rigidity) forces%rigidity_ice_v(i,j) = 0.0</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    forces%rigidity_ice_v(i,j) = forces%rigidity_ice_v(i,j) + &amp;</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;            kv_rho_ice * min(iss%mass_shelf(i,j), iss%mass_shelf(i,j+1))</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160; </div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;rigidity_ice_[uv]&quot;</span>, forces%rigidity_ice_u, forces%rigidity_ice_v, &amp;</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;                  g%HI, symmetric=.true.)</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;frac_shelf_[uv]&quot;</span>, forces%frac_shelf_u, forces%frac_shelf_v, &amp;</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                  g%HI, symmetric=.true.)</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, and <a class="el" href="MOM__domains_8F90_source.html#l00132">mom_domains::to_all</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__ice__shelf_8F90_source.html#l01074">initialize_ice_shelf()</a>, <a class="el" href="MOM__driver_8F90_source.html#l00001">mom_main()</a>, <a class="el" href="MOM__ice__shelf_8F90_source.html#l00193">shelf_calc_flux()</a>, <a class="el" href="mom__ocean__model__mct_8F90_source.html#l00433">mom_ocean_model_mct::update_ocean_model()</a>, and <a class="el" href="mom__ocean__model__nuopc_8F90_source.html#l00439">mom_ocean_model_nuopc::update_ocean_model()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_a0274b25df07d5fa712d038c31f921cbc_cgraph.svg" width="560" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_a0274b25df07d5fa712d038c31f921cbc_icgraph.svg" width="535" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="aca1d1c1db015f270ce1b1f93d16dea91"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aca1d1c1db015f270ce1b1f93d16dea91">&#9670;&nbsp;</a></span>add_shelf_pressure()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_ice_shelf::add_shelf_pressure </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__ice__shelf_1_1ice__shelf__cs.html">ice_shelf_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine adds the ice shelf pressure to the fluxes type. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>This module's control structure. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>A structure of surface fluxes that may be updated. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__ice__shelf_8F90_source.html#l00835">835</a> of file <a class="el" href="MOM__ice__shelf_8F90_source.html">MOM_ice_shelf.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(inout)</span> :: G<span class="comment">    !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type), <span class="keywordtype">intent(in)</span>    :: US<span class="comment">   !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_CS),    <span class="keywordtype">intent(in)</span>    :: CS<span class="comment">   !&lt; This module&#39;s control structure.</span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;  <span class="keywordtype">type</span>(forcing),         <span class="keywordtype">intent(inout)</span> :: fluxes<span class="comment">  !&lt; A structure of surface fluxes that may be updated.</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160; </div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="keywordtype">  real</span> :: press_ice<span class="comment">       !&lt; The pressure of the ice shelf per unit area of ocean (not ice) [Pa].</span></div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je, isd, ied, jsd, jed</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160; </div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;  <span class="keywordflow">if</span> ((cs%grid%isc /= g%isc) .or. (cs%grid%iec /= g%iec) .or. &amp;</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;      (cs%grid%jsc /= g%jsc) .or. (cs%grid%jec /= g%jec)) &amp;</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;add_shelf_pressure: Incompatible ocean and ice shelf grids.&quot;</span>)</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160; </div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    press_ice = (cs%ISS%area_shelf_h(i,j) * us%m_to_L**2*g%IareaT(i,j)) * (cs%g_Earth * cs%ISS%mass_shelf(i,j))</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%p_surf)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;      <span class="keywordflow">if</span> (.not.fluxes%accumulate_p_surf) fluxes%p_surf(i,j) = 0.0</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;      fluxes%p_surf(i,j) = fluxes%p_surf(i,j) + press_ice</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%p_surf_full)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;      <span class="keywordflow">if</span> (.not.fluxes%accumulate_p_surf) fluxes%p_surf_full(i,j) = 0.0</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;      fluxes%p_surf_full(i,j) = fluxes%p_surf_full(i,j) + press_ice</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__ice__shelf_8F90_source.html#l00864">add_shelf_flux()</a>, and <a class="el" href="MOM__ice__shelf_8F90_source.html#l01074">initialize_ice_shelf()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_aca1d1c1db015f270ce1b1f93d16dea91_cgraph.svg" width="560" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_aca1d1c1db015f270ce1b1f93d16dea91_icgraph.svg" width="100%" height="388"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a48e3e45926bb7fb3a0a964d4d8a369ce"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a48e3e45926bb7fb3a0a964d4d8a369ce">&#9670;&nbsp;</a></span>change_thickness_using_melt()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_ice_shelf::change_thickness_using_melt </td>
          <td>(</td>
          <td class="paramtype">type(ice_shelf_state), intent(inout)&#160;</td>
          <td class="paramname"><em>ISS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>time_step</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>rho_ice</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>debug</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Changes the thickness (mass) of the ice shelf based on sub-ice-shelf melting. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">iss</td><td>A structure with elements that describe the ice-shelf state </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time_step</td><td>The time step for this update [s]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>structure containing pointers to any possible thermodynamic or mass-flux forcing fields. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">rho_ice</td><td>The density of ice-shelf ice [kg m-2 Z-1 ~&gt; kg m-3]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">debug</td><td>If present and true, write chksums </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__ice__shelf_8F90_source.html#l00701">701</a> of file <a class="el" href="MOM__ice__shelf_8F90_source.html">MOM_ice_shelf.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(inout)</span> :: G<span class="comment">  !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_state), <span class="keywordtype">intent(inout)</span> :: ISS<span class="comment"> !&lt; A structure with elements that describe</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;<span class="comment">                                              !! the ice-shelf state</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>    :: time_step<span class="comment"> !&lt; The time step for this update [s].</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;  <span class="keywordtype">type</span>(forcing),         <span class="keywordtype">intent(inout)</span> :: fluxes<span class="comment"> !&lt; structure containing pointers to any possible</span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="comment">                                                 !! thermodynamic or mass-flux forcing fields.</span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>    :: rho_ice<span class="comment"> !&lt; The density of ice-shelf ice [kg m-2 Z-1 ~&gt; kg m-3].</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;  <span class="keywordtype">logical</span>,     <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: debug<span class="comment"> !&lt; If present and true, write chksums</span></div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160; </div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;  <span class="comment">! locals</span></div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;<span class="keywordtype">  real</span> :: I_rho_ice</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;  <span class="keywordtype">integer</span> :: i, j</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160; </div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;  i_rho_ice = 1.0 / rho_ice</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160; </div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;  <span class="keywordflow">do</span> j=g%jsc,g%jec ; <span class="keywordflow">do</span> i=g%isc,g%iec</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    <span class="keywordflow">if</span> ((iss%hmask(i,j) == 1) .or. (iss%hmask(i,j) == 2)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;      <span class="comment">! first, zero out fluxes applied during previous time step</span></div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%lprec)) fluxes%lprec(i,j) = 0.0</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%sens)) fluxes%sens(i,j) = 0.0</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%frac_shelf_h)) fluxes%frac_shelf_h(i,j) = 0.0</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%salt_flux)) fluxes%salt_flux(i,j) = 0.0</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160; </div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;      <span class="keywordflow">if</span> (iss%water_flux(i,j) / rho_ice * time_step &lt; iss%h_shelf(i,j)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        iss%h_shelf(i,j) = iss%h_shelf(i,j) - iss%water_flux(i,j) / rho_ice * time_step</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        <span class="comment">! the ice is about to melt away, so set thickness, area, and mask to zero</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        <span class="comment">! NOTE: this is not mass conservative should maybe scale salt &amp; heat flux for this cell</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        iss%h_shelf(i,j) = 0.0</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        iss%hmask(i,j) = 0.0</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        iss%area_shelf_h(i,j) = 0.0</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160; </div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;  <span class="keyword">call </span>pass_var(iss%area_shelf_h, g%domain)</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;  <span class="keyword">call </span>pass_var(iss%h_shelf, g%domain)</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;  <span class="keyword">call </span>pass_var(iss%hmask, g%domain)</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160; </div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;  <span class="comment">!### combine this with the loops above.</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;  <span class="keywordflow">do</span> j=g%jsd,g%jed ; <span class="keywordflow">do</span> i=g%isd,g%ied</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    <span class="keywordflow">if</span> ((iss%hmask(i,j) == 1) .or. (iss%hmask(i,j) == 2)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;      iss%mass_shelf(i,j) = iss%h_shelf(i,j)*rho_ice</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160; </div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;  <span class="keyword">call </span>pass_var(iss%mass_shelf, g%domain)</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__ice__shelf_8F90_source.html#l00193">shelf_calc_flux()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_a48e3e45926bb7fb3a0a964d4d8a369ce_icgraph.svg" width="519" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a6d0412c7264e0480d5144d26995dd8d3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6d0412c7264e0480d5144d26995dd8d3">&#9670;&nbsp;</a></span>ice_shelf_end()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_ice_shelf::ice_shelf_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__ice__shelf_1_1ice__shelf__cs.html">ice_shelf_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Deallocates all memory associated with this module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">cs</td><td>A pointer to the ice shelf control structure </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__ice__shelf_8F90_source.html#l01736">1736</a> of file <a class="el" href="MOM__ice__shelf_8F90_source.html">MOM_ice_shelf.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_CS), <span class="keywordtype">pointer</span>   :: CS<span class="comment"> !&lt; A pointer to the ice shelf control structure</span></div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160; </div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keywordflow">return</span></div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160; </div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;  <span class="keyword">call </span>ice_shelf_state_end(cs%ISS)</div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160; </div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;  <span class="keywordflow">if</span> (cs%active_shelf_dynamics) <span class="keyword">call </span>ice_shelf_dyn_end(cs%dCS)</div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160; </div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;  <span class="keyword">deallocate</span>(cs)</div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__ice__shelf__dynamics_8F90_source.html#l03451">mom_ice_shelf_dynamics::ice_shelf_dyn_end()</a>, and <a class="el" href="MOM__ice__shelf__state_8F90_source.html#l00087">mom_ice_shelf_state::ice_shelf_state_end()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__driver_8F90_source.html#l00001">mom_main()</a>, <a class="el" href="mom__ocean__model__nuopc_8F90_source.html#l00741">mom_ocean_model_nuopc::ocean_model_end()</a>, and <a class="el" href="mom__ocean__model__mct_8F90_source.html#l00746">mom_ocean_model_mct::ocean_model_end()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_a6d0412c7264e0480d5144d26995dd8d3_cgraph.svg" width="382" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_a6d0412c7264e0480d5144d26995dd8d3_icgraph.svg" width="390" height="170"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a40ae01bbe3155191647f2150903dda69"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a40ae01bbe3155191647f2150903dda69">&#9670;&nbsp;</a></span>ice_shelf_save_restart()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_ice_shelf::ice_shelf_save_restart </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__ice__shelf_1_1ice__shelf__cs.html">ice_shelf_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=*), intent(in), optional&#160;</td>
          <td class="paramname"><em>directory</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>time_stamped</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=*), intent(in), optional&#160;</td>
          <td class="paramname"><em>filename_suffix</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Save the ice shelf restart file. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>ice shelf control structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>model time at this call </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">directory</td><td>An optional directory into which to write these restart files. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time_stamped</td><td>f true, the restart file names include a unique time stamp. The default is false. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">filename_suffix</td><td>An optional suffix (e.g., a time-stamp) to append to the restart file names. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__ice__shelf_8F90_source.html#l01713">1713</a> of file <a class="el" href="MOM__ice__shelf_8F90_source.html">MOM_ice_shelf.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_CS),         <span class="keywordtype">pointer</span>    :: CS<span class="comment"> !&lt; ice shelf control structure</span></div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;  <span class="keywordtype">type</span>(time_type),            <span class="keywordtype">intent(in)</span> :: Time<span class="comment"> !&lt; model time at this call</span></div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;  <span class="keywordtype">character(len=*)</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: directory<span class="comment"> !&lt; An optional directory into which to write</span></div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;<span class="comment">                                               !! these restart files.</span></div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;  <span class="keywordtype">logical</span>,          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: time_stamped<span class="comment"> !&lt; f true, the restart file names include</span></div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;<span class="comment">                                               !! a unique time stamp.  The default is false.</span></div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;  <span class="keywordtype">character(len=*)</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: filename_suffix<span class="comment"> !&lt; An optional suffix (e.g., a</span></div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;<span class="comment">                                               !! time-stamp) to append to the restart file names.</span></div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;  <span class="comment">! local variables</span></div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">pointer</span> :: G =&gt; null()</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;  <span class="keywordtype">character(len=200)</span> :: restart_dir</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160; </div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;  g =&gt; cs%grid</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160; </div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(directory)) <span class="keywordflow">then</span> ; restart_dir = directory</div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;  <span class="keywordflow">else</span> ; restart_dir = cs%restart_output_dir ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160; </div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;  <span class="keyword">call </span>save_restart(restart_dir, time, cs%grid, cs%restart_CSp, time_stamped)</div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__driver_8F90_source.html#l00001">mom_main()</a>, <a class="el" href="mom__ocean__model__nuopc_8F90_source.html#l00689">mom_ocean_model_nuopc::ocean_model_restart()</a>, <a class="el" href="mom__ocean__model__mct_8F90_source.html#l00694">mom_ocean_model_mct::ocean_model_restart()</a>, <a class="el" href="mom__ocean__model__nuopc_8F90_source.html#l00758">mom_ocean_model_nuopc::ocean_model_save_restart()</a>, <a class="el" href="mom__ocean__model__mct_8F90_source.html#l00764">mom_ocean_model_mct::ocean_model_save_restart()</a>, and <a class="el" href="ocn__comp__mct_8F90_source.html#l00408">ocn_comp_mct::ocn_run_mct()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_a40ae01bbe3155191647f2150903dda69_icgraph.svg" width="648" height="351"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a5990f9918493ff4984245eac74e5f4d9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5990f9918493ff4984245eac74e5f4d9">&#9670;&nbsp;</a></span>initialize_ice_shelf()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_ice_shelf::initialize_ice_shelf </td>
          <td>(</td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), pointer&#160;</td>
          <td class="paramname"><em>ocn_grid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(inout)&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__ice__shelf_1_1ice__shelf__cs.html">ice_shelf_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(in), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(mech_forcing), intent(inout), optional&#160;</td>
          <td class="paramname"><em>forces</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(inout), optional&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(in), optional&#160;</td>
          <td class="paramname"><em>Time_in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>solo_ice_sheet_in</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initializes shelf model data, parameters and diagnostics. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>A structure to parse for run-time parameters </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">ocn_grid</td><td>The calling ocean model's horizontal grid structure </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">time</td><td>The clock that that will indicate the model time </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>A pointer to the ice shelf control structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">diag</td><td>A structure that is used to regulate the diagnostic output. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>A structure containing pointers to any possible thermodynamic or mass-flux forcing fields. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">forces</td><td>A structure with the driving mechanical forces </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time_in</td><td>The time at initialization. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">solo_ice_sheet_in</td><td>If present, this indicates whether a solo ice-sheet driver. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__ice__shelf_8F90_source.html#l01074">1074</a> of file <a class="el" href="MOM__ice__shelf_8F90_source.html">MOM_ice_shelf.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;  <span class="keywordtype">type</span>(param_file_type),        <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; A structure to parse for run-time parameters</span></div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),        <span class="keywordtype">pointer</span>       :: ocn_grid<span class="comment">   !&lt; The calling ocean model&#39;s horizontal grid structure</span></div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;  <span class="keywordtype">type</span>(time_type),              <span class="keywordtype">intent(inout)</span> :: Time<span class="comment"> !&lt; The clock that that will indicate the model time</span></div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_CS),           <span class="keywordtype">pointer</span>       :: CS<span class="comment">   !&lt; A pointer to the ice shelf control structure</span></div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl),    <span class="keywordtype">target</span>,   <span class="keywordtype">intent(in)</span>    :: diag<span class="comment"> !&lt; A structure that is used to regulate the diagnostic output.</span></div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;  <span class="keywordtype">type</span>(forcing),      <span class="keywordtype">optional</span>, <span class="keywordtype">intent(inout)</span> :: fluxes<span class="comment"> !&lt; A structure containing pointers to any possible</span></div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;<span class="comment">                                                   !! thermodynamic or mass-flux forcing fields.</span></div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;  <span class="keywordtype">type</span>(mech_forcing), <span class="keywordtype">optional</span>, <span class="keywordtype">intent(inout)</span> :: forces<span class="comment"> !&lt; A structure with the driving mechanical forces</span></div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;  <span class="keywordtype">type</span>(time_type),    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: Time_in<span class="comment"> !&lt; The time at initialization.</span></div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;  <span class="keywordtype">logical</span>,            <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: solo_ice_sheet_in<span class="comment"> !&lt; If present, this indicates whether</span></div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="comment">                                                   !! a solo ice-sheet driver.</span></div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160; </div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">pointer</span> :: G  =&gt; null(), og  =&gt; null() <span class="comment">! Pointers to grids for convenience.</span></div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type), <span class="keywordtype">pointer</span> :: US =&gt; null() <span class="comment">! Pointer to a structure containing</span></div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;                                                 <span class="comment">! various unit conversion factors</span></div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_state), <span class="keywordtype">pointer</span> :: ISS =&gt; null() <span class="comment">!&lt; A structure with elements that describe</span></div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;<span class="comment">                                          !! the ice-shelf state</span></div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;  <span class="keywordtype">type</span>(directories)  :: dirs</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;  <span class="keywordtype">type</span>(dyn_horgrid_type), <span class="keywordtype">pointer</span> :: dG =&gt; null()</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;<span class="keywordtype">  real</span>    :: Z_rescale  <span class="comment">! A rescaling factor for heights from the representation in</span></div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;                        <span class="comment">! a reastart fole to the internal representation in this run.</span></div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;<span class="keywordtype">  real</span> :: cdrag, drag_bg_vel</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;  <span class="keywordtype">logical</span> :: new_sim, save_IC, var_force</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;  <span class="comment">!This include declares and sets the variable &quot;version&quot;.</span></div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=200)</span> :: config</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;  <span class="keywordtype">character(len=200)</span> :: IC_file,filename,inputdir</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_ice_shelf&quot;</span>  <span class="comment">! This module&#39;s name.</span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je, isd, ied, jsd, jed, Isdq, Iedq, Jsdq, Jedq</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;  <span class="keywordtype">integer</span> :: wd_halos(2)</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;  <span class="keywordtype">logical</span> :: read_TideAmp, shelf_mass_is_dynamic, debug</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;  <span class="keywordtype">character(len=240)</span> :: Tideamp_file</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;<span class="keywordtype">  real</span>    :: utide</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_ice_shelf.F90, initialize_ice_shelf: &quot;</span>// &amp;</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;                          <span class="stringliteral">&quot;called with an associated control structure.&quot;</span>)</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;    <span class="keywordflow">return</span></div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;  <span class="keyword">allocate</span>(cs)</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160; </div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;  <span class="comment">!   Go through all of the infrastructure initialization calls, since this is</span></div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;  <span class="comment">! being treated as an independent component that just happens to use the</span></div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;  <span class="comment">! MOM&#39;s grid and infrastructure.</span></div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;  <span class="keyword">call </span>get_mom_input(dirs=dirs)</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160; </div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;  <span class="comment">! Determining the internal unit scaling factors for this run.</span></div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;  <span class="keyword">call </span>unit_scaling_init(param_file, cs%US)</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160; </div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;  <span class="comment">! Set up the ice-shelf domain and grid</span></div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;  wd_halos(:)=0</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;  <span class="keyword">call </span>mom_domains_init(cs%grid%domain, param_file, min_halo=wd_halos, symmetric=grid_sym_)</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;  <span class="comment">! call diag_mediator_init(CS%grid,param_file,CS%diag)</span></div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;  <span class="comment">! this needs to be fixed - will probably break when not using coupled driver 0</span></div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;  <span class="keyword">call </span>mom_grid_init(cs%grid, param_file, cs%US)</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160; </div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;  <span class="keyword">call </span>create_dyn_horgrid(dg, cs%grid%HI)</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;  <span class="keyword">call </span>clone_mom_domain(cs%grid%Domain, dg%Domain)</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160; </div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;  <span class="keyword">call </span>set_grid_metrics(dg, param_file, cs%US)</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;  <span class="comment">! call set_diag_mediator_grid(CS%grid, CS%diag)</span></div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160; </div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;  <span class="comment">! The ocean grid possibly uses different symmetry.</span></div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(ocn_grid)) <span class="keywordflow">then</span> ; cs%ocn_grid =&gt; ocn_grid</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;  <span class="keywordflow">else</span> ; cs%ocn_grid =&gt; cs%grid ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160; </div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;  <span class="comment">! Convenience pointers</span></div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;  g =&gt; cs%grid</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;  og =&gt; cs%ocn_grid</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;  us =&gt; cs%US</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160; </div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;  <span class="keywordflow">if</span> (is_root_pe()) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;    <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;OG: &#39;</span>, og%isd, og%isc, og%iec, og%ied, og%jsd, og%jsc, og%jsd, og%jed</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;    <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;IG: &#39;</span>, g%isd, g%isc, g%iec, g%ied, g%jsd, g%jsc, g%jsd, g%jed</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160; </div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;  cs%Time = time <span class="comment">! ### This might not be in the right place?</span></div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;  cs%diag =&gt; diag</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160; </div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;  <span class="comment">! Are we being called from the solo ice-sheet driver? When called by the ocean</span></div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;  <span class="comment">! model solo_ice_sheet_in is not preset.</span></div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;  cs%solo_ice_sheet = .false.</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(solo_ice_sheet_in)) cs%solo_ice_sheet = solo_ice_sheet_in</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160; </div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(time_in)) time = time_in</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160; </div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;  isd = g%isd ; jsd = g%jsd ; ied = g%ied ; jed = g%jed</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;  isdq = g%IsdB ; iedq = g%IedB ; jsdq = g%JsdB ; jedq = g%JedB</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160; </div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;  cs%Lat_fusion = 3.34e5</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;  cs%override_shelf_movement = .false. ; cs%active_shelf_dynamics = .false.</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160; </div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, <span class="stringliteral">&quot;&quot;</span>)</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DEBUG&quot;</span>, debug, default=.false.)</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DEBUG_IS&quot;</span>, cs%debug, &amp;</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;                 <span class="stringliteral">&quot;If true, write verbose debugging messages for the ice shelf.&quot;</span>, &amp;</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;                 default=debug)</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DYNAMIC_SHELF_MASS&quot;</span>, shelf_mass_is_dynamic, &amp;</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;                 <span class="stringliteral">&quot;If true, the ice sheet mass can evolve with time.&quot;</span>, &amp;</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;                 default=.false.)</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;  <span class="keywordflow">if</span> (shelf_mass_is_dynamic) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OVERRIDE_SHELF_MOVEMENT&quot;</span>, cs%override_shelf_movement, &amp;</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;                 <span class="stringliteral">&quot;If true, user provided code specifies the ice-shelf &quot;</span>//&amp;</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;                 <span class="stringliteral">&quot;movement instead of the dynamic ice model.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    cs%active_shelf_dynamics = .not.cs%override_shelf_movement</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;GROUNDING_LINE_INTERPOLATE&quot;</span>, cs%GL_regularize, &amp;</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;                 <span class="stringliteral">&quot;If true, regularize the floatation condition at the &quot;</span>//&amp;</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;                 <span class="stringliteral">&quot;grounding line as in Goldberg Holland Schoof 2009.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;GROUNDING_LINE_COUPLE&quot;</span>, cs%GL_couple, &amp;</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;                 <span class="stringliteral">&quot;If true, let the floatation condition be determined by &quot;</span>//&amp;</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;                 <span class="stringliteral">&quot;ocean column thickness. This means that update_OD_ffrac &quot;</span>//&amp;</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;                 <span class="stringliteral">&quot;will be called.  GL_REGULARIZE and GL_COUPLE are exclusive.&quot;</span>, &amp;</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;                 default=.false., do_not_log=cs%GL_regularize)</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;    <span class="keywordflow">if</span> (cs%GL_regularize) cs%GL_couple = .false.</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160; </div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SHELF_THERMO&quot;</span>, cs%isthermo, &amp;</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;                 <span class="stringliteral">&quot;If true, use a thermodynamically interactive ice shelf.&quot;</span>, &amp;</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;                 default=.false.)</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SHELF_THREE_EQN&quot;</span>, cs%threeeq, &amp;</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;                 <span class="stringliteral">&quot;If true, use the three equation expression of &quot;</span>//&amp;</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;                 <span class="stringliteral">&quot;consistency to calculate the fluxes at the ice-ocean &quot;</span>//&amp;</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;                 <span class="stringliteral">&quot;interface.&quot;</span>, default=.true.)</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SHELF_INSULATOR&quot;</span>, cs%insulator, &amp;</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;                 <span class="stringliteral">&quot;If true, the ice shelf is a perfect insulatior &quot;</span>//&amp;</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;                 <span class="stringliteral">&quot;(no conduction).&quot;</span>, default=.false.)</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MELTING_CUTOFF_DEPTH&quot;</span>, cs%cutoff_depth, &amp;</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;                 <span class="stringliteral">&quot;Depth above which the melt is set to zero (it must be &gt;= 0) &quot;</span>//&amp;</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;                 <span class="stringliteral">&quot;Default value won&#39;t affect the solution.&quot;</span>, default=0.0)</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;  <span class="keywordflow">if</span> (cs%cutoff_depth &lt; 0.) &amp;</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    <span class="keyword">call </span>mom_error(warning,<span class="stringliteral">&quot;Initialize_ice_shelf: MELTING_CUTOFF_DEPTH must be &gt;= 0.&quot;</span>)</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160; </div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;CONST_SEA_LEVEL&quot;</span>, cs%constant_sea_level, &amp;</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;                 <span class="stringliteral">&quot;If true, apply evaporative, heat and salt fluxes in &quot;</span>//&amp;</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;                  <span class="stringliteral">&quot;the sponge region. This will avoid a large increase &quot;</span>//&amp;</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;                 <span class="stringliteral">&quot;in sea level. This option is needed for some of the &quot;</span>//&amp;</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;                 <span class="stringliteral">&quot;ISOMIP+ experiments (Ocean3 and Ocean4). &quot;</span>//&amp;</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;                 <span class="stringliteral">&quot;IMPORTANT: it is not currently possible to do &quot;</span>//&amp;</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;                 <span class="stringliteral">&quot;prefect restarts using this flag.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160; </div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ISOMIP_S_SUR_SPONGE&quot;</span>, &amp;</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;                cs%S0, <span class="stringliteral">&quot;Surface salinity in the resoring region.&quot;</span>, &amp;</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;                default=33.8, do_not_log=.true.)</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160; </div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ISOMIP_T_SUR_SPONGE&quot;</span>, &amp;</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;                cs%T0, <span class="stringliteral">&quot;Surface temperature in the resoring region.&quot;</span>, &amp;</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;                default=-1.9, do_not_log=.true.)</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160; </div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SHELF_3EQ_GAMMA&quot;</span>, cs%const_gamma, &amp;</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;                 <span class="stringliteral">&quot;If true, user specifies a constant nondimensional heat-transfer coefficient &quot;</span>//&amp;</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;                 <span class="stringliteral">&quot;(GAMMA_T_3EQ), from which the salt-transfer coefficient is then computed &quot;</span>//&amp;</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;                 <span class="stringliteral">&quot; as GAMMA_T_3EQ/35. This is used with SHELF_THREE_EQN.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;  <span class="keywordflow">if</span> (cs%const_gamma) <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SHELF_3EQ_GAMMA_T&quot;</span>, cs%Gamma_T_3EQ, &amp;</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;                 <span class="stringliteral">&quot;Nondimensional heat-transfer coefficient.&quot;</span>,default=2.2e-2, &amp;</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;                  units=<span class="stringliteral">&quot;nondim.&quot;</span>, fail_if_missing=.true.)</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160; </div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ICE_SHELF_MASS_FROM_FILE&quot;</span>, &amp;</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;                 cs%mass_from_file, <span class="stringliteral">&quot;Read the mass of the &quot;</span>//&amp;</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;                 <span class="stringliteral">&quot;ice shelf (every time step) from a file.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160; </div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;  <span class="keywordflow">if</span> (cs%threeeq) &amp;</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SHELF_S_ROOT&quot;</span>, cs%find_salt_root, &amp;</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;                 <span class="stringliteral">&quot;If SHELF_S_ROOT = True, salinity at the ice/ocean interface (Sbdry) &quot;</span>//&amp;</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;                 <span class="stringliteral">&quot;is computed from a quadratic equation. Otherwise, the previous &quot;</span>//&amp;</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;                 <span class="stringliteral">&quot;interactive method to estimate Sbdry is used.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;  <span class="keywordflow">if</span> (cs%find_salt_root) <span class="keywordflow">then</span> <span class="comment">! read liquidus coeffs.</span></div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;     <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TFREEZE_S0_P0&quot;</span>,cs%lambda1, &amp;</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;                 <span class="stringliteral">&quot;this is the freezing potential temperature at &quot;</span>//&amp;</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;                 <span class="stringliteral">&quot;S=0, P=0.&quot;</span>, units=<span class="stringliteral">&quot;degC&quot;</span>, default=0.0, do_not_log=.true.)</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DTFREEZE_DS&quot;</span>,cs%lambda1, &amp;</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;                 <span class="stringliteral">&quot;this is the derivative of the freezing potential &quot;</span>//&amp;</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;                 <span class="stringliteral">&quot;temperature with salinity.&quot;</span>, &amp;</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;                 units=<span class="stringliteral">&quot;degC psu-1&quot;</span>, default=-0.054, do_not_log=.true.)</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DTFREEZE_DP&quot;</span>,cs%lambda3, &amp;</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;                 <span class="stringliteral">&quot;this is the derivative of the freezing potential &quot;</span>//&amp;</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;                 <span class="stringliteral">&quot;temperature with pressure.&quot;</span>, &amp;</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;                 units=<span class="stringliteral">&quot;degC Pa-1&quot;</span>, default=0.0, do_not_log=.true.)</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160; </div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160; </div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;  <span class="keywordflow">if</span> (.not.cs%threeeq) &amp;</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SHELF_2EQ_GAMMA_T&quot;</span>, cs%gamma_t, &amp;</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;                 <span class="stringliteral">&quot;If SHELF_THREE_EQN is false, this the fixed turbulent &quot;</span>//&amp;</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;                 <span class="stringliteral">&quot;exchange velocity at the ice-ocean interface.&quot;</span>, &amp;</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;                 units=<span class="stringliteral">&quot;m s-1&quot;</span>, fail_if_missing=.true.)</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160; </div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;G_EARTH&quot;</span>, cs%g_Earth, &amp;</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;                 <span class="stringliteral">&quot;The gravitational acceleration of the Earth.&quot;</span>, &amp;</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;                 units=<span class="stringliteral">&quot;m s-2&quot;</span>, default = 9.80)</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;C_P&quot;</span>, cs%Cp, &amp;</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;                 <span class="stringliteral">&quot;The heat capacity of sea water.&quot;</span>, units=<span class="stringliteral">&quot;J kg-1 K-1&quot;</span>, &amp;</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;                 fail_if_missing=.true.)</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RHO_0&quot;</span>, cs%Rho0, &amp;</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;                 <span class="stringliteral">&quot;The mean ocean density used with BOUSSINESQ true to &quot;</span>//&amp;</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;                 <span class="stringliteral">&quot;calculate accelerations and the mass for conservation &quot;</span>//&amp;</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;                 <span class="stringliteral">&quot;properties, or with BOUSSINSEQ false to convert some &quot;</span>//&amp;</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;                 <span class="stringliteral">&quot;parameters from vertical units of m to kg m-2.&quot;</span>, &amp;</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;                 units=<span class="stringliteral">&quot;kg m-3&quot;</span>, default=1035.0) <span class="comment">!### MAKE THIS A SEPARATE PARAMETER.</span></div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;C_P_ICE&quot;</span>, cs%Cp_ice, &amp;</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;                 <span class="stringliteral">&quot;The heat capacity of ice.&quot;</span>, units=<span class="stringliteral">&quot;J kg-1 K-1&quot;</span>, &amp;</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;                 default=2.10e3)</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160; </div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ICE_SHELF_FLUX_FACTOR&quot;</span>, cs%flux_factor, &amp;</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;                 <span class="stringliteral">&quot;Non-dimensional factor applied to shelf thermodynamic &quot;</span>//&amp;</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;                 <span class="stringliteral">&quot;fluxes.&quot;</span>, units=<span class="stringliteral">&quot;none&quot;</span>, default=1.0)</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160; </div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KV_ICE&quot;</span>, cs%kv_ice, &amp;</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;                 <span class="stringliteral">&quot;The viscosity of the ice.&quot;</span>, units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=1.0e10)</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KV_MOLECULAR&quot;</span>, cs%kv_molec, &amp;</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;                 <span class="stringliteral">&quot;The molecular kinimatic viscosity of sea water at the &quot;</span>//&amp;</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;                 <span class="stringliteral">&quot;freezing temperature.&quot;</span>, units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=1.95e-6)</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ICE_SHELF_SALINITY&quot;</span>, cs%Salin_ice, &amp;</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;                 <span class="stringliteral">&quot;The salinity of the ice inside the ice shelf.&quot;</span>, units=<span class="stringliteral">&quot;psu&quot;</span>, &amp;</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;                 default=0.0)</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ICE_SHELF_TEMPERATURE&quot;</span>, cs%Temp_ice, &amp;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;                 <span class="stringliteral">&quot;The temperature at the center of the ice shelf.&quot;</span>, &amp;</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;                 units = <span class="stringliteral">&quot;degC&quot;</span>, default=-15.0)</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KD_SALT_MOLECULAR&quot;</span>, cs%kd_molec_salt, &amp;</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;                 <span class="stringliteral">&quot;The molecular diffusivity of salt in sea water at the &quot;</span>//&amp;</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;                 <span class="stringliteral">&quot;freezing point.&quot;</span>, units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=8.02e-10)</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KD_TEMP_MOLECULAR&quot;</span>, cs%kd_molec_temp, &amp;</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;                 <span class="stringliteral">&quot;The molecular diffusivity of heat in sea water at the &quot;</span>//&amp;</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;                 <span class="stringliteral">&quot;freezing point.&quot;</span>, units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=1.41e-7)</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RHO_0&quot;</span>, cs%density_ocean_avg, &amp;</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;                 <span class="stringliteral">&quot;avg ocean density used in floatation cond&quot;</span>, &amp;</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;                 units=<span class="stringliteral">&quot;kg m-3&quot;</span>, default=1035.)</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DT_FORCING&quot;</span>, cs%time_step, &amp;</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;                 <span class="stringliteral">&quot;The time step for changing forcing, coupling with other &quot;</span>//&amp;</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;                 <span class="stringliteral">&quot;components, or potentially writing certain diagnostics. &quot;</span>//&amp;</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;                 <span class="stringliteral">&quot;The default value is given by DT.&quot;</span>, units=<span class="stringliteral">&quot;s&quot;</span>, default=0.0)</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160; </div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;COL_THICK_MELT_THRESHOLD&quot;</span>, cs%col_thick_melt_threshold, &amp;</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;                 <span class="stringliteral">&quot;The minimum ML thickness where melting is allowed.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, &amp;</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;                 default=0.0)</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160; </div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;READ_TIDEAMP&quot;</span>, read_tideamp, &amp;</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;                 <span class="stringliteral">&quot;If true, read a file (given by TIDEAMP_FILE) containing &quot;</span>//&amp;</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;                 <span class="stringliteral">&quot;the tidal amplitude with INT_TIDE_DISSIPATION.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160; </div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;  <span class="keyword">call </span>safe_alloc_ptr(cs%utide,isd,ied,jsd,jed)   ; cs%utide(:,:) = 0.0</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160; </div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;  <span class="keywordflow">if</span> (read_tideamp) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TIDEAMP_FILE&quot;</span>, tideamp_file, &amp;</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;                 <span class="stringliteral">&quot;The path to the file containing the spatially varying &quot;</span>//&amp;</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;                 <span class="stringliteral">&quot;tidal amplitudes.&quot;</span>, &amp;</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;                 default=<span class="stringliteral">&quot;tideamp.nc&quot;</span>)</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INPUTDIR&quot;</span>, inputdir, default=<span class="stringliteral">&quot;.&quot;</span>)</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;    inputdir = slasher(inputdir)</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;    tideamp_file = trim(inputdir) // trim(tideamp_file)</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;    <span class="keyword">call </span>mom_read_data(tideamp_file,<span class="stringliteral">&#39;tideamp&#39;</span>,cs%utide,g%domain,timelevel=1)</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;UTIDE&quot;</span>, utide, &amp;</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;                 <span class="stringliteral">&quot;The constant tidal amplitude used with INT_TIDE_DISSIPATION.&quot;</span>, &amp;</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;                 units=<span class="stringliteral">&quot;m s-1&quot;</span>, default=0.0)</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;    cs%utide(:,:) = utide</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160; </div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;  <span class="keyword">call </span>eos_init(param_file, cs%eqn_of_state)</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160; </div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;  <span class="comment">!! new parameters that need to be in MOM_input</span></div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160; </div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;  <span class="keywordflow">if</span> (cs%active_shelf_dynamics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160; </div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DENSITY_ICE&quot;</span>, cs%density_ice, &amp;</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;                 <span class="stringliteral">&quot;A typical density of ice.&quot;</span>, units=<span class="stringliteral">&quot;kg m-3&quot;</span>, default=917.0)</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160; </div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INPUT_FLUX_ICE_SHELF&quot;</span>, cs%input_flux, &amp;</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;                 <span class="stringliteral">&quot;volume flux at upstream boundary&quot;</span>, units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=0.)</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INPUT_THICK_ICE_SHELF&quot;</span>, cs%input_thickness, &amp;</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;                 <span class="stringliteral">&quot;flux thickness at upstream boundary&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, default=1000.)</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;    <span class="comment">! This is here because of inconsistent defaults.  I don&#39;t know why.  RWH</span></div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DENSITY_ICE&quot;</span>, cs%density_ice, &amp;</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;                 <span class="stringliteral">&quot;A typical density of ice.&quot;</span>, units=<span class="stringliteral">&quot;kg m-3&quot;</span>, default=900.0)</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;  cs%rho_ice = cs%density_ice*us%Z_to_m</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MIN_THICKNESS_SIMPLE_CALVE&quot;</span>, &amp;</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;                cs%min_thickness_simple_calve, &amp;</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;                 <span class="stringliteral">&quot;Min thickness rule for the very simple calving law&quot;</span>,&amp;</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;                 units=<span class="stringliteral">&quot;m&quot;</span>, default=0.0, scale=us%m_to_Z)</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160; </div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USTAR_SHELF_BG&quot;</span>, cs%ustar_bg, &amp;</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;                 <span class="stringliteral">&quot;The minimum value of ustar under ice sheves.&quot;</span>, &amp;</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;                 units=<span class="stringliteral">&quot;m s-1&quot;</span>, default=0.0, scale=us%m_to_Z*us%T_to_s)</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;CDRAG_SHELF&quot;</span>, cdrag, &amp;</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;       <span class="stringliteral">&quot;CDRAG is the drag coefficient relating the magnitude of &quot;</span>//&amp;</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;       <span class="stringliteral">&quot;the velocity field to the surface stress.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, &amp;</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;       default=0.003)</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;  cs%cdrag = cdrag</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;  <span class="keywordflow">if</span> (cs%ustar_bg &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DRAG_BG_VEL_SHELF&quot;</span>, drag_bg_vel, &amp;</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;                 <span class="stringliteral">&quot;DRAG_BG_VEL is either the assumed bottom velocity (with &quot;</span>//&amp;</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;                 <span class="stringliteral">&quot;LINEAR_DRAG) or an unresolved  velocity that is &quot;</span>//&amp;</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;                 <span class="stringliteral">&quot;combined with the resolved velocity to estimate the &quot;</span>//&amp;</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;                 <span class="stringliteral">&quot;velocity magnitude.&quot;</span>, units=<span class="stringliteral">&quot;m s-1&quot;</span>, default=0.0, scale=us%m_to_Z*us%T_to_s)</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;    <span class="keywordflow">if</span> (cs%cdrag*drag_bg_vel &gt; 0.0) cs%ustar_bg = sqrt(cs%cdrag)*drag_bg_vel</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160; </div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;  <span class="comment">! Allocate and initialize state variables to default values</span></div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;  <span class="keyword">call </span>ice_shelf_state_init(cs%ISS, cs%grid)</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;  iss =&gt; cs%ISS</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160; </div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;  <span class="comment">! Allocate the arrays for passing ice-shelf data through the forcing type.</span></div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;  <span class="keywordflow">if</span> (.not. cs%solo_ice_sheet) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;    <span class="keyword">call </span>mom_mesg(<span class="stringliteral">&quot;MOM_ice_shelf.F90, initialize_ice_shelf: allocating fluxes.&quot;</span>)</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;     <span class="comment">! GMM: the following assures that water/heat fluxes are just allocated</span></div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;     <span class="comment">! when SHELF_THERMO = True. These fluxes are necessary if one wants to</span></div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;     <span class="comment">! use either ENERGETICS_SFC_PBL (ALE mode) or BULKMIXEDLAYER (layer mode).</span></div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(fluxes)) &amp;</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;      <span class="keyword">call </span>allocate_forcing_type(cs%ocn_grid, fluxes, ustar=.true., shelf=.true., &amp;</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;                                 press=.true., water=cs%isthermo, heat=cs%isthermo)</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(forces)) &amp;</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;      <span class="keyword">call </span>allocate_mech_forcing(cs%ocn_grid, forces, ustar=.true., shelf=.true., press=.true.)</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;    <span class="keyword">call </span>mom_mesg(<span class="stringliteral">&quot;MOM_ice_shelf.F90, initialize_ice_shelf: allocating fluxes in solo mode.&quot;</span>)</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(fluxes)) &amp;</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;      <span class="keyword">call </span>allocate_forcing_type(g, fluxes, ustar=.true., shelf=.true., press=.true.)</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(forces)) &amp;</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;      <span class="keyword">call </span>allocate_mech_forcing(g, forces, ustar=.true., shelf=.true., press=.true.)</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160; </div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;  <span class="comment">! Set up the bottom depth, G%D either analytically or from file</span></div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;  <span class="keyword">call </span>mom_initialize_topography(dg%bathyT, g%max_depth, dg, param_file)</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;  <span class="keyword">call </span>rescale_dyn_horgrid_bathymetry(dg, us%Z_to_m)</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160; </div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;  <span class="comment">! Set up the Coriolis parameter, G%f, usually analytically.</span></div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;  <span class="keyword">call </span>mom_initialize_rotation(dg%CoriolisBu, dg, param_file, us)</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;  <span class="comment">! This copies grid elements, including bathyT and CoriolisBu from dG to CS%grid.</span></div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;  <span class="keyword">call </span>copy_dyngrid_to_mom_grid(dg, cs%grid, us)</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160; </div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;  <span class="keyword">call </span>destroy_dyn_horgrid(dg)</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160; </div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;  <span class="comment">! Set up the restarts.</span></div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;  <span class="keyword">call </span>restart_init(param_file, cs%restart_CSp, <span class="stringliteral">&quot;Shelf.res&quot;</span>)</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;  <span class="keyword">call </span>register_restart_field(iss%mass_shelf, <span class="stringliteral">&quot;shelf_mass&quot;</span>, .true., cs%restart_CSp, &amp;</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;                              <span class="stringliteral">&quot;Ice shelf mass&quot;</span>, <span class="stringliteral">&quot;kg m-2&quot;</span>)</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;  <span class="keyword">call </span>register_restart_field(iss%area_shelf_h, <span class="stringliteral">&quot;shelf_area&quot;</span>, .true., cs%restart_CSp, &amp;</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;                              <span class="stringliteral">&quot;Ice shelf area in cell&quot;</span>, <span class="stringliteral">&quot;m2&quot;</span>)</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;  <span class="keyword">call </span>register_restart_field(iss%h_shelf, <span class="stringliteral">&quot;h_shelf&quot;</span>, .true., cs%restart_CSp, &amp;</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;                              <span class="stringliteral">&quot;ice sheet/shelf thickness&quot;</span>, <span class="stringliteral">&quot;m&quot;</span>)</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;  <span class="keyword">call </span>register_restart_field(us%m_to_Z_restart, <span class="stringliteral">&quot;m_to_Z&quot;</span>, .false., cs%restart_CSp, &amp;</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;                              <span class="stringliteral">&quot;Height unit conversion factor&quot;</span>, <span class="stringliteral">&quot;Z meter-1&quot;</span>)</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;  <span class="keywordflow">if</span> (cs%active_shelf_dynamics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;    <span class="keyword">call </span>register_restart_field(iss%hmask, <span class="stringliteral">&quot;h_mask&quot;</span>, .true., cs%restart_CSp, &amp;</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;                                <span class="stringliteral">&quot;ice sheet/shelf thickness mask&quot;</span> ,<span class="stringliteral">&quot;none&quot;</span>)</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160; </div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;  <span class="comment">! if (CS%active_shelf_dynamics) then  !### Consider adding an ice shelf dynamics switch.</span></div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;    <span class="comment">! Allocate CS%dCS and specify additional restarts for ice shelf dynamics</span></div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    <span class="keyword">call </span>register_ice_shelf_dyn_restarts(g, param_file, cs%dCS, cs%restart_CSp)</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;  <span class="comment">! endif</span></div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160; </div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;  <span class="comment">!GMM - I think we do not need to save ustar_shelf and iceshelf_melt in the restart file</span></div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;  <span class="comment">!if (.not. CS%solo_ice_sheet) then</span></div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;  <span class="comment">!  call register_restart_field(fluxes%ustar_shelf, &quot;ustar_shelf&quot;, .false., CS%restart_CSp, &amp;</span></div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;  <span class="comment">!                              &quot;Friction velocity under ice shelves&quot;, &quot;m s-1&quot;)</span></div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;  <span class="comment">!  call register_restart_field(fluxes%iceshelf_melt, &quot;iceshelf_melt&quot;, .false., CS%restart_CSp, &amp;</span></div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;  <span class="comment">!                              &quot;Ice Shelf Melt Rate&quot;, &quot;m year-1&quot;)</span></div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;  <span class="comment">!endif</span></div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160; </div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;  cs%restart_output_dir = dirs%restart_output_dir</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160; </div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;  new_sim = .false.</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;  <span class="keywordflow">if</span> ((dirs%input_filename(1:1) == <span class="stringliteral">&#39;n&#39;</span>) .and. &amp;</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;      (len_trim(dirs%input_filename) == 1)) new_sim = .true.</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160; </div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;  <span class="keywordflow">if</span> (cs%override_shelf_movement .and. cs%mass_from_file) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160; </div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;    <span class="comment">! initialize the ids for reading shelf mass from a netCDF</span></div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;    <span class="keyword">call </span>initialize_shelf_mass(g, param_file, cs, iss)</div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160; </div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;    <span class="keywordflow">if</span> (new_sim) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;      <span class="comment">! new simulation, initialize ice thickness as in the static case</span></div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;      <span class="keyword">call </span>initialize_ice_thickness(iss%h_shelf, iss%area_shelf_h, iss%hmask, g, us, param_file)</div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160; </div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;    <span class="comment">! next make sure mass is consistent with thickness</span></div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;      <span class="keywordflow">do</span> j=g%jsd,g%jed ; <span class="keywordflow">do</span> i=g%isd,g%ied</div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;        <span class="keywordflow">if</span> ((iss%hmask(i,j) == 1) .or. (iss%hmask(i,j) == 2)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;          iss%mass_shelf(i,j) = iss%h_shelf(i,j)*cs%rho_ice</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160; </div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;      <span class="keywordflow">if</span> (cs%min_thickness_simple_calve &gt; 0.0) &amp;</div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;        <span class="keyword">call </span>ice_shelf_min_thickness_calve(g, iss%h_shelf, iss%area_shelf_h, iss%hmask, &amp;</div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;                                           cs%min_thickness_simple_calve)</div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160; </div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;  <span class="keywordflow">if</span> (cs%active_shelf_dynamics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;    <span class="comment">! the only reason to initialize boundary conds is if the shelf is dynamic - MJH</span></div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160; </div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;    <span class="comment">! call initialize_ice_shelf_boundary ( CS%u_face_mask_bdry, CS%v_face_mask_bdry, &amp;</span></div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;    <span class="comment">!                                      CS%u_flux_bdry_val, CS%v_flux_bdry_val, &amp;</span></div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;    <span class="comment">!                                      CS%u_bdry_val, CS%v_bdry_val, CS%h_bdry_val, &amp;</span></div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;    <span class="comment">!                                      ISS%hmask, G, param_file)</span></div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160; </div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160; </div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;  <span class="keywordflow">if</span> (new_sim .and. (.not. (cs%override_shelf_movement .and. cs%mass_from_file))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160; </div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;    <span class="comment">! This model is initialized internally or from a file.</span></div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;    <span class="keyword">call </span>initialize_ice_thickness(iss%h_shelf, iss%area_shelf_h, iss%hmask, g, us, param_file)</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160; </div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;    <span class="comment">! next make sure mass is consistent with thickness</span></div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;    <span class="keywordflow">do</span> j=g%jsd,g%jed ; <span class="keywordflow">do</span> i=g%isd,g%ied</div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;      <span class="keywordflow">if</span> ((iss%hmask(i,j) == 1) .or. (iss%hmask(i,j) == 2)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;        iss%mass_shelf(i,j) = iss%h_shelf(i,j)*cs%rho_ice</div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160; </div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;  <span class="comment">! else ! Previous block for new_sim=.T., this block restores the state.</span></div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;  <span class="keywordflow">elseif</span> (.not.new_sim) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;    <span class="comment">! This line calls a subroutine that reads the initial conditions from a restart file.</span></div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;    <span class="keyword">call </span>mom_mesg(<span class="stringliteral">&quot;MOM_ice_shelf.F90, initialize_ice_shelf: Restoring ice shelf from file.&quot;</span>)</div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;    <span class="keyword">call </span>restore_state(dirs%input_filename, dirs%restart_input_dir, time, &amp;</div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;                       g, cs%restart_CSp)</div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160; </div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;    <span class="keywordflow">if</span> ((us%m_to_Z_restart /= 0.0) .and. (us%m_to_Z_restart /= us%m_to_Z)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;      z_rescale = us%m_to_Z / us%m_to_Z_restart</div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;      <span class="keywordflow">do</span> j=g%jsc,g%jec ; <span class="keywordflow">do</span> i=g%isc,g%iec</div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;        iss%h_shelf(i,j) = z_rescale * iss%h_shelf(i,j)</div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160; </div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! .not. new_sim</span></div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160; </div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;  cs%Time = time</div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160; </div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;  <span class="keyword">call </span>pass_var(iss%area_shelf_h, g%domain)</div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;  <span class="keyword">call </span>pass_var(iss%h_shelf, g%domain)</div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;  <span class="keyword">call </span>pass_var(iss%mass_shelf, g%domain)</div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;  <span class="keyword">call </span>pass_var(iss%hmask, g%domain)</div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;  <span class="keyword">call </span>pass_var(g%bathyT, g%domain)</div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_pass)</div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160; </div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;  <span class="keywordflow">do</span> j=jsd,jed ; <span class="keywordflow">do</span> i=isd,ied</div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;    <span class="keywordflow">if</span> (iss%area_shelf_h(i,j) &gt; us%L_to_m**2*g%areaT(i,j)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;      <span class="keyword">call </span>mom_error(warning,<span class="stringliteral">&quot;Initialize_ice_shelf: area_shelf_h exceeds G%areaT.&quot;</span>)</div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;      iss%area_shelf_h(i,j) = us%L_to_m**2*g%areaT(i,j)</div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(fluxes)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=jsd,jed ; <span class="keywordflow">do</span> i=isd,ied</div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;    <span class="keywordflow">if</span> (g%areaT(i,j) &gt; 0.0) fluxes%frac_shelf_h(i,j) = iss%area_shelf_h(i,j) / (us%L_to_m**2*g%areaT(i,j))</div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160; </div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;    <span class="keyword">call </span>hchksum(fluxes%frac_shelf_h, <span class="stringliteral">&quot;IS init: frac_shelf_h&quot;</span>, g%HI, haloshift=0)</div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160; </div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(forces)) &amp;</div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;    <span class="keyword">call </span>add_shelf_forces(g, us, cs, forces, do_shelf_area=.not.cs%solo_ice_sheet)</div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160; </div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(fluxes)) <span class="keyword">call </span>add_shelf_pressure(g, us, cs, fluxes)</div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160; </div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;  <span class="keywordflow">if</span> (cs%active_shelf_dynamics .and. .not.cs%isthermo) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;    iss%water_flux(:,:) = 0.0</div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160; </div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;  <span class="keywordflow">if</span> (shelf_mass_is_dynamic) &amp;</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;    <span class="keyword">call </span>initialize_ice_shelf_dyn(param_file, time, iss, cs%dCS, g, us, diag, new_sim, solo_ice_sheet_in)</div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160; </div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;  <span class="keyword">call </span>fix_restart_unit_scaling(us)</div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160; </div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SAVE_INITIAL_CONDS&quot;</span>, save_ic, &amp;</div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;                 <span class="stringliteral">&quot;If true, save the ice shelf initial conditions.&quot;</span>, &amp;</div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;                 default=.false.)</div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;  <span class="keywordflow">if</span> (save_ic) <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SHELF_IC_OUTPUT_FILE&quot;</span>, ic_file,&amp;</div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;                 <span class="stringliteral">&quot;The name-root of the output file for the ice shelf &quot;</span>//&amp;</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;                 <span class="stringliteral">&quot;initial conditions.&quot;</span>, default=<span class="stringliteral">&quot;MOM_Shelf_IC&quot;</span>)</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160; </div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;  <span class="keywordflow">if</span> (save_ic .and. .not.((dirs%input_filename(1:1) == <span class="stringliteral">&#39;r&#39;</span>) .and. &amp;</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;                          (len_trim(dirs%input_filename) == 1))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;    <span class="keyword">call </span>save_restart(dirs%output_directory, cs%Time, g, &amp;</div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;                      cs%restart_CSp, filename=ic_file)</div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160; </div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160; </div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;  cs%id_area_shelf_h = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;area_shelf_h&#39;</span>, cs%diag%axesT1, cs%Time, &amp;</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;     <span class="stringliteral">&#39;Ice Shelf Area in cell&#39;</span>, <span class="stringliteral">&#39;meter-2&#39;</span>)</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;  cs%id_shelf_mass = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;shelf_mass&#39;</span>, cs%diag%axesT1, cs%Time, &amp;</div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;     <span class="stringliteral">&#39;mass of shelf&#39;</span>, <span class="stringliteral">&#39;kg/m^2&#39;</span>)</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;  cs%id_h_shelf = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;h_shelf&#39;</span>, cs%diag%axesT1, cs%Time, &amp;</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;       <span class="stringliteral">&#39;ice shelf thickness&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>, conversion=us%Z_to_m)</div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;  cs%id_mass_flux = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;mass_flux&#39;</span>, cs%diag%axesT1,&amp;</div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;     cs%Time,<span class="stringliteral">&#39;Total mass flux of freshwater across the ice-ocean interface.&#39;</span>, <span class="stringliteral">&#39;kg/s&#39;</span>)</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;  cs%id_melt = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;melt&#39;</span>, cs%diag%axesT1, cs%Time, &amp;</div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;     <span class="stringliteral">&#39;Ice Shelf Melt Rate&#39;</span>, <span class="stringliteral">&#39;m yr-1&#39;</span>)</div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;  cs%id_thermal_driving = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;thermal_driving&#39;</span>, cs%diag%axesT1, cs%Time, &amp;</div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;     <span class="stringliteral">&#39;pot. temp. in the boundary layer minus freezing pot. temp. at the ice-ocean interface.&#39;</span>, <span class="stringliteral">&#39;Celsius&#39;</span>)</div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;  cs%id_haline_driving = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;haline_driving&#39;</span>, cs%diag%axesT1, cs%Time, &amp;</div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;     <span class="stringliteral">&#39;salinity in the boundary layer minus salinity at the ice-ocean interface.&#39;</span>, <span class="stringliteral">&#39;psu&#39;</span>)</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;  cs%id_Sbdry = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;sbdry&#39;</span>, cs%diag%axesT1, cs%Time, &amp;</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;     <span class="stringliteral">&#39;salinity at the ice-ocean interface.&#39;</span>, <span class="stringliteral">&#39;psu&#39;</span>)</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;  cs%id_u_ml = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;u_ml&#39;</span>, cs%diag%axesCu1, cs%Time, &amp;</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;     <span class="stringliteral">&#39;Eastward vel. in the boundary layer (used to compute ustar)&#39;</span>, <span class="stringliteral">&#39;m s-1&#39;</span>)</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;  cs%id_v_ml = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;v_ml&#39;</span>, cs%diag%axesCv1, cs%Time, &amp;</div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;     <span class="stringliteral">&#39;Northward vel. in the boundary layer (used to compute ustar)&#39;</span>, <span class="stringliteral">&#39;m s-1&#39;</span>)</div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;  cs%id_exch_vel_s = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;exch_vel_s&#39;</span>, cs%diag%axesT1, cs%Time, &amp;</div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;     <span class="stringliteral">&#39;Sub-shelf salinity exchange velocity&#39;</span>, <span class="stringliteral">&#39;m s-1&#39;</span>)</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;  cs%id_exch_vel_t = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;exch_vel_t&#39;</span>, cs%diag%axesT1, cs%Time, &amp;</div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;     <span class="stringliteral">&#39;Sub-shelf thermal exchange velocity&#39;</span>, <span class="stringliteral">&#39;m s-1&#39;</span>)</div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;  cs%id_tfreeze = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;tfreeze&#39;</span>, cs%diag%axesT1, cs%Time, &amp;</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;     <span class="stringliteral">&#39;In Situ Freezing point at ice shelf interface&#39;</span>, <span class="stringliteral">&#39;degC&#39;</span>)</div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;  cs%id_tfl_shelf = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;tflux_shelf&#39;</span>, cs%diag%axesT1, cs%Time, &amp;</div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;     <span class="stringliteral">&#39;Heat conduction into ice shelf&#39;</span>, <span class="stringliteral">&#39;W m-2&#39;</span>)</div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;  cs%id_ustar_shelf = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ustar_shelf&#39;</span>, cs%diag%axesT1, cs%Time, &amp;</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;     <span class="stringliteral">&#39;Fric vel under shelf&#39;</span>, <span class="stringliteral">&#39;m/s&#39;</span>, conversion=us%Z_to_m*us%s_to_T)</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;  <span class="keywordflow">if</span> (cs%active_shelf_dynamics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;    cs%id_h_mask = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;h_mask&#39;</span>, cs%diag%axesT1, cs%Time, &amp;</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;       <span class="stringliteral">&#39;ice shelf thickness mask&#39;</span>, <span class="stringliteral">&#39;none&#39;</span>)</div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160; </div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;  id_clock_shelf = cpu_clock_id(<span class="stringliteral">&#39;Ice shelf&#39;</span>, grain=clock_component)</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;  id_clock_pass = cpu_clock_id(<span class="stringliteral">&#39; Ice shelf halo updates&#39;</span>, grain=clock_routine)</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__ice__shelf_8F90_source.html#l00754">add_shelf_forces()</a>, <a class="el" href="MOM__ice__shelf_8F90_source.html#l00835">add_shelf_pressure()</a>, <a class="el" href="MOM__transcribe__grid_8F90_source.html#l00023">mom_transcribe_grid::copy_dyngrid_to_mom_grid()</a>, <a class="el" href="MOM__EOS_8F90_source.html#l00709">mom_eos::eos_init()</a>, <a class="el" href="MOM__unit__scaling_8F90_source.html#l00109">mom_unit_scaling::fix_restart_unit_scaling()</a>, <a class="el" href="MOM__get__input_8F90_source.html#l00034">mom_get_input::get_mom_input()</a>, <a class="el" href="MOM__ice__shelf__state_8F90_source.html#l00058">mom_ice_shelf_state::ice_shelf_state_init()</a>, <a class="el" href="MOM__ice__shelf_8F90_source.html#l00185">id_clock_pass</a>, <a class="el" href="MOM__ice__shelf_8F90_source.html#l00184">id_clock_shelf</a>, <a class="el" href="MOM__ice__shelf__initialize_8F90_source.html#l00029">mom_ice_shelf_initialize::initialize_ice_thickness()</a>, <a class="el" href="MOM__ice__shelf_8F90_source.html#l01594">initialize_shelf_mass()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00044">mom_error_handler::is_root_pe()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__grid_8F90_source.html#l00184">mom_grid::mom_grid_init()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00053">mom_error_handler::mom_mesg()</a>, <a class="el" href="MOM__dyn__horgrid_8F90_source.html#l00285">mom_dyn_horgrid::rescale_dyn_horgrid_bathymetry()</a>, <a class="el" href="MOM__restart_8F90_source.html#l01421">mom_restart::restart_init()</a>, <a class="el" href="MOM__restart_8F90_source.html#l00984">mom_restart::restore_state()</a>, <a class="el" href="MOM__grid__initialize_8F90_source.html#l00063">mom_grid_initialize::set_grid_metrics()</a>, and <a class="el" href="MOM__unit__scaling_8F90_source.html#l00041">mom_unit_scaling::unit_scaling_init()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__driver_8F90_source.html#l00001">mom_main()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_a5990f9918493ff4984245eac74e5f4d9_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_a5990f9918493ff4984245eac74e5f4d9_icgraph.svg" width="322" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="ac478a1dd52137f8e851916bee2243fa3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac478a1dd52137f8e851916bee2243fa3">&#9670;&nbsp;</a></span>initialize_shelf_mass()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_ice_shelf::initialize_shelf_mass </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__ice__shelf_1_1ice__shelf__cs.html">ice_shelf_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ice_shelf_state), intent(inout)&#160;</td>
          <td class="paramname"><em>ISS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>new_sim</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initializes shelf mass based on three options (file, zero and user) </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>A structure to parse for run-time parameters </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>A pointer to the ice shelf control structure </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">iss</td><td>The ice shelf state type that is being updated </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">new_sim</td><td>If present and false, this run is being restarted </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__ice__shelf_8F90_source.html#l01594">1594</a> of file <a class="el" href="MOM__ice__shelf_8F90_source.html">MOM_ice_shelf.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160; </div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(in)</span> :: G<span class="comment">   !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;  <span class="keywordtype">type</span>(param_file_type), <span class="keywordtype">intent(in)</span> :: param_file<span class="comment"> !&lt; A structure to parse for run-time parameters</span></div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_CS),    <span class="keywordtype">pointer</span>    :: CS<span class="comment"> !&lt; A pointer to the ice shelf control structure</span></div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_state), <span class="keywordtype">intent(inout)</span> :: ISS<span class="comment"> !&lt; The ice shelf state type that is being updated</span></div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;  <span class="keywordtype">logical</span>,     <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: new_sim<span class="comment"> !&lt; If present and false, this run is being restarted</span></div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160; </div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je</div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;  <span class="keywordtype">logical</span> :: read_shelf_area, new_sim_2</div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;  <span class="keywordtype">character(len=240)</span> :: config, inputdir, shelf_file, filename</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;  <span class="keywordtype">character(len=120)</span> :: shelf_mass_var  <span class="comment">! The name of shelf mass in the file.</span></div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;  <span class="keywordtype">character(len=120)</span> :: shelf_area_var <span class="comment">! The name of shelf area in the file.</span></div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_ice_shelf&quot;</span></div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec</div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160; </div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;  new_sim_2 = .true. ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(new_sim)) new_sim_2 = new_sim</div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160; </div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ICE_SHELF_CONFIG&quot;</span>, config, &amp;</div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;                 <span class="stringliteral">&quot;A string that specifies how the ice shelf is &quot;</span>//&amp;</div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;                 <span class="stringliteral">&quot;initialized. Valid options include:\n&quot;</span>//&amp;</div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;                 <span class="stringliteral">&quot; \tfile\t Read from a file.\n&quot;</span>//&amp;</div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;                 <span class="stringliteral">&quot; \tzero\t Set shelf mass to 0 everywhere.\n&quot;</span>//&amp;</div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;                 <span class="stringliteral">&quot; \tUSER\t Call USER_initialize_shelf_mass.\n&quot;</span>, &amp;</div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;                 fail_if_missing=.true.)</div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160; </div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;  <span class="keywordflow">select case</span> ( trim(config) )</div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;file&quot;</span>)</div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160; </div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;      <span class="keyword">call </span>time_interp_external_init()</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160; </div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INPUTDIR&quot;</span>, inputdir, default=<span class="stringliteral">&quot;.&quot;</span>)</div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;      inputdir = slasher(inputdir)</div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160; </div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SHELF_FILE&quot;</span>, shelf_file, &amp;</div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;              <span class="stringliteral">&quot;If DYNAMIC_SHELF_MASS = True, OVERRIDE_SHELF_MOVEMENT = True &quot;</span>//&amp;</div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;              <span class="stringliteral">&quot;and ICE_SHELF_MASS_FROM_FILE = True, this is the file from &quot;</span>//&amp;</div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;              <span class="stringliteral">&quot;which to read the shelf mass and area.&quot;</span>, &amp;</div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;               default=<span class="stringliteral">&quot;shelf_mass.nc&quot;</span>)</div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SHELF_MASS_VAR&quot;</span>, shelf_mass_var, &amp;</div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;                 <span class="stringliteral">&quot;The variable in SHELF_FILE with the shelf mass.&quot;</span>, &amp;</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;                 default=<span class="stringliteral">&quot;shelf_mass&quot;</span>)</div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;READ_SHELF_AREA&quot;</span>, read_shelf_area, &amp;</div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;                 <span class="stringliteral">&quot;If true, also read the area covered by ice-shelf from SHELF_FILE.&quot;</span>, &amp;</div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;                 default=.false.)</div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160; </div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;      filename = trim(slasher(inputdir))//trim(shelf_file)</div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;      <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;INPUTDIR/SHELF_FILE&quot;</span>, filename)</div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160; </div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;      cs%id_read_mass = init_external_field(filename, shelf_mass_var, &amp;</div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;                          domain=g%Domain%mpp_domain, verbose=cs%debug)</div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160; </div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;      <span class="keywordflow">if</span> (read_shelf_area) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;         <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SHELF_AREA_VAR&quot;</span>, shelf_area_var, &amp;</div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;                  <span class="stringliteral">&quot;The variable in SHELF_FILE with the shelf area.&quot;</span>, &amp;</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;                  default=<span class="stringliteral">&quot;shelf_area&quot;</span>)</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160; </div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;         cs%id_read_area = init_external_field(filename,shelf_area_var, &amp;</div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;                             domain=g%Domain%mpp_domain)</div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160; </div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;      <span class="keywordflow">if</span> (.not.file_exists(filename, g%Domain)) <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;           <span class="stringliteral">&quot; initialize_shelf_mass: Unable to open &quot;</span>//trim(filename))</div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160; </div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;zero&quot;</span>)</div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;        iss%mass_shelf(i,j) = 0.0</div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;        iss%area_shelf_h(i,j) = 0.0</div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160; </div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;USER&quot;</span>)</div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;      <span class="keyword">call </span>user_initialize_shelf_mass(iss%mass_shelf, iss%area_shelf_h, &amp;</div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;                   iss%h_shelf, iss%hmask, g, cs%US, cs%user_CS, param_file, new_sim_2)</div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160; </div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;<span class="keywordflow">    case default</span> ;  <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;initialize_ice_shelf: &quot;</span>// &amp;</div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;      <span class="stringliteral">&quot;Unrecognized ice shelf setup &quot;</span>//trim(config))</div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;<span class="keywordflow">  end select</span></div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__ice__shelf_8F90_source.html#l01074">initialize_ice_shelf()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_ac478a1dd52137f8e851916bee2243fa3_cgraph.svg" width="586" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_ac478a1dd52137f8e851916bee2243fa3_icgraph.svg" width="542" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a84aff10af35c11912502a9cd7834dd50"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a84aff10af35c11912502a9cd7834dd50">&#9670;&nbsp;</a></span>shelf_calc_flux()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_ice_shelf::shelf_calc_flux </td>
          <td>(</td>
          <td class="paramtype">type(surface), intent(inout)&#160;</td>
          <td class="paramname"><em>state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>time_step</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__ice__shelf_1_1ice__shelf__cs.html">ice_shelf_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(mech_forcing), intent(inout), optional&#160;</td>
          <td class="paramname"><em>forces</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculates fluxes between the ocean and ice-shelf using the three-equations formulation (optional to use just two equations). See <a class="el" href="namespacemom__ice__shelf.html#section_ICE_SHELF_equations">ICE_SHELF equations</a>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">state</td><td>structure containing fields that describe the surface state of the ocean </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>structure containing pointers to any possible thermodynamic or mass-flux forcing fields. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>Start time of the fluxes. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time_step</td><td>Length of time over which these fluxes will be applied [s]. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>A pointer to the control structure returned by a previous call to initialize_ice_shelf. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">forces</td><td>A structure with the driving mechanical forces </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__ice__shelf_8F90_source.html#l00193">193</a> of file <a class="el" href="MOM__ice__shelf_8F90_source.html">MOM_ice_shelf.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;  <span class="keywordtype">type</span>(surface),         <span class="keywordtype">intent(inout)</span> :: state<span class="comment"> !&lt; structure containing fields that</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">                                                !!describe the surface state of the ocean</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  <span class="keywordtype">type</span>(forcing),         <span class="keywordtype">intent(inout)</span> :: fluxes<span class="comment"> !&lt; structure containing pointers to any possible</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="comment">                                                 !! thermodynamic or mass-flux forcing fields.</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  <span class="keywordtype">type</span>(time_type),       <span class="keywordtype">intent(in)</span>    :: Time<span class="comment">  !&lt; Start time of the fluxes.</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>    :: time_step<span class="comment"> !&lt; Length of time over which</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment">                                                    !! these fluxes will be applied [s].</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_CS),    <span class="keywordtype">pointer</span>       :: CS<span class="comment"> !&lt; A pointer to the control structure</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="comment">                                             !! returned by a previous call to</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="comment">                                             !! initialize_ice_shelf.</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;  <span class="keywordtype">type</span>(mech_forcing), <span class="keywordtype">optional</span>, <span class="keywordtype">intent(inout)</span> :: forces<span class="comment"> !&lt; A structure with the driving mechanical forces</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160; </div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">pointer</span> :: G =&gt; null() <span class="comment">! The grid structure used by the ice shelf.</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type), <span class="keywordtype">pointer</span> :: US =&gt; null() <span class="comment">! Pointer to a structure containing</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                                                 <span class="comment">! various unit conversion factors</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_state), <span class="keywordtype">pointer</span> :: ISS =&gt; null() <span class="comment">!&lt; A structure with elements that describe</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="comment">                                          !! the ice-shelf state</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160; </div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(CS%grid))</span> :: &amp;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    Rhoml, &amp;   !&lt; Ocean mixed layer density [kg m-3].</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    dR0_dT, &amp;  !&lt; Partial derivative of the mixed layer density</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment">               !&lt; with temperature [kg m-3 degC-1].</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    dr0_ds, &amp;  <span class="comment">!&lt; Partial derivative of the mixed layer density</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">               !&lt; with salinity [kg m-3 ppt-1].</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    p_int      <span class="comment">!&lt; The pressure at the ice-ocean interface [Pa].</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160; </div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(CS%grid),SZJ_(CS%grid))</span> :: &amp;</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    exch_vel_t, &amp;  !&lt; Sub-shelf thermal exchange velocity [m s-1]</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    exch_vel_s<span class="comment">     !&lt; Sub-shelf salt exchange velocity [m s-1]</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160; </div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZDI_(CS%grid),SZDJ_(CS%grid))</span> :: &amp;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    mass_flux<span class="comment">  !&lt; total mass flux of freshwater across</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZDI_(CS%grid),SZDJ_(CS%grid))</span> :: &amp;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    haline_driving<span class="comment"> !&lt; (SSS - S_boundary) ice-ocean</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment">               !! interface, positive for melting and negative for freezing.</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="comment">               !! This is computed as part of the ISOMIP diagnostics.</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: VK    = 0.40<span class="comment"> !&lt; Von Karman&#39;s constant - dimensionless</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="keywordtype">  real</span> :: ZETA_N = 0.052<span class="comment"> !&gt; The fraction of the boundary layer over which the</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="comment">               !! viscosity is linearly increasing. (Was 1/8. Why?)</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: RC    = 0.20     <span class="comment">! critical flux Richardson number.</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="keywordtype">  real</span> :: I_ZETA_N<span class="comment"> !&lt; The inverse of ZETA_N.</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="keywordtype">  real</span> :: LF, I_LF<span class="comment"> !&lt; Latent Heat of fusion [J kg-1] and its inverse.</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="keywordtype">  real</span> :: I_VK<span class="comment">     !&lt; The inverse of VK.</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="keywordtype">  real</span> :: PR, SC<span class="comment">   !&lt; The Prandtl number and Schmidt number [nondim].</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160; </div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  <span class="comment">! 3 equations formulation variables</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZDI_(CS%grid),SZDJ_(CS%grid))</span> :: &amp;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    Sbdry<span class="comment">     !&lt; Salinities in the ocean at the interface with the ice shelf [ppt].</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="keywordtype">  real</span> :: Sbdry_it</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="keywordtype">  real</span> :: Sbdry1, Sbdry2, S_a, S_b, S_c  <span class="comment">! use to find salt roots</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="keywordtype">  real</span> :: dS_it<span class="comment">    !&lt; The interface salinity change during an iteration [ppt].</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="keywordtype">  real</span> :: hBL_neut<span class="comment"> !&lt; The neutral boundary layer thickness [m].</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="keywordtype">  real</span> :: hBL_neut_h_molec<span class="comment"> !&lt; The ratio of the neutral boundary layer thickness</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="comment">                   !! to the molecular boundary layer thickness [nondim].</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  <span class="comment">!### THESE ARE CURRENTLY POSITIVE UPWARD.</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="keywordtype">  real</span> :: wT_flux<span class="comment"> !&lt; The vertical flux of heat just inside the ocean [degC m s-1].</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="keywordtype">  real</span> :: wB_flux<span class="comment"> !&lt; The vertical flux of heat just inside the ocean [m2 s-3].</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="keywordtype">  real</span> :: dB_dS<span class="comment">   !&lt; The derivative of buoyancy with salinity [m s-2 ppt-1].</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="keywordtype">  real</span> :: dB_dT<span class="comment">   !&lt; The derivative of buoyancy with temperature [m s-2 degC-1].</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="keywordtype">  real</span> :: I_n_star, n_star_term, absf</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="keywordtype">  real</span> :: dIns_dwB<span class="comment"> !&lt; The partial derivative of I_n_star with wB_flux, in ???.</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="keywordtype">  real</span> :: dT_ustar, dS_ustar</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="keywordtype">  real</span> :: ustar_h</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="keywordtype">  real</span> :: Gam_turb</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="keywordtype">  real</span> :: Gam_mol_t, Gam_mol_s</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="keywordtype">  real</span> :: RhoCp</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="keywordtype">  real</span> :: I_RhoLF</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="keywordtype">  real</span> :: ln_neut</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="keywordtype">  real</span> :: mass_exch</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="keywordtype">  real</span> :: Sb_min, Sb_max</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="keywordtype">  real</span> :: dS_min, dS_max</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;  <span class="comment">! Variables used in iterating for wB_flux.</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="keywordtype">  real</span> :: wB_flux_new, DwB, dDwB_dwB_in</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="keywordtype">  real</span> :: I_Gam_T, I_Gam_S, dG_dwB, iDens</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="keywordtype">  real</span> :: u_at_h, v_at_h, Isqrt2</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;  <span class="keywordtype">logical</span> :: Sb_min_set, Sb_max_set</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;  <span class="keywordtype">logical</span> :: update_ice_vel <span class="comment">! If true, it is time to update the ice shelf velocities.</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;  <span class="keywordtype">logical</span> :: coupled_GL     <span class="comment">! If true, the grouding line position is determined based on</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                            <span class="comment">! coupled ice-ocean dynamics.</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160; </div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: c2_3 = 2.0/3.0</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;  <span class="keywordtype">character(len=160)</span> :: mesg  <span class="comment">! The text of an error message</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je, ied, jed, it1, it3</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: rho_fw = 1000.0 <span class="comment">! fresh water density</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160; </div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;shelf_calc_flux: &quot;</span>// &amp;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;       <span class="stringliteral">&quot;initialize_ice_shelf must be called before shelf_calc_flux.&quot;</span>)</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_shelf)</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160; </div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;  g =&gt; cs%grid ; us =&gt; cs%US</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;  iss =&gt; cs%ISS</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160; </div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;  <span class="comment">! useful parameters</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; ied = g%ied ; jed = g%jed</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;  i_zeta_n = 1.0 / zeta_n</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;  lf = cs%Lat_fusion</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  i_rholf = 1.0/(cs%Rho0*lf)</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;  i_lf = 1.0 / lf</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  sc = cs%kv_molec/cs%kd_molec_salt</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;  pr = cs%kv_molec/cs%kd_molec_temp</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;  i_vk = 1.0/vk</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;  rhocp = cs%Rho0 * cs%Cp</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;  isqrt2 = 1.0/sqrt(2.0)</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160; </div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;  <span class="comment">!first calculate molecular component</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;  gam_mol_t = 12.5 * (pr**c2_3) - 6</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;  gam_mol_s = 12.5 * (sc**c2_3) - 6</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160; </div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;  idens = 1.0/cs%density_ocean_avg</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160; </div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;  <span class="comment">! GMM, zero some fields of the ice shelf structure (ice_shelf_CS)</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;  <span class="comment">! these fields are already set to zero during initialization</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;  <span class="comment">! However, they seem to be changed somewhere and, for diagnostic</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  <span class="comment">! reasons, it is better to set them to zero again.</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;  exch_vel_t(:,:) = 0.0 ; exch_vel_s(:,:) = 0.0</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;  iss%tflux_shelf(:,:) = 0.0 ; iss%water_flux(:,:) = 0.0</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;  iss%salt_flux(:,:) = 0.0; iss%tflux_ocn(:,:) = 0.0</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;  iss%tfreeze(:,:) = 0.0</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;  <span class="comment">! define Sbdry to avoid Run-Time Check Failure, when melt is not computed.</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;  haline_driving(:,:) = 0.0</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;  sbdry(:,:) = state%sss(:,:)</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160; </div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;  <span class="comment">!update time</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  cs%Time = time</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160; </div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;  <span class="keywordflow">if</span> (cs%override_shelf_movement) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    cs%time_step = time_step</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <span class="comment">! update shelf mass</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="keywordflow">if</span> (cs%mass_from_file) <span class="keyword">call </span>update_shelf_mass(g, cs, iss, time)</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160; </div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="keyword">call </span>hchksum(fluxes%frac_shelf_h, <span class="stringliteral">&quot;frac_shelf_h before apply melting&quot;</span>, g%HI, haloshift=0)</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    <span class="keyword">call </span>hchksum(state%sst, <span class="stringliteral">&quot;sst before apply melting&quot;</span>, g%HI, haloshift=0)</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="keyword">call </span>hchksum(state%sss, <span class="stringliteral">&quot;sss before apply melting&quot;</span>, g%HI, haloshift=0)</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="keyword">call </span>hchksum(state%u, <span class="stringliteral">&quot;u_ml before apply melting&quot;</span>, g%HI, haloshift=0)</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <span class="keyword">call </span>hchksum(state%v, <span class="stringliteral">&quot;v_ml before apply melting&quot;</span>, g%HI, haloshift=0)</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="keyword">call </span>hchksum(state%ocean_mass, <span class="stringliteral">&quot;ocean_mass before apply melting&quot;</span>, g%HI, haloshift=0)</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160; </div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  <span class="keywordflow">do</span> j=js,je</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <span class="comment">! Find the pressure at the ice-ocean interface, averaged only over the</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="comment">! part of the cell covered by ice shelf.</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; p_int(i) = cs%g_Earth * iss%mass_shelf(i,j) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160; </div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="comment">! Calculate insitu densities and expansion coefficients</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <span class="keyword">call </span>calculate_density(state%sst(:,j),state%sss(:,j), p_int, &amp;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;             rhoml(:), is, ie-is+1, cs%eqn_of_state)</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <span class="keyword">call </span>calculate_density_derivs(state%sst(:,j), state%sss(:,j), p_int, &amp;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;             dr0_dt, dr0_ds, is, ie-is+1, cs%eqn_of_state)</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160; </div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;      <span class="comment">! set ustar_shelf to zero. This is necessary if shelf_mass_is_dynamic</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;      <span class="comment">! but it won&#39;t make a difference otherwise.</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;      fluxes%ustar_shelf(i,j)= 0.0</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160; </div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;      <span class="comment">! DNG - to allow this everywhere Hml&gt;0.0 allows for melting under grounded cells</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      <span class="comment">!       propose instead to allow where Hml &gt; [some threshold]</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160; </div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;      <span class="keywordflow">if</span> ((idens*state%ocean_mass(i,j) &gt; cs%col_thick_melt_threshold) .and. &amp;</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;          (iss%area_shelf_h(i,j) &gt; 0.0) .and. &amp;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;          (cs%isthermo) .and. (state%Hml(i,j) &gt; 0.0) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160; </div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        <span class="keywordflow">if</span> (cs%threeeq) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;          <span class="comment">!   Iteratively determine a self-consistent set of fluxes, with the ocean</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;          <span class="comment">! salinity just below the ice-shelf as the variable that is being</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;          <span class="comment">! iterated for.</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;          <span class="comment">! ### SHOULD I SET USTAR_SHELF YET?</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160; </div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;          u_at_h = state%u(i,j)</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;          v_at_h = state%v(i,j)</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160; </div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;          <span class="comment">!### I think that CS%utide**1 should be CS%utide**2</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;          fluxes%ustar_shelf(i,j) = max(cs%ustar_bg, us%m_to_Z*us%T_to_s * &amp;</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;              sqrt(cs%cdrag*((u_at_h**2 + v_at_h**2) + cs%utide(i,j)**1)))</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160; </div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;          ustar_h = us%Z_to_m*us%s_to_T*fluxes%ustar_shelf(i,j)</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160; </div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">associated</span>(state%taux_shelf) .and. <span class="keyword">associated</span>(state%tauy_shelf)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            state%taux_shelf(i,j) = ustar_h*ustar_h*cs%Rho0*isqrt2</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            state%tauy_shelf(i,j) = state%taux_shelf(i,j)</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160; </div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;          <span class="comment">! Estimate the neutral ocean boundary layer thickness as the minimum of the</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;          <span class="comment">! reported ocean mixed layer thickness and the neutral Ekman depth.</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;          absf = 0.25*us%s_to_T*((abs(us%s_to_T*g%CoriolisBu(i,j)) + abs(us%s_to_T*g%CoriolisBu(i-1,j-1))) + &amp;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                                 (abs(us%s_to_T*g%CoriolisBu(i,j-1)) + abs(us%s_to_T*g%CoriolisBu(i-1,j))))</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;          <span class="keywordflow">if</span> (absf*state%Hml(i,j) &lt;= vk*ustar_h) <span class="keywordflow">then</span> ; hbl_neut = state%Hml(i,j)</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;          <span class="keywordflow">else</span> ; hbl_neut = (vk*ustar_h) / absf ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;          hbl_neut_h_molec = zeta_n * ((hbl_neut * ustar_h) / (5.0 * cs%Kv_molec))</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160; </div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;          <span class="comment">! Determine the mixed layer buoyancy flux, wB_flux.</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;          db_ds = (cs%g_Earth / rhoml(i)) * dr0_ds(i)</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;          db_dt = (cs%g_Earth / rhoml(i)) * dr0_dt(i)</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;          ln_neut = 0.0 ; <span class="keywordflow">if</span> (hbl_neut_h_molec &gt; 1.0) ln_neut = log(hbl_neut_h_molec)</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160; </div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;          <span class="keywordflow">if</span> (cs%find_salt_root) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;            <span class="comment">! read liquidus parameters</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160; </div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;            s_a = cs%lambda1 * cs%Gamma_T_3EQ * cs%Cp</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="comment">!            S_b = -CS%Gamma_T_3EQ*(CS%lambda2-CS%lambda3*p_int(i)-state%sst(i,j)) &amp;</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="comment">!               -LF*CS%Gamma_T_3EQ/35.0</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160; </div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;            s_b = cs%Gamma_T_3EQ*cs%Cp*(cs%lambda2+cs%lambda3*p_int(i)- &amp;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                  state%sst(i,j))-lf*cs%Gamma_T_3EQ/35.0</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;            s_c = lf*(cs%Gamma_T_3EQ/35.0)*state%sss(i,j)</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160; </div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;            <span class="comment">!### Depending on the sign of S_b, one of these will be inaccurate!</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;            sbdry1 = (-s_b + sqrt(s_b*s_b-4*s_a*s_c))/(2*s_a)</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;            sbdry2 = (-s_b - sqrt(s_b*s_b-4*s_a*s_c))/(2*s_a)</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;            sbdry(i,j) = max(sbdry1, sbdry2)</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            <span class="comment">! Safety check</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;            <span class="keywordflow">if</span> (sbdry(i,j) &lt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;              <span class="keyword">write</span>(mesg,*) <span class="stringliteral">&#39;state%sss(i,j) = &#39;</span>,state%sss(i,j), <span class="stringliteral">&#39;S_a, S_b, S_c&#39;</span>, s_a, s_b, s_c</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;              <span class="keyword">call </span>mom_error(warning, mesg, .true.)</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;              <span class="keyword">write</span>(mesg,*) <span class="stringliteral">&#39;I,J,Sbdry1,Sbdry2&#39;</span>,i,j,sbdry1,sbdry2</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;              <span class="keyword">call </span>mom_error(warning, mesg, .true.)</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;              <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;shelf_calc_flux: Negative salinity (Sbdry).&quot;</span>)</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;            <span class="comment">! Guess sss as the iteration starting point for the boundary salinity.</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;            sbdry(i,j) = state%sss(i,j) ; sb_max_set = .false.</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;            sb_min_set = .false.</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="keywordflow">          endif</span> <span class="comment">!find_salt_root</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160; </div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;          <span class="keywordflow">do</span> it1 = 1,20</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;            <span class="comment">! Determine the potential temperature at the ice-ocean interface.</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            <span class="keyword">call </span>calculate_tfreeze(sbdry(i,j), p_int(i), iss%tfreeze(i,j), cs%eqn_of_state)</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160; </div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;            dt_ustar = (state%sst(i,j) - iss%tfreeze(i,j)) * ustar_h</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;            ds_ustar = (state%sss(i,j) - sbdry(i,j)) * ustar_h</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160; </div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;            <span class="comment">! First, determine the buoyancy flux assuming no effects of stability</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;            <span class="comment">! on the turbulence.  Following H &amp; J &#39;99, this limit also applies</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;            <span class="comment">! when the buoyancy flux is destabilizing.</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160; </div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;            <span class="keywordflow">if</span> (cs%const_gamma) <span class="keywordflow">then</span> <span class="comment">! if using a constant gamma_T</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;              <span class="comment">! note the different form, here I_Gam_T is NOT 1/Gam_T!</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;              i_gam_t = cs%Gamma_T_3EQ</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;              i_gam_s = cs%Gamma_T_3EQ/35.</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;              gam_turb = i_vk * (ln_neut + (0.5 * i_zeta_n - 1.0))</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;              i_gam_t = 1.0 / (gam_mol_t + gam_turb)</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;              i_gam_s = 1.0 / (gam_mol_s + gam_turb)</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160; </div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;            wt_flux = dt_ustar * i_gam_t</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;            wb_flux = db_ds * (ds_ustar * i_gam_s) + db_dt * wt_flux</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160; </div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;            <span class="keywordflow">if</span> (wb_flux &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;              <span class="comment">! The buoyancy flux is stabilizing and will reduce the tubulent</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;              <span class="comment">! fluxes, and iteration is required.</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;              n_star_term = (zeta_n/rc) * (hbl_neut * vk) / ustar_h**3</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;              <span class="keywordflow">do</span> it3 = 1,30</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;               <span class="comment">! n_star &lt;= 1.0 is the ratio of working boundary layer thickness</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;               <span class="comment">! to the neutral thickness.</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;               <span class="comment">! hBL = n_star*hBL_neut ; hSub = 1/8*n_star*hBL</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160; </div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                i_n_star = sqrt(1.0 + n_star_term * wb_flux)</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                dins_dwb = 0.5 * n_star_term / i_n_star</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                <span class="keywordflow">if</span> (hbl_neut_h_molec &gt; i_n_star**2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                  gam_turb = i_vk * ((ln_neut - 2.0*log(i_n_star)) + &amp;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                                    (0.5*i_zeta_n*i_n_star - 1.0))</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                  dg_dwb =  i_vk * ( -2.0 / i_n_star + (0.5 * i_zeta_n)) * dins_dwb</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                  <span class="comment">!   The layer dominated by molecular viscosity is smaller than</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                  <span class="comment">! the assumed boundary layer.  This should be rare!</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                  gam_turb = i_vk * (0.5 * i_zeta_n*i_n_star - 1.0)</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                  dg_dwb = i_vk * (0.5 * i_zeta_n) * dins_dwb</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160; </div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                <span class="keywordflow">if</span> (cs%const_gamma) <span class="keywordflow">then</span> <span class="comment">! if using a constant gamma_T</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                  <span class="comment">! note the different form, here I_Gam_T is NOT 1/Gam_T!</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                  i_gam_t = cs%Gamma_T_3EQ</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                  i_gam_s = cs%Gamma_T_3EQ/35.</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;                  i_gam_t = 1.0 / (gam_mol_t + gam_turb)</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                  i_gam_s = 1.0 / (gam_mol_s + gam_turb)</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160; </div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                wt_flux = dt_ustar * i_gam_t</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                wb_flux_new = db_ds * (ds_ustar * i_gam_s) + db_dt * wt_flux</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160; </div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                <span class="comment">! Find the root where dwB = 0.0</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                dwb = wb_flux_new - wb_flux</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                <span class="keywordflow">if</span> (abs(wb_flux_new - wb_flux) &lt; &amp;</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                    1e-4*(abs(wb_flux_new) + abs(wb_flux))) <span class="keywordflow">exit</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160; </div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                ddwb_dwb_in = -dg_dwb * (db_ds * (ds_ustar * i_gam_s**2) + &amp;</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                                         db_dt * (dt_ustar * i_gam_t**2)) - 1.0</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                <span class="comment">! This is Newton&#39;s method without any bounds.</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                <span class="comment">! ### SHOULD BOUNDS BE NEEDED?</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                wb_flux_new = wb_flux - dwb / ddwb_dwb_in</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="keywordflow">              enddo</span> <span class="comment">!it3</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160; </div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;            iss%tflux_ocn(i,j)  = rhocp * wt_flux</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;            exch_vel_t(i,j) = ustar_h * i_gam_t</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;            exch_vel_s(i,j) = ustar_h * i_gam_s</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160; </div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="comment">!Calculate the heat flux inside the ice shelf.</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160; </div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    <span class="comment">!vertical adv/diff as in H+J 1999, eqns (26) &amp; approx from (31).</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    <span class="comment">! Q_ice = rho_ice * CS%CP_Ice * K_ice * dT/dz (at interface)</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="comment">!vertical adv/diff as in H+J 199, eqs (31) &amp; (26)...</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="comment">!  dT/dz ~= min( (lprec/(rho_ice*K_ice))*(CS%Temp_Ice-T_freeze) , 0.0 )</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="comment">!If this approximation is not made, iterations are required... See H+J Fig 3.</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160; </div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;            <span class="keywordflow">if</span> (iss%tflux_ocn(i,j) &lt;= 0.0) <span class="keywordflow">then</span>  <span class="comment">! Freezing occurs, so zero ice heat flux.</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;              iss%water_flux(i,j) = i_lf * iss%tflux_ocn(i,j)</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;              iss%tflux_shelf(i,j) = 0.0</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;              <span class="keywordflow">if</span> (cs%insulator) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                <span class="comment">!no conduction/perfect insulator</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                iss%tflux_shelf(i,j) = 0.0</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                iss%water_flux(i,j) = i_lf * (- iss%tflux_shelf(i,j) + iss%tflux_ocn(i,j))</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160; </div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                <span class="comment">! With melting, from H&amp;J 1999, eqs (31) &amp; (26)...</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                <span class="comment">!   Q_ice ~= cp_ice * (CS%Temp_Ice-T_freeze) * lprec</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                <span class="comment">!   RhoLF*lprec = Q_ice + ISS%tflux_ocn(i,j)</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                <span class="comment">!   lprec = (ISS%tflux_ocn(i,j)) / (LF + cp_ice * (T_freeze-CS%Temp_Ice))</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                iss%water_flux(i,j) = iss%tflux_ocn(i,j) / &amp;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                      (lf + cs%CP_Ice * (iss%tfreeze(i,j) - cs%Temp_Ice))</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160; </div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                iss%tflux_shelf(i,j) = iss%tflux_ocn(i,j) - lf*iss%water_flux(i,j)</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160; </div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;            <span class="comment">!other options: dTi/dz linear through shelf</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;            <span class="comment">!    dTi_dz = (CS%Temp_Ice - ISS%tfreeze(i,j))/G%draft(i,j)</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;            <span class="comment">!    ISS%tflux_shelf(i,j) = - Rho_Ice * CS%CP_Ice * KTI * dTi_dz</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160; </div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160; </div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;            <span class="keywordflow">if</span> (cs%find_salt_root) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;              <span class="keywordflow">exit</span> <span class="comment">! no need to do interaction, so exit loop</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160; </div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;              mass_exch = exch_vel_s(i,j) * cs%Rho0</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;              sbdry_it = (state%sss(i,j) * mass_exch + cs%Salin_ice * &amp;</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                          iss%water_flux(i,j)) / (mass_exch + iss%water_flux(i,j))</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;              ds_it = sbdry_it - sbdry(i,j)</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;              <span class="keywordflow">if</span> (abs(ds_it) &lt; 1e-4*(0.5*(state%sss(i,j) + sbdry(i,j) + 1.e-10))) <span class="keywordflow">exit</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160; </div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160; </div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;              <span class="keywordflow">if</span> (ds_it &lt; 0.0) <span class="keywordflow">then</span> <span class="comment">! Sbdry is now the upper bound.</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;                <span class="keywordflow">if</span> (sb_max_set .and. (sbdry(i,j) &gt; sb_max)) &amp;</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;                <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;shelf_calc_flux: Irregular iteration for Sbdry (max).&quot;</span>)</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;                sb_max = sbdry(i,j) ; ds_max = ds_it ; sb_max_set = .true.</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;              <span class="keywordflow">else</span> <span class="comment">! Sbdry is now the lower bound.</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                <span class="keywordflow">if</span> (sb_min_set .and. (sbdry(i,j) &lt; sb_min)) &amp;</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                   <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                   <span class="stringliteral">&quot;shelf_calc_flux: Irregular iteration for Sbdry (min).&quot;</span>)</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                   sb_min = sbdry(i,j) ; ds_min = ds_it ; sb_min_set = .true.</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="keywordflow">              endif</span> <span class="comment">! dS_it &lt; 0.0</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160; </div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;              <span class="keywordflow">if</span> (sb_min_set .and. sb_max_set) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                <span class="comment">! Use the false position method for the next iteration.</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;                sbdry(i,j) = sb_min + (sb_max-sb_min) * &amp;</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                            (ds_min / (ds_min - ds_max))</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                sbdry(i,j) = sbdry_it</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="keywordflow">              endif</span> <span class="comment">! Sb_min_set</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160; </div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;              sbdry(i,j) = sbdry_it</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="keywordflow">            endif</span> <span class="comment">! CS%find_salt_root</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160; </div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="keywordflow">          enddo</span> <span class="comment">!it1</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;  <span class="comment">! Check for non-convergence and/or non-boundedness?</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160; </div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;          <span class="comment">!   In the 2-equation form, the mixed layer turbulent exchange velocity</span></div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;          <span class="comment">! is specified and large enough that the ocean salinity at the interface</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;          <span class="comment">! is about the same as the boundary layer salinity.</span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160; </div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;          <span class="keyword">call </span>calculate_tfreeze(state%sss(i,j), p_int(i), iss%tfreeze(i,j), cs%eqn_of_state)</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160; </div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;          exch_vel_t(i,j) = cs%gamma_t</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;          iss%tflux_ocn(i,j) = rhocp * exch_vel_t(i,j) * (state%sst(i,j) - iss%tfreeze(i,j))</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;          iss%tflux_shelf(i,j) = 0.0</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;          iss%water_flux(i,j) = i_lf * iss%tflux_ocn(i,j)</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;          sbdry(i,j) = 0.0</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;      <span class="keywordflow">else</span> <span class="comment">!not shelf</span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;        iss%tflux_ocn(i,j) = 0.0</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160; </div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;<span class="comment">!      haline_driving(:,:) = state%sss(i,j) - Sbdry(i,j)</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160; </div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! i-loop</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! j-loop</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160; </div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;  <span class="comment">! ISS%water_flux = net liquid water into the ocean ( kg/(m^2 s) )</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;  <span class="comment">! We want melt in m/year</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;  <span class="keywordflow">if</span> (cs%const_gamma) <span class="keywordflow">then</span> <span class="comment">! use ISOMIP+ eq. with rho_fw</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    fluxes%iceshelf_melt = iss%water_flux  * (86400.0*365.0/rho_fw) * cs%flux_factor</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  <span class="keywordflow">else</span> <span class="comment">! use original eq.</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    fluxes%iceshelf_melt = iss%water_flux  * (86400.0*365.0/cs%density_ice) * cs%flux_factor</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160; </div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="keywordflow">if</span> ((idens*state%ocean_mass(i,j) &gt; cs%col_thick_melt_threshold) .and. &amp;</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        (iss%area_shelf_h(i,j) &gt; 0.0) .and. &amp;</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        (cs%isthermo) .and. (state%Hml(i,j) &gt; 0.0) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160; </div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;      <span class="comment">! Set melt to zero above a cutoff pressure</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;      <span class="comment">! (CS%Rho0*CS%cutoff_depth*CS%g_Earth) this is needed for the isomip</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;      <span class="comment">! test case.</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;      <span class="keywordflow">if</span> ((cs%g_Earth * iss%mass_shelf(i,j)) &lt; cs%Rho0*cs%cutoff_depth* &amp;</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;         cs%g_Earth) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;           iss%water_flux(i,j) = 0.0</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;           fluxes%iceshelf_melt(i,j) = 0.0</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;      <span class="comment">! Compute haline driving, which is one of the diags. used in ISOMIP</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;      haline_driving(i,j) = (iss%water_flux(i,j) * sbdry(i,j)) / &amp;</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                            (cs%Rho0 * exch_vel_s(i,j))</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160; </div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;      <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!Safety checks !!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;      <span class="comment">!1)Check if haline_driving computed above is consistent with</span></div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;      <span class="comment">! haline_driving = state%sss - Sbdry</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;      <span class="comment">!if (fluxes%iceshelf_melt(i,j) /= 0.0) then</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;      <span class="comment">!   if (haline_driving(i,j) /= (state%sss(i,j) - Sbdry(i,j))) then</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;      <span class="comment">!     write(mesg,*) &#39;at i,j=&#39;,i,j,&#39; haline_driving, sss-Sbdry&#39;,haline_driving(i,j), &amp;</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;      <span class="comment">!                   (state%sss(i,j) - Sbdry(i,j))</span></div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;      <span class="comment">!     call MOM_error(FATAL, &amp;</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;      <span class="comment">!            &quot;shelf_calc_flux: Inconsistency in melt and haline_driving&quot;//trim(mesg))</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;      <span class="comment">!   endif</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;      <span class="comment">!endif</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160; </div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;      <span class="comment">! 2) check if |melt| &gt; 0 when ustar_shelf = 0.</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;      <span class="comment">! this should never happen</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;      <span class="keywordflow">if</span> ((abs(fluxes%iceshelf_melt(i,j))&gt;0.0) .and. (fluxes%ustar_shelf(i,j) == 0.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        <span class="keyword">write</span>(mesg,*) <span class="stringliteral">&quot;|melt| = &quot;</span>,fluxes%iceshelf_melt(i,j),<span class="stringliteral">&quot; &gt; 0 and ustar_shelf = 0. at i,j&quot;</span>, i, j</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;shelf_calc_flux: &quot;</span>//trim(mesg))</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">! area_shelf_h</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;       <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!End of safety checks !!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i- and j-loops</span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160; </div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;  <span class="comment">! mass flux [kg s-1], part of ISOMIP diags.</span></div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;  mass_flux(:,:) = 0.0</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;  mass_flux(:,:) = iss%water_flux(:,:) * iss%area_shelf_h(:,:)</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160; </div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;  <span class="keywordflow">if</span> (cs%active_shelf_dynamics .or. cs%override_shelf_movement) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <span class="keyword">call </span>pass_var(iss%area_shelf_h, g%domain, complete=.false.)</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    <span class="keyword">call </span>pass_var(iss%mass_shelf, g%domain)</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;    <span class="keyword">call </span>cpu_clock_end(id_clock_pass)</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160; </div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;  <span class="comment">! Melting has been computed, now is time to update thickness and mass</span></div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;  <span class="keywordflow">if</span> ( cs%override_shelf_movement .and. (.not.cs%mass_from_file)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    <span class="keyword">call </span>change_thickness_using_melt(iss, g, time_step, fluxes, cs%rho_ice, cs%debug)</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160; </div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;      <span class="keyword">call </span>hchksum(iss%h_shelf, <span class="stringliteral">&quot;h_shelf after change thickness using melt&quot;</span>, g%HI, haloshift=0, scale=us%Z_to_m)</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;      <span class="keyword">call </span>hchksum(iss%mass_shelf, <span class="stringliteral">&quot;mass_shelf after change thickness using melt&quot;</span>, g%HI, haloshift=0)</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160; </div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keyword">call </span>mom_forcing_chksum(<span class="stringliteral">&quot;Before add shelf flux&quot;</span>, fluxes, g, cs%US, haloshift=0)</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160; </div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;  <span class="keyword">call </span>add_shelf_flux(g, us, cs, state, fluxes)</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160; </div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;  <span class="comment">! now the thermodynamic data is passed on... time to update the ice dynamic quantities</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160; </div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;  <span class="keywordflow">if</span> (cs%active_shelf_dynamics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;    update_ice_vel = .false.</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    coupled_gl = (cs%GL_couple .and. .not.cs%solo_ice_sheet)</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160; </div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    <span class="comment">! advect the ice shelf, and advance the front. Calving will be in here somewhere as well..</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    <span class="comment">! when we decide on how to do it</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;    <span class="keyword">call </span>update_ice_shelf(cs%dCS, iss, g, us, time_step, time, state%ocean_mass, coupled_gl)</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160; </div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160; </div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;  <span class="keyword">call </span>enable_averaging(time_step,time,cs%diag)</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;  <span class="keywordflow">if</span> (cs%id_shelf_mass &gt; 0) <span class="keyword">call </span>post_data(cs%id_shelf_mass, iss%mass_shelf, cs%diag)</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;  <span class="keywordflow">if</span> (cs%id_area_shelf_h &gt; 0) <span class="keyword">call </span>post_data(cs%id_area_shelf_h, iss%area_shelf_h, cs%diag)</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;  <span class="keywordflow">if</span> (cs%id_ustar_shelf &gt; 0) <span class="keyword">call </span>post_data(cs%id_ustar_shelf, fluxes%ustar_shelf, cs%diag)</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;  <span class="keywordflow">if</span> (cs%id_melt &gt; 0) <span class="keyword">call </span>post_data(cs%id_melt, fluxes%iceshelf_melt, cs%diag)</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;  <span class="keywordflow">if</span> (cs%id_thermal_driving &gt; 0) <span class="keyword">call </span>post_data(cs%id_thermal_driving, (state%sst-iss%tfreeze), cs%diag)</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;  <span class="keywordflow">if</span> (cs%id_Sbdry &gt; 0) <span class="keyword">call </span>post_data(cs%id_Sbdry, sbdry, cs%diag)</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;  <span class="keywordflow">if</span> (cs%id_haline_driving &gt; 0) <span class="keyword">call </span>post_data(cs%id_haline_driving, haline_driving, cs%diag)</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;  <span class="keywordflow">if</span> (cs%id_mass_flux &gt; 0) <span class="keyword">call </span>post_data(cs%id_mass_flux, mass_flux, cs%diag)</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;  <span class="keywordflow">if</span> (cs%id_u_ml &gt; 0) <span class="keyword">call </span>post_data(cs%id_u_ml, state%u, cs%diag)</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;  <span class="keywordflow">if</span> (cs%id_v_ml &gt; 0) <span class="keyword">call </span>post_data(cs%id_v_ml, state%v, cs%diag)</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;  <span class="keywordflow">if</span> (cs%id_tfreeze &gt; 0) <span class="keyword">call </span>post_data(cs%id_tfreeze, iss%tfreeze, cs%diag)</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;  <span class="keywordflow">if</span> (cs%id_tfl_shelf &gt; 0) <span class="keyword">call </span>post_data(cs%id_tfl_shelf, iss%tflux_shelf, cs%diag)</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;  <span class="keywordflow">if</span> (cs%id_exch_vel_t &gt; 0) <span class="keyword">call </span>post_data(cs%id_exch_vel_t, exch_vel_t, cs%diag)</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;  <span class="keywordflow">if</span> (cs%id_exch_vel_s &gt; 0) <span class="keyword">call </span>post_data(cs%id_exch_vel_s, exch_vel_s, cs%diag)</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;  <span class="keywordflow">if</span> (cs%id_h_shelf &gt; 0) <span class="keyword">call </span>post_data(cs%id_h_shelf,iss%h_shelf,cs%diag)</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;  <span class="keywordflow">if</span> (cs%id_h_mask &gt; 0) <span class="keyword">call </span>post_data(cs%id_h_mask,iss%hmask,cs%diag)</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;  <span class="keyword">call </span>disable_averaging(cs%diag)</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160; </div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(forces)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    <span class="keyword">call </span>add_shelf_forces(g, us, cs, forces, do_shelf_area=(cs%active_shelf_dynamics .or. &amp;</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;                                                        cs%override_shelf_movement))</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160; </div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_shelf)</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160; </div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keyword">call </span>mom_forcing_chksum(<span class="stringliteral">&quot;End of shelf calc flux&quot;</span>, fluxes, g, cs%US, haloshift=0)</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__ice__shelf_8F90_source.html#l00864">add_shelf_flux()</a>, <a class="el" href="MOM__ice__shelf_8F90_source.html#l00754">add_shelf_forces()</a>, <a class="el" href="MOM__ice__shelf_8F90_source.html#l00701">change_thickness_using_melt()</a>, <a class="el" href="MOM__diag__mediator_8F90_source.html#l01820">mom_diag_mediator::disable_averaging()</a>, <a class="el" href="MOM__diag__mediator_8F90_source.html#l01804">mom_diag_mediator::enable_averaging()</a>, <a class="el" href="MOM__ice__shelf_8F90_source.html#l00185">id_clock_pass</a>, <a class="el" href="MOM__ice__shelf_8F90_source.html#l00184">id_clock_shelf</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, and <a class="el" href="MOM__ice__shelf_8F90_source.html#l01675">update_shelf_mass()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__driver_8F90_source.html#l00001">mom_main()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_a84aff10af35c11912502a9cd7834dd50_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_a84aff10af35c11912502a9cd7834dd50_icgraph.svg" width="302" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a5331842e995aaf0a57772ccb5a48cdd1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5331842e995aaf0a57772ccb5a48cdd1">&#9670;&nbsp;</a></span>solo_time_step()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_ice_shelf::solo_time_step </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__ice__shelf_1_1ice__shelf__cs.html">ice_shelf_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>time_step</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(inout)&#160;</td>
          <td class="paramname"><em>nsteps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(inout)&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>min_time_step_in</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This routine is for stepping a stand-alone ice shelf model without an ocean. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>A pointer to the ice shelf control structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time_step</td><td>The time interval for this update [s]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">nsteps</td><td>The running number of ice shelf steps. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">time</td><td>The current model time </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">min_time_step_in</td><td>The minimum permitted time step [s]. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__ice__shelf_8F90_source.html#l01750">1750</a> of file <a class="el" href="MOM__ice__shelf_8F90_source.html">MOM_ice_shelf.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_CS), <span class="keywordtype">pointer</span>    :: CS<span class="comment"> !&lt; A pointer to the ice shelf control structure</span></div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;<span class="keywordtype">  real</span>,            <span class="keywordtype">intent(in)</span>    :: time_step<span class="comment"> !&lt; The time interval for this update [s].</span></div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;  <span class="keywordtype">integer</span>,         <span class="keywordtype">intent(inout)</span> :: nsteps<span class="comment">  !&lt; The running number of ice shelf steps.</span></div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;  <span class="keywordtype">type</span>(time_type), <span class="keywordtype">intent(inout)</span> :: Time<span class="comment"> !&lt; The current model time</span></div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;<span class="keywordtype">  real</span>,  <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: min_time_step_in<span class="comment"> !&lt; The minimum permitted time step [s].</span></div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160; </div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">pointer</span> :: G =&gt; null()</div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type), <span class="keywordtype">pointer</span> :: US =&gt; null() <span class="comment">! Pointer to a structure containing</span></div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;                                                 <span class="comment">! various unit conversion factors</span></div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_state), <span class="keywordtype">pointer</span> :: ISS =&gt; null() <span class="comment">!&lt; A structure with elements that describe</span></div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;<span class="comment">                                          !! the ice-shelf state</span></div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;  <span class="keywordtype">integer</span> :: is, iec, js, jec, i, j</div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;<span class="keywordtype">  real</span> :: time_step_remain</div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;<span class="keywordtype">  real</span> :: time_step_int, min_time_step</div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;  <span class="keywordtype">character(len=240)</span> :: mesg</div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;  <span class="keywordtype">logical</span> :: update_ice_vel <span class="comment">! If true, it is time to update the ice shelf velocities.</span></div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;  <span class="keywordtype">logical</span> :: coupled_GL     <span class="comment">! If true the grouding line position is determined based on</span></div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;                            <span class="comment">! coupled ice-ocean dynamics.</span></div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160; </div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;  g =&gt; cs%grid</div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;  us =&gt; cs%US</div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;  iss =&gt; cs%ISS</div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;  is = g%isc ; iec = g%iec ; js = g%jsc ; jec = g%jec</div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160; </div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;  time_step_remain = time_step</div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span> (min_time_step_in)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;    min_time_step = min_time_step_in</div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;    min_time_step = 1000.0 <span class="comment">! This is in seconds - at 1 km resolution it would imply ice is moving at ~1 meter per second</span></div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160; </div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;  <span class="keyword">write</span> (mesg,*) <span class="stringliteral">&quot;TIME in ice shelf call, yrs: &quot;</span>, time_type_to_real(time)/(365. * 86400.)</div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;  <span class="keyword">call </span>mom_mesg(<span class="stringliteral">&quot;solo_time_step: &quot;</span>//mesg)</div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160; </div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;  <span class="keywordflow">do</span> <span class="keywordflow">while</span> (time_step_remain &gt; 0.0)</div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;    nsteps = nsteps+1</div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160; </div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;    <span class="comment">! If time_step is not too long, this is unnecessary.</span></div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;    time_step_int = min(ice_time_step_cfl(cs%dCS, iss, g), time_step)</div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160; </div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;    <span class="keyword">write</span> (mesg,*) <span class="stringliteral">&quot;Ice model timestep = &quot;</span>, time_step_int, <span class="stringliteral">&quot; seconds&quot;</span></div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;    <span class="keywordflow">if</span> (time_step_int &lt; min_time_step) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_ice_shelf:solo_time_step: abnormally small timestep &quot;</span>//mesg)</div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;      <span class="keyword">call </span>mom_mesg(<span class="stringliteral">&quot;solo_time_step: &quot;</span>//mesg)</div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160; </div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;    <span class="keywordflow">if</span> (time_step_int &gt;= time_step_remain) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;      time_step_int = time_step_remain</div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;      time_step_remain = 0.0</div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;      time_step_remain = time_step_remain - time_step_int</div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160; </div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;    <span class="comment">! If the last mini-timestep is a day or less, we cannot expect velocities to change by much.</span></div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;    <span class="comment">! Do not update the velocities if the last step is very short.</span></div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;    update_ice_vel = ((time_step_int &gt; min_time_step) .or. (time_step_int &gt;= time_step))</div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;    coupled_gl = .false.</div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160; </div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;    <span class="keyword">call </span>update_ice_shelf(cs%dCS, iss, g, us, time_step_int, time, must_update_vel=update_ice_vel)</div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160; </div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;    <span class="keyword">call </span>enable_averaging(time_step,time,cs%diag)</div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;    <span class="keywordflow">if</span> (cs%id_area_shelf_h &gt; 0) <span class="keyword">call </span>post_data(cs%id_area_shelf_h, iss%area_shelf_h, cs%diag)</div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;    <span class="keywordflow">if</span> (cs%id_h_shelf &gt; 0) <span class="keyword">call </span>post_data(cs%id_h_shelf, iss%h_shelf, cs%diag)</div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;    <span class="keywordflow">if</span> (cs%id_h_mask &gt; 0) <span class="keyword">call </span>post_data(cs%id_h_mask, iss%hmask, cs%diag)</div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;    <span class="keyword">call </span>disable_averaging(cs%diag)</div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160; </div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__diag__mediator_8F90_source.html#l01820">mom_diag_mediator::disable_averaging()</a>, <a class="el" href="MOM__diag__mediator_8F90_source.html#l01804">mom_diag_mediator::enable_averaging()</a>, <a class="el" href="MOM__ice__shelf__dynamics_8F90_source.html#l00573">mom_ice_shelf_dynamics::ice_time_step_cfl()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, and <a class="el" href="MOM__error__handler_8F90_source.html#l00053">mom_error_handler::mom_mesg()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_a5331842e995aaf0a57772ccb5a48cdd1_cgraph.svg" width="591" height="314"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="af3b6307aa3522a6b6738f31e232ad2a5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af3b6307aa3522a6b6738f31e232ad2a5">&#9670;&nbsp;</a></span>update_shelf_mass()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_ice_shelf::update_shelf_mass </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__ice__shelf_1_1ice__shelf__cs.html">ice_shelf_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ice_shelf_state), intent(inout)&#160;</td>
          <td class="paramname"><em>ISS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Updates the ice shelf mass using data from a file. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>A pointer to the ice shelf control structure </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">iss</td><td>The ice shelf state type that is being updated </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>The current model time </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__ice__shelf_8F90_source.html#l01675">1675</a> of file <a class="el" href="MOM__ice__shelf_8F90_source.html">MOM_ice_shelf.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(inout)</span> :: G<span class="comment">   !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_CS),    <span class="keywordtype">intent(in)</span>    :: CS<span class="comment">  !&lt; A pointer to the ice shelf control structure</span></div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;  <span class="keywordtype">type</span>(ice_shelf_state), <span class="keywordtype">intent(inout)</span> :: ISS<span class="comment"> !&lt; The ice shelf state type that is being updated</span></div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;  <span class="keywordtype">type</span>(time_type),       <span class="keywordtype">intent(in)</span>    :: Time<span class="comment"> !&lt; The current model time</span></div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160; </div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;  <span class="comment">! local variables</span></div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je</div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec</div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160; </div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;  <span class="keyword">call </span>time_interp_external(cs%id_read_mass, time, iss%mass_shelf)</div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160; </div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;    iss%area_shelf_h(i,j) = 0.0</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;    iss%hmask(i,j) = 0.</div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;    <span class="keywordflow">if</span> (iss%mass_shelf(i,j) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;      iss%area_shelf_h(i,j) = g%US%L_to_m**2*g%areaT(i,j)</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;      iss%h_shelf(i,j) = iss%mass_shelf(i,j) / cs%rho_ice</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;      iss%hmask(i,j) = 1.</div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160; </div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;  <span class="comment">!call USER_update_shelf_mass(ISS%mass_shelf, ISS%area_shelf_h, ISS%h_shelf, &amp;</span></div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;  <span class="comment">!                            ISS%hmask, CS%grid, CS%user_CS, Time, .true.)</span></div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160; </div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;  <span class="keywordflow">if</span> (cs%min_thickness_simple_calve &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;    <span class="keyword">call </span>ice_shelf_min_thickness_calve(g, iss%h_shelf, iss%area_shelf_h, iss%hmask, &amp;</div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;                                       cs%min_thickness_simple_calve)</div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160; </div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;  <span class="keyword">call </span>pass_var(iss%area_shelf_h, g%domain)</div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;  <span class="keyword">call </span>pass_var(iss%h_shelf, g%domain)</div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;  <span class="keyword">call </span>pass_var(iss%hmask, g%domain)</div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;  <span class="keyword">call </span>pass_var(iss%mass_shelf, g%domain)</div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__ice__shelf_8F90_source.html#l00193">shelf_calc_flux()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__ice__shelf_af3b6307aa3522a6b6738f31e232ad2a5_icgraph.svg" width="515" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a3db8709f10aa77ed302598f3a23a608d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3db8709f10aa77ed302598f3a23a608d">&#9670;&nbsp;</a></span>id_clock_pass</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_ice_shelf::id_clock_pass</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>CPU Clock for group pass calls. </p>

<p class="definition">Definition at line <a class="el" href="MOM__ice__shelf_8F90_source.html#l00185">185</a> of file <a class="el" href="MOM__ice__shelf_8F90_source.html">MOM_ice_shelf.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="keywordtype">integer</span> :: id_clock_pass<span class="comment"> !&lt; CPU Clock for group pass calls</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__ice__shelf_8F90_source.html#l01074">initialize_ice_shelf()</a>, and <a class="el" href="MOM__ice__shelf_8F90_source.html#l00193">shelf_calc_flux()</a>.</p>

</div>
</div>
<a id="a5aff3e9a37cb5bc2b5b998bf296437ff"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5aff3e9a37cb5bc2b5b998bf296437ff">&#9670;&nbsp;</a></span>id_clock_shelf</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_ice_shelf::id_clock_shelf</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>CPU Clock for the ice shelf code. </p>

<p class="definition">Definition at line <a class="el" href="MOM__ice__shelf_8F90_source.html#l00184">184</a> of file <a class="el" href="MOM__ice__shelf_8F90_source.html">MOM_ice_shelf.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="keywordtype">integer</span> :: id_clock_shelf<span class="comment"> !&lt; CPU Clock for the ice shelf code</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__ice__shelf_8F90_source.html#l01074">initialize_ice_shelf()</a>, and <a class="el" href="MOM__ice__shelf_8F90_source.html#l00193">shelf_calc_flux()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__ice__shelf.html">mom_ice_shelf</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
