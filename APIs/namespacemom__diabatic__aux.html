<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_diabatic_aux Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('namespacemom__diabatic__aux.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a>  </div>
  <div class="headertitle">
<div class="title">mom_diabatic_aux Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Provides functions for some diabatic processes such as fraxil, brine rejection, tendency due to surface flux divergence. </p>
<p>This module contains the subroutines that, along with the subroutines that it calls, implements diapycnal mass and momentum fluxes and a bulk mixed layer. The diapycnal diffusion can be used without the bulk mixed layer.</p>
<p>diabatic first determines the (diffusive) diapycnal mass fluxes based on the convergence of the buoyancy fluxes within each layer. The dual-stream entrainment scheme of MacDougall and Dewar (JPO, 1997) is used for combined diapycnal advection and diffusion, calculated implicitly and potentially with the Richardson number dependent mixing, as described by Hallberg (MWR, 2000). Diapycnal advection is fundamentally the residual of diapycnal diffusion, so the fully implicit upwind differencing scheme that is used is entirely appropriate. The downward buoyancy flux in each layer is determined from an implicit calculation based on the previously calculated flux of the layer above and an estimated flux in the layer below. This flux is subject to the following conditions: (1) the flux in the top and bottom layers are set by the boundary conditions, and (2) no layer may be driven below an Angstrom thick- ness. If there is a bulk mixed layer, the buffer layer is treat- ed as a fixed density layer with vanishingly small diffusivity.</p>
<p>diabatic takes 5 arguments: the two velocities (u and v), the thicknesses (h), a structure containing the forcing fields, and the length of time over which to act (dt). The velocities and thickness are taken as inputs and modified within the subroutine. There is no limit on the time step. </p>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__diabatic__aux_1_1diabatic__aux__cs.html">diabatic_aux_cs</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Control structure for diabatic_aux.  <a href="structmom__diabatic__aux_1_1diabatic__aux__cs.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1fffddaa09c8650a74e045c2fe29e256"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__diabatic__aux.html#a1fffddaa09c8650a74e045c2fe29e256">id_clock_uv_at_h</a></td></tr>
<tr class="memdesc:a1fffddaa09c8650a74e045c2fe29e256"><td class="mdescLeft">&#160;</td><td class="mdescRight">CPU time clock IDs.  <a href="namespacemom__diabatic__aux.html#a1fffddaa09c8650a74e045c2fe29e256">More...</a><br /></td></tr>
<tr class="separator:a1fffddaa09c8650a74e045c2fe29e256"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a87671b375428f3a27c18c61d6a93d035"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__diabatic__aux.html#a87671b375428f3a27c18c61d6a93d035">id_clock_frazil</a></td></tr>
<tr class="memdesc:a87671b375428f3a27c18c61d6a93d035"><td class="mdescLeft">&#160;</td><td class="mdescRight">CPU time clock IDs.  <a href="namespacemom__diabatic__aux.html#a87671b375428f3a27c18c61d6a93d035">More...</a><br /></td></tr>
<tr class="separator:a87671b375428f3a27c18c61d6a93d035"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aee7529221802ad2ebd682e05c3b54acf"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__diabatic__aux.html#aee7529221802ad2ebd682e05c3b54acf">make_frazil</a> (h, tv, G, GV, CS, p_surf, halo)</td></tr>
<tr class="memdesc:aee7529221802ad2ebd682e05c3b54acf"><td class="mdescLeft">&#160;</td><td class="mdescRight">Frazil formation keeps the temperature above the freezing point. This subroutine warms any water that is colder than the (currently surface) freezing point up to the freezing point and accumulates the required heat (in J m-2) in tvfrazil.  <a href="namespacemom__diabatic__aux.html#aee7529221802ad2ebd682e05c3b54acf">More...</a><br /></td></tr>
<tr class="separator:aee7529221802ad2ebd682e05c3b54acf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa9248acf0b1cf246a79092077bcb0b46"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__diabatic__aux.html#aa9248acf0b1cf246a79092077bcb0b46">differential_diffuse_t_s</a> (h, tv, visc, dt, G, GV)</td></tr>
<tr class="memdesc:aa9248acf0b1cf246a79092077bcb0b46"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine applies double diffusion to T &amp; S, assuming no diapycal mass fluxes, using a simple triadiagonal solver.  <a href="namespacemom__diabatic__aux.html#aa9248acf0b1cf246a79092077bcb0b46">More...</a><br /></td></tr>
<tr class="separator:aa9248acf0b1cf246a79092077bcb0b46"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a737df97b7e0205b0680c3b901ff6e2ff"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__diabatic__aux.html#a737df97b7e0205b0680c3b901ff6e2ff">adjust_salt</a> (h, tv, G, GV, CS, halo)</td></tr>
<tr class="memdesc:a737df97b7e0205b0680c3b901ff6e2ff"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine keeps salinity from falling below a small but positive threshold. This usually occurs when the ice model attempts to extract more salt then is actually available to it from the ocean.  <a href="namespacemom__diabatic__aux.html#a737df97b7e0205b0680c3b901ff6e2ff">More...</a><br /></td></tr>
<tr class="separator:a737df97b7e0205b0680c3b901ff6e2ff"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a73cdec946a5ab30bee6fdd119aa970ad"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__diabatic__aux.html#a73cdec946a5ab30bee6fdd119aa970ad">insert_brine</a> (h, tv, G, GV, fluxes, nkmb, CS, dt, id_brine_lay)</td></tr>
<tr class="memdesc:a73cdec946a5ab30bee6fdd119aa970ad"><td class="mdescLeft">&#160;</td><td class="mdescRight">Insert salt from brine rejection into the first layer below the mixed layer which both contains mass and in which the change in layer density remains stable after the addition of salt via brine rejection.  <a href="namespacemom__diabatic__aux.html#a73cdec946a5ab30bee6fdd119aa970ad">More...</a><br /></td></tr>
<tr class="separator:a73cdec946a5ab30bee6fdd119aa970ad"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acde4c76c9a489b82cba0bac5ec1b1198"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__diabatic__aux.html#acde4c76c9a489b82cba0bac5ec1b1198">tridiagts</a> (G, GV, is, ie, js, je, hold, ea, eb, T, S)</td></tr>
<tr class="memdesc:acde4c76c9a489b82cba0bac5ec1b1198"><td class="mdescLeft">&#160;</td><td class="mdescRight">This is a simple tri-diagonal solver for T and S. "Simple" means it only uses arrays hold, ea and eb.  <a href="namespacemom__diabatic__aux.html#acde4c76c9a489b82cba0bac5ec1b1198">More...</a><br /></td></tr>
<tr class="separator:acde4c76c9a489b82cba0bac5ec1b1198"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac18edf904af75caadea28fc234a57a3c"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__diabatic__aux.html#ac18edf904af75caadea28fc234a57a3c">find_uv_at_h</a> (u, v, h, u_h, v_h, G, GV, ea, eb)</td></tr>
<tr class="memdesc:ac18edf904af75caadea28fc234a57a3c"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine calculates u_h and v_h (velocities at thickness points), optionally using the entrainment amounts passed in as arguments.  <a href="namespacemom__diabatic__aux.html#ac18edf904af75caadea28fc234a57a3c">More...</a><br /></td></tr>
<tr class="separator:ac18edf904af75caadea28fc234a57a3c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a43ac98433f0f2f0e6cf4f8a3c9622ec4"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__diabatic__aux.html#a43ac98433f0f2f0e6cf4f8a3c9622ec4">diagnosemldbydensitydifference</a> (id_MLD, h, tv, densityDiff, G, GV, US, diagPtr, id_N2subML, id_MLDsq, dz_subML)</td></tr>
<tr class="memdesc:a43ac98433f0f2f0e6cf4f8a3c9622ec4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Diagnose a mixed layer depth (MLD) determined by a given density difference with the surface. This routine is appropriate in MOM_diabatic_driver due to its position within the time stepping.  <a href="namespacemom__diabatic__aux.html#a43ac98433f0f2f0e6cf4f8a3c9622ec4">More...</a><br /></td></tr>
<tr class="separator:a43ac98433f0f2f0e6cf4f8a3c9622ec4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab32313b997a7728d99b52665b94e261f"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__diabatic__aux.html#ab32313b997a7728d99b52665b94e261f">applyboundaryfluxesinout</a> (CS, G, GV, US, dt, fluxes, optics, h, tv, aggregate_FW_forcing, evap_CFL_limit, minimum_forcing_depth, cTKE, dSV_dT, dSV_dS, SkinBuoyFlux)</td></tr>
<tr class="memdesc:ab32313b997a7728d99b52665b94e261f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Update the thickness, temperature, and salinity due to thermodynamic boundary forcing (contained in fluxes type) applied to h, tvT and tvS, and calculate the TKE implications of this heating.  <a href="namespacemom__diabatic__aux.html#ab32313b997a7728d99b52665b94e261f">More...</a><br /></td></tr>
<tr class="separator:ab32313b997a7728d99b52665b94e261f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a967697feb7ea22e1430d2b673ebab544"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__diabatic__aux.html#a967697feb7ea22e1430d2b673ebab544">diabatic_aux_init</a> (Time, G, GV, US, param_file, diag, CS, useALEalgorithm, use_ePBL)</td></tr>
<tr class="memdesc:a967697feb7ea22e1430d2b673ebab544"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine initializes the parameters and control structure of the diabatic_aux module.  <a href="namespacemom__diabatic__aux.html#a967697feb7ea22e1430d2b673ebab544">More...</a><br /></td></tr>
<tr class="separator:a967697feb7ea22e1430d2b673ebab544"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a071e066ca5ed6619c6a9515fb07f5567"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__diabatic__aux.html#a071e066ca5ed6619c6a9515fb07f5567">diabatic_aux_end</a> (CS)</td></tr>
<tr class="memdesc:a071e066ca5ed6619c6a9515fb07f5567"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine initializes the control structure and any related memory for the diabatic_aux module.  <a href="namespacemom__diabatic__aux.html#a071e066ca5ed6619c6a9515fb07f5567">More...</a><br /></td></tr>
<tr class="separator:a071e066ca5ed6619c6a9515fb07f5567"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a737df97b7e0205b0680c3b901ff6e2ff"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a737df97b7e0205b0680c3b901ff6e2ff">&#9670;&nbsp;</a></span>adjust_salt()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_diabatic_aux::adjust_salt </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__diabatic__aux_1_1diabatic__aux__cs.html">diabatic_aux_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in), optional&#160;</td>
          <td class="paramname"><em>halo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine keeps salinity from falling below a small but positive threshold. This usually occurs when the ice model attempts to extract more salt then is actually available to it from the ocean. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">tv</td><td>Structure containing pointers to any available thermodynamic fields. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>The control structure returned by a previous call to diabatic_aux_init. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">halo</td><td>Halo width over which to work </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00314">314</a> of file <a class="el" href="MOM__diabatic__aux_8F90_source.html">MOM_diabatic_aux.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: h<span class="comment">    !&lt; Layer thicknesses [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),   <span class="keywordtype">intent(inout)</span> :: tv<span class="comment">   !&lt; Structure containing pointers to any</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment">                                                 !! available thermodynamic fields.</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;  <span class="keywordtype">type</span>(diabatic_aux_CS),   <span class="keywordtype">intent(in)</span>    :: CS<span class="comment">   !&lt; The control structure returned by a previous</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="comment">                                                 !! call to diabatic_aux_init.</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;  <span class="keywordtype">integer</span>,       <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: halo<span class="comment"> !&lt; Halo width over which to work</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160; </div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;  <span class="comment">! local variables</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="keywordtype">  real</span> :: salt_add_col(SZI_(G),SZJ_(G))<span class="comment"> !&lt; The accumulated salt requirement [gSalt m-2]</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="keywordtype">  real</span> :: S_min<span class="comment">      !&lt; The minimum salinity [ppt].</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="keywordtype">  real</span> :: mc<span class="comment">         !&lt; A layer&#39;s mass [kg m-2].</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, nz</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160; </div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(halo)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    is = g%isc-halo ; ie = g%iec+halo ; js = g%jsc-halo ; je = g%jec+halo</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160; </div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="comment">!  call cpu_clock_begin(id_clock_adjust_salt)</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160; </div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  s_min = tv%min_salinity</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160; </div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;  salt_add_col(:,:) = 0.0</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160; </div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  <span class="comment">!$OMP parallel do default(none) private(mc)</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  <span class="keywordflow">do</span> j=js,je</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keywordflow">do</span> k=nz,1,-1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;      <span class="keywordflow">if</span> ( (g%mask2dT(i,j) &gt; 0.0) .and. &amp;</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;           ((tv%S(i,j,k) &lt; s_min) .or. (salt_add_col(i,j) &gt; 0.0)) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        mc = gv%H_to_kg_m2 * h(i,j,k)</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        <span class="keywordflow">if</span> (h(i,j,k) &lt;= 10.0*gv%Angstrom_H) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;          <span class="comment">! Very thin layers should not be adjusted by the salt flux</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;          <span class="keywordflow">if</span> (tv%S(i,j,k) &lt; s_min) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;            salt_add_col(i,j) = salt_add_col(i,j) +  mc * (s_min - tv%S(i,j,k))</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;            tv%S(i,j,k) = s_min</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        <span class="keywordflow">elseif</span> (salt_add_col(i,j) + mc * (s_min - tv%S(i,j,k)) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;          tv%S(i,j,k) = tv%S(i,j,k) - salt_add_col(i,j) / mc</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;          salt_add_col(i,j) = 0.0</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;          salt_add_col(i,j) = salt_add_col(i,j) + mc * (s_min - tv%S(i,j,k))</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;          tv%S(i,j,k) = s_min</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;      tv%salt_deficit(i,j) = tv%salt_deficit(i,j) + salt_add_col(i,j)</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="comment">!  call cpu_clock_end(id_clock_adjust_salt)</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160; </div>
</div><!-- fragment -->
</div>
</div>
<a id="ab32313b997a7728d99b52665b94e261f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab32313b997a7728d99b52665b94e261f">&#9670;&nbsp;</a></span>applyboundaryfluxesinout()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_diabatic_aux::applyboundaryfluxesinout </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__diabatic__aux_1_1diabatic__aux__cs.html">diabatic_aux_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(optics_type), pointer&#160;</td>
          <td class="paramname"><em>optics</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>aggregate_FW_forcing</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>evap_CFL_limit</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>minimum_forcing_depth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(out), optional&#160;</td>
          <td class="paramname"><em>cTKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(out), optional&#160;</td>
          <td class="paramname"><em>dSV_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(out), optional&#160;</td>
          <td class="paramname"><em>dSV_dS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g)), intent(out), optional&#160;</td>
          <td class="paramname"><em>SkinBuoyFlux</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Update the thickness, temperature, and salinity due to thermodynamic boundary forcing (contained in fluxes type) applied to h, tvT and tvS, and calculate the TKE implications of this heating. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Control structure for diabatic_aux </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>ocean vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time-step over which forcing is applied [s] </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>Surface fluxes container </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">optics</td><td>Optical properties container </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h</td><td>Layer thickness [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">tv</td><td>Structure containing pointers to any available thermodynamic fields. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">aggregate_fw_forcing</td><td>If False, treat in/out fluxes separately. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">evap_cfl_limit</td><td>The largest fraction of a layer that can be evaporated in one time-step [nondim]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">minimum_forcing_depth</td><td>The smallest depth over which heat and freshwater fluxes is applied [m]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">ctke</td><td>Turbulent kinetic energy requirement to mix </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dsv_dt</td><td>Partial derivative of specific volume with </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dsv_ds</td><td>Partial derivative of specific volume with </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">skinbuoyflux</td><td>Buoyancy flux at surface [Z2 s-3 ~&gt; m2 s-3]. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00776">776</a> of file <a class="el" href="MOM__diabatic__aux_8F90_source.html">MOM_diabatic_aux.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;  <span class="keywordtype">type</span>(diabatic_aux_CS),   <span class="keywordtype">pointer</span>       :: CS<span class="comment"> !&lt; Control structure for diabatic_aux</span></div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">  !&lt; Grid structure</span></div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment"> !&lt; ocean vertical grid structure</span></div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>    :: US<span class="comment"> !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: dt<span class="comment"> !&lt; Time-step over which forcing is applied [s]</span></div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;  <span class="keywordtype">type</span>(forcing),           <span class="keywordtype">intent(inout)</span> :: fluxes<span class="comment"> !&lt; Surface fluxes container</span></div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;  <span class="keywordtype">type</span>(optics_type),       <span class="keywordtype">pointer</span>       :: optics<span class="comment"> !&lt; Optical properties container</span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;                           <span class="keywordtype">intent(inout)</span> :: h<span class="comment">  !&lt; Layer thickness [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),   <span class="keywordtype">intent(inout)</span> :: tv<span class="comment"> !&lt; Structure containing pointers to any</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;<span class="comment">                                               !! available thermodynamic fields.</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;  <span class="keywordtype">logical</span>,                 <span class="keywordtype">intent(in)</span>    :: aggregate_FW_forcing<span class="comment"> !&lt; If False, treat in/out fluxes separately.</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: evap_CFL_limit<span class="comment"> !&lt; The largest fraction of a layer that</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;<span class="comment">                                               !! can be evaporated in one time-step [nondim].</span></div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: minimum_forcing_depth<span class="comment"> !&lt; The smallest depth over which</span></div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="comment">                                               !! heat and freshwater fluxes is applied [m].</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span>   :: cTKE<span class="comment"> !&lt; Turbulent kinetic energy requirement to mix</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;<span class="comment">                                               !! forcing through each layer [W m-2]</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span>   :: dSV_dT<span class="comment"> !&lt; Partial derivative of specific volume with</span></div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;<span class="comment">                                               !! potential temperature [m3 kg-1 degC-1].</span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span>   :: dSV_dS<span class="comment"> !&lt; Partial derivative of specific volume with</span></div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;<span class="comment">                                               !! salinity [m3 kg-1 ppt-1].</span></div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>, &amp;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;                   <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: SkinBuoyFlux<span class="comment"> !&lt; Buoyancy flux at surface [Z2 s-3 ~&gt; m2 s-3].</span></div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160; </div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: maxGroundings = 5</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;  <span class="keywordtype">integer</span> :: numberOfGroundings, iGround(maxGroundings), jGround(maxGroundings)</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;<span class="keywordtype">  real</span> :: H_limit_fluxes, IforcingDepthScale, Idt</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;<span class="keywordtype">  real</span> :: dThickness, dTemp, dSalt</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="keywordtype">  real</span> :: fractionOfForcing, hOld, Ithickness</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="keywordtype">  real</span> :: RivermixConst  <span class="comment">! A constant used in implementing river mixing [Pa s].</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    d_pres,       &amp;  <span class="comment">! pressure change across a layer [Pa]</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    p_lay,        &amp;  <span class="comment">! average pressure in a layer [Pa]</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    pres,         &amp;  <span class="comment">! pressure at an interface [Pa]</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    netMassInOut, &amp;  <span class="comment">! surface water fluxes [H ~&gt; m or kg m-2] over time step</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    netMassIn,    &amp;  <span class="comment">! mass entering ocean surface [H ~&gt; m or kg m-2] over a time step</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    netMassOut,   &amp;  <span class="comment">! mass leaving ocean surface [H ~&gt; m or kg m-2] over a time step</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    netHeat,      &amp;  <span class="comment">! heat via surface fluxes excluding Pen_SW_bnd and netMassOut</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;                     <span class="comment">! [degC H ~&gt; degC m or degC kg m-2]</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    netsalt,      &amp;  <span class="comment">! surface salt flux ( g(salt)/m2 for non-Bouss and ppt*H for Bouss )</span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;                     <span class="comment">! [ppt H ~&gt; ppt m or ppt kg m-2]</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    nonpensw,     &amp;  <span class="comment">! non-downwelling SW, which is absorbed at ocean surface</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;                     <span class="comment">! [degC H ~&gt; degC m or degC kg m-2]</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    surfpressure, &amp;  <span class="comment">! Surface pressure (approximated as 0.0) [Pa]</span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    drhodt,       &amp;  <span class="comment">! change in density per change in temperature [kg m-3 degC-1]</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    drhods,       &amp;  <span class="comment">! change in density per change in salinity [kg m-3 ppt-1]</span></div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    netheat_rate, &amp;  <span class="comment">! netheat but for dt=1 [degC H s-1 ~&gt; degC m s-1 or degC kg m-2 s-1]</span></div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    netsalt_rate, &amp;  <span class="comment">! netsalt but for dt=1 (e.g. returns a rate)</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;                     <span class="comment">! [ppt H s-1 ~&gt; ppt m s-1 or ppt kg m-2 s-1]</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    netmassinout_rate<span class="comment">! netmassinout but for dt=1 [H s-1 ~&gt; m s-1 or kg m-2 s-1]</span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G), SZK_(G))</span>                     :: h2d, T2d</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G), SZK_(G))</span>                     :: pen_TKE_2d, dSV_dT_2d</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span>                    :: netPen</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(max(optics%nbands,1),SZI_(G))</span>         :: Pen_SW_bnd, Pen_SW_bnd_rate</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;                                                           <span class="comment">!^ _rate is w/ dt=1</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(max(optics%nbands,1),SZI_(G),SZK_(G))</span> :: opacityBand</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;<span class="keywordtype">  real</span>                                                  :: hGrounding(maxGroundings)</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;<span class="keywordtype">  real</span>    :: Temp_in, Salin_in</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;<span class="comment">!  real    :: I_G_Earth</span></div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="keywordtype">  real</span>    :: g_Hconv2</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;<span class="keywordtype">  real</span>    :: GoRho    <span class="comment">! g_Earth times a unit conversion factor divided by density</span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;                      <span class="comment">! [Z m3 s-2 kg-1 ~&gt; m4 s-2 kg-1]</span></div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;  <span class="keywordtype">logical</span> :: calculate_energetics</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;  <span class="keywordtype">logical</span> :: calculate_buoyancy</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je, k, nz, n, nsw</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;  <span class="keywordtype">integer</span> :: start, npts</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;  <span class="keywordtype">character(len=45)</span> :: mesg</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160; </div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160; </div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;  <span class="comment">! Only apply forcing if fluxes%sw is associated.</span></div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(fluxes%sw)) <span class="keywordflow">return</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160; </div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;<span class="preprocessor">#define _OLD_ALG_</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="preprocessor"></span>  nsw = optics%nbands</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;  idt = 1.0/dt</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160; </div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;  calculate_energetics = (<span class="keyword">present</span>(ctke) .and. <span class="keyword">present</span>(dsv_dt) .and. <span class="keyword">present</span>(dsv_ds))</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;  calculate_buoyancy = <span class="keyword">present</span>(skinbuoyflux)</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;  <span class="keywordflow">if</span> (calculate_buoyancy) skinbuoyflux(:,:) = 0.0</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;<span class="comment">!  I_G_Earth = 1.0 / GV%g_Earth</span></div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;  g_hconv2 = gv%H_to_Pa * gv%H_to_kg_m2</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160; </div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(ctke)) ctke(:,:,:) = 0.0</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;  <span class="keywordflow">if</span> (calculate_buoyancy) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    surfpressure(:) = 0.0</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    gorho       = gv%g_Earth / gv%Rho0</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    start       = 1 + g%isc - g%isd</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    npts        = 1 + g%iec - g%isc</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160; </div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;  <span class="comment">! H_limit_fluxes is used by extractFluxes1d to scale down fluxes if the total</span></div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;  <span class="comment">! depth of the ocean is vanishing. It does not (yet) handle a value of zero.</span></div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;  <span class="comment">! To accommodate vanishing upper layers, we need to allow for an instantaneous</span></div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;  <span class="comment">! distribution of forcing over some finite vertical extent. The bulk mixed layer</span></div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;  <span class="comment">! code handles this issue properly.</span></div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;  h_limit_fluxes = max(gv%Angstrom_H, 1.e-30*gv%m_to_H)</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160; </div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;  <span class="comment">! diagnostic to see if need to create mass to avoid grounding</span></div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;  <span class="keywordflow">if</span> (cs%id_createdH&gt;0) cs%createdH(:,:) = 0.</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;  numberofgroundings = 0</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160; </div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;  <span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,nz,h,tv,nsw,G,GV,US,optics,fluxes,dt, &amp;</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;  <span class="comment">!$OMP                                  H_limit_fluxes,numberOfGroundings,iGround,jGround,&amp;</span></div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;  <span class="comment">!$OMP                                  nonPenSW,hGrounding,CS,Idt,aggregate_FW_forcing,  &amp;</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;  <span class="comment">!$OMP                                  minimum_forcing_depth,evap_CFL_limit,             &amp;</span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;  <span class="comment">!$OMP                                  calculate_buoyancy,netPen,SkinBuoyFlux,GoRho,     &amp;</span></div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;  <span class="comment">!$OMP                                  calculate_energetics,dSV_dT,dSV_dS,cTKE,g_Hconv2) &amp;</span></div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;  <span class="comment">!$OMP                          private(opacityBand,h2d,T2d,netMassInOut,netMassOut,      &amp;</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;  <span class="comment">!$OMP                                  netHeat,netSalt,Pen_SW_bnd,fractionOfForcing,     &amp;</span></div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;  <span class="comment">!$OMP                                  IforcingDepthScale,                               &amp;</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;  <span class="comment">!$OMP                                  dThickness,dTemp,dSalt,hOld,Ithickness,           &amp;</span></div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;  <span class="comment">!$OMP                                  netMassIn,pres,d_pres,p_lay,dSV_dT_2d,            &amp;</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;  <span class="comment">!$OMP                                  netmassinout_rate,netheat_rate,netsalt_rate,      &amp;</span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;  <span class="comment">!$OMP                                  drhodt,drhods,pen_sw_bnd_rate,SurfPressure,       &amp;</span></div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;  <span class="comment">!$OMP                                  pen_TKE_2d,Temp_in,Salin_in,RivermixConst)        &amp;</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;  <span class="comment">!$OMP                     firstprivate(start,npts)</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;  <span class="keywordflow">do</span> j=js,je</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;  <span class="comment">! Work in vertical slices for efficiency</span></div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160; </div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;    <span class="comment">! Copy state into 2D-slice arrays</span></div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;      h2d(i,k) = h(i,j,k)</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;      t2d(i,k) = tv%T(i,j,k)</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;      <span class="keywordflow">do</span> n=1,nsw</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;        opacityband(n,i,k) = (1.0 / gv%m_to_H)*optics%opacity_band(n,i,j,k)</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160; </div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    <span class="keywordflow">if</span> (calculate_energetics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;      <span class="comment">! The partial derivatives of specific volume with temperature and</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;      <span class="comment">! salinity need to be precalculated to avoid having heating of</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;      <span class="comment">! tiny layers give nonsensical values.</span></div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; pres(i) = 0.0 ;<span class="keywordflow"> enddo</span> <span class="comment">! Add surface pressure?</span></div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;      <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;        <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;          d_pres(i) = gv%H_to_Pa * h2d(i,k)</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;          p_lay(i) = pres(i) + 0.5*d_pres(i)</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;          pres(i) = pres(i) + d_pres(i)</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;        <span class="keyword">call </span>calculate_specific_vol_derivs(t2d(:,k), tv%S(:,j,k), p_lay(:),&amp;</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;                 dsv_dt(:,j,k), dsv_ds(:,j,k), is, ie-is+1, tv%eqn_of_state)</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;        <span class="keywordflow">do</span> i=is,ie ; dsv_dt_2d(i,k) = dsv_dt(i,j,k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;<span class="comment">!        do i=is,ie</span></div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;<span class="comment">!          dT_to_dPE(i,k) = I_G_Earth * US%Z_to_m * d_pres(i) * p_lay(i) * dSV_dT(i,j,k)</span></div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;<span class="comment">!          dS_to_dPE(i,k) = I_G_Earth * US%Z_to_m * d_pres(i) * p_lay(i) * dSV_dS(i,j,k)</span></div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="comment">!        enddo</span></div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;      pen_tke_2d(:,:) = 0.0</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160; </div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    <span class="comment">! The surface forcing is contained in the fluxes type.</span></div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    <span class="comment">! We aggregate the thermodynamic forcing for a time step into the following:</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <span class="comment">! netMassInOut = surface water fluxes [H ~&gt; m or kg m-2] over time step</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    <span class="comment">!              = lprec + fprec + vprec + evap + lrunoff + frunoff</span></div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    <span class="comment">!                note that lprec generally has sea ice melt/form included.</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    <span class="comment">! netMassOut   = net mass leaving ocean surface [H ~&gt; m or kg m-2] over a time step.</span></div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;    <span class="comment">!                netMassOut &lt; 0 means mass leaves ocean.</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    <span class="comment">! netHeat      = heat via surface fluxes [degC H ~&gt; degC m or degC kg m-2], excluding the part</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    <span class="comment">!                contained in Pen_SW_bnd; and excluding heat_content of netMassOut &lt; 0.</span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    <span class="comment">! netSalt      = surface salt fluxes [ppt H ~&gt; dppt m or gSalt m-2]</span></div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    <span class="comment">! Pen_SW_bnd   = components to penetrative shortwave radiation split according to bands.</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    <span class="comment">!                This field provides that portion of SW from atmosphere that in fact</span></div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;    <span class="comment">!                enters to the ocean and participates in pentrative SW heating.</span></div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;    <span class="comment">! nonpenSW     = non-downwelling SW flux, which is absorbed in ocean surface</span></div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;    <span class="comment">!                (in tandem w/ LW,SENS,LAT); saved only for diagnostic purposes.</span></div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160; </div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;    <span class="comment">!----------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    <span class="comment">!BGR-June 26, 2017{</span></div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;    <span class="comment">!Temporary action to preserve answers while fixing a bug.</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    <span class="comment">! To fix a bug in a diagnostic calculation, applyboundaryfluxesinout now returns</span></div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    <span class="comment">!  the surface buoyancy flux. Previously, extractbuoyancyflux2d was called, meaning</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;    <span class="comment">!  a second call to extractfluxes1d (causing the diagnostic net_heat to be incorrect).</span></div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;    <span class="comment">!  Note that this call to extract buoyancyflux2d was AFTER applyboundaryfluxesinout,</span></div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;    <span class="comment">!  which means it used the T/S fields after this routine.  Therefore, the surface</span></div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    <span class="comment">!  buoyancy flux is computed here at the very end of this routine for legacy reasons.</span></div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;    <span class="comment">!  A few specific notes follow:</span></div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    <span class="comment">!     1) The old method did not included river/calving contributions to heat flux.  This</span></div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;    <span class="comment">!        is kept consistent here via commenting code in the present extractFluxes1d &lt;_rate&gt;</span></div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;    <span class="comment">!        outputs, but we may reconsider this approach.</span></div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    <span class="comment">!     2) The old method computed the buoyancy flux rate directly (by setting dt=1), instead</span></div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    <span class="comment">!        of computing the integrated value (and dividing by dt). Hence the required</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;    <span class="comment">!        additional outputs from extractFluxes1d.</span></div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    <span class="comment">!          *** This is because: A*dt/dt =/=  A due to round off.</span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    <span class="comment">!     3) The old method computed buoyancy flux after this routine, meaning the returned</span></div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    <span class="comment">!        surface fluxes (from extractfluxes1d) must be recorded for use later in the code.</span></div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;    <span class="comment">!        We could (and maybe should) move that loop up to before the surface fluxes are</span></div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;    <span class="comment">!        applied, but this will change answers.</span></div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;    <span class="comment">!     For all these reasons we compute additional values of &lt;_rate&gt; which are preserved</span></div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;    <span class="comment">!     for the buoyancy flux calculation and reproduce the old answers.</span></div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;    <span class="comment">!   In the future this needs more detailed investigation to make sure everything is</span></div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;    <span class="comment">!   consistent and correct. These details shouldnt significantly effect climate,</span></div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    <span class="comment">!   but do change answers.</span></div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;    <span class="comment">!-----------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;    <span class="keywordflow">if</span> (calculate_buoyancy) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;      <span class="keyword">call </span>extractfluxes1d(g, gv, fluxes, optics, nsw, j, dt,                        &amp;</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;                  h_limit_fluxes, cs%use_river_heat_content, cs%use_calving_heat_content, &amp;</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;                  h2d, t2d, netmassinout, netmassout, netheat, netsalt,                   &amp;</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;                  pen_sw_bnd, tv, aggregate_fw_forcing, nonpensw=nonpensw,                &amp;</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;                  net_heat_rate=netheat_rate,net_salt_rate=netsalt_rate,                  &amp;</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;                  netmassinout_rate=netmassinout_rate,pen_sw_bnd_rate=pen_sw_bnd_rate)</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;      <span class="keyword">call </span>extractfluxes1d(g, gv, fluxes, optics, nsw, j, dt,                        &amp;</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;                  h_limit_fluxes, cs%use_river_heat_content, cs%use_calving_heat_content, &amp;</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;                  h2d, t2d, netmassinout, netmassout, netheat, netsalt,                   &amp;</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;                  pen_sw_bnd, tv, aggregate_fw_forcing, nonpensw=nonpensw)</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;<span class="keywordflow">   endif</span></div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;    <span class="comment">! ea is for passive tracers</span></div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;    <span class="comment">!  ea(i,j,1) = netMassInOut(i)</span></div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;      <span class="keywordflow">if</span> (aggregate_fw_forcing) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;        netmassout(i) = netmassinout(i)</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;        netmassin(i) = 0.</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;        netmassin(i) = netmassinout(i) - netmassout(i)</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;      <span class="keywordflow">if</span> (g%mask2dT(i,j)&gt;0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;        fluxes%netMassOut(i,j) = netmassout(i)</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        fluxes%netMassIn(i,j) = netmassin(i)</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;        fluxes%netMassOut(i,j) = 0.0</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;        fluxes%netMassIn(i,j) = 0.0</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160; </div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    <span class="comment">! Apply the surface boundary fluxes in three steps:</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;    <span class="comment">! A/ update mass, temp, and salinity due to all terms except mass leaving</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;    <span class="comment">!    ocean (and corresponding outward heat content), and ignoring penetrative SW.</span></div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;    <span class="comment">! B/ update mass, salt, temp from mass leaving ocean.</span></div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;    <span class="comment">! C/ update temp due to penetrative SW</span></div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;      <span class="keywordflow">if</span> (g%mask2dT(i,j)&gt;0.) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160; </div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;        <span class="comment">! A/ Update mass, temp, and salinity due to incoming mass flux.</span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;        <span class="keywordflow">do</span> k=1,1</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160; </div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;          <span class="comment">! Change in state due to forcing</span></div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;          dthickness = netmassin(i) <span class="comment">! Since we are adding mass, we can use all of it</span></div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;          dtemp = 0.</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;          dsalt = 0.</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160; </div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;          <span class="comment">! Update the forcing by the part to be consumed within the present k-layer.</span></div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;          <span class="comment">! If fractionOfForcing = 1, then updated netMassIn, netHeat, and netSalt vanish.</span></div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;          netmassin(i) = netmassin(i) - dthickness</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;          <span class="comment">! This line accounts for the temperature of the mass exchange</span></div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;          temp_in = t2d(i,k)</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;          salin_in = 0.0</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;          dtemp = dtemp + dthickness*temp_in</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160; </div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;          <span class="comment">! Diagnostics of heat content associated with mass fluxes</span></div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%heat_content_massin))                             &amp;</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;            fluxes%heat_content_massin(i,j) = fluxes%heat_content_massin(i,j) +   &amp;</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;                         t2d(i,k) * max(0.,dthickness) * gv%H_to_kg_m2 * fluxes%C_p * idt</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%heat_content_massout))                            &amp;</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;            fluxes%heat_content_massout(i,j) = fluxes%heat_content_massout(i,j) + &amp;</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;                         t2d(i,k) * min(0.,dthickness) * gv%H_to_kg_m2 * fluxes%C_p * idt</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tv%TempxPmE)) tv%TempxPmE(i,j) = tv%TempxPmE(i,j) + &amp;</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;                         t2d(i,k) * dthickness * gv%H_to_kg_m2</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160; </div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;          <span class="comment">! Determine the energetics of river mixing before updating the state.</span></div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;          <span class="keywordflow">if</span> (calculate_energetics .and. <span class="keyword">associated</span>(fluxes%lrunoff) .and. cs%do_rivermix) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;            <span class="comment">! Here we add an additional source of TKE to the mixed layer where river</span></div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;            <span class="comment">! is present to simulate unresolved estuaries. The TKE input is diagnosed</span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;            <span class="comment">! as follows:</span></div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;            <span class="comment">!   TKE_river[m3 s-3] = 0.5*rivermix_depth*g*(1/rho)*drho_ds*</span></div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;            <span class="comment">!                       River*(Samb - Sriver) = CS%mstar*U_star^3</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;            <span class="comment">! where River is in units of [m s-1].</span></div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;            <span class="comment">! Samb = Ambient salinity at the mouth of the estuary</span></div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;            <span class="comment">! rivermix_depth =  The prescribed depth over which to mix river inflow</span></div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;            <span class="comment">! drho_ds = The gradient of density wrt salt at the ambient surface salinity.</span></div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;            <span class="comment">! Sriver = 0 (i.e. rivers are assumed to be pure freshwater)</span></div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;            rivermixconst = -0.5*(cs%rivermix_depth*dt)*gv%Z_to_H*gv%H_to_Pa</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160; </div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;            ctke(i,j,k) = ctke(i,j,k) + max(0.0, rivermixconst*dsv_ds(i,j,1) * &amp;</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;                  (fluxes%lrunoff(i,j) + fluxes%frunoff(i,j)) * tv%S(i,j,1))</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160; </div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;          <span class="comment">! Update state</span></div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;          hold     = h2d(i,k)               <span class="comment">! Keep original thickness in hand</span></div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;          h2d(i,k) = h2d(i,k) + dthickness  <span class="comment">! New thickness</span></div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;          <span class="keywordflow">if</span> (h2d(i,k) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;            <span class="keywordflow">if</span> (calculate_energetics .and. (dthickness &gt; 0.)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;              <span class="comment">! Calculate the energy required to mix the newly added water over</span></div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;              <span class="comment">! the topmost grid cell.  ###CHECK THE SIGNS!!!</span></div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;              ctke(i,j,k) = ctke(i,j,k) + 0.5*g_hconv2*(hold*dthickness) * &amp;</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;                 ((t2d(i,k) - temp_in) * dsv_dt(i,j,k) + (tv%S(i,j,k) - salin_in) * dsv_ds(i,j,k))</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;            ithickness  = 1.0/h2d(i,k)      <span class="comment">! Inverse new thickness</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;            <span class="comment">! The &quot;if&quot;s below avoid changing T/S by roundoff unnecessarily</span></div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;            <span class="keywordflow">if</span> (dthickness /= 0. .or. dtemp /= 0.) t2d(i,k)    = (hold*t2d(i,k)    + dtemp)*ithickness</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;            <span class="keywordflow">if</span> (dthickness /= 0. .or. dsalt /= 0.) tv%S(i,j,k) = (hold*tv%S(i,j,k) + dsalt)*ithickness</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160; </div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160; </div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;<span class="keywordflow">        enddo</span> <span class="comment">! k=1,1</span></div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160; </div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;        <span class="comment">! B/ Update mass, salt, temp from mass leaving ocean and other fluxes of heat and salt.</span></div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160; </div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;          <span class="comment">! Place forcing into this layer if this layer has nontrivial thickness.</span></div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;          <span class="comment">! For layers thin relative to 1/IforcingDepthScale, then distribute</span></div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;          <span class="comment">! forcing into deeper layers.</span></div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;          iforcingdepthscale = 1. / max(gv%H_subroundoff, minimum_forcing_depth*gv%m_to_H - netmassout(i) )</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;          <span class="comment">! fractionOfForcing = 1.0, unless h2d is less than IforcingDepthScale.</span></div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;          fractionofforcing = min(1.0, h2d(i,k)*iforcingdepthscale)</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160; </div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;          <span class="comment">! In the case with (-1)*netMassOut*fractionOfForcing greater than cfl*h, we</span></div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;          <span class="comment">! limit the forcing applied to this cell, leaving the remaining forcing to</span></div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;          <span class="comment">! be distributed downwards.</span></div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;          <span class="keywordflow">if</span> (-fractionofforcing*netmassout(i) &gt; evap_cfl_limit*h2d(i,k)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;            fractionofforcing = -evap_cfl_limit*h2d(i,k)/netmassout(i)</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160; </div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;          <span class="comment">! Change in state due to forcing</span></div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160; </div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;          dthickness = max( fractionofforcing*netmassout(i), -h2d(i,k) )</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;          dtemp      = fractionofforcing*netheat(i)</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;          <span class="comment">!   ### The 0.9999 here should become a run-time parameter?</span></div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;          dsalt = max( fractionofforcing*netsalt(i), -0.9999*h2d(i,k)*tv%S(i,j,k))</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160; </div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;          <span class="comment">! Update the forcing by the part to be consumed within the present k-layer.</span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;          <span class="comment">! If fractionOfForcing = 1, then new netMassOut vanishes.</span></div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;          netmassout(i) = netmassout(i) - dthickness</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;          netheat(i) = netheat(i) - dtemp</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;          netsalt(i) = netsalt(i) - dsalt</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160; </div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;          <span class="comment">! This line accounts for the temperature of the mass exchange</span></div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;          dtemp = dtemp + dthickness*t2d(i,k)</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160; </div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;          <span class="comment">! Diagnostics of heat content associated with mass fluxes</span></div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%heat_content_massin))                             &amp;</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;            fluxes%heat_content_massin(i,j) = fluxes%heat_content_massin(i,j) +   &amp;</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;                         t2d(i,k) * max(0.,dthickness) * gv%H_to_kg_m2 * fluxes%C_p * idt</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%heat_content_massout))                            &amp;</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;            fluxes%heat_content_massout(i,j) = fluxes%heat_content_massout(i,j) + &amp;</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;                         t2d(i,k) * min(0.,dthickness) * gv%H_to_kg_m2 * fluxes%C_p * idt</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tv%TempxPmE)) tv%TempxPmE(i,j) = tv%TempxPmE(i,j) + &amp;</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;                         t2d(i,k) * dthickness * gv%H_to_kg_m2</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160; </div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;          <span class="comment">! Update state by the appropriate increment.</span></div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;          hold     = h2d(i,k)               <span class="comment">! Keep original thickness in hand</span></div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;          h2d(i,k) = h2d(i,k) + dthickness  <span class="comment">! New thickness</span></div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160; </div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;          <span class="keywordflow">if</span> (h2d(i,k) &gt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;            <span class="keywordflow">if</span> (calculate_energetics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;              <span class="comment">! Calculate the energy required to mix the newly added water over</span></div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;              <span class="comment">! the topmost grid cell, assuming that the fluxes of heat and salt</span></div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;              <span class="comment">! and rejected brine are initially applied in vanishingly thin</span></div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;              <span class="comment">! layers at the top of the layer before being mixed throughout</span></div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;              <span class="comment">! the layer.  Note that dThickness is always &lt;= 0. ###CHECK THE SIGNS!!!</span></div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;              ctke(i,j,k) = ctke(i,j,k) - (0.5*h2d(i,k)*g_hconv2) * &amp;</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;                 ((dtemp - dthickness*t2d(i,k)) * dsv_dt(i,j,k) + &amp;</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;                  (dsalt - dthickness*tv%S(i,j,k)) * dsv_ds(i,j,k))</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;            ithickness  = 1.0/h2d(i,k) <span class="comment">! Inverse of new thickness</span></div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;            t2d(i,k)    = (hold*t2d(i,k) + dtemp)*ithickness</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;            tv%S(i,j,k) = (hold*tv%S(i,j,k) + dsalt)*ithickness</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;          <span class="keywordflow">elseif</span> (h2d(i,k) &lt; 0.0) <span class="keywordflow">then</span> <span class="comment">! h2d==0 is a special limit that needs no extra handling</span></div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;            <span class="keyword">call </span>forcing_singlepointprint(fluxes,g,i,j,<span class="stringliteral">&#39;applyBoundaryFluxesInOut (h&lt;0)&#39;</span>)</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;            <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;applyBoundaryFluxesInOut(): lon,lat=&#39;</span>,g%geoLonT(i,j),g%geoLatT(i,j)</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;            <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;applyBoundaryFluxesInOut(): netT,netS,netH=&#39;</span>,netheat(i),netsalt(i),netmassinout(i)</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;            <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;applyBoundaryFluxesInOut(): dT,dS,dH=&#39;</span>,dtemp,dsalt,dthickness</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;            <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;applyBoundaryFluxesInOut(): h(n),h(n+1),k=&#39;</span>,hold,h2d(i,k),k</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;            <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_diabatic_driver.F90, applyBoundaryFluxesInOut(): &quot;</span>//&amp;</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;                           <span class="stringliteral">&quot;Complete mass loss in column!&quot;</span>)</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160; </div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;<span class="keywordflow">        enddo</span> <span class="comment">! k</span></div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160; </div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;      <span class="comment">! Check if trying to apply fluxes over land points</span></div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;      <span class="keywordflow">elseif</span> ((abs(netheat(i))+abs(netsalt(i))+abs(netmassin(i))+abs(netmassout(i)))&gt;0.) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160; </div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;        <span class="keywordflow">if</span> (.not. cs%ignore_fluxes_over_land) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;           <span class="keyword">call </span>forcing_singlepointprint(fluxes,g,i,j,<span class="stringliteral">&#39;applyBoundaryFluxesInOut (land)&#39;</span>)</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;           <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;applyBoundaryFluxesInOut(): lon,lat=&#39;</span>,g%geoLonT(i,j),g%geoLatT(i,j)</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;           <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;applyBoundaryFluxesInOut(): netHeat,netSalt,netMassIn,netMassOut=&#39;</span>,&amp;</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;                   netheat(i),netsalt(i),netmassin(i),netmassout(i)</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160; </div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;           <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_diabatic_driver.F90, applyBoundaryFluxesInOut(): &quot;</span>//&amp;</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;                                 <span class="stringliteral">&quot;Mass loss over land?&quot;</span>)</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160; </div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160; </div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;      <span class="comment">! If anything remains after the k-loop, then we have grounded out, which is a problem.</span></div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;      <span class="keywordflow">if</span> (netmassin(i)+netmassout(i) /= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;<span class="comment">!$OMP critical</span></div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;        numberofgroundings = numberofgroundings +1</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;        <span class="keywordflow">if</span> (numberofgroundings&lt;=maxgroundings) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;          iground(numberofgroundings) = i <span class="comment">! Record i,j location of event for</span></div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;          jground(numberofgroundings) = j <span class="comment">! warning message</span></div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;          hgrounding(numberofgroundings) = netmassin(i)+netmassout(i)</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;<span class="comment">!$OMP end critical</span></div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;        <span class="keywordflow">if</span> (cs%id_createdH&gt;0) cs%createdH(i,j) = cs%createdH(i,j) - (netmassin(i)+netmassout(i))/dt</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160; </div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! i</span></div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160; </div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;    <span class="comment">! Step C/ in the application of fluxes</span></div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;    <span class="comment">! Heat by the convergence of penetrating SW.</span></div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;    <span class="comment">! SW penetrative heating uses the updated thickness from above.</span></div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160; </div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;    <span class="comment">! Save temperature before increment with SW heating</span></div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;    <span class="comment">! and initialize CS%penSWflux_diag to zero.</span></div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;    <span class="keywordflow">if</span> (cs%id_penSW_diag &gt; 0 .or. cs%id_penSWflux_diag &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        cs%penSW_diag(i,j,k)     = t2d(i,k)</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;        cs%penSWflux_diag(i,j,k) = 0.0</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;      k=nz+1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;         cs%penSWflux_diag(i,j,k) = 0.0</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160; </div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    <span class="keywordflow">if</span> (calculate_energetics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;      <span class="keyword">call </span>absorbremainingsw(g, gv, h2d, opacityband, nsw, j, dt, h_limit_fluxes, &amp;</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;                             .false., .true., t2d, pen_sw_bnd, tke=pen_tke_2d, dsv_dt=dsv_dt_2d)</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;      k = 1 <span class="comment">! For setting break-points.</span></div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;        ctke(i,j,k) = ctke(i,j,k) + pen_tke_2d(i,k)</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;      <span class="keyword">call </span>absorbremainingsw(g, gv, h2d, opacityband, nsw, j, dt, h_limit_fluxes, &amp;</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;                             .false., .true., t2d, pen_sw_bnd)</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160; </div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160; </div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;    <span class="comment">! Step D/ copy updated thickness and temperature</span></div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;    <span class="comment">! 2d slice now back into model state.</span></div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;      h(i,j,k)    = h2d(i,k)</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;      tv%T(i,j,k) = t2d(i,k)</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160; </div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;    <span class="comment">! Diagnose heating [W m-2] applied to a grid cell from SW penetration</span></div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;    <span class="comment">! Also diagnose the penetrative SW heat flux at base of layer.</span></div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;    <span class="keywordflow">if</span> (cs%id_penSW_diag &gt; 0 .or. cs%id_penSWflux_diag &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160; </div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;      <span class="comment">! convergence of SW into a layer</span></div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        cs%penSW_diag(i,j,k) = (t2d(i,k)-cs%penSW_diag(i,j,k))*h(i,j,k) * idt * tv%C_p * gv%H_to_kg_m2</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160; </div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;      <span class="comment">! Perform a cumulative sum upwards from bottom to</span></div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;      <span class="comment">! diagnose penetrative SW flux at base of tracer cell.</span></div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;      <span class="comment">! CS%penSWflux_diag(i,j,k=1)    is penetrative shortwave at top of ocean.</span></div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;      <span class="comment">! CS%penSWflux_diag(i,j,k=kbot+1) is zero, since assume no SW penetrates rock.</span></div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;      <span class="comment">! CS%penSWflux_diag = rsdo  and CS%penSW_diag = rsdoabsorb</span></div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;      <span class="comment">! rsdoabsorb(k) = rsdo(k) - rsdo(k+1), so that rsdo(k) = rsdo(k+1) + rsdoabsorb(k)</span></div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;      <span class="keywordflow">if</span> (cs%id_penSWflux_diag &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;        <span class="keywordflow">do</span> k=nz,1,-1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;          cs%penSWflux_diag(i,j,k) = cs%penSW_diag(i,j,k) + cs%penSWflux_diag(i,j,k+1)</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160; </div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160; </div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    <span class="comment">! Fill CS%nonpenSW_diag</span></div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;    <span class="keywordflow">if</span> (cs%id_nonpenSW_diag &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;        cs%nonpenSW_diag(i,j) = nonpensw(i)</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160; </div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    <span class="comment">! BGR: Get buoyancy flux to return for ePBL</span></div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    <span class="comment">!  We want the rate, so we use the rate values returned from extractfluxes1d.</span></div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;    <span class="comment">!  Note that the *dt values could be divided by dt here, but</span></div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    <span class="comment">!  1) Answers will change due to round-off</span></div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;    <span class="comment">!  2) Be sure to save their values BEFORE fluxes are used.</span></div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;    <span class="keywordflow">if</span> (calculate_buoyancy) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;      drhodt(:) = 0.0</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;      drhods(:) = 0.0</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;      netpen(:,:) = 0.0</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;      <span class="comment">! Sum over bands and attenuate as a function of depth</span></div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;      <span class="comment">! netPen is the netSW as a function of depth</span></div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;      <span class="keyword">call </span>sumswoverbands(g, gv, h2d(:,:), optics%opacity_band(:,:,j,:), nsw, j, dt, &amp;</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;           h_limit_fluxes, .true., pen_sw_bnd_rate, netpen)</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;      <span class="comment">! Density derivatives</span></div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;      <span class="keyword">call </span>calculate_density_derivs(t2d(:,1), tv%S(:,j,1), surfpressure, &amp;</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;           drhodt, drhods, start, npts, tv%eqn_of_state)</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;      <span class="comment">! 1. Adjust netSalt to reflect dilution effect of FW flux</span></div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;      <span class="comment">! 2. Add in the SW heating for purposes of calculating the net</span></div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;      <span class="comment">! surface buoyancy flux affecting the top layer.</span></div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;      <span class="comment">! 3. Convert to a buoyancy flux, excluding penetrating SW heating</span></div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;      <span class="comment">!    BGR-Jul 5, 2017: The contribution of SW heating here needs investigated for ePBL.</span></div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;        skinbuoyflux(i,j) = - gorho * gv%H_to_Z * us%m_to_Z**2 * ( &amp;</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;            drhods(i) * (netsalt_rate(i) - tv%S(i,j,1)*netmassinout_rate(i)) + &amp;</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;            drhodt(i) * ( netheat_rate(i) + netpen(i,1)) ) <span class="comment">! m^2/s^3</span></div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160; </div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! j-loop finish</span></div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160; </div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;  <span class="comment">! Post the diagnostics</span></div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;  <span class="keywordflow">if</span> (cs%id_createdH       &gt; 0) <span class="keyword">call </span>post_data(cs%id_createdH      , cs%createdH      , cs%diag)</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;  <span class="keywordflow">if</span> (cs%id_penSW_diag     &gt; 0) <span class="keyword">call </span>post_data(cs%id_penSW_diag    , cs%penSW_diag    , cs%diag)</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;  <span class="keywordflow">if</span> (cs%id_penSWflux_diag &gt; 0) <span class="keyword">call </span>post_data(cs%id_penSWflux_diag, cs%penSWflux_diag, cs%diag)</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;  <span class="keywordflow">if</span> (cs%id_nonpenSW_diag  &gt; 0) <span class="keyword">call </span>post_data(cs%id_nonpenSW_diag , cs%nonpenSW_diag , cs%diag)</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160; </div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;<span class="comment">! The following check will be ignored if ignore_fluxes_over_land = true</span></div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;  <span class="keywordflow">if</span> (numberofgroundings&gt;0 .and. .not. cs%ignore_fluxes_over_land) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    <span class="keywordflow">do</span> i = 1, min(numberofgroundings, maxgroundings)</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;      <span class="keyword">call </span>forcing_singlepointprint(fluxes,g,iground(i),jground(i),<span class="stringliteral">&#39;applyBoundaryFluxesInOut (grounding)&#39;</span>)</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;      <span class="keyword">write</span>(mesg(1:45),<span class="stringliteral">&#39;(3es15.3)&#39;</span>) g%geoLonT( iground(i), jground(i) ), &amp;</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;                             g%geoLatT( iground(i), jground(i)) , hgrounding(i)</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;      <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;MOM_diabatic_driver.F90, applyBoundaryFluxesInOut(): &quot;</span>//&amp;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;                              <span class="stringliteral">&quot;Mass created. x,y,dh= &quot;</span>//trim(mesg), all_print=.true.)</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160; </div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    <span class="keywordflow">if</span> (numberofgroundings - maxgroundings &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;      <span class="keyword">write</span>(mesg, <span class="stringliteral">&#39;(i4)&#39;</span>) numberofgroundings - maxgroundings</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;      <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;MOM_diabatic_driver:F90, applyBoundaryFluxesInOut(): &quot;</span>//&amp;</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;                              trim(mesg) // <span class="stringliteral">&quot; groundings remaining&quot;</span>)</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__shortwave__abs_8F90_source.html#l00048">mom_shortwave_abs::absorbremainingsw()</a>, <a class="el" href="MOM__EOS_8F90_source.html#l00479">mom_eos::calculate_specific_vol_derivs()</a>, <a class="el" href="MOM__forcing__type_8F90_source.html#l00344">mom_forcing_type::extractfluxes1d()</a>, <a class="el" href="MOM__forcing__type_8F90_source.html#l01136">mom_forcing_type::forcing_singlepointprint()</a>, and <a class="el" href="MOM__shortwave__abs_8F90_source.html#l00300">mom_shortwave_abs::sumswoverbands()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__diabatic__driver_8F90_source.html#l00268">mom_diabatic_driver::diabatic()</a>, and <a class="el" href="MOM__diabatic__driver_8F90_source.html#l01127">mom_diabatic_driver::legacy_diabatic()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__diabatic__aux_ab32313b997a7728d99b52665b94e261f_cgraph.svg" width="100%" height="525"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__diabatic__aux_ab32313b997a7728d99b52665b94e261f_icgraph.svg" width="100%" height="388"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a071e066ca5ed6619c6a9515fb07f5567"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a071e066ca5ed6619c6a9515fb07f5567">&#9670;&nbsp;</a></span>diabatic_aux_end()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_diabatic_aux::diabatic_aux_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__diabatic__aux_1_1diabatic__aux__cs.html">diabatic_aux_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine initializes the control structure and any related memory for the diabatic_aux module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">cs</td><td>The control structure returned by a previous call to diabatic_aux_init; it is deallocated here. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__diabatic__aux_8F90_source.html#l01428">1428</a> of file <a class="el" href="MOM__diabatic__aux_8F90_source.html">MOM_diabatic_aux.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;  <span class="keywordtype">type</span>(diabatic_aux_CS), <span class="keywordtype">pointer</span> :: CS<span class="comment"> !&lt; The control structure returned by a previous</span></div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;<span class="comment">                                       !! call to diabatic_aux_init; it is deallocated here.</span></div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160; </div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keywordflow">return</span></div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160; </div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;  <span class="keywordflow">if</span> (cs%id_createdH       &gt;0) <span class="keyword">deallocate</span>(cs%createdH)</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;  <span class="keywordflow">if</span> (cs%id_penSW_diag     &gt;0) <span class="keyword">deallocate</span>(cs%penSW_diag)</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;  <span class="keywordflow">if</span> (cs%id_penSWflux_diag &gt;0) <span class="keyword">deallocate</span>(cs%penSWflux_diag)</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;  <span class="keywordflow">if</span> (cs%id_nonpenSW_diag  &gt;0) <span class="keyword">deallocate</span>(cs%nonpenSW_diag)</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160; </div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keyword">deallocate</span>(cs)</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160; </div>
</div><!-- fragment -->
</div>
</div>
<a id="a967697feb7ea22e1430d2b673ebab544"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a967697feb7ea22e1430d2b673ebab544">&#9670;&nbsp;</a></span>diabatic_aux_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_diabatic_aux::diabatic_aux_init </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(inout), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__diabatic__aux_1_1diabatic__aux__cs.html">diabatic_aux_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>useALEalgorithm</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>use_ePBL</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine initializes the parameters and control structure of the diabatic_aux module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>The current model time </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>A structure to parse for run-time parameters </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">diag</td><td>A structure used to regulate diagnostic output </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>A pointer to the control structure for the diabatic_aux module, which is initialized here. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">usealealgorithm</td><td>If true, use the ALE algorithm rather than layered mode. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">use_epbl</td><td>If true, use the implicit energetics planetary boundary layer scheme to determine the diffusivity in the surface boundary layer. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__diabatic__aux_8F90_source.html#l01303">1303</a> of file <a class="el" href="MOM__diabatic__aux_8F90_source.html">MOM_diabatic_aux.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;  <span class="keywordtype">type</span>(time_type),         <span class="keywordtype">intent(in)</span>    :: Time<span class="comment"> !&lt; The current model time</span></div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>    :: US<span class="comment">   !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;  <span class="keywordtype">type</span>(param_file_type),   <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; A structure to parse for run-time parameters</span></div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>, <span class="keywordtype">intent(inout)</span> :: diag<span class="comment"> !&lt; A structure used to regulate diagnostic output</span></div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;  <span class="keywordtype">type</span>(diabatic_aux_CS),   <span class="keywordtype">pointer</span>       :: CS<span class="comment">   !&lt; A pointer to the control structure for the</span></div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;<span class="comment">                                                 !! diabatic_aux module, which is initialized here.</span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;  <span class="keywordtype">logical</span>,                 <span class="keywordtype">intent(in)</span>    :: useALEalgorithm<span class="comment"> !&lt; If true, use the ALE algorithm rather</span></div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;<span class="comment">                                                 !! than layered mode.</span></div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;  <span class="keywordtype">logical</span>,                 <span class="keywordtype">intent(in)</span>    :: use_ePBL<span class="comment"> !&lt; If true, use the implicit energetics planetary</span></div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;<span class="comment">                                                 !! boundary layer scheme to determine the diffusivity</span></div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;<span class="comment">                                                 !! in the surface boundary layer.</span></div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160; </div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;<span class="comment">! This &quot;include&quot; declares and sets the variable &quot;version&quot;.</span></div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span>  :: mdl  = <span class="stringliteral">&quot;MOM_diabatic_aux&quot;</span> <span class="comment">! This module&#39;s name.</span></div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;  <span class="keywordtype">character(len=48)</span>  :: thickness_units</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;  <span class="keywordtype">integer</span> :: isd, ied, jsd, jed, IsdB, IedB, JsdB, JedB, nz, nbands</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;  isd  = g%isd  ; ied  = g%ied  ; jsd  = g%jsd  ; jed  = g%jed ; nz = g%ke</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;  isdb = g%IsdB ; iedb = g%IedB ; jsdb = g%JsdB ; jedb = g%JedB</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160; </div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;diabatic_aux_init called with an &quot;</span>// &amp;</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;                            <span class="stringliteral">&quot;associated control structure.&quot;</span>)</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;    <span class="keywordflow">return</span></div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;    <span class="keyword">allocate</span>(cs)</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;<span class="keywordflow">   endif</span></div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160; </div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;  cs%diag =&gt; diag</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160; </div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;<span class="comment">! Set default, read and log parameters</span></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, &amp;</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;                   <span class="stringliteral">&quot;The following parameters are used for auxiliary diabatic processes.&quot;</span>)</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160; </div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RECLAIM_FRAZIL&quot;</span>, cs%reclaim_frazil, &amp;</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;                 <span class="stringliteral">&quot;If true, try to use any frazil heat deficit to cool any &quot;</span>//&amp;</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;                 <span class="stringliteral">&quot;overlying layers down to the freezing point, thereby &quot;</span>//&amp;</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;                 <span class="stringliteral">&quot;avoiding the creation of thin ice when the SST is above &quot;</span>//&amp;</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;                 <span class="stringliteral">&quot;the freezing point.&quot;</span>, default=.true.)</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;PRESSURE_DEPENDENT_FRAZIL&quot;</span>, &amp;</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;                                cs%pressure_dependent_frazil, &amp;</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;                 <span class="stringliteral">&quot;If true, use a pressure dependent freezing temperature &quot;</span>//&amp;</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;                 <span class="stringliteral">&quot;when making frazil. The default is false, which will be &quot;</span>//&amp;</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;                 <span class="stringliteral">&quot;faster but is inappropriate with ice-shelf cavities.&quot;</span>, &amp;</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;                 default=.false.)</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160; </div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;  <span class="keywordflow">if</span> (use_epbl) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;IGNORE_FLUXES_OVER_LAND&quot;</span>, cs%ignore_fluxes_over_land,&amp;</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;         <span class="stringliteral">&quot;If true, the model does not check if fluxes are being applied &quot;</span>//&amp;</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;         <span class="stringliteral">&quot;over land points. This is needed when the ocean is coupled &quot;</span>//&amp;</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;         <span class="stringliteral">&quot;with ice shelves and sea ice, since the sea ice mask needs to &quot;</span>//&amp;</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;         <span class="stringliteral">&quot;be different than the ocean mask to avoid sea ice formation &quot;</span>//&amp;</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;         <span class="stringliteral">&quot;under ice shelves. This flag only works when use_ePBL = True.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DO_RIVERMIX&quot;</span>, cs%do_rivermix, &amp;</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;                 <span class="stringliteral">&quot;If true, apply additional mixing wherever there is &quot;</span>//&amp;</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;                 <span class="stringliteral">&quot;runoff, so that it is mixed down to RIVERMIX_DEPTH &quot;</span>//&amp;</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;                 <span class="stringliteral">&quot;if the ocean is that deep.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;    <span class="keywordflow">if</span> (cs%do_rivermix) &amp;</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RIVERMIX_DEPTH&quot;</span>, cs%rivermix_depth, &amp;</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;                 <span class="stringliteral">&quot;The depth to which rivers are mixed if DO_RIVERMIX is &quot;</span>//&amp;</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;                 <span class="stringliteral">&quot;defined.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, default=0.0, scale=us%m_to_Z)</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;    cs%do_rivermix = .false. ; cs%rivermix_depth = 0.0 ; cs%ignore_fluxes_over_land = .false.</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160; </div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;  <span class="keywordflow">if</span> (gv%nkml == 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_RIVER_HEAT_CONTENT&quot;</span>, cs%use_river_heat_content, &amp;</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;                   <span class="stringliteral">&quot;If true, use the fluxes%runoff_Hflx field to set the &quot;</span>//&amp;</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;                   <span class="stringliteral">&quot;heat carried by runoff, instead of using SST*CP*liq_runoff.&quot;</span>, &amp;</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;                   default=.false.)</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_CALVING_HEAT_CONTENT&quot;</span>, cs%use_calving_heat_content, &amp;</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;                   <span class="stringliteral">&quot;If true, use the fluxes%calving_Hflx field to set the &quot;</span>//&amp;</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;                   <span class="stringliteral">&quot;heat carried by runoff, instead of using SST*CP*froz_runoff.&quot;</span>, &amp;</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;                   default=.false.)</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;    cs%use_river_heat_content = .false.</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    cs%use_calving_heat_content = .false.</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160; </div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;  <span class="keywordflow">if</span> (usealealgorithm) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    cs%id_createdH = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&quot;created_H&quot;</span>,diag%axesT1, &amp;</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;        time, <span class="stringliteral">&quot;The volume flux added to stop the ocean from drying out and becoming negative in depth&quot;</span>, &amp;</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;        <span class="stringliteral">&quot;m s-1&quot;</span>)</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;    <span class="keywordflow">if</span> (cs%id_createdH&gt;0) <span class="keyword">allocate</span>(cs%createdH(isd:ied,jsd:jed))</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160; </div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;    <span class="comment">! diagnostic for heating of a grid cell from convergence of SW heat into the cell</span></div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;    cs%id_penSW_diag = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;rsdoabsorb&#39;</span>,                     &amp;</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;          diag%axesTL, time, <span class="stringliteral">&#39;Convergence of Penetrative Shortwave Flux in Sea Water Layer&#39;</span>,&amp;</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;          <span class="stringliteral">&#39;W m-2&#39;</span>, standard_name=<span class="stringliteral">&#39;net_rate_of_absorption_of_shortwave_energy_in_ocean_layer&#39;</span>,v_extensive=.true.)</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160; </div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;    <span class="comment">! diagnostic for penetrative SW heat flux at top interface of tracer cell (nz+1 interfaces)</span></div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;    <span class="comment">! k=1 gives penetrative SW at surface; SW(k=nz+1)=0 (no penetration through rock).</span></div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;    cs%id_penSWflux_diag = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;rsdo&#39;</span>,                               &amp;</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;          diag%axesTi, time, <span class="stringliteral">&#39;Downwelling Shortwave Flux in Sea Water at Grid Cell Upper Interface&#39;</span>,&amp;</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;          <span class="stringliteral">&#39;W m-2&#39;</span>, standard_name=<span class="stringliteral">&#39;downwelling_shortwave_flux_in_sea_water&#39;</span>)</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160; </div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;    <span class="comment">! need both arrays for the SW diagnostics (one for flux, one for convergence)</span></div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;    <span class="keywordflow">if</span> (cs%id_penSW_diag&gt;0 .or. cs%id_penSWflux_diag&gt;0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;       <span class="keyword">allocate</span>(cs%penSW_diag(isd:ied,jsd:jed,nz))</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;       cs%penSW_diag(:,:,:) = 0.0</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;       <span class="keyword">allocate</span>(cs%penSWflux_diag(isd:ied,jsd:jed,nz+1))</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;       cs%penSWflux_diag(:,:,:) = 0.0</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160; </div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;    <span class="comment">! diagnostic for non-downwelling SW radiation (i.e., SW absorbed at ocean surface)</span></div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;    cs%id_nonpenSW_diag = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;nonpenSW&#39;</span>,                       &amp;</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;          diag%axesT1, time,                                                                   &amp;</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;          <span class="stringliteral">&#39;Non-downwelling SW radiation (i.e., SW absorbed in ocean surface with LW,SENS,LAT)&#39;</span>,&amp;</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;          <span class="stringliteral">&#39;W m-2&#39;</span>, standard_name=<span class="stringliteral">&#39;nondownwelling_shortwave_flux_in_sea_water&#39;</span>)</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    <span class="keywordflow">if</span> (cs%id_nonpenSW_diag &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;       <span class="keyword">allocate</span>(cs%nonpenSW_diag(isd:ied,jsd:jed))</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;       cs%nonpenSW_diag(:,:) = 0.0</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160; </div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;  id_clock_uv_at_h = cpu_clock_id(<span class="stringliteral">&#39;(Ocean find_uv_at_h)&#39;</span>, grain=clock_routine)</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;  id_clock_frazil  = cpu_clock_id(<span class="stringliteral">&#39;(Ocean frazil)&#39;</span>, grain=clock_routine)</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00081">id_clock_frazil</a>, and <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00081">id_clock_uv_at_h</a>.</p>

</div>
</div>
<a id="a43ac98433f0f2f0e6cf4f8a3c9622ec4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a43ac98433f0f2f0e6cf4f8a3c9622ec4">&#9670;&nbsp;</a></span>diagnosemldbydensitydifference()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_diabatic_aux::diagnosemldbydensitydifference </td>
          <td>(</td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>id_MLD</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>densityDiff</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), pointer&#160;</td>
          <td class="paramname"><em>diagPtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in), optional&#160;</td>
          <td class="paramname"><em>id_N2subML</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in), optional&#160;</td>
          <td class="paramname"><em>id_MLDsq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>dz_subML</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Diagnose a mixed layer depth (MLD) determined by a given density difference with the surface. This routine is appropriate in MOM_diabatic_driver due to its position within the time stepping. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Grid type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>ocean vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">id_mld</td><td>Handle (ID) of MLD diagnostic </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thickness [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>Structure containing pointers to any available thermodynamic fields. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">densitydiff</td><td>Density difference to determine MLD [kg m-3] </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">diagptr</td><td>Diagnostics structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">id_n2subml</td><td>Optional handle (ID) of subML stratification </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">id_mldsq</td><td>Optional handle (ID) of squared MLD </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dz_subml</td><td>The distance over which to calculate N2subML or 50 m if missing [Z ~&gt; m] </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00645">645</a> of file <a class="el" href="MOM__diabatic__aux_8F90_source.html">MOM_diabatic_aux.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span> :: G<span class="comment">           !&lt; Grid type</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span> :: GV<span class="comment">          !&lt; ocean vertical grid structure</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span> :: US<span class="comment">          !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;  <span class="keywordtype">integer</span>,                 <span class="keywordtype">intent(in)</span> :: id_MLD<span class="comment">      !&lt; Handle (ID) of MLD diagnostic</span></div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                           <span class="keywordtype">intent(in)</span> :: h<span class="comment">           !&lt; Layer thickness [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),   <span class="keywordtype">intent(in)</span> :: tv<span class="comment">          !&lt; Structure containing pointers to any</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;<span class="comment">                                                     !! available thermodynamic fields.</span></div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span> :: densityDiff<span class="comment"> !&lt; Density difference to determine MLD [kg m-3]</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl),         <span class="keywordtype">pointer</span>    :: diagPtr<span class="comment">     !&lt; Diagnostics structure</span></div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;  <span class="keywordtype">integer</span>,       <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: id_N2subML<span class="comment">  !&lt; Optional handle (ID) of subML stratification</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;  <span class="keywordtype">integer</span>,       <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: id_MLDsq<span class="comment">    !&lt; Optional handle (ID) of squared MLD</span></div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;<span class="keywordtype">  real</span>,          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: dz_subML<span class="comment">    !&lt; The distance over which to calculate N2subML</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="comment">                                                     !! or 50 m if missing [Z ~&gt; m]</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160; </div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: deltaRhoAtKm1, deltaRhoAtK <span class="comment">! Density differences [kg m-3].</span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: pRef_MLD, pRef_N2 <span class="comment">! Reference pressures [Pa].</span></div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: H_subML, dH_N2    <span class="comment">! Summed thicknesses used in N2 calculation [H ~&gt; m].</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: T_subML, T_deeper <span class="comment">! Temperatures used in the N2 calculation [degC].</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: S_subML, S_deeper <span class="comment">! Salinities used in the N2 calculation [ppt].</span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: rho_subML, rho_deeper <span class="comment">! Densities used in the N2 calculation [kg m-3].</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: dK, dKm1          <span class="comment">! Depths [Z ~&gt; m].</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: rhoSurf          <span class="comment">! Density used in finding the mixedlayer depth [kg m-3].</span></div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G), SZJ_(G))</span> :: MLD     <span class="comment">! Diagnosed mixed layer depth [Z ~&gt; m].</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G), SZJ_(G))</span> :: subMLN2 <span class="comment">! Diagnosed stratification below ML [s-2].</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G), SZJ_(G))</span> :: MLD2    <span class="comment">! Diagnosed MLD^2 [Z2 ~&gt; m2].</span></div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: N2_region_set <span class="comment">! If true, all necessary values for calculating N2</span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;                                               <span class="comment">! have been stored already.</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="keywordtype">  real</span> :: gE_Rho0          <span class="comment">! The gravitational acceleration divided by a mean density [m4 s-2 kg-1].</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="keywordtype">  real</span> :: dH_subML         <span class="comment">! Depth below ML over which to diagnose stratification [H ~&gt; m].</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je, k, nz, id_N2, id_SQ</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="keywordtype">  real</span> :: aFac, ddRho</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160; </div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;  id_n2 = -1 ; <span class="keywordflow">if</span> (<span class="keyword">PRESENT</span>(id_n2subml)) id_n2 = id_n2subml</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160; </div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;  id_sq = -1 ; <span class="keywordflow">if</span> (<span class="keyword">PRESENT</span>(id_n2subml)) id_sq = id_mldsq</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160; </div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;  ge_rho0 = us%m_to_Z**2 * gv%g_Earth / gv%Rho0</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;  dh_subml = 50.*gv%m_to_H  ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(dz_subml)) dh_subml = gv%Z_to_H*dz_subml</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160; </div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160; </div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;  pref_mld(:) = 0.0</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;  <span class="keywordflow">do</span> j=js,je</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; dk(i) = 0.5 * h(i,j,1) * gv%H_to_Z ;<span class="keywordflow"> enddo</span> <span class="comment">! Depth of center of surface layer</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    <span class="keyword">call </span>calculate_density(tv%T(:,j,1), tv%S(:,j,1), pref_mld, rhosurf, is, ie-is+1, tv%eqn_of_state)</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;      deltarhoatk(i) = 0.</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;      mld(i,j) = 0.</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;      <span class="keywordflow">if</span> (id_n2&gt;0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        submln2(i,j) = 0.0</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        h_subml(i) = h(i,j,1) ; dh_n2(i) = 0.0</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;        t_subml(i) = 0.0  ; s_subml(i) = 0.0 ; t_deeper(i) = 0.0 ; s_deeper(i) = 0.0</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;        n2_region_set(i) = (g%mask2dT(i,j)&lt;0.5) <span class="comment">! Only need to work on ocean points.</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    <span class="keywordflow">do</span> k=2,nz</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;        dkm1(i) = dk(i) <span class="comment">! Depth of center of layer K-1</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;        dk(i) = dk(i) + 0.5 * ( h(i,j,k) + h(i,j,k-1) ) * gv%H_to_Z <span class="comment">! Depth of center of layer K</span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160; </div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;      <span class="comment">! Prepare to calculate stratification, N2, immediately below the mixed layer by finding</span></div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;      <span class="comment">! the cells that extend over at least dz_subML.</span></div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;      <span class="keywordflow">if</span> (id_n2&gt;0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;         <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;          <span class="keywordflow">if</span> (mld(i,j)==0.0) <span class="keywordflow">then</span>  <span class="comment">! Still in the mixed layer.</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;            h_subml(i) = h_subml(i) + h(i,j,k)</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;          <span class="keywordflow">elseif</span> (.not.n2_region_set(i)) <span class="keywordflow">then</span> <span class="comment">! This block is below the mixed layer, but N2 has not been found yet.</span></div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;            <span class="keywordflow">if</span> (dh_n2(i)==0.0) <span class="keywordflow">then</span> <span class="comment">! Record the temperature, salinity, pressure, immediately below the ML</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;              t_subml(i) = tv%T(i,j,k) ; s_subml(i) = tv%S(i,j,k)</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;              h_subml(i) = h_subml(i) + 0.5 * h(i,j,k) <span class="comment">! Start midway through this layer.</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;              dh_n2(i) = 0.5 * h(i,j,k)</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;            <span class="keywordflow">elseif</span> (dh_n2(i) + h(i,j,k) &lt; dh_subml) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;              dh_n2(i) = dh_n2(i) + h(i,j,k)</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;            <span class="keywordflow">else</span>  <span class="comment">! This layer includes the base of the region where N2 is calculated.</span></div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;              t_deeper(i) = tv%T(i,j,k) ; s_deeper(i) = tv%S(i,j,k)</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;              dh_n2(i) = dh_n2(i) + 0.5 * h(i,j,k)</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;              n2_region_set(i) = .true.</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;<span class="keywordflow">        enddo</span> <span class="comment">! i-loop</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! id_N2&gt;0</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160; </div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;      <span class="comment">! Mixed-layer depth, using sigma-0 (surface reference pressure)</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; deltarhoatkm1(i) = deltarhoatk(i) ;<span class="keywordflow"> enddo</span> <span class="comment">! Store value from previous iteration of K</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;      <span class="keyword">call </span>calculate_density(tv%T(:,j,k), tv%S(:,j,k), pref_mld, deltarhoatk, is, ie-is+1, tv%eqn_of_state)</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;      <span class="keywordflow">do</span> i = is, ie</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        deltarhoatk(i) = deltarhoatk(i) - rhosurf(i) <span class="comment">! Density difference between layer K and surface</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;        ddrho = deltarhoatk(i) - deltarhoatkm1(i)</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;        <span class="keywordflow">if</span> ((mld(i,j)==0.) .and. (ddrho&gt;0.) .and. &amp;</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;            (deltarhoatkm1(i)&lt;densitydiff) .and. (deltarhoatk(i)&gt;=densitydiff)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;          afac = ( densitydiff - deltarhoatkm1(i) ) / ddrho</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;          mld(i,j) = dk(i) * afac + dkm1(i) * (1. - afac)</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;        <span class="keywordflow">if</span> (id_sq &gt; 0) mld2(i,j) = mld(i,j)**2</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="keywordflow">      enddo</span> <span class="comment">! i-loop</span></div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! k-loop</span></div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;      <span class="keywordflow">if</span> ((mld(i,j)==0.) .and. (deltarhoatk(i)&lt;densitydiff)) mld(i,j) = dk(i) <span class="comment">! Assume mixing to the bottom</span></div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160; </div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    <span class="keywordflow">if</span> (id_n2&gt;0) <span class="keywordflow">then</span>  <span class="comment">! Now actually calculate stratification, N2, below the mixed layer.</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; pref_n2(i) = gv%H_to_Pa * (h_subml(i) + 0.5*dh_n2(i)) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;      <span class="comment">! if ((.not.N2_region_set(i)) .and. (dH_N2(i) &gt; 0.5*dH_subML)) then</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;      <span class="comment">!    ! Use whatever stratification we can, measured over whatever distance is available?</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;      <span class="comment">!    T_deeper(i) = tv%T(i,j,nz) ; S_deeper(i) = tv%S(i,j,nz)</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;      <span class="comment">!    N2_region_set(i) = .true.</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;      <span class="comment">! endif</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;      <span class="keyword">call </span>calculate_density(t_subml, s_subml, pref_n2, rho_subml, is, ie-is+1, tv%eqn_of_state)</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;      <span class="keyword">call </span>calculate_density(t_deeper, s_deeper, pref_n2, rho_deeper, is, ie-is+1, tv%eqn_of_state)</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> ((g%mask2dT(i,j)&gt;0.5) .and. n2_region_set(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;        submln2(i,j) =  ge_rho0 * (rho_deeper(i) - rho_subml(i)) / (gv%H_to_z * dh_n2(i))</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! j-loop</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160; </div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;  <span class="keywordflow">if</span> (id_mld &gt; 0) <span class="keyword">call </span>post_data(id_mld, mld, diagptr)</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;  <span class="keywordflow">if</span> (id_n2 &gt; 0)  <span class="keyword">call </span>post_data(id_n2, submln2 , diagptr)</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;  <span class="keywordflow">if</span> (id_sq &gt; 0)  <span class="keyword">call </span>post_data(id_sq, mld2, diagptr)</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__diabatic__driver_8F90_source.html#l00268">mom_diabatic_driver::diabatic()</a>, and <a class="el" href="MOM__diabatic__driver_8F90_source.html#l01127">mom_diabatic_driver::legacy_diabatic()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__diabatic__aux_a43ac98433f0f2f0e6cf4f8a3c9622ec4_icgraph.svg" width="100%" height="388"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="aa9248acf0b1cf246a79092077bcb0b46"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa9248acf0b1cf246a79092077bcb0b46">&#9670;&nbsp;</a></span>differential_diffuse_t_s()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_diabatic_aux::differential_diffuse_t_s </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(vertvisc_type), intent(in)&#160;</td>
          <td class="paramname"><em>visc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine applies double diffusion to T &amp; S, assuming no diapycal mass fluxes, using a simple triadiagonal solver. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">tv</td><td>Structure containing pointers to any available thermodynamic fields. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">visc</td><td>Structure containing vertical viscosities, bottom boundary layer properies, and related fields. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment [s]. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00211">211</a> of file <a class="el" href="MOM__diabatic__aux_8F90_source.html">MOM_diabatic_aux.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: h<span class="comment">    !&lt; Layer thicknesses [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),   <span class="keywordtype">intent(inout)</span> :: tv<span class="comment">   !&lt; Structure containing pointers to any</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">                                                 !! available thermodynamic fields.</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;  <span class="keywordtype">type</span>(vertvisc_type),     <span class="keywordtype">intent(in)</span>    :: visc<span class="comment"> !&lt; Structure containing vertical viscosities, bottom</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment">                                                 !! boundary layer properies, and related fields.</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">   !&lt;  Time increment [s].</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160; </div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;  <span class="comment">! local variables</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    b1_T, b1_S, &amp;  <span class="comment">!  Variables used by the tridiagonal solvers of T &amp; S [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    d1_T, d1_S     <span class="comment">!  Variables used by the tridiagonal solvers [nondim].</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span> :: &amp;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    c1_T, c1_S     <span class="comment">!  Variables used by the tridiagonal solvers [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span> :: &amp;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    mix_T, mix_S   <span class="comment">!  Mixing distances in both directions across each interface [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="keywordtype">  real</span> :: h_tr         <span class="comment">! h_tr is h at tracer points with a tiny thickness</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                       <span class="comment">! added to ensure positive definiteness [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="keywordtype">  real</span> :: h_neglect    <span class="comment">! A thickness that is so small it is usually lost</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                       <span class="comment">! in roundoff and can be neglected [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="keywordtype">  real</span> :: I_h_int      <span class="comment">! The inverse of the thickness associated with an</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                       <span class="comment">! interface [H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="keywordtype">  real</span> :: b_denom_T    <span class="comment">! The first term in the denominators for the expressions</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="keywordtype">  real</span> :: b_denom_S    <span class="comment">! for b1_T and b1_S, both [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:,:)</span>, <span class="keywordtype">pointer</span> :: T=&gt;null(), s=&gt;null()</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:,:)</span>, <span class="keywordtype">pointer</span> :: Kd_T=&gt;null(), kd_s=&gt;null() <span class="comment">! Diffusivities [Z2 s-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, nz</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160; </div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;  h_neglect = gv%H_subroundoff</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; </div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(tv%T)) <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;      <span class="stringliteral">&quot;differential_diffuse_T_S: Called with an unassociated tv%T&quot;</span>)</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(tv%S)) <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;      <span class="stringliteral">&quot;differential_diffuse_T_S: Called with an unassociated tv%S&quot;</span>)</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(visc%Kd_extra_T)) <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;      <span class="stringliteral">&quot;differential_diffuse_T_S: Called with an unassociated visc%Kd_extra_T&quot;</span>)</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(visc%Kd_extra_S)) <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;      <span class="stringliteral">&quot;differential_diffuse_T_S: Called with an unassociated visc%Kd_extra_S&quot;</span>)</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160; </div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  t =&gt; tv%T ; s =&gt; tv%S</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;  kd_t =&gt; visc%Kd_extra_T ; kd_s =&gt; visc%Kd_extra_S</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,h,h_neglect,dt,Kd_T,Kd_S,G,GV,T,S,nz) &amp;</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">!$OMP                          private(I_h_int,mix_T,mix_S,h_tr,b1_T,b1_S, &amp;</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="comment">!$OMP                                  d1_T,d1_S,c1_T,c1_S,b_denom_T,b_denom_S)</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  <span class="keywordflow">do</span> j=js,je</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;      i_h_int = 1.0 / (0.5 * (h(i,j,1) + h(i,j,2)) + h_neglect)</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;      mix_t(i,2) = ((dt * kd_t(i,j,2)) * gv%Z_to_H**2) * i_h_int</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;      mix_s(i,2) = ((dt * kd_s(i,j,2)) * gv%Z_to_H**2) * i_h_int</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160; </div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;      h_tr = h(i,j,1) + h_neglect</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;      b1_t(i) = 1.0 / (h_tr + mix_t(i,2))</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;      b1_s(i) = 1.0 / (h_tr + mix_s(i,2))</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;      d1_t(i) = h_tr * b1_t(i)</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;      d1_s(i) = h_tr * b1_s(i)</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;      t(i,j,1) = (b1_t(i)*h_tr)*t(i,j,1)</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;      s(i,j,1) = (b1_s(i)*h_tr)*s(i,j,1)</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="keywordflow">do</span> k=2,nz-1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;      <span class="comment">! Calculate the mixing across the interface below this layer.</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;      i_h_int = 1.0 / (0.5 * (h(i,j,k) + h(i,j,k+1)) + h_neglect)</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;      mix_t(i,k+1) = ((dt * kd_t(i,j,k+1)) * gv%Z_to_H**2) * i_h_int</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;      mix_s(i,k+1) = ((dt * kd_s(i,j,k+1)) * gv%Z_to_H**2) * i_h_int</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160; </div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;      c1_t(i,k) = mix_t(i,k) * b1_t(i)</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;      c1_s(i,k) = mix_s(i,k) * b1_s(i)</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160; </div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;      h_tr = h(i,j,k) + h_neglect</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;      b_denom_t = h_tr + d1_t(i)*mix_t(i,k)</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;      b_denom_s = h_tr + d1_s(i)*mix_s(i,k)</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;      b1_t(i) = 1.0 / (b_denom_t + mix_t(i,k+1))</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;      b1_s(i) = 1.0 / (b_denom_s + mix_s(i,k+1))</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;      d1_t(i) = b_denom_t * b1_t(i)</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;      d1_s(i) = b_denom_s * b1_s(i)</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160; </div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;      t(i,j,k) = b1_t(i) * (h_tr*t(i,j,k) + mix_t(i,k)*t(i,j,k-1))</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;      s(i,j,k) = b1_s(i) * (h_tr*s(i,j,k) + mix_s(i,k)*s(i,j,k-1))</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;      c1_t(i,nz) = mix_t(i,nz) * b1_t(i)</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;      c1_s(i,nz) = mix_s(i,nz) * b1_s(i)</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160; </div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;      h_tr = h(i,j,nz) + h_neglect</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;      b1_t(i) = 1.0 / (h_tr + d1_t(i)*mix_t(i,nz))</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;      b1_s(i) = 1.0 / (h_tr + d1_s(i)*mix_s(i,nz))</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160; </div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;      t(i,j,nz) = b1_t(i) * (h_tr*t(i,j,nz) + mix_t(i,nz)*t(i,j,nz-1))</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;      s(i,j,nz) = b1_s(i) * (h_tr*s(i,j,nz) + mix_s(i,nz)*s(i,j,nz-1))</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    <span class="keywordflow">do</span> k=nz-1,1,-1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;      t(i,j,k) = t(i,j,k) + c1_t(i,k+1)*t(i,j,k+1)</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;      s(i,j,k) = s(i,j,k) + c1_s(i,k+1)*s(i,j,k+1)</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="keywordflow">  enddo</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="ac18edf904af75caadea28fc234a57a3c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac18edf904af75caadea28fc234a57a3c">&#9670;&nbsp;</a></span>find_uv_at_h()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_diabatic_aux::find_uv_at_h </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>u_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>v_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in), optional&#160;</td>
          <td class="paramname"><em>ea</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in), optional&#160;</td>
          <td class="paramname"><em>eb</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine calculates u_h and v_h (velocities at thickness points), optionally using the entrainment amounts passed in as arguments. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u</td><td>The zonal velocity [m s-1] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v</td><td>The meridional velocity [m s-1] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">u_h</td><td>Zonal velocity interpolated to h points [m s-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">v_h</td><td>Meridional velocity interpolated to h points [m s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ea</td><td>The amount of fluid entrained from the layer </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">eb</td><td>The amount of fluid entrained from the layer </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00543">543</a> of file <a class="el" href="MOM__diabatic__aux_8F90_source.html">MOM_diabatic_aux.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),     <span class="keywordtype">intent(in)</span>  :: G<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type),   <span class="keywordtype">intent(in)</span>  :: GV<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                             <span class="keywordtype">intent(in)</span>  :: u<span class="comment">    !&lt; The zonal velocity [m s-1]</span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;                             <span class="keywordtype">intent(in)</span>  :: v<span class="comment">    !&lt; The meridional velocity [m s-1]</span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                             <span class="keywordtype">intent(in)</span>  :: h<span class="comment">    !&lt; Layer thicknesses [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                             <span class="keywordtype">intent(out)</span>   :: u_h<span class="comment"> !&lt; Zonal velocity interpolated to h points [m s-1].</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                             <span class="keywordtype">intent(out)</span>   :: v_h<span class="comment"> !&lt; Meridional velocity interpolated to h points [m s-1].</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                     <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>  :: ea<span class="comment"> !&lt; The amount of fluid entrained from the layer</span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="comment">                                                 !! above within this time step [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="comment">                                                 !! Omitting ea is the same as setting it to 0.</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                     <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>  :: eb<span class="comment"> !&lt; The amount of fluid entrained from the layer</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="comment">                                                 !! below within this time step [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="comment">                                                 !! Omitting eb is the same as setting it to 0.</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160; </div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;  <span class="comment">! local variables</span></div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="keywordtype">  real</span> :: b_denom_1    <span class="comment">! The first term in the denominator of b1 [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="keywordtype">  real</span> :: h_neglect    <span class="comment">! A thickness that is so small it is usually lost</span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                       <span class="comment">! in roundoff and can be neglected [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;<span class="keywordtype">  real</span> :: b1(SZI_(G)), d1(SZI_(G)), c1(SZI_(G),SZK_(G))</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;<span class="keywordtype">  real</span> :: a_n(SZI_(G)), a_s(SZI_(G))  <span class="comment">! Fractional weights of the neighboring</span></div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;<span class="keywordtype">  real</span> :: a_e(SZI_(G)), a_w(SZI_(G))  <span class="comment">! velocity points, ~1/2 in the open</span></div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                                      <span class="comment">! ocean, nondimensional.</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;<span class="keywordtype">  real</span> :: s, Idenom</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;  <span class="keywordtype">logical</span> :: mix_vertically</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, nz</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_uv_at_h)</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;  h_neglect = gv%H_subroundoff</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160; </div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;  mix_vertically = <span class="keyword">present</span>(ea)</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(ea) .neqv. <span class="keyword">present</span>(eb)) <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;      <span class="stringliteral">&quot;find_uv_at_h: Either both ea and eb or neither one must be present &quot;</span>// &amp;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;      <span class="stringliteral">&quot;in call to find_uv_at_h.&quot;</span>)</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,G,GV,mix_vertically,h,h_neglect, &amp;</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="comment">!$OMP                                  eb,u_h,u,v_h,v,nz,ea)                     &amp;</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="comment">!$OMP                          private(s,Idenom,a_w,a_e,a_s,a_n,b_denom_1,b1,d1,c1)</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;  <span class="keywordflow">do</span> j=js,je</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;      s = g%areaCu(i-1,j)+g%areaCu(i,j)</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;      <span class="keywordflow">if</span> (s&gt;0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        idenom = sqrt(0.5*g%IareaT(i,j)/s)</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        a_w(i) = g%areaCu(i-1,j)*idenom</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;        a_e(i) = g%areaCu(i,j)*idenom</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        a_w(i) = 0.0 ; a_e(i) = 0.0</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160; </div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;      s = g%areaCv(i,j-1)+g%areaCv(i,j)</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;      <span class="keywordflow">if</span> (s&gt;0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        idenom = sqrt(0.5*g%IareaT(i,j)/s)</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        a_s(i) = g%areaCv(i,j-1)*idenom</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;        a_n(i) = g%areaCv(i,j)*idenom</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        a_s(i) = 0.0 ; a_n(i) = 0.0</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160; </div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    <span class="keywordflow">if</span> (mix_vertically) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        b_denom_1 = h(i,j,1) + h_neglect</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;        b1(i) = 1.0 / (b_denom_1 + eb(i,j,1))</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        d1(i) = b_denom_1 * b1(i)</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        u_h(i,j,1) = (h(i,j,1)*b1(i)) * (a_e(i)*u(i,j,1) + a_w(i)*u(i-1,j,1))</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;        v_h(i,j,1) = (h(i,j,1)*b1(i)) * (a_n(i)*v(i,j,1) + a_s(i)*v(i,j-1,1))</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;      <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        c1(i,k) = eb(i,j,k-1) * b1(i)</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        b_denom_1 = h(i,j,k) + d1(i)*ea(i,j,k) + h_neglect</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        b1(i) = 1.0 / (b_denom_1 + eb(i,j,k))</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        d1(i) = b_denom_1 * b1(i)</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        u_h(i,j,k) = (h(i,j,k) * (a_e(i)*u(i,j,k) + a_w(i)*u(i-1,j,k)) + &amp;</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                      ea(i,j,k)*u_h(i,j,k-1))*b1(i)</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        v_h(i,j,k) = (h(i,j,k) * (a_n(i)*v(i,j,k) + a_s(i)*v(i,j-1,k)) + &amp;</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                      ea(i,j,k)*v_h(i,j,k-1))*b1(i)</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;      <span class="keywordflow">do</span> k=nz-1,1,-1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        u_h(i,j,k) = u_h(i,j,k) + c1(i,k+1)*u_h(i,j,k+1)</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        v_h(i,j,k) = v_h(i,j,k) + c1(i,k+1)*v_h(i,j,k+1)</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        u_h(i,j,k) = a_e(i)*u(i,j,k) + a_w(i)*u(i-1,j,k)</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        v_h(i,j,k) = a_n(i)*v(i,j,k) + a_s(i)*v(i,j-1,k)</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160; </div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_uv_at_h)</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00081">id_clock_uv_at_h</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__diabatic__driver_8F90_source.html#l00268">mom_diabatic_driver::diabatic()</a>, and <a class="el" href="MOM__diabatic__driver_8F90_source.html#l01127">mom_diabatic_driver::legacy_diabatic()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__diabatic__aux_ac18edf904af75caadea28fc234a57a3c_icgraph.svg" width="100%" height="388"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a73cdec946a5ab30bee6fdd119aa970ad"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a73cdec946a5ab30bee6fdd119aa970ad">&#9670;&nbsp;</a></span>insert_brine()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_diabatic_aux::insert_brine </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nkmb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__diabatic__aux_1_1diabatic__aux__cs.html">diabatic_aux_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>id_brine_lay</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Insert salt from brine rejection into the first layer below the mixed layer which both contains mass and in which the change in layer density remains stable after the addition of salt via brine rejection. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">tv</td><td>Structure containing pointers to any available thermodynamic fields </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fluxes</td><td>A structure of thermodynamic surface fluxes </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nkmb</td><td>The number of layers in the mixed and buffer layers </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>The control structure returned by a previous call to diabatic_aux_init </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>The thermodyanmic time step [s]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">id_brine_lay</td><td>The handle for a diagnostic which layer receivees the brine. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00374">374</a> of file <a class="el" href="MOM__diabatic__aux_8F90_source.html">MOM_diabatic_aux.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: h<span class="comment">    !&lt; Layer thicknesses [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),   <span class="keywordtype">intent(inout)</span> :: tv<span class="comment">   !&lt; Structure containing pointers to any</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="comment">                                                 !! available thermodynamic fields</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;  <span class="keywordtype">type</span>(forcing),           <span class="keywordtype">intent(in)</span>    :: fluxes<span class="comment"> !&lt; A structure of thermodynamic surface fluxes</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;  <span class="keywordtype">integer</span>,                 <span class="keywordtype">intent(in)</span>    :: nkmb<span class="comment"> !&lt; The number of layers in the mixed and buffer layers</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;  <span class="keywordtype">type</span>(diabatic_aux_CS),   <span class="keywordtype">intent(in)</span>    :: CS<span class="comment">   !&lt; The control structure returned by a previous</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="comment">                                                 !! call to diabatic_aux_init</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">   !&lt; The thermodyanmic time step [s].</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  <span class="keywordtype">integer</span>,                 <span class="keywordtype">intent(in)</span>    :: id_brine_lay<span class="comment"> !&lt; The handle for a diagnostic</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="comment">                                                 !! which layer receivees the brine.</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160; </div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;  <span class="comment">! local variables</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="keywordtype">  real</span> :: salt(SZI_(G)) <span class="comment">! The amount of salt rejected from</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                        <span class="comment">!  sea ice. [grams]</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="keywordtype">  real</span> :: dzbr(SZI_(G)) <span class="comment">! cumulative depth over which brine is distributed</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="keywordtype">  real</span> :: inject_layer(SZI_(G),SZJ_(G)) <span class="comment">! diagnostic</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160; </div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="keywordtype">  real</span> :: p_ref_cv(SZI_(G))</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="keywordtype">  real</span> :: T(SZI_(G),SZK_(G))</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="keywordtype">  real</span> :: S(SZI_(G),SZK_(G))</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="keywordtype">  real</span> :: h_2d(SZI_(G),SZK_(G))</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="keywordtype">  real</span> :: Rcv(SZI_(G),SZK_(G))</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="keywordtype">  real</span> :: mc  <span class="comment">! A layer&#39;s mass [kg m-2].</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="keywordtype">  real</span> :: s_new,R_new,t0,scale, cdz</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, nz, ks</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160; </div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: brine_dz = 1.0  <span class="comment">! minumum thickness over which to distribute brine</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: s_max = 45.0    <span class="comment">! salinity bound</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160; </div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160; </div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(fluxes%salt_flux)) <span class="keywordflow">return</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160; </div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;  p_ref_cv(:)  = tv%P_ref</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160; </div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  inject_layer(:,:) = nz</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160; </div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;  <span class="keywordflow">do</span> j=js,je</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160; </div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    salt(:)=0.0 ; dzbr(:)=0.0</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160; </div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (g%mask2dT(i,j) &gt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;      salt(i) = dt * (1000. * fluxes%salt_flux(i,j))</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160; </div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        t(i,k)=tv%T(i,j,k); s(i,k)=tv%S(i,j,k)</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        <span class="comment">! avoid very small thickness</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        h_2d(i,k)=max(h(i,j,k), gv%Angstrom_H)</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160; </div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;      <span class="keyword">call </span>calculate_density(t(:,k), s(:,k), p_ref_cv, rcv(:,k), is, &amp;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                             ie-is+1, tv%eqn_of_state)</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160; </div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    <span class="comment">! First, try to find an interior layer where inserting all the salt</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="comment">! will not cause the layer to become statically unstable.</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    <span class="comment">! Bias towards deeper layers.</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160; </div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    <span class="keywordflow">do</span> k=nkmb+1,nz-1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;      <span class="keywordflow">if</span> ((g%mask2dT(i,j) &gt; 0.0) .and. dzbr(i) &lt; brine_dz .and. salt(i) &gt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        mc = gv%H_to_kg_m2 * h_2d(i,k)</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;        s_new = s(i,k) + salt(i)/mc</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        t0 = t(i,k)</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        <span class="keyword">call </span>calculate_density(t0,s_new,tv%P_Ref,r_new,tv%eqn_of_state)</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        <span class="keywordflow">if</span> (r_new &lt; 0.5*(rcv(i,k)+rcv(i,k+1)) .and. s_new&lt;s_max) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;          dzbr(i)=dzbr(i)+h_2d(i,k)</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;          inject_layer(i,j) = min(inject_layer(i,j),real(k))</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160; </div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    <span class="comment">! Then try to insert into buffer layers if they exist</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    <span class="keywordflow">do</span> k=nkmb,gv%nkml+1,-1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;      <span class="keywordflow">if</span> ((g%mask2dT(i,j) &gt; 0.0) .and. dzbr(i) &lt; brine_dz .and. salt(i) &gt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        mc = gv%H_to_kg_m2 * h_2d(i,k)</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;        dzbr(i)=dzbr(i)+h_2d(i,k)</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;        inject_layer(i,j) = min(inject_layer(i,j),real(k))</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160; </div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    <span class="comment">! finally if unable to find a layer to insert, then place in mixed layer</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160; </div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    <span class="keywordflow">do</span> k=1,gv%nkml ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;      <span class="keywordflow">if</span> ((g%mask2dT(i,j) &gt; 0.0) .and. dzbr(i) &lt; brine_dz .and. salt(i) &gt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;        mc = gv%H_to_kg_m2 * h_2d(i,k)</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        dzbr(i)=dzbr(i)+h_2d(i,k)</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;        inject_layer(i,j) = min(inject_layer(i,j),real(k))</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160; </div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160; </div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;      <span class="keywordflow">if</span> ((g%mask2dT(i,j) &gt; 0.0) .and. salt(i) &gt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="comment">!   if (dzbr(i)&lt; brine_dz) call MOM_error(FATAL,&quot;insert_brine: failed&quot;)</span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        ks=inject_layer(i,j)</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        cdz=0.0</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        <span class="keywordflow">do</span> k=ks,nz</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;          mc = gv%H_to_kg_m2 * h_2d(i,k)</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;          scale = h_2d(i,k)/dzbr(i)</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;          cdz=cdz+h_2d(i,k)</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;          <span class="keywordflow">if</span> (cdz &gt; 1.0) <span class="keywordflow">exit</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;          tv%S(i,j,k) = tv%S(i,j,k) + scale*salt(i)/mc</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160; </div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160; </div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;  <span class="keywordflow">if</span> (cs%id_brine_lay &gt; 0) <span class="keyword">call </span>post_data(cs%id_brine_lay, inject_layer, cs%diag)</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160; </div>
</div><!-- fragment -->
</div>
</div>
<a id="aee7529221802ad2ebd682e05c3b54acf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aee7529221802ad2ebd682e05c3b54acf">&#9670;&nbsp;</a></span>make_frazil()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_diabatic_aux::make_frazil </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__diabatic__aux_1_1diabatic__aux__cs.html">diabatic_aux_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(in), optional&#160;</td>
          <td class="paramname"><em>p_surf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in), optional&#160;</td>
          <td class="paramname"><em>halo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Frazil formation keeps the temperature above the freezing point. This subroutine warms any water that is colder than the (currently surface) freezing point up to the freezing point and accumulates the required heat (in J m-2) in tvfrazil. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">tv</td><td>Structure containing pointers to any available thermodynamic fields. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>The control structure returned by a previous call to diabatic_aux_init. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">p_surf</td><td>The pressure at the ocean surface [Pa]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">halo</td><td>Halo width over which to calculate frazil </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00091">91</a> of file <a class="el" href="MOM__diabatic__aux_8F90_source.html">MOM_diabatic_aux.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">  !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment"> !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: h<span class="comment">  !&lt; Layer thicknesses [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),   <span class="keywordtype">intent(inout)</span> :: tv<span class="comment"> !&lt; Structure containing pointers to any available</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment">                                               !! thermodynamic fields.</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  <span class="keywordtype">type</span>(diabatic_aux_CS),   <span class="keywordtype">intent(in)</span>    :: CS<span class="comment"> !&lt; The control structure returned by a previous</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment">                                               !! call to diabatic_aux_init.</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>, &amp;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: p_surf<span class="comment"> !&lt; The pressure at the ocean surface [Pa].</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="keywordtype">integer</span>,       <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: halo<span class="comment"> !&lt; Halo width over which to calculate frazil</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160; </div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    fraz_col, &amp; <span class="comment">! The accumulated heat requirement due to frazil [J].</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    T_freeze, &amp; <span class="comment">! The freezing potential temperature at the current salinity [degC].</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    ps          <span class="comment">! pressure</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span> :: &amp;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    pressure    <span class="comment">! The pressure at the middle of each layer [Pa].</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="keywordtype">  real</span> :: hc    <span class="comment">! A layer&#39;s heat capacity [J m-2 degC-1].</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  <span class="keywordtype">logical</span> :: T_fr_set  <span class="comment">! True if the freezing point has been calculated for a</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                       <span class="comment">! row of points.</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, nz</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160; </div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(halo)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    is = g%isc-halo ; ie = g%iec+halo ; js = g%jsc-halo ; je = g%jec+halo</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160; </div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_frazil)</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160; </div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;  <span class="keywordflow">if</span> (.not.cs%pressure_dependent_frazil) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie ; pressure(i,k) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,CS,G,GV,h,nz,tv,p_surf) &amp;</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">!$OMP                           private(fraz_col,T_fr_set,T_freeze,hc,ps)  &amp;</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment">!$OMP                      firstprivate(pressure)    !pressure might be set above, so should be firstprivate</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  <span class="keywordflow">do</span> j=js,je</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    ps(:) = 0.0</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">PRESENT</span>(p_surf)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;      ps(i) = p_surf(i,j)</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160; </div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; fraz_col(i) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160; </div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <span class="keywordflow">if</span> (cs%pressure_dependent_frazil) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        pressure(i,1) = ps(i) + (0.5*gv%H_to_Pa)*h(i,j,1)</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;      <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        pressure(i,k) = pressure(i,k-1) + &amp;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;          (0.5*gv%H_to_Pa) * (h(i,j,k) + h(i,j,k-1))</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160; </div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keywordflow">if</span> (cs%reclaim_frazil) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;      t_fr_set = .false.</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (tv%frazil(i,j) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        <span class="keywordflow">if</span> (.not.t_fr_set) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;          <span class="keyword">call </span>calculate_tfreeze(tv%S(i:,j,1), pressure(i:,1), t_freeze(i:), &amp;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                                 1, ie-i+1, tv%eqn_of_state)</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;          t_fr_set = .true.</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160; </div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="keywordflow">if</span> (tv%T(i,j,1) &gt; t_freeze(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <span class="comment">! If frazil had previously been formed, but the surface temperature is now</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="comment">! above freezing, cool the surface layer with the frazil heat deficit.</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;          hc = (tv%C_p*gv%H_to_kg_m2) * h(i,j,1)</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;          <span class="keywordflow">if</span> (tv%frazil(i,j) - hc * (tv%T(i,j,1) - t_freeze(i)) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            tv%T(i,j,1) = tv%T(i,j,1) - tv%frazil(i,j)/hc</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            tv%frazil(i,j) = 0.0</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            tv%frazil(i,j) = tv%frazil(i,j) - hc * (tv%T(i,j,1) - t_freeze(i))</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;            tv%T(i,j,1) = t_freeze(i)</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160; </div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="keywordflow">do</span> k=nz,1,-1</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;      t_fr_set = .false.</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        <span class="keywordflow">if</span> ((g%mask2dT(i,j) &gt; 0.0) .and. &amp;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;            ((tv%T(i,j,k) &lt; 0.0) .or. (fraz_col(i) &gt; 0.0))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;          <span class="keywordflow">if</span> (.not.t_fr_set) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            <span class="keyword">call </span>calculate_tfreeze(tv%S(i:,j,k), pressure(i:,k), t_freeze(i:), &amp;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                                   1, ie-i+1, tv%eqn_of_state)</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;            t_fr_set = .true.</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160; </div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;          hc = (tv%C_p*gv%H_to_kg_m2) * h(i,j,k)</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;          <span class="keywordflow">if</span> (h(i,j,k) &lt;= 10.0*gv%Angstrom_H) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;            <span class="comment">! Very thin layers should not be cooled by the frazil flux.</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;            <span class="keywordflow">if</span> (tv%T(i,j,k) &lt; t_freeze(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;              fraz_col(i) = fraz_col(i) + hc * (t_freeze(i) - tv%T(i,j,k))</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;              tv%T(i,j,k) = t_freeze(i)</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;            <span class="keywordflow">if</span> (fraz_col(i) + hc * (t_freeze(i) - tv%T(i,j,k)) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;              tv%T(i,j,k) = tv%T(i,j,k) - fraz_col(i)/hc</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;              fraz_col(i) = 0.0</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;              fraz_col(i) = fraz_col(i) + hc * (t_freeze(i) - tv%T(i,j,k))</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;              tv%T(i,j,k) = t_freeze(i)</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;      tv%frazil(i,j) = tv%frazil(i,j) + fraz_col(i)</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_frazil)</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00081">id_clock_frazil</a>.</p>

</div>
</div>
<a id="acde4c76c9a489b82cba0bac5ec1b1198"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acde4c76c9a489b82cba0bac5ec1b1198">&#9670;&nbsp;</a></span>tridiagts()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_diabatic_aux::tridiagts </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>is</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>ie</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>js</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>je</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>hold</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>ea</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>eb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>T</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>S</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This is a simple tri-diagonal solver for T and S. "Simple" means it only uses arrays hold, ea and eb. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">is</td><td>The start i-index to work on. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ie</td><td>The end i-index to work on. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">js</td><td>The start j-index to work on. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">je</td><td>The end j-index to work on. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">hold</td><td>The layer thicknesses before entrainment, [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ea</td><td>The amount of fluid entrained from the layer above within this time step [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">eb</td><td>The amount of fluid entrained from the layer below within this time step [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">t</td><td>Layer potential temperatures [degC]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">s</td><td>Layer salinities [ppt]. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00494">494</a> of file <a class="el" href="MOM__diabatic__aux_8F90_source.html">MOM_diabatic_aux.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                    <span class="keywordtype">intent(in)</span>    :: G<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type),                  <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;  <span class="keywordtype">integer</span>,                                  <span class="keywordtype">intent(in)</span>    :: is<span class="comment">   !&lt; The start i-index to work on.</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;  <span class="keywordtype">integer</span>,                                  <span class="keywordtype">intent(in)</span>    :: ie<span class="comment">   !&lt; The end i-index to work on.</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;  <span class="keywordtype">integer</span>,                                  <span class="keywordtype">intent(in)</span>    :: js<span class="comment">   !&lt; The start j-index to work on.</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;  <span class="keywordtype">integer</span>,                                  <span class="keywordtype">intent(in)</span>    :: je<span class="comment">   !&lt; The end j-index to work on.</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: hold<span class="comment"> !&lt; The layer thicknesses before entrainment,</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="comment">                                                                  !! [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: ea<span class="comment"> !&lt; The amount of fluid entrained from the layer</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="comment">                                                 !! above within this time step [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: eb<span class="comment"> !&lt; The amount of fluid entrained from the layer</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="comment">                                                 !! below within this time step [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span> :: T<span class="comment">  !&lt; Layer potential temperatures [degC].</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span> :: S<span class="comment">  !&lt; Layer salinities [ppt].</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160; </div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="keywordtype">  real</span> :: b1(SZIB_(G)), d1(SZIB_(G)) <span class="comment">! b1, c1, and d1 are variables used by the</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="keywordtype">  real</span> :: c1(SZIB_(G),SZK_(G))       <span class="comment">! tridiagonal solver.</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="keywordtype">  real</span> :: h_tr, b_denom_1</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160; </div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;  <span class="comment">!$OMP parallel do default(shared) private(h_tr,b1,d1,c1,b_denom_1)</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;  <span class="keywordflow">do</span> j=js,je</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;      h_tr = hold(i,j,1) + gv%H_subroundoff</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;      b1(i) = 1.0 / (h_tr + eb(i,j,1))</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;      d1(i) = h_tr * b1(i)</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;      t(i,j,1) = (b1(i)*h_tr)*t(i,j,1)</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;      s(i,j,1) = (b1(i)*h_tr)*s(i,j,1)</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="keywordflow">do</span> k=2,g%ke ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;      c1(i,k) = eb(i,j,k-1) * b1(i)</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;      h_tr = hold(i,j,k) + gv%H_subroundoff</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;      b_denom_1 = h_tr + d1(i)*ea(i,j,k)</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;      b1(i) = 1.0 / (b_denom_1 + eb(i,j,k))</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;      d1(i) = b_denom_1 * b1(i)</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;      t(i,j,k) = b1(i) * (h_tr*t(i,j,k) + ea(i,j,k)*t(i,j,k-1))</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;      s(i,j,k) = b1(i) * (h_tr*s(i,j,k) + ea(i,j,k)*s(i,j,k-1))</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="keywordflow">do</span> k=g%ke-1,1,-1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;      t(i,j,k) = t(i,j,k) + c1(i,k+1)*t(i,j,k+1)</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;      s(i,j,k) = s(i,j,k) + c1(i,k+1)*s(i,j,k+1)</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="keywordflow">  enddo</span></div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a87671b375428f3a27c18c61d6a93d035"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a87671b375428f3a27c18c61d6a93d035">&#9670;&nbsp;</a></span>id_clock_frazil</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_diabatic_aux::id_clock_frazil</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>CPU time clock IDs. </p>

<p class="definition">Definition at line <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00081">81</a> of file <a class="el" href="MOM__diabatic__aux_8F90_source.html">MOM_diabatic_aux.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__diabatic__aux_8F90_source.html#l01303">diabatic_aux_init()</a>, and <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00091">make_frazil()</a>.</p>

</div>
</div>
<a id="a1fffddaa09c8650a74e045c2fe29e256"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1fffddaa09c8650a74e045c2fe29e256">&#9670;&nbsp;</a></span>id_clock_uv_at_h</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_diabatic_aux::id_clock_uv_at_h</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>CPU time clock IDs. </p>

<p class="definition">Definition at line <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00081">81</a> of file <a class="el" href="MOM__diabatic__aux_8F90_source.html">MOM_diabatic_aux.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="keywordtype">integer</span> :: id_clock_uv_at_h, id_clock_frazil</div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__diabatic__aux_8F90_source.html#l01303">diabatic_aux_init()</a>, and <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00543">find_uv_at_h()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__diabatic__aux.html">mom_diabatic_aux</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
