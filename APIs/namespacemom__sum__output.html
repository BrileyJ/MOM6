<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_sum_output Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('namespacemom__sum__output.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">mom_sum_output Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Reports integrated quantities for monitoring the model state. </p>
<p>By Robert Hallberg, April 1994 - June 2002</p>
<p>This file contains the subroutine (write_energy) that writes horizontally integrated quantities, such as energies and layer volumes, and other summary information to an output file. Some of these quantities (APE or resting interface height) are defined relative to the global histogram of topography. The subroutine that compiles that histogram (depth_list_setup) is also included in this file.</p>
<p>In addition, if the number of velocity truncations since the previous call to write_energy exceeds maxtrunc or the total energy exceeds a very large threshold, a fatal termination is triggered. </p>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__sum__output_1_1depth__list.html">depth_list</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">A list of depths and corresponding globally integrated ocean area at each depth and the ocean volume below each depth.  <a href="structmom__sum__output_1_1depth__list.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">The control structure for the MOM_sum_output module.  <a href="structmom__sum__output_1_1sum__output__cs.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a05003e74cbb39fbdf760d23617390445"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#a05003e74cbb39fbdf760d23617390445">mom_sum_output_init</a> (G, US, param_file, directory, ntrnc, Input_start_time, CS)</td></tr>
<tr class="memdesc:a05003e74cbb39fbdf760d23617390445"><td class="mdescLeft">&#160;</td><td class="mdescRight">MOM_sum_output_init initializes the parameters and settings for the MOM_sum_output module.  <a href="namespacemom__sum__output.html#a05003e74cbb39fbdf760d23617390445">More...</a><br /></td></tr>
<tr class="separator:a05003e74cbb39fbdf760d23617390445"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae54994f461b38198510274dadbce8fb5"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#ae54994f461b38198510274dadbce8fb5">mom_sum_output_end</a> (CS)</td></tr>
<tr class="memdesc:ae54994f461b38198510274dadbce8fb5"><td class="mdescLeft">&#160;</td><td class="mdescRight">MOM_sum_output_end deallocates memory used by the MOM_sum_output module.  <a href="namespacemom__sum__output.html#ae54994f461b38198510274dadbce8fb5">More...</a><br /></td></tr>
<tr class="separator:ae54994f461b38198510274dadbce8fb5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad3cc692dd515100ec8cf92d740c91e72"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#ad3cc692dd515100ec8cf92d740c91e72">write_energy</a> (u, v, h, tv, day, n, G, GV, US, CS, tracer_CSp, OBC, dt_forcing)</td></tr>
<tr class="memdesc:ad3cc692dd515100ec8cf92d740c91e72"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine calculates and writes the total model energy, the energy and mass of each layer, and other globally integrated physical quantities.  <a href="namespacemom__sum__output.html#ad3cc692dd515100ec8cf92d740c91e72">More...</a><br /></td></tr>
<tr class="separator:ad3cc692dd515100ec8cf92d740c91e72"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6f7111a0644a40651873dc291ee05217"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#a6f7111a0644a40651873dc291ee05217">accumulate_net_input</a> (fluxes, sfc_state, dt, G, CS)</td></tr>
<tr class="memdesc:a6f7111a0644a40651873dc291ee05217"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine accumates the net input of volume, salt and heat, through the ocean surface for use in diagnosing conservation.  <a href="namespacemom__sum__output.html#a6f7111a0644a40651873dc291ee05217">More...</a><br /></td></tr>
<tr class="separator:a6f7111a0644a40651873dc291ee05217"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a53d3dcd50cba41760dd8713228785a8d"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#a53d3dcd50cba41760dd8713228785a8d">depth_list_setup</a> (G, US, CS)</td></tr>
<tr class="memdesc:a53d3dcd50cba41760dd8713228785a8d"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine sets up an ordered list of depths, along with the cross sectional areas at each depth and the volume of fluid deeper than each depth. This might be read from a previously created file or it might be created anew. (For now only new creation occurs.  <a href="namespacemom__sum__output.html#a53d3dcd50cba41760dd8713228785a8d">More...</a><br /></td></tr>
<tr class="separator:a53d3dcd50cba41760dd8713228785a8d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1db5001777c2171a7f3f16122b4bacd1"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#a1db5001777c2171a7f3f16122b4bacd1">create_depth_list</a> (G, CS)</td></tr>
<tr class="memdesc:a1db5001777c2171a7f3f16122b4bacd1"><td class="mdescLeft">&#160;</td><td class="mdescRight">create_depth_list makes an ordered list of depths, along with the cross sectional areas at each depth and the volume of fluid deeper than each depth.  <a href="namespacemom__sum__output.html#a1db5001777c2171a7f3f16122b4bacd1">More...</a><br /></td></tr>
<tr class="separator:a1db5001777c2171a7f3f16122b4bacd1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a955e777980a668bfc611c78de5de1895"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#a955e777980a668bfc611c78de5de1895">write_depth_list</a> (G, US, CS, filename, list_size)</td></tr>
<tr class="memdesc:a955e777980a668bfc611c78de5de1895"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine writes out the depth list to the specified file.  <a href="namespacemom__sum__output.html#a955e777980a668bfc611c78de5de1895">More...</a><br /></td></tr>
<tr class="separator:a955e777980a668bfc611c78de5de1895"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4f45b1c7dbff4fe064e102ccb2967daf"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#a4f45b1c7dbff4fe064e102ccb2967daf">read_depth_list</a> (G, US, CS, filename)</td></tr>
<tr class="memdesc:a4f45b1c7dbff4fe064e102ccb2967daf"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine reads in the depth list to the specified file and allocates and sets up CSDL and CSlist_size .  <a href="namespacemom__sum__output.html#a4f45b1c7dbff4fe064e102ccb2967daf">More...</a><br /></td></tr>
<tr class="separator:a4f45b1c7dbff4fe064e102ccb2967daf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a928dd1160bb6c0033a417c618b9d01ef"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#a928dd1160bb6c0033a417c618b9d01ef">get_depth_list_checksums</a> (G, depth_chksum, area_chksum)</td></tr>
<tr class="memdesc:a928dd1160bb6c0033a417c618b9d01ef"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return the checksums required to verify DEPTH_LIST_FILE contents.  <a href="namespacemom__sum__output.html#a928dd1160bb6c0033a417c618b9d01ef">More...</a><br /></td></tr>
<tr class="separator:a928dd1160bb6c0033a417c618b9d01ef"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a5191c3198dcd24f50da9279ce7ebbc60"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#a5191c3198dcd24f50da9279ce7ebbc60">num_fields</a> = 17</td></tr>
<tr class="memdesc:a5191c3198dcd24f50da9279ce7ebbc60"><td class="mdescLeft">&#160;</td><td class="mdescRight">Number of diagnostic fields.  <a href="namespacemom__sum__output.html#a5191c3198dcd24f50da9279ce7ebbc60">More...</a><br /></td></tr>
<tr class="separator:a5191c3198dcd24f50da9279ce7ebbc60"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4502602fe6c41088fc5a7f658070b386"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(*), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#a4502602fe6c41088fc5a7f658070b386">depth_chksum_attr</a> = &quot;bathyT_checksum&quot;</td></tr>
<tr class="memdesc:a4502602fe6c41088fc5a7f658070b386"><td class="mdescLeft">&#160;</td><td class="mdescRight">Checksum attribute name of GbathyT over the compute domain.  <a href="namespacemom__sum__output.html#a4502602fe6c41088fc5a7f658070b386">More...</a><br /></td></tr>
<tr class="separator:a4502602fe6c41088fc5a7f658070b386"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af8db0fa8cff32727c5f23cc328b67a7c"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(*), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#af8db0fa8cff32727c5f23cc328b67a7c">area_chksum_attr</a> = &quot;mask2dT_areaT_checksum&quot;</td></tr>
<tr class="memdesc:af8db0fa8cff32727c5f23cc328b67a7c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Checksum attribute of name of Gmask2dT * GareaT over the compute domain.  <a href="namespacemom__sum__output.html#af8db0fa8cff32727c5f23cc328b67a7c">More...</a><br /></td></tr>
<tr class="separator:af8db0fa8cff32727c5f23cc328b67a7c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a6f7111a0644a40651873dc291ee05217"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6f7111a0644a40651873dc291ee05217">&#9670;&nbsp;</a></span>accumulate_net_input()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_sum_output::accumulate_net_input </td>
          <td>(</td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(surface), intent(in)&#160;</td>
          <td class="paramname"><em>sfc_state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine accumates the net input of volume, salt and heat, through the ocean surface for use in diagnosing conservation. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">fluxes</td><td>A structure containing pointers to any possible forcing fields. Unused fields are unallocated. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">sfc_state</td><td>A structure containing fields that describe the surface state of the ocean. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>The amount of time over which to average [s]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to MOM_sum_output_init. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l00940">940</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;  <span class="keywordtype">type</span>(forcing),         <span class="keywordtype">intent(in)</span> :: fluxes<span class="comment"> !&lt; A structure containing pointers to any possible</span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="comment">                                              !! forcing fields.  Unused fields are unallocated.</span></div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;  <span class="keywordtype">type</span>(surface),         <span class="keywordtype">intent(in)</span> :: sfc_state<span class="comment"> !&lt; A structure containing fields that</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;<span class="comment">                                              !! describe the surface state of the ocean.</span></div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span> :: dt<span class="comment">     !&lt; The amount of time over which to average [s].</span></div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(in)</span> :: G<span class="comment">      !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;  <span class="keywordtype">type</span>(Sum_output_CS),   <span class="keywordtype">pointer</span>    :: CS<span class="comment">     !&lt; The control structure returned by a previous call</span></div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;<span class="comment">                                              !! to MOM_sum_output_init.</span></div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: &amp;</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;    FW_in, &amp;   <span class="comment">! The net fresh water input, integrated over a timestep [kg].</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    salt_in, &amp; <span class="comment">! The total salt added by surface fluxes, integrated</span></div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;               <span class="comment">! over a time step [ppt kg].</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;    heat_in    <span class="comment">! The total heat added by surface fluxes, integrated</span></div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;               <span class="comment">! over a time step [J].</span></div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;<span class="keywordtype">  real</span> :: FW_input   <span class="comment">! The net fresh water input, integrated over a timestep</span></div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;                     <span class="comment">! and summed over space [kg].</span></div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;<span class="keywordtype">  real</span> :: salt_input <span class="comment">! The total salt added by surface fluxes, integrated</span></div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;                     <span class="comment">! over a time step and summed over space [ppt kg].</span></div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;<span class="keywordtype">  real</span> :: heat_input <span class="comment">! The total heat added by boundary fluxes, integrated</span></div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;                     <span class="comment">! over a time step and summed over space [J].</span></div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;<span class="keywordtype">  real</span> :: C_p        <span class="comment">! The heat capacity of seawater [J degC-1 kg-1].</span></div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160; </div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;  <span class="keywordtype">type</span>(EFP_type) :: &amp;</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    FW_in_EFP,   &amp; <span class="comment">! Extended fixed point version of FW_input [kg]</span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    salt_in_EFP, &amp; <span class="comment">! Extended fixed point version of salt_input [ppt kg]</span></div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    heat_in_EFP    <span class="comment">! Extended fixed point version of heat_input [J]</span></div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160; </div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;<span class="keywordtype">  real</span> :: inputs(3)   <span class="comment">! A mixed array for combining the sums</span></div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160; </div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;  c_p = fluxes%C_p</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160; </div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;  fw_in(:,:) = 0.0 ; fw_input = 0.0</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%evap)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%lprec) .and. <span class="keyword">associated</span>(fluxes%fprec)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;        fw_in(i,j) = dt*g%US%L_to_m**2*g%areaT(i,j)*(fluxes%evap(i,j) + &amp;</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;            (((fluxes%lprec(i,j) + fluxes%vprec(i,j)) + fluxes%lrunoff(i,j)) + &amp;</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;              (fluxes%fprec(i,j) + fluxes%frunoff(i,j))))</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;      <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;        <span class="stringliteral">&quot;accumulate_net_input called with associated evap field, but no precip field.&quot;</span>)</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160; </div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%seaice_melt)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;    fw_in(i,j) = fw_in(i,j) + dt * g%US%L_to_m**2*g%areaT(i,j) * fluxes%seaice_melt(i,j)</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160; </div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;  salt_in(:,:) = 0.0 ; heat_in(:,:) = 0.0</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160; </div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%sw)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;      heat_in(i,j) = heat_in(i,j) + dt*g%US%L_to_m**2*g%areaT(i,j) * (fluxes%sw(i,j) + &amp;</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;             (fluxes%lw(i,j) + (fluxes%latent(i,j) + fluxes%sens(i,j))))</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160; </div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%seaice_melt_heat)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;       heat_in(i,j) = heat_in(i,j) + dt*g%US%L_to_m**2*g%areaT(i,j) * fluxes%seaice_melt_heat(i,j)</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160; </div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    <span class="comment">! smg: new code</span></div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    <span class="comment">! include heat content from water transport across ocean surface</span></div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;<span class="comment">!    if (associated(fluxes%heat_content_lprec)) then ; do j=js,je ; do i=is,ie</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;<span class="comment">!      heat_in(i,j) = heat_in(i,j) + dt*G%US%L_to_m**2*G%areaT(i,j) *                          &amp;</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;<span class="comment">!         (fluxes%heat_content_lprec(i,j)   + (fluxes%heat_content_fprec(i,j)   &amp;</span></div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;<span class="comment">!       + (fluxes%heat_content_lrunoff(i,j) + (fluxes%heat_content_frunoff(i,j) &amp;</span></div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;<span class="comment">!       + (fluxes%heat_content_cond(i,j)    + (fluxes%heat_content_vprec(i,j)   &amp;</span></div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;<span class="comment">!       +  fluxes%heat_content_massout(i,j)))))))</span></div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;<span class="comment">!    enddo ; enddo ; endif</span></div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160; </div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    <span class="comment">! smg: old code</span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(sfc_state%TempxPmE)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;        heat_in(i,j) = heat_in(i,j) + (c_p * g%US%L_to_m**2*g%areaT(i,j)) * sfc_state%TempxPmE(i,j)</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;    <span class="keywordflow">elseif</span> (<span class="keyword">associated</span>(fluxes%evap)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        heat_in(i,j) = heat_in(i,j) + (c_p * sfc_state%SST(i,j)) * fw_in(i,j)</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160; </div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160; </div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;    <span class="comment">! The following heat sources may or may not be used.</span></div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(sfc_state%internal_heat)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;        heat_in(i,j) = heat_in(i,j) + (c_p * g%US%L_to_m**2*g%areaT(i,j)) * &amp;</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;                     sfc_state%internal_heat(i,j)</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(sfc_state%frazil)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;      heat_in(i,j) = heat_in(i,j) + g%US%L_to_m**2*g%areaT(i,j) * sfc_state%frazil(i,j)</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%heat_added)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;      heat_in(i,j) = heat_in(i,j) + dt*g%US%L_to_m**2*g%areaT(i,j)*fluxes%heat_added(i,j)</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="comment">!    if (associated(sfc_state%sw_lost)) then ; do j=js,je ; do i=is,ie</span></div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;<span class="comment">!      heat_in(i,j) = heat_in(i,j) - G%US%L_to_m**2*G%areaT(i,j) * sfc_state%sw_lost(i,j)</span></div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="comment">!    enddo ; enddo ; endif</span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160; </div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%salt_flux)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;      <span class="comment">! convert salt_flux from kg (salt)/(m^2 s) to ppt * [m s-1].</span></div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;      salt_in(i,j) = dt*g%US%L_to_m**2*g%areaT(i,j)*(1000.0*fluxes%salt_flux(i,j))</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160; </div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;  <span class="keywordflow">if</span> ((cs%use_temperature) .or. <span class="keyword">associated</span>(fluxes%lprec) .or. &amp;</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;      <span class="keyword">associated</span>(fluxes%evap)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;    fw_input   = <a class="code" href="interfacemom__coms_1_1reproducing__sum.html">reproducing_sum</a>(fw_in,   efp_sum=fw_in_efp)</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    heat_input = <a class="code" href="interfacemom__coms_1_1reproducing__sum.html">reproducing_sum</a>(heat_in, efp_sum=heat_in_efp)</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    salt_input = <a class="code" href="interfacemom__coms_1_1reproducing__sum.html">reproducing_sum</a>(salt_in, efp_sum=salt_in_efp)</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160; </div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    cs%fresh_water_input = cs%fresh_water_input + fw_input</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;    cs%net_salt_input    = cs%net_salt_input    + salt_input</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    cs%net_heat_input    = cs%net_heat_input    + heat_input</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160; </div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;    cs%fresh_water_in_EFP = cs%fresh_water_in_EFP + fw_in_efp</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;    cs%net_salt_in_EFP    = cs%net_salt_in_EFP    + salt_in_efp</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    cs%net_heat_in_EFP    = cs%net_heat_in_EFP    + heat_in_efp</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a6f7111a0644a40651873dc291ee05217_cgraph.svg" width="620" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a1db5001777c2171a7f3f16122b4bacd1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1db5001777c2171a7f3f16122b4bacd1">&#9670;&nbsp;</a></span>create_depth_list()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_sum_output::create_depth_list </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>create_depth_list makes an ordered list of depths, along with the cross sectional areas at each depth and the volume of fluid deeper than each depth. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure set up in MOM_sum_output_init, in which the ordered depth list is stored. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l01101">1101</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(in)</span> :: G<span class="comment">  !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;  <span class="keywordtype">type</span>(Sum_output_CS),   <span class="keywordtype">pointer</span>    :: CS<span class="comment"> !&lt; The control structure set up in MOM_sum_output_init,</span></div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;<span class="comment">                                          !! in which the ordered depth list is stored.</span></div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(G%Domain%niglobal*G%Domain%njglobal + 1)</span> :: &amp;</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;    Dlist, &amp;  !&lt; The global list of bottom depths [Z ~&gt; m].</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;    AreaList<span class="comment">  !&lt; The global list of cell areas [m2].</span></div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(G%Domain%niglobal*G%Domain%njglobal+1)</span> :: &amp;</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;    indx2<span class="comment">     !&lt; The position of an element in the original unsorted list.</span></div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;<span class="keywordtype">  real</span>    :: Dnow<span class="comment">  !&lt; The depth now being considered for sorting [Z ~&gt; m].</span></div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;<span class="keywordtype">  real</span>    :: Dprev<span class="comment"> !&lt; The most recent depth that was considered [Z ~&gt; m].</span></div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;<span class="keywordtype">  real</span>    :: vol<span class="comment">   !&lt; The running sum of open volume below a deptn [Z m2 ~&gt; m3].</span></div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;<span class="keywordtype">  real</span>    :: area<span class="comment">  !&lt; The open area at the current depth [m2].</span></div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;<span class="keywordtype">  real</span>    :: D_list_prev<span class="comment"> !&lt; The most recent depth added to the list [Z ~&gt; m].</span></div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;  <span class="keywordtype">logical</span> :: add_to_list<span class="comment"> !&lt; This depth should be included as an entry on the list.</span></div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160; </div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;  <span class="keywordtype">integer</span> :: ir, indxt</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;  <span class="keywordtype">integer</span> :: mls, list_size</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;  <span class="keywordtype">integer</span> :: list_pos, i_global, j_global</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, kl</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160; </div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;  mls = g%Domain%niglobal*g%Domain%njglobal</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160; </div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;<span class="comment">! Need to collect the global data from compute domains to a 1D array for sorting.</span></div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;  dlist(:) = 0.0</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;  arealist(:) = 0.0</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;  <span class="keywordflow">do</span> j=g%jsc,g%jec ; <span class="keywordflow">do</span> i=g%isc,g%iec</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    <span class="comment">! Set global indices that start the global domain at 1 (Fortran convention).</span></div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    j_global = j + g%jdg_offset - (g%jsg-1)</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;    i_global = i + g%idg_offset - (g%isg-1)</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160; </div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    list_pos = (j_global-1)*g%Domain%niglobal + i_global</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;    dlist(list_pos) = g%bathyT(i,j)</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    arealist(list_pos) = g%mask2dT(i,j) * g%US%L_to_m**2*g%areaT(i,j)</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160; </div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;  <span class="comment">! These sums reproduce across PEs because the arrays are only nonzero on one PE.</span></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;  <span class="keyword">call </span>sum_across_pes(dlist, mls+1)</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;  <span class="keyword">call </span>sum_across_pes(arealist, mls+1)</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160; </div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;  <span class="keywordflow">do</span> j=1,mls+1 ; indx2(j) = j ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;  k = mls / 2  + 1 ; ir = mls</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;  <span class="keywordflow">do</span></div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;    <span class="keywordflow">if</span> (k &gt; 1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;      k = k - 1</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;      indxt = indx2(k)</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;      dnow = dlist(indxt)</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;      indxt = indx2(ir)</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;      dnow = dlist(indxt)</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;      indx2(ir) = indx2(1)</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;      ir = ir - 1</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;      <span class="keywordflow">if</span> (ir == 1) <span class="keywordflow">then</span> ; indx2(1) = indxt ; <span class="keywordflow">exit</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;    i=k ; j=k*2</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;    <span class="keywordflow">do</span> ; <span class="keywordflow">if</span> (j &gt; ir) <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;      <span class="keywordflow">if</span> (j &lt; ir .AND. dlist(indx2(j)) &lt; dlist(indx2(j+1))) j = j + 1</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;      <span class="keywordflow">if</span> (dnow &lt; dlist(indx2(j))) <span class="keywordflow">then</span> ; indx2(i) = indx2(j) ; i = j ; j = j + i</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;      <span class="keywordflow">else</span> ; j = ir+1 ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;    indx2(i) = indxt</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160; </div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;<span class="comment">!  At this point, the lists should perhaps be culled to save memory.</span></div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;<span class="comment">! Culling: (1) identical depths (e.g. land) - take the last one.</span></div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;<span class="comment">!          (2) the topmost and bottommost depths are always saved.</span></div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;<span class="comment">!          (3) very close depths</span></div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;<span class="comment">!          (4) equal volume changes.</span></div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160; </div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;  <span class="comment">! Count the unique elements in the list.</span></div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;  d_list_prev = dlist(indx2(mls))</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;  list_size = 2</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;  <span class="keywordflow">do</span> k=mls-1,1,-1</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;    <span class="keywordflow">if</span> (dlist(indx2(k)) &lt; d_list_prev-cs%D_list_min_inc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;      list_size = list_size + 1</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;      d_list_prev = dlist(indx2(k))</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160; </div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;  cs%list_size = list_size</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;  <span class="keyword">allocate</span>(cs%DL(cs%list_size+1))</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160; </div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;  vol = 0.0 ; area = 0.0</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;  dprev = dlist(indx2(mls))</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;  d_list_prev = dprev</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160; </div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;  kl = 0</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;  <span class="keywordflow">do</span> k=mls,1,-1</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    i = indx2(k)</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;    vol = vol + area * (dprev - dlist(i))</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;    area = area + arealist(i)</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160; </div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;    add_to_list = .false.</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;    <span class="keywordflow">if</span> ((kl == 0) .or. (k==1)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;      add_to_list = .true.</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    <span class="keywordflow">elseif</span> (dlist(indx2(k-1)) &lt; d_list_prev-cs%D_list_min_inc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;      add_to_list = .true.</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;      d_list_prev = dlist(indx2(k-1))</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160; </div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;    <span class="keywordflow">if</span> (add_to_list) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;      kl = kl+1</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;      cs%DL(kl)%depth = dlist(i)</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;      cs%DL(kl)%area = area</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;      cs%DL(kl)%vol_below = vol</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;    dprev = dlist(i)</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160; </div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;  <span class="keywordflow">do</span> <span class="keywordflow">while</span> (kl &lt; list_size)</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;    <span class="comment">! I don&#39;t understand why this is needed... RWH</span></div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;    kl = kl+1</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;    cs%DL(kl)%vol_below = cs%DL(kl-1)%vol_below * 1.000001</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;    cs%DL(kl)%area = cs%DL(kl-1)%area</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;    cs%DL(kl)%depth = cs%DL(kl-1)%depth</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160; </div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;  cs%DL(cs%list_size+1)%vol_below = cs%DL(cs%list_size)%vol_below * 1000.0</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;  cs%DL(cs%list_size+1)%area = cs%DL(cs%list_size)%area</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;  cs%DL(cs%list_size+1)%depth = cs%DL(cs%list_size)%depth</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__sum__output_8F90_source.html#l01071">depth_list_setup()</a>, and <a class="el" href="MOM__sum__output_8F90_source.html#l01321">read_depth_list()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a1db5001777c2171a7f3f16122b4bacd1_icgraph.svg" width="100%" height="361"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a53d3dcd50cba41760dd8713228785a8d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a53d3dcd50cba41760dd8713228785a8d">&#9670;&nbsp;</a></span>depth_list_setup()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_sum_output::depth_list_setup </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine sets up an ordered list of depths, along with the cross sectional areas at each depth and the volume of fluid deeper than each depth. This might be read from a previously created file or it might be created anew. (For now only new creation occurs. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to MOM_sum_output_init. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l01071">1071</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(in)</span> :: G<span class="comment">   !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type), <span class="keywordtype">intent(in)</span> :: US<span class="comment">  !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;  <span class="keywordtype">type</span>(Sum_output_CS),   <span class="keywordtype">pointer</span>    :: CS<span class="comment">  !&lt; The control structure returned by a</span></div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;<span class="comment">                                           !! previous call to MOM_sum_output_init.</span></div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;  <span class="keywordtype">integer</span> :: k</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160; </div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;  <span class="keywordflow">if</span> (cs%read_depth_list) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;    <span class="keywordflow">if</span> (file_exists(cs%depth_list_file)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;      <span class="keyword">call </span>read_depth_list(g, us, cs, cs%depth_list_file)</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;      <span class="keywordflow">if</span> (is_root_pe()) <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;depth_list_setup: &quot;</span>// &amp;</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;        trim(cs%depth_list_file)//<span class="stringliteral">&quot; does not exist.  Creating a new file.&quot;</span>)</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;      <span class="keyword">call </span>create_depth_list(g, cs)</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160; </div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;      <span class="keyword">call </span>write_depth_list(g, us, cs, cs%depth_list_file, cs%list_size+1)</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;    <span class="keyword">call </span>create_depth_list(g, cs)</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160; </div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;  <span class="keywordflow">do</span> k=1,g%ke</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    cs%lH(k) = cs%list_size</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__sum__output_8F90_source.html#l01101">create_depth_list()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00044">mom_error_handler::is_root_pe()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__sum__output_8F90_source.html#l01321">read_depth_list()</a>, and <a class="el" href="MOM__sum__output_8F90_source.html#l01226">write_depth_list()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__sum__output_8F90_source.html#l00142">mom_sum_output_init()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a53d3dcd50cba41760dd8713228785a8d_cgraph.svg" width="100%" height="496"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a53d3dcd50cba41760dd8713228785a8d_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a928dd1160bb6c0033a417c618b9d01ef"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a928dd1160bb6c0033a417c618b9d01ef">&#9670;&nbsp;</a></span>get_depth_list_checksums()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_sum_output::get_depth_list_checksums </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=16), intent(out)&#160;</td>
          <td class="paramname"><em>depth_chksum</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=16), intent(out)&#160;</td>
          <td class="paramname"><em>area_chksum</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Return the checksums required to verify DEPTH_LIST_FILE contents. </p>
<p>This function computes checksums for the bathymetry (GbathyT) and masked area (mask2dT * areaT) fields of the model grid G, which are used to compute the depth list. A difference in checksum indicates that a different method was used to compute the grid data, and that any results using the depth list, such as APE, will not be reproducible.</p>
<p>Checksums are saved as hexadecimal strings, in order to avoid potential datatype issues with netCDF attributes. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid structure </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">depth_chksum</td><td>Depth checksum hexstring </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">area_chksum</td><td>Area checksum hexstring </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l01477">1477</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(in)</span> :: G<span class="comment">          !&lt; Ocean grid structure</span></div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;  <span class="keywordtype">character(len=16)</span>, <span class="keywordtype">intent(out)</span> :: depth_chksum<span class="comment">  !&lt; Depth checksum hexstring</span></div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;  <span class="keywordtype">character(len=16)</span>, <span class="keywordtype">intent(out)</span> :: area_chksum<span class="comment">   !&lt; Area checksum hexstring</span></div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160; </div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;  <span class="keywordtype">integer</span> :: i, j</div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">allocatable</span> :: field(:,:)</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160; </div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;  <span class="keyword">allocate</span>(field(g%isc:g%iec, g%jsc:g%jec))</div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160; </div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;  <span class="comment">! Depth checksum</span></div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;  <span class="keywordflow">do</span> j=g%jsc,g%jec ; <span class="keywordflow">do</span> i=g%isc,g%iec</div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;    field(i,j) = g%bathyT(i,j)</div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;  <span class="keyword">write</span>(depth_chksum, <span class="stringliteral">&#39;(Z16)&#39;</span>) mpp_chksum(field(:,:))</div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160; </div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;  <span class="comment">! Area checksum</span></div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;  <span class="keywordflow">do</span> j=g%jsc,g%jec ; <span class="keywordflow">do</span> i=g%isc,g%iec</div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;    field(i,j) = g%mask2dT(i,j) * g%US%L_to_m**2*g%areaT(i,j)</div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;  <span class="keyword">write</span>(area_chksum, <span class="stringliteral">&#39;(Z16)&#39;</span>) mpp_chksum(field(:,:))</div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160; </div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;  <span class="keyword">deallocate</span>(field)</div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__sum__output_8F90_source.html#l01321">read_depth_list()</a>, and <a class="el" href="MOM__sum__output_8F90_source.html#l01226">write_depth_list()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a928dd1160bb6c0033a417c618b9d01ef_icgraph.svg" width="100%" height="383"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="ae54994f461b38198510274dadbce8fb5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae54994f461b38198510274dadbce8fb5">&#9670;&nbsp;</a></span>mom_sum_output_end()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_sum_output::mom_sum_output_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>MOM_sum_output_end deallocates memory used by the MOM_sum_output module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">cs</td><td>The control structure returned by a previous call to MOM_sum_output_init. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l00290">290</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;  <span class="keywordtype">type</span>(Sum_output_CS), <span class="keywordtype">pointer</span> :: CS<span class="comment">  !&lt; The control structure returned by a</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment">                                      !! previous call to MOM_sum_output_init.</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    <span class="keywordflow">if</span> (cs%do_APE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;      <span class="keyword">deallocate</span>(cs%lH, cs%DL)</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160; </div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <span class="keyword">deallocate</span>(cs)</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="keywordflow">  endif</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="a05003e74cbb39fbdf760d23617390445"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a05003e74cbb39fbdf760d23617390445">&#9670;&nbsp;</a></span>mom_sum_output_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_sum_output::mom_sum_output_init </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=*), intent(in)&#160;</td>
          <td class="paramname"><em>directory</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(inout), target&#160;</td>
          <td class="paramname"><em>ntrnc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Input_start_time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>MOM_sum_output_init initializes the parameters and settings for the MOM_sum_output module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>A structure to parse for run-time parameters. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">directory</td><td>The directory where the energy file goes. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ntrnc</td><td>The integer that stores the number of times the velocity has been truncated since the last call to write_energy. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">input_start_time</td><td>The start time of the simulation. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>A pointer that is set to point to the control structure for this module. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l00142">142</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),  <span class="keywordtype">intent(in)</span>    :: G<span class="comment">          !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),  <span class="keywordtype">intent(in)</span>    :: US<span class="comment">         !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  <span class="keywordtype">type</span>(param_file_type),  <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; A structure to parse for run-time</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment">                                                      !! parameters.</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  <span class="keywordtype">character(len=*)</span>,       <span class="keywordtype">intent(in)</span>    :: directory<span class="comment">  !&lt; The directory where the energy file goes.</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">target</span>,        <span class="keywordtype">intent(inout)</span> :: ntrnc<span class="comment">      !&lt; The integer that stores the number of times</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">                                                      !! the velocity has been truncated since the</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment">                                                      !! last call to write_energy.</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  <span class="keywordtype">type</span>(time_type),        <span class="keywordtype">intent(in)</span>    :: Input_start_time<span class="comment"> !&lt; The start time of the simulation.</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  <span class="keywordtype">type</span>(Sum_output_CS),    <span class="keywordtype">pointer</span>       :: CS<span class="comment">         !&lt; A pointer that is set to point to the</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">                                                      !! control structure for this module.</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="keywordtype">  real</span> :: Time_unit <span class="comment">! The time unit in seconds for ENERGYSAVEDAYS.</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="keywordtype">  real</span> :: Rho_0     <span class="comment">! A reference density [kg m-3]</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="keywordtype">  real</span> :: maxvel    <span class="comment">! The maximum permitted velocity [m s-1]</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_sum_output&quot;</span> <span class="comment">! This module&#39;s name.</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;  <span class="keywordtype">character(len=200)</span> :: energyfile  <span class="comment">! The name of the energy file.</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  <span class="keywordtype">character(len=32)</span> :: filename_appendix = <span class="stringliteral">&#39;&#39;</span> <span class="comment">!fms appendix to filename for ensemble runs</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160; </div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;MOM_sum_output_init called with associated control structure.&quot;</span>)</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <span class="keywordflow">return</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="keyword">allocate</span>(cs)</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160; </div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  <span class="comment">! Read all relevant parameters and write them to the model log.</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, <span class="stringliteral">&quot;&quot;</span>)</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;CALCULATE_APE&quot;</span>, cs%do_APE_calc, &amp;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;                 <span class="stringliteral">&quot;If true, calculate the available potential energy of &quot;</span>//&amp;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                 <span class="stringliteral">&quot;the interfaces.  Setting this to false reduces the &quot;</span>//&amp;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                 <span class="stringliteral">&quot;memory footprint of high-PE-count models dramatically.&quot;</span>, &amp;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                 default=.true.)</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;WRITE_STOCKS&quot;</span>, cs%write_stocks, &amp;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                 <span class="stringliteral">&quot;If true, write the integrated tracer amounts to stdout &quot;</span>//&amp;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                 <span class="stringliteral">&quot;when the energy files are written.&quot;</span>, default=.true.)</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ENABLE_THERMODYNAMICS&quot;</span>, cs%use_temperature, &amp;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                 <span class="stringliteral">&quot;If true, Temperature and salinity are used as state &quot;</span>//&amp;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;                 <span class="stringliteral">&quot;variables.&quot;</span>, default=.true.)</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DT&quot;</span>, cs%dt, &amp;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                 <span class="stringliteral">&quot;The (baroclinic) dynamics time step.&quot;</span>, units=<span class="stringliteral">&quot;s&quot;</span>, &amp;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                 fail_if_missing=.true.)</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MAXTRUNC&quot;</span>, cs%maxtrunc, &amp;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                 <span class="stringliteral">&quot;The run will be stopped, and the day set to a very &quot;</span>//&amp;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                 <span class="stringliteral">&quot;large value if the velocity is truncated more than &quot;</span>//&amp;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                 <span class="stringliteral">&quot;MAXTRUNC times between energy saves.  Set MAXTRUNC to 0 &quot;</span>//&amp;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                 <span class="stringliteral">&quot;to stop if there is any truncation of velocities.&quot;</span>, &amp;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                 units=<span class="stringliteral">&quot;truncations save_interval-1&quot;</span>, default=0)</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160; </div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MAX_ENERGY&quot;</span>, cs%max_Energy, &amp;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                 <span class="stringliteral">&quot;The maximum permitted average energy per unit mass; the &quot;</span>//&amp;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;                 <span class="stringliteral">&quot;model will be stopped if there is more energy than &quot;</span>//&amp;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                 <span class="stringliteral">&quot;this.  If zero or negative, this is set to 10*MAXVEL^2.&quot;</span>, &amp;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-2&quot;</span>, default=0.0)</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  <span class="keywordflow">if</span> (cs%max_Energy &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MAXVEL&quot;</span>, maxvel, &amp;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                 <span class="stringliteral">&quot;The maximum velocity allowed before the velocity &quot;</span>//&amp;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                 <span class="stringliteral">&quot;components are truncated.&quot;</span>, units=<span class="stringliteral">&quot;m s-1&quot;</span>, default=3.0e8)</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    cs%max_Energy = 10.0 * maxvel**2</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;MAX_ENERGY as used&quot;</span>, cs%max_Energy)</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160; </div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ENERGYFILE&quot;</span>, energyfile, &amp;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;                 <span class="stringliteral">&quot;The file to use to write the energies and globally &quot;</span>//&amp;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                 <span class="stringliteral">&quot;summed diagnostics.&quot;</span>, default=<span class="stringliteral">&quot;ocean.stats&quot;</span>)</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160; </div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  <span class="comment">!query fms_io if there is a filename_appendix (for ensemble runs)</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;  <span class="keyword">call </span>get_filename_appendix(filename_appendix)</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;  <span class="keywordflow">if</span> (len_trim(filename_appendix) &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;     energyfile = trim(energyfile) //<span class="stringliteral">&#39;.&#39;</span>//trim(filename_appendix)</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160; </div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;  cs%energyfile = trim(slasher(directory))//trim(energyfile)</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;output_path/ENERGYFILE&quot;</span>, cs%energyfile)</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="preprocessor">#ifdef STATSLABEL</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="preprocessor"></span>  cs%energyfile = trim(cs%energyfile)//<span class="stringliteral">&quot;.&quot;</span>//trim(adjustl(statslabel))</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DATE_STAMPED_STDOUT&quot;</span>, cs%date_stamped_output, &amp;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                 <span class="stringliteral">&quot;If true, use dates (not times) in messages to stdout&quot;</span>, &amp;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                 default=.true.)</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TIMEUNIT&quot;</span>, cs%Timeunit, &amp;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;                 <span class="stringliteral">&quot;The time unit in seconds a number of input fields&quot;</span>, &amp;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                 units=<span class="stringliteral">&quot;s&quot;</span>, default=86400.0)</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;  <span class="keywordflow">if</span> (cs%Timeunit &lt; 0.0) cs%Timeunit = 86400.0</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160; </div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160; </div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160; </div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;  <span class="keywordflow">if</span> (cs%do_APE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;READ_DEPTH_LIST&quot;</span>, cs%read_depth_list, &amp;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                   <span class="stringliteral">&quot;Read the depth list from a file if it exists or &quot;</span>//&amp;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                   <span class="stringliteral">&quot;create that file otherwise.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DEPTH_LIST_MIN_INC&quot;</span>, cs%D_list_min_inc, &amp;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                   <span class="stringliteral">&quot;The minimum increment between the depths of the &quot;</span>//&amp;</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                   <span class="stringliteral">&quot;entries in the depth-list file.&quot;</span>, &amp;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                   units=<span class="stringliteral">&quot;m&quot;</span>, default=1.0e-10, scale=us%m_to_Z)</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="keywordflow">if</span> (cs%read_depth_list) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DEPTH_LIST_FILE&quot;</span>, cs%depth_list_file, &amp;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                   <span class="stringliteral">&quot;The name of the depth list file.&quot;</span>, default=<span class="stringliteral">&quot;Depth_list.nc&quot;</span>)</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;      <span class="keywordflow">if</span> (scan(cs%depth_list_file,<span class="stringliteral">&#39;/&#39;</span>) == 0) &amp;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        cs%depth_list_file = trim(slasher(directory))//trim(cs%depth_list_file)</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160; </div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;REQUIRE_DEPTH_LIST_CHECKSUMS&quot;</span>, &amp;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                     cs%require_depth_list_chksum, &amp;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                 <span class="stringliteral">&quot;Require that matching checksums be in Depth_list.nc &quot;</span>//&amp;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                 <span class="stringliteral">&quot;when reading the file.&quot;</span>, default=.true.)</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;      <span class="keywordflow">if</span> (.not. cs%require_depth_list_chksum) &amp;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;UPDATE_DEPTH_LIST_CHECKSUMS&quot;</span>, &amp;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                     cs%update_depth_list_chksum, &amp;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                 <span class="stringliteral">&quot;Automatically update the Depth_list.nc file if the &quot;</span>//&amp;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                 <span class="stringliteral">&quot;checksums are missing or do not match current values.&quot;</span>, &amp;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                 default=.false.)</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160; </div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="keyword">allocate</span>(cs%lH(g%ke))</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="keyword">call </span>depth_list_setup(g, us, cs)</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    cs%list_size = 0</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160; </div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TIMEUNIT&quot;</span>, time_unit, &amp;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                 <span class="stringliteral">&quot;The time unit for ENERGYSAVEDAYS.&quot;</span>, &amp;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                 units=<span class="stringliteral">&quot;s&quot;</span>, default=86400.0)</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ENERGYSAVEDAYS&quot;</span>,cs%energysavedays, &amp;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                 <span class="stringliteral">&quot;The interval in units of TIMEUNIT between saves of the &quot;</span>//&amp;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                 <span class="stringliteral">&quot;energies of the run and other globally summed diagnostics.&quot;</span>,&amp;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                 default=set_time(0,days=1), timeunit=time_unit)</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ENERGYSAVEDAYS_GEOMETRIC&quot;</span>,cs%energysavedays_geometric, &amp;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                 <span class="stringliteral">&quot;The starting interval in units of TIMEUNIT for the first call &quot;</span>//&amp;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                 <span class="stringliteral">&quot;to save the energies of the run and other globally summed diagnostics. &quot;</span>//&amp;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                 <span class="stringliteral">&quot;The interval increases by a factor of 2. after each call to write_energy.&quot;</span>,&amp;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                 default=set_time(seconds=0), timeunit=time_unit)</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160; </div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;  <span class="keywordflow">if</span> ((time_type_to_real(cs%energysavedays_geometric) &gt; 0.) .and. &amp;</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;     (cs%energysavedays_geometric &lt; cs%energysavedays)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;         cs%energysave_geometric = .true.</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;         cs%energysave_geometric = .false.</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160; </div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;  cs%Start_time = input_start_time</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;  cs%ntrunc =&gt; ntrnc</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__sum__output_8F90_source.html#l01071">depth_list_setup()</a>, and <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM_8F90_source.html#l01500">mom::initialize_mom()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a05003e74cbb39fbdf760d23617390445_cgraph.svg" width="100%" height="545"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a05003e74cbb39fbdf760d23617390445_icgraph.svg" width="511" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a4f45b1c7dbff4fe064e102ccb2967daf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4f45b1c7dbff4fe064e102ccb2967daf">&#9670;&nbsp;</a></span>read_depth_list()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_sum_output::read_depth_list </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=*), intent(in)&#160;</td>
          <td class="paramname"><em>filename</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine reads in the depth list to the specified file and allocates and sets up CSDL and CSlist_size . </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to MOM_sum_output_init. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">filename</td><td>The path to the depth list file to read. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l01321">1321</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(in)</span> :: G<span class="comment">   !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type), <span class="keywordtype">intent(in)</span> :: US<span class="comment">  !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;  <span class="keywordtype">type</span>(Sum_output_CS),   <span class="keywordtype">pointer</span>    :: CS<span class="comment">  !&lt; The control structure returned by a</span></div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;<span class="comment">                                           !! previous call to MOM_sum_output_init.</span></div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;  <span class="keywordtype">character(len=*)</span>,      <span class="keywordtype">intent(in)</span> :: filename<span class="comment"> !&lt; The path to the depth list file to read.</span></div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;  <span class="keywordtype">character(len=32)</span> :: mdl</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;  <span class="keywordtype">character(len=240)</span> :: var_name, var_msg</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">allocatable</span> :: tmp(:)</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;  <span class="keywordtype">integer</span> :: ncid, status, varid, list_size, k</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;  <span class="keywordtype">integer</span> :: ndim, len, var_dim_ids(NF90_MAX_VAR_DIMS)</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;  <span class="keywordtype">character(len=16)</span> :: depth_file_chksum, depth_grid_chksum</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;  <span class="keywordtype">character(len=16)</span> :: area_file_chksum, area_grid_chksum</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;  <span class="keywordtype">integer</span> :: depth_attr_status, area_attr_status</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160; </div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;  mdl = <span class="stringliteral">&quot;MOM_sum_output read_depth_list:&quot;</span></div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160; </div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;  status = nf90_open(filename, nf90_nowrite, ncid)</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;    <span class="keyword">call </span>mom_error(fatal,mdl//<span class="stringliteral">&quot; Difficulties opening &quot;</span>//trim(filename)// &amp;</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;        <span class="stringliteral">&quot; - &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160; </div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;  <span class="comment">! Check bathymetric consistency</span></div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;  depth_attr_status = nf90_get_att(ncid, nf90_global, depth_chksum_attr, &amp;</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;                                   depth_file_chksum)</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;  area_attr_status = nf90_get_att(ncid, nf90_global, area_chksum_attr, &amp;</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;                                  area_file_chksum)</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160; </div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;  <span class="keywordflow">if</span> (any([depth_attr_status, area_attr_status] == nf90_enotatt)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;    var_msg = trim(cs%depth_list_file) // <span class="stringliteral">&quot; checksums are missing;&quot;</span></div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;    <span class="keywordflow">if</span> (cs%require_depth_list_chksum) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;      <span class="keyword">call </span>mom_error(fatal, trim(var_msg) // <span class="stringliteral">&quot; aborting.&quot;</span>)</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;    <span class="keywordflow">elseif</span> (cs%update_depth_list_chksum) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;      <span class="keyword">call </span>mom_error(warning, trim(var_msg) // <span class="stringliteral">&quot; updating file.&quot;</span>)</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;      <span class="keyword">call </span>create_depth_list(g, cs)</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;      <span class="keyword">call </span>write_depth_list(g, us, cs, cs%depth_list_file, cs%list_size+1)</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;      <span class="keywordflow">return</span></div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;      <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;        trim(var_msg) // <span class="stringliteral">&quot; some diagnostics may not be reproducible.&quot;</span>)</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;    <span class="comment">! Validate netCDF call</span></div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;    <span class="keywordflow">if</span> (depth_attr_status /= nf90_noerr) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;      var_msg = mdl // <span class="stringliteral">&quot;Failed to read &quot;</span> // trim(filename) // <span class="stringliteral">&quot;:&quot;</span> &amp;</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;                // depth_chksum_attr</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;      <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;        trim(var_msg) // <span class="stringliteral">&quot; - &quot;</span> // nf90_strerror(depth_attr_status))</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160; </div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;    <span class="keywordflow">if</span> (area_attr_status /= nf90_noerr) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;      var_msg = mdl // <span class="stringliteral">&quot;Failed to read &quot;</span> // trim(filename) // <span class="stringliteral">&quot;:&quot;</span> &amp;</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;                // area_chksum_attr</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;      <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;        trim(var_msg) // <span class="stringliteral">&quot; - &quot;</span> // nf90_strerror(area_attr_status))</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160; </div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;    <span class="keyword">call </span>get_depth_list_checksums(g, depth_grid_chksum, area_grid_chksum)</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160; </div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    <span class="keywordflow">if</span> (depth_grid_chksum /= depth_file_chksum &amp;</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;            .or. area_grid_chksum /= area_file_chksum) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;      var_msg = trim(cs%depth_list_file) // <span class="stringliteral">&quot; checksums do not match;&quot;</span></div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;      <span class="keywordflow">if</span> (cs%require_depth_list_chksum) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;        <span class="keyword">call </span>mom_error(fatal, trim(var_msg) // <span class="stringliteral">&quot; aborting.&quot;</span>)</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;      <span class="keywordflow">elseif</span> (cs%update_depth_list_chksum) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;        <span class="keyword">call </span>mom_error(warning, trim(var_msg) // <span class="stringliteral">&quot; updating file.&quot;</span>)</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;        <span class="keyword">call </span>create_depth_list(g, cs)</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;        <span class="keyword">call </span>write_depth_list(g, us, cs, cs%depth_list_file, cs%list_size+1)</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;        <span class="keywordflow">return</span></div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;        <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;          trim(var_msg) // <span class="stringliteral">&quot; some diagnostics may not be reproducible.&quot;</span>)</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160; </div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;  var_name = <span class="stringliteral">&quot;depth&quot;</span></div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;  var_msg = trim(var_name)//<span class="stringliteral">&quot; in &quot;</span>//trim(filename)//<span class="stringliteral">&quot; - &quot;</span></div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;  status = nf90_inq_varid(ncid, var_name, varid)</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(fatal,mdl// &amp;</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;        <span class="stringliteral">&quot; Difficulties finding variable &quot;</span>//trim(var_msg)//&amp;</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;        trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160; </div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;  status = nf90_inquire_variable(ncid, varid, ndims=ndim, dimids=var_dim_ids)</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;    <span class="keyword">call </span>mom_error(fatal,mdl//<span class="stringliteral">&quot; cannot inquire about &quot;</span>//trim(var_msg)//&amp;</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;        trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;  <span class="keywordflow">elseif</span> (ndim &gt; 1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;    <span class="keyword">call </span>mom_error(fatal,mdl//<span class="stringliteral">&quot; &quot;</span>//trim(var_msg)//&amp;</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;         <span class="stringliteral">&quot; has too many or too few dimensions.&quot;</span>)</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160; </div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;  <span class="comment">! Get the length of the list.</span></div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;  status = nf90_inquire_dimension(ncid, var_dim_ids(1), len=list_size)</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(fatal,mdl// &amp;</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;        <span class="stringliteral">&quot; cannot inquire about dimension(1) of &quot;</span>//trim(var_msg)//&amp;</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;        trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160; </div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;  cs%list_size = list_size-1</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;  <span class="keyword">allocate</span>(cs%DL(list_size))</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;  <span class="keyword">allocate</span>(tmp(list_size))</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160; </div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;  status = nf90_get_var(ncid, varid, tmp)</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(fatal,mdl// &amp;</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;        <span class="stringliteral">&quot; Difficulties reading variable &quot;</span>//trim(var_msg)//&amp;</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;        trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160; </div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;  <span class="keywordflow">do</span> k=1,list_size ; cs%DL(k)%depth = us%m_to_Z*tmp(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160; </div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;  var_name = <span class="stringliteral">&quot;area&quot;</span></div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;  var_msg = trim(var_name)//<span class="stringliteral">&quot; in &quot;</span>//trim(filename)//<span class="stringliteral">&quot; - &quot;</span></div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;  status = nf90_inq_varid(ncid, var_name, varid)</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(fatal,mdl// &amp;</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;        <span class="stringliteral">&quot; Difficulties finding variable &quot;</span>//trim(var_msg)//&amp;</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;        trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;  status = nf90_get_var(ncid, varid, tmp)</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(fatal,mdl// &amp;</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;        <span class="stringliteral">&quot; Difficulties reading variable &quot;</span>//trim(var_msg)//&amp;</div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;        trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160; </div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;  <span class="keywordflow">do</span> k=1,list_size ; cs%DL(k)%area = tmp(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160; </div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;  var_name = <span class="stringliteral">&quot;vol_below&quot;</span></div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;  var_msg = trim(var_name)//<span class="stringliteral">&quot; in &quot;</span>//trim(filename)</div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;  status = nf90_inq_varid(ncid, var_name, varid)</div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(fatal,mdl// &amp;</div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;        <span class="stringliteral">&quot; Difficulties finding variable &quot;</span>//trim(var_msg)//&amp;</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;        trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;  status = nf90_get_var(ncid, varid, tmp)</div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(fatal,mdl// &amp;</div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;        <span class="stringliteral">&quot; Difficulties reading variable &quot;</span>//trim(var_msg)//&amp;</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;        trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160; </div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;  <span class="keywordflow">do</span> k=1,list_size ; cs%DL(k)%vol_below = us%m_to_Z*tmp(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160; </div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;  status = nf90_close(ncid)</div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, mdl// &amp;</div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;    <span class="stringliteral">&quot; Difficulties closing &quot;</span>//trim(filename)//<span class="stringliteral">&quot; - &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160; </div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;  <span class="keyword">deallocate</span>(tmp)</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__sum__output_8F90_source.html#l00047">area_chksum_attr</a>, <a class="el" href="MOM__sum__output_8F90_source.html#l01101">create_depth_list()</a>, <a class="el" href="MOM__sum__output_8F90_source.html#l00044">depth_chksum_attr</a>, <a class="el" href="MOM__sum__output_8F90_source.html#l01477">get_depth_list_checksums()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, and <a class="el" href="MOM__sum__output_8F90_source.html#l01226">write_depth_list()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__sum__output_8F90_source.html#l01071">depth_list_setup()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a4f45b1c7dbff4fe064e102ccb2967daf_cgraph.svg" width="100%" height="471"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a4f45b1c7dbff4fe064e102ccb2967daf_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a955e777980a668bfc611c78de5de1895"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a955e777980a668bfc611c78de5de1895">&#9670;&nbsp;</a></span>write_depth_list()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_sum_output::write_depth_list </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=*), intent(in)&#160;</td>
          <td class="paramname"><em>filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>list_size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine writes out the depth list to the specified file. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to MOM_sum_output_init. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">filename</td><td>The path to the depth list file to write. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">list_size</td><td>The size of the depth list. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l01226">1226</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(in)</span> :: G<span class="comment">   !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type), <span class="keywordtype">intent(in)</span> :: US<span class="comment">  !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;  <span class="keywordtype">type</span>(Sum_output_CS),   <span class="keywordtype">pointer</span>    :: CS<span class="comment">  !&lt; The control structure returned by a</span></div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;<span class="comment">                                           !! previous call to MOM_sum_output_init.</span></div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;  <span class="keywordtype">character(len=*)</span>,      <span class="keywordtype">intent(in)</span> :: filename<span class="comment"> !&lt; The path to the depth list file to write.</span></div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;  <span class="keywordtype">integer</span>,               <span class="keywordtype">intent(in)</span> :: list_size<span class="comment"> !&lt; The size of the depth list.</span></div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">allocatable</span> :: tmp(:)</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;  <span class="keywordtype">integer</span> :: ncid, dimid(1), Did, Aid, Vid, status, k</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;  <span class="keywordtype">character(len=16)</span> :: depth_chksum, area_chksum</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160; </div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;  <span class="comment">! All ranks are required to compute the global checksum</span></div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;  <span class="keyword">call </span>get_depth_list_checksums(g, depth_chksum, area_chksum)</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160; </div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;  <span class="keywordflow">if</span> (.not.is_root_pe()) <span class="keywordflow">return</span></div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160; </div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;  <span class="keyword">allocate</span>(tmp(list_size)) ; tmp(:) = 0.0</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160; </div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;  status = nf90_create(filename, 0, ncid)</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    <span class="keyword">call </span>mom_error(warning, filename//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    <span class="keywordflow">return</span></div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160; </div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;  status = nf90_def_dim(ncid, <span class="stringliteral">&quot;list&quot;</span>, list_size, dimid(1))</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;      filename//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160; </div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;  status = nf90_def_var(ncid, <span class="stringliteral">&quot;depth&quot;</span>, nf90_double, dimid, did)</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;      filename//<span class="stringliteral">&quot; depth &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;  status = nf90_put_att(ncid, did, <span class="stringliteral">&quot;long_name&quot;</span>, <span class="stringliteral">&quot;Sorted depth&quot;</span>)</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;      filename//<span class="stringliteral">&quot; depth &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;  status = nf90_put_att(ncid, did, <span class="stringliteral">&quot;units&quot;</span>, <span class="stringliteral">&quot;m&quot;</span>)</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;      filename//<span class="stringliteral">&quot; depth &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160; </div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;  status = nf90_def_var(ncid, <span class="stringliteral">&quot;area&quot;</span>, nf90_double, dimid, aid)</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;      filename//<span class="stringliteral">&quot; area &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;  status = nf90_put_att(ncid, aid, <span class="stringliteral">&quot;long_name&quot;</span>, <span class="stringliteral">&quot;Open area at depth&quot;</span>)</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;      filename//<span class="stringliteral">&quot; area &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;  status = nf90_put_att(ncid, aid, <span class="stringliteral">&quot;units&quot;</span>, <span class="stringliteral">&quot;m2&quot;</span>)</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;      filename//<span class="stringliteral">&quot; area &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160; </div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;  status = nf90_def_var(ncid, <span class="stringliteral">&quot;vol_below&quot;</span>, nf90_double, dimid, vid)</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;      filename//<span class="stringliteral">&quot; vol_below &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;  status = nf90_put_att(ncid, vid, <span class="stringliteral">&quot;long_name&quot;</span>, <span class="stringliteral">&quot;Open volume below depth&quot;</span>)</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;   <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;      filename//<span class="stringliteral">&quot; vol_below &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;  status = nf90_put_att(ncid, vid, <span class="stringliteral">&quot;units&quot;</span>, <span class="stringliteral">&quot;m3&quot;</span>)</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;      filename//<span class="stringliteral">&quot; vol_below &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160; </div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;  <span class="comment">! Dependency checksums</span></div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;  status = nf90_put_att(ncid, nf90_global, depth_chksum_attr, depth_chksum)</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;      filename//<span class="stringliteral">&quot; &quot;</span>//depth_chksum_attr//<span class="stringliteral">&quot; &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160; </div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;  status = nf90_put_att(ncid, nf90_global, area_chksum_attr, area_chksum)</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;      filename//<span class="stringliteral">&quot; &quot;</span>//area_chksum_attr//<span class="stringliteral">&quot; &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160; </div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;  status = nf90_enddef(ncid)</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;      filename//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160; </div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;  <span class="keywordflow">do</span> k=1,list_size ; tmp(k) = us%Z_to_m*cs%DL(k)%depth ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;  status = nf90_put_var(ncid, did, tmp)</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;      filename//<span class="stringliteral">&quot; depth &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160; </div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;  <span class="keywordflow">do</span> k=1,list_size ; tmp(k) = cs%DL(k)%area ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;  status = nf90_put_var(ncid, aid, tmp)</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;      filename//<span class="stringliteral">&quot; area &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160; </div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;  <span class="keywordflow">do</span> k=1,list_size ; tmp(k) = us%Z_to_m*cs%DL(k)%vol_below ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;  status = nf90_put_var(ncid, vid, tmp)</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;      filename//<span class="stringliteral">&quot; vol_below &quot;</span>//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160; </div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;  status = nf90_close(ncid)</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;      filename//trim(nf90_strerror(status)))</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__sum__output_8F90_source.html#l00047">area_chksum_attr</a>, <a class="el" href="MOM__sum__output_8F90_source.html#l00044">depth_chksum_attr</a>, <a class="el" href="MOM__sum__output_8F90_source.html#l01477">get_depth_list_checksums()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00044">mom_error_handler::is_root_pe()</a>, and <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__sum__output_8F90_source.html#l01071">depth_list_setup()</a>, and <a class="el" href="MOM__sum__output_8F90_source.html#l01321">read_depth_list()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a955e777980a668bfc611c78de5de1895_cgraph.svg" width="595" height="170"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a955e777980a668bfc611c78de5de1895_icgraph.svg" width="100%" height="361"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="ad3cc692dd515100ec8cf92d740c91e72"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad3cc692dd515100ec8cf92d740c91e72">&#9670;&nbsp;</a></span>write_energy()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_sum_output::write_energy </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>day</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(tracer_flow_control_cs), optional, pointer&#160;</td>
          <td class="paramname"><em>tracer_CSp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_obc_type), optional, pointer&#160;</td>
          <td class="paramname"><em>OBC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(in), optional&#160;</td>
          <td class="paramname"><em>dt_forcing</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine calculates and writes the total model energy, the energy and mass of each layer, and other globally integrated physical quantities. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u</td><td>The zonal velocity [L T-1 ~&gt; m s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v</td><td>The meridional velocity [L T-1 ~&gt; m s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>A structure pointing to various thermodynamic variables. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">day</td><td>The current model time. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n</td><td>The time step number of the current execution. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to MOM_sum_output_init. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">tracer_csp</td><td>tracer control structure. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">obc</td><td>Open boundaries control structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_forcing</td><td>The forcing time step </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l00304">304</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">   !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">  !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>    :: US<span class="comment">  !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: u<span class="comment">   !&lt; The zonal velocity [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: v<span class="comment">   !&lt; The meridional velocity [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  &amp;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: h<span class="comment">   !&lt; Layer thicknesses [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),   <span class="keywordtype">intent(in)</span>    :: tv<span class="comment">  !&lt; A structure pointing to various</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="comment">                                                !! thermodynamic variables.</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;  <span class="keywordtype">type</span>(time_type),         <span class="keywordtype">intent(in)</span>    :: day<span class="comment"> !&lt; The current model time.</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  <span class="keywordtype">integer</span>,                 <span class="keywordtype">intent(in)</span>    :: n<span class="comment">   !&lt; The time step number of the</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment">                                                !! current execution.</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;  <span class="keywordtype">type</span>(Sum_output_CS),     <span class="keywordtype">pointer</span>       :: CS<span class="comment">  !&lt; The control structure returned by a</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment">                                                !! previous call to MOM_sum_output_init.</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;  <span class="keywordtype">type</span>(tracer_flow_control_CS), &amp;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                    <span class="keywordtype">optional</span>, <span class="keywordtype">pointer</span>    :: tracer_CSp<span class="comment"> !&lt; tracer control structure.</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;  <span class="keywordtype">type</span>(ocean_OBC_type),         &amp;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;                    <span class="keywordtype">optional</span>, <span class="keywordtype">pointer</span>    :: OBC<span class="comment"> !&lt; Open boundaries control structure.</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;  <span class="keywordtype">type</span>(time_type),  <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: dt_forcing<span class="comment"> !&lt; The forcing time step</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="keywordtype">  real</span> :: eta(SZI_(G),SZJ_(G),SZK_(G)+1) <span class="comment">! The height of interfaces [Z ~&gt; m].</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="keywordtype">  real</span> :: areaTm(SZI_(G),SZJ_(G)) <span class="comment">! A masked version of areaT [m2].</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="keywordtype">  real</span> :: KE(SZK_(G))  <span class="comment">! The total kinetic energy of a layer [J].</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="keywordtype">  real</span> :: PE(SZK_(G)+1)<span class="comment">! The available potential energy of an interface [J].</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="keywordtype">  real</span> :: KE_tot       <span class="comment">! The total kinetic energy [J].</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="keywordtype">  real</span> :: PE_tot       <span class="comment">! The total available potential energy [J].</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="keywordtype">  real</span> :: Z_0APE(SZK_(G)+1) <span class="comment">! The uniform depth which overlies the same</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                       <span class="comment">! volume as is below an interface [Z ~&gt; m].</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="keywordtype">  real</span> :: H_0APE(SZK_(G)+1) <span class="comment">! A version of Z_0APE, converted to m, usually positive.</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="keywordtype">  real</span> :: toten        <span class="comment">! The total kinetic &amp; potential energies of</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                       <span class="comment">! all layers [J] (i.e. kg m2 s-2).</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="keywordtype">  real</span> :: En_mass      <span class="comment">! The total kinetic and potential energies divided by</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                       <span class="comment">! the total mass of the ocean [m2 s-2].</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="keywordtype">  real</span> :: vol_lay(SZK_(G))  <span class="comment">! The volume of fluid in a layer [Z m2 ~&gt; m3].</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="keywordtype">  real</span> :: volbelow     <span class="comment">! The volume of all layers beneath an interface [Z m2 ~&gt; m3].</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="keywordtype">  real</span> :: mass_lay(SZK_(G)) <span class="comment">! The mass of fluid in a layer [kg].</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="keywordtype">  real</span> :: mass_tot     <span class="comment">! The total mass of the ocean [kg].</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="keywordtype">  real</span> :: vol_tot      <span class="comment">! The total ocean volume [m3].</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="keywordtype">  real</span> :: mass_chg     <span class="comment">! The change in total ocean mass of fresh water since</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                       <span class="comment">! the last call to this subroutine [kg].</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="keywordtype">  real</span> :: mass_anom    <span class="comment">! The change in fresh water that cannot be accounted for</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                       <span class="comment">! by the surface fluxes [kg].</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="keywordtype">  real</span> :: Salt         <span class="comment">! The total amount of salt in the ocean [ppt kg].</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="keywordtype">  real</span> :: Salt_chg     <span class="comment">! The change in total ocean salt since the last call</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                       <span class="comment">! to this subroutine [ppt kg].</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keywordtype">  real</span> :: Salt_anom    <span class="comment">! The change in salt that cannot be accounted for by</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                       <span class="comment">! the surface fluxes [ppt kg].</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="keywordtype">  real</span> :: salin        <span class="comment">! The mean salinity of the ocean [ppt].</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="keywordtype">  real</span> :: salin_chg    <span class="comment">! The change in total salt since the last call</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                       <span class="comment">! to this subroutine divided by total mass [ppt].</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="keywordtype">  real</span> :: salin_anom   <span class="comment">! The change in total salt that cannot be accounted for by</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                       <span class="comment">! the surface fluxes divided by total mass [ppt].</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="keywordtype">  real</span> :: salin_mass_in <span class="comment">! The mass of salt input since the last call [kg].</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="keywordtype">  real</span> :: Heat         <span class="comment">! The total amount of Heat in the ocean [J].</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="keywordtype">  real</span> :: Heat_chg     <span class="comment">! The change in total ocean heat since the last call</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                       <span class="comment">! to this subroutine [J].</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="keywordtype">  real</span> :: Heat_anom    <span class="comment">! The change in heat that cannot be accounted for by</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                       <span class="comment">! the surface fluxes [J].</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="keywordtype">  real</span> :: temp         <span class="comment">! The mean potential temperature of the ocean [degC].</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="keywordtype">  real</span> :: temp_chg     <span class="comment">! The change in total heat divided by total heat capacity</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                       <span class="comment">! of the ocean since the last call to this subroutine, degC.</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="keywordtype">  real</span> :: temp_anom    <span class="comment">! The change in total heat that cannot be accounted for</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                       <span class="comment">! by the surface fluxes, divided by the total heat</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                       <span class="comment">! capacity of the ocean [degC].</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="keywordtype">  real</span> :: hint         <span class="comment">! The deviation of an interface from H [Z ~&gt; m].</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="keywordtype">  real</span> :: hbot         <span class="comment">! 0 if the basin is deeper than H, or the</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                       <span class="comment">! height of the basin depth over H otherwise [Z ~&gt; m].</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                       <span class="comment">! This makes PE only include real fluid.</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="keywordtype">  real</span> :: hbelow       <span class="comment">! The depth of fluid in all layers beneath an interface [Z ~&gt; m].</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;  <span class="keywordtype">type</span>(EFP_type) :: &amp;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    mass_EFP, &amp;        <span class="comment">! Extended fixed point sums of total mass, etc.</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    salt_EFP, heat_EFP, salt_chg_EFP, heat_chg_EFP, mass_chg_EFP, &amp;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    mass_anom_EFP, salt_anom_EFP, heat_anom_EFP</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="keywordtype">  real</span> :: CFL_trans    <span class="comment">! A transport-based definition of the CFL number [nondim].</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="keywordtype">  real</span> :: CFL_lin      <span class="comment">! A simpler definition of the CFL number [nondim].</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="keywordtype">  real</span> :: max_CFL(2)   <span class="comment">! The maxima of the CFL numbers [nondim].</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="keywordtype">  real</span> :: Irho0        <span class="comment">! The inverse of the reference density [m3 kg-1].</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> :: &amp;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    tmp1               <span class="comment">! A temporary array</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span> :: &amp;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    PE_pt              <span class="comment">! The potential energy at each point [J].</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: &amp;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    Temp_int, Salt_int <span class="comment">! Layer and cell integrated heat and salt [J] and [g Salt].</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="keywordtype">  real</span> :: H_to_kg_m2   <span class="comment">! Local copy of a unit conversion factor.</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="keywordtype">  real</span> :: KE_scale_factor   <span class="comment">! The combination of unit rescaling factors in the kinetic energy</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                            <span class="comment">! calculation [kg T2 L-2 s-2 H-1 ~&gt; kg m-3 or nondim]</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  <span class="keywordtype">integer</span> :: num_nc_fields  <span class="comment">! The number of fields that will actually go into</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                            <span class="comment">! the NetCDF file.</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, ns, nz, m, Isq, Ieq, Jsq, Jeq</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  <span class="keywordtype">integer</span> :: l, lbelow, labove   <span class="comment">! indices of deep_area_vol, used to find Z_0APE.</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                                 <span class="comment">! lbelow &amp; labove are lower &amp; upper limits for l</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                                 <span class="comment">! in the search for the entry in lH to use.</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;  <span class="keywordtype">integer</span> :: start_of_day, num_days</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="keywordtype">  real</span>    :: reday, var</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;  <span class="keywordtype">character(len=240)</span> :: energypath_nc</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  <span class="keywordtype">character(len=200)</span> :: mesg</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  <span class="keywordtype">character(len=32)</span>  :: mesg_intro, time_units, day_str, n_str, date_str</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;  <span class="keywordtype">logical</span> :: date_stamped</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;  <span class="keywordtype">type</span>(time_type) :: dt_force <span class="comment">! A time_type version of the forcing timestep.</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;<span class="keywordtype">  real</span> :: Tr_stocks(MAX_FIELDS_)</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="keywordtype">  real</span> :: Tr_min(MAX_FIELDS_), Tr_max(MAX_FIELDS_)</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="keywordtype">  real</span> :: Tr_min_x(MAX_FIELDS_), Tr_min_y(MAX_FIELDS_), Tr_min_z(MAX_FIELDS_)</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="keywordtype">  real</span> :: Tr_max_x(MAX_FIELDS_), Tr_max_y(MAX_FIELDS_), Tr_max_z(MAX_FIELDS_)</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;  <span class="keywordtype">logical</span> :: Tr_minmax_got(MAX_FIELDS_) = .false.</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;  <span class="keywordtype">character(len=40)</span>, <span class="keywordtype">dimension(MAX_FIELDS_)</span> :: &amp;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    Tr_names, Tr_units</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  <span class="keywordtype">integer</span> :: nTr_stocks</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;  <span class="keywordtype">integer</span> :: iyear, imonth, iday, ihour, iminute, isecond, itick <span class="comment">! For call to get_date()</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;  <span class="keywordtype">logical</span> :: local_open_BC</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;  <span class="keywordtype">type</span>(OBC_segment_type), <span class="keywordtype">pointer</span> :: segment =&gt; null()</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160; </div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160; <span class="comment">! A description for output of each of the fields.</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;  <span class="keywordtype">type</span>(vardesc) :: vars(NUM_FIELDS+MAX_FIELDS_)</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160; </div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  <span class="comment">! write_energy_time is the next integral multiple of energysavedays.</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  dt_force = set_time(seconds=2) ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_forcing)) dt_force = dt_forcing</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;  <span class="keywordflow">if</span> (cs%previous_calls == 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="keywordflow">if</span> (cs%energysave_geometric) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;      <span class="keywordflow">if</span> (cs%energysavedays_geometric &lt; cs%energysavedays) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        cs%write_energy_time = day + cs%energysavedays_geometric</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        cs%geometric_end_time = cs%Start_time + cs%energysavedays * &amp;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;          (1 + (day - cs%Start_time) / cs%energysavedays)</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        cs%write_energy_time = cs%Start_time + cs%energysavedays * &amp;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;          (1 + (day - cs%Start_time) / cs%energysavedays)</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;      cs%write_energy_time = cs%Start_time + cs%energysavedays * &amp;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        (1 + (day - cs%Start_time) / cs%energysavedays)</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;  <span class="keywordflow">elseif</span> (day + (dt_force/2) &lt;= cs%write_energy_time) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    <span class="keywordflow">return</span>  <span class="comment">! Do not write this step</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;  <span class="keywordflow">else</span> <span class="comment">! Determine the next write time before proceeding</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    <span class="keywordflow">if</span> (cs%energysave_geometric) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;      <span class="keywordflow">if</span> (cs%write_energy_time + cs%energysavedays_geometric &gt;= &amp;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;          cs%geometric_end_time) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        cs%write_energy_time = cs%geometric_end_time</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        cs%energysave_geometric = .false.  <span class="comment">! stop geometric progression</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        cs%write_energy_time = cs%write_energy_time + cs%energysavedays_geometric</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;      cs%energysavedays_geometric = cs%energysavedays_geometric*2</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;      cs%write_energy_time = cs%write_energy_time + cs%energysavedays</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160; </div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;  num_nc_fields = 17</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;  <span class="keywordflow">if</span> (.not.cs%use_temperature) num_nc_fields = 11</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  vars(1) = var_desc(<span class="stringliteral">&quot;Ntrunc&quot;</span>,<span class="stringliteral">&quot;Nondim&quot;</span>,<span class="stringliteral">&quot;Number of Velocity Truncations&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;  vars(2) = var_desc(<span class="stringliteral">&quot;En&quot;</span>,<span class="stringliteral">&quot;Joules&quot;</span>,<span class="stringliteral">&quot;Total Energy&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;  vars(3) = var_desc(<span class="stringliteral">&quot;APE&quot;</span>,<span class="stringliteral">&quot;Joules&quot;</span>,<span class="stringliteral">&quot;Total Interface APE&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;i&#39;</span>)</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;  vars(4) = var_desc(<span class="stringliteral">&quot;KE&quot;</span>,<span class="stringliteral">&quot;Joules&quot;</span>,<span class="stringliteral">&quot;Total Layer KE&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;L&#39;</span>)</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  vars(5) = var_desc(<span class="stringliteral">&quot;H0&quot;</span>,<span class="stringliteral">&quot;meter&quot;</span>,<span class="stringliteral">&quot;Zero APE Depth of Interface&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;i&#39;</span>)</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;  vars(6) = var_desc(<span class="stringliteral">&quot;Mass_lay&quot;</span>,<span class="stringliteral">&quot;kg&quot;</span>,<span class="stringliteral">&quot;Total Layer Mass&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;L&#39;</span>)</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;  vars(7) = var_desc(<span class="stringliteral">&quot;Mass&quot;</span>,<span class="stringliteral">&quot;kg&quot;</span>,<span class="stringliteral">&quot;Total Mass&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;  vars(8) = var_desc(<span class="stringliteral">&quot;Mass_chg&quot;</span>,<span class="stringliteral">&quot;kg&quot;</span>,<span class="stringliteral">&quot;Total Mass Change between Entries&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  vars(9) = var_desc(<span class="stringliteral">&quot;Mass_anom&quot;</span>,<span class="stringliteral">&quot;kg&quot;</span>,<span class="stringliteral">&quot;Anomalous Total Mass Change&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  vars(10) = var_desc(<span class="stringliteral">&quot;max_CFL_trans&quot;</span>,<span class="stringliteral">&quot;Nondim&quot;</span>,<span class="stringliteral">&quot;Maximum finite-volume CFL&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;  vars(11) = var_desc(<span class="stringliteral">&quot;max_CFL_lin&quot;</span>,<span class="stringliteral">&quot;Nondim&quot;</span>,<span class="stringliteral">&quot;Maximum finite-difference CFL&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    vars(12) = var_desc(<span class="stringliteral">&quot;Salt&quot;</span>,<span class="stringliteral">&quot;kg&quot;</span>,<span class="stringliteral">&quot;Total Salt&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    vars(13) = var_desc(<span class="stringliteral">&quot;Salt_chg&quot;</span>,<span class="stringliteral">&quot;kg&quot;</span>,<span class="stringliteral">&quot;Total Salt Change between Entries&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    vars(14) = var_desc(<span class="stringliteral">&quot;Salt_anom&quot;</span>,<span class="stringliteral">&quot;kg&quot;</span>,<span class="stringliteral">&quot;Anomalous Total Salt Change&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    vars(15) = var_desc(<span class="stringliteral">&quot;Heat&quot;</span>,<span class="stringliteral">&quot;Joules&quot;</span>,<span class="stringliteral">&quot;Total Heat&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    vars(16) = var_desc(<span class="stringliteral">&quot;Heat_chg&quot;</span>,<span class="stringliteral">&quot;Joules&quot;</span>,<span class="stringliteral">&quot;Total Heat Change between Entries&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    vars(17) = var_desc(<span class="stringliteral">&quot;Heat_anom&quot;</span>,<span class="stringliteral">&quot;Joules&quot;</span>,<span class="stringliteral">&quot;Anomalous Total Heat Change&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160; </div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;  local_open_bc = .false.</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(obc)) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (<span class="keyword">associated</span>(obc)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    local_open_bc = (obc%open_u_BCs_exist_globally .or. obc%open_v_BCs_exist_globally)</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160; </div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;  isq = g%IscB ; ieq = g%IecB ; jsq = g%JscB ; jeq = g%JecB</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;  h_to_kg_m2 = gv%H_to_kg_m2</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160; </div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;         <span class="stringliteral">&quot;write_energy: Module must be initialized before it is used.&quot;</span>)</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160; </div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    areatm(i,j) = g%mask2dT(i,j)*us%L_to_m**2*g%areaT(i,j)</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160; </div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;  <span class="keywordflow">if</span> (gv%Boussinesq) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    tmp1(:,:,:) = 0.0</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;      tmp1(i,j,k) = h(i,j,k) * (h_to_kg_m2*areatm(i,j))</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160; </div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="comment">! This block avoids using the points beyond an open boundary condition</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="comment">! in the accumulation of mass, but perhaps it would be unnecessary if there</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="comment">! were a more judicious use of masks in the loops 4 or 7 lines above.</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    <span class="keywordflow">if</span> (local_open_bc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;      <span class="keywordflow">do</span> ns=1, obc%number_of_segments</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;        segment =&gt; obc%segment(ns)</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        <span class="keywordflow">if</span> (.not. segment%on_pe .or. segment%specified) cycle</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;        i=segment%HI%IsdB ; j=segment%HI%JsdB</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;        <span class="keywordflow">if</span> (segment%direction == obc_direction_e) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;          <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=segment%HI%jsd,segment%HI%jed</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;            tmp1(i+1,j,k) = 0.0</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;        <span class="keywordflow">elseif</span> (segment%direction == obc_direction_w) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;          <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=segment%HI%jsd,segment%HI%jed</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;            tmp1(i,j,k) = 0.0</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        <span class="keywordflow">elseif</span> (segment%direction == obc_direction_n) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;          <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=segment%HI%isd,segment%HI%ied</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;            tmp1(i,j+1,k) = 0.0</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        <span class="keywordflow">elseif</span> (segment%direction == obc_direction_s) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;          <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=segment%HI%isd,segment%HI%ied</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;            tmp1(i,j,k) = 0.0</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160; </div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    mass_tot = <a class="code" href="interfacemom__coms_1_1reproducing__sum.html">reproducing_sum</a>(tmp1, sums=mass_lay, efp_sum=mass_efp)</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; vol_lay(k) = (gv%H_to_Z/h_to_kg_m2)*mass_lay(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    tmp1(:,:,:) = 0.0</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    <span class="keywordflow">if</span> (cs%do_APE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        tmp1(i,j,k) = h_to_kg_m2 * h(i,j,k) * areatm(i,j)</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;      mass_tot = <a class="code" href="interfacemom__coms_1_1reproducing__sum.html">reproducing_sum</a>(tmp1, sums=mass_lay, efp_sum=mass_efp)</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160; </div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;      <span class="keyword">call </span>find_eta(h, tv, g, gv, us, eta)</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        tmp1(i,j,k) = (eta(i,j,k)-eta(i,j,k+1)) * areatm(i,j)</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;      vol_tot = us%Z_to_m*<a class="code" href="interfacemom__coms_1_1reproducing__sum.html">reproducing_sum</a>(tmp1, sums=vol_lay)</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;        tmp1(i,j,k) = h_to_kg_m2 * h(i,j,k) * areatm(i,j)</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;      mass_tot = <a class="code" href="interfacemom__coms_1_1reproducing__sum.html">reproducing_sum</a>(tmp1, sums=mass_lay, efp_sum=mass_efp)</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; vol_lay(k) = us%m_to_Z * (mass_lay(k) / gv%Rho0) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! Boussinesq</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160; </div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;  ntr_stocks = 0</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(tracer_csp)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <span class="keyword">call </span>call_tracer_stocks(h, tr_stocks, g, gv, tracer_csp, stock_names=tr_names, &amp;</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                            stock_units=tr_units, num_stocks=ntr_stocks,&amp;</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                            got_min_max=tr_minmax_got, global_min=tr_min, global_max=tr_max, &amp;</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                            xgmin=tr_min_x, ygmin=tr_min_y, zgmin=tr_min_z,&amp;</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                            xgmax=tr_max_x, ygmax=tr_max_y, zgmax=tr_max_z)</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    <span class="keywordflow">if</span> (ntr_stocks &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;      <span class="keywordflow">do</span> m=1,ntr_stocks</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        vars(num_nc_fields+m) = var_desc(tr_names(m), units=tr_units(m), &amp;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                      longname=tr_names(m), hor_grid=<span class="stringliteral">&#39;1&#39;</span>, z_grid=<span class="stringliteral">&#39;1&#39;</span>)</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;      num_nc_fields = num_nc_fields + ntr_stocks</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160; </div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;  <span class="keywordflow">if</span> (cs%previous_calls == 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    cs%mass_prev = mass_tot ; cs%fresh_water_input = 0.0</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160; </div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    cs%mass_prev_EFP = mass_efp</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    cs%fresh_water_in_EFP = real_to_efp(0.0)</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160; </div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    <span class="comment">!  Reopen or create a text output file, with an explanatory header line.</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    <span class="keywordflow">if</span> (is_root_pe()) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;      <span class="keywordflow">if</span> (day &gt; cs%Start_time) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        <span class="keyword">call </span>open_file(cs%fileenergy_ascii, trim(cs%energyfile), &amp;</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                       action=append_file, form=ascii_file, nohdrs=.true.)</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;        <span class="keyword">call </span>open_file(cs%fileenergy_ascii, trim(cs%energyfile), &amp;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                       action=writeonly_file, form=ascii_file, nohdrs=.true.)</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        <span class="keywordflow">if</span> (abs(cs%timeunit - 86400.0) &lt; 1.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;          <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(&quot;  Step,&quot;,7x,&quot;Day,  Truncs,      &amp;</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;Energy/Mass,      Maximum CFL,  Mean Sea Level,  Total Mass,  Mean Salin, &amp;</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;Mean Temp, Frac Mass Err,   Salin Err,    Temp Err&quot;)&#39;</span>)</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(12x,&quot;[days]&quot;,17x,&quot;[m2 s-2]&quot;,11x,&quot;[Nondim]&quot;,7x,&quot;[m]&quot;,13x,&amp;</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;&quot;[kg]&quot;,9x,&quot;[PSU]&quot;,6x,&quot;[degC]&quot;,7x,&quot;[Nondim]&quot;,8x,&quot;[PSU]&quot;,8x,&quot;[degC]&quot;)&#39;</span>)</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(&quot;  Step,&quot;,7x,&quot;Day,  Truncs,      &amp;</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;Energy/Mass,      Maximum CFL,  Mean sea level,   Total Mass,    Frac Mass Err&quot;)&#39;</span>)</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(12x,&quot;[days]&quot;,17x,&quot;[m2 s-2]&quot;,11x,&quot;[Nondim]&quot;,8x,&quot;[m]&quot;,13x,&amp;</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;&quot;[kg]&quot;,11x,&quot;[Nondim]&quot;)&#39;</span>)</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;          <span class="keywordflow">if</span> ((cs%timeunit &gt;= 0.99) .and. (cs%timeunit &lt; 1.01)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;            time_units = <span class="stringliteral">&quot;           [seconds]     &quot;</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;          <span class="keywordflow">elseif</span> ((cs%timeunit &gt;= 3599.0) .and. (cs%timeunit &lt; 3601.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;            time_units = <span class="stringliteral">&quot;            [hours]      &quot;</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;          <span class="keywordflow">elseif</span> ((cs%timeunit &gt;= 86399.0) .and. (cs%timeunit &lt; 86401.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;            time_units = <span class="stringliteral">&quot;             [days]      &quot;</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;          <span class="keywordflow">elseif</span> ((cs%timeunit &gt;= 3.0e7) .and. (cs%timeunit &lt; 3.2e7)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;            time_units = <span class="stringliteral">&quot;            [years]      &quot;</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;            <span class="keyword">write</span>(time_units,<span class="stringliteral">&#39;(9x,&quot;[&quot;,es8.2,&quot; s]    &quot;)&#39;</span>) cs%timeunit</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160; </div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;          <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(&quot;  Step,&quot;,7x,&quot;Time, Truncs,      &amp;</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;Energy/Mass,      Maximum CFL,  Mean Sea Level,  Total Mass,  Mean Salin, &amp;</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;Mean Temp, Frac Mass Err,   Salin Err,    Temp Err&quot;)&#39;</span>)</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(A25,10x,&quot;[m2 s-2]&quot;,11x,&quot;[Nondim]&quot;,7x,&quot;[m]&quot;,13x,&amp;</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;&quot;[kg]&quot;,9x,&quot;[PSU]&quot;,6x,&quot;[degC]&quot;,7x,&quot;[Nondim]&quot;,8x,&quot;[PSU]&quot;,6x,&amp;</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;&quot;[degC]&quot;)&#39;</span>) time_units</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(&quot;  Step,&quot;,7x,&quot;Time, Truncs,      &amp;</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;Energy/Mass,      Maximum CFL,  Mean sea level,   Total Mass,    Frac Mass Err&quot;)&#39;</span>)</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(A25,10x,&quot;[m2 s-2]&quot;,11x,&quot;[Nondim]&quot;,8x,&quot;[m]&quot;,13x,&amp;</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;&quot;[kg]&quot;,11x,&quot;[Nondim]&quot;)&#39;</span>) time_units</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160; </div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    energypath_nc = trim(cs%energyfile) // <span class="stringliteral">&quot;.nc&quot;</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    <span class="keywordflow">if</span> (day &gt; cs%Start_time) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;      <span class="keyword">call </span>reopen_file(cs%fileenergy_nc, trim(energypath_nc), vars, &amp;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                       num_nc_fields, cs%fields, single_file, cs%timeunit, &amp;</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                       g=g, gv=gv)</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;      <span class="keyword">call </span>create_file(cs%fileenergy_nc, trim(energypath_nc), vars, &amp;</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                       num_nc_fields, cs%fields, single_file, cs%timeunit, &amp;</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                       g=g, gv=gv)</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160; </div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;  <span class="keywordflow">if</span> (cs%do_APE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    lbelow = 1 ; volbelow = 0.0</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    <span class="keywordflow">do</span> k=nz,1,-1</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;      volbelow = volbelow + vol_lay(k)</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;      <span class="keywordflow">if</span> ((volbelow &gt;= cs%DL(cs%lH(k))%vol_below) .and. &amp;</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;          (volbelow &lt; cs%DL(cs%lH(k)+1)%vol_below)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        l = cs%lH(k)</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        labove=cs%list_size+1</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;        l = (labove + lbelow) / 2</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;        <span class="keywordflow">do</span> <span class="keywordflow">while</span> (l &gt; lbelow)</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;          <span class="keywordflow">if</span> (volbelow &lt; cs%DL(l)%vol_below) <span class="keywordflow">then</span> ; labove = l</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;          <span class="keywordflow">else</span> ; lbelow = l ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;          l = (labove + lbelow) / 2</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        cs%lH(k) = l</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;      lbelow = l</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;      z_0ape(k) = cs%DL(l)%depth - (volbelow - cs%DL(l)%vol_below) / cs%DL(l)%area</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    z_0ape(nz+1) = cs%DL(2)%depth</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160; </div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    <span class="comment">!   Calculate the Available Potential Energy integrated over each</span></div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    <span class="comment">! interface.  With a nonlinear equation of state or with a bulk</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    <span class="comment">! mixed layer this calculation is only approximate.  With an ALE model</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    <span class="comment">! this does not make sense.</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;    pe_pt(:,:,:) = 0.0</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    <span class="keywordflow">if</span> (gv%Boussinesq) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;        hbelow = 0.0</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        <span class="keywordflow">do</span> k=nz,1,-1</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;          hbelow = hbelow + h(i,j,k) * gv%H_to_Z</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;          hint = z_0ape(k) + (hbelow - g%bathyT(i,j))</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;          hbot = z_0ape(k) - g%bathyT(i,j)</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;          hbot = (hbot + abs(hbot)) * 0.5</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;          pe_pt(i,j,k) = 0.5 * areatm(i,j) * us%Z_to_m*us%L_T_to_m_s**2*(gv%Rho0*gv%g_prime(k)) * &amp;</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                  (hint * hint - hbot * hbot)</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        <span class="keywordflow">do</span> k=nz,1,-1</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;          hint = z_0ape(k) + eta(i,j,k)  <span class="comment">! eta and H_0 have opposite signs.</span></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;          hbot = max(z_0ape(k) - g%bathyT(i,j), 0.0)</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;          pe_pt(i,j,k) = 0.5 * (areatm(i,j) * us%Z_to_m*us%L_T_to_m_s**2*(gv%Rho0*gv%g_prime(k))) * &amp;</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;                  (hint * hint - hbot * hbot)</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160; </div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    pe_tot = <a class="code" href="interfacemom__coms_1_1reproducing__sum.html">reproducing_sum</a>(pe_pt, sums=pe)</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    <span class="keywordflow">do</span> k=1,nz+1 ; h_0ape(k) = us%Z_to_m*z_0ape(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    pe_tot = 0.0</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    <span class="keywordflow">do</span> k=1,nz+1 ; pe(k) = 0.0 ; h_0ape(k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160; </div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="comment">! Calculate the Kinetic Energy integrated over each layer.</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;  ke_scale_factor = gv%H_to_kg_m2*us%L_T_to_m_s**2</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;  tmp1(:,:,:) = 0.0</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    tmp1(i,j,k) = (0.25 * ke_scale_factor * (areatm(i,j) * h(i,j,k))) * &amp;</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;            (u(i-1,j,k)**2 + u(i,j,k)**2 + v(i,j-1,k)**2 + v(i,j,k)**2)</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;  ke_tot = <a class="code" href="interfacemom__coms_1_1reproducing__sum.html">reproducing_sum</a>(tmp1, sums=ke)</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160; </div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;  toten = ke_tot + pe_tot</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160; </div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;  salt = 0.0 ; heat = 0.0</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    temp_int(:,:) = 0.0 ; salt_int(:,:) = 0.0</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;      salt_int(i,j) = salt_int(i,j) + tv%S(i,j,k) * &amp;</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;                      (h(i,j,k)*(h_to_kg_m2 * areatm(i,j)))</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;      temp_int(i,j) = temp_int(i,j) + (tv%C_p * tv%T(i,j,k)) * &amp;</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;                      (h(i,j,k)*(h_to_kg_m2 * areatm(i,j)))</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    salt = <a class="code" href="interfacemom__coms_1_1reproducing__sum.html">reproducing_sum</a>(salt_int, efp_sum=salt_efp)</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    heat = <a class="code" href="interfacemom__coms_1_1reproducing__sum.html">reproducing_sum</a>(temp_int, efp_sum=heat_efp)</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160; </div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;<span class="comment">! Calculate the maximum CFL numbers.</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;  max_cfl(1:2) = 0.0</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=isq,ieq</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;    <span class="keywordflow">if</span> (u(i,j,k) &lt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;      cfl_trans = (-u(i,j,k) * us%s_to_T*cs%dt) * (g%dy_Cu(i,j) * g%IareaT(i+1,j))</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;      cfl_trans = (u(i,j,k) * us%s_to_T*cs%dt) * (g%dy_Cu(i,j) * g%IareaT(i,j))</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    cfl_lin = abs(u(i,j,k) * us%s_to_T*cs%dt) * g%IdxCu(i,j)</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    max_cfl(1) = max(max_cfl(1), cfl_trans)</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    max_cfl(2) = max(max_cfl(2), cfl_lin)</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=jsq,jeq ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordflow">if</span> (v(i,j,k) &lt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;      cfl_trans = (-v(i,j,k) * us%s_to_T*cs%dt) * (g%dx_Cv(i,j) * g%IareaT(i,j+1))</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;      cfl_trans = (v(i,j,k) * us%s_to_T*cs%dt) * (g%dx_Cv(i,j) * g%IareaT(i,j))</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    cfl_lin = abs(v(i,j,k) * us%s_to_T*cs%dt) * g%IdyCv(i,j)</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    max_cfl(1) = max(max_cfl(1), cfl_trans)</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    max_cfl(2) = max(max_cfl(2), cfl_lin)</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160; </div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;  <span class="keyword">call </span>sum_across_pes(cs%ntrunc)</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;  <span class="comment">!   Sum the various quantities across all the processors.  This sum is NOT</span></div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;  <span class="comment">! guaranteed to be bitwise reproducible, even on the same decomposition.</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;  <span class="comment">!   The sum of Tr_stocks should be reimplemented using the reproducing sums.</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;  <span class="keywordflow">if</span> (ntr_stocks &gt; 0) <span class="keyword">call </span>sum_across_pes(tr_stocks,ntr_stocks)</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160; </div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;  <span class="keyword">call </span>max_across_pes(max_cfl(1))</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;  <span class="keyword">call </span>max_across_pes(max_cfl(2))</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature .and. cs%previous_calls == 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    cs%salt_prev = salt ; cs%net_salt_input = 0.0</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    cs%heat_prev = heat ; cs%net_heat_input = 0.0</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160; </div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;    cs%salt_prev_EFP = salt_efp ; cs%net_salt_in_EFP = real_to_efp(0.0)</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    cs%heat_prev_EFP = heat_efp ; cs%net_heat_in_EFP = real_to_efp(0.0)</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;  irho0 = 1.0/gv%Rho0</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160; </div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    salt_chg_efp = salt_efp - cs%salt_prev_EFP</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    salt_anom_efp = salt_chg_efp - cs%net_salt_in_EFP</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    salt_chg = efp_to_real(salt_chg_efp) ; salt_anom = efp_to_real(salt_anom_efp)</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    heat_chg_efp = heat_efp - cs%heat_prev_EFP</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    heat_anom_efp = heat_chg_efp - cs%net_heat_in_EFP</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    heat_chg = efp_to_real(heat_chg_efp) ; heat_anom = efp_to_real(heat_anom_efp)</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160; </div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;  mass_chg_efp = mass_efp - cs%mass_prev_EFP</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;  salin_mass_in = 0.0</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;  <span class="keywordflow">if</span> (gv%Boussinesq) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    mass_anom_efp = mass_chg_efp - cs%fresh_water_in_EFP</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    <span class="comment">! net_salt_input needs to be converted from ppt m s-1 to kg m-2 s-1.</span></div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    mass_anom_efp = mass_chg_efp - cs%fresh_water_in_EFP</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    <span class="keywordflow">if</span> (cs%use_temperature) &amp;</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;      salin_mass_in = 0.001*efp_to_real(cs%net_salt_in_EFP)</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;  mass_chg = efp_to_real(mass_chg_efp)</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;  mass_anom = efp_to_real(mass_anom_efp) - salin_mass_in</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160; </div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    salin = salt / mass_tot ; salin_anom = salt_anom / mass_tot</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;   <span class="comment">! salin_chg = Salt_chg / mass_tot</span></div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    temp = heat / (mass_tot*tv%C_p) ; temp_anom = heat_anom / (mass_tot*tv%C_p)</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;  en_mass = toten / mass_tot</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160; </div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;  <span class="keyword">call </span>get_time(day, start_of_day, num_days)</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;  date_stamped = (cs%date_stamped_output .and. (get_calendar_type() /= no_calendar))</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;  <span class="keywordflow">if</span> (date_stamped) &amp;</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    <span class="keyword">call </span>get_date(day, iyear, imonth, iday, ihour, iminute, isecond, itick)</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;  <span class="keywordflow">if</span> (abs(cs%timeunit - 86400.0) &lt; 1.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    reday = real(num_days)+ (real(start_of_day)/86400.0)</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    mesg_intro = <span class="stringliteral">&quot;MOM Day &quot;</span></div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    reday = real(num_days)*(86400.0/cs%timeunit) + &amp;</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="keywordtype">            REAL</span>(start_of_day)/abs(CS%timeunit)</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    mesg_intro = <span class="stringliteral">&quot;MOM Time &quot;</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;  <span class="keywordflow">if</span> (reday &lt; 1.0e8) <span class="keywordflow">then</span> ;      <span class="keyword">write</span>(day_str, <span class="stringliteral">&#39;(F12.3)&#39;</span>) reday</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;  <span class="keywordflow">elseif</span> (reday &lt; 1.0e11) <span class="keywordflow">then</span> ; <span class="keyword">write</span>(day_str, <span class="stringliteral">&#39;(F15.3)&#39;</span>) reday</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;  <span class="keywordflow">else</span> ;                         <span class="keyword">write</span>(day_str, <span class="stringliteral">&#39;(ES15.9)&#39;</span>) reday ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160; </div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;  <span class="keywordflow">if</span>     (n &lt; 1000000)   <span class="keywordflow">then</span> ; <span class="keyword">write</span>(n_str, <span class="stringliteral">&#39;(I6)&#39;</span>)  n</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;  <span class="keywordflow">elseif</span> (n &lt; 10000000)  <span class="keywordflow">then</span> ; <span class="keyword">write</span>(n_str, <span class="stringliteral">&#39;(I7)&#39;</span>)  n</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;  <span class="keywordflow">elseif</span> (n &lt; 100000000) <span class="keywordflow">then</span> ; <span class="keyword">write</span>(n_str, <span class="stringliteral">&#39;(I8)&#39;</span>)  n</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;  <span class="keywordflow">else</span>                        ; <span class="keyword">write</span>(n_str, <span class="stringliteral">&#39;(I10)&#39;</span>) n ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160; </div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;  <span class="keywordflow">if</span> (date_stamped) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    <span class="keyword">write</span>(date_str,<span class="stringliteral">&#39;(&quot;MOM Date&quot;,i7,2(&quot;/&quot;,i2.2),&quot; &quot;,i2.2,2(&quot;:&quot;,i2.2))&#39;</span>) &amp;</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;       iyear, imonth, iday, ihour, iminute, isecond</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    date_str = trim(mesg_intro)//trim(day_str)</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160; </div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;  <span class="keywordflow">if</span> (is_root_pe()) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;        <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(A,&quot; &quot;,A,&quot;: En &quot;,ES12.6, &quot;, MaxCFL &quot;, F8.5, &quot;, Mass &quot;, &amp;</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp; ES18.12, &quot;, Salt &quot;, F15.11,&quot;, Temp &quot;, F15.11)&#39;</span>) &amp;</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;          trim(date_str), trim(n_str), en_mass, max_cfl(1), mass_tot, salin, temp</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;        <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(A,&quot; &quot;,A,&quot;: En &quot;,ES12.6, &quot;, MaxCFL &quot;, F8.5, &quot;, Mass &quot;, &amp;</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp; ES18.12)&#39;</span>) &amp;</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;          trim(date_str), trim(n_str), en_mass, max_cfl(1), mass_tot</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160; </div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;      <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(A,&quot;,&quot;,A,&quot;,&quot;, I6,&quot;, En &quot;,ES22.16, &amp;</span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                               &amp;&quot;, CFL &quot;, F8.5, &quot;, SL &quot;,&amp;</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                               &amp;es11.4,&quot;, M &quot;,ES11.5,&quot;, S&quot;,f8.4,&quot;, T&quot;,f8.4,&amp;</span></div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                               &amp;&quot;, Me &quot;,ES9.2,&quot;, Se &quot;,ES9.2,&quot;, Te &quot;,ES9.2)&#39;</span>) &amp;</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;            trim(n_str), trim(day_str), cs%ntrunc, en_mass, max_cfl(1), &amp;</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;            -h_0ape(1), mass_tot, salin, temp, mass_anom/mass_tot, salin_anom, &amp;</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;            temp_anom</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;      <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(A,&quot;,&quot;,A,&quot;,&quot;, I6,&quot;, En &quot;,ES22.16, &amp;</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                                &amp;&quot;, CFL &quot;, F8.5, &quot;, SL &quot;,&amp;</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                                  &amp;ES11.4,&quot;, Mass &quot;,ES11.5,&quot;, Me &quot;,ES9.2)&#39;</span>) &amp;</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;            trim(n_str), trim(day_str), cs%ntrunc, en_mass, max_cfl(1), &amp;</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;            -h_0ape(1), mass_tot, mass_anom/mass_tot</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160; </div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <span class="keywordflow">if</span> (cs%ntrunc &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;      <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(A,&quot; Energy/Mass:&quot;,ES12.5,&quot; Truncations &quot;,I0)&#39;</span>) &amp;</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;        trim(date_str), en_mass, cs%ntrunc</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160; </div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    <span class="keywordflow">if</span> (cs%write_stocks) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;      <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(&quot;    Total Energy: &quot;,Z16.16,ES24.16)&#39;</span>) toten, toten</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;      <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(&quot;    Total Mass: &quot;,ES24.16,&quot;, Change: &quot;,ES24.16,&quot; Error: &quot;,ES12.5,&quot; (&quot;,ES8.1,&quot;)&quot;)&#39;</span>) &amp;</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;            mass_tot, mass_chg, mass_anom, mass_anom/mass_tot</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;      <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;        <span class="keywordflow">if</span> (salt == 0.) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;          <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(&quot;    Total Salt: &quot;,ES24.16,&quot;, Change: &quot;,ES24.16,&quot; Error: &quot;,ES12.5)&#39;</span>) &amp;</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;              salt*0.001, salt_chg*0.001, salt_anom*0.001</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;          <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(&quot;    Total Salt: &quot;,ES24.16,&quot;, Change: &quot;,ES24.16,&quot; Error: &quot;,ES12.5,&quot; (&quot;,ES8.1,&quot;)&quot;)&#39;</span>) &amp;</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;              salt*0.001, salt_chg*0.001, salt_anom*0.001, salt_anom/salt</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;        <span class="keywordflow">if</span> (heat == 0.) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;          <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(&quot;    Total Heat: &quot;,ES24.16,&quot;, Change: &quot;,ES24.16,&quot; Error: &quot;,ES12.5)&#39;</span>) &amp;</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;              heat, heat_chg, heat_anom</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;          <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(&quot;    Total Heat: &quot;,ES24.16,&quot;, Change: &quot;,ES24.16,&quot; Error: &quot;,ES12.5,&quot; (&quot;,ES8.1,&quot;)&quot;)&#39;</span>) &amp;</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;              heat, heat_chg, heat_anom, heat_anom/heat</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;      <span class="keywordflow">do</span> m=1,ntr_stocks</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160; </div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;         <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(&quot;      Total &quot;,a,&quot;: &quot;,ES24.16,X,a)&#39;</span>) &amp;</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;              trim(tr_names(m)), tr_stocks(m), trim(tr_units(m))</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160; </div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;         <span class="keywordflow">if</span> (tr_minmax_got(m)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;           <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(64X,&quot;Global Min:&quot;,ES24.16,X,&quot;at: (&quot;, f7.2,&quot;,&quot;f7.2,&quot;,&quot;f8.2,&quot;)&quot;  )&#39;</span>) &amp;</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;                tr_min(m),tr_min_x(m),tr_min_y(m),tr_min_z(m)</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;           <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(64X,&quot;Global Max:&quot;,ES24.16,X,&quot;at: (&quot;, f7.2,&quot;,&quot;f7.2,&quot;,&quot;f8.2,&quot;)&quot;  )&#39;</span>) &amp;</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;                tr_max(m),tr_max_x(m),tr_max_y(m),tr_max_z(m)</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160; </div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160; </div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;  var = real(cs%ntrunc)</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(1), var, reday)</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(2), toten, reday)</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(3), pe, reday)</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(4), ke, reday)</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(5), h_0ape, reday)</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(6), mass_lay, reday)</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160; </div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(7), mass_tot, reday)</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(8), mass_chg, reday)</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(9), mass_anom, reday)</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(10), max_cfl(1), reday)</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(11), max_cfl(1), reday)</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(12), 0.001*salt, reday)</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(13), 0.001*salt_chg, reday)</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(14), 0.001*salt_anom, reday)</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(15), heat, reday)</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(16), heat_chg, reday)</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(17), heat_anom, reday)</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    <span class="keywordflow">do</span> m=1,ntr_stocks</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;      <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(17+m), tr_stocks(m), reday)</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    <span class="keywordflow">do</span> m=1,ntr_stocks</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;      <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(11+m), tr_stocks(m), reday)</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160; </div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;  <span class="keyword">call </span>flush_file(cs%fileenergy_nc)</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160; </div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;  <span class="comment">! The second (impossible-looking) test looks for a NaN in En_mass.</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;  <span class="keywordflow">if</span> ((en_mass&gt;cs%max_Energy) .or. &amp;</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;     ((en_mass&gt;cs%max_Energy) .and. (en_mass&lt;cs%max_Energy))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;    <span class="keyword">write</span>(mesg,<span class="stringliteral">&#39;(&quot;Energy per unit mass of &quot;,ES11.4,&quot; exceeds &quot;,ES11.4)&#39;</span>) &amp;</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;                  en_mass, cs%max_Energy</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;      <span class="stringliteral">&quot;write_energy : Excessive energy per unit mass or NaNs forced model termination.&quot;</span>)</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;  <span class="keywordflow">if</span> (cs%ntrunc&gt;cs%maxtrunc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;write_energy : Ocean velocity has been truncated too many times.&quot;</span>)</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;  cs%ntrunc = 0</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;  cs%previous_calls = cs%previous_calls + 1</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;  cs%mass_prev = mass_tot ; cs%fresh_water_input = 0.0</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    cs%salt_prev = salt ; cs%net_salt_input = 0.0</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    cs%heat_prev = heat ; cs%net_heat_input = 0.0</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160; </div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;  cs%mass_prev_EFP = mass_efp ; cs%fresh_water_in_EFP = real_to_efp(0.0)</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    cs%salt_prev_EFP = salt_efp ; cs%net_salt_in_EFP = real_to_efp(0.0)</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    cs%heat_prev_EFP = heat_efp ; cs%net_heat_in_EFP = real_to_efp(0.0)</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;<span class="keywordflow">  endif</span></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__tracer__flow__control_8F90_source.html#l00574">mom_tracer_flow_control::call_tracer_stocks()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00044">mom_error_handler::is_root_pe()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__open__boundary_8F90_source.html#l00065">mom_open_boundary::obc_direction_e</a>, <a class="el" href="MOM__open__boundary_8F90_source.html#l00063">mom_open_boundary::obc_direction_n</a>, <a class="el" href="MOM__open__boundary_8F90_source.html#l00064">mom_open_boundary::obc_direction_s</a>, and <a class="el" href="MOM__open__boundary_8F90_source.html#l00066">mom_open_boundary::obc_direction_w</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_ad3cc692dd515100ec8cf92d740c91e72_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="af8db0fa8cff32727c5f23cc328b67a7c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af8db0fa8cff32727c5f23cc328b67a7c">&#9670;&nbsp;</a></span>area_chksum_attr</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> (*), parameter mom_sum_output::area_chksum_attr = &quot;mask2dT_areaT_checksum&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Checksum attribute of name of Gmask2dT * GareaT over the compute domain. </p>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l00047">47</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment">character (*), parameter :: area_chksum_attr = &quot;mask2dT_areaT_checksum&quot;</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__sum__output_8F90_source.html#l01321">read_depth_list()</a>, and <a class="el" href="MOM__sum__output_8F90_source.html#l01226">write_depth_list()</a>.</p>

</div>
</div>
<a id="a4502602fe6c41088fc5a7f658070b386"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4502602fe6c41088fc5a7f658070b386">&#9670;&nbsp;</a></span>depth_chksum_attr</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> (*), parameter mom_sum_output::depth_chksum_attr = &quot;bathyT_checksum&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Checksum attribute name of GbathyT over the compute domain. </p>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l00044">44</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">character (*), parameter :: depth_chksum_attr = &quot;bathyT_checksum&quot;</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__sum__output_8F90_source.html#l01321">read_depth_list()</a>, and <a class="el" href="MOM__sum__output_8F90_source.html#l01226">write_depth_list()</a>.</p>

</div>
</div>
<a id="a5191c3198dcd24f50da9279ce7ebbc60"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5191c3198dcd24f50da9279ce7ebbc60">&#9670;&nbsp;</a></span>num_fields</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_sum_output::num_fields = 17</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Number of diagnostic fields. </p>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l00043">43</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: NUM_FIELDS = 17<span class="comment"> !&lt; Number of diagnostic fields</span></div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="ainterfacemom__coms_1_1reproducing__sum_html"><div class="ttname"><a href="interfacemom__coms_1_1reproducing__sum.html">mom_coms::reproducing_sum</a></div><div class="ttdoc">Find an accurate and order-invariant sum of distributed 2d or 3d fields.</div><div class="ttdef"><b>Definition:</b> <a href="MOM__coms_8F90_source.html#l00054">MOM_coms.F90:54</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__sum__output.html">mom_sum_output</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
