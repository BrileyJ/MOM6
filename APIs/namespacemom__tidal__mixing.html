<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_tidal_mixing Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('namespacemom__tidal__mixing.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a>  </div>
  <div class="headertitle">
<div class="title">mom_tidal_mixing Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Interface to vertical tidal mixing schemes including CVMix tidal mixing. </p>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__tidal__mixing_1_1tidal__mixing__cs.html">tidal_mixing_cs</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Control structure with parameters for the tidal mixing module.  <a href="structmom__tidal__mixing_1_1tidal__mixing__cs.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__tidal__mixing_1_1tidal__mixing__diags.html">tidal_mixing_diags</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Containers for tidal mixing diagnostics.  <a href="structmom__tidal__mixing_1_1tidal__mixing__diags.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a925ef652b1932e881b0f10e3d2fe17fa"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=40)&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#a925ef652b1932e881b0f10e3d2fe17fa">mdl</a> = &quot;MOM_tidal_mixing&quot;</td></tr>
<tr class="memdesc:a925ef652b1932e881b0f10e3d2fe17fa"><td class="mdescLeft">&#160;</td><td class="mdescRight">This module's name.  <a href="namespacemom__tidal__mixing.html#a925ef652b1932e881b0f10e3d2fe17fa">More...</a><br /></td></tr>
<tr class="separator:a925ef652b1932e881b0f10e3d2fe17fa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7d67c30f468c9f4c8d97bfe2e3341bff"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(20), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#a7d67c30f468c9f4c8d97bfe2e3341bff">stlaurent_profile_string</a> = &quot;STLAURENT_02&quot;</td></tr>
<tr class="memdesc:a7d67c30f468c9f4c8d97bfe2e3341bff"><td class="mdescLeft">&#160;</td><td class="mdescRight">This module's name.  <a href="namespacemom__tidal__mixing.html#a7d67c30f468c9f4c8d97bfe2e3341bff">More...</a><br /></td></tr>
<tr class="separator:a7d67c30f468c9f4c8d97bfe2e3341bff"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab6b1348f160c8cab37a087b10cf11e7f"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(20), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#ab6b1348f160c8cab37a087b10cf11e7f">polzin_profile_string</a> = &quot;POLZIN_09&quot;</td></tr>
<tr class="memdesc:ab6b1348f160c8cab37a087b10cf11e7f"><td class="mdescLeft">&#160;</td><td class="mdescRight">This module's name.  <a href="namespacemom__tidal__mixing.html#ab6b1348f160c8cab37a087b10cf11e7f">More...</a><br /></td></tr>
<tr class="separator:ab6b1348f160c8cab37a087b10cf11e7f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a507b1bb394ac4788c09657334b682297"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#a507b1bb394ac4788c09657334b682297">stlaurent_02</a> = 1</td></tr>
<tr class="memdesc:a507b1bb394ac4788c09657334b682297"><td class="mdescLeft">&#160;</td><td class="mdescRight">This module's name.  <a href="namespacemom__tidal__mixing.html#a507b1bb394ac4788c09657334b682297">More...</a><br /></td></tr>
<tr class="separator:a507b1bb394ac4788c09657334b682297"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afed6c5ada4d2eeb610c5c87029d36ac3"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#afed6c5ada4d2eeb610c5c87029d36ac3">polzin_09</a> = 2</td></tr>
<tr class="memdesc:afed6c5ada4d2eeb610c5c87029d36ac3"><td class="mdescLeft">&#160;</td><td class="mdescRight">This module's name.  <a href="namespacemom__tidal__mixing.html#afed6c5ada4d2eeb610c5c87029d36ac3">More...</a><br /></td></tr>
<tr class="separator:afed6c5ada4d2eeb610c5c87029d36ac3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a264f090d7416d0fa6542e7ba51299cbd"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(20), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#a264f090d7416d0fa6542e7ba51299cbd">simmons_scheme_string</a> = &quot;SIMMONS&quot;</td></tr>
<tr class="memdesc:a264f090d7416d0fa6542e7ba51299cbd"><td class="mdescLeft">&#160;</td><td class="mdescRight">This module's name.  <a href="namespacemom__tidal__mixing.html#a264f090d7416d0fa6542e7ba51299cbd">More...</a><br /></td></tr>
<tr class="separator:a264f090d7416d0fa6542e7ba51299cbd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa77238da241cd9c94f24a9bd8d3b2fe1"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(20), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#aa77238da241cd9c94f24a9bd8d3b2fe1">schmittner_scheme_string</a> = &quot;SCHMITTNER&quot;</td></tr>
<tr class="memdesc:aa77238da241cd9c94f24a9bd8d3b2fe1"><td class="mdescLeft">&#160;</td><td class="mdescRight">This module's name.  <a href="namespacemom__tidal__mixing.html#aa77238da241cd9c94f24a9bd8d3b2fe1">More...</a><br /></td></tr>
<tr class="separator:aa77238da241cd9c94f24a9bd8d3b2fe1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4e093041fb72f388f962e7a1091c55bf"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#a4e093041fb72f388f962e7a1091c55bf">simmons</a> = 1</td></tr>
<tr class="memdesc:a4e093041fb72f388f962e7a1091c55bf"><td class="mdescLeft">&#160;</td><td class="mdescRight">This module's name.  <a href="namespacemom__tidal__mixing.html#a4e093041fb72f388f962e7a1091c55bf">More...</a><br /></td></tr>
<tr class="separator:a4e093041fb72f388f962e7a1091c55bf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a96e82abebc8049e136886af73ae99906"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#a96e82abebc8049e136886af73ae99906">schmittner</a> = 2</td></tr>
<tr class="memdesc:a96e82abebc8049e136886af73ae99906"><td class="mdescLeft">&#160;</td><td class="mdescRight">This module's name.  <a href="namespacemom__tidal__mixing.html#a96e82abebc8049e136886af73ae99906">More...</a><br /></td></tr>
<tr class="separator:a96e82abebc8049e136886af73ae99906"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6278fe41ef74ac23ba02ae1540104c5f"><td class="memItemLeft" align="right" valign="top">logical function, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#a6278fe41ef74ac23ba02ae1540104c5f">tidal_mixing_init</a> (Time, G, GV, US, param_file, diag, CS)</td></tr>
<tr class="memdesc:a6278fe41ef74ac23ba02ae1540104c5f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initializes internal tidal dissipation scheme for diapycnal mixing.  <a href="namespacemom__tidal__mixing.html#a6278fe41ef74ac23ba02ae1540104c5f">More...</a><br /></td></tr>
<tr class="separator:a6278fe41ef74ac23ba02ae1540104c5f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abf084268fd9c71f20880838d2bce7e3e"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#abf084268fd9c71f20880838d2bce7e3e">calculate_tidal_mixing</a> (h, N2_bot, j, TKE_to_Kd, max_TKE, G, GV, US, CS, N2_lay, N2_int, Kd_lay, Kd_int, Kd_max, Kv)</td></tr>
<tr class="memdesc:abf084268fd9c71f20880838d2bce7e3e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Depending on whether or not CVMix is active, calls the associated subroutine to compute internal tidal dissipation and to add the effect of internal-tide-driven mixing to the layer or interface diffusivities.  <a href="namespacemom__tidal__mixing.html#abf084268fd9c71f20880838d2bce7e3e">More...</a><br /></td></tr>
<tr class="separator:abf084268fd9c71f20880838d2bce7e3e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aef4b9f3c4ceece52a1cebe1bbee66988"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#aef4b9f3c4ceece52a1cebe1bbee66988">calculate_cvmix_tidal</a> (h, j, G, GV, US, CS, N2_int, Kd_lay, Kv)</td></tr>
<tr class="memdesc:aef4b9f3c4ceece52a1cebe1bbee66988"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calls the CVMix routines to compute tidal dissipation and to add the effect of internal-tide-driven mixing to the interface diffusivities.  <a href="namespacemom__tidal__mixing.html#aef4b9f3c4ceece52a1cebe1bbee66988">More...</a><br /></td></tr>
<tr class="separator:aef4b9f3c4ceece52a1cebe1bbee66988"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa8f8da6657f71aaef15f3cbe4e5f521d"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#aa8f8da6657f71aaef15f3cbe4e5f521d">add_int_tide_diffusivity</a> (h, N2_bot, j, TKE_to_Kd, max_TKE, G, GV, US, CS, N2_lay, Kd_lay, Kd_int, Kd_max)</td></tr>
<tr class="memdesc:aa8f8da6657f71aaef15f3cbe4e5f521d"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine adds the effect of internal-tide-driven mixing to the layer diffusivities. The mechanisms considered are (1) local dissipation of internal waves generated by the barotropic flow ("itidal"), (2) local dissipation of internal waves generated by the propagating low modes (rays) of the internal tide ("lowmode"), and (3) local dissipation of internal lee waves. Will eventually need to add diffusivity due to other wave-breaking processes (e.g. Bottom friction, Froude-number-depending breaking, PSI, etc.).  <a href="namespacemom__tidal__mixing.html#aa8f8da6657f71aaef15f3cbe4e5f521d">More...</a><br /></td></tr>
<tr class="separator:aa8f8da6657f71aaef15f3cbe4e5f521d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7d2dfb64df35957d1252ce841c0cdf43"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#a7d2dfb64df35957d1252ce841c0cdf43">setup_tidal_diagnostics</a> (G, CS)</td></tr>
<tr class="memdesc:a7d2dfb64df35957d1252ce841c0cdf43"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sets up diagnostics arrays for tidal mixing.  <a href="namespacemom__tidal__mixing.html#a7d2dfb64df35957d1252ce841c0cdf43">More...</a><br /></td></tr>
<tr class="separator:a7d2dfb64df35957d1252ce841c0cdf43"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af6fabb2bc6e4aabd3187938bda8098ec"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#af6fabb2bc6e4aabd3187938bda8098ec">post_tidal_diagnostics</a> (G, GV, h, CS)</td></tr>
<tr class="memdesc:af6fabb2bc6e4aabd3187938bda8098ec"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine offers up diagnostics of the tidal mixing.  <a href="namespacemom__tidal__mixing.html#af6fabb2bc6e4aabd3187938bda8098ec">More...</a><br /></td></tr>
<tr class="separator:af6fabb2bc6e4aabd3187938bda8098ec"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adfd3a137ee6402fdcdfb7c46711e0e23"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#adfd3a137ee6402fdcdfb7c46711e0e23">read_tidal_energy</a> (G, US, tidal_energy_type, tidal_energy_file, CS)</td></tr>
<tr class="memdesc:adfd3a137ee6402fdcdfb7c46711e0e23"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine read tidal energy inputs from a file.  <a href="namespacemom__tidal__mixing.html#adfd3a137ee6402fdcdfb7c46711e0e23">More...</a><br /></td></tr>
<tr class="separator:adfd3a137ee6402fdcdfb7c46711e0e23"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a30a24b88982a5134253679d9484b3708"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#a30a24b88982a5134253679d9484b3708">read_tidal_constituents</a> (G, US, tidal_energy_file, CS)</td></tr>
<tr class="memdesc:a30a24b88982a5134253679d9484b3708"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine reads tidal input energy from a file by constituent.  <a href="namespacemom__tidal__mixing.html#a30a24b88982a5134253679d9484b3708">More...</a><br /></td></tr>
<tr class="separator:a30a24b88982a5134253679d9484b3708"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4ec08e118dea2ecbac7e719ed73acc70"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tidal__mixing.html#a4ec08e118dea2ecbac7e719ed73acc70">tidal_mixing_end</a> (CS)</td></tr>
<tr class="memdesc:a4ec08e118dea2ecbac7e719ed73acc70"><td class="mdescLeft">&#160;</td><td class="mdescRight">Clear pointers and deallocate memory.  <a href="namespacemom__tidal__mixing.html#a4ec08e118dea2ecbac7e719ed73acc70">More...</a><br /></td></tr>
<tr class="separator:a4ec08e118dea2ecbac7e719ed73acc70"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="aa8f8da6657f71aaef15f3cbe4e5f521d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa8f8da6657f71aaef15f3cbe4e5f521d">&#9670;&nbsp;</a></span>add_int_tide_diffusivity()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_tidal_mixing::add_int_tide_diffusivity </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied), intent(in)&#160;</td>
          <td class="paramname"><em>N2_bot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>TKE_to_Kd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>max_TKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__tidal__mixing_1_1tidal__mixing__cs.html">tidal_mixing_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>N2_lay</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>Kd_lay</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke+1), intent(inout), optional&#160;</td>
          <td class="paramname"><em>Kd_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Kd_max</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine adds the effect of internal-tide-driven mixing to the layer diffusivities. The mechanisms considered are (1) local dissipation of internal waves generated by the barotropic flow ("itidal"), (2) local dissipation of internal waves generated by the propagating low modes (rays) of the internal tide ("lowmode"), and (3) local dissipation of internal lee waves. Will eventually need to add diffusivity due to other wave-breaking processes (e.g. Bottom friction, Froude-number-depending breaking, PSI, etc.). </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n2_bot</td><td>The near-bottom squared buoyancy frequency frequency [T-2 ~&gt; s-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n2_lay</td><td>The squared buoyancy frequency of the layers [T-2 ~&gt; s-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>The j-index to work on </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tke_to_kd</td><td>The conversion rate between the TKE dissipated within a layer and the diapycnal diffusivity within that layer, usually (~Rho_0 / (G_Earth * dRho_lay)) [Z2 T-1 / Z3 T-3 = T2 Z-1 ~&gt; s2 m-1] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">max_tke</td><td>The energy required to for a layer to entrain to its maximum realizable thickness [Z3 T-3 ~&gt; m3 s-3] </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure for this module </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">kd_lay</td><td>The diapycnal diffusvity in layers [Z2 T-1 ~&gt; m2 s-1]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">kd_int</td><td>The diapycnal diffusvity at interfaces </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">kd_max</td><td>The maximum increment for diapycnal diffusivity due to TKE-based processes [Z2 s-1 ~&gt; m2 s-1]. Set this to a negative value to have no limit. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00917">917</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),            <span class="keywordtype">intent(in)</span>    :: G<span class="comment">      !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type),          <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">     !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),            <span class="keywordtype">intent(in)</span>    :: US<span class="comment">     !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                                    <span class="keywordtype">intent(in)</span>    :: h<span class="comment">      !&lt; Layer thicknesses [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,         <span class="keywordtype">intent(in)</span>    :: N2_bot<span class="comment"> !&lt; The near-bottom squared buoyancy frequency</span></div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;<span class="comment">                                                            !! frequency [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: N2_lay<span class="comment"> !&lt; The squared buoyancy frequency of the</span></div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;<span class="comment">                                                            !! layers [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;  <span class="keywordtype">integer</span>,                          <span class="keywordtype">intent(in)</span>    :: j<span class="comment">      !&lt; The j-index to work on</span></div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: TKE_to_Kd<span class="comment"> !&lt; The conversion rate between the TKE</span></div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;<span class="comment">                                                            !! dissipated within a layer and the</span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;<span class="comment">                                                            !! diapycnal diffusivity within that layer,</span></div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;<span class="comment">                                                            !! usually (~Rho_0 / (G_Earth * dRho_lay))</span></div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;<span class="comment">                                                            !! [Z2 T-1 / Z3 T-3 = T2 Z-1 ~&gt; s2 m-1]</span></div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: max_TKE<span class="comment"> !&lt; The energy required to for a layer to entrain</span></div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;<span class="comment">                                                            !! to its maximum realizable thickness [Z3 T-3 ~&gt; m3 s-3]</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;  <span class="keywordtype">type</span>(tidal_mixing_cs),            <span class="keywordtype">pointer</span>       :: CS<span class="comment">     !&lt; The control structure for this module</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;                                    <span class="keywordtype">intent(inout)</span> :: Kd_lay<span class="comment"> !&lt; The diapycnal diffusvity in layers [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>, &amp;</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;                          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(inout)</span> :: Kd_int<span class="comment"> !&lt; The diapycnal diffusvity at interfaces</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;<span class="comment">                                                            !! [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;<span class="keywordtype">  real</span>,                             <span class="keywordtype">intent(in)</span>    :: Kd_max<span class="comment"> !&lt; The maximum increment for diapycnal</span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="comment">                                                            !! diffusivity due to TKE-based processes</span></div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="comment">                                                            !! [Z2 s-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;<span class="comment">                                                            !! Set this to a negative value to have no limit.</span></div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160; </div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;  <span class="comment">! local</span></div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160; </div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;    htot,             &amp; <span class="comment">! total thickness above or below a layer, or the</span></div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;                        <span class="comment">! integrated thickness in the BBL [Z ~&gt; m].</span></div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;    htot_wkb,         &amp; <span class="comment">! WKB scaled distance from top to bottom [Z ~&gt; m].</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    tke_itidal_bot,   &amp; <span class="comment">! internal tide TKE at ocean bottom [Z3 T-3 ~&gt; m3 s-3]</span></div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    tke_niku_bot,     &amp; <span class="comment">! lee-wave TKE at ocean bottom [Z3 T-3 ~&gt; m3 s-3]</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;    tke_lowmode_bot,  &amp; <span class="comment">! internal tide TKE at ocean bottom lost from all remote low modes [Z3 T-3 ~&gt; m3 s-3] (BDM)</span></div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;    inv_int,          &amp; <span class="comment">! inverse of TKE decay for int tide over the depth of the ocean [nondim]</span></div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;    inv_int_lee,      &amp; <span class="comment">! inverse of TKE decay for lee waves over the depth of the ocean [nondim]</span></div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    inv_int_low,      &amp; <span class="comment">! inverse of TKE decay for low modes over the depth of the ocean [nondim] (BDM)</span></div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;    z0_polzin,        &amp; <span class="comment">! TKE decay scale in Polzin formulation [Z ~&gt; m].</span></div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    z0_polzin_scaled, &amp; <span class="comment">! TKE decay scale in Polzin formulation [Z ~&gt; m].</span></div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;                        <span class="comment">! multiplied by N2_bot/N2_meanz to be coherent with the WKB scaled z</span></div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;                        <span class="comment">! z*=int(N2/N2_bot) * N2_bot/N2_meanz = int(N2/N2_meanz)</span></div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;                        <span class="comment">! z0_Polzin_scaled = z0_Polzin * N2_bot/N2_meanz</span></div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    n2_meanz,         &amp; <span class="comment">! vertically averaged squared buoyancy frequency [s-2] for WKB scaling</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;    tke_itidal_rem,   &amp; <span class="comment">! remaining internal tide TKE (from barotropic source) [Z3 T-3 ~&gt; m3 s-3]</span></div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    tke_niku_rem,     &amp; <span class="comment">! remaining lee-wave TKE [Z3 T-3 ~&gt; m3 s-3]</span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    tke_lowmode_rem,  &amp; <span class="comment">! remaining internal tide TKE (from propagating low mode source) [Z3 T-3 ~&gt; m3 s-3] (BDM)</span></div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    tke_frac_top,     &amp; <span class="comment">! fraction of bottom TKE that should appear at top of a layer [nondim]</span></div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;    tke_frac_top_lee, &amp; <span class="comment">! fraction of bottom TKE that should appear at top of a layer [nondim]</span></div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;    tke_frac_top_lowmode, &amp;</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;                        <span class="comment">! fraction of bottom TKE that should appear at top of a layer [nondim] (BDM)</span></div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;    z_from_bot,       &amp; <span class="comment">! distance from bottom [Z ~&gt; m].</span></div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;    z_from_bot_wkb      <span class="comment">! WKB scaled distance from bottom [Z ~&gt; m].</span></div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160; </div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;<span class="keywordtype">  real</span> :: I_rho0        <span class="comment">! 1 / RHO0 [m3 kg-1]</span></div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;<span class="keywordtype">  real</span> :: Kd_add        <span class="comment">! diffusivity to add in a layer [Z2 s-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;<span class="keywordtype">  real</span> :: TKE_itide_lay <span class="comment">! internal tide TKE imparted to a layer (from barotropic) [Z3 T-3 ~&gt; m3 s-3]</span></div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;<span class="keywordtype">  real</span> :: TKE_Niku_lay  <span class="comment">! lee-wave TKE imparted to a layer [Z3 T-3 ~&gt; m3 s-3]</span></div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;<span class="keywordtype">  real</span> :: TKE_lowmode_lay <span class="comment">! internal tide TKE imparted to a layer (from low mode) [Z3 T-3 ~&gt; m3 s-3] (BDM)</span></div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;<span class="keywordtype">  real</span> :: frac_used     <span class="comment">! fraction of TKE that can be used in a layer [nondim]</span></div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;<span class="keywordtype">  real</span> :: Izeta         <span class="comment">! inverse of TKE decay scale [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;<span class="keywordtype">  real</span> :: Izeta_lee     <span class="comment">! inverse of TKE decay scale for lee waves [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;<span class="keywordtype">  real</span> :: z0_psl        <span class="comment">! temporary variable [Z ~&gt; m].</span></div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;<span class="keywordtype">  real</span> :: TKE_lowmode_tot <span class="comment">! TKE from all low modes [kg Z3 m-3 T-3 ~&gt; W m-2] (BDM)</span></div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160; </div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;  <span class="keywordtype">logical</span> :: use_Polzin, use_Simmons</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;  <span class="keywordtype">character(len=160)</span> :: mesg  <span class="comment">! The text of an error message</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;  <span class="keywordtype">integer</span> :: i, k, is, ie, nz</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;  <span class="keywordtype">integer</span> :: a, fr, m</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;  <span class="keywordtype">type</span>(tidal_mixing_diags), <span class="keywordtype">pointer</span> :: dd =&gt; null()</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160; </div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;  is = g%isc ; ie = g%iec ; nz = g%ke</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;  dd =&gt; cs%dd</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160; </div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;  <span class="keywordflow">if</span> (.not.(cs%Int_tide_dissipation .or. cs%Lee_wave_dissipation)) <span class="keywordflow">return</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160; </div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; htot(i) = 0.0 ; inv_int(i) = 0.0 ; inv_int_lee(i) = 0.0 ; inv_int_low(i) = 0.0 ;<span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;    htot(i) = htot(i) + gv%H_to_Z*h(i,j,k)</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160; </div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;  i_rho0 = 1.0/gv%Rho0</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160; </div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;  use_polzin = ((cs%Int_tide_dissipation .and. (cs%int_tide_profile == polzin_09)) .or. &amp;</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;                (cs%lee_wave_dissipation .and. (cs%lee_wave_profile == polzin_09)) .or. &amp;</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;                (cs%Lowmode_itidal_dissipation .and. (cs%int_tide_profile == polzin_09)))</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;  use_simmons = ((cs%Int_tide_dissipation .and. (cs%int_tide_profile == stlaurent_02)) .or. &amp;</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                 (cs%lee_wave_dissipation .and. (cs%lee_wave_profile == stlaurent_02)) .or. &amp;</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                 (cs%Lowmode_itidal_dissipation .and. (cs%int_tide_profile == stlaurent_02)))</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160; </div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;  <span class="comment">! Calculate parameters for vertical structure of dissipation</span></div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;  <span class="comment">! Simmons:</span></div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;  <span class="keywordflow">if</span> ( use_simmons ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;    izeta = 1.0 / max(cs%Int_tide_decay_scale, gv%H_subroundoff*gv%H_to_Z)</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    izeta_lee = 1.0 / max(cs%Int_tide_decay_scale*cs%Decay_scale_factor_lee, &amp;</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                          gv%H_subroundoff*gv%H_to_Z)</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;      cs%Nb(i,j) = sqrt(us%s_to_T**2 * n2_bot(i))</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_bot)) dd%N2_bot(i,j) = us%s_to_T**2 * n2_bot(i)</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;      <span class="keywordflow">if</span> ( cs%Int_tide_dissipation ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;        <span class="keywordflow">if</span> (izeta*htot(i) &gt; 1.0e-14) <span class="keywordflow">then</span> <span class="comment">! L&#39;Hospital&#39;s version of Adcroft&#39;s reciprocal rule.</span></div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;          inv_int(i) = 1.0 / (1.0 - exp(-izeta*htot(i)))</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;      <span class="keywordflow">if</span> ( cs%Lee_wave_dissipation ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;        <span class="keywordflow">if</span> (izeta_lee*htot(i) &gt; 1.0e-14) <span class="keywordflow">then</span>  <span class="comment">! L&#39;Hospital&#39;s version of Adcroft&#39;s reciprocal rule.</span></div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;          inv_int_lee(i) = 1.0 / (1.0 - exp(-izeta_lee*htot(i)))</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;      <span class="keywordflow">if</span> ( cs%Lowmode_itidal_dissipation) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;        <span class="keywordflow">if</span> (izeta*htot(i) &gt; 1.0e-14) <span class="keywordflow">then</span> <span class="comment">! L&#39;Hospital&#39;s version of Adcroft&#39;s reciprocal rule.</span></div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;          inv_int_low(i) = 1.0 / (1.0 - exp(-izeta*htot(i)))</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;      z_from_bot(i) = gv%H_to_Z*h(i,j,nz)</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! Simmons</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160; </div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;  <span class="comment">! Polzin:</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;  <span class="keywordflow">if</span> ( use_polzin ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;    <span class="comment">! WKB scaling of the vertical coordinate</span></div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; n2_meanz(i)=0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;      n2_meanz(i) = n2_meanz(i) + (us%s_to_T**2 * n2_lay(i,k)) * gv%H_to_Z * h(i,j,k)</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;      n2_meanz(i) = n2_meanz(i) / (htot(i) + gv%H_subroundoff*gv%H_to_Z)</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_meanz))  dd%N2_meanz(i,j) = n2_meanz(i)</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160; </div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;    <span class="comment">! WKB scaled z*(z=H) z* at the surface using the modified Polzin WKB scaling</span></div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; htot_wkb(i) = htot(i) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;<span class="comment">!    do i=is,ie ; htot_WKB(i) = 0.0 ; enddo</span></div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="comment">!    do k=1,nz ; do i=is,ie</span></div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;<span class="comment">!      htot_WKB(i) = htot_WKB(i) + GV%H_to_Z*h(i,j,k) * (US%s_to_T**2 * N2_lay(i,k)) / N2_meanz(i)</span></div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;<span class="comment">!    enddo ; enddo</span></div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    <span class="comment">! htot_WKB(i) = htot(i) ! Nearly equivalent and simpler</span></div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160; </div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;      cs%Nb(i,j) = sqrt(us%s_to_T**2 * n2_bot(i))</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;      <span class="comment">!### In the code below 1.0e-14 is a dimensional constant in [s-3]</span></div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;      <span class="keywordflow">if</span> ((cs%tideamp(i,j) &gt; 0.0) .and. &amp;</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;          (cs%kappa_itides**2 * cs%h2(i,j) * cs%Nb(i,j)**3 &gt; 1.0e-14) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        z0_polzin(i) = cs%Polzin_decay_scale_factor * cs%Nu_Polzin * &amp;</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;                       cs%Nbotref_Polzin**2 * cs%tideamp(i,j) / &amp;</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;                     ( cs%kappa_itides**2 * cs%h2(i,j) * us%T_to_s * cs%Nb(i,j)**3 )</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;        <span class="keywordflow">if</span> (z0_polzin(i) &lt; cs%Polzin_min_decay_scale) &amp;</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;          z0_polzin(i) = cs%Polzin_min_decay_scale</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;        <span class="keywordflow">if</span> (n2_meanz(i) &gt; 1.0e-14  ) <span class="keywordflow">then</span>  <span class="comment">!### Here 1.0e-14 has dimensions of s-2.</span></div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;          z0_polzin_scaled(i) = z0_polzin(i)*cs%Nb(i,j)**2 / n2_meanz(i)</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;          z0_polzin_scaled(i) = cs%Polzin_decay_scale_max_factor * htot(i)</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;        <span class="keywordflow">if</span> (z0_polzin_scaled(i) &gt; (cs%Polzin_decay_scale_max_factor * htot(i)) ) &amp;</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;          z0_polzin_scaled(i) = cs%Polzin_decay_scale_max_factor * htot(i)</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;        z0_polzin(i) = cs%Polzin_decay_scale_max_factor * htot(i)</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;        z0_polzin_scaled(i) = cs%Polzin_decay_scale_max_factor * htot(i)</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160; </div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Polzin_decay_scale)) &amp;</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;        dd%Polzin_decay_scale(i,j) = z0_polzin(i)</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Polzin_decay_scale_scaled)) &amp;</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;        dd%Polzin_decay_scale_scaled(i,j) = z0_polzin_scaled(i)</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_bot)) dd%N2_bot(i,j) = cs%Nb(i,j)*cs%Nb(i,j)</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160; </div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;      <span class="keywordflow">if</span> ( cs%Int_tide_dissipation .and. (cs%int_tide_profile == polzin_09) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        <span class="comment">! For the Polzin formulation, this if loop prevents the vertical</span></div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;        <span class="comment">! flux of energy dissipation from having NaN values</span></div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;        <span class="keywordflow">if</span> (htot_wkb(i) &gt; 1.0e-14*us%m_to_Z) <span class="keywordflow">then</span>  <span class="comment">!### Avoid using this dimensional constant.</span></div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;          inv_int(i) = ( z0_polzin_scaled(i) / htot_wkb(i) ) + 1.0</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;      <span class="keywordflow">if</span> ( cs%lee_wave_dissipation .and. (cs%lee_wave_profile == polzin_09) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;        <span class="comment">! For the Polzin formulation, this if loop prevents the vertical</span></div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;        <span class="comment">! flux of energy dissipation from having NaN values</span></div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;        <span class="keywordflow">if</span> (htot_wkb(i) &gt; 1.0e-14*us%m_to_Z) <span class="keywordflow">then</span> <span class="comment">!### Avoid using this dimensional constant.</span></div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;          inv_int_lee(i) = ( z0_polzin_scaled(i)*cs%Decay_scale_factor_lee / htot_wkb(i) ) + 1.0</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;      <span class="keywordflow">if</span> ( cs%Lowmode_itidal_dissipation .and. (cs%int_tide_profile == polzin_09) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;        <span class="comment">! For the Polzin formulation, this if loop prevents the vertical</span></div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;        <span class="comment">! flux of energy dissipation from having NaN values</span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;        <span class="keywordflow">if</span> (htot_wkb(i) &gt; 1.0e-14*us%m_to_Z) <span class="keywordflow">then</span> <span class="comment">!### Avoid using this dimensional constant.</span></div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;          inv_int_low(i) = ( z0_polzin_scaled(i) / htot_wkb(i) ) + 1.0</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160; </div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;      z_from_bot(i) = gv%H_to_Z*h(i,j,nz)</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;      <span class="comment">! Use the new formulation for WKB scaling.  N2 is referenced to its vertical mean.</span></div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;      <span class="keywordflow">if</span> (n2_meanz(i) &gt; 1.0e-14 ) <span class="keywordflow">then</span>  <span class="comment">!### Avoid using this dimensional constant.</span></div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;        z_from_bot_wkb(i) = gv%H_to_Z*h(i,j,nz) * (us%s_to_T**2 * n2_lay(i,nz)) / n2_meanz(i)</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;      <span class="keywordflow">else</span> ; z_from_bot_wkb(i) = 0 ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;<span class="keywordflow">  endif</span>  <span class="comment">! Polzin</span></div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160; </div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;  <span class="comment">! Calculate/get dissipation values at bottom</span></div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;  <span class="comment">! Both Polzin and Simmons:</span></div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;    <span class="comment">! Dissipation of locally trapped internal tide (non-propagating high modes)</span></div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;    tke_itidal_bot(i) = min(cs%TKE_itidal(i,j)*us%T_to_s*cs%Nb(i,j), cs%TKE_itide_max)</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%TKE_itidal_used)) &amp;</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;      dd%TKE_itidal_used(i,j) = tke_itidal_bot(i)</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;    tke_itidal_bot(i) = (i_rho0 * cs%Mu_itides * cs%Gamma_itides) * tke_itidal_bot(i)</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;    <span class="comment">! Dissipation of locally trapped lee waves</span></div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;    tke_niku_bot(i) = 0.0</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;    <span class="keywordflow">if</span> (cs%Lee_wave_dissipation) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;      tke_niku_bot(i) = (i_rho0 * cs%Mu_itides * cs%Gamma_lee) * cs%TKE_Niku(i,j)</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    <span class="comment">! Dissipation of propagating internal tide (baroclinic low modes; rays) (BDM)</span></div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    tke_lowmode_tot    = 0.0</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;    tke_lowmode_bot(i) = 0.0</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;    <span class="keywordflow">if</span> (cs%Lowmode_itidal_dissipation) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;      <span class="comment">! get loss rate due to wave drag on low modes (already multiplied by q)</span></div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160; </div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;      <span class="comment">! TODO: uncomment the following call and fix it</span></div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;      <span class="comment">!call get_lowmode_loss(i,j,G,CS%int_tide_CSp,&quot;WaveDrag&quot;,TKE_lowmode_tot)</span></div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;      <span class="keyword">write</span> (mesg,*) <span class="stringliteral">&quot;========&quot;</span>, __file__, __line__</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;      <span class="keyword">call </span>mom_error(fatal,trim(mesg)//<span class="stringliteral">&quot;: this block not supported yet. (aa)&quot;</span>)</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160; </div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;      tke_lowmode_bot(i) = cs%Mu_itides * i_rho0 * tke_lowmode_tot</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;    <span class="comment">! Vertical energy flux at bottom</span></div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;    tke_itidal_rem(i)  = inv_int(i)     * tke_itidal_bot(i)</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;    tke_niku_rem(i)    = inv_int_lee(i) * tke_niku_bot(i)</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;    tke_lowmode_rem(i) = inv_int_low(i) * tke_lowmode_bot(i)</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160; </div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Fl_itidal)) dd%Fl_itidal(i,j,nz) = tke_itidal_rem(i) <span class="comment">!why is this here? BDM</span></div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160; </div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;  <span class="comment">! Estimate the work that would be done by mixing in each layer.</span></div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;  <span class="comment">! Simmons:</span></div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;  <span class="keywordflow">if</span> ( use_simmons ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    <span class="keywordflow">do</span> k=nz-1,2,-1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;      <span class="keywordflow">if</span> (max_tke(i,k) &lt;= 0.0) cycle</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;      z_from_bot(i) = z_from_bot(i) + gv%H_to_Z*h(i,j,k)</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160; </div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;      <span class="comment">! Fraction of bottom flux predicted to reach top of this layer</span></div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;      tke_frac_top(i)         = inv_int(i)     * exp(-izeta * z_from_bot(i))</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;      tke_frac_top_lee(i)     = inv_int_lee(i) * exp(-izeta_lee * z_from_bot(i))</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;      tke_frac_top_lowmode(i) = inv_int_low(i) * exp(-izeta * z_from_bot(i))</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160; </div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;      <span class="comment">! Actual influx at bottom of layer minus predicted outflux at top of layer to give</span></div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;      <span class="comment">! predicted power expended</span></div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;      tke_itide_lay   = tke_itidal_rem(i)  - tke_itidal_bot(i) * tke_frac_top(i)</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;      tke_niku_lay    = tke_niku_rem(i)    - tke_niku_bot(i)   * tke_frac_top_lee(i)</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;      tke_lowmode_lay = tke_lowmode_rem(i) - tke_lowmode_bot(i)* tke_frac_top_lowmode(i)</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160; </div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;      <span class="comment">! Actual power expended may be less than predicted if stratification is weak; adjust</span></div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;      <span class="keywordflow">if</span> (tke_itide_lay + tke_niku_lay + tke_lowmode_lay &gt; (max_tke(i,k))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;        frac_used = (max_tke(i,k)) / (tke_itide_lay + tke_niku_lay + tke_lowmode_lay)</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;        tke_itide_lay   = frac_used * tke_itide_lay</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;        tke_niku_lay    = frac_used * tke_niku_lay</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;        tke_lowmode_lay = frac_used * tke_lowmode_lay</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160; </div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;      <span class="comment">! Calculate vertical flux available to bottom of layer above</span></div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;      tke_itidal_rem(i)  = tke_itidal_rem(i)  - tke_itide_lay</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;      tke_niku_rem(i)    = tke_niku_rem(i)    - tke_niku_lay</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;      tke_lowmode_rem(i) = tke_lowmode_rem(i) - tke_lowmode_lay</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160; </div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;      <span class="comment">! Convert power to diffusivity</span></div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;      kd_add  = us%s_to_T * tke_to_kd(i,k) * (tke_itide_lay + tke_niku_lay + tke_lowmode_lay)</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160; </div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;      <span class="keywordflow">if</span> (kd_max &gt;= 0.0) kd_add = min(kd_add, kd_max)</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;      kd_lay(i,j,k) = kd_lay(i,j,k) + (us%T_to_s * kd_add)</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160; </div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(kd_int)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;        kd_int(i,j,k)   = kd_int(i,j,k)   + 0.5 * (us%T_to_s * kd_add)</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        kd_int(i,j,k+1) = kd_int(i,j,k+1) + 0.5 * (us%T_to_s * kd_add)</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160; </div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;      <span class="comment">! diagnostics</span></div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_itidal)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        <span class="comment">! If at layers, dd%Kd_itidal is just TKE_to_Kd(i,k) * TKE_itide_lay</span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        <span class="comment">! The following sets the interface diagnostics.</span></div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;        kd_add = us%s_to_T * tke_to_kd(i,k) * tke_itide_lay</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;        <span class="keywordflow">if</span> (kd_max &gt;= 0.0) kd_add = min(kd_add, kd_max)</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;        <span class="keywordflow">if</span> (k&gt;1)  dd%Kd_itidal(i,j,k)   = dd%Kd_itidal(i,j,k)   + 0.5*kd_add</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;        <span class="keywordflow">if</span> (k&lt;nz) dd%Kd_itidal(i,j,k+1) = dd%Kd_itidal(i,j,k+1) + 0.5*kd_add</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Itidal_work)) &amp;</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;        dd%Kd_itidal_work(i,j,k) = gv%Rho0 * tke_itide_lay</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Fl_itidal)) dd%Fl_itidal(i,j,k) = tke_itidal_rem(i)</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160; </div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Niku)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;        <span class="comment">! If at layers, dd%Kd_Niku(i,j,K) is just TKE_to_Kd(i,k) * TKE_Niku_lay</span></div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;        <span class="comment">! The following sets the interface diagnostics.</span></div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;        kd_add = us%s_to_T * tke_to_kd(i,k) * tke_niku_lay</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;        <span class="keywordflow">if</span> (kd_max &gt;= 0.0) kd_add = min(kd_add, kd_max)</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;        <span class="keywordflow">if</span> (k&gt;1) dd%Kd_Niku(i,j,k)    = dd%Kd_Niku(i,j,k)   + 0.5*kd_add</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;        <span class="keywordflow">if</span> (k&lt;nz) dd%Kd_Niku(i,j,k+1) = dd%Kd_Niku(i,j,k+1) + 0.5*kd_add</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;<span class="comment">!     if (associated(dd%Kd_Niku)) dd%Kd_Niku(i,j,K) = TKE_to_Kd(i,k) * TKE_Niku_lay</span></div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Niku_work)) &amp;</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;        dd%Kd_Niku_work(i,j,k) = gv%Rho0 * tke_niku_lay</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160; </div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_lowmode)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;        <span class="comment">! If at layers, dd%Kd_lowmode is just TKE_to_Kd(i,k) * TKE_lowmode_lay</span></div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;        <span class="comment">! The following sets the interface diagnostics.</span></div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;        kd_add = us%s_to_T * tke_to_kd(i,k) * tke_lowmode_lay</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;        <span class="keywordflow">if</span> (kd_max &gt;= 0.0) kd_add = min(kd_add, kd_max)</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;        <span class="keywordflow">if</span> (k&gt;1)  dd%Kd_lowmode(i,j,k)   = dd%Kd_lowmode(i,j,k)   + 0.5*kd_add</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        <span class="keywordflow">if</span> (k&lt;nz) dd%Kd_lowmode(i,j,k+1) = dd%Kd_lowmode(i,j,k+1) + 0.5*kd_add</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_lowmode_work)) &amp;</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;        dd%Kd_lowmode_work(i,j,k) = gv%Rho0 * tke_lowmode_lay</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Fl_lowmode)) dd%Fl_lowmode(i,j,k) = tke_lowmode_rem(i)</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160; </div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! Simmons</span></div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160; </div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;  <span class="comment">! Polzin:</span></div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;  <span class="keywordflow">if</span> ( use_polzin ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;    <span class="keywordflow">do</span> k=nz-1,2,-1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;      <span class="keywordflow">if</span> (max_tke(i,k) &lt;= 0.0) cycle</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;      z_from_bot(i) = z_from_bot(i) + gv%H_to_Z*h(i,j,k)</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;      <span class="keywordflow">if</span> (n2_meanz(i) &gt; 1.0e-14 ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;        z_from_bot_wkb(i) = z_from_bot_wkb(i) &amp;</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;            + gv%H_to_Z * h(i,j,k) * (us%s_to_T**2 * n2_lay(i,k)) / n2_meanz(i)</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;      <span class="keywordflow">else</span> ; z_from_bot_wkb(i) = 0 ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160; </div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;      <span class="comment">! Fraction of bottom flux predicted to reach top of this layer</span></div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;      tke_frac_top(i)     = ( inv_int(i) * z0_polzin_scaled(i) ) / &amp;</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;                            ( z0_polzin_scaled(i) + z_from_bot_wkb(i) )</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;      z0_psl = z0_polzin_scaled(i)*cs%Decay_scale_factor_lee</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;      tke_frac_top_lee(i) = (inv_int_lee(i) * z0_psl) / (z0_psl + z_from_bot_wkb(i))</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;      tke_frac_top_lowmode(i) = ( inv_int_low(i) * z0_polzin_scaled(i) ) / &amp;</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;                            ( z0_polzin_scaled(i) + z_from_bot_wkb(i) )</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160; </div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;      <span class="comment">! Actual influx at bottom of layer minus predicted outflux at top of layer to give</span></div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;      <span class="comment">! predicted power expended</span></div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;      tke_itide_lay   = tke_itidal_rem(i)  - tke_itidal_bot(i) *tke_frac_top(i)</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;      tke_niku_lay    = tke_niku_rem(i)    - tke_niku_bot(i)   * tke_frac_top_lee(i)</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;      tke_lowmode_lay = tke_lowmode_rem(i) - tke_lowmode_bot(i)*tke_frac_top_lowmode(i)</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160; </div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;      <span class="comment">! Actual power expended may be less than predicted if stratification is weak; adjust</span></div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;      <span class="keywordflow">if</span> (tke_itide_lay + tke_niku_lay + tke_lowmode_lay &gt; (max_tke(i,k))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;        frac_used = (max_tke(i,k)) / (tke_itide_lay + tke_niku_lay + tke_lowmode_lay)</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;        tke_itide_lay   = frac_used * tke_itide_lay</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;        tke_niku_lay    = frac_used * tke_niku_lay</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;        tke_lowmode_lay = frac_used * tke_lowmode_lay</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160; </div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;      <span class="comment">! Calculate vertical flux available to bottom of layer above</span></div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;      tke_itidal_rem(i)  = tke_itidal_rem(i)  - tke_itide_lay</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;      tke_niku_rem(i)    = tke_niku_rem(i)    - tke_niku_lay</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;      tke_lowmode_rem(i) = tke_lowmode_rem(i) - tke_lowmode_lay</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160; </div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;      <span class="comment">! Convert power to diffusivity</span></div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;      kd_add  = us%s_to_T * tke_to_kd(i,k) * (tke_itide_lay + tke_niku_lay + tke_lowmode_lay)</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160; </div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;      <span class="keywordflow">if</span> (kd_max &gt;= 0.0) kd_add = min(kd_add, kd_max)</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;      kd_lay(i,j,k) = kd_lay(i,j,k) + (us%T_to_s * kd_add)</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160; </div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(kd_int)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;        kd_int(i,j,k)   = kd_int(i,j,k)   + 0.5 * (us%T_to_s * kd_add)</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;        kd_int(i,j,k+1) = kd_int(i,j,k+1) + 0.5 * (us%T_to_s * kd_add)</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160; </div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;      <span class="comment">! diagnostics</span></div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_itidal)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;        <span class="comment">! If at layers, this is just dd%Kd_itidal(i,j,K) = TKE_to_Kd(i,k) * TKE_itide_lay</span></div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        <span class="comment">! The following sets the interface diagnostics.</span></div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;        kd_add = us%s_to_T * tke_to_kd(i,k) * tke_itide_lay</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;        <span class="keywordflow">if</span> (kd_max &gt;= 0.0) kd_add = min(kd_add, kd_max)</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;        <span class="keywordflow">if</span> (k&gt;1)  dd%Kd_itidal(i,j,k)   = dd%Kd_itidal(i,j,k)   + 0.5*kd_add</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;        <span class="keywordflow">if</span> (k&lt;nz) dd%Kd_itidal(i,j,k+1) = dd%Kd_itidal(i,j,k+1) + 0.5*kd_add</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Itidal_work)) &amp;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;        dd%Kd_itidal_work(i,j,k) = gv%Rho0 * tke_itide_lay</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Fl_itidal)) dd%Fl_itidal(i,j,k) = tke_itidal_rem(i)</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160; </div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Niku)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;        <span class="comment">! If at layers, this is just dd%Kd_Niku(i,j,K) = TKE_to_Kd(i,k) * TKE_Niku_lay</span></div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;        <span class="comment">! The following sets the interface diagnostics.</span></div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;        kd_add = us%s_to_T * tke_to_kd(i,k) * tke_niku_lay</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        <span class="keywordflow">if</span> (kd_max &gt;= 0.0) kd_add = min(kd_add, kd_max)</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;        <span class="keywordflow">if</span> (k&gt;1) dd%Kd_Niku(i,j,k)    = dd%Kd_Niku(i,j,k)   + 0.5*kd_add</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;        <span class="keywordflow">if</span> (k&lt;nz) dd%Kd_Niku(i,j,k+1) = dd%Kd_Niku(i,j,k+1) + 0.5*kd_add</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;   <span class="comment">!  if (associated(dd%Kd_Niku)) dd%Kd_Niku(i,j,K) = TKE_to_Kd(i,k) * TKE_Niku_lay</span></div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Niku_work)) dd%Kd_Niku_work(i,j,k) = gv%Rho0 * tke_niku_lay</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160; </div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_lowmode)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;        <span class="comment">! If at layers, dd%Kd_lowmode is just TKE_to_Kd(i,k) * TKE_lowmode_lay</span></div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;        <span class="comment">! The following sets the interface diagnostics.</span></div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;        kd_add = us%s_to_T * tke_to_kd(i,k) * tke_lowmode_lay</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;        <span class="keywordflow">if</span> (kd_max &gt;= 0.0) kd_add = min(kd_add, kd_max)</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;        <span class="keywordflow">if</span> (k&gt;1)  dd%Kd_lowmode(i,j,k)   = dd%Kd_lowmode(i,j,k)   + 0.5*kd_add</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;        <span class="keywordflow">if</span> (k&lt;nz) dd%Kd_lowmode(i,j,k+1) = dd%Kd_lowmode(i,j,k+1) + 0.5*kd_add</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_lowmode_work)) &amp;</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;        dd%Kd_lowmode_work(i,j,k) = gv%Rho0 * tke_lowmode_lay</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Fl_lowmode)) dd%Fl_lowmode(i,j,k) = tke_lowmode_rem(i)</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160; </div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! Polzin</span></div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00196">polzin_09</a>, and <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00195">stlaurent_02</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00635">calculate_tidal_mixing()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__tidal__mixing_aa8f8da6657f71aaef15f3cbe4e5f521d_cgraph.svg" width="578" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__tidal__mixing_aa8f8da6657f71aaef15f3cbe4e5f521d_icgraph.svg" width="418" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="aef4b9f3c4ceece52a1cebe1bbee66988"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aef4b9f3c4ceece52a1cebe1bbee66988">&#9670;&nbsp;</a></span>calculate_cvmix_tidal()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_tidal_mixing::calculate_cvmix_tidal </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__tidal__mixing_1_1tidal__mixing__cs.html">tidal_mixing_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke+1), intent(in)&#160;</td>
          <td class="paramname"><em>N2_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>Kd_lay</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:,:), pointer&#160;</td>
          <td class="paramname"><em>Kv</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Calls the CVMix routines to compute tidal dissipation and to add the effect of internal-tide-driven mixing to the interface diffusivities. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>The j-index to work on </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>ocean vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>This module's control structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n2_int</td><td>The squared buoyancy frequency at the interfaces [T-2 ~&gt; s-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">kd_lay</td><td>The diapycnal diffusivities in the layers [Z2 T-1 ~&gt; m2 s-1]. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">kv</td><td>The "slow" vertical viscosity at each interface (not layer!) [Z2 s-1 ~&gt; m2 s-1]. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00681">681</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;  <span class="keywordtype">integer</span>,                 <span class="keywordtype">intent(in)</span>    :: j<span class="comment">     !&lt; The j-index to work on</span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">     !&lt; Grid structure.</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">    !&lt; ocean vertical grid structure</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>    :: US<span class="comment">    !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;  <span class="keywordtype">type</span>(tidal_mixing_cs),   <span class="keywordtype">pointer</span>       :: CS<span class="comment">    !&lt; This module&#39;s control structure.</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span>, <span class="keywordtype">intent(in)</span> :: N2_int<span class="comment"> !&lt; The squared buoyancy</span></div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;<span class="comment">                                                  !! frequency at the interfaces [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: h<span class="comment">     !&lt; Layer thicknesses [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;                           <span class="keywordtype">intent(inout)</span> :: Kd_lay<span class="comment">!&lt; The diapycnal diffusivities in the layers [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:,:)</span>,  <span class="keywordtype">pointer</span>       :: Kv<span class="comment">    !&lt; The &quot;slow&quot; vertical viscosity at each interface</span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="comment">                                                  !! (not layer!) [Z2 s-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(G)+1)</span> :: Kd_tidal    <span class="comment">! tidal diffusivity [m2/s]</span></div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(G)+1)</span> :: Kv_tidal    <span class="comment">! tidal viscosity [m2/s]</span></div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(G)+1)</span> :: vert_dep    <span class="comment">! vertical deposition</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(G)+1)</span> :: iFaceHeight <span class="comment">! Height of interfaces [m]</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(G)+1)</span> :: SchmittnerSocn</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(G))</span>   :: cellHeight  <span class="comment">! Height of cell centers [m]</span></div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(G))</span>   :: tidal_qe_md <span class="comment">! Tidal dissipation energy interpolated from 3d input</span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;                                            <span class="comment">! to model coordinates</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(G)+1)</span> :: N2_int_i    <span class="comment">! De-scaled interface buoyancy frequency [s-2]</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(G))</span>   :: Schmittner_coeff</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(G))</span>   :: h_m         <span class="comment">! Cell thickness [m]</span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">dimension(:,:)</span> :: exp_hab_zetar</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160; </div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;  <span class="keywordtype">integer</span> :: i, k, is, ie</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="keywordtype">  real</span> :: dh, hcorr, Simmons_coeff</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: rho_fw = 1000.0 <span class="comment">! fresh water density [kg/m^3]</span></div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;                                     <span class="comment">! TODO: when coupled, get this from CESM (SHR_CONST_RHOFW)</span></div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="keywordtype">  real</span> :: h_neglect, h_neglect_edge</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;  <span class="keywordtype">type</span>(tidal_mixing_diags), <span class="keywordtype">pointer</span> :: dd =&gt; null()</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160; </div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;  is  = g%isc ; ie  = g%iec</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;  dd =&gt; cs%dd</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160; </div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;  <span class="keywordflow">select case</span> (cs%CVMix_tidal_scheme)</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;  <span class="keywordflow">case</span> (simmons)</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160; </div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;      <span class="keywordflow">if</span> (g%mask2dT(i,j)&lt;1) cycle</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160; </div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;      ifaceheight = 0.0 <span class="comment">! BBL is all relative to the surface</span></div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;      hcorr = 0.0</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;      <span class="keywordflow">do</span> k=1,g%ke</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        <span class="comment">! cell center and cell bottom in meters (negative values in the ocean)</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        dh = h(i,j,k) * gv%H_to_m <span class="comment">! Nominal thickness to use for increment, rescaled to m for use by CVMix.</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        dh = dh + hcorr <span class="comment">! Take away the accumulated error (could temporarily make dh&lt;0)</span></div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        hcorr = min( dh - cs%min_thickness, 0. ) <span class="comment">! If inflating then hcorr&lt;0</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        dh = max( dh, cs%min_thickness ) <span class="comment">! Limit increment dh&gt;=min_thickness</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        cellheight(k)    = ifaceheight(k) - 0.5 * dh</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;        ifaceheight(k+1) = ifaceheight(k) - dh</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160; </div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;      <span class="keyword">call </span>cvmix_compute_simmons_invariant( nlev                    = g%ke,                &amp;</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;                                            energy_flux             = cs%tidal_qe_2d(i,j), &amp;</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;                                            rho                     = rho_fw,              &amp;</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;                                            simmonscoeff            = simmons_coeff,       &amp;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;                                            vertdep                 = vert_dep,            &amp;</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;                                            zw                      = ifaceheight,         &amp;</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;                                            zt                      = cellheight,          &amp;</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;                                            cvmix_tidal_params_user = cs%CVMix_tidal_params)</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160; </div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;      <span class="comment">! Since we pass tidal_qe_2d=(CS%Gamma_itides)*tidal_energy_flux_2d, and not tidal_energy_flux_2d in</span></div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;      <span class="comment">! above subroutine call, we divide Simmons_coeff by CS%Gamma_itides as a corrective step:</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;      <span class="comment">! TODO: (CS%Gamma_itides)*tidal_energy_flux_2d is unnecessary, directly use tidal_energy_flux_2d</span></div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;      simmons_coeff = simmons_coeff / cs%Gamma_itides</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160; </div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160; </div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;      <span class="comment">! XXX: Temporary de-scaling of N2_int(i,:) into a temporary variable</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;      <span class="keywordflow">do</span> k = 1,g%ke+1</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        n2_int_i(k) = us%s_to_T**2 * n2_int(i,k)</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160; </div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;      <span class="keyword">call </span>cvmix_coeffs_tidal( mdiff_out               = kv_tidal,            &amp;</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;                               tdiff_out               = kd_tidal,            &amp;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;                               nsqr                    = n2_int_i,            &amp;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                               oceandepth              = -ifaceheight(g%ke+1),&amp;</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;                               simmonscoeff            = simmons_coeff,       &amp;</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;                               vert_dep                = vert_dep,            &amp;</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;                               nlev                    = g%ke,                &amp;</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;                               max_nlev                = g%ke,                &amp;</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;                               cvmix_params            = cs%CVMix_glb_params, &amp;</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;                               cvmix_tidal_params_user = cs%CVMix_tidal_params)</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160; </div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;      <span class="comment">! Update diffusivity</span></div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;      <span class="keywordflow">do</span> k=1,g%ke</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        kd_lay(i,j,k) = kd_lay(i,j,k) + 0.5 * us%m2_s_to_Z2_T * (kd_tidal(k) + kd_tidal(k+1))</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160; </div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;      <span class="comment">! Update viscosity with the proper unit conversion.</span></div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(kv)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        <span class="keywordflow">do</span> k=1,g%ke+1</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;          kv(i,j,k) = kv(i,j,k) + us%m_to_Z**2 * kv_tidal(k)  <span class="comment">! Rescale from m2 s-1 to Z2 s-1.</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160; </div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;      <span class="comment">! diagnostics</span></div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_itidal)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        dd%Kd_itidal(i,j,:) = kd_tidal(:)</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_int)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;        dd%N2_int(i,j,:) = n2_int(i,:)</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Simmons_coeff_2d)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;        dd%Simmons_coeff_2d(i,j) = simmons_coeff</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%vert_dep_3d)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        dd%vert_dep_3d(i,j,:) = vert_dep(:)</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160; </div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! i=is,ie</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160; </div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;  <span class="keywordflow">case</span> (schmittner)</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160; </div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="comment">! TODO: correct exp_hab_zetar shapes in CVMix_compute_Schmittner_invariant</span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    <span class="comment">! and CVMix_compute_SchmittnerCoeff low subroutines</span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160; </div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    <span class="keyword">allocate</span>(exp_hab_zetar(g%ke+1,g%ke+1))</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    <span class="keywordflow">if</span> (gv%Boussinesq) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;      h_neglect = gv%m_to_H*1.0e-30 ; h_neglect_edge = gv%m_to_H*1.0e-10</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;      h_neglect = gv%kg_m2_to_H*1.0e-30 ; h_neglect_edge = gv%kg_m2_to_H*1.0e-10</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160; </div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160; </div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160; </div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;      <span class="keywordflow">if</span> (g%mask2dT(i,j)&lt;1) cycle</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160; </div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;      ifaceheight = 0.0 <span class="comment">! BBL is all relative to the surface</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;      hcorr = 0.0</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;      <span class="keywordflow">do</span> k=1,g%ke</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;        h_m(k) = h(i,j,k)*gv%H_to_m  <span class="comment">! Rescale thicknesses to m for use by CVmix.</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;        <span class="comment">! cell center and cell bottom in meters (negative values in the ocean)</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;        dh = h_m(k) + hcorr <span class="comment">! Nominal thickness less the accumulated error (could temporarily make dh&lt;0)</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;        hcorr = min( dh - cs%min_thickness, 0. ) <span class="comment">! If inflating then hcorr&lt;0</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;        dh = max( dh, cs%min_thickness ) <span class="comment">! Limit increment dh&gt;=min_thickness</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;        cellheight(k)    = ifaceheight(k) - 0.5 * dh</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;        ifaceheight(k+1) = ifaceheight(k) - dh</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160; </div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;      schmittnersocn = 0.0 <span class="comment">! TODO: compute this</span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160; </div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;      <span class="comment">! form the time-invariant part of Schmittner coefficient term</span></div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;      <span class="keyword">call </span>cvmix_compute_schmittner_invariant(nlev                    = g%ke,           &amp;</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                                              vertdep                 = vert_dep,       &amp;</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;                                              efficiency              = cs%Mu_itides,   &amp;</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                                              rho                     = rho_fw,         &amp;</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;                                              exp_hab_zetar           = exp_hab_zetar,  &amp;</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;                                              zw                      = ifaceheight,    &amp;</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;                                              cvmix_tidal_params_user = cs%CVMix_tidal_params)</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;                  <span class="comment">!TODO: in above call, there is no need to pass efficiency, since it gets</span></div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;                  <span class="comment">! passed via CVMix_init_tidal and stored in CVMix_tidal_params. Change</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;                  <span class="comment">! CVMix API to prevent this redundancy.</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160; </div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;      <span class="comment">! remap from input z coordinate to model coordinate:</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;      tidal_qe_md = 0.0</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;      <span class="keyword">call </span>remapping_core_h(cs%remap_cs, <span class="keyword">size</span>(cs%h_src), cs%h_src, cs%tidal_qe_3d_in(i,j,:), &amp;</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;                            g%ke, h_m, tidal_qe_md)</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160; </div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;      <span class="comment">! form the Schmittner coefficient that is based on 3D q*E, which is formed from</span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;      <span class="comment">! summing q_i*TidalConstituent_i over the number of constituents.</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;      <span class="keyword">call </span>cvmix_compute_schmittnercoeff( nlev                    = g%ke,               &amp;</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;                                          energy_flux             = tidal_qe_md(:),     &amp;</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;                                          rho                     = rho_fw,             &amp;</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;                                          schmittnercoeff         = schmittner_coeff,   &amp;</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;                                          exp_hab_zetar           = exp_hab_zetar,      &amp;</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;                                          cvmix_tidal_params_user = cs%CVMix_tidal_params)</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160; </div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;      <span class="comment">! XXX: Temporary de-scaling of N2_int(i,:) into a temporary variable</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;      <span class="keywordflow">do</span> k = 1,g%ke+1</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;        n2_int_i(k) = us%s_to_T**2 * n2_int(i,k)</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160; </div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;      <span class="keyword">call </span>cvmix_coeffs_tidal_schmittner( mdiff_out               = kv_tidal,             &amp;</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;                                          tdiff_out               = kd_tidal,             &amp;</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;                                          nsqr                    = n2_int_i,             &amp;</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;                                          oceandepth              = -ifaceheight(g%ke+1), &amp;</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;                                          vert_dep                = vert_dep,             &amp;</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;                                          nlev                    = g%ke,                 &amp;</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                                          max_nlev                = g%ke,                 &amp;</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;                                          schmittnercoeff         = schmittner_coeff,     &amp;</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;                                          schmittnersouthernocean = schmittnersocn,       &amp;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;                                          cvmix_params            = cs%CVMix_glb_params,  &amp;</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;                                          cvmix_tidal_params_user = cs%CVMix_tidal_params)</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160; </div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;      <span class="comment">! Update diffusivity</span></div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;      <span class="keywordflow">do</span> k=1,g%ke</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;        kd_lay(i,j,k) = kd_lay(i,j,k) + 0.5 * us%m2_s_to_Z2_T * (kd_tidal(k) + kd_tidal(k+1))</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160; </div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;      <span class="comment">! Update viscosity</span></div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(kv)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;        <span class="keywordflow">do</span> k=1,g%ke+1</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;          kv(i,j,k) = kv(i,j,k) + us%m_to_Z**2 * kv_tidal(k)   <span class="comment">! Rescale from m2 s-1 to Z2 s-1.</span></div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160; </div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;      <span class="comment">! diagnostics</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_itidal)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;        dd%Kd_itidal(i,j,:) = kd_tidal(:)</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_int)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;        dd%N2_int(i,j,:) = n2_int(i,:)</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Schmittner_coeff_3d)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        dd%Schmittner_coeff_3d(i,j,:) = schmittner_coeff(:)</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%tidal_qe_md)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;        dd%tidal_qe_md(i,j,:) = tidal_qe_md(:)</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%vert_dep_3d)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;        dd%vert_dep_3d(i,j,:) = vert_dep(:)</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! i=is,ie</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160; </div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    <span class="keyword">deallocate</span>(exp_hab_zetar)</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160; </div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;<span class="keywordflow">  case default</span></div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;     <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;tidal_mixing_init: Unrecognized setting &quot;</span>// &amp;</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;         <span class="stringliteral">&quot;#define CVMIX_TIDAL_SCHEME found in input file.&quot;</span>)</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;<span class="keywordflow">  end select</span></div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__remapping_8F90_source.html#l00182">mom_remapping::remapping_core_h()</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00200">schmittner</a>, and <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00199">simmons</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00635">calculate_tidal_mixing()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__tidal__mixing_aef4b9f3c4ceece52a1cebe1bbee66988_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__tidal__mixing_aef4b9f3c4ceece52a1cebe1bbee66988_icgraph.svg" width="448" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="abf084268fd9c71f20880838d2bce7e3e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abf084268fd9c71f20880838d2bce7e3e">&#9670;&nbsp;</a></span>calculate_tidal_mixing()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_tidal_mixing::calculate_tidal_mixing </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>N2_bot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>TKE_to_Kd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>max_TKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__tidal__mixing_1_1tidal__mixing__cs.html">tidal_mixing_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>N2_lay</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)+1), intent(in)&#160;</td>
          <td class="paramname"><em>N2_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>Kd_lay</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)+1), intent(inout), optional&#160;</td>
          <td class="paramname"><em>Kd_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Kd_max</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:,:), pointer&#160;</td>
          <td class="paramname"><em>Kv</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Depending on whether or not CVMix is active, calls the associated subroutine to compute internal tidal dissipation and to add the effect of internal-tide-driven mixing to the layer or interface diffusivities. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n2_bot</td><td>The near-bottom squared buoyancy frequency [T-2 ~&gt; s-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n2_lay</td><td>The squared buoyancy frequency of the layers [T-2 ~&gt; s-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n2_int</td><td>The squared buoyancy frequency at the interfaces [T-2 ~&gt; s-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>The j-index to work on </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tke_to_kd</td><td>The conversion rate between the TKE dissipated within a layer and the diapycnal diffusivity within that layer, usually (~Rho_0 / (G_Earth * dRho_lay)) [Z2 T-1 / Z3 T-3 = T2 Z-1 ~&gt; s2 m-1] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">max_tke</td><td>The energy required to for a layer to entrain to its maximum realizable thickness [Z3 T-3 ~&gt; m3 s-3] </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure for this module </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">kd_lay</td><td>The diapycnal diffusvity in layers [Z2 T-1 ~&gt; m2 s-1]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">kd_int</td><td>The diapycnal diffusvity at interfaces, </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">kd_max</td><td>The maximum increment for diapycnal diffusivity due to TKE-based processes, [Z2 T-1 ~&gt; m2 s-1]. Set this to a negative value to have no limit. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">kv</td><td>The "slow" vertical viscosity at each interface (not layer!) [Z2 s-1 ~&gt; m2 s-1]. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00635">635</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),            <span class="keywordtype">intent(in)</span>    :: G<span class="comment">      !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type),          <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">     !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),            <span class="keywordtype">intent(in)</span>    :: US<span class="comment">     !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                                    <span class="keywordtype">intent(in)</span>    :: h<span class="comment">      !&lt; Layer thicknesses [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,         <span class="keywordtype">intent(in)</span>    :: N2_bot<span class="comment"> !&lt; The near-bottom squared buoyancy</span></div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;<span class="comment">                                                            !! frequency [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: N2_lay<span class="comment"> !&lt; The squared buoyancy frequency of the</span></div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;<span class="comment">                                                            !! layers [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span>, <span class="keywordtype">intent(in)</span>  :: N2_int<span class="comment"> !&lt; The squared buoyancy frequency at the</span></div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="comment">                                                            !! interfaces [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;  <span class="keywordtype">integer</span>,                          <span class="keywordtype">intent(in)</span>    :: j<span class="comment">      !&lt; The j-index to work on</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: TKE_to_Kd<span class="comment"> !&lt; The conversion rate between the TKE</span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="comment">                                                            !! dissipated within a layer and the</span></div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;<span class="comment">                                                            !! diapycnal diffusivity within that layer,</span></div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;<span class="comment">                                                            !! usually (~Rho_0 / (G_Earth * dRho_lay))</span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;<span class="comment">                                                            !! [Z2 T-1 / Z3 T-3 = T2 Z-1 ~&gt; s2 m-1]</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: max_TKE<span class="comment"> !&lt; The energy required to for a layer to entrain</span></div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="comment">                                                            !! to its maximum realizable thickness [Z3 T-3 ~&gt; m3 s-3]</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;  <span class="keywordtype">type</span>(tidal_mixing_cs),            <span class="keywordtype">pointer</span>       :: CS<span class="comment">     !&lt; The control structure for this module</span></div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                                    <span class="keywordtype">intent(inout)</span> :: Kd_lay<span class="comment"> !&lt; The diapycnal diffusvity in layers [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>, &amp;</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(inout)</span> :: Kd_int<span class="comment"> !&lt; The diapycnal diffusvity at interfaces,</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;<span class="comment">                                                            !! [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="keywordtype">  real</span>,                             <span class="keywordtype">intent(in)</span>    :: Kd_max<span class="comment"> !&lt; The maximum increment for diapycnal</span></div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;<span class="comment">                                                            !! diffusivity due to TKE-based processes,</span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="comment">                                                            !! [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;<span class="comment">                                                            !! Set this to a negative value to have no limit.</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:,:)</span>,           <span class="keywordtype">pointer</span>       :: Kv<span class="comment">     !&lt; The &quot;slow&quot; vertical viscosity at each interface</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="comment">                                                            !! (not layer!) [Z2 s-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160; </div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;  <span class="keywordflow">if</span> (cs%Int_tide_dissipation .or. cs%Lee_wave_dissipation .or. cs%Lowmode_itidal_dissipation) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    <span class="keywordflow">if</span> (cs%use_CVMix_tidal) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;      <span class="keyword">call </span>calculate_cvmix_tidal(h, j, g, gv, us, cs, n2_int, kd_lay, kv)</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;      <span class="keyword">call </span>add_int_tide_diffusivity(h, n2_bot, j, tke_to_kd, max_tke, &amp;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;                                    g, gv, us, cs, n2_lay, kd_lay, kd_int, us%s_to_T*kd_max)</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="keywordflow">  endif</span></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00917">add_int_tide_diffusivity()</a>, and <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00681">calculate_cvmix_tidal()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__tidal__mixing_abf084268fd9c71f20880838d2bce7e3e_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="af6fabb2bc6e4aabd3187938bda8098ec"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af6fabb2bc6e4aabd3187938bda8098ec">&#9670;&nbsp;</a></span>post_tidal_diagnostics()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_tidal_mixing::post_tidal_diagnostics </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__tidal__mixing_1_1tidal__mixing__cs.html">tidal_mixing_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine offers up diagnostics of the tidal mixing. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure for this module </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l01407">1407</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),    <span class="keywordtype">intent(in)</span>   :: G<span class="comment">   !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type),  <span class="keywordtype">intent(in)</span>   :: GV<span class="comment">  !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  &amp;</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;                            <span class="keywordtype">intent(in)</span>   :: h<span class="comment">   !&lt; Layer thicknesses [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;  <span class="keywordtype">type</span>(tidal_mixing_cs),    <span class="keywordtype">pointer</span>      :: CS<span class="comment">  !&lt; The control structure for this module</span></div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160; </div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;  <span class="comment">! local</span></div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;  <span class="keywordtype">type</span>(tidal_mixing_diags), <span class="keywordtype">pointer</span> :: dd =&gt; null()</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160; </div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;  dd =&gt; cs%dd</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160; </div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;  <span class="keywordflow">if</span> (cs%Int_tide_dissipation .or. cs%Lee_wave_dissipation .or. cs%Lowmode_itidal_dissipation) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_itidal  &gt; 0) <span class="keyword">call </span>post_data(cs%id_TKE_itidal,  dd%TKE_itidal_used, cs%diag)</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_leewave &gt; 0) <span class="keyword">call </span>post_data(cs%id_TKE_leewave, cs%TKE_Niku,        cs%diag)</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;    <span class="keywordflow">if</span> (cs%id_Nb          &gt; 0) <span class="keyword">call </span>post_data(cs%id_Nb,      cs%Nb,      cs%diag)</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;    <span class="keywordflow">if</span> (cs%id_N2_bot      &gt; 0) <span class="keyword">call </span>post_data(cs%id_N2_bot,  dd%N2_bot,  cs%diag)</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    <span class="keywordflow">if</span> (cs%id_N2_meanz    &gt; 0) <span class="keyword">call </span>post_data(cs%id_N2_meanz,dd%N2_meanz,cs%diag)</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160; </div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;    <span class="keywordflow">if</span> (cs%id_Fl_itidal &gt; 0) <span class="keyword">call </span>post_data(cs%id_Fl_itidal, dd%Fl_itidal, cs%diag)</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_itidal &gt; 0) <span class="keyword">call </span>post_data(cs%id_Kd_itidal, dd%Kd_itidal, cs%diag)</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_Niku   &gt; 0) <span class="keyword">call </span>post_data(cs%id_Kd_Niku,   dd%Kd_Niku,   cs%diag)</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_lowmode&gt; 0) <span class="keyword">call </span>post_data(cs%id_Kd_lowmode, dd%Kd_lowmode, cs%diag)</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;    <span class="keywordflow">if</span> (cs%id_Fl_lowmode&gt; 0) <span class="keyword">call </span>post_data(cs%id_Fl_lowmode, dd%Fl_lowmode, cs%diag)</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160; </div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;    <span class="keywordflow">if</span> (cs%id_N2_int&gt; 0)        <span class="keyword">call </span>post_data(cs%id_N2_int, dd%N2_int, cs%diag)</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;    <span class="keywordflow">if</span> (cs%id_vert_dep&gt; 0)      <span class="keyword">call </span>post_data(cs%id_vert_dep, dd%vert_dep_3d, cs%diag)</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;    <span class="keywordflow">if</span> (cs%id_Simmons_coeff&gt; 0) <span class="keyword">call </span>post_data(cs%id_Simmons_coeff, dd%Simmons_coeff_2d, cs%diag)</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    <span class="keywordflow">if</span> (cs%id_Schmittner_coeff&gt; 0) <span class="keyword">call </span>post_data(cs%id_Schmittner_coeff, dd%Schmittner_coeff_3d, cs%diag)</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;    <span class="keywordflow">if</span> (cs%id_tidal_qe_md&gt; 0) <span class="keyword">call </span>post_data(cs%id_tidal_qe_md, dd%tidal_qe_md, cs%diag)</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160; </div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_Itidal_Work &gt; 0) &amp;</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Kd_Itidal_Work, dd%Kd_Itidal_Work, cs%diag)</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_Niku_Work &gt; 0) <span class="keyword">call </span>post_data(cs%id_Kd_Niku_Work, dd%Kd_Niku_Work, cs%diag)</div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_Lowmode_Work &gt; 0) &amp;</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Kd_Lowmode_Work, dd%Kd_Lowmode_Work, cs%diag)</div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160; </div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;    <span class="keywordflow">if</span> (cs%id_Polzin_decay_scale &gt; 0 ) &amp;</div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Polzin_decay_scale, dd%Polzin_decay_scale, cs%diag)</div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;    <span class="keywordflow">if</span> (cs%id_Polzin_decay_scale_scaled &gt; 0 ) &amp;</div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Polzin_decay_scale_scaled, dd%Polzin_decay_scale_scaled, cs%diag)</div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160; </div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_itidal)) <span class="keyword">deallocate</span>(dd%Kd_itidal)</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_lowmode)) <span class="keyword">deallocate</span>(dd%Kd_lowmode)</div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Fl_itidal)) <span class="keyword">deallocate</span>(dd%Fl_itidal)</div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Fl_lowmode)) <span class="keyword">deallocate</span>(dd%Fl_lowmode)</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Polzin_decay_scale)) <span class="keyword">deallocate</span>(dd%Polzin_decay_scale)</div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Polzin_decay_scale_scaled)) <span class="keyword">deallocate</span>(dd%Polzin_decay_scale_scaled)</div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_bot)) <span class="keyword">deallocate</span>(dd%N2_bot)</div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_meanz)) <span class="keyword">deallocate</span>(dd%N2_meanz)</div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Niku)) <span class="keyword">deallocate</span>(dd%Kd_Niku)</div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Niku_work)) <span class="keyword">deallocate</span>(dd%Kd_Niku_work)</div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Itidal_Work))  <span class="keyword">deallocate</span>(dd%Kd_Itidal_Work)</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Lowmode_Work)) <span class="keyword">deallocate</span>(dd%Kd_Lowmode_Work)</div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%TKE_itidal_used)) <span class="keyword">deallocate</span>(dd%TKE_itidal_used)</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_int)) <span class="keyword">deallocate</span>(dd%N2_int)</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%vert_dep_3d)) <span class="keyword">deallocate</span>(dd%vert_dep_3d)</div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Simmons_coeff_2d)) <span class="keyword">deallocate</span>(dd%Simmons_coeff_2d)</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Schmittner_coeff_3d)) <span class="keyword">deallocate</span>(dd%Schmittner_coeff_3d)</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%tidal_qe_md)) <span class="keyword">deallocate</span>(dd%tidal_qe_md)</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00201">mom_set_diffusivity::set_diffusivity()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__tidal__mixing_af6fabb2bc6e4aabd3187938bda8098ec_icgraph.svg" width="370" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a30a24b88982a5134253679d9484b3708"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a30a24b88982a5134253679d9484b3708">&#9670;&nbsp;</a></span>read_tidal_constituents()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_tidal_mixing::read_tidal_constituents </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=200), intent(in)&#160;</td>
          <td class="paramname"><em>tidal_energy_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__tidal__mixing_1_1tidal__mixing__cs.html">tidal_mixing_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine reads tidal input energy from a file by constituent. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tidal_energy_file</td><td>The file from which to read tidal energy inputs </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure for this module </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l01503">1503</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(in)</span> :: G<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type), <span class="keywordtype">intent(in)</span> :: US<span class="comment">   !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;  <span class="keywordtype">character(len=200)</span>,    <span class="keywordtype">intent(in)</span> :: tidal_energy_file<span class="comment"> !&lt; The file from which to read tidal energy inputs</span></div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;  <span class="keywordtype">type</span>(tidal_mixing_cs), <span class="keywordtype">pointer</span>    :: CS<span class="comment">   !&lt; The control structure for this module</span></div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160; </div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;  <span class="comment">! local variables</span></div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: C1_3 = 1.0/3.0</div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: &amp;</div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;    tidal_qk1, &amp;  <span class="comment">! qk1 coefficient used in Schmittner &amp; Egbert</span></div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;    tidal_qo1     <span class="comment">! qo1 coefficient used in Schmittner &amp; Egbert</span></div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">dimension(:)</span> :: &amp;</div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;    z_t, &amp;        <span class="comment">! depth from surface to midpoint of input layer [Z]</span></div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;    z_w           <span class="comment">! depth from surface to top of input layer [Z]</span></div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">dimension(:,:,:)</span> :: &amp;</div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;    tc_m2, &amp;      <span class="comment">! input lunar semidiurnal tidal energy flux [W/m^2]</span></div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;    tc_s2, &amp;      <span class="comment">! input solar semidiurnal tidal energy flux [W/m^2]</span></div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;    tc_k1, &amp;      <span class="comment">! input lunar diurnal tidal energy flux [W/m^2]</span></div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;    tc_o1         <span class="comment">! input lunar diurnal tidal energy flux [W/m^2]</span></div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(4)</span> :: nz_in</div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;  <span class="keywordtype">integer</span>               :: k, is, ie, js, je, isd, ied, jsd, jed, i, j</div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160; </div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec</div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed</div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160; </div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;  <span class="comment">! get number of input levels:</span></div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;  <span class="keyword">call </span>field_size(tidal_energy_file, <span class="stringliteral">&#39;z_t&#39;</span>, nz_in)</div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160; </div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;  <span class="comment">! allocate local variables</span></div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;  <span class="keyword">allocate</span>(z_t(nz_in(1)), z_w(nz_in(1)) )</div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;  <span class="keyword">allocate</span>(tc_m2(isd:ied,jsd:jed,nz_in(1)), &amp;</div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;           tc_s2(isd:ied,jsd:jed,nz_in(1)), &amp;</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;           tc_k1(isd:ied,jsd:jed,nz_in(1)), &amp;</div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;           tc_o1(isd:ied,jsd:jed,nz_in(1)) )</div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160; </div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;  <span class="comment">! allocate CS variables associated with 3d tidal energy dissipation</span></div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">allocated</span>(cs%tidal_qe_3d_in)) <span class="keyword">allocate</span>(cs%tidal_qe_3d_in(isd:ied,jsd:jed,nz_in(1)))</div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">allocated</span>(cs%h_src))          <span class="keyword">allocate</span>(cs%h_src(nz_in(1)))</div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160; </div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;  <span class="comment">! read in tidal constituents</span></div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;  <span class="keyword">call </span>mom_read_data(tidal_energy_file, <span class="stringliteral">&#39;M2&#39;</span>, tc_m2, g%domain)</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;  <span class="keyword">call </span>mom_read_data(tidal_energy_file, <span class="stringliteral">&#39;S2&#39;</span>, tc_s2, g%domain)</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;  <span class="keyword">call </span>mom_read_data(tidal_energy_file, <span class="stringliteral">&#39;K1&#39;</span>, tc_k1, g%domain)</div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;  <span class="keyword">call </span>mom_read_data(tidal_energy_file, <span class="stringliteral">&#39;O1&#39;</span>, tc_o1, g%domain)</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;  <span class="comment">! Note the hard-coded assumption that z_t and z_w in the file are in centimeters.</span></div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;  <span class="keyword">call </span>mom_read_data(tidal_energy_file, <span class="stringliteral">&#39;z_t&#39;</span>, z_t, scale=100.0*us%m_to_Z)</div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;  <span class="keyword">call </span>mom_read_data(tidal_energy_file, <span class="stringliteral">&#39;z_w&#39;</span>, z_w, scale=100.0*us%m_to_Z)</div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160; </div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;    <span class="keywordflow">if</span> (abs(g%geoLatT(i,j)) &lt; 30.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;      tidal_qk1(i,j) = c1_3</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;      tidal_qo1(i,j) = c1_3</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;      tidal_qk1(i,j) = 1.0</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;      tidal_qo1(i,j) = 1.0</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160; </div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;  cs%tidal_qe_3d_in(:,:,:) = 0.0</div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;  <span class="keywordflow">do</span> k=1,nz_in(1)</div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;    <span class="comment">! Store the input cell thickness in m for use with CVmix.</span></div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;    cs%h_src(k) = us%Z_to_m*(z_t(k)-z_w(k))*2.0</div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;    <span class="comment">! form tidal_qe_3d_in from weighted tidal constituents</span></div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;      <span class="keywordflow">if</span> ((z_t(k) &lt;= g%bathyT(i,j)) .and. (z_w(k) &gt; cs%tidal_diss_lim_tc)) &amp;</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;        cs%tidal_qe_3d_in(i,j,k) = c1_3*tc_m2(i,j,k) + c1_3*tc_s2(i,j,k) + &amp;</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;                tidal_qk1(i,j)*tc_k1(i,j,k) + tidal_qo1(i,j)*tc_o1(i,j,k)</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160; </div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;  <span class="comment">!open(unit=1905,file=&quot;out_1905.txt&quot;,access=&quot;APPEND&quot;)</span></div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;  <span class="comment">!do j=G%jsd,G%jed</span></div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;  <span class="comment">!  do i=isd,ied</span></div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;  <span class="comment">!    if ( i+G%idg_offset .eq. 90 .and. j+G%jdg_offset .eq. 126) then</span></div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;  <span class="comment">!      write(1905,*) &quot;-------------------------------------------&quot;</span></div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;  <span class="comment">!      do k=50,nz_in(1)</span></div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;  <span class="comment">!          write(1905,*) i,j,k</span></div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;  <span class="comment">!          write(1905,*) CS%tidal_qe_3d_in(i,j,k), tc_m2(i,j,k)</span></div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;  <span class="comment">!          write(1905,*) z_t(k), G%bathyT(i,j), z_w(k),CS%tidal_diss_lim_tc</span></div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;  <span class="comment">!      end do</span></div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;  <span class="comment">!    endif</span></div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;  <span class="comment">!  enddo</span></div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;  <span class="comment">!enddo</span></div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;  <span class="comment">!close(1905)</span></div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160; </div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;  <span class="comment">! test if qE is positive</span></div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;  <span class="keywordflow">if</span> (any(cs%tidal_qe_3d_in&lt;0.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;read_tidal_constituents: Negative tidal_qe_3d_in terms.&quot;</span>)</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160; </div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;  <span class="comment">!! collapse 3D q*E to 2D q*E</span></div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;  <span class="comment">!CS%tidal_qe_2d(:,:) = 0.0</span></div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;  <span class="comment">!do k=1,nz_in(1) ; do j=js,je ; do i=is,ie</span></div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;  <span class="comment">!  if (z_t(k) &lt;= G%bathyT(i,j)) &amp;</span></div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;  <span class="comment">!    CS%tidal_qe_2d(i,j) = CS%tidal_qe_2d(i,j) + CS%tidal_qe_3d_in(i,j,k)</span></div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;  <span class="comment">!enddo ; enddo ; enddo</span></div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160; </div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;  <span class="comment">! initialize input remapping:</span></div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;  <span class="keyword">call </span>initialize_remapping(cs%remap_cs, remapping_scheme=<span class="stringliteral">&quot;PLM&quot;</span>, &amp;</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;                            boundary_extrapolation=.false., check_remapping=cs%debug)</div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160; </div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;  <span class="keyword">deallocate</span>(tc_m2)</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;  <span class="keyword">deallocate</span>(tc_s2)</div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;  <span class="keyword">deallocate</span>(tc_k1)</div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;  <span class="keyword">deallocate</span>(tc_o1)</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;  <span class="keyword">deallocate</span>(z_t)</div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;  <span class="keyword">deallocate</span>(z_w)</div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__remapping_8F90_source.html#l01541">mom_remapping::initialize_remapping()</a>, and <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__tidal__mixing_8F90_source.html#l01473">read_tidal_energy()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__tidal__mixing_a30a24b88982a5134253679d9484b3708_cgraph.svg" width="100%" height="388"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__tidal__mixing_a30a24b88982a5134253679d9484b3708_icgraph.svg" width="612" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="adfd3a137ee6402fdcdfb7c46711e0e23"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adfd3a137ee6402fdcdfb7c46711e0e23">&#9670;&nbsp;</a></span>read_tidal_energy()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_tidal_mixing::read_tidal_energy </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=20), intent(in)&#160;</td>
          <td class="paramname"><em>tidal_energy_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=200), intent(in)&#160;</td>
          <td class="paramname"><em>tidal_energy_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__tidal__mixing_1_1tidal__mixing__cs.html">tidal_mixing_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine read tidal energy inputs from a file. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tidal_energy_type</td><td>The type of tidal energy inputs to read </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tidal_energy_file</td><td>The file from which to read tidalinputs </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure for this module </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l01473">1473</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span> :: G<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span> :: US<span class="comment">   !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;  <span class="keywordtype">character(len=20)</span>,       <span class="keywordtype">intent(in)</span> :: tidal_energy_type<span class="comment"> !&lt; The type of tidal energy inputs to read</span></div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;  <span class="keywordtype">character(len=200)</span>,      <span class="keywordtype">intent(in)</span> :: tidal_energy_file<span class="comment"> !&lt; The file from which to read tidalinputs</span></div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;  <span class="keywordtype">type</span>(tidal_mixing_cs),   <span class="keywordtype">pointer</span>    :: CS<span class="comment">   !&lt; The control structure for this module</span></div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;  <span class="comment">! local</span></div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;  <span class="keywordtype">integer</span> :: i, j, isd, ied, jsd, jed, nz</div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">dimension(:,:)</span> :: tidal_energy_flux_2d <span class="comment">! input tidal energy flux at T-grid points [W m-2]</span></div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160; </div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed ; nz = g%ke</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160; </div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;  <span class="keywordflow">select case</span> (uppercase(tidal_energy_type(1:4)))</div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;  <span class="keywordflow">case</span> (<span class="stringliteral">&#39;JAYN&#39;</span>) <span class="comment">! Jayne 2009</span></div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;    <span class="keywordflow">if</span> (.not. <span class="keyword">allocated</span>(cs%tidal_qe_2d)) <span class="keyword">allocate</span>(cs%tidal_qe_2d(isd:ied,jsd:jed))</div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;    <span class="keyword">allocate</span>(tidal_energy_flux_2d(isd:ied,jsd:jed))</div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;    <span class="keyword">call </span>mom_read_data(tidal_energy_file,<span class="stringliteral">&#39;wave_dissipation&#39;</span>,tidal_energy_flux_2d, g%domain)</div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;    <span class="keywordflow">do</span> j=g%jsc,g%jec ; <span class="keywordflow">do</span> i=g%isc,g%iec</div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;      cs%tidal_qe_2d(i,j) = cs%Gamma_itides * tidal_energy_flux_2d(i,j)</div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;    <span class="keyword">deallocate</span>(tidal_energy_flux_2d)</div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;  <span class="keywordflow">case</span> (<span class="stringliteral">&#39;ER03&#39;</span>) <span class="comment">! Egbert &amp; Ray 2003</span></div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;    <span class="keyword">call </span>read_tidal_constituents(g, us, tidal_energy_file, cs)</div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;<span class="keywordflow">  case default</span></div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;read_tidal_energy: Unknown tidal energy file type.&quot;</span>)</div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;<span class="keywordflow">  end select</span></div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l01503">read_tidal_constituents()</a>, and <a class="el" href="MOM__string__functions_8F90_source.html#l00042">mom_string_functions::uppercase()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00207">tidal_mixing_init()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__tidal__mixing_adfd3a137ee6402fdcdfb7c46711e0e23_cgraph.svg" width="100%" height="434"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__tidal__mixing_adfd3a137ee6402fdcdfb7c46711e0e23_icgraph.svg" width="395" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a7d2dfb64df35957d1252ce841c0cdf43"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7d2dfb64df35957d1252ce841c0cdf43">&#9670;&nbsp;</a></span>setup_tidal_diagnostics()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_tidal_mixing::setup_tidal_diagnostics </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__tidal__mixing_1_1tidal__mixing__cs.html">tidal_mixing_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sets up diagnostics arrays for tidal mixing. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure for this module </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l01322">1322</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(in)</span> :: G<span class="comment">  !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;  <span class="keywordtype">type</span>(tidal_mixing_cs), <span class="keywordtype">pointer</span>    :: CS<span class="comment"> !&lt; The control structure for this module</span></div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160; </div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;  <span class="comment">! local</span></div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;  <span class="keywordtype">integer</span> :: isd, ied, jsd, jed, nz</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;  <span class="keywordtype">type</span>(tidal_mixing_diags), <span class="keywordtype">pointer</span> :: dd =&gt; null()</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160; </div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;  isd = g%isd; ied = g%ied; jsd = g%jsd; jed = g%jed; nz = g%ke</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;  dd =&gt; cs%dd</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160; </div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;  <span class="keywordflow">if</span> ((cs%id_Kd_itidal &gt; 0) .or. (cs%id_Kd_Itidal_work &gt; 0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_itidal(isd:ied,jsd:jed,nz+1)) ; dd%Kd_itidal(:,:,:) = 0.0</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;  <span class="keywordflow">if</span> ((cs%id_Kd_lowmode &gt; 0) .or. (cs%id_Kd_lowmode_work &gt; 0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_lowmode(isd:ied,jsd:jed,nz+1)) ; dd%Kd_lowmode(:,:,:) = 0.0</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;  <span class="keywordflow">if</span> ( (cs%id_Fl_itidal &gt; 0) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;    <span class="keyword">allocate</span>(dd%Fl_itidal(isd:ied,jsd:jed,nz+1)) ; dd%Fl_itidal(:,:,:) = 0.0</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;  <span class="keywordflow">if</span> ( (cs%id_Fl_lowmode &gt; 0) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;    <span class="keyword">allocate</span>(dd%Fl_lowmode(isd:ied,jsd:jed,nz+1)) ; dd%Fl_lowmode(:,:,:) = 0.0</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;  <span class="keywordflow">if</span> ( (cs%id_Polzin_decay_scale &gt; 0) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;    <span class="keyword">allocate</span>(dd%Polzin_decay_scale(isd:ied,jsd:jed))</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;    dd%Polzin_decay_scale(:,:) = 0.0</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;  <span class="keywordflow">if</span> ( (cs%id_N2_bot &gt; 0) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    <span class="keyword">allocate</span>(dd%N2_bot(isd:ied,jsd:jed)) ; dd%N2_bot(:,:) = 0.0</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;  <span class="keywordflow">if</span> ( (cs%id_N2_meanz &gt; 0) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;    <span class="keyword">allocate</span>(dd%N2_meanz(isd:ied,jsd:jed)) ; dd%N2_meanz(:,:) = 0.0</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;  <span class="keywordflow">if</span> ( (cs%id_Polzin_decay_scale_scaled &gt; 0) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;    <span class="keyword">allocate</span>(dd%Polzin_decay_scale_scaled(isd:ied,jsd:jed))</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;    dd%Polzin_decay_scale_scaled(:,:) = 0.0</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;  <span class="keywordflow">if</span> ((cs%id_Kd_Niku &gt; 0) .or. (cs%id_Kd_Niku_work &gt; 0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_Niku(isd:ied,jsd:jed,nz+1)) ; dd%Kd_Niku(:,:,:) = 0.0</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kd_Niku_work &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_Niku_work(isd:ied,jsd:jed,nz)) ; dd%Kd_Niku_work(:,:,:) = 0.0</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kd_Itidal_work &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_Itidal_work(isd:ied,jsd:jed,nz))</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;    dd%Kd_Itidal_work(:,:,:) = 0.0</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kd_Lowmode_Work &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_Lowmode_Work(isd:ied,jsd:jed,nz))</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;    dd%Kd_Lowmode_Work(:,:,:) = 0.0</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;  <span class="keywordflow">if</span> (cs%id_TKE_itidal &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;    <span class="keyword">allocate</span>(dd%TKE_Itidal_used(isd:ied,jsd:jed)) ; dd%TKE_Itidal_used(:,:) = 0.</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;  <span class="comment">! additional diags for CVMix</span></div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;  <span class="keywordflow">if</span> (cs%id_N2_int &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;    <span class="keyword">allocate</span>(dd%N2_int(isd:ied,jsd:jed,nz+1)) ; dd%N2_int(:,:,:) = 0.0</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;  <span class="keywordflow">if</span> (cs%id_Simmons_coeff &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;    <span class="keywordflow">if</span> (cs%CVMix_tidal_scheme .ne. simmons) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;setup_tidal_diagnostics: Simmons_coeff diagnostics is available &quot;</span>//&amp;</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;                            <span class="stringliteral">&quot;only when CVMix_tidal_scheme is Simmons&quot;</span>)</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;    <span class="keyword">allocate</span>(dd%Simmons_coeff_2d(isd:ied,jsd:jed)) ; dd%Simmons_coeff_2d(:,:) = 0.0</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;  <span class="keywordflow">if</span> (cs%id_vert_dep &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    <span class="keyword">allocate</span>(dd%vert_dep_3d(isd:ied,jsd:jed,nz+1)) ; dd%vert_dep_3d(:,:,:) = 0.0</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;  <span class="keywordflow">if</span> (cs%id_Schmittner_coeff &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;    <span class="keywordflow">if</span> (cs%CVMix_tidal_scheme .ne. schmittner) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;setup_tidal_diagnostics: Schmittner_coeff diagnostics is available &quot;</span>//&amp;</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;                            <span class="stringliteral">&quot;only when CVMix_tidal_scheme is Schmittner.&quot;</span>)</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;    <span class="keyword">allocate</span>(dd%Schmittner_coeff_3d(isd:ied,jsd:jed,nz)) ; dd%Schmittner_coeff_3d(:,:,:) = 0.0</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;  <span class="keywordflow">if</span> (cs%id_tidal_qe_md &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;    <span class="keywordflow">if</span> (cs%CVMix_tidal_scheme .ne. schmittner) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;setup_tidal_diagnostics: tidal_qe_md diagnostics is available &quot;</span>//&amp;</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;                            <span class="stringliteral">&quot;only when CVMix_tidal_scheme is Schmittner.&quot;</span>)</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;    <span class="keyword">allocate</span>(dd%tidal_qe_md(isd:ied,jsd:jed,nz)) ; dd%tidal_qe_md(:,:,:) = 0.0</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;<span class="keywordflow">  endif</span></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00200">schmittner</a>, and <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00199">simmons</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00201">mom_set_diffusivity::set_diffusivity()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__tidal__mixing_a7d2dfb64df35957d1252ce841c0cdf43_cgraph.svg" width="588" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__tidal__mixing_a7d2dfb64df35957d1252ce841c0cdf43_icgraph.svg" width="378" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a4ec08e118dea2ecbac7e719ed73acc70"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4ec08e118dea2ecbac7e719ed73acc70">&#9670;&nbsp;</a></span>tidal_mixing_end()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_tidal_mixing::tidal_mixing_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__tidal__mixing_1_1tidal__mixing__cs.html">tidal_mixing_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Clear pointers and deallocate memory. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">cs</td><td>This module's control structure, which will be deallocated in this routine. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l01614">1614</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;  <span class="keywordtype">type</span>(tidal_mixing_cs), <span class="keywordtype">pointer</span> :: CS<span class="comment"> !&lt; This module&#39;s control structure, which</span></div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;<span class="comment">                                       !! will be deallocated in this routine.</span></div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160; </div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keywordflow">return</span></div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160; </div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;  <span class="comment">!TODO deallocate all the dynamically allocated members here ...</span></div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%tidal_qe_2d))    <span class="keyword">deallocate</span>(cs%tidal_qe_2d)</div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%tidal_qe_3d_in)) <span class="keyword">deallocate</span>(cs%tidal_qe_3d_in)</div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%h_src))          <span class="keyword">deallocate</span>(cs%h_src)</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;  <span class="keyword">deallocate</span>(cs%dd)</div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;  <span class="keyword">deallocate</span>(cs)</div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__diabatic__driver_8F90_source.html#l03289">mom_diabatic_driver::diabatic_driver_end()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__tidal__mixing_a4ec08e118dea2ecbac7e719ed73acc70_icgraph.svg" width="378" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a6278fe41ef74ac23ba02ae1540104c5f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6278fe41ef74ac23ba02ae1540104c5f">&#9670;&nbsp;</a></span>tidal_mixing_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">logical function, public mom_tidal_mixing::tidal_mixing_init </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(inout), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__tidal__mixing_1_1tidal__mixing__cs.html">tidal_mixing_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initializes internal tidal dissipation scheme for diapycnal mixing. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>The current time. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Vertical grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>Run-time parameter file handle </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">diag</td><td>Diagnostics control structure. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>This module's control structure. </td></tr>
  </table>
  </dd>
</dl>
<p>TODO: add units</p>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00207">207</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;  <span class="keywordtype">type</span>(time_type),          <span class="keywordtype">intent(in)</span>    :: Time<span class="comment">       !&lt; The current time.</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),    <span class="keywordtype">intent(in)</span>    :: G<span class="comment">          !&lt; Grid structure.</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type),  <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">         !&lt; Vertical grid structure.</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),    <span class="keywordtype">intent(in)</span>    :: US<span class="comment">         !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;  <span class="keywordtype">type</span>(param_file_type),    <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; Run-time parameter file handle</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>,  <span class="keywordtype">intent(inout)</span> :: diag<span class="comment">       !&lt; Diagnostics control structure.</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;  <span class="keywordtype">type</span>(tidal_mixing_cs),    <span class="keywordtype">pointer</span>       :: CS<span class="comment">         !&lt; This module&#39;s control structure.</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160; </div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  <span class="keywordtype">logical</span> :: read_tideamp</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;  <span class="keywordtype">character(len=20)</span>  :: tmpstr, int_tide_profile_str</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;  <span class="keywordtype">character(len=20)</span>  :: CVMix_tidal_scheme_str, tidal_energy_type</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  <span class="keywordtype">character(len=200)</span> :: filename, h2_file, Niku_TKE_input_file</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;  <span class="keywordtype">character(len=200)</span> :: tidal_energy_file, tideamp_file</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="keywordtype">  real</span> :: utide, hamp, prandtl_tidal</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="keywordtype">  real</span> :: Niku_scale <span class="comment">! local variable for scaling the Nikurashin TKE flux data</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;  <span class="keywordtype">integer</span> :: isd, ied, jsd, jed</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160; </div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;tidal_mixing_init called when control structure &quot;</span>// &amp;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                            <span class="stringliteral">&quot;is already associated.&quot;</span>)</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keywordflow">return</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;  <span class="keyword">allocate</span>(cs)</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;  <span class="keyword">allocate</span>(cs%dd)</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160; </div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;  cs%debug = cs%debug.and.is_root_pe()</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160; </div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;  is  = g%isc ; ie  = g%iec ; js  = g%jsc ; je  = g%jec</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160; </div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;  cs%diag =&gt; diag</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; </div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;  <span class="comment">! Read parameters</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, &amp;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="stringliteral">&quot;Vertical Tidal Mixing Parameterization&quot;</span>)</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_CVMix_TIDAL&quot;</span>, cs%use_CVMix_tidal, &amp;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                 <span class="stringliteral">&quot;If true, turns on tidal mixing via CVMix&quot;</span>, &amp;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                 default=.false.)</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160; </div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INPUTDIR&quot;</span>, cs%inputdir, default=<span class="stringliteral">&quot;.&quot;</span>,do_not_log=.true.)</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;  cs%inputdir = slasher(cs%inputdir)</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INT_TIDE_DISSIPATION&quot;</span>, cs%int_tide_dissipation, &amp;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                 <span class="stringliteral">&quot;If true, use an internal tidal dissipation scheme to &quot;</span>//&amp;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                 <span class="stringliteral">&quot;drive diapycnal mixing, along the lines of St. Laurent &quot;</span>//&amp;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                 <span class="stringliteral">&quot;et al. (2002) and Simmons et al. (2004).&quot;</span>, default=cs%use_CVMix_tidal)</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160; </div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  <span class="comment">! return if tidal mixing is inactive</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  tidal_mixing_init = cs%int_tide_dissipation</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;  <span class="keywordflow">if</span> (.not. tidal_mixing_init) <span class="keywordflow">return</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160; </div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;  <span class="keywordflow">if</span> (cs%int_tide_dissipation) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160; </div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="comment">! Read in CVMix tidal scheme if CVMix tidal mixing is on</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="keywordflow">if</span> (cs%use_CVMix_tidal) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;CVMIX_TIDAL_SCHEME&quot;</span>, cvmix_tidal_scheme_str, &amp;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                 <span class="stringliteral">&quot;CVMIX_TIDAL_SCHEME selects the CVMix tidal mixing &quot;</span>//&amp;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                 <span class="stringliteral">&quot;scheme with INT_TIDE_DISSIPATION. Valid values are:\n&quot;</span>//&amp;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                 <span class="stringliteral">&quot;\t SIMMONS - Use the Simmons et al (2004) tidal \n&quot;</span>//&amp;</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                 <span class="stringliteral">&quot;\t                mixing scheme.\n&quot;</span>//&amp;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                 <span class="stringliteral">&quot;\t SCHMITTNER - Use the Schmittner et al (2014) tidal \n&quot;</span>//&amp;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                 <span class="stringliteral">&quot;\t                mixing scheme.&quot;</span>, &amp;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                 default=simmons_scheme_string)</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;      cvmix_tidal_scheme_str = uppercase(cvmix_tidal_scheme_str)</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160; </div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;      <span class="keywordflow">select case</span> (cvmix_tidal_scheme_str)</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        <span class="keywordflow">case</span> (simmons_scheme_string)    ; cs%CVMix_tidal_scheme = simmons</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        <span class="keywordflow">case</span> (schmittner_scheme_string) ; cs%CVMix_tidal_scheme = schmittner</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="keywordflow">        case default</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;tidal_mixing_init: Unrecognized setting &quot;</span>// &amp;</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;            <span class="stringliteral">&quot;#define CVMIX_TIDAL_SCHEME &quot;</span>//trim(cvmix_tidal_scheme_str)//<span class="stringliteral">&quot; found in input file.&quot;</span>)</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="keywordflow">      end select</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">! CS%use_CVMix_tidal</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160; </div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="comment">! Read in vertical profile of tidal energy dissipation</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <span class="keywordflow">if</span> ( cs%CVMix_tidal_scheme.eq.schmittner .or. .not. cs%use_CVMix_tidal) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INT_TIDE_PROFILE&quot;</span>, int_tide_profile_str, &amp;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                   <span class="stringliteral">&quot;INT_TIDE_PROFILE selects the vertical profile of energy &quot;</span>//&amp;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                   <span class="stringliteral">&quot;dissipation with INT_TIDE_DISSIPATION. Valid values are:\n&quot;</span>//&amp;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                   <span class="stringliteral">&quot;\t STLAURENT_02 - Use the St. Laurent et al exponential \n&quot;</span>//&amp;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                   <span class="stringliteral">&quot;\t                decay profile.\n&quot;</span>//&amp;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                   <span class="stringliteral">&quot;\t POLZIN_09 - Use the Polzin WKB-stretched algebraic \n&quot;</span>//&amp;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                   <span class="stringliteral">&quot;\t                decay profile.&quot;</span>, &amp;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                   default=stlaurent_profile_string)</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;      int_tide_profile_str = uppercase(int_tide_profile_str)</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160; </div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;      <span class="keywordflow">select case</span> (int_tide_profile_str)</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <span class="keywordflow">case</span> (stlaurent_profile_string)   ; cs%int_tide_profile = stlaurent_02</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        <span class="keywordflow">case</span> (polzin_profile_string)      ; cs%int_tide_profile = polzin_09</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="keywordflow">        case default</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;          <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;tidal_mixing_init: Unrecognized setting &quot;</span>// &amp;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;              <span class="stringliteral">&quot;#define INT_TIDE_PROFILE &quot;</span>//trim(int_tide_profile_str)//<span class="stringliteral">&quot; found in input file.&quot;</span>)</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="keywordflow">      end select</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160; </div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  <span class="keywordflow">elseif</span> (cs%use_CVMix_tidal) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;tidal_mixing_init: Cannot set INT_TIDE_DISSIPATION to False &quot;</span>// &amp;</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;            <span class="stringliteral">&quot;when USE_CVMix_TIDAL is set to True.&quot;</span>)</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160; </div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LEE_WAVE_DISSIPATION&quot;</span>, cs%Lee_wave_dissipation, &amp;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                 <span class="stringliteral">&quot;If true, use an lee wave driven dissipation scheme to &quot;</span>//&amp;</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                 <span class="stringliteral">&quot;drive diapycnal mixing, along the lines of Nikurashin &quot;</span>//&amp;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                 <span class="stringliteral">&quot;(2010) and using the St. Laurent et al. (2002) &quot;</span>//&amp;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                 <span class="stringliteral">&quot;and Simmons et al. (2004) vertical profile&quot;</span>, default=.false.)</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  <span class="keywordflow">if</span> (cs%lee_wave_dissipation) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="keywordflow">if</span> (cs%use_CVMix_tidal) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;tidal_mixing_init: Lee wave driven dissipation scheme cannot &quot;</span>// &amp;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;            <span class="stringliteral">&quot;be used when CVMix tidal mixing scheme is active.&quot;</span>)</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LEE_WAVE_PROFILE&quot;</span>, tmpstr, &amp;</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                 <span class="stringliteral">&quot;LEE_WAVE_PROFILE selects the vertical profile of energy &quot;</span>//&amp;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;                 <span class="stringliteral">&quot;dissipation with LEE_WAVE_DISSIPATION. Valid values are:\n&quot;</span>//&amp;</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                 <span class="stringliteral">&quot;\t STLAURENT_02 - Use the St. Laurent et al exponential \n&quot;</span>//&amp;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                 <span class="stringliteral">&quot;\t                decay profile.\n&quot;</span>//&amp;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                 <span class="stringliteral">&quot;\t POLZIN_09 - Use the Polzin WKB-stretched algebraic \n&quot;</span>//&amp;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                 <span class="stringliteral">&quot;\t                decay profile.&quot;</span>, &amp;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                 default=stlaurent_profile_string)</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    tmpstr = uppercase(tmpstr)</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="keywordflow">select case</span> (tmpstr)</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;      <span class="keywordflow">case</span> (stlaurent_profile_string) ; cs%lee_wave_profile = stlaurent_02</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;      <span class="keywordflow">case</span> (polzin_profile_string) ; cs%lee_wave_profile = polzin_09</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="keywordflow">      case default</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;tidal_mixing_init: Unrecognized setting &quot;</span>// &amp;</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;            <span class="stringliteral">&quot;#define LEE_WAVE_PROFILE &quot;</span>//trim(tmpstr)//<span class="stringliteral">&quot; found in input file.&quot;</span>)</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="keywordflow">    end select</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160; </div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INT_TIDE_LOWMODE_DISSIPATION&quot;</span>, cs%Lowmode_itidal_dissipation, &amp;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                 <span class="stringliteral">&quot;If true, consider mixing due to breaking low modes that &quot;</span>//&amp;</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                 <span class="stringliteral">&quot;have been remotely generated; as with itidal drag on the &quot;</span>//&amp;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                 <span class="stringliteral">&quot;barotropic tide, use an internal tidal dissipation scheme to &quot;</span>//&amp;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                 <span class="stringliteral">&quot;drive diapycnal mixing, along the lines of St. Laurent &quot;</span>//&amp;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;                 <span class="stringliteral">&quot;et al. (2002) and Simmons et al. (2004).&quot;</span>, default=.false.)</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160; </div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;  <span class="keywordflow">if</span> ((cs%Int_tide_dissipation .and. (cs%int_tide_profile == polzin_09)) .or. &amp;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;      (cs%lee_wave_dissipation .and. (cs%lee_wave_profile == polzin_09))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    <span class="keywordflow">if</span> (cs%use_CVMix_tidal) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;tidal_mixing_init: Polzin scheme cannot &quot;</span>// &amp;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;            <span class="stringliteral">&quot;be used when CVMix tidal mixing scheme is active.&quot;</span>)</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NU_POLZIN&quot;</span>, cs%Nu_Polzin, &amp;</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                 <span class="stringliteral">&quot;When the Polzin decay profile is used, this is a &quot;</span>//&amp;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                 <span class="stringliteral">&quot;non-dimensional constant in the expression for the &quot;</span>//&amp;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                 <span class="stringliteral">&quot;vertical scale of decay for the tidal energy dissipation.&quot;</span>, &amp;</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0697)</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NBOTREF_POLZIN&quot;</span>, cs%Nbotref_Polzin, &amp;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                 <span class="stringliteral">&quot;When the Polzin decay profile is used, this is the &quot;</span>//&amp;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                 <span class="stringliteral">&quot;reference value of the buoyancy frequency at the ocean &quot;</span>//&amp;</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                 <span class="stringliteral">&quot;bottom in the Polzin formulation for the vertical &quot;</span>//&amp;</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                 <span class="stringliteral">&quot;scale of decay for the tidal energy dissipation.&quot;</span>, &amp;</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                 units=<span class="stringliteral">&quot;s-1&quot;</span>, default=9.61e-4)</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;POLZIN_DECAY_SCALE_FACTOR&quot;</span>, &amp;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                 cs%Polzin_decay_scale_factor, &amp;</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                 <span class="stringliteral">&quot;When the Polzin decay profile is used, this is a &quot;</span>//&amp;</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                 <span class="stringliteral">&quot;scale factor for the vertical scale of decay of the tidal &quot;</span>//&amp;</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                 <span class="stringliteral">&quot;energy dissipation.&quot;</span>, default=1.0, units=<span class="stringliteral">&quot;nondim&quot;</span>)</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;POLZIN_SCALE_MAX_FACTOR&quot;</span>, &amp;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                 cs%Polzin_decay_scale_max_factor, &amp;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                 <span class="stringliteral">&quot;When the Polzin decay profile is used, this is a factor &quot;</span>//&amp;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;                 <span class="stringliteral">&quot;to limit the vertical scale of decay of the tidal &quot;</span>//&amp;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                 <span class="stringliteral">&quot;energy dissipation to POLZIN_DECAY_SCALE_MAX_FACTOR &quot;</span>//&amp;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                 <span class="stringliteral">&quot;times the depth of the ocean.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0)</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;POLZIN_MIN_DECAY_SCALE&quot;</span>, cs%Polzin_min_decay_scale, &amp;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                 <span class="stringliteral">&quot;When the Polzin decay profile is used, this is the &quot;</span>//&amp;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                 <span class="stringliteral">&quot;minimum vertical decay scale for the vertical profile\n&quot;</span>//&amp;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                 <span class="stringliteral">&quot;of internal tide dissipation with the Polzin (2009) formulation&quot;</span>, &amp;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                 units=<span class="stringliteral">&quot;m&quot;</span>, default=0.0, scale=us%m_to_Z)</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160; </div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;  <span class="keywordflow">if</span> (cs%Int_tide_dissipation .or. cs%Lee_wave_dissipation) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INT_TIDE_DECAY_SCALE&quot;</span>, cs%Int_tide_decay_scale, &amp;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                 <span class="stringliteral">&quot;The decay scale away from the bottom for tidal TKE with &quot;</span>//&amp;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                 <span class="stringliteral">&quot;the new coding when INT_TIDE_DISSIPATION is used.&quot;</span>, &amp;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                 <span class="comment">!units=&quot;m&quot;, default=0.0)</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                 units=<span class="stringliteral">&quot;m&quot;</span>, default=500.0, scale=us%m_to_Z)  <span class="comment">! TODO: confirm this new default</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MU_ITIDES&quot;</span>, cs%Mu_itides, &amp;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;                 <span class="stringliteral">&quot;A dimensionless turbulent mixing efficiency used with &quot;</span>//&amp;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                 <span class="stringliteral">&quot;INT_TIDE_DISSIPATION, often 0.2.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.2)</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;GAMMA_ITIDES&quot;</span>, cs%Gamma_itides, &amp;</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                 <span class="stringliteral">&quot;The fraction of the internal tidal energy that is &quot;</span>//&amp;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                 <span class="stringliteral">&quot;dissipated locally with INT_TIDE_DISSIPATION. &quot;</span>//&amp;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                 <span class="stringliteral">&quot;THIS NAME COULD BE BETTER.&quot;</span>, &amp;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.3333)</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MIN_ZBOT_ITIDES&quot;</span>, cs%min_zbot_itides, &amp;</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                 <span class="stringliteral">&quot;Turn off internal tidal dissipation when the total &quot;</span>//&amp;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                 <span class="stringliteral">&quot;ocean depth is less than this value.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, default=0.0, scale=us%m_to_Z)</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160; </div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;  <span class="keywordflow">if</span> ( (cs%Int_tide_dissipation .or. cs%Lee_wave_dissipation) .and. &amp;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        .not. cs%use_CVMix_tidal) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160; </div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <span class="keyword">call </span>safe_alloc_ptr(cs%Nb,isd,ied,jsd,jed)</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="keyword">call </span>safe_alloc_ptr(cs%h2,isd,ied,jsd,jed)</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="keyword">call </span>safe_alloc_ptr(cs%TKE_itidal,isd,ied,jsd,jed)</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="keyword">call </span>safe_alloc_ptr(cs%mask_itidal,isd,ied,jsd,jed) ; cs%mask_itidal(:,:) = 1.0</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160; </div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KAPPA_ITIDES&quot;</span>, cs%kappa_itides, &amp;</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;                 <span class="stringliteral">&quot;A topographic wavenumber used with INT_TIDE_DISSIPATION. &quot;</span>//&amp;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                 <span class="stringliteral">&quot;The default is 2pi/10 km, as in St.Laurent et al. 2002.&quot;</span>, &amp;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                 units=<span class="stringliteral">&quot;m-1&quot;</span>, default=8.e-4*atan(1.0), scale=us%Z_to_m)</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160; </div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;UTIDE&quot;</span>, cs%utide, &amp;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                 <span class="stringliteral">&quot;The constant tidal amplitude used with INT_TIDE_DISSIPATION.&quot;</span>, &amp;</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                 units=<span class="stringliteral">&quot;m s-1&quot;</span>, default=0.0, scale=us%m_to_Z*us%T_to_s)</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    <span class="keyword">call </span>safe_alloc_ptr(cs%tideamp,is,ie,js,je) ; cs%tideamp(:,:) = cs%utide</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160; </div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KAPPA_H2_FACTOR&quot;</span>, cs%kappa_h2_factor, &amp;</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                 <span class="stringliteral">&quot;A scaling factor for the roughness amplitude with &quot;</span>//&amp;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                 <span class="stringliteral">&quot;INT_TIDE_DISSIPATION.&quot;</span>,  units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0)</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TKE_ITIDE_MAX&quot;</span>, cs%TKE_itide_max, &amp;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                 <span class="stringliteral">&quot;The maximum internal tide energy source available to mix &quot;</span>//&amp;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                 <span class="stringliteral">&quot;above the bottom boundary layer with INT_TIDE_DISSIPATION.&quot;</span>, &amp;</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                 units=<span class="stringliteral">&quot;W m-2&quot;</span>,  default=1.0e3, scale=us%m_to_Z**3*us%T_to_s**3)</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160; </div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;READ_TIDEAMP&quot;</span>, read_tideamp, &amp;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                 <span class="stringliteral">&quot;If true, read a file (given by TIDEAMP_FILE) containing &quot;</span>//&amp;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                 <span class="stringliteral">&quot;the tidal amplitude with INT_TIDE_DISSIPATION.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    <span class="keywordflow">if</span> (read_tideamp) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;      <span class="keywordflow">if</span> (cs%use_CVMix_tidal) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;          <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;tidal_mixing_init: Tidal amplitude files are &quot;</span>// &amp;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;              <span class="stringliteral">&quot;not compatible with CVMix tidal mixing. &quot;</span>)</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TIDEAMP_FILE&quot;</span>, tideamp_file, &amp;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                 <span class="stringliteral">&quot;The path to the file containing the spatially varying &quot;</span>//&amp;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                 <span class="stringliteral">&quot;tidal amplitudes with INT_TIDE_DISSIPATION.&quot;</span>, default=<span class="stringliteral">&quot;tideamp.nc&quot;</span>)</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;      filename = trim(cs%inputdir) // trim(tideamp_file)</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;      <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;INPUTDIR/TIDEAMP_FILE&quot;</span>, filename)</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;      <span class="keyword">call </span>mom_read_data(filename, <span class="stringliteral">&#39;tideamp&#39;</span>, cs%tideamp, g%domain, timelevel=1, scale=us%m_to_Z*us%T_to_s)</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160; </div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;H2_FILE&quot;</span>, h2_file, &amp;</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                 <span class="stringliteral">&quot;The path to the file containing the sub-grid-scale &quot;</span>//&amp;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                 <span class="stringliteral">&quot;topographic roughness amplitude with INT_TIDE_DISSIPATION.&quot;</span>, &amp;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                 fail_if_missing=(.not.cs%use_CVMix_tidal))</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    filename = trim(cs%inputdir) // trim(h2_file)</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;INPUTDIR/H2_FILE&quot;</span>, filename)</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    <span class="keyword">call </span>mom_read_data(filename, <span class="stringliteral">&#39;h2&#39;</span>, cs%h2, g%domain, timelevel=1, scale=us%m_to_Z**2)</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160; </div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;      <span class="keywordflow">if</span> (g%bathyT(i,j) &lt; cs%min_zbot_itides) cs%mask_itidal(i,j) = 0.0</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;      cs%tideamp(i,j) = cs%tideamp(i,j) * cs%mask_itidal(i,j) * g%mask2dT(i,j)</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160; </div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;      <span class="comment">! Restrict rms topo to 10 percent of column depth.</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;      <span class="comment">!### Note the hard-coded nondimensional constant, and that this could be simplified.</span></div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;      hamp = min(0.1*g%bathyT(i,j),sqrt(cs%h2(i,j)))</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;      cs%h2(i,j) = hamp*hamp</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160; </div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;      utide = cs%tideamp(i,j)</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;      <span class="comment">! Compute the fixed part of internal tidal forcing; units are [kg Z3 m-3 T-2 ~&gt; J m-2 = kg s-2] here.</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;      cs%TKE_itidal(i,j) = 0.5 * cs%kappa_h2_factor * gv%Rho0 * &amp;</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;           cs%kappa_itides * cs%h2(i,j) * utide*utide</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160; </div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160; </div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  <span class="keywordflow">if</span> (cs%Lee_wave_dissipation) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160; </div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NIKURASHIN_TKE_INPUT_FILE&quot;</span>,niku_tke_input_file, &amp;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                 <span class="stringliteral">&quot;The path to the file containing the TKE input from lee &quot;</span>//&amp;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                 <span class="stringliteral">&quot;wave driven mixing. Used with LEE_WAVE_DISSIPATION.&quot;</span>, &amp;</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                 fail_if_missing=.true.)</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NIKURASHIN_SCALE&quot;</span>,niku_scale, &amp;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                 <span class="stringliteral">&quot;A non-dimensional factor by which to scale the lee-wave &quot;</span>//&amp;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                 <span class="stringliteral">&quot;driven TKE input. Used with LEE_WAVE_DISSIPATION.&quot;</span>, &amp;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0)</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160; </div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    filename = trim(cs%inputdir) // trim(niku_tke_input_file)</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;INPUTDIR/NIKURASHIN_TKE_INPUT_FILE&quot;</span>, &amp;</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                   filename)</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="keyword">call </span>safe_alloc_ptr(cs%TKE_Niku,is,ie,js,je) ; cs%TKE_Niku(:,:) = 0.0</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    <span class="keyword">call </span>mom_read_data(filename, <span class="stringliteral">&#39;TKE_input&#39;</span>, cs%TKE_Niku, g%domain, timelevel=1, &amp;  <span class="comment">! ??? timelevel -aja</span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                       scale=us%m_to_Z**3*us%T_to_s**3)</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    cs%TKE_Niku(:,:) = niku_scale * cs%TKE_Niku(:,:)</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160; </div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;GAMMA_NIKURASHIN&quot;</span>,cs%Gamma_lee, &amp;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                 <span class="stringliteral">&quot;The fraction of the lee wave energy that is dissipated &quot;</span>//&amp;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                 <span class="stringliteral">&quot;locally with LEE_WAVE_DISSIPATION.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, &amp;</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                 default=0.3333)</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DECAY_SCALE_FACTOR_LEE&quot;</span>,cs%Decay_scale_factor_lee, &amp;</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                 <span class="stringliteral">&quot;Scaling for the vertical decay scaleof the local &quot;</span>//&amp;</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                 <span class="stringliteral">&quot;dissipation of lee waves dissipation.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, &amp;</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                 default=1.0)</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    cs%Decay_scale_factor_lee = -9.e99 <span class="comment">! This should never be used if CS%Lee_wave_dissipation = False</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160; </div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;  <span class="comment">! Configure CVMix</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;  <span class="keywordflow">if</span> (cs%use_CVMix_tidal) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160; </div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="comment">! Read in CVMix params</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="comment">!call openParameterBlock(param_file,&#39;CVMix_TIDAL&#39;)</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TIDAL_MAX_COEF&quot;</span>, cs%tidal_max_coef, &amp;</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                   <span class="stringliteral">&quot;largest acceptable value for tidal diffusivity&quot;</span>, &amp;</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                   units=<span class="stringliteral">&quot;m^2/s&quot;</span>, default=50e-4) <span class="comment">! the default is 50e-4 in CVMix, 100e-4 in POP.</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TIDAL_DISS_LIM_TC&quot;</span>, cs%tidal_diss_lim_tc, &amp;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                   <span class="stringliteral">&quot;Min allowable depth for dissipation for tidal-energy-constituent data. &quot;</span>//&amp;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                   <span class="stringliteral">&quot;No dissipation contribution is applied above TIDAL_DISS_LIM_TC.&quot;</span>, &amp;</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                   units=<span class="stringliteral">&quot;m&quot;</span>, default=0.0, scale=us%m_to_Z)</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TIDAL_ENERGY_FILE&quot;</span>,tidal_energy_file, &amp;</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                 <span class="stringliteral">&quot;The path to the file containing tidal energy &quot;</span>//&amp;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                 <span class="stringliteral">&quot;dissipation. Used with CVMix tidal mixing schemes.&quot;</span>, &amp;</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                 fail_if_missing=.true.)</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&#39;MIN_THICKNESS&#39;</span>, cs%min_thickness, default=0.001, &amp;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                   do_not_log=.true.)</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;PRANDTL_TIDAL&quot;</span>, prandtl_tidal, &amp;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                   <span class="stringliteral">&quot;Prandtl number used by CVMix tidal mixing schemes &quot;</span>//&amp;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                   <span class="stringliteral">&quot;to convert vertical diffusivities into viscosities.&quot;</span>, &amp;</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;                    units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0, &amp;</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                   do_not_log=.true.)</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <span class="keyword">call </span>cvmix_put(cs%CVMix_glb_params,<span class="stringliteral">&#39;Prandtl&#39;</span>,prandtl_tidal)</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160; </div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    tidal_energy_file = trim(cs%inputdir) // trim(tidal_energy_file)</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TIDAL_ENERGY_TYPE&quot;</span>,tidal_energy_type, &amp;</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                 <span class="stringliteral">&quot;The type of input tidal energy flux dataset. Valid values are&quot;</span>//&amp;</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                   <span class="stringliteral">&quot;\t Jayne\n&quot;</span>//&amp;</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                   <span class="stringliteral">&quot;\t ER03 \n&quot;</span>,&amp;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                 fail_if_missing=.true.)</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    <span class="comment">! Check whether tidal energy input format and CVMix tidal mixing scheme are consistent</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    <span class="keywordflow">if</span> ( .not. ( &amp;</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;          (uppercase(tidal_energy_type(1:4)).eq.<span class="stringliteral">&#39;JAYN&#39;</span> .and. cs%CVMix_tidal_scheme.eq.simmons).or. &amp;</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;          (uppercase(tidal_energy_type(1:4)).eq.<span class="stringliteral">&#39;ER03&#39;</span> .and. cs%CVMix_tidal_scheme.eq.schmittner) ) )<span class="keywordflow">then</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;tidal_mixing_init: Tidal energy file type (&quot;</span>//&amp;</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                      trim(tidal_energy_type)//<span class="stringliteral">&quot;) is incompatible with CVMix tidal &quot;</span>//&amp;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;                      <span class="stringliteral">&quot; mixing scheme: &quot;</span>//trim(cvmix_tidal_scheme_str) )</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    cvmix_tidal_scheme_str = lowercase(cvmix_tidal_scheme_str)</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160; </div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="comment">! Set up CVMix</span></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="keyword">call </span>cvmix_init_tidal(cvmix_tidal_params_user = cs%CVMix_tidal_params,    &amp;</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;                          mix_scheme              = cvmix_tidal_scheme_str,   &amp;</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                          efficiency              = cs%Mu_itides,             &amp;</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                          vertical_decay_scale    = cs%int_tide_decay_scale*us%Z_to_m,  &amp;</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                          max_coefficient         = cs%tidal_max_coef,        &amp;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                          local_mixing_frac       = cs%Gamma_itides,          &amp;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                          depth_cutoff            = cs%min_zbot_itides*us%Z_to_m)</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160; </div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    <span class="keyword">call </span>read_tidal_energy(g, us, tidal_energy_type, tidal_energy_file, cs)</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160; </div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    <span class="comment">!call closeParameterBlock(param_file)</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160; </div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! CVMix on</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160; </div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;  <span class="comment">! Register Diagnostics fields</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160; </div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;  <span class="keywordflow">if</span> (cs%Int_tide_dissipation .or. cs%Lee_wave_dissipation .or. &amp;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;      cs%Lowmode_itidal_dissipation) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160; </div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    cs%id_Kd_itidal = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_itides&#39;</span>,diag%axesTi,time, &amp;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;         <span class="stringliteral">&#39;Internal Tide Driven Diffusivity&#39;</span>, <span class="stringliteral">&#39;m2 s-1&#39;</span>, conversion=us%Z_to_m**2)</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160; </div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    <span class="keywordflow">if</span> (cs%use_CVMix_tidal) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;      cs%id_N2_int = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;N2_int&#39;</span>,diag%axesTi,time, &amp;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;          <span class="stringliteral">&#39;Bouyancy frequency squared, at interfaces&#39;</span>, <span class="stringliteral">&#39;s-2&#39;</span>)<span class="comment"></span></div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="comment">      !&gt; TODO: add units</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;      cs%id_Simmons_coeff = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Simmons_coeff&#39;</span>,diag%axesT1,time, &amp;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;           <span class="stringliteral">&#39;time-invariant portion of the tidal mixing coefficient using the Simmons&#39;</span>, <span class="stringliteral">&#39;&#39;</span>)</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;      cs%id_Schmittner_coeff = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Schmittner_coeff&#39;</span>,diag%axesTL,time, &amp;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;           <span class="stringliteral">&#39;time-invariant portion of the tidal mixing coefficient using the Schmittner&#39;</span>, <span class="stringliteral">&#39;&#39;</span>)</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;      cs%id_tidal_qe_md = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;tidal_qe_md&#39;</span>,diag%axesTL,time, &amp;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;           <span class="stringliteral">&#39;input tidal energy dissipated locally interpolated to model vertical coordinates&#39;</span>, <span class="stringliteral">&#39;&#39;</span>)</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;      cs%id_vert_dep = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;vert_dep&#39;</span>,diag%axesTi,time, &amp;</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;           <span class="stringliteral">&#39;vertical deposition function needed for Simmons et al tidal  mixing&#39;</span>, <span class="stringliteral">&#39;&#39;</span>)</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160; </div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;      cs%id_TKE_itidal = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;TKE_itidal&#39;</span>,diag%axesT1,time, &amp;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;          <span class="stringliteral">&#39;Internal Tide Driven Turbulent Kinetic Energy&#39;</span>, <span class="stringliteral">&#39;W m-2&#39;</span>, conversion=(us%Z_to_m**3*us%s_to_T**3))</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;      cs%id_Nb = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Nb&#39;</span>,diag%axesT1,time, &amp;</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;           <span class="stringliteral">&#39;Bottom Buoyancy Frequency&#39;</span>, <span class="stringliteral">&#39;s-1&#39;</span>)</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160; </div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;      cs%id_Kd_lowmode = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_lowmode&#39;</span>,diag%axesTi,time, &amp;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;           <span class="stringliteral">&#39;Internal Tide Driven Diffusivity (from propagating low modes)&#39;</span>, &amp;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;           <span class="stringliteral">&#39;m2 s-1&#39;</span>, conversion=us%Z_to_m**2)</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160; </div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;      cs%id_Fl_itidal = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Fl_itides&#39;</span>,diag%axesTi,time, &amp;</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;          <span class="stringliteral">&#39;Vertical flux of tidal turbulent dissipation&#39;</span>, &amp;</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;          <span class="stringliteral">&#39;m3 s-3&#39;</span>, conversion=(us%Z_to_m**3*us%s_to_T**3))</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160; </div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;      cs%id_Fl_lowmode = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Fl_lowmode&#39;</span>,diag%axesTi,time, &amp;</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;           <span class="stringliteral">&#39;Vertical flux of tidal turbulent dissipation (from propagating low modes)&#39;</span>, &amp;</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;           <span class="stringliteral">&#39;m3 s-3&#39;</span>, conversion=(us%Z_to_m**3*us%s_to_T**3))</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160; </div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;      cs%id_Polzin_decay_scale = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Polzin_decay_scale&#39;</span>,diag%axesT1,time, &amp;</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;           <span class="stringliteral">&#39;Vertical decay scale for the tidal turbulent dissipation with Polzin scheme&#39;</span>, &amp;</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;           <span class="stringliteral">&#39;m&#39;</span>, conversion=us%Z_to_m)</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160; </div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;      cs%id_Polzin_decay_scale_scaled = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, &amp;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;           <span class="stringliteral">&#39;Polzin_decay_scale_scaled&#39;</span>, diag%axesT1, time, &amp;</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;           <span class="stringliteral">&#39;Vertical decay scale for the tidal turbulent dissipation with Polzin scheme, &#39;</span>// &amp;</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;           <span class="stringliteral">&#39;scaled by N2_bot/N2_meanz&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>, conversion=us%Z_to_m)</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160; </div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;      cs%id_N2_bot = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;N2_b&#39;</span>,diag%axesT1,time, &amp;</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;           <span class="stringliteral">&#39;Bottom Buoyancy frequency squared&#39;</span>, <span class="stringliteral">&#39;s-2&#39;</span>)</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160; </div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;      cs%id_N2_meanz = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;N2_meanz&#39;</span>,diag%axesT1,time, &amp;</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;           <span class="stringliteral">&#39;Buoyancy frequency squared averaged over the water column&#39;</span>, <span class="stringliteral">&#39;s-2&#39;</span>)</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160; </div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;      cs%id_Kd_Itidal_Work = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_Itidal_Work&#39;</span>,diag%axesTL,time, &amp;</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;           <span class="stringliteral">&#39;Work done by Internal Tide Diapycnal Mixing&#39;</span>, <span class="stringliteral">&#39;W m-2&#39;</span>, conversion=(us%Z_to_m**3*us%s_to_T**3))</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160; </div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;      cs%id_Kd_Niku_Work = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_Nikurashin_Work&#39;</span>,diag%axesTL,time, &amp;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;           <span class="stringliteral">&#39;Work done by Nikurashin Lee Wave Drag Scheme&#39;</span>, <span class="stringliteral">&#39;W m-2&#39;</span>, conversion=(us%Z_to_m**3*us%s_to_T**3))</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160; </div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;      cs%id_Kd_Lowmode_Work = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_Lowmode_Work&#39;</span>,diag%axesTL,time, &amp;</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;           <span class="stringliteral">&#39;Work done by Internal Tide Diapycnal Mixing (low modes)&#39;</span>, &amp;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;           <span class="stringliteral">&#39;W m-2&#39;</span>, conversion=(us%Z_to_m**3*us%s_to_T**3))</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160; </div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;      <span class="keywordflow">if</span> (cs%Lee_wave_dissipation) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        cs%id_TKE_leewave = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;TKE_leewave&#39;</span>,diag%axesT1,time, &amp;</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;            <span class="stringliteral">&#39;Lee wave Driven Turbulent Kinetic Energy&#39;</span>, <span class="stringliteral">&#39;W m-2&#39;</span>, conversion=(us%Z_to_m**3*us%s_to_T**3))</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        cs%id_Kd_Niku = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_Nikurashin&#39;</span>,diag%axesTi,time, &amp;</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;             <span class="stringliteral">&#39;Lee Wave Driven Diffusivity&#39;</span>, <span class="stringliteral">&#39;m2 s-1&#39;</span>, conversion=us%Z_to_m**2)</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">! S%use_CVMix_tidal</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00044">mom_error_handler::is_root_pe()</a>, <a class="el" href="MOM__string__functions_8F90_source.html#l00024">mom_string_functions::lowercase()</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00192">mdl</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00196">polzin_09</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00194">polzin_profile_string</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l01473">read_tidal_energy()</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00200">schmittner</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00198">schmittner_scheme_string</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00199">simmons</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00197">simmons_scheme_string</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00195">stlaurent_02</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00193">stlaurent_profile_string</a>, and <a class="el" href="MOM__string__functions_8F90_source.html#l00042">mom_string_functions::uppercase()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__tidal__mixing_a6278fe41ef74ac23ba02ae1540104c5f_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a925ef652b1932e881b0f10e3d2fe17fa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a925ef652b1932e881b0f10e3d2fe17fa">&#9670;&nbsp;</a></span>mdl</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=40) mom_tidal_mixing::mdl = &quot;MOM_tidal_mixing&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This module's name. </p>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00192">192</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="comment">character(len=40)         :: mdl = &quot;MOM_tidal_mixing&quot;     !&lt; This module&#39;s name.</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00207">tidal_mixing_init()</a>.</p>

</div>
</div>
<a id="afed6c5ada4d2eeb610c5c87029d36ac3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afed6c5ada4d2eeb610c5c87029d36ac3">&#9670;&nbsp;</a></span>polzin_09</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_tidal_mixing::polzin_09 = 2</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This module's name. </p>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00196">196</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="keywordtype">integer</span>,        <span class="keywordtype">parameter</span> :: POLZIN_09    = 2</div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00917">add_int_tide_diffusivity()</a>, and <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00207">tidal_mixing_init()</a>.</p>

</div>
</div>
<a id="ab6b1348f160c8cab37a087b10cf11e7f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab6b1348f160c8cab37a087b10cf11e7f">&#9670;&nbsp;</a></span>polzin_profile_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(20), parameter mom_tidal_mixing::polzin_profile_string = &quot;POLZIN_09&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This module's name. </p>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00194">194</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">character*(20), parameter :: POLZIN_PROFILE_STRING      = &quot;POLZIN_09&quot;</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00207">tidal_mixing_init()</a>.</p>

</div>
</div>
<a id="a96e82abebc8049e136886af73ae99906"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a96e82abebc8049e136886af73ae99906">&#9670;&nbsp;</a></span>schmittner</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_tidal_mixing::schmittner = 2</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This module's name. </p>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00200">200</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="keywordtype">integer</span>,        <span class="keywordtype">parameter</span> :: SCHMITTNER   = 2</div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00681">calculate_cvmix_tidal()</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l01322">setup_tidal_diagnostics()</a>, and <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00207">tidal_mixing_init()</a>.</p>

</div>
</div>
<a id="aa77238da241cd9c94f24a9bd8d3b2fe1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa77238da241cd9c94f24a9bd8d3b2fe1">&#9670;&nbsp;</a></span>schmittner_scheme_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(20), parameter mom_tidal_mixing::schmittner_scheme_string = &quot;SCHMITTNER&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This module's name. </p>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00198">198</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="comment">character*(20), parameter :: SCHMITTNER_SCHEME_STRING   = &quot;SCHMITTNER&quot;</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00207">tidal_mixing_init()</a>.</p>

</div>
</div>
<a id="a4e093041fb72f388f962e7a1091c55bf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4e093041fb72f388f962e7a1091c55bf">&#9670;&nbsp;</a></span>simmons</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_tidal_mixing::simmons = 1</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This module's name. </p>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00199">199</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="keywordtype">integer</span>,        <span class="keywordtype">parameter</span> :: SIMMONS   = 1</div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00681">calculate_cvmix_tidal()</a>, <a class="el" href="MOM__tidal__mixing_8F90_source.html#l01322">setup_tidal_diagnostics()</a>, and <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00207">tidal_mixing_init()</a>.</p>

</div>
</div>
<a id="a264f090d7416d0fa6542e7ba51299cbd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a264f090d7416d0fa6542e7ba51299cbd">&#9670;&nbsp;</a></span>simmons_scheme_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(20), parameter mom_tidal_mixing::simmons_scheme_string = &quot;SIMMONS&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This module's name. </p>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00197">197</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="comment">character*(20), parameter :: SIMMONS_SCHEME_STRING      = &quot;SIMMONS&quot;</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00207">tidal_mixing_init()</a>.</p>

</div>
</div>
<a id="a507b1bb394ac4788c09657334b682297"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a507b1bb394ac4788c09657334b682297">&#9670;&nbsp;</a></span>stlaurent_02</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_tidal_mixing::stlaurent_02 = 1</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This module's name. </p>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00195">195</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="keywordtype">integer</span>,        <span class="keywordtype">parameter</span> :: STLAURENT_02 = 1</div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00917">add_int_tide_diffusivity()</a>, and <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00207">tidal_mixing_init()</a>.</p>

</div>
</div>
<a id="a7d67c30f468c9f4c8d97bfe2e3341bff"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7d67c30f468c9f4c8d97bfe2e3341bff">&#9670;&nbsp;</a></span>stlaurent_profile_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(20), parameter mom_tidal_mixing::stlaurent_profile_string = &quot;STLAURENT_02&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This module's name. </p>

<p class="definition">Definition at line <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00193">193</a> of file <a class="el" href="MOM__tidal__mixing_8F90_source.html">MOM_tidal_mixing.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment">character*(20), parameter :: STLAURENT_PROFILE_STRING   = &quot;STLAURENT_02&quot;</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__tidal__mixing_8F90_source.html#l00207">tidal_mixing_init()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__tidal__mixing.html">mom_tidal_mixing</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
