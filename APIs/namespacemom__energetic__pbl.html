<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_energetic_pbl Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('namespacemom__energetic__pbl.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a>  </div>
  <div class="headertitle">
<div class="title">mom_energetic_pbl Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Energetically consistent planetary boundary layer parameterization. </p>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__energetic__pbl_1_1energetic__pbl__cs.html">energetic_pbl_cs</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">This control structure holds parameters for the <a class="el" href="namespaceMOM__energetic__PBL.html">MOM_energetic_PBL</a> module.  <a href="structmom__energetic__pbl_1_1energetic__pbl__cs.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr><td colspan="2"><div class="groupHeader"></div></td></tr>
<tr class="memitem:a397c319268a901e2e4bf3c5a3e7730f4"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a397c319268a901e2e4bf3c5a3e7730f4">energetic_pbl</a> (h_3d, u_3d, v_3d, tv, fluxes, dt, Kd_int, G, GV, US, CS, dSV_dT, dSV_dS, TKE_forced, Buoy_Flux, dt_diag, last_call, dT_expected, dS_expected, waves)</td></tr>
<tr class="memdesc:a397c319268a901e2e4bf3c5a3e7730f4"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine determines the diffusivities from the integrated energetics mixed layer model. It assumes that heating, cooling and freshwater fluxes have already been applied. All calculations are done implicitly, and there is no stability limit on the time step.  <a href="namespacemom__energetic__pbl.html#a397c319268a901e2e4bf3c5a3e7730f4">More...</a><br /></td></tr>
<tr class="separator:a397c319268a901e2e4bf3c5a3e7730f4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab0d988822a378f674d3b7e0ee2534c74"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#ab0d988822a378f674d3b7e0ee2534c74">find_pe_chg</a> (Kddt_h0, dKddt_h, hp_a, hp_b, Th_a, Sh_a, Th_b, Sh_b, dT_to_dPE_a, dS_to_dPE_a, dT_to_dPE_b, dS_to_dPE_b, pres_Z, dT_to_dColHt_a, dS_to_dColHt_a, dT_to_dColHt_b, dS_to_dColHt_b, PE_chg, dPEc_dKd, dPE_max, dPEc_dKd_0, ColHt_cor)</td></tr>
<tr class="memdesc:ab0d988822a378f674d3b7e0ee2534c74"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine calculates the change in potential energy and or derivatives for several changes in an interfaces's diapycnal diffusivity times a timestep.  <a href="namespacemom__energetic__pbl.html#ab0d988822a378f674d3b7e0ee2534c74">More...</a><br /></td></tr>
<tr class="separator:ab0d988822a378f674d3b7e0ee2534c74"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3eb660658d0677c55c6187dcf4a180b5"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a3eb660658d0677c55c6187dcf4a180b5">find_pe_chg_orig</a> (Kddt_h, h_k, b_den_1, dTe_term, dSe_term, dT_km1_t2, dS_km1_t2, dT_to_dPE_k, dS_to_dPE_k, dT_to_dPEa, dS_to_dPEa, pres_Z, dT_to_dColHt_k, dS_to_dColHt_k, dT_to_dColHta, dS_to_dColHta, PE_chg, dPEc_dKd, dPE_max, dPEc_dKd_0)</td></tr>
<tr class="memdesc:a3eb660658d0677c55c6187dcf4a180b5"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine calculates the change in potential energy and or derivatives for several changes in an interfaces's diapycnal diffusivity times a timestep using the original form used in the first version of ePBL.  <a href="namespacemom__energetic__pbl.html#a3eb660658d0677c55c6187dcf4a180b5">More...</a><br /></td></tr>
<tr class="separator:a3eb660658d0677c55c6187dcf4a180b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af3a7ca5357ed9a1383c9556b117116dc"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#af3a7ca5357ed9a1383c9556b117116dc">energetic_pbl_get_mld</a> (CS, MLD, G, US, m_to_MLD_units)</td></tr>
<tr class="memdesc:af3a7ca5357ed9a1383c9556b117116dc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Copies the ePBL active mixed layer depth into MLD.  <a href="namespacemom__energetic__pbl.html#af3a7ca5357ed9a1383c9556b117116dc">More...</a><br /></td></tr>
<tr class="separator:af3a7ca5357ed9a1383c9556b117116dc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aec70079fb3f2e322625532017cdd0cc6"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#aec70079fb3f2e322625532017cdd0cc6">ust_2_u10_coare3p5</a> (USTair, U10, GV, US)</td></tr>
<tr class="memdesc:aec70079fb3f2e322625532017cdd0cc6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Computes wind speed from ustar_air based on COARE 3.5 Cd relationship.  <a href="namespacemom__energetic__pbl.html#aec70079fb3f2e322625532017cdd0cc6">More...</a><br /></td></tr>
<tr class="separator:aec70079fb3f2e322625532017cdd0cc6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a66dc4ecc7712c6f0307ca211c97fa5ef"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a66dc4ecc7712c6f0307ca211c97fa5ef">get_la_windsea</a> (ustar, hbl, GV, US, LA)</td></tr>
<tr class="memdesc:a66dc4ecc7712c6f0307ca211c97fa5ef"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine returns the Langmuir number, given ustar and the boundary layer thickness, inclusion conversion to the 10m wind.  <a href="namespacemom__energetic__pbl.html#a66dc4ecc7712c6f0307ca211c97fa5ef">More...</a><br /></td></tr>
<tr class="separator:a66dc4ecc7712c6f0307ca211c97fa5ef"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad9fa0dc4ba4e126ec686b44a5829c2e8"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#ad9fa0dc4ba4e126ec686b44a5829c2e8">energetic_pbl_init</a> (Time, G, GV, US, param_file, diag, CS)</td></tr>
<tr class="memdesc:ad9fa0dc4ba4e126ec686b44a5829c2e8"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine initializes the energetic_PBL module.  <a href="namespacemom__energetic__pbl.html#ad9fa0dc4ba4e126ec686b44a5829c2e8">More...</a><br /></td></tr>
<tr class="separator:ad9fa0dc4ba4e126ec686b44a5829c2e8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a64860c8b0110ba516795a288acdefd1f"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a64860c8b0110ba516795a288acdefd1f">energetic_pbl_end</a> (CS)</td></tr>
<tr class="memdesc:a64860c8b0110ba516795a288acdefd1f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Clean up and deallocate memory associated with the energetic_PBL module.  <a href="namespacemom__energetic__pbl.html#a64860c8b0110ba516795a288acdefd1f">More...</a><br /></td></tr>
<tr class="separator:a64860c8b0110ba516795a288acdefd1f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a397c319268a901e2e4bf3c5a3e7730f4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a397c319268a901e2e4bf3c5a3e7730f4">&#9670;&nbsp;</a></span>energetic_pbl()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_energetic_pbl::energetic_pbl </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>h_3d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>u_3d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>v_3d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke+1), intent(out)&#160;</td>
          <td class="paramname"><em>Kd_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__energetic__pbl_1_1energetic__pbl__cs.html">energetic_pbl_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>dSV_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>dSV_dS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>TKE_forced</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(in)&#160;</td>
          <td class="paramname"><em>Buoy_Flux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>dt_diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>last_call</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(out), optional&#160;</td>
          <td class="paramname"><em>dT_expected</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(out), optional&#160;</td>
          <td class="paramname"><em>dS_expected</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(wave_parameters_cs), optional, pointer&#160;</td>
          <td class="paramname"><em>waves</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine determines the diffusivities from the integrated energetics mixed layer model. It assumes that heating, cooling and freshwater fluxes have already been applied. All calculations are done implicitly, and there is no stability limit on the time step. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h_3d</td><td>Layer thicknesses [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u_3d</td><td>Zonal velocities interpolated to h points </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v_3d</td><td>Zonal velocities interpolated to h points </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dsv_dt</td><td>The partial derivative of in-situ specific </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dsv_ds</td><td>The partial derivative of in-situ specific </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tke_forced</td><td>The forcing requirements to homogenize the </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">tv</td><td>A structure containing pointers to any available thermodynamic fields. Absent fields have NULL ptrs. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>A structure containing pointers to any possible forcing fields. Unused fields have NULL ptrs. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment [s]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">kd_int</td><td>The diagnosed diffusivities at interfaces </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to mixedlayer_init. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">buoy_flux</td><td>The surface buoyancy flux [Z2 s-3 ~&gt; m2 s-3]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_diag</td><td>The diagnostic time step, which may be less than dt if there are two callse to mixedlayer [s]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">last_call</td><td>If true, this is the last call to mixedlayer in the current time step, so diagnostics will be written. The default is .true. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dt_expected</td><td>The values of temperature change that </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">ds_expected</td><td>The values of salinity change that </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">waves</td><td>Wave CS </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00216">216</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(inout)</span> :: G<span class="comment">      !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">     !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>    :: US<span class="comment">     !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                           <span class="keywordtype">intent(inout)</span> :: h_3d<span class="comment">   !&lt; Layer thicknesses [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: u_3d<span class="comment">   !&lt; Zonal velocities interpolated to h points</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="comment">                                                   !! [m s-1].</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: v_3d<span class="comment">   !&lt; Zonal velocities interpolated to h points</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="comment">                                                   !! [m s-1].</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: dSV_dT<span class="comment"> !&lt; The partial derivative of in-situ specific</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="comment">                                                   !! volume with potential temperature</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="comment">                                                   !! [m3 kg-1 degC-1].</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: dSV_dS<span class="comment"> !&lt; The partial derivative of in-situ specific</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">                                                   !! volume with salinity [m3 kg-1 ppt-1].</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: TKE_forced<span class="comment"> !&lt; The forcing requirements to homogenize the</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="comment">                                                   !! forcing that has been applied to each layer</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="comment">                                                   !! through each layer [J m-2].</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),   <span class="keywordtype">intent(inout)</span> :: tv<span class="comment">     !&lt; A structure containing pointers to any</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="comment">                                                   !! available thermodynamic fields. Absent fields</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="comment">                                                   !! have NULL ptrs.</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  <span class="keywordtype">type</span>(forcing),           <span class="keywordtype">intent(inout)</span> :: fluxes<span class="comment"> !&lt; A structure containing pointers to any</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="comment">                                                   !! possible forcing fields. Unused fields have</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="comment">                                                   !! NULL ptrs.</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">     !&lt; Time increment [s].</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                           <span class="keywordtype">intent(out)</span>   :: Kd_int<span class="comment"> !&lt; The diagnosed diffusivities at interfaces</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="comment">                                                   !! [Z2 s-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;  <span class="keywordtype">type</span>(energetic_PBL_CS),  <span class="keywordtype">pointer</span>       :: CS<span class="comment">     !&lt; The control structure returned by a previous</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="comment">                                                   !! call to mixedlayer_init.</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>, &amp;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: Buoy_Flux<span class="comment"> !&lt; The surface buoyancy flux [Z2 s-3 ~&gt; m2 s-3].</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="keywordtype">  real</span>,          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: dt_diag<span class="comment">   !&lt; The diagnostic time step, which may be less</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment">                                                   !! than dt if there are two callse to</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="comment">                                                   !! mixedlayer [s].</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;  <span class="keywordtype">logical</span>,       <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: last_call<span class="comment"> !&lt; If true, this is the last call to</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">                                                   !! mixedlayer in the current time step, so</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="comment">                                                   !! diagnostics will be written. The default</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="comment">                                                   !! is .true.</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span>   :: dT_expected<span class="comment"> !&lt; The values of temperature change that</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment">                                                   !! should be expected when the returned</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="comment">                                                   !! diffusivities are applied [degC].</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span>   :: dS_expected<span class="comment"> !&lt; The values of salinity change that</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment">                                                   !! should be expected when the returned</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="comment">                                                   !! diffusivities are applied [ppt].</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;  <span class="keywordtype">type</span>(wave_parameters_CS), &amp;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">pointer</span>       :: Waves<span class="comment">  !&lt; Wave CS</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160; </div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">!    This subroutine determines the diffusivities from the integrated energetics</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment">!  mixed layer model.  It assumes that heating, cooling and freshwater fluxes</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="comment">!  have already been applied.  All calculations are done implicitly, and there</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="comment">!  is no stability limit on the time step.</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="comment">!    For each interior interface, first discard the TKE to account for mixing</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment">! of shortwave radiation through the next denser cell.  Next drive mixing based</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="comment">! on the local? values of ustar + wstar, subject to available energy.  This</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment">! step sets the value of Kd(K).  Any remaining energy is then subject to decay</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="comment">! before being handed off to the next interface.  mech_TKE and conv_PErel are treated</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="comment">! separately for the purposes of decay, but are used proportionately to drive</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="comment">! mixing.</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment">!   The key parameters for the mixed layer are found in the control structure.</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">! These include mstar, nstar, TKE_decay, and conv_decay.  For the Oberhuber (1993) mixed layer,</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">! the values of these are:</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">!      mstar = 1.25,  nstar = 1, TKE_decay = 2.5, conv_decay = 0.5</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">!  TKE_decay is 1/kappa in eq. 28 of Oberhuber (1993), while</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">!  conv_decay is 1/mu.</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="comment">!    For a traditional Kraus-Turner mixed layer, the values are:</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="comment">!      mstar = 1.25, nstar = 0.4, TKE_decay = 0.0, conv_decay = 0.0</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160; </div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span> :: &amp;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    h, &amp;            <span class="comment">!   The layer thickness [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    T, &amp;            <span class="comment">!   The layer temperatures [degC].</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    S, &amp;            <span class="comment">!   The layer salinities [ppt].</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    u, &amp;            <span class="comment">!   The zonal velocity [m s-1].</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    v               <span class="comment">!   The meridional velocity [m s-1].</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV)+1)</span> :: &amp;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    Kd, &amp;           <span class="comment">! The diapycnal diffusivity [Z2 s-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    pres, &amp;         <span class="comment">! Interface pressures [Pa].</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    pres_Z, &amp;       <span class="comment">! Interface pressures with a rescaling factor to convert interface height</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                    <span class="comment">! movements into changes in column potential energy [J m-2 Z-1 ~&gt; J m-3].</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    hb_hs           <span class="comment">! The distance from the bottom over the thickness of the</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                    <span class="comment">! water column [nondim].</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    mech_TKE, &amp;     <span class="comment">!   The mechanically generated turbulent kinetic energy</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                    <span class="comment">! available for mixing over a time step [J m-2 = kg s-2].</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    conv_perel, &amp;   <span class="comment">! The potential energy that has been convectively released</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                    <span class="comment">! during this timestep [J m-2 = kg s-2]. A portion nstar_FC</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                    <span class="comment">! of conv_PErel is available to drive mixing.</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    htot, &amp;         <span class="comment">!   The total depth of the layers above an interface [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    uhtot, &amp;        <span class="comment">!   The depth integrated zonal and meridional velocities in the</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    vhtot, &amp;        <span class="comment">! layers above [H m s-1 ~&gt; m2 s-1 or kg m-1 s-1].</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    mech_tke_top, &amp; <span class="comment">!    The value of mech_TKE at the top of the column [J m-2].</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    conv_perel_top, &amp; <span class="comment">!  The value of conv_PErel at the top of the column [J m-2].</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160; </div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    idecay_len_tke, &amp;  <span class="comment">! The inverse of a turbulence decay length scale [H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    h_sum, &amp;        <span class="comment">! The total thickness of the water column [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    absf            <span class="comment">! The absolute value of f [s-1].</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160; </div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160; </div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span> :: &amp;</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    dT_to_dColHt, &amp; <span class="comment">! Partial derivatives of the total column height with the temperature</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    dS_to_dColHt, &amp; <span class="comment">! and salinity changes within a layer [Z degC-1 ~&gt; m degC-1] and [Z ppt-1 ~&gt; m ppt-1].</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    dT_to_dPE, &amp;    <span class="comment">! Partial derivatives of column potential energy with the temperature</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    dS_to_dPE, &amp;    <span class="comment">! and salinity changes within a layer, in [J m-2 degC-1] and [J m-2 ppt-1].</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    dT_to_dColHt_a, &amp; <span class="comment">! Partial derivatives of the total column height with the temperature</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    dS_to_dColHt_a, &amp; <span class="comment">! and salinity changes within a layer, including the implicit effects</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                    <span class="comment">! of mixing with layers higher in the water colun [Z degC-1 ~&gt; m degC-1] and [Z ppt-1 ~&gt; m ppt-1].</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    dt_to_dpe_a, &amp;  <span class="comment">! Partial derivatives of column potential energy with the temperature</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    ds_to_dpe_a     <span class="comment">! and salinity changes within a layer, including the implicit effects</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                    <span class="comment">! of mixing with layers higher in the water column, in</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                    <span class="comment">! units of [J m-2 degC-1] and [J m-2 ppt-1].</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: &amp;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    T0, S0, &amp;       <span class="comment">! Initial values of T and S in the column, in [degC] and [ppt].</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    Te, Se, &amp;       <span class="comment">! Estimated final values of T and S in the column, in [degC] and [ppt].</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    c1, &amp;           <span class="comment">! c1 is used by the tridiagonal solver [nondim].</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    dTe, dSe        <span class="comment">! Running (1-way) estimates of temperature and salinity change.</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: &amp;</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    Th_a, &amp;         <span class="comment">! An effective temperature times a thickness in the layer above, including implicit</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                    <span class="comment">! mixing effects with other yet higher layers [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    sh_a, &amp;         <span class="comment">! An effective salinity times a thickness in the layer above, including implicit</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;                    <span class="comment">! mixing effects with other yet higher layers [ppt H ~&gt; ppt m or ppt kg m-2].</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    th_b, &amp;         <span class="comment">! An effective temperature times a thickness in the layer below, including implicit</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                    <span class="comment">! mixing effects with other yet lower layers [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    sh_b            <span class="comment">! An effective salinity times a thickness in the layer below, including implicit</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                    <span class="comment">! mixing effects with other yet lower layers [ppt H ~&gt; ppt m or ppt kg m-2].</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    hp_a            <span class="comment">! An effective pivot thickness of the layer including the effects</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                    <span class="comment">! of coupling with layers above [H ~&gt; m or kg m-2].  This is the first term</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                    <span class="comment">! in the denominator of b1 in a downward-oriented tridiagonal solver.</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: &amp;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    MixLen_shape, &amp; <span class="comment">! A nondimensional shape factor for the mixing length that</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                    <span class="comment">! gives it an appropriate assymptotic value at the bottom of</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                    <span class="comment">! the boundary layer.</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    kddt_h          <span class="comment">! The diapycnal diffusivity times a timestep divided by the</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                    <span class="comment">! average thicknesses around a layer [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="keywordtype">  real</span> :: b1        <span class="comment">! b1 is inverse of the pivot used by the tridiagonal solver [H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="keywordtype">  real</span> :: h_neglect <span class="comment">! A thickness that is so small it is usually lost</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                    <span class="comment">! in roundoff and can be neglected [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="keywordtype">  real</span> :: dMass     <span class="comment">! The mass per unit area within a layer [kg m-2].</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="keywordtype">  real</span> :: dPres     <span class="comment">! The hydrostatic pressure change across a layer [Pa].</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="keywordtype">  real</span> :: dMKE_max  <span class="comment">! The maximum amount of mean kinetic energy that could be</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                    <span class="comment">! converted to turbulent kinetic energy if the velocity in</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                    <span class="comment">! the layer below an interface were homogenized with all of</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                    <span class="comment">! the water above the interface [J m-2 = kg s-2].</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="keywordtype">  real</span> :: MKE2_Hharm <span class="comment">! Twice the inverse of the harmonic mean of the thickness</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                    <span class="comment">! of a layer and the thickness of the water above, used in</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                    <span class="comment">! the MKE conversion equation [H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160; </div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="keywordtype">  real</span> :: dt_h      <span class="comment">! The timestep divided by the averages of the thicknesses around</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                    <span class="comment">! a layer, times a thickness conversion factor [H s m-2 ~&gt; s m-1 or kg s m-4].</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="keywordtype">  real</span> :: h_bot     <span class="comment">! The distance from the bottom [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="keywordtype">  real</span> :: h_rsum    <span class="comment">! The running sum of h from the top [Z ~&gt; m].</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="keywordtype">  real</span> :: I_hs      <span class="comment">! The inverse of h_sum [H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="keywordtype">  real</span> :: I_MLD     <span class="comment">! The inverse of the current value of MLD [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="keywordtype">  real</span> :: h_tt      <span class="comment">! The distance from the surface or up to the next interface</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                    <span class="comment">! that did not exhibit turbulent mixing from this scheme plus</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                    <span class="comment">! a surface mixing roughness length given by h_tt_min [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="keywordtype">  real</span> :: h_tt_min  <span class="comment">! A surface roughness length [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160; </div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="keywordtype">  real</span> :: C1_3      <span class="comment">! = 1/3.</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="keywordtype">  real</span> :: vonKar    <span class="comment">! The vonKarman constant.</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="keywordtype">  real</span> :: I_dtrho   <span class="comment">! 1.0 / (dt * Rho0) in [m3 kg-1 s-1].  This is</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                    <span class="comment">! used convert TKE back into ustar^3.</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="keywordtype">  real</span> :: U_star    <span class="comment">! The surface friction velocity [Z s-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="keywordtype">  real</span> :: U_Star_Mean <span class="comment">! The surface friction without gustiness [Z s-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="keywordtype">  real</span> :: vstar     <span class="comment">! An in-situ turbulent velocity [m s-1].</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="keywordtype">  real</span> :: Enhance_M <span class="comment">! An enhancement factor for vstar, based here on Langmuir impact.</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="keywordtype">  real</span> :: LA        <span class="comment">! The Langmuir number [nondim]</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="keywordtype">  real</span> :: LAmod     <span class="comment">! A modified Langmuir number accounting for other parameters.</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="keywordtype">  real</span> :: hbs_here  <span class="comment">! The local minimum of hb_hs and MixLen_shape, times a</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                    <span class="comment">! conversion factor from H to Z [Z H-1 ~&gt; 1 or m3 kg-1].</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="keywordtype">  real</span> :: nstar_FC  <span class="comment">! The fraction of conv_PErel that can be converted to mixing [nondim].</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="keywordtype">  real</span> :: TKE_reduc <span class="comment">! The fraction by which TKE and other energy fields are</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                    <span class="comment">! reduced to support mixing [nondim]. between 0 and 1.</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="keywordtype">  real</span> :: tot_TKE   <span class="comment">! The total TKE available to support mixing at interface K [J m-2].</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="keywordtype">  real</span> :: TKE_here  <span class="comment">! The total TKE at this point in the algorithm [J m-2].</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="keywordtype">  real</span> :: dT_km1_t2 <span class="comment">! A diffusivity-independent term related to the temperature</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                    <span class="comment">! change in the layer above the interface [degC].</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="keywordtype">  real</span> :: dS_km1_t2 <span class="comment">! A diffusivity-independent term related to the salinity</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                    <span class="comment">! change in the layer above the interface [ppt].</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="keywordtype">  real</span> :: dTe_term  <span class="comment">! A diffusivity-independent term related to the temperature</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;                    <span class="comment">! change in the layer below the interface [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="keywordtype">  real</span> :: dSe_term  <span class="comment">! A diffusivity-independent term related to the salinity</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                    <span class="comment">! change in the layer above the interface [ppt H ~&gt; ppt m or ppt kg m-2].</span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="keywordtype">  real</span> :: dTe_t2    <span class="comment">! A part of dTe_term [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="keywordtype">  real</span> :: dSe_t2    <span class="comment">! A part of dSe_term [ppt H ~&gt; ppt m or ppt kg m-2].</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="keywordtype">  real</span> :: dPE_conv  <span class="comment">! The convective change in column potential energy [J m-2].</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="keywordtype">  real</span> :: MKE_src   <span class="comment">! The mean kinetic energy source of TKE due to Kddt_h(K) [J m-2].</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="keywordtype">  real</span> :: dMKE_src_dK  <span class="comment">! The partial derivative of MKE_src with Kddt_h(K) [J m-2 H-1 ~&gt; J m-3 or J kg-1].</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;<span class="keywordtype">  real</span> :: Kd_guess0    <span class="comment">! A first guess of the diapycnal diffusivity [Z2 s-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="keywordtype">  real</span> :: PE_chg_g0    <span class="comment">! The potential energy change when Kd is Kd_guess0 [J m-2]</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="keywordtype">  real</span> :: dPEa_dKd_g0</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="keywordtype">  real</span> :: Kddt_h_g0    <span class="comment">! The first guess diapycnal diffusivity times a timestep divided</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                       <span class="comment">! by the average thicknesses around a layer [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="keywordtype">  real</span> :: PE_chg_max   <span class="comment">! The maximum PE change for very large values of Kddt_h(K).</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="keywordtype">  real</span> :: dPEc_dKd_Kd0 <span class="comment">! The partial derivative of PE change with Kddt_h(K)</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                       <span class="comment">! for very small values of Kddt_h(K) [J m-2 H-1 ~&gt; J m-3 or J kg-1].</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;<span class="keywordtype">  real</span> :: PE_chg    <span class="comment">! The change in potential energy due to mixing at an</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                    <span class="comment">! interface [J m-2], positive for the column increasing</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                    <span class="comment">! in potential energy (i.e., consuming TKE).</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="keywordtype">  real</span> :: TKE_left  <span class="comment">! The amount of turbulent kinetic energy left for the most</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                    <span class="comment">! recent guess at Kddt_h(K) [J m-2].</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="keywordtype">  real</span> :: dPEc_dKd  <span class="comment">! The partial derivative of PE_chg with Kddt_h(K) [J m-2 H-1 ~&gt; J m-3 or J kg-1].</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="keywordtype">  real</span> :: TKE_left_min, TKE_left_max <span class="comment">! Maximum and minimum values of TKE_left [J m-2].</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;<span class="keywordtype">  real</span> :: Kddt_h_max, Kddt_h_min <span class="comment">! Maximum and minimum values of Kddt_h(K) [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="keywordtype">  real</span> :: Kddt_h_guess <span class="comment">! A guess at the value of Kddt_h(K) [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="keywordtype">  real</span> :: Kddt_h_next  <span class="comment">! The next guess at the value of Kddt_h(K) [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="keywordtype">  real</span> :: dKddt_h      <span class="comment">! The change between guesses at Kddt_h(K) [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="keywordtype">  real</span> :: dKddt_h_Newt <span class="comment">! The change between guesses at Kddt_h(K) with Newton&#39;s method [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;<span class="keywordtype">  real</span> :: Kddt_h_newt  <span class="comment">! The Newton&#39;s method next guess for Kddt_h(K) [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="keywordtype">  real</span> :: exp_kh    <span class="comment">! The nondimensional decay of TKE across a layer [nondim].</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;  <span class="keywordtype">logical</span> :: use_Newt  <span class="comment">! Use Newton&#39;s method for the next guess at Kddt_h(K).</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;  <span class="keywordtype">logical</span> :: convectively_stable</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    sfc_connected   <span class="comment">! If true the ocean is actively turbulent from the present</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;                    <span class="comment">! interface all the way up to the surface.</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;  <span class="keywordtype">logical</span> :: sfc_disconnect <span class="comment">! If true, any turbulence has become disconnected</span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;                    <span class="comment">! from the surface.</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160; </div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;<span class="comment">! The following is only used as a diagnostic.</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;<span class="keywordtype">  real</span> :: dt__diag  <span class="comment">! A copy of dt_diag (if present) or dt [s].</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;<span class="keywordtype">  real</span> :: IdtdR0    <span class="comment">!  = 1.0 / (dt__diag * Rho0) [m3 kg-1 s-1].</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: &amp;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    Hsfc_used       <span class="comment">! The thickness of the surface region [Z ~&gt; m].</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;  <span class="keywordtype">logical</span> :: write_diags  <span class="comment">! If true, write out diagnostics with this step.</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;  <span class="keywordtype">logical</span> :: reset_diags  <span class="comment">! If true, zero out the accumulated diagnostics.</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <span class="comment">! Local column copies of energy change diagnostics, all [J m-2].</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;<span class="keywordtype">  real</span> :: dTKE_conv, dTKE_forcing, dTKE_mixing</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;<span class="keywordtype">  real</span> :: dTKE_MKE, dTKE_mech_decay, dTKE_conv_decay</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;  <span class="comment">!----------------------------------------------------------------------</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;  <span class="comment">!/BGR added Aug24,2016 for adding iteration to get boundary layer depth</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  <span class="comment">!    - needed to compute new mixing length.</span></div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="keywordtype">  real</span> :: MLD_guess, MLD_found <span class="comment">! Mixing Layer depth guessed/found for iteration [Z ~&gt; m].</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="keywordtype">  real</span> :: max_MLD, min_MLD <span class="comment">! Iteration bounds [Z ~&gt; m], which are adjusted at each step</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                           <span class="comment">!  - These are initialized based on surface/bottom</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                           <span class="comment">!  1. The iteration guesses a value (possibly from</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                           <span class="comment">!     prev step or neighbor).</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                           <span class="comment">!  2. The iteration checks if value is converged,</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                           <span class="comment">!     too shallow, or too deep.</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                           <span class="comment">!  3. Based on result adjusts the Max/Min</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                           <span class="comment">!     and searches through the water column.</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                           <span class="comment">!  - If using an accurate guess the iteration</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                           <span class="comment">!    is very quick (e.g. if MLD doesn&#39;t change</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                           <span class="comment">!    over timestep).  Otherwise it takes 5-10</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                           <span class="comment">!    passes, but has a high convergence rate.</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;                           <span class="comment">!    Other iteration may be tried, but this</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                           <span class="comment">!    method seems to rarely fail and the added</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                           <span class="comment">!    cost is likely not significant.  Additionally,</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                           <span class="comment">!    when it fails it does so in a reasonable</span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                           <span class="comment">!    manner giving a usable guess. When it</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                           <span class="comment">!    does fail, it is due to convection within</span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                           <span class="comment">!    the boundary.  Likely, a new method e.g.</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                           <span class="comment">!    surface_disconnect, can improve this.</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;  <span class="keywordtype">logical</span> :: FIRST_OBL     <span class="comment">! Flag for computing &quot;found&quot; Mixing layer depth</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;  <span class="keywordtype">logical</span> :: OBL_CONVERGED <span class="comment">! Flag for convergence of MLD</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;  <span class="keywordtype">integer</span> :: OBL_IT        <span class="comment">! Iteration counter</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;<span class="comment">!### These need to be made into run-time parameters.</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;  <span class="keywordtype">integer</span> :: MAX_OBL_IT=20 <span class="comment">! Set maximum number of iterations.  Probably</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                           <span class="comment">!  best as an input parameter, but then may want</span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                           <span class="comment">!  to use allocatable arrays if storing</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                           <span class="comment">!  guess/found (as diagnostic); skipping for now.</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                           <span class="comment">!  In reality, the maximum number of guesses</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                           <span class="comment">!  needed is set by:</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                           <span class="comment">!    DEPTH/2^M &lt; DZ</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                           <span class="comment">!    where M is the number of guesses</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                           <span class="comment">!    e.g. M=12 for DEPTH=4000m and DZ=1m</span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: Vstar_Used, &amp;      <span class="comment">! 1D arrays used to store</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                               Mixing_Length_Used   <span class="comment">! Vstar and Mixing_Length</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;  <span class="comment">!/BGR - remaining variables are related to tracking iteration statistics.</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;  <span class="keywordtype">logical</span> :: OBL_IT_STATS=.false. <span class="comment">! Flag for computing OBL iteration statistics</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="keywordtype">  REAL</span> :: ITguess(20), ITresult(20),ITmax(20),ITmin(20) <span class="comment">! Flag for storing guess/result</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                                                        <span class="comment">! should have dim=MAX_OBL_IT</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">save</span> :: MAXIT=0   <span class="comment">! Stores maximum number of iterations</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">save</span> :: MINIT=1e8 <span class="comment">! Stores minimum number of iterations</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">save</span> :: SUMIT=0   <span class="comment">! Stores total iterations (summed over all)</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">save</span> :: NUMIT=0   <span class="comment">! Stores number of times iterated</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                             <span class="comment">!e.g. Average iterations = SUMIT/NUMIT</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">save</span> :: CONVERGED<span class="comment">!</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">save</span> :: NOTCONVERGED<span class="comment">!</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;  <span class="comment">!-End BGR iteration parameters-----------------------------------------</span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="keywordtype">  real</span> :: N2_dissipation</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="keywordtype">  real</span> :: Bf_STABLE   <span class="comment">! Buoyancy flux, capped at 0 (negative only)</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="keywordtype">  real</span> :: Bf_UNSTABLE <span class="comment">! Buoyancy flux, floored at 0 (positive only)</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;<span class="keywordtype">  real</span> :: Stab_Scale  <span class="comment">! Composite of stabilizing Ekman scale and Monin-Obukhov length scales [Z ~&gt; m].</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="keywordtype">  real</span> :: iL_Ekman    <span class="comment">! Inverse of Ekman length scale [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="keywordtype">  real</span> :: iL_Obukhov  <span class="comment">! Inverse of Obukhov length scale [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="keywordtype">  real</span> :: MLD_o_Ekman          <span class="comment">! &gt;</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="keywordtype">  real</span> :: MLD_o_Obukhov_stab   <span class="comment">! Ratios of length scales where MLD is boundary layer depth</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="keywordtype">  real</span> :: Ekman_o_Obukhov_stab <span class="comment">! &gt;</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="keywordtype">  real</span> :: MLD_o_Obukhov_un   <span class="comment">! Ratios of length scales where MLD is boundary layer depth</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="keywordtype">  real</span> :: Ekman_o_Obukhov_un <span class="comment">! &gt;</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160; </div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="keywordtype">  real</span> :: C_MO = 1. <span class="comment">! Constant in Stab_Scale for Monin-Obukhov</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;<span class="keywordtype">  real</span> :: C_EK = 2. <span class="comment">! Constant in Stab_Scale for Ekman length</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="keywordtype">  real</span> :: MLD_over_STAB <span class="comment">! Mixing layer depth divided by Stab_Scale</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="keywordtype">  real</span> :: MSTAR_MIX <span class="comment">! The value of mstar (Proportionality of TKE to drive mixing to ustar</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                    <span class="comment">! cubed) which is computed as a function of latitude, boundary layer depth,</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                    <span class="comment">! and the Monin-Obukhov depth.</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="keywordtype">  real</span> :: MSTAR_LT  <span class="comment">! The added mstar contribution due to Langmuir turbulence</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="keywordtype">  real</span> :: MSTAR_Conv_Adj <span class="comment">! Adjustment made to mstar due to convection reducing mechanical mixing.</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;<span class="keywordtype">  real</span> :: MSTAR_STAB, MSTAR_ROT <span class="comment">! Mstar in each limit, max is used.</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="keywordtype">  real</span> :: Surface_Scale <span class="comment">! Surface decay scale for vstar</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="keywordtype">  real</span> :: K_Enhancement <span class="comment">! A local enhancement of K, perhaps due to Langmuir turbulence</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;  <span class="comment">! For LT_ENH_K_R16</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="keywordtype">  real</span> :: Shape_Function                <span class="comment">! The shape function of the enhancement</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: Max_Shape_Function = 0.148148 <span class="comment">! The max value of the shape function of the enhancement</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: Max_K_Enhancement = 2.25      <span class="comment">! The max value of the enhancement</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;  <span class="comment">!-End for LT_ENH_K_R16</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;  <span class="keywordtype">logical</span> :: debug=.false.  <span class="comment">! Change this hard-coded value for debugging.</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160; </div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;  <span class="comment">!  The following arrays are used only for debugging purposes.</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;<span class="keywordtype">  real</span> :: dPE_debug, mixing_debug, taux2, tauy2</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(20)</span> :: TKE_left_itt, PE_chg_itt, Kddt_h_itt, dPEa_dKd_itt, MKE_src_itt</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span> :: &amp;</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    mech_TKE_k, conv_PErel_k</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: nstar_k</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: num_itts</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160; </div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, nz, itt, max_itt</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160; </div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = gv%ke</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160; </div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;energetic_PBL: &quot;</span>//&amp;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;         <span class="stringliteral">&quot;Module must be initialized before it is used.&quot;</span>)</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160; </div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(tv%eqn_of_state)) <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;      <span class="stringliteral">&quot;energetic_PBL: Temperature, salinity and an equation of state &quot;</span>//&amp;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;      <span class="stringliteral">&quot;must now be used.&quot;</span>)</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;  <span class="keywordflow">if</span> (.NOT. <span class="keyword">associated</span>(fluxes%ustar)) <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;      <span class="stringliteral">&quot;energetic_PBL: No surface TKE fluxes (ustar) defined in mixedlayer!&quot;</span>)</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_expected) .or. <span class="keyword">present</span>(ds_expected)) debug = .true.</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160; </div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;  h_neglect = gv%H_subroundoff</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160; </div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;  <span class="keywordflow">if</span> (.not.cs%Use_MLD_Iteration) max_obl_it=1</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;  c1_3 = 1.0 / 3.0</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;  dt__diag = dt ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_diag)) dt__diag = dt_diag</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;  idtdr0 = 1.0 / (dt__diag * gv%Rho0)</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;  write_diags = .true. ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(last_call)) write_diags = last_call</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;  max_itt = 20</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160; </div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;  h_tt_min = 0.0</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;  vonkar = 0.41</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;  mstar_mix=cs%MSTAR<span class="comment">!Initialize to mstar</span></div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;  i_dtrho = 0.0 ; <span class="keywordflow">if</span> (dt*gv%Rho0 &gt; 0.0) i_dtrho = 1.0 / (dt*gv%Rho0)</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160; </div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  <span class="comment">! Determine whether to zero out diagnostics before accumulation.</span></div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;  reset_diags = .true.</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_diag) .and. write_diags .and. (dt__diag &gt; dt)) &amp;</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    reset_diags = .false.  <span class="comment">! This is the second call to mixedlayer.</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160; </div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;  <span class="keywordflow">if</span> (reset_diags) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;<span class="comment">!!OMP parallel do default(none) shared(is,ie,js,je,CS)</span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        cs%diag_TKE_wind(i,j) = 0.0 ; cs%diag_TKE_MKE(i,j) = 0.0</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;        cs%diag_TKE_conv(i,j) = 0.0 ; cs%diag_TKE_forcing(i,j) = 0.0</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;        cs%diag_TKE_mixing(i,j) = 0.0 ; cs%diag_TKE_mech_decay(i,j) = 0.0</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;        cs%diag_TKE_conv_decay(i,j) = 0.0 <span class="comment">!; CS%diag_TKE_unbalanced_forcing(i,j) = 0.0</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="comment">!!OMP parallel do default(none) shared(CS)</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    <span class="keywordflow">if</span> (cs%Mixing_Diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;      cs%Mixing_Length(:,:,:) = 0.0</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;      cs%Velocity_Scale(:,:,:) = 0.0</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160; </div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160; </div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="comment">!!OMP parallel do default(none) shared(js,je,nz,is,ie,h_3d,u_3d,v_3d,tv,dt,      &amp;</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="comment">!!OMP                                  CS,G,GV,US,fluxes,IdtdR0,                 &amp;</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;<span class="comment">!!OMP                                  TKE_forced,debug,H_neglect,dSV_dT,        &amp;</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;<span class="comment">!!OMP                                  dSV_dS,I_dtrho,C1_3,h_tt_min,vonKar,      &amp;</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;<span class="comment">!!OMP                                  max_itt,Kd_int)                           &amp;</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;<span class="comment">!!OMP                           private(i,j,k,h,u,v,T,S,Kd,mech_TKE_k,conv_PErel_k, &amp;</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="comment">!!OMP                                   U_Star,absf,mech_TKE,conv_PErel,nstar_k, &amp;</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="comment">!!OMP                                   h_sum,I_hs,h_bot,hb_hs,T0,S0,num_itts,   &amp;</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;<span class="comment">!!OMP                                   pres,pres_Z,dMass,dPres,dT_to_dPE,dS_to_dPE, &amp;</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;<span class="comment">!!OMP                                   dT_to_dColHt,dS_to_dColHt,Kddt_h,hp_a,   &amp;</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;<span class="comment">!!OMP                                   Th_a,Sh_a,Th_b,Sh_b,dT_to_dPE_a,htot,    &amp;</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="comment">!!OMP                                   dT_to_dColHt_a,dS_to_dColHt_a,uhtot,vhtot, &amp;</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="comment">!!OMP                                   Idecay_len_TKE,exp_kh,nstar_FC,tot_TKE,  &amp;</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;<span class="comment">!!OMP                                   TKE_reduc,dTe_t2,dSe_t2,dTe,dSe,dt_h,    &amp;</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;<span class="comment">!!OMP                                   Convectively_stable,sfc_disconnect,b1,   &amp;</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;<span class="comment">!!OMP                                   c1,dT_km1_t2,dS_km1_t2,dTe_term,         &amp;</span></div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<span class="comment">!!OMP                                   dSe_term,MKE2_Hharm,vstar,h_tt,h_rsum,   &amp;</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="comment">!!OMP                                   Kd_guess0,Kddt_h_g0,dPEc_dKd_Kd0,        &amp;</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;<span class="comment">!!OMP                                   PE_chg_max,dPEa_dKd_g0,PE_chg_g0,        &amp;</span></div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="comment">!!OMP                                   MKE_src,dPE_conv,Kddt_h_max,Kddt_h_min,  &amp;</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;<span class="comment">!!OMP                                   dTKE_conv, dTKE_forcing, dTKE_mixing,    &amp;</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="comment">!!OMP                                   dTKE_MKE,dTKE_mech_decay,dTKE_conv_decay,&amp;</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;<span class="comment">!!OMP                                   TKE_left_max,TKE_left_min,Kddt_h_guess,  &amp;</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;<span class="comment">!!OMP                                   TKE_left_itt,dPEa_dKd_itt,PE_chg_itt,    &amp;</span></div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;<span class="comment">!!OMP                                   MKE_src_itt,Kddt_h_itt,dPEc_dKd,PE_chg,  &amp;</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;<span class="comment">!!OMP                                   dMKE_src_dK,TKE_left,use_Newt,           &amp;</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="comment">!!OMP                                   dKddt_h_Newt,Kddt_h_Newt,Kddt_h_next,    &amp;</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="comment">!!OMP                                   dKddt_h,Te,Se,Hsfc_used,dS_to_dPE_a,     &amp;</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;<span class="comment">!!OMP                                   dMKE_max,sfc_connected,TKE_here)</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;  <span class="keywordflow">do</span> j=js,je</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    <span class="comment">! Copy the thicknesses and other fields to 2-d arrays.</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;      h(i,k) = h_3d(i,j,k) + h_neglect ; u(i,k) = u_3d(i,j,k) ; v(i,k) = v_3d(i,j,k)</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;      t(i,k) = tv%T(i,j,k) ; s(i,k) = tv%S(i,j,k)</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;      kd(i,k) = 0.0</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;      cs%ML_depth(i,j) = h(i,1)*gv%H_to_Z</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;      <span class="comment">!CS%ML_depth2(i,j) = h(i,1)*GV%H_to_Z</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;      sfc_connected(i) = .true.</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160; </div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;      mech_tke_k(:,:) = 0.0 ; conv_perel_k(:,:) = 0.0</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160; </div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    <span class="comment">!   Determine the initial mech_TKE and conv_PErel, including the energy required</span></div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;    <span class="comment">! to mix surface heating through the topmost cell, the energy released by mixing</span></div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    <span class="comment">! surface cooling &amp; brine rejection down through the topmost cell, and</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    <span class="comment">! homogenizing the shortwave heating within that cell.  This sets the energy</span></div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <span class="comment">! and ustar and wstar available to drive mixing at the first interior</span></div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    <span class="comment">! interface.</span></div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (g%mask2dT(i,j) &gt; 0.5) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160; </div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;      u_star = fluxes%ustar(i,j)</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;      u_star_mean = fluxes%ustar_gustless(i,j)</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%ustar_shelf) .and. <span class="keyword">associated</span>(fluxes%frac_shelf_h)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;        <span class="keywordflow">if</span> (fluxes%frac_shelf_h(i,j) &gt; 0.0) &amp;</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;          u_star = (1.0 - fluxes%frac_shelf_h(i,j)) * u_star + &amp;</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                    fluxes%frac_shelf_h(i,j) * fluxes%ustar_shelf(i,j)</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;      <span class="keywordflow">if</span> (u_star &lt; cs%ustar_min) u_star = cs%ustar_min</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160; </div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;      <span class="comment">! Computing Bf w/ limiters.</span></div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;      bf_stable = max(0.0, buoy_flux(i,j)) <span class="comment">! Positive for stable</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;      bf_unstable = min(0.0, buoy_flux(i,j)) <span class="comment">! Negative for unstable</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;      <span class="keywordflow">if</span> (cs%omega_frac &gt;= 1.0) <span class="keywordflow">then</span> ; absf(i) = 2.0*cs%omega</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;        absf(i) = 0.25*us%s_to_T*((abs(g%CoriolisBu(i,j)) + abs(g%CoriolisBu(i-1,j-1))) + &amp;</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;                                  (abs(g%CoriolisBu(i,j-1)) + abs(g%CoriolisBu(i-1,j))))</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;        <span class="keywordflow">if</span> (cs%omega_frac &gt; 0.0) &amp;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;          absf(i) = sqrt(cs%omega_frac*4.0*cs%omega**2 + (1.0-cs%omega_frac)*absf(i)**2)</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;      <span class="comment">! Computing stability scale which correlates with TKE for mixing, where</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;      <span class="comment">! TKE for mixing = TKE production minus TKE dissipation</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;      stab_scale = u_star**2 / ( vonkar * ( c_mo * bf_stable / u_star -  c_ek * u_star * absf(i)))</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;      <span class="comment">! Inverse of Ekman and Obukhov</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;      il_ekman   = absf(i) / u_star</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;      il_obukhov = buoy_flux(i,j)*vonkar / (u_star**3)</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;      <span class="keywordflow">if</span> (cs%USE_LT) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;        ekman_o_obukhov_stab = abs(max(0., il_obukhov / (il_ekman + 1.e-10*us%Z_to_m)))</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        ekman_o_obukhov_un = abs(min(0., il_obukhov / (il_ekman + 1.e-10*us%Z_to_m)))</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        <span class="comment">!### Consider recoding this as...</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;        <span class="comment">! Max_ratio = 1.0e16</span></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;        <span class="comment">! Ekman_Obukhov = Max_ratio</span></div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;        <span class="comment">! if (abs(buoy_flux(i,j)*vonkar) &lt; Max_ratio*(absf(i) * U_star**2)) &amp;</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;        <span class="comment">!   Ekman_Obukhov = buoy_flux(i,j)*vonkar / (absf(i) * U_star**2)</span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;        <span class="comment">! if (buoy_flux(i,j) &gt; 0.0) then</span></div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;        <span class="comment">!   Ekman_o_Obukhov_stab = Ekman_Obukhov ; Ekman_o_Obukhov_un = 0.0</span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;        <span class="comment">! else</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        <span class="comment">!   Ekman_o_Obukhov_un = Ekman_Obukhov ; Ekman_o_Obukhov_stab = 0.0</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        <span class="comment">! endif</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160; </div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;      <span class="keywordflow">if</span> (cs%Mstar_Mode == cs%CONST_MSTAR) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;        mech_tke(i) = (dt*cs%mstar*gv%Rho0) * us%Z_to_m**3 * u_star**3</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;        conv_perel(i) = 0.0</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160; </div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;        <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;          cs%diag_TKE_wind(i,j) = cs%diag_TKE_wind(i,j) + mech_tke(i) * idtdr0</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;          <span class="keywordflow">if</span> (tke_forced(i,j,1) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;            cs%diag_TKE_forcing(i,j) = cs%diag_TKE_forcing(i,j) + &amp;</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;                 max(-mech_tke(i), tke_forced(i,j,1)) * idtdr0</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;            <span class="comment">! CS%diag_TKE_unbalanced_forcing(i,j) = CS%diag_TKE_unbalanced_forcing(i,j) + &amp;</span></div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;            <span class="comment">!     min(0.0, TKE_forced(i,j,1) + mech_TKE(i)) * IdtdR0</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;            cs%diag_TKE_forcing(i,j) = cs%diag_TKE_forcing(i,j) + cs%nstar*tke_forced(i,j,1) * idtdr0</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160; </div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;        <span class="keywordflow">if</span> (tke_forced(i,j,1) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;          mech_tke(i) = mech_tke(i) + tke_forced(i,j,1)</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;          <span class="keywordflow">if</span> (mech_tke(i) &lt; 0.0) mech_tke(i) = 0.0</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;          conv_perel(i) = conv_perel(i) + tke_forced(i,j,1)</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160; </div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160; </div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="comment">!    endif ; enddo</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160; </div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;<span class="comment">!    do i=is,ie ; if (G%mask2dT(i,j) &gt; 0.5) then</span></div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160; </div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;      h_sum(i) = h_neglect ; <span class="keywordflow">do</span> k=1,nz ; h_sum(i) = h_sum(i) + h(i,k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;      i_hs = 0.0 ; <span class="keywordflow">if</span> (h_sum(i) &gt; 0.0) i_hs = 1.0 / h_sum(i)</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160; </div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;      h_bot = 0.0 ; hb_hs(i,nz+1) = 0.0</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;      <span class="keywordflow">do</span> k=nz,1,-1</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;        h_bot = h_bot + h(i,k)</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;        hb_hs(i,k) = h_bot * i_hs</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160; </div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;      pres(i,1) = 0.0 ; pres_z(i,1) = 0.0</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;      <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        dmass = gv%H_to_kg_m2 * h(i,k)</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        dpres = (gv%g_Earth*us%m_to_Z) * dmass  <span class="comment">! This is equivalent to GV%H_to_Pa * h(i,k)</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        dt_to_dpe(i,k) = (dmass * (pres(i,k) + 0.5*dpres)) * dsv_dt(i,j,k)</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        ds_to_dpe(i,k) = (dmass * (pres(i,k) + 0.5*dpres)) * dsv_ds(i,j,k)</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        dt_to_dcolht(i,k) = dmass * us%m_to_Z * dsv_dt(i,j,k)</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        ds_to_dcolht(i,k) = dmass * us%m_to_Z * dsv_ds(i,j,k)</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160; </div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        pres(i,k+1) = pres(i,k) + dpres</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;        pres_z(i,k+1) = us%Z_to_m * pres(i,k+1)</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160; </div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;<span class="comment">!    endif ; enddo</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160; </div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    <span class="comment">! Note the outer i-loop and inner k-loop loop order!!!</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;<span class="comment">!    do i=is,ie ; if (G%mask2dT(i,j) &gt; 0.5) then</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; t0(k) = t(i,k) ; s0(k) = s(i,k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160; </div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;      <span class="comment">! Store the initial mechanical TKE and convectively released PE to</span></div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;      <span class="comment">! enable multiple iterations.</span></div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;      mech_tke_top(i) = mech_tke(i) ; conv_perel_top(i) = conv_perel(i)</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160; </div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;      <span class="comment">!/The following lines are for the iteration over MLD</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;      <span class="comment">!{</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;      <span class="comment">! max_MLD will initialized as ocean bottom depth</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;      max_mld = 0.0 ; <span class="keywordflow">do</span> k=1,nz ; max_mld = max_mld + h(i,k)*gv%H_to_Z ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;      min_mld = 0.0 <span class="comment">!min_MLD will initialize as 0.</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;      <span class="comment">!/BGR: May add user-input bounds for max/min MLD</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160; </div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;      <span class="comment">!/BGR: Add MLD_guess based on stored previous value.</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;      <span class="comment">!      note that this is different from ML_Depth already</span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;      <span class="comment">!      computed by EPBL, need to figure out why.</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;      <span class="keywordflow">if</span> (cs%MLD_iteration_guess .and. (cs%ML_Depth2(i,j) &gt; 1.0*us%m_to_Z)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        <span class="comment">!If prev value is present use for guess.</span></div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;        mld_guess = cs%ML_Depth2(i,j)</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        <span class="comment">!Otherwise guess middle of water column (or Stab_Scale if smaller).</span></div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;        mld_guess = 0.5 * (min_mld+max_mld)</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160; </div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;      <span class="comment">! Iterate up to MAX_OBL_IT times to determine a converged EPBL depth.</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;      obl_converged = .false.</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160; </div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;      <span class="comment">! Initialize ENHANCE_M to 1 and mstar_lt to 0</span></div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;      enhance_m=1.e0</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;      mstar_lt = 0.0</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;      <span class="keywordflow">do</span> obl_it=1,max_obl_it ; <span class="keywordflow">if</span> (.not. obl_converged) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160; </div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        <span class="comment">! Reset ML_depth</span></div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        cs%ML_depth(i,j) = h(i,1)*gv%H_to_Z</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;        <span class="comment">!CS%ML_depth2(i,j) = h(i,1)*GV%H_to_Z</span></div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160; </div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        sfc_connected(i) = .true.</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160; </div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;        <span class="keywordflow">if</span> (cs%Mstar_Mode &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        <span class="comment">! Note the value of mech_TKE(i) now must be iterated over, so it is moved here</span></div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;        <span class="comment">! First solve for the TKE to PE length scale</span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;          <span class="keywordflow">if</span> (cs%MSTAR_MODE == cs%MLD_o_OBUKHOV) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;            mld_over_stab = mld_guess / stab_scale - cs%MSTAR_XINT</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;            <span class="comment">!### MLD_over_Stab = (MLD_guess * (VonKar * (C_MO*BF_Stable -  C_EK*U_star**2*absf(i)))) / &amp;</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;            <span class="comment">!###               U_star**3 - CS%MSTAR_XINT</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;            <span class="keywordflow">if</span> ((mld_over_stab) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;              <span class="comment">!Asymptote to 0 as MLD_over_Stab -&gt; -infinity (always)</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;              mstar_mix = (cs%MSTAR_B*(mld_over_stab)+cs%MSTAR_A)**(cs%MSTAR_N)</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;              <span class="keywordflow">if</span> (cs%MSTAR_CAP&gt;=0.) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;                <span class="keywordflow">if</span> (cs%MSTAR_FLATCAP .OR. (mld_over_stab  &lt;= cs%MSTAR_XINT_UP)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;                <span class="comment">!If using flat cap (or if using asymptotic cap</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                <span class="comment">!   but within linear regime we can make use of same code)</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;                  mstar_mix = min(cs%MSTAR_CAP, &amp;</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;                     cs%MSTAR_SLOPE*(mld_over_stab)+cs%MSTAR_AT_XINT)</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;                  <span class="comment">!Asymptote to MSTAR_CAP as MLD_over_Stab -&gt; infinity</span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;                  mstar_mix = cs%MSTAR_CAP - &amp;</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;                       (cs%MSTAR_B2*(mld_over_stab-cs%MSTAR_XINT_UP)&amp;</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;                       +cs%MSTAR_A2)**(cs%MSTAR_N)</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;                <span class="comment">!No cap if negative cap value given.</span></div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;                mstar_mix = cs%MSTAR_SLOPE*(mld_over_stab)+cs%MSTAR_AT_XINT</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;          <span class="keywordflow">elseif</span> (cs%MSTAR_MODE == cs%EKMAN_o_OBUKHOV) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;            <span class="comment">!### Please refrain from using the construct A / B / C in place of A/(B*C).</span></div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;            <span class="comment">! The limit for the balance of rotation and stabilizing is f(L_Ekman,L_Obukhov)</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;            mstar_stab = cs%MSTAR_COEF*sqrt(bf_stable  / u_star**2 / (absf(i)+1.e-10))</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;            <span class="comment">!### Should be mstar_STAB = CS%MSTAR_COEF*sqrt(Bf_Stable / (U_star**2 * (absf(i)+1.e-10)))</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;            <span class="comment">! The limit for rotation (Ekman length) limited mixin</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;            mstar_rot =  cs%C_EK * log(max(1., u_star / (absf(i)+1.e-10) / mld_guess))</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;            <span class="comment">!### Consider rewriting the expression for mstar_ROT as:</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;            <span class="comment">! mstar_Rot = 0.0</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;            <span class="comment">! if (Ustar &gt; absf(i) * MLD_guess) &amp;</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;            <span class="comment">!   mstar_ROT = CS%C_EK * log(U_star / (absf(i) * MLD_guess))</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;            <span class="comment">! Here 1.25 is .5/von Karman, which gives the Obukhov limit.</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;            mstar_mix = max(mstar_stab, min(1.25, mstar_rot))</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;            <span class="keywordflow">if</span> (cs%MSTAR_CAP &gt; 0.0) mstar_mix = min(cs%MSTAR_CAP, mstar_mix)</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;          <span class="keywordflow">elseif</span> (cs%MSTAR_MODE.eq.cs%MSTAR_RH18) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;            mstar_rot = cs%RH18_MST_CN1 * ( 1.0 - ( 1.+cs%RH18_MST_CN2 * &amp;</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;                 exp( cs%RH18_MST_CN3 * mld_guess * absf(i) / u_star) )**-1.0 )</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;            mstar_stab = cs%RH18_MST_CS1 * (bf_stable**2*mld_guess &amp;</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;                 / ( u_star**5 * absf(i) ) ) **cs%RH18_MST_CS2</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;            mstar_mix = mstar_rot + mstar_stab</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;          endif<span class="comment">!mstar_mode==1 or ==2 or ==3</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;          <span class="comment">! Adjustment for unstable buoyancy flux.</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;          <span class="comment">!  Convection reduces mechanical mixing because there</span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;          <span class="comment">!  is less density gradient to mix. (Statically unstable near surface)</span></div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;          mstar_conv_adj = 1. - cs%CNV_MST_FAC * (-bf_unstable + 1.e-10*us%m_to_Z**2) / &amp;</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;                                 ( (-bf_unstable + 1.e-10*us%m_to_Z**2) +                 &amp;</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;                                   2.0 *mstar_mix * u_star**3 / mld_guess )</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;          <span class="comment">! MSTAR_Conv_Adj = 1. - CS%CNV_MST_FAC * ((-BF_Unstable + 1.e-10*US%m_to_Z**2)*MLD_guess) / &amp;</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;          <span class="comment">!                       ( (-Bf_Unstable + 1.e-10*US%m_to_Z**2)*MLD_guess + &amp;</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;          <span class="comment">!                         2.0*MSTAR_MIX * U_star**3 )</span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;          <span class="keywordflow">if</span> (cs%USE_LT) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;            <span class="keyword">call </span>get_langmuir_number( la, g, gv, us, abs(mld_guess), u_star_mean, i, j, &amp;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;                                      h=h(i,:), u_h=u(i,:), v_h=v(i,:), waves=waves)</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;            <span class="comment">! 2. Get parameters for modified LA</span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;            mld_o_ekman = abs(mld_guess * il_ekman)</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;            mld_o_obukhov_stab = abs(max(0., mld_guess*il_obukhov))</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;            mld_o_obukhov_un = abs(min(0., mld_guess*il_obukhov))</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;            <span class="comment">! 3. Adjust LA based on various parameters.</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;            <span class="comment">!    Assumes linear factors based on length scale ratios to adjust LA</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;            <span class="comment">!    Note when these coefficients are set to 0 recovers simple LA.</span></div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;            lamod = la * (1.0 + max(-0.5,cs%LaC_MLDoEK * mld_o_ekman) +   &amp;</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;                 cs%LaC_EKoOB_stab * ekman_o_obukhov_stab + &amp;</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;                 cs%LaC_EKoOB_un * ekman_o_obukhov_un + &amp;</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;                 cs%LaC_MLDoOB_stab * mld_o_obukhov_stab  + &amp;</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;                 cs%LaC_MLDoOB_un * mld_o_obukhov_un )</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;            <span class="keywordflow">if</span> (cs%LT_Enhance_Form==1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;              <span class="comment">!Original w&#39;/ust scaling w/ Van Roekel et al. 2012 scaling</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;              <span class="comment">!  NOTE we know now that this is not the right way to scale M.</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;              enhance_m = (1. + (1.4*la)**(-2) + (5.4*la)**(-4))**(1.5)</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;            <span class="keywordflow">elseif</span> (cs%LT_Enhance_Form==2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;              <span class="comment">! Enhancement is multiplied (added mst_lt set to 0)</span></div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;              enhance_m = min(cs%Max_Enhance_M, (1. + cs%LT_ENHANCE_COEF*lamod**cs%LT_ENHANCE_EXP))</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;              mstar_lt = 0.0</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;            <span class="keywordflow">elseif</span> (cs%LT_ENHANCE_Form == 3) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;              <span class="comment">! or Enhancement is additive (multiplied enhance_m set to 1)</span></div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;              mstar_lt = cs%LT_ENHANCE_COEF * lamod**cs%LT_ENHANCE_EXP</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;              enhance_m = 1.0</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;          <span class="comment">!Reset mech_tke and conv_perel values (based on new mstar)</span></div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;          mech_tke(i) = ( mstar_mix * mstar_conv_adj * enhance_m + mstar_lt) * &amp;</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;                        us%Z_to_m**3 * (dt*gv%Rho0*u_star**3)</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;          conv_perel(i) = 0.0</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;          <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;            cs%diag_TKE_wind(i,j) = cs%diag_TKE_wind(i,j) + mech_tke(i) * idtdr0</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;            <span class="keywordflow">if</span> (tke_forced(i,j,1) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;              cs%diag_TKE_forcing(i,j) = cs%diag_TKE_forcing(i,j) + &amp;</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;                   max(-mech_tke(i), tke_forced(i,j,1)) * idtdr0</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;              <span class="comment">! CS%diag_TKE_unbalanced_forcing(i,j) = CS%diag_TKE_unbalanced_forcing(i,j) + &amp;</span></div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;              <span class="comment">!     min(0.0, TKE_forced(i,j,1) + mech_TKE(i)) * IdtdR0</span></div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;              cs%diag_TKE_forcing(i,j) = cs%diag_TKE_forcing(i,j) + cs%nstar*tke_forced(i,j,1) * idtdr0</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160; </div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;          <span class="keywordflow">if</span> (tke_forced(i,j,1) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;            mech_tke(i) = mech_tke(i) + tke_forced(i,j,1)</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;            <span class="keywordflow">if</span> (mech_tke(i) &lt; 0.0) mech_tke(i) = 0.0</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;            conv_perel(i) = conv_perel(i) + tke_forced(i,j,1)</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;          mech_tke(i) = mech_tke_top(i)*enhance_m ; conv_perel(i) = conv_perel_top(i)</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160; </div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;        <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;          dtke_conv = 0.0 ; dtke_forcing = 0.0 ; dtke_mixing = 0.0</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;          dtke_mke = 0.0 ; dtke_mech_decay = 0.0 ; dtke_conv_decay = 0.0</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160; </div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;        <span class="comment">! Store in 1D arrays cleared out each iteration.  Only write in</span></div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        <span class="comment">!  3D arrays after convergence.</span></div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;          vstar_used(k) = 0.0 ; mixing_length_used(k) = 0.0</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;        <span class="keywordflow">if</span> (.not.cs%Use_MLD_Iteration) obl_converged = .true.</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160; </div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;        <span class="keywordflow">if</span> ((.not.cs%Use_MLD_Iteration) .or. &amp;</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;            (cs%transLay_scale &gt;= 1.0) .or. (cs%transLay_scale &lt; 0.0) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;          <span class="keywordflow">do</span> k=1,nz+1 ; mixlen_shape(k) = 1.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;        <span class="keywordflow">elseif</span> (mld_guess &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;          <span class="keywordflow">if</span> (cs%transLay_scale &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;            <span class="keywordflow">do</span> k=1,nz+1 ; mixlen_shape(k) = cs%transLay_scale ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;            <span class="keywordflow">do</span> k=1,nz+1 ; mixlen_shape(k) = 1.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;          <span class="comment">! Reduce the mixing length based on MLD, with a quadratic</span></div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;          <span class="comment">! expression that follows KPP.</span></div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;          i_mld = 1.0 / mld_guess ; h_rsum = 0.0</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;          mixlen_shape(1) = 1.0</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;          <span class="keywordflow">do</span> k=2,nz+1</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;            h_rsum = h_rsum + h(i,k-1)*gv%H_to_Z</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;            <span class="keywordflow">if</span> (cs%MixLenExponent==2.0)<span class="keywordflow">then</span></div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;              mixlen_shape(k) = cs%transLay_scale + (1.0 - cs%transLay_scale) * &amp;</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;                   (max(0.0, (mld_guess - h_rsum)*i_mld) )**2<span class="comment">!CS%MixLenExponent</span></div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;              mixlen_shape(k) = cs%transLay_scale + (1.0 - cs%transLay_scale) * &amp;</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;                   (max(0.0, (mld_guess - h_rsum)*i_mld) )**cs%MixLenExponent</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;<span class="keywordflow">          enddo</span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160; </div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160; </div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;        kd(i,1) = 0.0 ; kddt_h(1) = 0.0</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;        hp_a(i) = h(i,1)</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        dt_to_dpe_a(i,1) = dt_to_dpe(i,1) ; dt_to_dcolht_a(i,1) = dt_to_dcolht(i,1)</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;        ds_to_dpe_a(i,1) = ds_to_dpe(i,1) ; ds_to_dcolht_a(i,1) = ds_to_dcolht(i,1)</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160; </div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;        htot(i) = h(i,1) ; uhtot(i) = u(i,1)*h(i,1) ; vhtot(i) = v(i,1)*h(i,1)</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160; </div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;        <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;          mech_tke_k(i,1) = mech_tke(i) ; conv_perel_k(i,1) = conv_perel(i)</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;          nstar_k(:) = 0.0 ; nstar_k(1) = cs%nstar ; num_itts(:) = -1</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;        <span class="keywordflow">do</span> k=2,nz</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;          <span class="comment">! Apply dissipation to the TKE, here applied as an exponential decay</span></div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;          <span class="comment">! due to 3-d turbulent energy being lost to inefficient rotational modes.</span></div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160; </div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;          <span class="comment">!   There should be several different &quot;flavors&quot; of TKE that decay at</span></div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;          <span class="comment">! different rates.  The following form is often used for mechanical</span></div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;          <span class="comment">! stirring from the surface, perhaps due to breaking surface gravity</span></div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;          <span class="comment">! waves and wind-driven turbulence.</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;          idecay_len_tke(i) = (cs%TKE_decay * absf(i) / u_star) * gv%H_to_Z</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;          exp_kh = 1.0</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;          <span class="keywordflow">if</span> (idecay_len_tke(i) &gt; 0.0) exp_kh = exp(-h(i,k-1)*idecay_len_tke(i))</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;          <span class="keywordflow">if</span> (cs%TKE_diagnostics) &amp;</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;            dtke_mech_decay = dtke_mech_decay + (exp_kh-1.0) * mech_tke(i) * idtdr0</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;          mech_tke(i) = mech_tke(i) * exp_kh</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160; </div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;          <span class="comment">!   Accumulate any convectively released potential energy to contribute</span></div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;          <span class="comment">! to wstar and to drive penetrating convection.</span></div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;          <span class="keywordflow">if</span> (tke_forced(i,j,k) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;            conv_perel(i) = conv_perel(i) + tke_forced(i,j,k)</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;            <span class="keywordflow">if</span> (cs%TKE_diagnostics) &amp;</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;              dtke_forcing = dtke_forcing + cs%nstar*tke_forced(i,j,k) * idtdr0</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160; </div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;          <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;            mech_tke_k(i,k) = mech_tke(i) ; conv_perel_k(i,k) = conv_perel(i)</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160; </div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;          <span class="comment">!  Determine the total energy</span></div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;          nstar_fc = cs%nstar</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;          <span class="keywordflow">if</span> (cs%nstar * conv_perel(i) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;            <span class="comment">! Here nstar is a function of the natural Rossby number 0.2/(1+0.2/Ro), based</span></div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;            <span class="comment">! on a curve fit from the data of Wang (GRL, 2003).</span></div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;            <span class="comment">! Note:         Ro = 1.0 / sqrt(0.5 * dt * Rho0 * (absf*htot(i))**3 / conv_PErel(i))</span></div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;            nstar_fc = cs%nstar * conv_perel(i) / (conv_perel(i) + 0.2 * &amp;</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;                            sqrt(0.5 * dt * gv%Rho0 * (absf(i)*(htot(i)*gv%H_to_m))**3 * conv_perel(i)))</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160; </div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;          <span class="keywordflow">if</span> (debug) nstar_k(k) = nstar_fc</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160; </div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;          tot_tke = mech_tke(i) + nstar_fc * conv_perel(i)</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160; </div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;          <span class="comment">!   For each interior interface, first discard the TKE to account for</span></div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;          <span class="comment">! mixing of shortwave radiation through the next denser cell.</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;          <span class="keywordflow">if</span> (tke_forced(i,j,k) &lt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;            <span class="keywordflow">if</span> (tke_forced(i,j,k) + tot_tke &lt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;              <span class="comment">! The shortwave requirements deplete all the energy in this layer.</span></div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;              <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;                dtke_mixing = dtke_mixing + tot_tke * idtdr0</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;                dtke_forcing = dtke_forcing - tot_tke * idtdr0</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                <span class="comment">! dTKE_unbalanced_forcing = dTKE_unbalanced_forcing + &amp;</span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;                <span class="comment">!     (TKE_forced(i,j,k) + tot_TKE) * IdtdR0</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;                dtke_conv_decay = dtke_conv_decay + &amp;</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;                        (cs%nstar-nstar_fc) * conv_perel(i) * idtdr0</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;              tot_tke = 0.0 ; mech_tke(i) = 0.0 ; conv_perel(i) = 0.0</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;              <span class="comment">! Reduce the mechanical and convective TKE proportionately.</span></div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;              tke_reduc = (tot_tke + tke_forced(i,j,k)) / tot_tke</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;              <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;                dtke_mixing = dtke_mixing - tke_forced(i,j,k) * idtdr0</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;                dtke_forcing = dtke_forcing + tke_forced(i,j,k) * idtdr0</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;                dtke_conv_decay = dtke_conv_decay + &amp;</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                    (1.0-tke_reduc)*(cs%nstar-nstar_fc) * conv_perel(i) * idtdr0</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;              tot_tke = tke_reduc*tot_tke   <span class="comment">! = tot_TKE + TKE_forced(i,j,k)</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;              mech_tke(i) = tke_reduc*mech_tke(i)</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;              conv_perel(i) = tke_reduc*conv_perel(i)</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160; </div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;          <span class="comment">! Precalculate some temporary expressions that are independent of Kddt_h(K).</span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;          <span class="keywordflow">if</span> (cs%orig_PE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;            <span class="keywordflow">if</span> (k==2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;              dte_t2 = 0.0 ; dse_t2 = 0.0</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;              dte_t2 = kddt_h(k-1) * ((t0(k-2) - t0(k-1)) + dte(k-2))</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;              dse_t2 = kddt_h(k-1) * ((s0(k-2) - s0(k-1)) + dse(k-2))</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;          dt_h = (gv%Z_to_H**2*dt) / max(0.5*(h(i,k-1)+h(i,k)), 1e-15*h_sum(i))</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160; </div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;          <span class="comment">!   This tests whether the layers above and below this interface are in</span></div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;          <span class="comment">! a convetively stable configuration, without considering any effects of</span></div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;          <span class="comment">! mixing at higher interfaces.  It is an approximation to the more</span></div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;          <span class="comment">! complete test dPEc_dKd_Kd0 &gt;= 0.0, that would include the effects of</span></div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;          <span class="comment">! mixing across interface K-1.  The dT_to_dColHt here are effectively</span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;          <span class="comment">! mass-weigted estimates of dSV_dT.</span></div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;          convectively_stable = ( 0.0 &lt;= &amp;</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;            ( (dt_to_dcolht(i,k) + dt_to_dcolht(i,k-1) ) * (t0(k-1)-t0(k)) + &amp;</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;              (ds_to_dcolht(i,k) + ds_to_dcolht(i,k-1) ) * (s0(k-1)-s0(k)) ) )</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160; </div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;          <span class="keywordflow">if</span> ((mech_tke(i) + conv_perel(i)) &lt;= 0.0 .and. convectively_stable) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;            <span class="comment">! Energy is already exhausted, so set Kd = 0 and cycle or exit?</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;            tot_tke = 0.0 ; mech_tke(i) = 0.0 ; conv_perel(i) = 0.0</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;            kd(i,k) = 0.0 ; kddt_h(k) = 0.0</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;            sfc_disconnect = .true.</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;            <span class="comment">! if (.not.debug) exit</span></div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160; </div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;           <span class="comment">!   The estimated properties for layer k-1 can be calculated, using</span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;           <span class="comment">! greatly simplified expressions when Kddt_h = 0.  This enables the</span></div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;           <span class="comment">! tridiagonal solver for the whole column to be completed for debugging</span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;           <span class="comment">! purposes, and also allows for something akin to convective adjustment</span></div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;           <span class="comment">! in unstable interior regions?</span></div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;            b1 = 1.0 / hp_a(i)</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;            c1(k) = 0.0</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;            <span class="keywordflow">if</span> (cs%orig_PE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;              dte(k-1) = b1 * ( dte_t2 )</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;              dse(k-1) = b1 * ( dse_t2 )</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160; </div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;            hp_a(i) = h(i,k)</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;            dt_to_dpe_a(i,k) = dt_to_dpe(i,k)</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;            ds_to_dpe_a(i,k) = ds_to_dpe(i,k)</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;            dt_to_dcolht_a(i,k) = dt_to_dcolht(i,k)</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;            ds_to_dcolht_a(i,k) = ds_to_dcolht(i,k)</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160; </div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;          <span class="keywordflow">else</span> <span class="comment">! tot_TKE &gt; 0.0 or this is a potentially convectively unstable profile.</span></div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;            sfc_disconnect = .false.</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160; </div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;            <span class="comment">! Precalculate some more temporary expressions that are independent of</span></div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;            <span class="comment">! Kddt_h(K).</span></div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;            <span class="keywordflow">if</span> (cs%orig_PE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;              <span class="keywordflow">if</span> (k==2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;                dt_km1_t2 = (t0(k)-t0(k-1))</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;                ds_km1_t2 = (s0(k)-s0(k-1))</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;                dt_km1_t2 = (t0(k)-t0(k-1)) - &amp;</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;                      (kddt_h(k-1) / hp_a(i)) * ((t0(k-2) - t0(k-1)) + dte(k-2))</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;                ds_km1_t2 = (s0(k)-s0(k-1)) - &amp;</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;                      (kddt_h(k-1) / hp_a(i)) * ((s0(k-2) - s0(k-1)) + dse(k-2))</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;              dte_term = dte_t2 + hp_a(i) * (t0(k-1)-t0(k))</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;              dse_term = dse_t2 + hp_a(i) * (s0(k-1)-s0(k))</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;              <span class="keywordflow">if</span> (k&lt;=2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;                th_a(k-1) = h(i,k-1) * t0(k-1) ; sh_a(k-1) = h(i,k-1) * s0(k-1)</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;                th_a(k-1) = h(i,k-1) * t0(k-1) + kddt_h(k-1) * te(k-2)</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;                sh_a(k-1) = h(i,k-1) * s0(k-1) + kddt_h(k-1) * se(k-2)</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;              th_b(k) = h(i,k) * t0(k) ; sh_b(k) = h(i,k) * s0(k)</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160; </div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;            <span class="comment">!   Using Pr=1 and the diffusivity at the bottom interface (once it is</span></div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;            <span class="comment">! known), determine how much resolved mean kinetic energy (MKE) will be</span></div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;            <span class="comment">! extracted within a timestep and add a fraction CS%MKE_to_TKE_effic of</span></div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;            <span class="comment">! this to the mTKE budget available for mixing in the next layer.</span></div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160; </div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;            <span class="keywordflow">if</span> ((cs%MKE_to_TKE_effic &gt; 0.0) .and. (htot(i)*h(i,k) &gt; 0.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;              <span class="comment">! This is the energy that would be available from homogenizing the</span></div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;              <span class="comment">! velocities between layer k and the layers above.</span></div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;              dmke_max = (gv%H_to_kg_m2 * cs%MKE_to_TKE_effic) * 0.5 * &amp;</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;                  (h(i,k) / ((htot(i) + h(i,k))*htot(i))) * &amp;</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;                  ((uhtot(i)-u(i,k)*htot(i))**2 + (vhtot(i)-v(i,k)*htot(i))**2)</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;              <span class="comment">! A fraction (1-exp(Kddt_h*MKE2_Hharm)) of this energy would be</span></div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;              <span class="comment">! extracted by mixing with a finite viscosity.</span></div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;              mke2_hharm = (htot(i) + h(i,k) + 2.0*h_neglect) / &amp;</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;                           ((htot(i)+h_neglect) * (h(i,k)+h_neglect))</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;              dmke_max = 0.0 ; mke2_hharm = 0.0</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160; </div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;            <span class="comment">! At this point, Kddt_h(K) will be unknown because its value may depend</span></div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;            <span class="comment">! on how much energy is available.  mech_TKE might be negative due to</span></div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;            <span class="comment">! contributions from TKE_forced.</span></div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;            h_tt = htot(i) + h_tt_min</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;            tke_here = mech_tke(i) + cs%wstar_ustar_coef*conv_perel(i)</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;            <span class="keywordflow">if</span> (tke_here &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;              <span class="keywordflow">if</span> (cs%vstar_mode==0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;                vstar = cs%vstar_scale_fac * (i_dtrho*tke_here)**c1_3</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;              <span class="keywordflow">elseif</span> (cs%vstar_mode==1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;                surface_scale = max(0.05,1.-htot(i)/mld_guess)</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;                vstar = cs%vstar_scale_fac * (cs%vstar_surf_fac*u_star + &amp;</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;                     (cs%wstar_ustar_coef*conv_perel(i)*i_dtrho)**c1_3)* &amp;</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;                     surface_scale</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;              hbs_here = gv%H_to_Z * min(hb_hs(i,k), mixlen_shape(k))</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;              mixing_length_used(k) = max(cs%min_mix_len, ((h_tt*hbs_here)*vstar) / &amp;</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;                  ((cs%Ekman_scale_coef * absf(i)) * (h_tt*hbs_here) + vstar))</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;              <span class="comment">!Note setting Kd_guess0 to Mixing_Length_Used(K) here will</span></div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;              <span class="comment">! change the answers.  Therefore, skipping that.</span></div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;              <span class="keywordflow">if</span> (.not.cs%Use_MLD_Iteration) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;                 kd_guess0 = vstar * vonkar * ((h_tt*hbs_here)*vstar) / &amp;</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;                  ((cs%Ekman_scale_coef * absf(i)) * (h_tt*hbs_here) + vstar)</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;                 kd_guess0 = vstar * vonkar * mixing_length_used(k)</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;              <span class="comment">! Compute the local enhnacement of K (perhaps due to Langmuir)</span></div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;              <span class="keywordflow">if</span> (cs%LT_ENH_K_R16) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;                shape_function = htot(i)/mld_guess*(1.-htot(i)/mld_guess)**2</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;                k_enhancement = ( min( max_k_enhancement,1.+1./la ) - 1. )</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;                kd_guess0 = kd_guess0 * shape_function / max_shape_function</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;              vstar = 0.0 ; kd_guess0 = 0.0</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;            vstar_used(k) = vstar <span class="comment">! Track vstar</span></div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;            kddt_h_g0 = kd_guess0*dt_h</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160; </div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;            <span class="keywordflow">if</span> (cs%orig_PE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;              <span class="keyword">call </span>find_pe_chg_orig(kddt_h_g0, h(i,k), hp_a(i), dte_term, dse_term, &amp;</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;                       dt_km1_t2, ds_km1_t2, dt_to_dpe(i,k), ds_to_dpe(i,k), &amp;</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;                       dt_to_dpe_a(i,k-1), ds_to_dpe_a(i,k-1), &amp;</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;                       pres_z(i,k), dt_to_dcolht(i,k), ds_to_dcolht(i,k), &amp;</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;                       dt_to_dcolht_a(i,k-1), ds_to_dcolht_a(i,k-1), &amp;</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;                       pe_chg=pe_chg_g0, dpec_dkd=dpea_dkd_g0, dpe_max=pe_chg_max, &amp;</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;                       dpec_dkd_0=dpec_dkd_kd0 )</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;              <span class="keyword">call </span>find_pe_chg(0.0, kddt_h_g0, hp_a(i), h(i,k), &amp;</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;                         th_a(k-1), sh_a(k-1), th_b(k), sh_b(k), &amp;</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;                         dt_to_dpe_a(i,k-1), ds_to_dpe_a(i,k-1), dt_to_dpe(i,k), ds_to_dpe(i,k), &amp;</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;                         pres_z(i,k), dt_to_dcolht_a(i,k-1), ds_to_dcolht_a(i,k-1), &amp;</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;                         dt_to_dcolht(i,k), ds_to_dcolht(i,k), &amp;</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;                         pe_chg=pe_chg_g0, dpec_dkd=dpea_dkd_g0, dpe_max=pe_chg_max, &amp;</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;                         dpec_dkd_0=dpec_dkd_kd0 )</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160; </div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;            mke_src = dmke_max*(1.0 - exp(-kddt_h_g0 * mke2_hharm))</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160; </div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;            <span class="keywordflow">if</span> (pe_chg_g0 &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;              <span class="comment">!Negative buoyancy (increases PE)</span></div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;              n2_dissipation = 1.+cs%N2_DISSIPATION_SCALE_NEG</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;              <span class="comment">!Positive buoyancy (decreases PE)</span></div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;              n2_dissipation = 1.+cs%N2_DISSIPATION_SCALE_POS</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160; </div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;            <span class="keywordflow">if</span> ((pe_chg_g0 &lt; 0.0) .or. ((vstar == 0.0) .and. (dpec_dkd_kd0 &lt; 0.0))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;              <span class="comment">! This column is convectively unstable.</span></div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;              <span class="keywordflow">if</span> (pe_chg_max &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;                <span class="comment">! Does MKE_src need to be included in the calculation of vstar here?</span></div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;                tke_here = mech_tke(i) + cs%wstar_ustar_coef*(conv_perel(i)-pe_chg_max)</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;                <span class="keywordflow">if</span> (tke_here &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;                  <span class="keywordflow">if</span> (cs%vstar_mode==0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;                    vstar = cs%vstar_scale_fac * (i_dtrho*tke_here)**c1_3</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;                  <span class="keywordflow">elseif</span> (cs%vstar_mode==1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;                    surface_scale = max(0.05,1.-htot(i)/mld_guess)</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;                    vstar = cs%vstar_scale_fac * (cs%vstar_surf_fac*u_star + &amp;</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;                         (cs%wstar_ustar_coef*conv_perel(i)*i_dtrho)**c1_3)* &amp;</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;                         surface_scale</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;<span class="keywordflow">                  endif</span></div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;                  hbs_here = gv%H_to_Z * min(hb_hs(i,k), mixlen_shape(k))</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;                  mixing_length_used(k) = max(cs%min_mix_len,((h_tt*hbs_here)*vstar) / &amp;</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;                      ((cs%Ekman_scale_coef * absf(i)) * (h_tt*hbs_here) + vstar))</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;                  <span class="keywordflow">if</span> (.not.cs%Use_MLD_Iteration) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;                  <span class="comment">! Note again (as prev) that using Mixing_Length_Used here</span></div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;                  <span class="comment">!  instead of redoing the computation will change answers...</span></div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;                    kd(i,k) = vstar * vonkar *  ((h_tt*hbs_here)*vstar) / &amp;</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;                          ((cs%Ekman_scale_coef * absf(i)) * (h_tt*hbs_here) + vstar)</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;                  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;                    kd(i,k) = vstar * vonkar * mixing_length_used(k)</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;<span class="keywordflow">                  endif</span></div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;                  <span class="comment">! Compute the local enhnacement of K (perhaps due to Langmuir)</span></div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;                  <span class="keywordflow">if</span> (cs%LT_ENH_K_R16) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;                    shape_function = htot(i)/mld_guess*(1.-htot(i)/mld_guess)**2</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;                    k_enhancement = ( min( max_k_enhancement,1.+1./la ) - 1. )</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;                    kd(i,k) = kd(i,k) * shape_function / max_shape_function</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;<span class="keywordflow">                  endif</span></div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;                  vstar = 0.0 ; kd(i,k) = 0.0</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;                vstar_used(k) = vstar</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160; </div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;                <span class="keywordflow">if</span> (cs%orig_PE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;                  <span class="keyword">call </span>find_pe_chg_orig(kd(i,k)*dt_h, h(i,k), hp_a(i), dte_term, dse_term, &amp;</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;                           dt_km1_t2, ds_km1_t2, dt_to_dpe(i,k), ds_to_dpe(i,k), &amp;</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;                           dt_to_dpe_a(i,k-1), ds_to_dpe_a(i,k-1), &amp;</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;                           pres_z(i,k), dt_to_dcolht(i,k), ds_to_dcolht(i,k), &amp;</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;                           dt_to_dcolht_a(i,k-1), ds_to_dcolht_a(i,k-1), &amp;</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;                           pe_chg=dpe_conv)</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;                  <span class="keyword">call </span>find_pe_chg(0.0, kd(i,k)*dt_h, hp_a(i), h(i,k), &amp;</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;                           th_a(k-1), sh_a(k-1), th_b(k), sh_b(k), &amp;</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;                           dt_to_dpe_a(i,k-1), ds_to_dpe_a(i,k-1), dt_to_dpe(i,k), ds_to_dpe(i,k), &amp;</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;                           pres_z(i,k), dt_to_dcolht_a(i,k-1), ds_to_dcolht_a(i,k-1), &amp;</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;                           dt_to_dcolht(i,k), ds_to_dcolht(i,k), &amp;</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;                           pe_chg=dpe_conv)</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;                <span class="comment">! Should this be iterated to convergence for Kd?</span></div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;                <span class="keywordflow">if</span> (dpe_conv &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;                  kd(i,k) = kd_guess0 ; dpe_conv = pe_chg_g0</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;                  mke_src = dmke_max*(1.0 - exp(-(kd(i,k)*dt_h) * mke2_hharm))</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;                <span class="comment">! The energy change does not vary monotonically with Kddt_h.  Find the maximum?</span></div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;                kd(i,k) = kd_guess0 ; dpe_conv = pe_chg_g0</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;              conv_perel(i) = conv_perel(i) - dpe_conv</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;              mech_tke(i) = mech_tke(i) + mke_src</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;              <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;                dtke_conv = dtke_conv - cs%nstar*dpe_conv * idtdr0</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;                dtke_mke = dtke_mke + mke_src * idtdr0</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;              <span class="keywordflow">if</span> (sfc_connected(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;                cs%ML_depth(i,j) = cs%ML_depth(i,j) + gv%H_to_Z * h(i,k)</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;                <span class="comment">! CS%ML_depth2(i,j) = CS%ML_depth2(i,J) + GV%H_to_Z * h(i,k)</span></div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160; </div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;              kddt_h(k) = kd(i,k)*dt_h</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;            <span class="keywordflow">elseif</span> (tot_tke + (mke_src - n2_dissipation*pe_chg_g0) &gt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;              <span class="comment">! There is energy to support the suggested mixing.  Keep that estimate.</span></div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;              kd(i,k) = kd_guess0</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;              kddt_h(k) = kddt_h_g0</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160; </div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;              <span class="comment">! Reduce the mechanical and convective TKE proportionately.</span></div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;              tot_tke = tot_tke + mke_src</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;              tke_reduc = 0.0   <span class="comment">! tot_TKE could be 0 if Convectively_stable is false.</span></div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;              <span class="keywordflow">if</span> (tot_tke &gt; 0.0) tke_reduc = (tot_tke - n2_dissipation*pe_chg_g0) &amp;</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;                                             / tot_tke</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;              <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;                dtke_mixing = dtke_mixing - pe_chg_g0 * idtdr0</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;                dtke_mke = dtke_mke + mke_src * idtdr0</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;                dtke_conv_decay = dtke_conv_decay + &amp;</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;                    (1.0-tke_reduc)*(cs%nstar-nstar_fc) * conv_perel(i) * idtdr0</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;              tot_tke = tke_reduc*tot_tke</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;              mech_tke(i) = tke_reduc*(mech_tke(i) + mke_src)</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;              conv_perel(i) = tke_reduc*conv_perel(i)</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;              <span class="keywordflow">if</span> (sfc_connected(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;                cs%ML_depth(i,j) = cs%ML_depth(i,j) + gv%H_to_Z * h(i,k)</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;                <span class="comment">! CS%ML_depth2(i,J) = CS%ML_depth2(i,J) + GV%H_to_Z * h(i,k)</span></div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;            <span class="keywordflow">elseif</span> (tot_tke == 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;              <span class="comment">! This can arise if nstar_FC = 0.</span></div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;              kd(i,k) = 0.0 ; kddt_h(k) = 0.0</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;              tot_tke = 0.0 ; conv_perel(i) = 0.0 ; mech_tke(i) = 0.0</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;              sfc_disconnect = .true.</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;              <span class="comment">! There is not enough energy to support the mixing, so reduce the</span></div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;              <span class="comment">! diffusivity to what can be supported.</span></div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;              kddt_h_max = kddt_h_g0 ; kddt_h_min = 0.0</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;              tke_left_max = tot_tke + (mke_src - n2_dissipation*pe_chg_g0)</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;              tke_left_min = tot_tke</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160; </div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;              <span class="comment">! As a starting guess, take the minimum of a false position estimate</span></div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;              <span class="comment">! and a Newton&#39;s method estimate starting from Kddt_h = 0.0.</span></div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;              kddt_h_guess = tot_tke * kddt_h_max / max( n2_dissipation*pe_chg_g0 &amp;</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;                                 - mke_src, kddt_h_max * (dpec_dkd_kd0 - dmke_max *        &amp;</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;                                 mke2_hharm) )</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;              <span class="comment">! The above expression is mathematically the same as the following</span></div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;              <span class="comment">! except it is not susceptible to division by zero when</span></div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;              <span class="comment">!   dPEc_dKd_Kd0 = dMKE_max = 0 .</span></div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;              <span class="comment">!  Kddt_h_guess = tot_TKE * min( Kddt_h_max / (PE_chg_g0 - MKE_src), &amp;</span></div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;              <span class="comment">!                      1.0 / (dPEc_dKd_Kd0 - dMKE_max * MKE2_Hharm) )</span></div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;              <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;                tke_left_itt(:) = 0.0 ; dpea_dkd_itt(:) = 0.0 ; pe_chg_itt(:) = 0.0</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;                mke_src_itt(:) = 0.0 ; kddt_h_itt(:) = 0.0</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;              <span class="keywordflow">do</span> itt=1,max_itt</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;                <span class="keywordflow">if</span> (cs%orig_PE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;                  <span class="keyword">call </span>find_pe_chg_orig(kddt_h_guess, h(i,k), hp_a(i), dte_term, dse_term, &amp;</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;                           dt_km1_t2, ds_km1_t2, dt_to_dpe(i,k), ds_to_dpe(i,k), &amp;</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;                           dt_to_dpe_a(i,k-1), ds_to_dpe_a(i,k-1), &amp;</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;                           pres_z(i,k), dt_to_dcolht(i,k), ds_to_dcolht(i,k), &amp;</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;                           dt_to_dcolht_a(i,k-1), ds_to_dcolht_a(i,k-1), &amp;</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;                           pe_chg=pe_chg, dpec_dkd=dpec_dkd )</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;                  <span class="keyword">call </span>find_pe_chg(0.0, kddt_h_guess, hp_a(i), h(i,k), &amp;</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;                           th_a(k-1), sh_a(k-1), th_b(k), sh_b(k), &amp;</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;                           dt_to_dpe_a(i,k-1), ds_to_dpe_a(i,k-1), dt_to_dpe(i,k), ds_to_dpe(i,k), &amp;</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;                           pres_z(i,k), dt_to_dcolht_a(i,k-1), ds_to_dcolht_a(i,k-1), &amp;</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;                           dt_to_dcolht(i,k), ds_to_dcolht(i,k), &amp;</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;                           pe_chg=dpe_conv)</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;                mke_src = dmke_max * (1.0 - exp(-mke2_hharm * kddt_h_guess))</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;                dmke_src_dk = dmke_max * mke2_hharm * exp(-mke2_hharm * kddt_h_guess)</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160; </div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;                tke_left = tot_tke + (mke_src - n2_dissipation*pe_chg)</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;                <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;                  kddt_h_itt(itt) = kddt_h_guess ; mke_src_itt(itt) = mke_src</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;                  pe_chg_itt(itt) = n2_dissipation*pe_chg</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;                  tke_left_itt(itt) = tke_left</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;                  dpea_dkd_itt(itt) = dpec_dkd</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;                <span class="comment">! Store the new bounding values, bearing in mind that min and max</span></div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;                <span class="comment">! here refer to Kddt_h and dTKE_left/dKddt_h &lt; 0:</span></div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;                <span class="keywordflow">if</span> (tke_left &gt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;                  kddt_h_min = kddt_h_guess ; tke_left_min = tke_left</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;                  kddt_h_max = kddt_h_guess ; tke_left_max = tke_left</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160; </div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;                <span class="comment">! Try to use Newton&#39;s method, but if it would go outside the bracketed</span></div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;                <span class="comment">! values use the false-position method instead.</span></div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;                use_newt = .true.</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;                <span class="keywordflow">if</span> (dpec_dkd*n2_dissipation - dmke_src_dk &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;                  use_newt = .false.</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;                  dkddt_h_newt = tke_left / (dpec_dkd*n2_dissipation - dmke_src_dk)</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;                  kddt_h_newt = kddt_h_guess + dkddt_h_newt</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;                  <span class="keywordflow">if</span> ((kddt_h_newt &gt; kddt_h_max) .or. (kddt_h_newt &lt; kddt_h_min)) &amp;</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;                    use_newt = .false.</div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160; </div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;                <span class="keywordflow">if</span> (use_newt) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;                  kddt_h_next = kddt_h_guess + dkddt_h_newt</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;                  dkddt_h = dkddt_h_newt</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;                  kddt_h_next = (tke_left_max * kddt_h_min - kddt_h_max * tke_left_min) / &amp;</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;                                (tke_left_max - tke_left_min)</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;                  dkddt_h = kddt_h_next - kddt_h_guess</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160; </div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;                <span class="keywordflow">if</span> ((abs(dkddt_h) &lt; 1e-9*kddt_h_guess) .or. (itt==max_itt)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;                  <span class="comment">! Use the old value so that the energy calculation does not need to be repeated.</span></div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;                  <span class="keywordflow">if</span> (debug) num_itts(k) = itt</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;                  <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;                  kddt_h_guess = kddt_h_next</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;<span class="keywordflow">              enddo</span></div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;              kd(i,k) = kddt_h_guess / dt_h ; kddt_h(k) = kd(i,k)*dt_h</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160; </div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;              <span class="comment">! All TKE should have been consumed.</span></div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;              <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;                dtke_mixing = dtke_mixing - (tot_tke + mke_src) * idtdr0</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;                dtke_mke = dtke_mke + mke_src * idtdr0</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;                dtke_conv_decay = dtke_conv_decay + &amp;</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;                    (cs%nstar-nstar_fc) * conv_perel(i) * idtdr0</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160; </div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;              <span class="keywordflow">if</span> (sfc_connected(i)) cs%ML_depth(i,j) = cs%ML_depth(i,j) + &amp;</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;                   (pe_chg / pe_chg_g0) * gv%H_to_Z * h(i,k)</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;              tot_tke = 0.0 ; mech_tke(i) = 0.0 ; conv_perel(i) = 0.0</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;              sfc_disconnect = .true.</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160; </div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;            kddt_h(k) = kd(i,k)*dt_h</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;           <span class="comment">!   At this point, the final value of Kddt_h(K) is known, so the</span></div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;           <span class="comment">! estimated properties for layer k-1 can be calculated.</span></div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;            b1 = 1.0 / (hp_a(i) + kddt_h(k))</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;            c1(k) = kddt_h(k) * b1</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;            <span class="keywordflow">if</span> (cs%orig_PE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;              dte(k-1) = b1 * ( kddt_h(k)*(t0(k)-t0(k-1)) + dte_t2 )</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;              dse(k-1) = b1 * ( kddt_h(k)*(s0(k)-s0(k-1)) + dse_t2 )</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160; </div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;            hp_a(i) = h(i,k) + (hp_a(i) * b1) * kddt_h(k)</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;            dt_to_dpe_a(i,k) = dt_to_dpe(i,k) + c1(k)*dt_to_dpe_a(i,k-1)</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;            ds_to_dpe_a(i,k) = ds_to_dpe(i,k) + c1(k)*ds_to_dpe_a(i,k-1)</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;            dt_to_dcolht_a(i,k) = dt_to_dcolht(i,k) + c1(k)*dt_to_dcolht_a(i,k-1)</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;            ds_to_dcolht_a(i,k) = ds_to_dcolht(i,k) + c1(k)*ds_to_dcolht_a(i,k-1)</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160; </div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;<span class="keywordflow">          endif</span>  <span class="comment">! tot_TKT &gt; 0.0 branch.  Kddt_h(K) has been set.</span></div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160; </div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;          <span class="comment">! Store integrated velocities and thicknesses for MKE conversion calculations.</span></div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;          <span class="keywordflow">if</span> (sfc_disconnect) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;            <span class="comment">! There is no turbulence at this interface, so zero out the running sums.</span></div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;            uhtot(i) = u(i,k)*h(i,k)</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;            vhtot(i) = v(i,k)*h(i,k)</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;            htot(i)  = h(i,k)</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;            sfc_connected(i) = .false.</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;            uhtot(i) = uhtot(i) + u(i,k)*h(i,k)</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;            vhtot(i) = vhtot(i) + v(i,k)*h(i,k)</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;            htot(i)  = htot(i) + h(i,k)</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160; </div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;          <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;            <span class="keywordflow">if</span> (k==2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;              te(1) = b1*(h(i,1)*t0(1))</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;              se(1) = b1*(h(i,1)*s0(1))</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;              te(k-1) = b1 * (h(i,k-1) * t0(k-1) + kddt_h(k-1) * te(k-2))</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;              se(k-1) = b1 * (h(i,k-1) * s0(k-1) + kddt_h(k-1) * se(k-2))</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;        kd(i,nz+1) = 0.0</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160; </div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;        <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;          <span class="comment">! Complete the tridiagonal solve for Te.</span></div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;          b1 = 1.0 / hp_a(i)</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;          te(nz) = b1 * (h(i,nz) * t0(nz) + kddt_h(nz) * te(nz-1))</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;          se(nz) = b1 * (h(i,nz) * s0(nz) + kddt_h(nz) * se(nz-1))</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;          <span class="keywordflow">do</span> k=nz-1,1,-1</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;            te(k) = te(k) + c1(k+1)*te(k+1)</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;            se(k) = se(k) + c1(k+1)*se(k+1)</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;<span class="keywordflow">          enddo</span></div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;        <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_expected)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;          <span class="keywordflow">do</span> k=1,nz ; dt_expected(i,j,k) = te(k) - t0(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;        <span class="keywordflow">if</span> (<span class="keyword">present</span>(ds_expected)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;          <span class="keywordflow">do</span> k=1,nz ; ds_expected(i,j,k) = se(k) - s0(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;        <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;          dpe_debug = 0.0</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;          <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;            dpe_debug = dpe_debug + (dt_to_dpe(i,k) * (te(k) - t0(k)) + &amp;</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;                                     ds_to_dpe(i,k) * (se(k) - s0(k)))</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;<span class="keywordflow">          enddo</span></div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;          mixing_debug = dpe_debug * idtdr0</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;        k = nz <span class="comment">! This is here to allow a breakpoint to be set.</span></div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;        <span class="comment">!/BGR</span></div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;        <span class="comment">! The following lines are used for the iteration</span></div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;        <span class="comment">! note the iteration has been altered to use the value predicted by</span></div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;        <span class="comment">! the TKE threshold (ML_DEPTH).  This is because the MSTAR</span></div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;        <span class="comment">! is now dependent on the ML, and therefore the ML needs to be estimated</span></div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;        <span class="comment">! more precisely than the grid spacing.</span></div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;        <span class="comment">!/</span></div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;        itmax(obl_it) = max_mld       <span class="comment">! Track max    }</span></div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;        itmin(obl_it) = min_mld       <span class="comment">! Track min    } For debug purpose</span></div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;        itguess(obl_it) = mld_guess   <span class="comment">! Track guess  }</span></div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;        <span class="comment">!/</span></div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;        mld_found = 0.0 ; first_obl = .true.</div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;        <span class="keywordflow">if</span> (cs%Orig_MLD_iteration) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;          <span class="comment">!This is how the iteration was original conducted</span></div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;          <span class="keywordflow">do</span> k=2,nz</div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;            <span class="keywordflow">if</span> (first_obl) <span class="keywordflow">then</span> <span class="comment">!Breaks when OBL found</span></div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;              <span class="keywordflow">if</span> ((vstar_used(k) &gt; 1.e-10*us%m_to_Z) .and. k &lt; nz) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;                mld_found = mld_found + h(i,k-1)*gv%H_to_Z</div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;                first_obl = .false.</div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;                <span class="keywordflow">if</span> (mld_found - cs%MLD_tol &gt; mld_guess) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;                  min_mld = mld_guess</div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;                <span class="keywordflow">elseif</span> ((mld_guess - mld_found) &lt; max(cs%MLD_tol,h(i,k-1)*gv%H_to_Z)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;                  obl_converged = .true.<span class="comment">!Break convergence loop</span></div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;                  <span class="keywordflow">if</span> (obl_it_stats) <span class="keywordflow">then</span> <span class="comment">!Compute iteration statistics</span></div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;                    maxit = max(maxit,obl_it)</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;                    minit = min(minit,obl_it)</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;                    sumit = sumit+obl_it</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;                    numit = numit+1</div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;                    print*,maxit,minit,sumit/numit</div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;<span class="keywordflow">                  endif</span></div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;                  cs%ML_Depth2(i,j) = mld_guess</div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;                  max_mld = mld_guess <span class="comment">!We know this guess was too deep</span></div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;<span class="keywordflow">          enddo</span></div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;          <span class="comment">!New method uses ML_DEPTH as computed in ePBL routine</span></div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;          mld_found = cs%ML_Depth(i,j)</div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;          <span class="keywordflow">if</span> (mld_found - cs%MLD_tol &gt; mld_guess) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;            min_mld = mld_guess</div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;          <span class="keywordflow">elseif</span> (abs(mld_guess - mld_found) &lt; cs%MLD_tol) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;            obl_converged = .true.<span class="comment">!Break convergence loop</span></div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;            <span class="keywordflow">if</span> (obl_it_stats) <span class="keywordflow">then</span> <span class="comment">!Compute iteration statistics</span></div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;              maxit = max(maxit,obl_it)</div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;              minit = min(minit,obl_it)</div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;              sumit = sumit+obl_it</div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;              numit = numit+1</div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;              print*,maxit,minit,sumit/numit</div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;            cs%ML_Depth2(i,j) = mld_guess</div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;            max_mld = mld_guess <span class="comment">!We know this guess was too deep</span></div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;        <span class="comment">! For next pass, guess average of minimum and maximum values.</span></div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;        mld_guess = 0.5*(min_mld + max_mld)</div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;        itresult(obl_it) = mld_found</div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! Iteration loop for converged boundary layer thickness.</span></div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;      <span class="keywordflow">if</span> (.not.obl_converged) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;        <span class="comment">!/Temp output, warn that EPBL didn&#39;t converge</span></div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;        <span class="comment">!/Print guess/found for every iteration step</span></div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;        <span class="comment">!print*,&#39;EPBL MLD DID NOT CONVERGE&#39;</span></div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;        notconverged=notconverged+1</div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;        <span class="comment">!do obl_it=1,max_obl_it</span></div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;        <span class="comment">!   print*,ITmin(obl_it),ITmax(obl_it)</span></div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;        <span class="comment">!   print*,obl_it,ITguess(obl_it),ITresult(obl_it)</span></div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;        <span class="comment">!enddo</span></div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;        <span class="comment">!Activate to print out some output when not converged</span></div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;        <span class="comment">!{</span></div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;        <span class="comment">!print*,&#39;Min/Max: &#39;,ITmin(50),ITmax(50)</span></div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;        <span class="comment">!print*,&#39;Guess/result: &#39;,ITguess(50),ITresult(50)</span></div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;        <span class="comment">!print*,&#39;Stats on CPU: &#39;,CONVERGED,NOTCONVERGED,&amp;</span></div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;        <span class="comment">!     real(NOTCONVERGED)/real(CONVERGED)</span></div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;        <span class="comment">!}</span></div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;        <span class="comment">!stop !Kill if not converged during testing.</span></div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;        converged=converged+1</div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160; </div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;      <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;        cs%diag_TKE_MKE(i,j) = cs%diag_TKE_MKE(i,j) + dtke_mke</div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;        cs%diag_TKE_conv(i,j) = cs%diag_TKE_conv(i,j) + dtke_conv</div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;        cs%diag_TKE_forcing(i,j) = cs%diag_TKE_forcing(i,j) + dtke_forcing</div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;        cs%diag_TKE_mixing(i,j) = cs%diag_TKE_mixing(i,j) + dtke_mixing</div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;        cs%diag_TKE_mech_decay(i,j) = cs%diag_TKE_mech_decay(i,j) + dtke_mech_decay</div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;        cs%diag_TKE_conv_decay(i,j) = cs%diag_TKE_conv_decay(i,j) + dtke_conv_decay</div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;       <span class="comment">! CS%diag_TKE_unbalanced_forcing(i,j) = CS%diag_TKE_unbalanced_forcing(i,j) + dTKE_unbalanced</span></div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;      <span class="keywordflow">if</span> (cs%Mixing_Diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;        <span class="comment">!Write to 3-D for outputing Mixing length and</span></div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;        <span class="comment">!  velocity scale.</span></div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;          cs%Mixing_Length(i,j,k) = mixing_length_used(k)</div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;          cs%Velocity_Scale(i,j,k) = vstar_used(k)</div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%Enhance_M)) cs%Enhance_M(i,j) = enhance_m</div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%mstar_mix)) cs%mstar_mix(i,j) = mstar_mix</div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%mstar_lt)) cs%mstar_lt(i,j) = mstar_lt</div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%MLD_Obukhov)) cs%MLD_Obukhov(i,j) = mld_guess * il_obukhov</div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%MLD_Ekman)) cs%MLD_Ekman(i,j) = mld_guess * il_ekman</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%Ekman_Obukhov)) cs%Ekman_Obukhov(i,j) = il_obukhov / (il_ekman + 1.e-10*us%Z_to_m)</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%La)) cs%La(i,j) = la</div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%La_mod)) cs%La_mod(i,j) = lamod</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;    <span class="keywordflow">else</span> <span class="comment">! End of the ocean-point part of the i-loop</span></div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;      <span class="comment">! For masked points, Kd_int must still be set (to 0) because it has intent out.</span></div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;        kd(i,k) = 0.</div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_expected)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; dt_expected(i,j,k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(ds_expected)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; ds_expected(i,j,k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! Close of i-loop - Note unusual loop order!</span></div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160; </div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;    <span class="keywordflow">if</span> (cs%id_Hsfc_used &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; hsfc_used(i,j) = h(i,1)*gv%H_to_Z ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;      <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;        <span class="keywordflow">if</span> (kd(i,k) &gt; 0.0) hsfc_used(i,j) = hsfc_used(i,j) + h(i,k)*gv%H_to_Z</div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160; </div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;    <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;      kd_int(i,j,k) = kd(i,k)</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160; </div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! j-loop</span></div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160; </div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;  <span class="keywordflow">if</span> (write_diags) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;    <span class="keywordflow">if</span> (cs%id_ML_depth &gt; 0) &amp;</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;      <span class="keyword">call </span>post_data(cs%id_ML_depth, cs%ML_depth, cs%diag)</div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_wind &gt; 0) &amp;</div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_wind, cs%diag_TKE_wind, cs%diag)</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_MKE &gt; 0) &amp;</div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_MKE, cs%diag_TKE_MKE, cs%diag)</div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_conv &gt; 0) &amp;</div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_conv, cs%diag_TKE_conv, cs%diag)</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_forcing &gt; 0) &amp;</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_forcing, cs%diag_TKE_forcing, cs%diag)</div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_mixing &gt; 0) &amp;</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_mixing, cs%diag_TKE_mixing, cs%diag)</div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_mech_decay &gt; 0) &amp;</div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_mech_decay, cs%diag_TKE_mech_decay, cs%diag)</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_conv_decay &gt; 0) &amp;</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_conv_decay, cs%diag_TKE_conv_decay, cs%diag)</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;    <span class="keywordflow">if</span> (cs%id_Hsfc_used &gt; 0) &amp;</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Hsfc_used, hsfc_used, cs%diag)</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;    <span class="keywordflow">if</span> (cs%id_Mixing_Length &gt; 0) &amp;</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Mixing_Length, cs%Mixing_Length, cs%diag)</div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;    <span class="keywordflow">if</span> (cs%id_Velocity_Scale &gt;0) &amp;</div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Velocity_Scale, cs%Velocity_Scale, cs%diag)</div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;    <span class="keywordflow">if</span> (cs%id_OSBL &gt;0) &amp;</div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;      <span class="keyword">call </span>post_data(cs%id_OSBL, cs%ML_Depth2, cs%diag)</div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;    <span class="keywordflow">if</span> (cs%id_LT_Enhancement &gt;0) &amp;</div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;      <span class="keyword">call </span>post_data(cs%id_LT_Enhancement, cs%Enhance_M, cs%diag)</div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;    <span class="keywordflow">if</span> (cs%id_MSTAR_MIX &gt;0) &amp;</div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;      <span class="keyword">call </span>post_data(cs%id_MSTAR_MIX, cs%MSTAR_MIX, cs%diag)</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;    <span class="keywordflow">if</span> (cs%id_MLD_OBUKHOV &gt;0) &amp;</div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;      <span class="keyword">call </span>post_data(cs%id_MLD_Obukhov, cs%MLD_OBUKHOV, cs%diag)</div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;    <span class="keywordflow">if</span> (cs%id_MLD_EKMAN &gt;0) &amp;</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;      <span class="keyword">call </span>post_data(cs%id_MLD_Ekman, cs%MLD_EKMAN, cs%diag)</div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;    <span class="keywordflow">if</span> (cs%id_Ekman_Obukhov &gt;0) &amp;</div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Ekman_Obukhov, cs%Ekman_Obukhov, cs%diag)</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;    <span class="keywordflow">if</span> (cs%id_LA &gt;0) &amp;</div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;      <span class="keyword">call </span>post_data(cs%id_LA, cs%LA, cs%diag)</div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;    <span class="keywordflow">if</span> (cs%id_LA_MOD &gt;0) &amp;</div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;      <span class="keyword">call </span>post_data(cs%id_LA_MOD, cs%LA_MOD, cs%diag)</div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;    <span class="keywordflow">if</span> (cs%id_MSTAR_LT &gt; 0) &amp;</div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;      <span class="keyword">call </span>post_data(cs%id_MSTAR_LT, cs%MSTAR_LT, cs%diag)</div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01623">find_pe_chg()</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01772">find_pe_chg_orig()</a>, <a class="el" href="MOM__wave__interface_8F90_source.html#l00879">mom_wave_interface::get_langmuir_number()</a>, and <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_a397c319268a901e2e4bf3c5a3e7730f4_cgraph.svg" width="100%" height="486"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a64860c8b0110ba516795a288acdefd1f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a64860c8b0110ba516795a288acdefd1f">&#9670;&nbsp;</a></span>energetic_pbl_end()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_energetic_pbl::energetic_pbl_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__energetic__pbl_1_1energetic__pbl__cs.html">energetic_pbl_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Clean up and deallocate memory associated with the energetic_PBL module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">cs</td><td>Energetic_PBL control structure that will be deallocated in this subroutine. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l02439">2439</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;  <span class="keywordtype">type</span>(energetic_PBL_CS), <span class="keywordtype">pointer</span> :: CS<span class="comment"> !&lt; Energetic_PBL control structure that</span></div>
<div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;<span class="comment">                                        !! will be deallocated in this subroutine.</span></div>
<div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160; </div>
<div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keywordflow">return</span></div>
<div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160; </div>
<div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%ML_depth))            <span class="keyword">deallocate</span>(cs%ML_depth)</div>
<div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%ML_depth2))           <span class="keyword">deallocate</span>(cs%ML_depth2)</div>
<div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%Enhance_M))           <span class="keyword">deallocate</span>(cs%Enhance_M)</div>
<div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%MLD_EKMAN))           <span class="keyword">deallocate</span>(cs%MLD_EKMAN)</div>
<div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%MLD_OBUKHOV))         <span class="keyword">deallocate</span>(cs%MLD_OBUKHOV)</div>
<div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%EKMAN_OBUKHOV))       <span class="keyword">deallocate</span>(cs%EKMAN_OBUKHOV)</div>
<div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%LA))                  <span class="keyword">deallocate</span>(cs%LA)</div>
<div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%LA_MOD))              <span class="keyword">deallocate</span>(cs%LA_MOD)</div>
<div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%MSTAR_MIX))           <span class="keyword">deallocate</span>(cs%MSTAR_MIX)</div>
<div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%MSTAR_LT))            <span class="keyword">deallocate</span>(cs%MSTAR_LT)</div>
<div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%diag_TKE_wind))       <span class="keyword">deallocate</span>(cs%diag_TKE_wind)</div>
<div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%diag_TKE_MKE))        <span class="keyword">deallocate</span>(cs%diag_TKE_MKE)</div>
<div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%diag_TKE_conv))       <span class="keyword">deallocate</span>(cs%diag_TKE_conv)</div>
<div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%diag_TKE_forcing))    <span class="keyword">deallocate</span>(cs%diag_TKE_forcing)</div>
<div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%diag_TKE_mixing))     <span class="keyword">deallocate</span>(cs%diag_TKE_mixing)</div>
<div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%diag_TKE_mech_decay)) <span class="keyword">deallocate</span>(cs%diag_TKE_mech_decay)</div>
<div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%diag_TKE_conv_decay)) <span class="keyword">deallocate</span>(cs%diag_TKE_conv_decay)</div>
<div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%Mixing_Length))       <span class="keyword">deallocate</span>(cs%Mixing_Length)</div>
<div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%Velocity_Scale))      <span class="keyword">deallocate</span>(cs%Velocity_Scale)</div>
<div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160; </div>
<div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;  <span class="keyword">deallocate</span>(cs)</div>
<div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160; </div>
</div><!-- fragment -->
</div>
</div>
<a id="af3a7ca5357ed9a1383c9556b117116dc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af3a7ca5357ed9a1383c9556b117116dc">&#9670;&nbsp;</a></span>energetic_pbl_get_mld()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_energetic_pbl::energetic_pbl_get_mld </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__energetic__pbl_1_1energetic__pbl__cs.html">energetic_pbl_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(out)&#160;</td>
          <td class="paramname"><em>MLD</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>m_to_MLD_units</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Copies the ePBL active mixed layer depth into MLD. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Control structure for ePBL </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">mld</td><td>Depth of ePBL active mixing layer [m or other units] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">m_to_mld_units</td><td>A conversion factor to the desired units for MLD </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01921">1921</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;  <span class="keywordtype">type</span>(energetic_PBL_CS),           <span class="keywordtype">pointer</span>     :: CS<span class="comment">  !&lt; Control structure for ePBL</span></div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),            <span class="keywordtype">intent(in)</span>  :: G<span class="comment">   !&lt; Grid structure</span></div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),            <span class="keywordtype">intent(in)</span>  :: US<span class="comment">  !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>, <span class="keywordtype">intent(out)</span> :: MLD<span class="comment"> !&lt; Depth of ePBL active mixing layer [m or other units]</span></div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;<span class="keywordtype">  real</span>,                   <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>  :: m_to_MLD_units<span class="comment"> !&lt; A conversion factor to the desired units for MLD</span></div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;<span class="keywordtype">  real</span> :: scale  <span class="comment">! A dimensional rescaling factor</span></div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;  <span class="keywordtype">integer</span> :: i,j</div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160; </div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;  scale = us%Z_to_m ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(m_to_mld_units)) scale = scale * m_to_mld_units</div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160; </div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;  <span class="keywordflow">do</span> j=g%jsc,g%jec ; <span class="keywordflow">do</span> i=g%isc,g%iec</div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;    mld(i,j) = scale*cs%ML_Depth(i,j)</div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__diabatic__driver_8F90_source.html#l00268">mom_diabatic_driver::diabatic()</a>, and <a class="el" href="MOM__diabatic__driver_8F90_source.html#l01127">mom_diabatic_driver::legacy_diabatic()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_af3a7ca5357ed9a1383c9556b117116dc_icgraph.svg" width="100%" height="388"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="ad9fa0dc4ba4e126ec686b44a5829c2e8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad9fa0dc4ba4e126ec686b44a5829c2e8">&#9670;&nbsp;</a></span>energetic_pbl_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_energetic_pbl::energetic_pbl_init </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in), target&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(inout), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__energetic__pbl_1_1energetic__pbl__cs.html">energetic_pbl_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine initializes the energetic_PBL module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>The current model time </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>A structure to parse for run-time parameters </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">diag</td><td>A structure that is used to regulate diagnostic output </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>A pointer that is set to point to the control structure for this module </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l02078">2078</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;  <span class="keywordtype">type</span>(time_type), <span class="keywordtype">target</span>, <span class="keywordtype">intent(in)</span>    :: Time<span class="comment"> !&lt; The current model time</span></div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>    :: US<span class="comment">   !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;  <span class="keywordtype">type</span>(param_file_type),   <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; A structure to parse for run-time parameters</span></div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>, <span class="keywordtype">intent(inout)</span> :: diag<span class="comment"> !&lt; A structure that is used to regulate diagnostic output</span></div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;  <span class="keywordtype">type</span>(energetic_PBL_CS),  <span class="keywordtype">pointer</span>       :: CS<span class="comment">   !&lt; A pointer that is set to point to the control</span></div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;<span class="comment">                                                 !! structure for this module</span></div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;  <span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;<span class="preprocessor"># include &quot;version_variable.h&quot;</span></div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_energetic_PBL&quot;</span>  <span class="comment">! This module&#39;s name.</span></div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;<span class="keywordtype">  real</span> :: omega_frac_dflt</div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;  <span class="keywordtype">integer</span> :: isd, ied, jsd, jed</div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;  <span class="keywordtype">logical</span> :: use_temperature, use_omega</div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;  <span class="keywordtype">logical</span> :: use_la_windsea</div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed</div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160; </div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;mixedlayer_init called with an associated&quot;</span>// &amp;</div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;                            <span class="stringliteral">&quot;associated control structure.&quot;</span>)</div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;    <span class="keywordflow">return</span></div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;  <span class="keywordflow">else</span> ; <span class="keyword">allocate</span>(cs) ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160; </div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;  cs%diag =&gt; diag</div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;  cs%Time =&gt; time</div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160; </div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;<span class="comment">! Set default, read and log parameters</span></div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, <span class="stringliteral">&quot;&quot;</span>)</div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160; </div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR_MODE&quot;</span>, cs%mstar_mode, &amp;</div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;                 <span class="stringliteral">&quot;An integer switch for how to compute MSTAR. \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;                 <span class="stringliteral">&quot;    0 for constant MSTAR\n&quot;</span>//&amp;</div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;                 <span class="stringliteral">&quot;    1 for MSTAR w/ MLD in stabilizing limit\n&quot;</span>//&amp;</div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;                 <span class="stringliteral">&quot;    2 for MSTAR w/ L_E/L_O in stabilizing limit\n&quot;</span>//&amp;</div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;                 <span class="stringliteral">&quot;    3 for MSTAR as in RH18.&quot;</span>,&amp;</div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;                 <span class="stringliteral">&quot;units=nondim&quot;</span>,default=0)</div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR&quot;</span>, cs%mstar, &amp;</div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;                 <span class="stringliteral">&quot;The ratio of the friction velocity cubed to the TKE &quot;</span>//&amp;</div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;                 <span class="stringliteral">&quot;input to the mixed layer.&quot;</span>, <span class="stringliteral">&quot;units=nondim&quot;</span>, default=1.2)</div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MIX_LEN_EXPONENT&quot;</span>, cs%MixLenExponent, &amp;</div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;                 <span class="stringliteral">&quot;The exponent applied to the ratio of the distance to the MLD &quot;</span>//&amp;</div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;                 <span class="stringliteral">&quot;and the MLD depth which determines the shape of the mixing length.&quot;</span>,&amp;</div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;                 <span class="stringliteral">&quot;units=nondim&quot;</span>, default=2.0)</div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR_CAP&quot;</span>, cs%mstar_cap, &amp;</div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;                 <span class="stringliteral">&quot;Maximum value of mstar allowed in model if non-negative &quot;</span>//&amp;</div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;                 <span class="stringliteral">&quot;(used if MSTAR_MODE&gt;0).&quot;</span>,&amp;</div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;                 <span class="stringliteral">&quot;units=nondim&quot;</span>, default=-1.0)</div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR_CONV_ADJ&quot;</span>, cs%cnv_mst_fac, &amp;</div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;                 <span class="stringliteral">&quot;Factor used for reducing mstar during convection &quot;</span>//&amp;</div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;                 <span class="stringliteral">&quot;due to reduction of stable density gradient.&quot;</span>,&amp;</div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;                 <span class="stringliteral">&quot;units=nondim&quot;</span>, default=0.0)</div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR_SLOPE&quot;</span>, cs%mstar_slope, &amp;</div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;                 <span class="stringliteral">&quot;The slope of the linear relationship between mstar &quot;</span>//&amp;</div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;                 <span class="stringliteral">&quot;and the length scale ratio (used if MSTAR_MODE=1).&quot;</span>,&amp;</div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;                 <span class="stringliteral">&quot;units=nondim&quot;</span>, default=0.85)</div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR_XINT&quot;</span>, cs%mstar_xint, &amp;</div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;                 <span class="stringliteral">&quot;The value of the length scale ratio where the mstar &quot;</span>//&amp;</div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;                 <span class="stringliteral">&quot;is linear above (used if MSTAR_MODE=1).&quot;</span>,&amp;</div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;                 <span class="stringliteral">&quot;units=nondim&quot;</span>, default=-0.3)</div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR_AT_XINT&quot;</span>, cs%mstar_at_xint, &amp;</div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;                 <span class="stringliteral">&quot;The value of mstar at MSTAR_XINT &quot;</span>//&amp;</div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;                 <span class="stringliteral">&quot;(used if MSTAR_MODE=1).&quot;</span>,&amp;</div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;                 <span class="stringliteral">&quot;units=nondim&quot;</span>, default=0.095)</div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR_FLATCAP&quot;</span>, cs%MSTAR_FLATCAP, &amp;</div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;                 <span class="stringliteral">&quot;Set false to use asymptotic cap, defaults to true. &quot;</span>//&amp;</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;                 <span class="stringliteral">&quot;(used only if MSTAR_MODE=1)&quot;</span>&amp;</div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;                 ,<span class="stringliteral">&quot;units=nondim&quot;</span>,default=.true.)</div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR2_COEF1&quot;</span>, cs%MSTAR_COEF, &amp;</div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;                 <span class="stringliteral">&quot;Coefficient in computing mstar when rotation and &quot;</span>//&amp;</div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;                 <span class="stringliteral">&quot;stabilizing effects are both important (used if MSTAR_MODE=2)&quot;</span>&amp;</div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;                  ,<span class="stringliteral">&quot;units=nondim&quot;</span>,default=0.3)</div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR2_COEF2&quot;</span>, cs%C_EK, &amp;</div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;                 <span class="stringliteral">&quot;Coefficient in computing mstar when only rotation limits &quot;</span>//&amp;</div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;                 <span class="stringliteral">&quot;the total mixing. (used only if MSTAR_MODE=2)&quot;</span>&amp;</div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;                  ,<span class="stringliteral">&quot;units=nondim&quot;</span>,default=0.085)</div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RH18_MST_CN1&quot;</span>, cs%RH18_MST_CN1,&amp;</div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;                 <span class="stringliteral">&quot;MSTAR_N coefficient 1 (outter-most coefficient for fit). \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;                 <span class="stringliteral">&quot; The value of 0.275 is given in RH18.  Increasing this \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;                 <span class="stringliteral">&quot;coefficient increases MSTAR for all values of Hf/ust, but more \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;                 <span class="stringliteral">&quot;effectively at low values (weakly developed OSBLs).&quot;</span>,&amp;</div>
<div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.275)</div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RH18_MST_CN2&quot;</span>, cs%RH18_MST_CN2,&amp;</div>
<div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;                 <span class="stringliteral">&quot;MSTAR_N coefficient 2 (coefficient outside of exponential decay). \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;                 <span class="stringliteral">&quot;The value of 8.0 is given in RH18.  Increasing this coefficient \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;                 <span class="stringliteral">&quot;increases MSTAR for all values of HF/ust, with a much more even \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;                 <span class="stringliteral">&quot;effect across a wide range of Hf/ust than CN1.&quot;</span>,&amp;</div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>,default=8.0)</div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RH18_MST_CN3&quot;</span>, cs%RH18_MST_CN3,&amp;</div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;                 <span class="stringliteral">&quot;MSTAR_N coefficient 3 (exponential decay coefficient). \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;                 <span class="stringliteral">&quot;The value of -5.0 is given in RH18.  Increasing this increases how \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;                 <span class="stringliteral">&quot;quickly the value of MSTAR decreases as Hf/ust increases.&quot;</span>,&amp;</div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;                  units=<span class="stringliteral">&quot;nondim&quot;</span>,default=-5.0)</div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RH18_MST_CS1&quot;</span>, cs%RH18_MST_CS1,&amp;</div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;                 <span class="stringliteral">&quot;MSTAR_S coefficient for RH18 in stabilizing limit. \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;                 <span class="stringliteral">&quot;The value of 0.2 is given in RH18 and increasing it increases \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;                 <span class="stringliteral">&quot;MSTAR in the presence of a stabilizing surface buoyancy flux.&quot;</span>,&amp;</div>
<div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>,default=0.2)</div>
<div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RH18_MST_CS2&quot;</span>, cs%RH18_MST_CS2,&amp;</div>
<div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;                 <span class="stringliteral">&quot;MSTAR_S exponent for RH18 in stabilizing limit. \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;                 <span class="stringliteral">&quot;The value of 0.4 is given in RH18 and increasing it increases MSTAR \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;                 <span class="stringliteral">&quot;exponentially in the presence of a stabilizing surface buoyancy flux.&quot;</span>,&amp;</div>
<div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>,default=0.4)</div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NSTAR&quot;</span>, cs%nstar, &amp;</div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;                 <span class="stringliteral">&quot;The portion of the buoyant potential energy imparted by &quot;</span>//&amp;</div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;                 <span class="stringliteral">&quot;surface fluxes that is available to drive entrainment &quot;</span>//&amp;</div>
<div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;                 <span class="stringliteral">&quot;at the base of mixed layer when that energy is positive.&quot;</span>, &amp;</div>
<div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.2)</div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MKE_TO_TKE_EFFIC&quot;</span>, cs%MKE_to_TKE_effic, &amp;</div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;                 <span class="stringliteral">&quot;The efficiency with which mean kinetic energy released &quot;</span>//&amp;</div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;                 <span class="stringliteral">&quot;by mechanically forced entrainment of the mixed layer &quot;</span>//&amp;</div>
<div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;                 <span class="stringliteral">&quot;is converted to turbulent kinetic energy.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, &amp;</div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;                 default=0.0)</div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TKE_DECAY&quot;</span>, cs%TKE_decay, &amp;</div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;                 <span class="stringliteral">&quot;TKE_DECAY relates the vertical rate of decay of the &quot;</span>//&amp;</div>
<div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;                 <span class="stringliteral">&quot;TKE available for mechanical entrainment to the natural &quot;</span>//&amp;</div>
<div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;                 <span class="stringliteral">&quot;Ekman depth.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=2.5)</div>
<div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;<span class="comment">!  call get_param(param_file, mdl, &quot;HMIX_MIN&quot;, CS%Hmix_min, &amp;</span></div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;<span class="comment">!                 &quot;The minimum mixed layer depth if the mixed layer depth &quot;//&amp;</span></div>
<div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;<span class="comment">!                 &quot;is determined dynamically.&quot;, units=&quot;m&quot;, default=0.0)</span></div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160; </div>
<div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OMEGA&quot;</span>,cs%omega,              &amp;</div>
<div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;                 <span class="stringliteral">&quot;The rotation rate of the earth.&quot;</span>, units=<span class="stringliteral">&quot;s-1&quot;</span>, &amp;</div>
<div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;                 default=7.2921e-5)</div>
<div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_USE_OMEGA&quot;</span>, use_omega,                  &amp;</div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;                 <span class="stringliteral">&quot;If true, use the absolute rotation rate instead of the &quot;</span>//&amp;</div>
<div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;                 <span class="stringliteral">&quot;vertical component of rotation when setting the decay &quot;</span>// &amp;</div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;                 <span class="stringliteral">&quot;scale for turbulence.&quot;</span>, default=.false., do_not_log=.true.)</div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;  omega_frac_dflt = 0.0</div>
<div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;  <span class="keywordflow">if</span> (use_omega) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;ML_USE_OMEGA is depricated; use ML_OMEGA_FRAC=1.0 instead.&quot;</span>)</div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;    omega_frac_dflt = 1.0</div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_OMEGA_FRAC&quot;</span>, cs%omega_frac,              &amp;</div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;                 <span class="stringliteral">&quot;When setting the decay scale for turbulence, use this &quot;</span>//  &amp;</div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;                 <span class="stringliteral">&quot;fraction of the absolute rotation rate blended with the &quot;</span>//&amp;</div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;                 <span class="stringliteral">&quot;local value of f, as sqrt((1-of)*f^2 + of*4*omega^2).&quot;</span>,      &amp;</div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=omega_frac_dflt)</div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;VSTAR_MODE&quot;</span>, cs%vstar_mode, &amp;</div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;                 <span class="stringliteral">&quot;An integer switch for how to compute VSTAR. \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;                 <span class="stringliteral">&quot;    0 for old  vstar (TKE Remaining)^(1/3)\n&quot;</span>//&amp;</div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;                 <span class="stringliteral">&quot;    1 for vstar from u* and w* (see Reichl &amp; Hallberg 2018).&quot;</span>,&amp;</div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;                 <span class="stringliteral">&quot;units=nondim&quot;</span>,default=0)</div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;WSTAR_USTAR_COEF&quot;</span>, cs%wstar_ustar_coef,     &amp;</div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;                 <span class="stringliteral">&quot;A ratio relating the efficiency with which convectively &quot;</span>//&amp;</div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;                 <span class="stringliteral">&quot;released energy is converted to a turbulent velocity, &quot;</span>//  &amp;</div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;                 <span class="stringliteral">&quot;relative to mechanically forced TKE. Making this larger &quot;</span>//&amp;</div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;                 <span class="stringliteral">&quot;increases the BL diffusivity&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0)</div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;VSTAR_SCALE_FACTOR&quot;</span>, cs%vstar_scale_fac, &amp;</div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;                 <span class="stringliteral">&quot;An overall nondimensional scaling factor for v*. &quot;</span>//    &amp;</div>
<div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;                 <span class="stringliteral">&quot;Making this larger decreases the PBL diffusivity.&quot;</span>,       &amp;</div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0, scale=us%m_to_Z)</div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;VSTAR_SURF_FAC&quot;</span>, cs%vstar_surf_fac,&amp;</div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;                 <span class="stringliteral">&quot;The proportionality times ustar to set vstar to at the surface.&quot;</span>,&amp;</div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;                 <span class="stringliteral">&quot;units=nondim&quot;</span>, default=1.2)</div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_ENHANCE_K_R16&quot;</span>,cs%LT_ENH_K_R16, &amp;</div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;                 <span class="stringliteral">&quot;Logical flag to toggle on enhancing mixing coefficient in\n&quot;</span>//&amp;</div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;                 <span class="stringliteral">&quot;boundary layer due to Langmuir turbulence following Reichl\n&quot;</span>//&amp;</div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;                 <span class="stringliteral">&quot;et al., 2016. \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;                 <span class="stringliteral">&quot;This approach is not recommended for use, as it is based\n&quot;</span>//&amp;</div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;                 <span class="stringliteral">&quot;on a hurricane LES configuration and not known if it is general.&quot;</span>,&amp;</div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>,default=.false.)</div>
<div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EKMAN_SCALE_COEF&quot;</span>, cs%Ekman_scale_coef,           &amp;</div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;                 <span class="stringliteral">&quot;A nondimensional scaling factor controlling the inhibition &quot;</span>//   &amp;</div>
<div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;                 <span class="stringliteral">&quot;of the diffusive length scale by rotation. Making this larger &quot;</span>//&amp;</div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;                 <span class="stringliteral">&quot;decreases the PBL diffusivity.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0)</div>
<div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_MLD_ITERATION&quot;</span>, cs%USE_MLD_ITERATION,    &amp;</div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;                 <span class="stringliteral">&quot;A logical that specifies whether or not to use the &quot;</span>//      &amp;</div>
<div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;                 <span class="stringliteral">&quot;distance to the bottom of the actively turbulent boundary &quot;</span>//&amp;</div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;                 <span class="stringliteral">&quot;layer to help set the EPBL length scale.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ORIG_MLD_ITERATION&quot;</span>, cs%ORIG_MLD_ITERATION,  &amp;</div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;                 <span class="stringliteral">&quot;A logical that specifies whether or not to use the &quot;</span>//      &amp;</div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;                 <span class="stringliteral">&quot;old method for determining MLD depth in iteration, which &quot;</span>//&amp;</div>
<div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;                 <span class="stringliteral">&quot;is limited to resolution.&quot;</span>, default=.true.)</div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MLD_ITERATION_GUESS&quot;</span>, cs%MLD_ITERATION_GUESS,       &amp;</div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;                 <span class="stringliteral">&quot;A logical that specifies whether or not to use the &quot;</span>//             &amp;</div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;                 <span class="stringliteral">&quot;previous timestep MLD as a first guess in the MLD iteration. &quot;</span>//    &amp;</div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;                 <span class="stringliteral">&quot;The default is false to facilitate reproducibility.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_MLD_TOLERANCE&quot;</span>, cs%MLD_tol,         &amp;</div>
<div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;                 <span class="stringliteral">&quot;The tolerance for the iteratively determined mixed &quot;</span>//  &amp;</div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;                 <span class="stringliteral">&quot;layer depth.  This is only used with USE_MLD_ITERATION.&quot;</span>, &amp;</div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;                 units=<span class="stringliteral">&quot;meter&quot;</span>, default=1.0, scale=us%m_to_Z)</div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_MIN_MIX_LEN&quot;</span>, cs%min_mix_len,    &amp;</div>
<div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;                 <span class="stringliteral">&quot;The minimum mixing length scale that will be used &quot;</span>//&amp;</div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;                 <span class="stringliteral">&quot;by ePBL.  The default (0) does not set a minimum.&quot;</span>,    &amp;</div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;                 units=<span class="stringliteral">&quot;meter&quot;</span>, default=0.0, scale=us%m_to_Z)</div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_ORIGINAL_PE_CALC&quot;</span>, cs%orig_PE_calc,         &amp;</div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;                 <span class="stringliteral">&quot;If true, the ePBL code uses the original form of the &quot;</span>//        &amp;</div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;                 <span class="stringliteral">&quot;potential energy change code.  Otherwise, the newer &quot;</span>//         &amp;</div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;                 <span class="stringliteral">&quot;version that can work with successive increments to the &quot;</span>//     &amp;</div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;                 <span class="stringliteral">&quot;diffusivity in upward or downward passes is used.&quot;</span>, default=.true.)</div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_TRANSITION_SCALE&quot;</span>, cs%transLay_scale, &amp;</div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;                 <span class="stringliteral">&quot;A scale for the mixing length in the transition layer &quot;</span>// &amp;</div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;                 <span class="stringliteral">&quot;at the edge of the boundary layer as a fraction of the &quot;</span>//&amp;</div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;                 <span class="stringliteral">&quot;boundary layer thickness.  The default is 0.1.&quot;</span>, &amp;</div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.1)</div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;  <span class="keywordflow">if</span> ( cs%USE_MLD_ITERATION .and. abs(cs%transLay_scale-0.5) &gt;= 0.5) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;If flag USE_MLD_ITERATION is true, then &quot;</span>//       &amp;</div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;                 <span class="stringliteral">&quot;EPBL_TRANSITION should be greater than 0 and less than 1.&quot;</span>)</div>
<div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;N2_DISSIPATION_POS&quot;</span>, cs%N2_Dissipation_Scale_Pos, &amp;</div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;                 <span class="stringliteral">&quot;A scale for the dissipation of TKE due to stratification &quot;</span>//     &amp;</div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;                 <span class="stringliteral">&quot;in the boundary layer, applied when local stratification &quot;</span>//     &amp;</div>
<div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;                 <span class="stringliteral">&quot;is positive.  The default is 0, but should probably be ~0.4.&quot;</span>,     &amp;</div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;N2_DISSIPATION_NEG&quot;</span>, cs%N2_Dissipation_Scale_Neg,&amp;</div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;                 <span class="stringliteral">&quot;A scale for the dissipation of TKE due to stratification &quot;</span>//    &amp;</div>
<div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;                 <span class="stringliteral">&quot;in the boundary layer, applied when local stratification &quot;</span>//    &amp;</div>
<div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;                 <span class="stringliteral">&quot;is negative.  The default is 0, but should probably be ~1.&quot;</span>,      &amp;</div>
<div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div>
<div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_LA_LI2016&quot;</span>, use_la_windsea,      &amp;</div>
<div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;       <span class="stringliteral">&quot;A logical to use the Li et al. 2016 (submitted) formula to &quot;</span>//&amp;</div>
<div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;       <span class="stringliteral">&quot;determine the Langmuir number.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=.false.)</div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;  <span class="comment">! Note this can be activated in other ways, but this preserves the old method.</span></div>
<div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;  <span class="keywordflow">if</span> (use_la_windsea) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;    cs%USE_LT = .true.</div>
<div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_LT&quot;</span>, cs%USE_LT, &amp;</div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;         <span class="stringliteral">&quot;A logical to use a LT parameterization.&quot;</span>,              &amp;</div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;         units=<span class="stringliteral">&quot;nondim&quot;</span>, default=.false.)</div>
<div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;  <span class="keywordflow">if</span> (cs%USE_LT) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_ENHANCE&quot;</span>, cs%LT_ENHANCE_FORM, &amp;</div>
<div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;         <span class="stringliteral">&quot;Integer for Langmuir number mode. \n&quot;</span>//                     &amp;</div>
<div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;         <span class="stringliteral">&quot; *Requires USE_LA_LI2016 to be set to True. \n&quot;</span>//           &amp;</div>
<div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;         <span class="stringliteral">&quot;Options: 0 - No Langmuir \n&quot;</span>//                              &amp;</div>
<div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;         <span class="stringliteral">&quot;         1 - Van Roekel et al. 2014/Li et al., 2016  \n&quot;</span>//  &amp;</div>
<div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;         <span class="stringliteral">&quot;         2 - Multiplied w/ adjusted La. \n&quot;</span>//               &amp;</div>
<div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;         <span class="stringliteral">&quot;         3 - Added w/ adjusted La.&quot;</span>,                        &amp;</div>
<div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;         units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0)</div>
<div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_ENHANCE_COEF&quot;</span>, cs%LT_ENHANCE_COEF, &amp;</div>
<div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;         <span class="stringliteral">&quot;Coefficient for Langmuir enhancement if LT_ENHANCE &gt; 1&quot;</span>,         &amp;</div>
<div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;         units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.447)</div>
<div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_ENHANCE_EXP&quot;</span>, cs%LT_ENHANCE_EXP, &amp;</div>
<div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;         <span class="stringliteral">&quot;Exponent for Langmuir enhancement if LT_ENHANCE &gt; 1&quot;</span>,          &amp;</div>
<div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;         units=<span class="stringliteral">&quot;nondim&quot;</span>, default=-1.33)</div>
<div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_MOD_LAC1&quot;</span>, cs%LaC_MLDoEK,    &amp;</div>
<div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;         <span class="stringliteral">&quot;Coefficient for modification of Langmuir number due to &quot;</span>//&amp;</div>
<div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;         <span class="stringliteral">&quot;MLD approaching Ekman depth if LT_ENHANCE=2.&quot;</span>,            &amp;</div>
<div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;         units=<span class="stringliteral">&quot;nondim&quot;</span>, default=-0.87)</div>
<div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_MOD_LAC2&quot;</span>, cs%LaC_MLDoOB_stab, &amp;</div>
<div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;         <span class="stringliteral">&quot;Coefficient for modification of Langmuir number due to &quot;</span>//  &amp;</div>
<div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;         <span class="stringliteral">&quot;MLD approaching stable Obukhov depth if LT_ENHANCE=2.&quot;</span>,     &amp;</div>
<div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;         units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div>
<div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_MOD_LAC3&quot;</span>, cs%LaC_MLDoOB_un, &amp;</div>
<div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;         <span class="stringliteral">&quot;Coefficient for modification of Langmuir number due to &quot;</span>//&amp;</div>
<div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;         <span class="stringliteral">&quot;MLD approaching unstable Obukhov depth if LT_ENHANCE=2.&quot;</span>, &amp;</div>
<div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;         units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div>
<div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_MOD_LAC4&quot;</span>, cs%Lac_EKoOB_stab, &amp;</div>
<div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;         <span class="stringliteral">&quot;Coefficient for modification of Langmuir number due to &quot;</span>// &amp;</div>
<div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;         <span class="stringliteral">&quot;ratio of Ekman to stable Obukhov depth if LT_ENHANCE=2.&quot;</span>,  &amp;</div>
<div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;         units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.95)</div>
<div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_MOD_LAC5&quot;</span>, cs%Lac_EKoOB_un,   &amp;</div>
<div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;         <span class="stringliteral">&quot;Coefficient for modification of Langmuir number due to &quot;</span>// &amp;</div>
<div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;         <span class="stringliteral">&quot;ratio of Ekman to unstable Obukhov depth if LT_ENHANCE=2.&quot;</span>,&amp;</div>
<div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;         units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.95)</div>
<div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;  <span class="comment">! This gives a minimum decay scale that is typically much less than Angstrom.</span></div>
<div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;  cs%ustar_min = 2e-4*cs%omega*(gv%Angstrom_Z + gv%H_to_Z*gv%H_subroundoff)</div>
<div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;  <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_USTAR_MIN&quot;</span>, cs%ustar_min*us%Z_to_m, &amp;</div>
<div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;                 <span class="stringliteral">&quot;The (tiny) minimum friction velocity used within the &quot;</span>//&amp;</div>
<div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;                 <span class="stringliteral">&quot;ePBL code, derived from OMEGA and ANGSTROM.&quot;</span>, units=<span class="stringliteral">&quot;m s-1&quot;</span>)</div>
<div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160; </div>
<div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;  cs%id_ML_depth = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_h_ML&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;      time, <span class="stringliteral">&#39;Surface boundary layer depth&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>, conversion=us%Z_to_m, &amp;</div>
<div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;      cmor_long_name=<span class="stringliteral">&#39;Ocean Mixed Layer Thickness Defined by Mixing Scheme&#39;</span>)</div>
<div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;  cs%id_TKE_wind = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_TKE_wind&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;      time, <span class="stringliteral">&#39;Wind-stirring source of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;m3 s-3&#39;</span>)</div>
<div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;  cs%id_TKE_MKE = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_TKE_MKE&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;      time, <span class="stringliteral">&#39;Mean kinetic energy source of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;m3 s-3&#39;</span>)</div>
<div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;  cs%id_TKE_conv = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_TKE_conv&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;      time, <span class="stringliteral">&#39;Convective source of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;m3 s-3&#39;</span>)</div>
<div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;  cs%id_TKE_forcing = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_TKE_forcing&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;      time, <span class="stringliteral">&#39;TKE consumed by mixing surface forcing or penetrative shortwave radation &#39;</span>//&amp;</div>
<div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;            <span class="stringliteral">&#39;through model layers&#39;</span>, <span class="stringliteral">&#39;m3 s-3&#39;</span>)</div>
<div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;  cs%id_TKE_mixing = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_TKE_mixing&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;      time, <span class="stringliteral">&#39;TKE consumed by mixing that deepens the mixed layer&#39;</span>, <span class="stringliteral">&#39;m3 s-3&#39;</span>)</div>
<div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;  cs%id_TKE_mech_decay = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_TKE_mech_decay&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;      time, <span class="stringliteral">&#39;Mechanical energy decay sink of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;m3 s-3&#39;</span>)</div>
<div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;  cs%id_TKE_conv_decay = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_TKE_conv_decay&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;      time, <span class="stringliteral">&#39;Convective energy decay sink of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;m3 s-3&#39;</span>)</div>
<div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;  cs%id_Hsfc_used = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_Hs_used&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;      time, <span class="stringliteral">&#39;Surface region thickness that is used&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>, conversion=us%m_to_Z)</div>
<div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;  cs%id_Mixing_Length = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;Mixing_Length&#39;</span>, diag%axesTi, &amp;</div>
<div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;      time, <span class="stringliteral">&#39;Mixing Length that is used&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>, conversion=us%Z_to_m)</div>
<div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;  cs%id_Velocity_Scale = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;Velocity_Scale&#39;</span>, diag%axesTi, &amp;</div>
<div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;      time, <span class="stringliteral">&#39;Velocity Scale that is used.&#39;</span>, <span class="stringliteral">&#39;m s-1&#39;</span>, conversion=us%Z_to_m)</div>
<div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;  cs%id_LT_enhancement = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;LT_Enhancement&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;      time, <span class="stringliteral">&#39;LT enhancement that is used.&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div>
<div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;  cs%id_MSTAR_mix = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MSTAR&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;      time, <span class="stringliteral">&#39;MSTAR that is used.&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div>
<div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;  cs%id_OSBL = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_OSBL&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;      time, <span class="stringliteral">&#39;ePBL Surface Boundary layer depth.&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>, conversion=us%m_to_Z)</div>
<div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;  <span class="comment">! BGR (9/21/2017) Note that ePBL_OSBL is the guess for iteration step while ePBL_h_ML is</span></div>
<div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;  <span class="comment">!                 result from iteration step.</span></div>
<div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;  cs%id_mld_ekman = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MLD_EKMAN&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;      time, <span class="stringliteral">&#39;Boundary layer depth over Ekman length.&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>)</div>
<div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;  cs%id_mld_obukhov = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MLD_OBUKHOV&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;      time, <span class="stringliteral">&#39;Boundary layer depth over Obukhov length.&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>)</div>
<div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;  cs%id_ekman_obukhov = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;EKMAN_OBUKHOV&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;      time, <span class="stringliteral">&#39;Ekman length over Obukhov length.&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>)</div>
<div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;  cs%id_LA = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;LA&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;      time, <span class="stringliteral">&#39;Langmuir number.&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div>
<div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;  cs%id_LA_mod = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;LA_MOD&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;      time, <span class="stringliteral">&#39;Modified Langmuir number.&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div>
<div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;  cs%id_MSTAR_LT = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MSTAR_LT&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;      time, <span class="stringliteral">&#39;MSTAR applied for LT effect.&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div>
<div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160; </div>
<div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ENABLE_THERMODYNAMICS&quot;</span>, use_temperature, &amp;</div>
<div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;                 <span class="stringliteral">&quot;If true, temperature and salinity are used as state &quot;</span>//&amp;</div>
<div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;                 <span class="stringliteral">&quot;variables.&quot;</span>, default=.true.)</div>
<div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160; </div>
<div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;  <span class="keywordflow">if</span> (max(cs%id_TKE_wind, cs%id_TKE_MKE, cs%id_TKE_conv, &amp;</div>
<div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;          cs%id_TKE_mixing, cs%id_TKE_mech_decay, cs%id_TKE_forcing, &amp;</div>
<div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;          cs%id_TKE_conv_decay) &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_wind, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_MKE, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_conv, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_forcing, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_mixing, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_mech_decay, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_conv_decay, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160; </div>
<div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;    cs%TKE_diagnostics = .true.</div>
<div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;  <span class="keywordflow">if</span> ((cs%id_Mixing_Length&gt;0) .or. (cs%id_Velocity_Scale&gt;0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%Velocity_Scale,isd,ied,jsd,jed,gv%ke+1)</div>
<div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%Mixing_Length,isd,ied,jsd,jed,gv%ke+1)</div>
<div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;    cs%Velocity_Scale(:,:,:) = 0.0</div>
<div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;    cs%Mixing_Length(:,:,:) = 0.0</div>
<div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;    cs%mixing_diagnostics = .true.</div>
<div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;  <span class="keyword">call </span>safe_alloc_alloc(cs%ML_depth, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;  <span class="keyword">call </span>safe_alloc_alloc(cs%ML_depth2, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;  <span class="keywordflow">if</span> (max(cs%id_LT_Enhancement, cs%id_mstar_mix,cs%id_mld_ekman, &amp;</div>
<div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;       cs%id_ekman_obukhov, cs%id_mld_obukhov, cs%id_LA, cs%id_LA_mod, cs%id_MSTAR_LT ) &gt;0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%Mstar_mix, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%Enhance_M, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%MLD_EKMAN, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%MLD_OBUKHOV, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%EKMAN_OBUKHOV, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%LA, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%LA_MOD, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%MSTAR_LT, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160; </div>
<div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;  <span class="comment">!Fitting coefficients to asymptote twoard 0 as MLD -&gt; Ekman depth</span></div>
<div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;  cs%MSTAR_A = cs%MSTAR_AT_XINT**(1./cs%MSTAR_N)</div>
<div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;  cs%MSTAR_B = cs%MSTAR_SLOPE / (cs%MSTAR_N*cs%MSTAR_A**(cs%MSTAR_N-1.))</div>
<div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;  <span class="comment">!Fitting coefficients to asymptote toward MSTAR_CAP</span></div>
<div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;  <span class="comment">!*Fixed to begin asymptote at MSTAR_CAP-0.5 toward MSTAR_CAP</span></div>
<div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;  cs%MSTAR_A2 = 0.5**(1./cs%MSTAR_N)</div>
<div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;  cs%MSTAR_B2 = -cs%MSTAR_SLOPE / (cs%MSTAR_N*cs%MSTAR_A2**(cs%MSTAR_N-1))</div>
<div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;  <span class="comment">!Compute value of X (referenced to MSTAR_XINT) where transition</span></div>
<div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;  <span class="comment">! to asymptotic regime based on value of X where MSTAR=MSTAR_CAP-0.5</span></div>
<div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;  cs%MSTAR_XINT_UP = (cs%MSTAR_CAP-0.5-cs%MSTAR_AT_XINT)/cs%MSTAR_SLOPE</div>
<div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_ad9fa0dc4ba4e126ec686b44a5829c2e8_cgraph.svg" width="564" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="ab0d988822a378f674d3b7e0ee2534c74"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab0d988822a378f674d3b7e0ee2534c74">&#9670;&nbsp;</a></span>find_pe_chg()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_energetic_pbl::find_pe_chg </td>
          <td>(</td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Kddt_h0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dKddt_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>hp_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>hp_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Th_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Sh_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Th_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Sh_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dPE_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dPE_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dPE_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dPE_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>pres_Z</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dColHt_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dColHt_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dColHt_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dColHt_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>PE_chg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>dPEc_dKd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>dPE_max</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>dPEc_dKd_0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>ColHt_cor</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine calculates the change in potential energy and or derivatives for several changes in an interfaces's diapycnal diffusivity times a timestep. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">kddt_h0</td><td>The previously used diffusivity at an interface times the time step and divided by the average of the thicknesses around the interface [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dkddt_h</td><td>The trial change in the diffusivity at an interface times the time step and divided by the average of the thicknesses around the interface [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">hp_a</td><td>The effective pivot thickness of the layer above the interface, given by h_k plus a term that is a fraction (determined from the tridiagonal solver) of Kddt_h for the interface above [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">hp_b</td><td>The effective pivot thickness of the layer below the interface, given by h_k plus a term that is a fraction (determined from the tridiagonal solver) of Kddt_h for the interface above [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">th_a</td><td>An effective temperature times a thickness in the layer above, including implicit mixing effects with other yet higher layers [degC H ~&gt; degC m or degC kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">sh_a</td><td>An effective salinity times a thickness in the layer above, including implicit mixing effects with other yet higher layers [degC H ~&gt; degC m or degC kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">th_b</td><td>An effective temperature times a thickness in the layer below, including implicit mixing effects with other yet lower layers [degC H ~&gt; degC m or degC kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">sh_b</td><td>An effective salinity times a thickness in the layer below, including implicit mixing effects with other yet lower layers [degC H ~&gt; degC m or degC kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dpe_a</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dT) relating a layer's temperature change to the change in column potential energy, including all implicit diffusive changes in the temperatures of all the layers above [J m-2 degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dpe_a</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dS) relating a layer's salinity change to the change in column potential energy, including all implicit diffusive changes in the salinities of all the layers above [J m-2 ppt-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dpe_b</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dT) relating a layer's temperature change to the change in column potential energy, including all implicit diffusive changes in the temperatures of all the layers below [J m-2 degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dpe_b</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dS) relating a layer's salinity change to the change in column potential energy, including all implicit diffusive changes in the salinities of all the layers below [J m-2 ppt-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">pres_z</td><td>The rescaled hydrostatic interface pressure, which relates the changes in column thickness to the energy that is radiated as gravity waves and unavailable to drive mixing [J m-2 Z-1 ~&gt; J m-3]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dcolht_a</td><td>A factor (mass_lay*dSColHtc_vol/dT) relating a layer's temperature change to the change in column height, including all implicit diffusive changes in the temperatures of all the layers above [Z degC-1 ~&gt; m degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dcolht_a</td><td>A factor (mass_lay*dSColHtc_vol/dS) relating a layer's salinity change to the change in column height, including all implicit diffusive changes in the salinities of all the layers above [Z ppt-1 ~&gt; m ppt-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dcolht_b</td><td>A factor (mass_lay*dSColHtc_vol/dT) relating a layer's temperature change to the change in column height, including all implicit diffusive changes in the temperatures of all the layers below [Z degC-1 ~&gt; m degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dcolht_b</td><td>A factor (mass_lay*dSColHtc_vol/dS) relating a layer's salinity change to the change in column height, including all implicit diffusive changes in the salinities of all the layers below [Z ppt-1 ~&gt; m ppt-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">pe_chg</td><td>The change in column potential energy from applying Kddt_h at the present interface [J m-2]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dpec_dkd</td><td>The partial derivative of PE_chg with Kddt_h [J m-2 H-1 ~&gt; J m-3 or J kg-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dpe_max</td><td>The maximum change in column potential energy that could be realizedd by applying a huge value of Kddt_h at the present interface [J m-2]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dpec_dkd_0</td><td>The partial derivative of PE_chg with Kddt_h in the limit where Kddt_h = 0 [J m-2 H-1 ~&gt; J m-3 or J kg-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">colht_cor</td><td>The correction to PE_chg that is made due to a net change in the column height [J m-2]. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01623">1623</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: Kddt_h0<span class="comment">  !&lt; The previously used diffusivity at an interface times</span></div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;<span class="comment">                                !! the time step and  divided by the average of the</span></div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;<span class="comment">                                !! thicknesses around the interface [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dKddt_h<span class="comment">  !&lt; The trial change in the diffusivity at an interface times</span></div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;<span class="comment">                                !! the time step and  divided by the average of the</span></div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;<span class="comment">                                !! thicknesses around the interface [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: hp_a<span class="comment">     !&lt; The effective pivot thickness of the layer above the</span></div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;<span class="comment">                                !! interface, given by h_k plus a term that</span></div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;<span class="comment">                                !! is a fraction (determined from the tridiagonal solver) of</span></div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;<span class="comment">                                !! Kddt_h for the interface above [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: hp_b<span class="comment">     !&lt; The effective pivot thickness of the layer below the</span></div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;<span class="comment">                                !! interface, given by h_k plus a term that</span></div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;<span class="comment">                                !! is a fraction (determined from the tridiagonal solver) of</span></div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;<span class="comment">                                !! Kddt_h for the interface above [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: Th_a<span class="comment">     !&lt; An effective temperature times a thickness in the layer</span></div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;<span class="comment">                                !! above, including implicit mixing effects with other</span></div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;<span class="comment">                                !! yet higher layers [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: Sh_a<span class="comment">     !&lt; An effective salinity times a thickness in the layer</span></div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;<span class="comment">                                !! above, including implicit mixing effects with other</span></div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;<span class="comment">                                !! yet higher layers [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: Th_b<span class="comment">     !&lt; An effective temperature times a thickness in the layer</span></div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;<span class="comment">                                !! below, including implicit mixing effects with other</span></div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;<span class="comment">                                !! yet lower layers [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: Sh_b<span class="comment">     !&lt; An effective salinity times a thickness in the layer</span></div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;<span class="comment">                                !! below, including implicit mixing effects with other</span></div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;<span class="comment">                                !! yet lower layers [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dPE_a<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dT) relating</span></div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;<span class="comment">                                !! a layer&#39;s temperature change to the change in column</span></div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;<span class="comment">                                !! potential energy, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;<span class="comment">                                !! in the temperatures of all the layers above [J m-2 degC-1].</span></div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dPE_a<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dS) relating</span></div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;<span class="comment">                                !! a layer&#39;s salinity change to the change in column</span></div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;<span class="comment">                                !! potential energy, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;<span class="comment">                                !! in the salinities of all the layers above [J m-2 ppt-1].</span></div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dPE_b<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dT) relating</span></div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;<span class="comment">                                !! a layer&#39;s temperature change to the change in column</span></div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;<span class="comment">                                !! potential energy, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;<span class="comment">                                !! in the temperatures of all the layers below [J m-2 degC-1].</span></div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dPE_b<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dS) relating</span></div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;<span class="comment">                                !! a layer&#39;s salinity change to the change in column</span></div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;<span class="comment">                                !! potential energy, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;<span class="comment">                                !! in the salinities of all the layers below [J m-2 ppt-1].</span></div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: pres_Z<span class="comment">   !&lt; The rescaled hydrostatic interface pressure, which relates</span></div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;<span class="comment">                                !! the changes in column thickness to the energy that is radiated</span></div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;<span class="comment">                                !! as gravity waves and unavailable to drive mixing [J m-2 Z-1 ~&gt; J m-3].</span></div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dColHt_a<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dT) relating</span></div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;<span class="comment">                                !! a layer&#39;s temperature change to the change in column</span></div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;<span class="comment">                                !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;<span class="comment">                                !! in the temperatures of all the layers above [Z degC-1 ~&gt; m degC-1].</span></div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dColHt_a<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dS) relating</span></div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;<span class="comment">                                !! a layer&#39;s salinity change to the change in column</span></div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;<span class="comment">                                !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;<span class="comment">                                !! in the salinities of all the layers above [Z ppt-1 ~&gt; m ppt-1].</span></div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dColHt_b<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dT) relating</span></div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;<span class="comment">                                !! a layer&#39;s temperature change to the change in column</span></div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;<span class="comment">                                !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;<span class="comment">                                !! in the temperatures of all the layers below [Z degC-1 ~&gt; m degC-1].</span></div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dColHt_b<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dS) relating</span></div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;<span class="comment">                                !! a layer&#39;s salinity change to the change in column</span></div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;<span class="comment">                                !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;<span class="comment">                                !! in the salinities of all the layers below [Z ppt-1 ~&gt; m ppt-1].</span></div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160; </div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: PE_chg<span class="comment">   !&lt; The change in column potential energy from applying</span></div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;<span class="comment">                                          !! Kddt_h at the present interface [J m-2].</span></div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: dPEc_dKd<span class="comment"> !&lt; The partial derivative of PE_chg with Kddt_h</span></div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;<span class="comment">                                          !! [J m-2 H-1 ~&gt; J m-3 or J kg-1].</span></div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: dPE_max<span class="comment">  !&lt; The maximum change in column potential energy that could</span></div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;<span class="comment">                                          !! be realizedd by applying a huge value of Kddt_h at the</span></div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;<span class="comment">                                          !! present interface [J m-2].</span></div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: dPEc_dKd_0<span class="comment"> !&lt; The partial derivative of PE_chg with Kddt_h in the</span></div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;<span class="comment">                                            !! limit where Kddt_h = 0 [J m-2 H-1 ~&gt; J m-3 or J kg-1].</span></div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: ColHt_cor<span class="comment">  !&lt; The correction to PE_chg that is made due to a net</span></div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;<span class="comment">                                            !! change in the column height [J m-2].</span></div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160; </div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;<span class="keywordtype">  real</span> :: hps <span class="comment">! The sum of the two effective pivot thicknesses [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;<span class="keywordtype">  real</span> :: bdt1 <span class="comment">! A product of the two pivot thicknesses plus a diffusive term [H2 ~&gt; m2 or kg2 m-4].</span></div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;<span class="keywordtype">  real</span> :: dT_c <span class="comment">! The core term in the expressions for the temperature changes [degC H2 ~&gt; degC m2 or degC kg2 m-4].</span></div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;<span class="keywordtype">  real</span> :: dS_c <span class="comment">! The core term in the expressions for the salinity changes [ppt H2 ~&gt; ppt m2 or ppt kg2 m-4].</span></div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;<span class="keywordtype">  real</span> :: PEc_core <span class="comment">! The diffusivity-independent core term in the expressions</span></div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;                   <span class="comment">! for the potential energy changes [J m-3].</span></div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;<span class="keywordtype">  real</span> :: ColHt_core <span class="comment">! The diffusivity-independent core term in the expressions</span></div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;                     <span class="comment">! for the column height changes [J m-3].</span></div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;<span class="keywordtype">  real</span> :: ColHt_chg  <span class="comment">! The change in the column height [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;<span class="keywordtype">  real</span> :: y1   <span class="comment">! A local temporary term, [H-3 ~&gt; m-3 or m6 kg-3] or [H-4 ~&gt; m-4 or m8 kg-4] in various contexts.</span></div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160; </div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;  <span class="comment">!   The expression for the change in potential energy used here is derived</span></div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;  <span class="comment">! from the expression for the final estimates of the changes in temperature</span></div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;  <span class="comment">! and salinities, and then extensively manipulated to get it into its most</span></div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;  <span class="comment">! succint form. The derivation is not necessarily obvious, but it demonstrably</span></div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;  <span class="comment">! works by comparison with separate calculations of the energy changes after</span></div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;  <span class="comment">! the tridiagonal solver for the final changes in temperature and salinity are</span></div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;  <span class="comment">! applied.</span></div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160; </div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;  hps = hp_a + hp_b</div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;  bdt1 = hp_a * hp_b + kddt_h0 * hps</div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;  dt_c = hp_a * th_b - hp_b * th_a</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;  ds_c = hp_a * sh_b - hp_b * sh_a</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;  pec_core = hp_b * (dt_to_dpe_a * dt_c + ds_to_dpe_a * ds_c) - &amp;</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;             hp_a * (dt_to_dpe_b * dt_c + ds_to_dpe_b * ds_c)</div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;  colht_core = hp_b * (dt_to_dcolht_a * dt_c + ds_to_dcolht_a * ds_c) - &amp;</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;               hp_a * (dt_to_dcolht_b * dt_c + ds_to_dcolht_b * ds_c)</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160; </div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(pe_chg)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;    <span class="comment">! Find the change in column potential energy due to the change in the</span></div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;    <span class="comment">! diffusivity at this interface by dKddt_h.</span></div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;    y1 = dkddt_h / (bdt1 * (bdt1 + dkddt_h * hps))</div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;    pe_chg = pec_core * y1</div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;    colht_chg = colht_core * y1</div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;    <span class="keywordflow">if</span> (colht_chg &lt; 0.0) pe_chg = pe_chg - pres_z * colht_chg</div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(colht_cor)) colht_cor = -pres_z * min(colht_chg, 0.0)</div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;  <span class="keywordflow">elseif</span> (<span class="keyword">present</span>(colht_cor)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;    y1 = dkddt_h / (bdt1 * (bdt1 + dkddt_h * hps))</div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;    colht_cor = -pres_z * min(colht_core * y1, 0.0)</div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160; </div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dpec_dkd)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;    <span class="comment">! Find the derivative of the potential energy change with dKddt_h.</span></div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;    y1 = 1.0 / (bdt1 + dkddt_h * hps)**2</div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;    dpec_dkd = pec_core * y1</div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;    colht_chg = colht_core * y1</div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;    <span class="keywordflow">if</span> (colht_chg &lt; 0.0) dpec_dkd = dpec_dkd - pres_z * colht_chg</div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160; </div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dpe_max)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;    <span class="comment">! This expression is the limit of PE_chg for infinite dKddt_h.</span></div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;    y1 = 1.0 / (bdt1 * hps)</div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;    dpe_max = pec_core * y1</div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;    colht_chg = colht_core * y1</div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;    <span class="keywordflow">if</span> (colht_chg &lt; 0.0) dpe_max = dpe_max - pres_z * colht_chg</div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160; </div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dpec_dkd_0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;    <span class="comment">! This expression is the limit of dPEc_dKd for dKddt_h = 0.</span></div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;    y1 = 1.0 / bdt1**2</div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;    dpec_dkd_0 = pec_core * y1</div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;    colht_chg = colht_core * y1</div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;    <span class="keywordflow">if</span> (colht_chg &lt; 0.0) dpec_dkd_0 = dpec_dkd_0 - pres_z * colht_chg</div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00216">energetic_pbl()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_ab0d988822a378f674d3b7e0ee2534c74_icgraph.svg" width="360" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a3eb660658d0677c55c6187dcf4a180b5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3eb660658d0677c55c6187dcf4a180b5">&#9670;&nbsp;</a></span>find_pe_chg_orig()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_energetic_pbl::find_pe_chg_orig </td>
          <td>(</td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Kddt_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>h_k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>b_den_1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dTe_term</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dSe_term</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_km1_t2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_km1_t2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dPE_k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dPE_k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dPEa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dPEa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>pres_Z</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dColHt_k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dColHt_k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dColHta</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dColHta</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>PE_chg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>dPEc_dKd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>dPE_max</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>dPEc_dKd_0</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine calculates the change in potential energy and or derivatives for several changes in an interfaces's diapycnal diffusivity times a timestep using the original form used in the first version of ePBL. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">kddt_h</td><td>The diffusivity at an interface times the time step and divided by the average of the thicknesses around the interface [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h_k</td><td>The thickness of the layer below the interface [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">b_den_1</td><td>The first term in the denominator of the pivot for the tridiagonal solver, given by h_k plus a term that is a fraction (determined from the tridiagonal solver) of Kddt_h for the interface above [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dte_term</td><td>A diffusivity-independent term related to the temperature change in the layer below the interface [degC H ~&gt; degC m or degC kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dse_term</td><td>A diffusivity-independent term related to the salinity change in the layer below the interface [ppt H ~&gt; ppt m or ppt kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_km1_t2</td><td>A diffusivity-independent term related to the temperature change in the layer above the interface [degC]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_km1_t2</td><td>A diffusivity-independent term related to the salinity change in the layer above the interface [ppt]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">pres_z</td><td>The rescaled hydrostatic interface pressure, which relates the changes in column thickness to the energy that is radiated as gravity waves and unavailable to drive mixing [J m-2 Z-1 ~&gt; J m-3]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dpe_k</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dT) relating a layer's temperature change to the change in column potential energy, including all implicit diffusive changes in the temperatures of all the layers below [J m-2 degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dpe_k</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dS) relating a layer's salinity change to the change in column potential energy, including all implicit diffusive changes in the salinities of all the layers below [J m-2 ppt-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dpea</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dT) relating a layer's temperature change to the change in column potential energy, including all implicit diffusive changes in the temperatures of all the layers above [J m-2 degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dpea</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dS) relating a layer's salinity change to the change in column potential energy, including all implicit diffusive changes in the salinities of all the layers above [J m-2 ppt-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dcolht_k</td><td>A factor (mass_lay*dSColHtc_vol/dT) relating a layer's temperature change to the change in column height, including all implicit diffusive changes in the temperatures of all the layers below [Z degC-1 ~&gt; m degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dcolht_k</td><td>A factor (mass_lay*dSColHtc_vol/dS) relating a layer's salinity change to the change in column height, including all implicit diffusive changes in the salinities of all the layers below [Z ppt-1 ~&gt; m ppt-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dcolhta</td><td>A factor (mass_lay*dSColHtc_vol/dT) relating a layer's temperature change to the change in column height, including all implicit diffusive changes in the temperatures of all the layers above [Z degC-1 ~&gt; m degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dcolhta</td><td>A factor (mass_lay*dSColHtc_vol/dS) relating a layer's salinity change to the change in column height, including all implicit diffusive changes in the salinities of all the layers above [Z ppt-1 ~&gt; m ppt-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">pe_chg</td><td>The change in column potential energy from applying Kddt_h at the present interface [J m-2]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dpec_dkd</td><td>The partial derivative of PE_chg with Kddt_h [J m-2 H-1 ~&gt; J m-3 or J kg-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dpe_max</td><td>The maximum change in column potential energy that could be realizedd by applying a huge value of Kddt_h at the present interface [J m-2]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dpec_dkd_0</td><td>The partial derivative of PE_chg with Kddt_h in the limit where Kddt_h = 0 [J m-2 H-1 ~&gt; J m-3 or J kg-1]. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01772">1772</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: Kddt_h<span class="comment">   !&lt; The diffusivity at an interface times the time step and</span></div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;<span class="comment">                                !! divided by the average of the thicknesses around the</span></div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;<span class="comment">                                !! interface [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: h_k<span class="comment">      !&lt; The thickness of the layer below the interface [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: b_den_1<span class="comment">  !&lt; The first term in the denominator of the pivot</span></div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;<span class="comment">                                !! for the tridiagonal solver, given by h_k plus a term that</span></div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;<span class="comment">                                !! is a fraction (determined from the tridiagonal solver) of</span></div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;<span class="comment">                                !! Kddt_h for the interface above [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dTe_term<span class="comment"> !&lt; A diffusivity-independent term related to the temperature change</span></div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;<span class="comment">                                !! in the layer below the interface [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dSe_term<span class="comment"> !&lt; A diffusivity-independent term related to the salinity change</span></div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;<span class="comment">                                !! in the layer below the interface [ppt H ~&gt; ppt m or ppt kg m-2].</span></div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_km1_t2<span class="comment"> !&lt; A diffusivity-independent term related to the</span></div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;<span class="comment">                                 !! temperature change in the layer above the interface [degC].</span></div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_km1_t2<span class="comment"> !&lt; A diffusivity-independent term related to the</span></div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;<span class="comment">                                 !! salinity change in the layer above the interface [ppt].</span></div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: pres_Z<span class="comment">    !&lt; The rescaled hydrostatic interface pressure, which relates</span></div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;<span class="comment">                                 !! the changes in column thickness to the energy that is radiated</span></div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;<span class="comment">                                 !! as gravity waves and unavailable to drive mixing [J m-2 Z-1 ~&gt; J m-3].</span></div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dPE_k<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dT) relating</span></div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;<span class="comment">                                 !! a layer&#39;s temperature change to the change in column</span></div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;<span class="comment">                                 !! potential energy, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;<span class="comment">                                 !! in the temperatures of all the layers below [J m-2 degC-1].</span></div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dPE_k<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dS) relating</span></div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;<span class="comment">                                 !! a layer&#39;s salinity change to the change in column</span></div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;<span class="comment">                                 !! potential energy, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;<span class="comment">                                 !! in the salinities of all the layers below [J m-2 ppt-1].</span></div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dPEa<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dT) relating</span></div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;<span class="comment">                                 !! a layer&#39;s temperature change to the change in column</span></div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;<span class="comment">                                 !! potential energy, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;<span class="comment">                                 !! in the temperatures of all the layers above [J m-2 degC-1].</span></div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dPEa<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dS) relating</span></div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;<span class="comment">                                 !! a layer&#39;s salinity change to the change in column</span></div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;<span class="comment">                                 !! potential energy, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;<span class="comment">                                 !! in the salinities of all the layers above [J m-2 ppt-1].</span></div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dColHt_k<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dT) relating</span></div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;<span class="comment">                                 !! a layer&#39;s temperature change to the change in column</span></div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;<span class="comment">                                 !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;<span class="comment">                                 !! in the temperatures of all the layers below [Z degC-1 ~&gt; m degC-1].</span></div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dColHt_k<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dS) relating</span></div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;<span class="comment">                                 !! a layer&#39;s salinity change to the change in column</span></div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;<span class="comment">                                 !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;<span class="comment">                                 !! in the salinities of all the layers below [Z ppt-1 ~&gt; m ppt-1].</span></div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dColHta<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dT) relating</span></div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;<span class="comment">                                 !! a layer&#39;s temperature change to the change in column</span></div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;<span class="comment">                                 !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;<span class="comment">                                 !! in the temperatures of all the layers above [Z degC-1 ~&gt; m degC-1].</span></div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dColHta<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dS) relating</span></div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;<span class="comment">                                 !! a layer&#39;s salinity change to the change in column</span></div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;<span class="comment">                                 !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;<span class="comment">                                 !! in the salinities of all the layers above [Z ppt-1 ~&gt; m ppt-1].</span></div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160; </div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: PE_chg<span class="comment">   !&lt; The change in column potential energy from applying</span></div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;<span class="comment">                                          !! Kddt_h at the present interface [J m-2].</span></div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: dPEc_dKd<span class="comment"> !&lt; The partial derivative of PE_chg with Kddt_h</span></div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;<span class="comment">                                          !! [J m-2 H-1 ~&gt; J m-3 or J kg-1].</span></div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: dPE_max<span class="comment">  !&lt; The maximum change in column potential energy that could</span></div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;<span class="comment">                                          !! be realizedd by applying a huge value of Kddt_h at the</span></div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;<span class="comment">                                          !! present interface [J m-2].</span></div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: dPEc_dKd_0<span class="comment"> !&lt; The partial derivative of PE_chg with Kddt_h in the</span></div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;<span class="comment">                                            !! limit where Kddt_h = 0 [J m-2 H-1 ~&gt; J m-3 or J kg-1].</span></div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160; </div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;<span class="comment">!   This subroutine determines the total potential energy change due to mixing</span></div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;<span class="comment">! at an interface, including all of the implicit effects of the prescribed</span></div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;<span class="comment">! mixing at interfaces above.  Everything here is derived by careful manipulation</span></div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;<span class="comment">! of the robust tridiagonal solvers used for tracers by MOM6.  The results are</span></div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;<span class="comment">! positive for mixing in a stably stratified environment.</span></div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;<span class="comment">!   The comments describing these arguments are for a downward mixing pass, but</span></div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;<span class="comment">! this routine can also be used for an upward pass with the sense of direction</span></div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;<span class="comment">! reversed.</span></div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160; </div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;<span class="keywordtype">  real</span> :: b1            <span class="comment">! b1 is used by the tridiagonal solver [H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;<span class="keywordtype">  real</span> :: b1Kd          <span class="comment">! Temporary array [nondim]</span></div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;<span class="keywordtype">  real</span> :: ColHt_chg     <span class="comment">! The change in column thickness [Z ~&gt; m].</span></div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;<span class="keywordtype">  real</span> :: dColHt_max    <span class="comment">! The change in column thickness for infinite diffusivity [Z ~&gt; m].</span></div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;<span class="keywordtype">  real</span> :: dColHt_dKd    <span class="comment">! The partial derivative of column thickness with diffusivity [s Z-1 ~&gt; s m-1].</span></div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;<span class="keywordtype">  real</span> :: dT_k, dT_km1  <span class="comment">! Temporary arrays [degC].</span></div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;<span class="keywordtype">  real</span> :: dS_k, dS_km1  <span class="comment">! Temporary arrays [ppt].</span></div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;<span class="keywordtype">  real</span> :: I_Kr_denom    <span class="comment">! Temporary array [H-2 ~&gt; m-2 or m4 kg-2]</span></div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;<span class="keywordtype">  real</span> :: dKr_dKd       <span class="comment">! Nondimensional temporary array.</span></div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;<span class="keywordtype">  real</span> :: ddT_k_dKd, ddT_km1_dKd <span class="comment">! Temporary arrays [degC H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;<span class="keywordtype">  real</span> :: ddS_k_dKd, ddS_km1_dKd <span class="comment">! Temporary arrays [ppt H-1 ~&gt; ppt m-1 or ppt m2 kg-1].</span></div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160; </div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;  b1 = 1.0 / (b_den_1 + kddt_h)</div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;  b1kd = kddt_h*b1</div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160; </div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;  <span class="comment">! Start with the temperature change in layer k-1 due to the diffusivity at</span></div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;  <span class="comment">! interface K without considering the effects of changes in layer k.</span></div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160; </div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;  <span class="comment">! Calculate the change in PE due to the diffusion at interface K</span></div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;  <span class="comment">! if Kddt_h(K+1) = 0.</span></div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;  i_kr_denom = 1.0 / (h_k*b_den_1 + (b_den_1 + h_k)*kddt_h)</div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160; </div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;  dt_k = (kddt_h*i_kr_denom) * dte_term</div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;  ds_k = (kddt_h*i_kr_denom) * dse_term</div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160; </div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(pe_chg)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;    <span class="comment">! Find the change in energy due to diffusion with strength Kddt_h at this interface.</span></div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;    <span class="comment">! Increment the temperature changes in layer k-1 due the changes in layer k.</span></div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;    dt_km1 = b1kd * ( dt_k + dt_km1_t2 )</div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;    ds_km1 = b1kd * ( ds_k + ds_km1_t2 )</div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;    pe_chg = (dt_to_dpe_k * dt_k + dt_to_dpea * dt_km1) + &amp;</div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;             (ds_to_dpe_k * ds_k + ds_to_dpea * ds_km1)</div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;    colht_chg = (dt_to_dcolht_k * dt_k + dt_to_dcolhta * dt_km1) + &amp;</div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;                (ds_to_dcolht_k * ds_k + ds_to_dcolhta * ds_km1)</div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;    <span class="keywordflow">if</span> (colht_chg &lt; 0.0) pe_chg = pe_chg - pres_z * colht_chg</div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160; </div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dpec_dkd)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;    <span class="comment">! Find the derivatives of the temperature and salinity changes with Kddt_h.</span></div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;    dkr_dkd = (h_k*b_den_1) * i_kr_denom**2</div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160; </div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;    ddt_k_dkd = dkr_dkd * dte_term</div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;    dds_k_dkd = dkr_dkd * dse_term</div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;    ddt_km1_dkd = (b1**2 * b_den_1) * ( dt_k + dt_km1_t2 ) + b1kd * ddt_k_dkd</div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;    dds_km1_dkd = (b1**2 * b_den_1) * ( ds_k + ds_km1_t2 ) + b1kd * dds_k_dkd</div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160; </div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;    <span class="comment">! Calculate the partial derivative of Pe_chg with Kddt_h.</span></div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;    dpec_dkd = (dt_to_dpe_k * ddt_k_dkd + dt_to_dpea * ddt_km1_dkd) + &amp;</div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;               (ds_to_dpe_k * dds_k_dkd + ds_to_dpea * dds_km1_dkd)</div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;    dcolht_dkd = (dt_to_dcolht_k * ddt_k_dkd + dt_to_dcolhta * ddt_km1_dkd) + &amp;</div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;                 (ds_to_dcolht_k * dds_k_dkd + ds_to_dcolhta * dds_km1_dkd)</div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;    <span class="keywordflow">if</span> (dcolht_dkd &lt; 0.0) dpec_dkd = dpec_dkd - pres_z * dcolht_dkd</div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160; </div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dpe_max)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;    <span class="comment">! This expression is the limit of PE_chg for infinite Kddt_h.</span></div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;    dpe_max = (dt_to_dpea * dt_km1_t2 + ds_to_dpea * ds_km1_t2) + &amp;</div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;              ((dt_to_dpe_k + dt_to_dpea) * dte_term + &amp;</div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;               (ds_to_dpe_k + ds_to_dpea) * dse_term) / (b_den_1 + h_k)</div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;    dcolht_max = (dt_to_dcolhta * dt_km1_t2 + ds_to_dcolhta * ds_km1_t2) + &amp;</div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;              ((dt_to_dcolht_k + dt_to_dcolhta) * dte_term + &amp;</div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;               (ds_to_dcolht_k + ds_to_dcolhta) * dse_term) / (b_den_1 + h_k)</div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;    <span class="keywordflow">if</span> (dcolht_max &lt; 0.0) dpe_max = dpe_max - pres_z*dcolht_max</div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160; </div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dpec_dkd_0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;    <span class="comment">! This expression is the limit of dPEc_dKd for Kddt_h = 0.</span></div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;    dpec_dkd_0 = (dt_to_dpea * dt_km1_t2 + ds_to_dpea * ds_km1_t2) / (b_den_1) + &amp;</div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;                 (dt_to_dpe_k * dte_term + ds_to_dpe_k * dse_term) / (h_k*b_den_1)</div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;    dcolht_dkd = (dt_to_dcolhta * dt_km1_t2 + ds_to_dcolhta * ds_km1_t2) / (b_den_1) + &amp;</div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;                 (dt_to_dcolht_k * dte_term + ds_to_dcolht_k * dse_term) / (h_k*b_den_1)</div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;    <span class="keywordflow">if</span> (dcolht_dkd &lt; 0.0) dpec_dkd_0 = dpec_dkd_0 - pres_z*dcolht_dkd</div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00216">energetic_pbl()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_a3eb660658d0677c55c6187dcf4a180b5_icgraph.svg" width="360" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a66dc4ecc7712c6f0307ca211c97fa5ef"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a66dc4ecc7712c6f0307ca211c97fa5ef">&#9670;&nbsp;</a></span>get_la_windsea()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_energetic_pbl::get_la_windsea </td>
          <td>(</td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>ustar</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>hbl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out)&#160;</td>
          <td class="paramname"><em>LA</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine returns the Langmuir number, given ustar and the boundary layer thickness, inclusion conversion to the 10m wind. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">ustar</td><td>The water-side surface friction velocity [m s-1] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">hbl</td><td>The ocean boundary layer depth [m] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">la</td><td>The Langmuir number returned from this module </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01986">1986</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>  :: ustar<span class="comment"> !&lt; The water-side surface friction velocity [m s-1]</span></div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>  :: hbl<span class="comment">   !&lt; The ocean boundary layer depth [m]</span></div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>  :: GV<span class="comment">    !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>  :: US<span class="comment">    !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(out)</span> :: LA<span class="comment">    !&lt; The Langmuir number returned from this module</span></div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;<span class="comment">! Original description:</span></div>
<div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;<span class="comment">! This function returns the enhancement factor, given the 10-meter</span></div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;<span class="comment">! wind [m s-1], friction velocity [m s-1] and the boundary layer depth [m].</span></div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;<span class="comment">! Update (Jan/25):</span></div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;<span class="comment">! Converted from function to subroutine, now returns Langmuir number.</span></div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;<span class="comment">! Computes 10m wind internally, so only ustar and hbl need passed to</span></div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;<span class="comment">! subroutine.</span></div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;<span class="comment">! Qing Li, 160606</span></div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;<span class="comment">! BGR port from CVMix to MOM6 Jan/25/2017</span></div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;<span class="comment">! BGR change output to LA from Efactor</span></div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;<span class="comment">! BGR remove u10 input</span></div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160; </div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;<span class="comment">! Input</span></div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;<span class="comment">! Local variables</span></div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;  <span class="comment">! parameters</span></div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: &amp;</div>
<div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;       <span class="comment">! ratio of U19.5 to U10 (Holthuijsen, 2007)</span></div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;       u19p5_to_u10 = 1.075, &amp;</div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;       <span class="comment">! ratio of mean frequency to peak frequency for</span></div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;       <span class="comment">! Pierson-Moskowitz spectrum (Webb, 2011)</span></div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;       fm_to_fp = 1.296, &amp;</div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;       <span class="comment">! ratio of surface Stokes drift to U10</span></div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;       us_to_u10 = 0.0162, &amp;</div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;       <span class="comment">! loss ratio of Stokes transport</span></div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;       r_loss = 0.667</div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;<span class="keywordtype">  real</span> :: uStokes, hm0, fm, fp, vstokes, kphil, kstar</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;<span class="keywordtype">  real</span> :: z0, z0i, r1, r2, r3, r4, tmp, us_sl, lasl_sqr_i</div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;<span class="keywordtype">  real</span> :: pi, u10</div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;  pi = 4.0*atan(1.0)</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;  <span class="keywordflow">if</span> (ustar &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;    <span class="comment">! Computing u10 based on ustar and COARE 3.5 relationships</span></div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;    <span class="keyword">call </span>ust_2_u10_coare3p5(ustar * sqrt(gv%Rho0/1.225), u10, gv, us)</div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;    <span class="comment">! surface Stokes drift</span></div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;    ustokes = us_to_u10*u10</div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160; </div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;    <span class="comment">! significant wave height from Pierson-Moskowitz spectrum (Bouws, 1998)</span></div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;    hm0 = 0.0246 *u10**2</div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160; </div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;    <span class="comment">! peak frequency (PM, Bouws, 1998)</span></div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;    tmp = 2.0 * pi * u19p5_to_u10 * u10</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;    fp = 0.877 * (gv%g_Earth*us%m_to_Z) / tmp</div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160; </div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;    <span class="comment">! mean frequency</span></div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;    fm = fm_to_fp * fp</div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160; </div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;    <span class="comment">! total Stokes transport (a factor r_loss is applied to account</span></div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;    <span class="comment">!  for the effect of directional spreading, multidirectional waves</span></div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;    <span class="comment">!  and the use of PM peak frequency and PM significant wave height</span></div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;    <span class="comment">!  on estimating the Stokes transport)</span></div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;    vstokes = 0.125 * pi * r_loss * fm * hm0**2</div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;    <span class="comment">!</span></div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;    <span class="comment">! the general peak wavenumber for Phillips&#39; spectrum</span></div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;    <span class="comment">! (Breivik et al., 2016) with correction of directional spreading</span></div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;    kphil = 0.176 * ustokes / vstokes</div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;    <span class="comment">!</span></div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;    <span class="comment">! surface layer averaged Stokes dirft with Stokes drift profile</span></div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;    <span class="comment">! estimated from Phillips&#39; spectrum (Breivik et al., 2016)</span></div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;    <span class="comment">! the directional spreading effect from Webb and Fox-Kemper, 2015</span></div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;    <span class="comment">! is also included</span></div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;    kstar = kphil * 2.56</div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;    <span class="comment">! surface layer</span></div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;    <span class="comment">!z0 = 0.2 * abs(hbl)</span></div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;    <span class="comment">!BGR hbl now adjusted by averaging ratio before function call.</span></div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;    z0 = abs(hbl)</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;    z0i = 1.0 / z0</div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;    <span class="comment">! term 1 to 4</span></div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;    r1 = ( 0.151 / kphil * z0i -0.84 ) &amp;</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;         * ( 1.0 - exp(-2.0 * kphil * z0) )</div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;    r2 = -( 0.84 + 0.0591 / kphil * z0i ) &amp;</div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;         *sqrt( 2.0 * pi * kphil * z0 ) &amp;</div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;         *erfc( sqrt( 2.0 * kphil * z0 ) )</div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;    r3 = ( 0.0632 / kstar * z0i + 0.125 ) &amp;</div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;         * (1.0 - exp(-2.0 * kstar * z0) )</div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;    r4 = ( 0.125 + 0.0946 / kstar * z0i ) &amp;</div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;         *sqrt( 2.0 * pi *kstar * z0) &amp;</div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;         *erfc( sqrt( 2.0 * kstar * z0 ) )</div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;    us_sl = ustokes * (0.715 + r1 + r2 + r3 + r4)</div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;    <span class="comment">!</span></div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;    la = sqrt(ustar / us_sl)</div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;    la=1.e8</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;<span class="keywordflow">  endif</span></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01940">ust_2_u10_coare3p5()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_a66dc4ecc7712c6f0307ca211c97fa5ef_cgraph.svg" width="364" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="aec70079fb3f2e322625532017cdd0cc6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aec70079fb3f2e322625532017cdd0cc6">&#9670;&nbsp;</a></span>ust_2_u10_coare3p5()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_energetic_pbl::ust_2_u10_coare3p5 </td>
          <td>(</td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>USTair</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out)&#160;</td>
          <td class="paramname"><em>U10</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Computes wind speed from ustar_air based on COARE 3.5 Cd relationship. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">ustair</td><td>Ustar in the air [m s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">u10</td><td>The 10 m wind speed [m s-1]. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01940">1940</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>  :: USTair<span class="comment"> !&lt; Ustar in the air [m s-1].</span></div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>  :: GV<span class="comment">     !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>  :: US<span class="comment">     !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(out)</span> :: U10<span class="comment">    !&lt; The 10 m wind speed [m s-1].</span></div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160; </div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: vonkar = 0.4</div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: nu=1e-6</div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;<span class="keywordtype">  real</span> :: z0sm, z0, z0rough, u10a, alpha, CD</div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;  <span class="keywordtype">integer</span> :: CT</div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160; </div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;  <span class="comment">! Uses empirical formula for z0 to convert ustar_air to u10 based on the</span></div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;  <span class="comment">!  COARE 3.5 paper (Edson et al., 2013)</span></div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;  <span class="comment">!alpha=m*U10+b</span></div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;  <span class="comment">!Note in Edson et al. 2013, eq. 13 m is given as 0.017.  However,</span></div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;  <span class="comment">! m=0.0017 reproduces the curve in their figure 6.</span></div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160; </div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;  z0sm = 0.11 * nu / ustair; <span class="comment">!Compute z0smooth from ustar guess</span></div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;  u10 = ustair/sqrt(0.001);  <span class="comment">!Guess for u10</span></div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;  u10a = 1000</div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160; </div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;  ct=0</div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;  <span class="keywordflow">do</span> <span class="keywordflow">while</span> (abs(u10a/u10-1.)&gt;0.001)</div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;    ct=ct+1</div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;    u10a = u10</div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;    alpha = min(0.028,0.0017 * u10 - 0.005)</div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;    z0rough = alpha * ustair**2/(gv%g_Earth*us%m_to_Z) <span class="comment">! Compute z0rough from ustar guess</span></div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;    z0=z0sm+z0rough</div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;    cd = ( vonkar / log(10/z0) )**2 <span class="comment">! Compute CD from derived roughness</span></div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;    u10 = ustair/sqrt(cd);<span class="comment">!Compute new u10 from derived CD, while loop</span></div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;                       <span class="comment">! ends and checks for convergence...CT counter</span></div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;                       <span class="comment">! makes sure loop doesn&#39;t run away if function</span></div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;                       <span class="comment">! doesn&#39;t converge.  This code was produced offline</span></div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;                       <span class="comment">! and converged rapidly (e.g. 2 cycles)</span></div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;                       <span class="comment">! for ustar=0.0001:0.0001:10.</span></div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;    <span class="keywordflow">if</span> (ct&gt;20) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;      u10 = ustair/sqrt(0.0015) <span class="comment">! I don&#39;t expect to get here, but just</span></div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;                              <span class="comment">!  in case it will output a reasonable value.</span></div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;      <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;  <span class="keywordflow">return</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01986">get_la_windsea()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_aec70079fb3f2e322625532017cdd0cc6_icgraph.svg" width="364" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__energetic__pbl.html">mom_energetic_pbl</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
