<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_energetic_pbl Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('namespacemom__energetic__pbl.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a>  </div>
  <div class="headertitle">
<div class="title">mom_energetic_pbl Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Energetically consistent planetary boundary layer parameterization. </p>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__energetic__pbl_1_1energetic__pbl__cs.html">energetic_pbl_cs</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">This control structure holds parameters for the <a class="el" href="namespaceMOM__energetic__PBL.html">MOM_energetic_PBL</a> module.  <a href="structmom__energetic__pbl_1_1energetic__pbl__cs.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__energetic__pbl_1_1epbl__column__diags.html">epbl_column_diags</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">A type for conveniently passing around ePBL diagnostics for a column.  <a href="structmom__energetic__pbl_1_1epbl__column__diags.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a62611ee2449d47b4ac347ecc5815c927"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a62611ee2449d47b4ac347ecc5815c927">use_fixed_mstar</a> = 0</td></tr>
<tr class="memdesc:a62611ee2449d47b4ac347ecc5815c927"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enumeration values for mstar_Scheme.  <a href="namespacemom__energetic__pbl.html#a62611ee2449d47b4ac347ecc5815c927">More...</a><br /></td></tr>
<tr class="separator:a62611ee2449d47b4ac347ecc5815c927"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2f6f5a6f3b88370f8956a16805ff8d93"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a2f6f5a6f3b88370f8956a16805ff8d93">mstar_from_ekman</a> = 2</td></tr>
<tr class="memdesc:a2f6f5a6f3b88370f8956a16805ff8d93"><td class="mdescLeft">&#160;</td><td class="mdescRight">The value of mstar_scheme to base mstar on the ratio of the Ekman layer depth to the Obukhov depth.  <a href="namespacemom__energetic__pbl.html#a2f6f5a6f3b88370f8956a16805ff8d93">More...</a><br /></td></tr>
<tr class="separator:a2f6f5a6f3b88370f8956a16805ff8d93"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5504d7a4935753ac24c43f35a729052e"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a5504d7a4935753ac24c43f35a729052e">mstar_from_rh18</a> = 3</td></tr>
<tr class="memdesc:a5504d7a4935753ac24c43f35a729052e"><td class="mdescLeft">&#160;</td><td class="mdescRight">The value of mstar_scheme to base mstar of of RH18.  <a href="namespacemom__energetic__pbl.html#a5504d7a4935753ac24c43f35a729052e">More...</a><br /></td></tr>
<tr class="separator:a5504d7a4935753ac24c43f35a729052e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a408fc314121efffe70ff08b56b920343"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a408fc314121efffe70ff08b56b920343">no_langmuir</a> = 0</td></tr>
<tr class="memdesc:a408fc314121efffe70ff08b56b920343"><td class="mdescLeft">&#160;</td><td class="mdescRight">The value of LT_ENHANCE_FORM not use Langmuir turbolence.  <a href="namespacemom__energetic__pbl.html#a408fc314121efffe70ff08b56b920343">More...</a><br /></td></tr>
<tr class="separator:a408fc314121efffe70ff08b56b920343"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af8dec1f8eeb76a7638d11acc279f9bbd"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#af8dec1f8eeb76a7638d11acc279f9bbd">langmuir_rescale</a> = 2</td></tr>
<tr class="memdesc:af8dec1f8eeb76a7638d11acc279f9bbd"><td class="mdescLeft">&#160;</td><td class="mdescRight">The value of LT_ENHANCE_FORM to use a multiplicative rescaling of mstar to account for Langmuir turbulence.  <a href="namespacemom__energetic__pbl.html#af8dec1f8eeb76a7638d11acc279f9bbd">More...</a><br /></td></tr>
<tr class="separator:af8dec1f8eeb76a7638d11acc279f9bbd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a502b7fb02ebdec866caed1508a103c1d"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a502b7fb02ebdec866caed1508a103c1d">langmuir_add</a> = 3</td></tr>
<tr class="memdesc:a502b7fb02ebdec866caed1508a103c1d"><td class="mdescLeft">&#160;</td><td class="mdescRight">The value of LT_ENHANCE_FORM to add a contribution to mstar from Langmuir turblence to other contributions.  <a href="namespacemom__energetic__pbl.html#a502b7fb02ebdec866caed1508a103c1d">More...</a><br /></td></tr>
<tr class="separator:a502b7fb02ebdec866caed1508a103c1d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a148db2e43fc3bb4cc1f266ec7391a7dd"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a148db2e43fc3bb4cc1f266ec7391a7dd">wt_from_croot_tke</a> = 0</td></tr>
<tr class="memdesc:a148db2e43fc3bb4cc1f266ec7391a7dd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Use a constant times the cube root of remaining TKE to calculate the turbulent velocity.  <a href="namespacemom__energetic__pbl.html#a148db2e43fc3bb4cc1f266ec7391a7dd">More...</a><br /></td></tr>
<tr class="separator:a148db2e43fc3bb4cc1f266ec7391a7dd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0dc2252a2315d8d99000f9b003b24b00"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a0dc2252a2315d8d99000f9b003b24b00">wt_from_rh18</a> = 1</td></tr>
<tr class="memdesc:a0dc2252a2315d8d99000f9b003b24b00"><td class="mdescLeft">&#160;</td><td class="mdescRight">Use a scheme based on a combination of w* and v* as documented in Reichl &amp; Hallberg (2018) to calculate the turbulent velocity.  <a href="namespacemom__energetic__pbl.html#a0dc2252a2315d8d99000f9b003b24b00">More...</a><br /></td></tr>
<tr class="separator:a0dc2252a2315d8d99000f9b003b24b00"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1242b6400e7d01529a3d19b85e0d5b5b"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(20), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a1242b6400e7d01529a3d19b85e0d5b5b">constant_string</a> = &quot;CONSTANT&quot;</td></tr>
<tr class="memdesc:a1242b6400e7d01529a3d19b85e0d5b5b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enumeration values for mstar_Scheme.  <a href="namespacemom__energetic__pbl.html#a1242b6400e7d01529a3d19b85e0d5b5b">More...</a><br /></td></tr>
<tr class="separator:a1242b6400e7d01529a3d19b85e0d5b5b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a193184bbe6bba5bfcb7b077d620cbfe7"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(20), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a193184bbe6bba5bfcb7b077d620cbfe7">om4_string</a> = &quot;OM4&quot;</td></tr>
<tr class="memdesc:a193184bbe6bba5bfcb7b077d620cbfe7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enumeration values for mstar_Scheme.  <a href="namespacemom__energetic__pbl.html#a193184bbe6bba5bfcb7b077d620cbfe7">More...</a><br /></td></tr>
<tr class="separator:a193184bbe6bba5bfcb7b077d620cbfe7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6fc8bff404f05376f1f3b4c90cb169a0"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(20), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a6fc8bff404f05376f1f3b4c90cb169a0">rh18_string</a> = &quot;REICHL_H18&quot;</td></tr>
<tr class="memdesc:a6fc8bff404f05376f1f3b4c90cb169a0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enumeration values for mstar_Scheme.  <a href="namespacemom__energetic__pbl.html#a6fc8bff404f05376f1f3b4c90cb169a0">More...</a><br /></td></tr>
<tr class="separator:a6fc8bff404f05376f1f3b4c90cb169a0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6617f3587ab57c34581cd76bd80b9249"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(20), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a6617f3587ab57c34581cd76bd80b9249">root_tke_string</a> = &quot;CUBE_ROOT_TKE&quot;</td></tr>
<tr class="memdesc:a6617f3587ab57c34581cd76bd80b9249"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enumeration values for mstar_Scheme.  <a href="namespacemom__energetic__pbl.html#a6617f3587ab57c34581cd76bd80b9249">More...</a><br /></td></tr>
<tr class="separator:a6617f3587ab57c34581cd76bd80b9249"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4299f4ef5bbeabb5d0ca7e6016546ac4"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(20), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a4299f4ef5bbeabb5d0ca7e6016546ac4">none_string</a> = &quot;NONE&quot;</td></tr>
<tr class="memdesc:a4299f4ef5bbeabb5d0ca7e6016546ac4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enumeration values for mstar_Scheme.  <a href="namespacemom__energetic__pbl.html#a4299f4ef5bbeabb5d0ca7e6016546ac4">More...</a><br /></td></tr>
<tr class="separator:a4299f4ef5bbeabb5d0ca7e6016546ac4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6e1dc5a516a3ea979f425084c1291139"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(20), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a6e1dc5a516a3ea979f425084c1291139">rescaled_string</a> = &quot;RESCALE&quot;</td></tr>
<tr class="memdesc:a6e1dc5a516a3ea979f425084c1291139"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enumeration values for mstar_Scheme.  <a href="namespacemom__energetic__pbl.html#a6e1dc5a516a3ea979f425084c1291139">More...</a><br /></td></tr>
<tr class="separator:a6e1dc5a516a3ea979f425084c1291139"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a54d8529555fee1f2ada7a7107f3c266c"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(20), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a54d8529555fee1f2ada7a7107f3c266c">additive_string</a> = &quot;ADDITIVE&quot;</td></tr>
<tr class="memdesc:a54d8529555fee1f2ada7a7107f3c266c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enumeration values for mstar_Scheme.  <a href="namespacemom__energetic__pbl.html#a54d8529555fee1f2ada7a7107f3c266c">More...</a><br /></td></tr>
<tr class="separator:a54d8529555fee1f2ada7a7107f3c266c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a39d18925dcbd4477d63188edeae399f0"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a39d18925dcbd4477d63188edeae399f0">energetic_pbl</a> (h_3d, u_3d, v_3d, tv, fluxes, dt, Kd_int, G, GV, US, CS, dSV_dT, dSV_dS, TKE_forced, buoy_flux, dt_diag, last_call, dT_expected, dS_expected, Waves)</td></tr>
<tr class="memdesc:a39d18925dcbd4477d63188edeae399f0"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine determines the diffusivities from the integrated energetics mixed layer model. It assumes that heating, cooling and freshwater fluxes have already been applied. All calculations are done implicitly, and there is no stability limit on the time step.  <a href="namespacemom__energetic__pbl.html#a39d18925dcbd4477d63188edeae399f0">More...</a><br /></td></tr>
<tr class="separator:a39d18925dcbd4477d63188edeae399f0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a01291f3e97cfdcf58866a1e9b0bcfc26"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a01291f3e97cfdcf58866a1e9b0bcfc26">epbl_column</a> (h, u, v, T0, S0, dSV_dT, dSV_dS, TKE_forcing, B_flux, absf, u_star, u_star_mean, dt, MLD_io, Kd, mixvel, mixlen, GV, US, CS, eCD, dt_diag, Waves, G, i, j)</td></tr>
<tr class="memdesc:a01291f3e97cfdcf58866a1e9b0bcfc26"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine determines the diffusivities from the integrated energetics mixed layer model for a single column of water.  <a href="namespacemom__energetic__pbl.html#a01291f3e97cfdcf58866a1e9b0bcfc26">More...</a><br /></td></tr>
<tr class="separator:a01291f3e97cfdcf58866a1e9b0bcfc26"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a786e4381a925e3c84d0e99be09295627"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a786e4381a925e3c84d0e99be09295627">find_pe_chg</a> (Kddt_h0, dKddt_h, hp_a, hp_b, Th_a, Sh_a, Th_b, Sh_b, dT_to_dPE_a, dS_to_dPE_a, dT_to_dPE_b, dS_to_dPE_b, pres_Z, dT_to_dColHt_a, dS_to_dColHt_a, dT_to_dColHt_b, dS_to_dColHt_b, PE_chg, dPEc_dKd, dPE_max, dPEc_dKd_0, PE_ColHt_cor)</td></tr>
<tr class="memdesc:a786e4381a925e3c84d0e99be09295627"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine calculates the change in potential energy and or derivatives for several changes in an interfaces's diapycnal diffusivity times a timestep.  <a href="namespacemom__energetic__pbl.html#a786e4381a925e3c84d0e99be09295627">More...</a><br /></td></tr>
<tr class="separator:a786e4381a925e3c84d0e99be09295627"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3eb660658d0677c55c6187dcf4a180b5"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a3eb660658d0677c55c6187dcf4a180b5">find_pe_chg_orig</a> (Kddt_h, h_k, b_den_1, dTe_term, dSe_term, dT_km1_t2, dS_km1_t2, dT_to_dPE_k, dS_to_dPE_k, dT_to_dPEa, dS_to_dPEa, pres_Z, dT_to_dColHt_k, dS_to_dColHt_k, dT_to_dColHta, dS_to_dColHta, PE_chg, dPEc_dKd, dPE_max, dPEc_dKd_0)</td></tr>
<tr class="memdesc:a3eb660658d0677c55c6187dcf4a180b5"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine calculates the change in potential energy and or derivatives for several changes in an interfaces's diapycnal diffusivity times a timestep using the original form used in the first version of ePBL.  <a href="namespacemom__energetic__pbl.html#a3eb660658d0677c55c6187dcf4a180b5">More...</a><br /></td></tr>
<tr class="separator:a3eb660658d0677c55c6187dcf4a180b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7686c6a30a476068859f7a2a30e652df"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a7686c6a30a476068859f7a2a30e652df">find_mstar</a> (CS, US, Buoyancy_Flux, UStar, UStar_Mean, BLD, Abs_Coriolis, MStar, Langmuir_Number, MStar_LT, Convect_Langmuir_Number)</td></tr>
<tr class="memdesc:a7686c6a30a476068859f7a2a30e652df"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine finds the Mstar value for ePBL.  <a href="namespacemom__energetic__pbl.html#a7686c6a30a476068859f7a2a30e652df">More...</a><br /></td></tr>
<tr class="separator:a7686c6a30a476068859f7a2a30e652df"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac7fd166f015884862a3798882ad1c977"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#ac7fd166f015884862a3798882ad1c977">mstar_langmuir</a> (CS, US, Abs_Coriolis, Buoyancy_Flux, UStar, BLD, Langmuir_Number, Mstar, MStar_LT, Convect_Langmuir_Number)</td></tr>
<tr class="memdesc:ac7fd166f015884862a3798882ad1c977"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine modifies the Mstar value if the Langmuir number is present.  <a href="namespacemom__energetic__pbl.html#ac7fd166f015884862a3798882ad1c977">More...</a><br /></td></tr>
<tr class="separator:ac7fd166f015884862a3798882ad1c977"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af3a7ca5357ed9a1383c9556b117116dc"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#af3a7ca5357ed9a1383c9556b117116dc">energetic_pbl_get_mld</a> (CS, MLD, G, US, m_to_MLD_units)</td></tr>
<tr class="memdesc:af3a7ca5357ed9a1383c9556b117116dc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Copies the ePBL active mixed layer depth into MLD.  <a href="namespacemom__energetic__pbl.html#af3a7ca5357ed9a1383c9556b117116dc">More...</a><br /></td></tr>
<tr class="separator:af3a7ca5357ed9a1383c9556b117116dc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad9fa0dc4ba4e126ec686b44a5829c2e8"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#ad9fa0dc4ba4e126ec686b44a5829c2e8">energetic_pbl_init</a> (Time, G, GV, US, param_file, diag, CS)</td></tr>
<tr class="memdesc:ad9fa0dc4ba4e126ec686b44a5829c2e8"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine initializes the energetic_PBL module.  <a href="namespacemom__energetic__pbl.html#ad9fa0dc4ba4e126ec686b44a5829c2e8">More...</a><br /></td></tr>
<tr class="separator:ad9fa0dc4ba4e126ec686b44a5829c2e8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a64860c8b0110ba516795a288acdefd1f"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__energetic__pbl.html#a64860c8b0110ba516795a288acdefd1f">energetic_pbl_end</a> (CS)</td></tr>
<tr class="memdesc:a64860c8b0110ba516795a288acdefd1f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Clean up and deallocate memory associated with the energetic_PBL module.  <a href="namespacemom__energetic__pbl.html#a64860c8b0110ba516795a288acdefd1f">More...</a><br /></td></tr>
<tr class="separator:a64860c8b0110ba516795a288acdefd1f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a39d18925dcbd4477d63188edeae399f0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a39d18925dcbd4477d63188edeae399f0">&#9670;&nbsp;</a></span>energetic_pbl()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_energetic_pbl::energetic_pbl </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>h_3d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>u_3d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>v_3d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke+1), intent(out)&#160;</td>
          <td class="paramname"><em>Kd_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__energetic__pbl_1_1energetic__pbl__cs.html">energetic_pbl_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>dSV_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>dSV_dS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>TKE_forced</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(in)&#160;</td>
          <td class="paramname"><em>buoy_flux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>dt_diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>last_call</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(out), optional&#160;</td>
          <td class="paramname"><em>dT_expected</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(out), optional&#160;</td>
          <td class="paramname"><em>dS_expected</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(wave_parameters_cs), optional, pointer&#160;</td>
          <td class="paramname"><em>Waves</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine determines the diffusivities from the integrated energetics mixed layer model. It assumes that heating, cooling and freshwater fluxes have already been applied. All calculations are done implicitly, and there is no stability limit on the time step. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h_3d</td><td>Layer thicknesses [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u_3d</td><td>Zonal velocities interpolated to h points </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v_3d</td><td>Zonal velocities interpolated to h points </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dsv_dt</td><td>The partial derivative of in-situ specific </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dsv_ds</td><td>The partial derivative of in-situ specific </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tke_forced</td><td>The forcing requirements to homogenize the </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">tv</td><td>A structure containing pointers to any available thermodynamic fields. Absent fields have NULL ptrs. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>A structure containing pointers to any possible forcing fields. Unused fields have NULL ptrs. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment [T ~&gt; s]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">kd_int</td><td>The diagnosed diffusivities at interfaces </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to mixedlayer_init. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">buoy_flux</td><td>The surface buoyancy flux [Z2 T-3 ~&gt; m2 s-3]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_diag</td><td>The diagnostic time step, which may be less than dt if there are two calls to mixedlayer [T ~&gt; s]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">last_call</td><td>If true, this is the last call to mixedlayer in the current time step, so diagnostics will be written. The default is .true. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dt_expected</td><td>The values of temperature change that </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">ds_expected</td><td>The values of salinity change that </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">waves</td><td>Wave CS </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00243">243</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(inout)</span> :: G<span class="comment">      !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">     !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>    :: US<span class="comment">     !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                           <span class="keywordtype">intent(inout)</span> :: h_3d<span class="comment">   !&lt; Layer thicknesses [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: u_3d<span class="comment">   !&lt; Zonal velocities interpolated to h points</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="comment">                                                   !! [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: v_3d<span class="comment">   !&lt; Zonal velocities interpolated to h points</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment">                                                   !! [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: dSV_dT<span class="comment"> !&lt; The partial derivative of in-situ specific</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">                                                   !! volume with potential temperature</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="comment">                                                   !! [R-1 degC-1 ~&gt; m3 kg-1 degC-1].</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: dSV_dS<span class="comment"> !&lt; The partial derivative of in-situ specific</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="comment">                                                   !! volume with salinity [R-1 ppt-1 ~&gt; m3 kg-1 ppt-1].</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: TKE_forced<span class="comment"> !&lt; The forcing requirements to homogenize the</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment">                                                   !! forcing that has been applied to each layer</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment">                                                   !! [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),   <span class="keywordtype">intent(inout)</span> :: tv<span class="comment">     !&lt; A structure containing pointers to any</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="comment">                                                   !! available thermodynamic fields. Absent fields</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">                                                   !! have NULL ptrs.</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;  <span class="keywordtype">type</span>(forcing),           <span class="keywordtype">intent(inout)</span> :: fluxes<span class="comment"> !&lt; A structure containing pointers to any</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">                                                   !! possible forcing fields. Unused fields have</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">                                                   !! NULL ptrs.</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">     !&lt; Time increment [T ~&gt; s].</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                           <span class="keywordtype">intent(out)</span>   :: Kd_int<span class="comment"> !&lt; The diagnosed diffusivities at interfaces</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="comment">                                                   !! [Z2 s-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  <span class="keywordtype">type</span>(energetic_PBL_CS),  <span class="keywordtype">pointer</span>       :: CS<span class="comment">     !&lt; The control structure returned by a previous</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment">                                                   !! call to mixedlayer_init.</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>, &amp;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: buoy_flux<span class="comment"> !&lt; The surface buoyancy flux [Z2 T-3 ~&gt; m2 s-3].</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="keywordtype">  real</span>,          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: dt_diag<span class="comment">   !&lt; The diagnostic time step, which may be less</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="comment">                                                   !! than dt if there are two calls to mixedlayer [T ~&gt; s].</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;  <span class="keywordtype">logical</span>,       <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: last_call<span class="comment"> !&lt; If true, this is the last call to</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">                                                   !! mixedlayer in the current time step, so</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment">                                                   !! diagnostics will be written. The default</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">                                                   !! is .true.</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span>   :: dT_expected<span class="comment"> !&lt; The values of temperature change that</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">                                                   !! should be expected when the returned</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">                                                   !! diffusivities are applied [degC].</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span>   :: dS_expected<span class="comment"> !&lt; The values of salinity change that</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment">                                                   !! should be expected when the returned</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment">                                                   !! diffusivities are applied [ppt].</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;  <span class="keywordtype">type</span>(wave_parameters_CS), &amp;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">pointer</span>       :: Waves<span class="comment">  !&lt; Wave CS</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160; </div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment">!    This subroutine determines the diffusivities from the integrated energetics</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">!  mixed layer model.  It assumes that heating, cooling and freshwater fluxes</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment">!  have already been applied.  All calculations are done implicitly, and there</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment">!  is no stability limit on the time step.</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="comment">!    For each interior interface, first discard the TKE to account for mixing</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment">! of shortwave radiation through the next denser cell.  Next drive mixing based</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="comment">! on the local? values of ustar + wstar, subject to available energy.  This</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="comment">! step sets the value of Kd(K).  Any remaining energy is then subject to decay</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment">! before being handed off to the next interface.  mech_TKE and conv_PErel are treated</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment">! separately for the purposes of decay, but are used proportionately to drive</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="comment">! mixing.</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="comment">!   The key parameters for the mixed layer are found in the control structure.</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="comment">!   To use the classic constant mstar mixied layers choose MSTAR_SCHEME=CONSTANT.</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="comment">! The key parameters then include mstar, nstar, TKE_decay, and conv_decay.</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="comment">! For the Oberhuber (1993) mixed layer,the values of these are:</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="comment">!      mstar = 1.25,  nstar = 1, TKE_decay = 2.5, conv_decay = 0.5</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="comment">! TKE_decay is 1/kappa in eq. 28 of Oberhuber (1993), while conv_decay is 1/mu.</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="comment">! For a traditional Kraus-Turner mixed layer, the values are:</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment">!      mstar = 1.25, nstar = 0.4, TKE_decay = 0.0, conv_decay = 0.0</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160; </div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span> :: &amp;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    h_2d, &amp;         <span class="comment">! A 2-d slice of the layer thickness [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    T_2d, &amp;         <span class="comment">! A 2-d slice of the layer temperatures [degC].</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    S_2d, &amp;         <span class="comment">! A 2-d slice of the layer salinities [ppt].</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    TKE_forced_2d, &amp; <span class="comment">! A 2-d slice of TKE_forced [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    dSV_dT_2d, &amp;    <span class="comment">! A 2-d slice of dSV_dT [R-1 degC-1 ~&gt; m3 kg-1 degC-1].</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    dSV_dS_2d, &amp;    <span class="comment">! A 2-d slice of dSV_dS [R-1 ppt-1 ~&gt; m3 kg-1 ppt-1].</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    u_2d, &amp;         <span class="comment">! A 2-d slice of the zonal velocity [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    v_2d            <span class="comment">! A 2-d slice of the meridional velocity [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV)+1)</span> :: &amp;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    Kd_2d           <span class="comment">! A 2-d version of the diapycnal diffusivity [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: &amp;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    h, &amp;            <span class="comment">! The layer thickness [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    T0, &amp;           <span class="comment">! The initial layer temperatures [degC].</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    S0, &amp;           <span class="comment">! The initial layer salinities [ppt].</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    dSV_dT_1d, &amp;    <span class="comment">! The partial derivatives of specific volume with temperature [R-1 degC-1 ~&gt; m3 kg-1 degC-1].</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    dSV_dS_1d, &amp;    <span class="comment">! The partial derivatives of specific volume with salinity [R-1 ppt-1 ~&gt; m3 kg-1 ppt-1].</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    TKE_forcing, &amp;  <span class="comment">! Forcing of the TKE in the layer coming from TKE_forced [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    u, &amp;            <span class="comment">! The zonal velocity [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    v               <span class="comment">! The meridional velocity [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: &amp;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    Kd, &amp;           <span class="comment">! The diapycnal diffusivity [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    mixvel, &amp;       <span class="comment">! A turbulent mixing veloxity [Z T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    mixlen          <span class="comment">! A turbulent mixing length [Z ~&gt; m].</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="keywordtype">  real</span> :: h_neglect <span class="comment">! A thickness that is so small it is usually lost</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;                    <span class="comment">! in roundoff and can be neglected [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160; </div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="keywordtype">  real</span> :: absf      <span class="comment">! The absolute value of f [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="keywordtype">  real</span> :: U_star    <span class="comment">! The surface friction velocity [Z T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="keywordtype">  real</span> :: U_Star_Mean <span class="comment">! The surface friction without gustiness [Z T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="keywordtype">  real</span> :: B_Flux    <span class="comment">! The surface buoyancy flux [Z2 T-3 ~&gt; m2 s-3]</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="keywordtype">  real</span> :: MLD_io    <span class="comment">! The mixed layer depth found by ePBL_column [Z ~&gt; m].</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160; </div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="comment">! The following are only used for diagnostics.</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="keywordtype">  real</span> :: dt__diag  <span class="comment">! A copy of dt_diag (if present) or dt [T ~&gt; s].</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;  <span class="keywordtype">logical</span> :: write_diags  <span class="comment">! If true, write out diagnostics with this step.</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;  <span class="keywordtype">logical</span> :: reset_diags  <span class="comment">! If true, zero out the accumulated diagnostics.</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160; </div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;  <span class="keywordtype">logical</span> :: debug=.false.  <span class="comment">! Change this hard-coded value for debugging.</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;  <span class="keywordtype">type</span>(ePBL_column_diags) :: eCD <span class="comment">! A container for passing around diagnostics.</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160; </div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, nz</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160; </div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = gv%ke</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160; </div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;energetic_PBL: &quot;</span>//&amp;</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;         <span class="stringliteral">&quot;Module must be initialized before it is used.&quot;</span>)</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160; </div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(tv%eqn_of_state)) <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;      <span class="stringliteral">&quot;energetic_PBL: Temperature, salinity and an equation of state &quot;</span>//&amp;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;      <span class="stringliteral">&quot;must now be used.&quot;</span>)</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;  <span class="keywordflow">if</span> (.NOT. <span class="keyword">associated</span>(fluxes%ustar)) <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;      <span class="stringliteral">&quot;energetic_PBL: No surface TKE fluxes (ustar) defined in mixedlayer!&quot;</span>)</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;  debug = .false. ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_expected) .or. <span class="keyword">present</span>(ds_expected)) debug = .true.</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160; </div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;  <span class="keywordflow">if</span> (debug) <span class="keyword">allocate</span>(ecd%dT_expect(nz), ecd%dS_expect(nz))</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160; </div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  h_neglect = gv%H_subroundoff</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160; </div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;  dt__diag = dt ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_diag)) dt__diag = dt_diag</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;  write_diags = .true. ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(last_call)) write_diags = last_call</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160; </div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160; </div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;  <span class="comment">! Determine whether to zero out diagnostics before accumulation.</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;  reset_diags = .true.</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_diag) .and. write_diags .and. (dt__diag &gt; dt)) &amp;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    reset_diags = .false.  <span class="comment">! This is the second call to mixedlayer.</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160; </div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  <span class="keywordflow">if</span> (reset_diags) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="comment">!!OMP parallel do default(none) shared(is,ie,js,je,CS)</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        cs%diag_TKE_wind(i,j) = 0.0 ; cs%diag_TKE_MKE(i,j) = 0.0</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        cs%diag_TKE_conv(i,j) = 0.0 ; cs%diag_TKE_forcing(i,j) = 0.0</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        cs%diag_TKE_mixing(i,j) = 0.0 ; cs%diag_TKE_mech_decay(i,j) = 0.0</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        cs%diag_TKE_conv_decay(i,j) = 0.0 <span class="comment">!; CS%diag_TKE_unbalanced(i,j) = 0.0</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;  <span class="comment">! if (CS%id_Mixing_Length&gt;0) CS%Mixing_Length(:,:,:) = 0.0</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  <span class="comment">! if (CS%id_Velocity_Scale&gt;0) CS%Velocity_Scale(:,:,:) = 0.0</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160; </div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="comment">!!OMP parallel do default(private) shared(js,je,nz,is,ie,h_3d,u_3d,v_3d,tv,dt, &amp;</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="comment">!!OMP                                  CS,G,GV,US,fluxes,debug, &amp;</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="comment">!!OMP                                  TKE_forced,dSV_dT,dSV_dS,Kd_int)</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;  <span class="keywordflow">do</span> j=js,je</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="comment">! Copy the thicknesses and other fields to 2-d arrays.</span></div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;      h_2d(i,k) = h_3d(i,j,k) ; u_2d(i,k) = u_3d(i,j,k) ; v_2d(i,k) = v_3d(i,j,k)</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;      t_2d(i,k) = tv%T(i,j,k) ; s_2d(i,k) = tv%S(i,j,k)</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;      tke_forced_2d(i,k) = tke_forced(i,j,k)</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;      dsv_dt_2d(i,k) = dsv_dt(i,j,k) ; dsv_ds_2d(i,k) = dsv_ds(i,j,k)</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160; </div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="comment">!   Determine the initial mech_TKE and conv_PErel, including the energy required</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    <span class="comment">! to mix surface heating through the topmost cell, the energy released by mixing</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="comment">! surface cooling &amp; brine rejection down through the topmost cell, and</span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    <span class="comment">! homogenizing the shortwave heating within that cell.  This sets the energy</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    <span class="comment">! and ustar and wstar available to drive mixing at the first interior</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    <span class="comment">! interface.</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (g%mask2dT(i,j) &gt; 0.5) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160; </div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;      <span class="comment">! Copy the thicknesses and other fields to 1-d arrays.</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;      <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        h(k) = h_2d(i,k) + gv%H_subroundoff ; u(k) = u_2d(i,k) ; v(k) = v_2d(i,k)</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        t0(k) = t_2d(i,k) ; s0(k) = s_2d(i,k) ; tke_forcing(k) =  tke_forced_2d(i,k)</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        dsv_dt_1d(k) = dsv_dt_2d(i,k) ; dsv_ds_1d(k) = dsv_ds_2d(i,k)</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1 ; kd(k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160; </div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;      <span class="comment">! Make local copies of surface forcing and process them.</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;      u_star = fluxes%ustar(i,j)</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;      u_star_mean = fluxes%ustar_gustless(i,j)</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;      b_flux = buoy_flux(i,j)</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%ustar_shelf) .and. <span class="keyword">associated</span>(fluxes%frac_shelf_h)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        <span class="keywordflow">if</span> (fluxes%frac_shelf_h(i,j) &gt; 0.0) &amp;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;          u_star = (1.0 - fluxes%frac_shelf_h(i,j)) * u_star + &amp;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                   fluxes%frac_shelf_h(i,j) * fluxes%ustar_shelf(i,j)</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;      <span class="keywordflow">if</span> (u_star &lt; cs%ustar_min) u_star = cs%ustar_min</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;      <span class="keywordflow">if</span> (cs%omega_frac &gt;= 1.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;        absf = 2.0*cs%omega</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        absf = 0.25*((abs(g%CoriolisBu(i,j)) + abs(g%CoriolisBu(i-1,j-1))) + &amp;</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                     (abs(g%CoriolisBu(i,j-1)) + abs(g%CoriolisBu(i-1,j))))</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <span class="keywordflow">if</span> (cs%omega_frac &gt; 0.0) &amp;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;          absf = sqrt(cs%omega_frac*4.0*cs%omega**2 + (1.0-cs%omega_frac)*absf**2)</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160; </div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;      <span class="comment">! Perhaps provide a first guess for MLD based on a stored previous value.</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;      mld_io = -1.0</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;      <span class="keywordflow">if</span> (cs%MLD_iteration_guess .and. (cs%ML_Depth(i,j) &gt; 0.0))  mld_io = cs%ML_Depth(i,j)</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160; </div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;      <span class="keyword">call </span>epbl_column(h, u, v, t0, s0, dsv_dt_1d, dsv_ds_1d, tke_forcing, b_flux, absf, &amp;</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                       u_star, u_star_mean, dt, mld_io, kd, mixvel, mixlen, gv, &amp;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                       us, cs, ecd, dt_diag=dt_diag, waves=waves, g=g, i=i, j=j)</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160; </div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160; </div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;      <span class="comment">! Copy the diffusivities to a 2-d array.</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        kd_2d(i,k) = kd(k)</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;      cs%ML_depth(i,j) = mld_io</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160; </div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_expected)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; dt_expected(i,j,k) = ecd%dT_expect(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(ds_expected)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; ds_expected(i,j,k) = ecd%dS_expect(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160; </div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;      <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        cs%diag_TKE_MKE(i,j) = cs%diag_TKE_MKE(i,j) + ecd%dTKE_MKE</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        cs%diag_TKE_conv(i,j) = cs%diag_TKE_conv(i,j) + ecd%dTKE_conv</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        cs%diag_TKE_forcing(i,j) = cs%diag_TKE_forcing(i,j) + ecd%dTKE_forcing</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        cs%diag_TKE_wind(i,j) = cs%diag_TKE_wind(i,j) + ecd%dTKE_wind</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        cs%diag_TKE_mixing(i,j) = cs%diag_TKE_mixing(i,j) + ecd%dTKE_mixing</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        cs%diag_TKE_mech_decay(i,j) = cs%diag_TKE_mech_decay(i,j) + ecd%dTKE_mech_decay</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        cs%diag_TKE_conv_decay(i,j) = cs%diag_TKE_conv_decay(i,j) + ecd%dTKE_conv_decay</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;       <span class="comment">! CS%diag_TKE_unbalanced(i,j) = CS%diag_TKE_unbalanced(i,j) + eCD%dTKE_unbalanced</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;      <span class="comment">! Write to 3-D for outputing Mixing length and velocity scale.</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;      <span class="keywordflow">if</span> (cs%id_Mixing_Length&gt;0) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        cs%Mixing_Length(i,j,k) = mixlen(k)</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;      <span class="keywordflow">if</span> (cs%id_Velocity_Scale&gt;0) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        cs%Velocity_Scale(i,j,k) = mixvel(k)</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%mstar_mix)) cs%mstar_mix(i,j) = ecd%mstar</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%mstar_lt)) cs%mstar_lt(i,j) = ecd%mstar_LT</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%La)) cs%La(i,j) = ecd%LA</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%La_mod)) cs%La_mod(i,j) = ecd%LAmod</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="keywordflow">else</span> <span class="comment">! End of the ocean-point part of the i-loop</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;      <span class="comment">! For masked points, Kd_int must still be set (to 0) because it has intent out.</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1 ; kd_2d(i,k) = 0. ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;      cs%ML_depth(i,j) = 0.0</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160; </div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_expected)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; dt_expected(i,j,k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(ds_expected)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; ds_expected(i,j,k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! Close of i-loop - Note unusual loop order!</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160; </div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=is,ie ; kd_int(i,j,k) = kd_2d(i,k) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160; </div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! j-loop</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160; </div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;  <span class="keywordflow">if</span> (write_diags) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    <span class="keywordflow">if</span> (cs%id_ML_depth &gt; 0) <span class="keyword">call </span>post_data(cs%id_ML_depth, cs%ML_depth, cs%diag)</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_wind &gt; 0) <span class="keyword">call </span>post_data(cs%id_TKE_wind, cs%diag_TKE_wind, cs%diag)</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_MKE &gt; 0)  <span class="keyword">call </span>post_data(cs%id_TKE_MKE, cs%diag_TKE_MKE, cs%diag)</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_conv &gt; 0) <span class="keyword">call </span>post_data(cs%id_TKE_conv, cs%diag_TKE_conv, cs%diag)</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_forcing &gt; 0) <span class="keyword">call </span>post_data(cs%id_TKE_forcing, cs%diag_TKE_forcing, cs%diag)</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_mixing &gt; 0) <span class="keyword">call </span>post_data(cs%id_TKE_mixing, cs%diag_TKE_mixing, cs%diag)</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_mech_decay &gt; 0) &amp;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_mech_decay, cs%diag_TKE_mech_decay, cs%diag)</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_conv_decay &gt; 0) &amp;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_conv_decay, cs%diag_TKE_conv_decay, cs%diag)</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    <span class="keywordflow">if</span> (cs%id_Mixing_Length &gt; 0) <span class="keyword">call </span>post_data(cs%id_Mixing_Length, cs%Mixing_Length, cs%diag)</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    <span class="keywordflow">if</span> (cs%id_Velocity_Scale &gt;0) <span class="keyword">call </span>post_data(cs%id_Velocity_Scale, cs%Velocity_Scale, cs%diag)</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <span class="keywordflow">if</span> (cs%id_MSTAR_MIX &gt; 0)     <span class="keyword">call </span>post_data(cs%id_MSTAR_MIX, cs%MSTAR_MIX, cs%diag)</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    <span class="keywordflow">if</span> (cs%id_LA &gt; 0)       <span class="keyword">call </span>post_data(cs%id_LA, cs%LA, cs%diag)</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    <span class="keywordflow">if</span> (cs%id_LA_MOD &gt; 0)   <span class="keyword">call </span>post_data(cs%id_LA_MOD, cs%LA_MOD, cs%diag)</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="keywordflow">if</span> (cs%id_MSTAR_LT &gt; 0) <span class="keyword">call </span>post_data(cs%id_MSTAR_LT, cs%MSTAR_LT, cs%diag)</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160; </div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;  <span class="keywordflow">if</span> (debug) <span class="keyword">deallocate</span>(ecd%dT_expect, ecd%dS_expect)</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00538">epbl_column()</a>, and <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_a39d18925dcbd4477d63188edeae399f0_cgraph.svg" width="100%" height="551"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a64860c8b0110ba516795a288acdefd1f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a64860c8b0110ba516795a288acdefd1f">&#9670;&nbsp;</a></span>energetic_pbl_end()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_energetic_pbl::energetic_pbl_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__energetic__pbl_1_1energetic__pbl__cs.html">energetic_pbl_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Clean up and deallocate memory associated with the energetic_PBL module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">cs</td><td>Energetic_PBL control structure that will be deallocated in this subroutine. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l02379">2379</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;  <span class="keywordtype">type</span>(energetic_PBL_CS), <span class="keywordtype">pointer</span> :: CS<span class="comment"> !&lt; Energetic_PBL control structure that</span></div>
<div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;<span class="comment">                                        !! will be deallocated in this subroutine.</span></div>
<div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160; </div>
<div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keywordflow">return</span></div>
<div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160; </div>
<div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%ML_depth))            <span class="keyword">deallocate</span>(cs%ML_depth)</div>
<div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%LA))                  <span class="keyword">deallocate</span>(cs%LA)</div>
<div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%LA_MOD))              <span class="keyword">deallocate</span>(cs%LA_MOD)</div>
<div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%MSTAR_MIX))           <span class="keyword">deallocate</span>(cs%MSTAR_MIX)</div>
<div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%MSTAR_LT))            <span class="keyword">deallocate</span>(cs%MSTAR_LT)</div>
<div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%diag_TKE_wind))       <span class="keyword">deallocate</span>(cs%diag_TKE_wind)</div>
<div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%diag_TKE_MKE))        <span class="keyword">deallocate</span>(cs%diag_TKE_MKE)</div>
<div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%diag_TKE_conv))       <span class="keyword">deallocate</span>(cs%diag_TKE_conv)</div>
<div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%diag_TKE_forcing))    <span class="keyword">deallocate</span>(cs%diag_TKE_forcing)</div>
<div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%diag_TKE_mixing))     <span class="keyword">deallocate</span>(cs%diag_TKE_mixing)</div>
<div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%diag_TKE_mech_decay)) <span class="keyword">deallocate</span>(cs%diag_TKE_mech_decay)</div>
<div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%diag_TKE_conv_decay)) <span class="keyword">deallocate</span>(cs%diag_TKE_conv_decay)</div>
<div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%Mixing_Length))       <span class="keyword">deallocate</span>(cs%Mixing_Length)</div>
<div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%Velocity_Scale))      <span class="keyword">deallocate</span>(cs%Velocity_Scale)</div>
<div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160; </div>
<div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;  <span class="keyword">deallocate</span>(cs)</div>
<div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160; </div>
</div><!-- fragment -->
</div>
</div>
<a id="af3a7ca5357ed9a1383c9556b117116dc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af3a7ca5357ed9a1383c9556b117116dc">&#9670;&nbsp;</a></span>energetic_pbl_get_mld()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_energetic_pbl::energetic_pbl_get_mld </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__energetic__pbl_1_1energetic__pbl__cs.html">energetic_pbl_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(out)&#160;</td>
          <td class="paramname"><em>MLD</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>m_to_MLD_units</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Copies the ePBL active mixed layer depth into MLD. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Control structure for ePBL </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">mld</td><td>Depth of ePBL active mixing layer [m or other units] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">m_to_mld_units</td><td>A conversion factor to the desired units for MLD </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01920">1920</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;  <span class="keywordtype">type</span>(energetic_PBL_CS),           <span class="keywordtype">pointer</span>     :: CS<span class="comment">  !&lt; Control structure for ePBL</span></div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),            <span class="keywordtype">intent(in)</span>  :: G<span class="comment">   !&lt; Grid structure</span></div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),            <span class="keywordtype">intent(in)</span>  :: US<span class="comment">  !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>, <span class="keywordtype">intent(out)</span> :: MLD<span class="comment"> !&lt; Depth of ePBL active mixing layer [m or other units]</span></div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;<span class="keywordtype">  real</span>,                   <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>  :: m_to_MLD_units<span class="comment"> !&lt; A conversion factor to the</span></div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;<span class="comment">                                                       !! desired units for MLD</span></div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;<span class="keywordtype">  real</span> :: scale  <span class="comment">! A dimensional rescaling factor</span></div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;  <span class="keywordtype">integer</span> :: i,j</div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160; </div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;  scale = us%Z_to_m ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(m_to_mld_units)) scale = scale * m_to_mld_units</div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160; </div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;  <span class="keywordflow">do</span> j=g%jsc,g%jec ; <span class="keywordflow">do</span> i=g%isc,g%iec</div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;    mld(i,j) = scale*cs%ML_Depth(i,j)</div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__diabatic__driver_8F90_source.html#l01229">mom_diabatic_driver::diabatic_ale()</a>, <a class="el" href="MOM__diabatic__driver_8F90_source.html#l00446">mom_diabatic_driver::diabatic_ale_legacy()</a>, <a class="el" href="MOM__lateral__boundary__diffusion_8F90_source.html#l00123">mom_lateral_boundary_diffusion::lateral_boundary_diffusion()</a>, and <a class="el" href="MOM__neutral__diffusion_8F90_source.html#l00264">mom_neutral_diffusion::neutral_diffusion_calc_coeffs()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_af3a7ca5357ed9a1383c9556b117116dc_icgraph.svg" width="583" height="279"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="ad9fa0dc4ba4e126ec686b44a5829c2e8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad9fa0dc4ba4e126ec686b44a5829c2e8">&#9670;&nbsp;</a></span>energetic_pbl_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_energetic_pbl::energetic_pbl_init </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in), target&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(inout), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__energetic__pbl_1_1energetic__pbl__cs.html">energetic_pbl_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine initializes the energetic_PBL module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>The current model time </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>A structure to parse for run-time parameters </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">diag</td><td>A structure that is used to regulate diagnostic output </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>A pointer that is set to point to the control structure for this module </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">1941</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;  <span class="keywordtype">type</span>(time_type), <span class="keywordtype">target</span>, <span class="keywordtype">intent(in)</span>    :: Time<span class="comment"> !&lt; The current model time</span></div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>    :: US<span class="comment">   !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;  <span class="keywordtype">type</span>(param_file_type),   <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; A structure to parse for run-time parameters</span></div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>, <span class="keywordtype">intent(inout)</span> :: diag<span class="comment"> !&lt; A structure that is used to regulate diagnostic output</span></div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;  <span class="keywordtype">type</span>(energetic_PBL_CS),  <span class="keywordtype">pointer</span>       :: CS<span class="comment">   !&lt; A pointer that is set to point to the control</span></div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;<span class="comment">                                                 !! structure for this module</span></div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;  <span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;<span class="preprocessor"># include &quot;version_variable.h&quot;</span></div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_energetic_PBL&quot;</span>  <span class="comment">! This module&#39;s name.</span></div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;  <span class="keywordtype">character(len=20)</span>  :: tmpstr</div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;<span class="keywordtype">  real</span> :: omega_frac_dflt</div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;<span class="keywordtype">  real</span> :: R_Z3_T3_to_kg_s3 <span class="comment">! A conversion factor for work diagnostics [kg T3 R-1 Z-3 s-3 ~&gt; nondim]</span></div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;  <span class="keywordtype">integer</span> :: isd, ied, jsd, jed</div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;  <span class="keywordtype">integer</span> :: mstar_mode, LT_enhance, wT_mode</div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;  <span class="keywordtype">logical</span> :: default_2018_answers</div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;  <span class="keywordtype">logical</span> :: use_temperature, use_omega</div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;  <span class="keywordtype">logical</span> :: use_la_windsea</div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed</div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160; </div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;mixedlayer_init called with an associated&quot;</span>//&amp;</div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;                            <span class="stringliteral">&quot;associated control structure.&quot;</span>)</div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;    <span class="keywordflow">return</span></div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;  <span class="keywordflow">else</span> ; <span class="keyword">allocate</span>(cs) ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160; </div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;  cs%diag =&gt; diag</div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;  cs%Time =&gt; time</div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160; </div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;<span class="comment">! Set default, read and log parameters</span></div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, <span class="stringliteral">&quot;&quot;</span>)</div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160; </div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160; </div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;<span class="comment">!/1. General ePBL settings</span></div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OMEGA&quot;</span>, cs%omega, &amp;</div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;                 <span class="stringliteral">&quot;The rotation rate of the earth.&quot;</span>, units=<span class="stringliteral">&quot;s-1&quot;</span>, &amp;</div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;                 default=7.2921e-5, scale=us%T_to_S)</div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_USE_OMEGA&quot;</span>, use_omega, &amp;</div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;                 <span class="stringliteral">&quot;If true, use the absolute rotation rate instead of the &quot;</span>//&amp;</div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;                 <span class="stringliteral">&quot;vertical component of rotation when setting the decay &quot;</span>//&amp;</div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;                 <span class="stringliteral">&quot;scale for turbulence.&quot;</span>, default=.false., do_not_log=.true.)</div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;  omega_frac_dflt = 0.0</div>
<div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;  <span class="keywordflow">if</span> (use_omega) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;ML_USE_OMEGA is depricated; use ML_OMEGA_FRAC=1.0 instead.&quot;</span>)</div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;    omega_frac_dflt = 1.0</div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_OMEGA_FRAC&quot;</span>, cs%omega_frac, &amp;</div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;                 <span class="stringliteral">&quot;When setting the decay scale for turbulence, use this &quot;</span>//&amp;</div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;                 <span class="stringliteral">&quot;fraction of the absolute rotation rate blended with the &quot;</span>//&amp;</div>
<div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;                 <span class="stringliteral">&quot;local value of f, as sqrt((1-of)*f^2 + of*4*omega^2).&quot;</span>, &amp;</div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=omega_frac_dflt)</div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EKMAN_SCALE_COEF&quot;</span>, cs%Ekman_scale_coef, &amp;</div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;                 <span class="stringliteral">&quot;A nondimensional scaling factor controlling the inhibition &quot;</span>//&amp;</div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;                 <span class="stringliteral">&quot;of the diffusive length scale by rotation. Making this larger &quot;</span>//&amp;</div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;                 <span class="stringliteral">&quot;decreases the PBL diffusivity.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0)</div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DEFAULT_2018_ANSWERS&quot;</span>, default_2018_answers, &amp;</div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;                 <span class="stringliteral">&quot;This sets the default value for the various _2018_ANSWERS parameters.&quot;</span>, &amp;</div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;                 default=.true.)</div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_2018_ANSWERS&quot;</span>, cs%answers_2018, &amp;</div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;                 <span class="stringliteral">&quot;If true, use the order of arithmetic and expressions that recover the &quot;</span>//&amp;</div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;                 <span class="stringliteral">&quot;answers from the end of 2018.  Otherwise, use updated and more robust &quot;</span>//&amp;</div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;                 <span class="stringliteral">&quot;forms of the same expressions.&quot;</span>, default=default_2018_answers)</div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160; </div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160; </div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_ORIGINAL_PE_CALC&quot;</span>, cs%orig_PE_calc, &amp;</div>
<div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;                 <span class="stringliteral">&quot;If true, the ePBL code uses the original form of the &quot;</span>//&amp;</div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;                 <span class="stringliteral">&quot;potential energy change code.  Otherwise, the newer &quot;</span>//&amp;</div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;                 <span class="stringliteral">&quot;version that can work with successive increments to the &quot;</span>//&amp;</div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;                 <span class="stringliteral">&quot;diffusivity in upward or downward passes is used.&quot;</span>, default=.true.)</div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160; </div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MKE_TO_TKE_EFFIC&quot;</span>, cs%MKE_to_TKE_effic, &amp;</div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;                 <span class="stringliteral">&quot;The efficiency with which mean kinetic energy released &quot;</span>//&amp;</div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;                 <span class="stringliteral">&quot;by mechanically forced entrainment of the mixed layer &quot;</span>//&amp;</div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;                 <span class="stringliteral">&quot;is converted to turbulent kinetic energy.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, &amp;</div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;                 default=0.0)</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TKE_DECAY&quot;</span>, cs%TKE_decay, &amp;</div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;                 <span class="stringliteral">&quot;TKE_DECAY relates the vertical rate of decay of the &quot;</span>//&amp;</div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;                 <span class="stringliteral">&quot;TKE available for mechanical entrainment to the natural &quot;</span>//&amp;</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;                 <span class="stringliteral">&quot;Ekman depth.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=2.5)</div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160; </div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160; </div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;<span class="comment">!/2. Options related to setting MSTAR</span></div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_MSTAR_SCHEME&quot;</span>, tmpstr, &amp;</div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;                 <span class="stringliteral">&quot;EPBL_MSTAR_SCHEME selects the method for setting mstar.  Valid values are: \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;                 <span class="stringliteral">&quot;\t CONSTANT   - Use a fixed mstar given by MSTAR \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;                 <span class="stringliteral">&quot;\t OM4        - Use L_Ekman/L_Obukhov in the sabilizing limit, as in OM4 \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;                 <span class="stringliteral">&quot;\t REICHL_H18 - Use the scheme documented in Reichl &amp; Hallberg, 2018.&quot;</span>, &amp;</div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;                 default=constant_string, do_not_log=.true.)</div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR_MODE&quot;</span>, mstar_mode, default=-1)</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;  <span class="keywordflow">if</span> (mstar_mode == 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;    tmpstr = constant_string</div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;Use EPBL_MSTAR_SCHEME = CONSTANT instead of the archaic MSTAR_MODE = 0.&quot;</span>)</div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;  <span class="keywordflow">elseif</span> (mstar_mode == 1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;You are using a legacy mstar mode in ePBL that has been phased out. &quot;</span>//&amp;</div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;                          <span class="stringliteral">&quot;If you need to use this setting please report this error.  Also use &quot;</span>//&amp;</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;                          <span class="stringliteral">&quot;EPBL_MSTAR_SCHEME to specify the scheme for mstar.&quot;</span>)</div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;  <span class="keywordflow">elseif</span> (mstar_mode == 2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;    tmpstr = om4_string</div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;Use EPBL_MSTAR_SCHEME = OM4 instead of the archaic MSTAR_MODE = 2.&quot;</span>)</div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;  <span class="keywordflow">elseif</span> (mstar_mode == 3) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;    tmpstr = rh18_string</div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;Use EPBL_MSTAR_SCHEME = REICHL_H18 instead of the archaic MSTAR_MODE = 3.&quot;</span>)</div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;  <span class="keywordflow">elseif</span> (mstar_mode &gt; 3) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;An unrecognized value of the obsolete parameter MSTAR_MODE was specified.&quot;</span>)</div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;  <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_MSTAR_SCHEME&quot;</span>, tmpstr, &amp;</div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;                 <span class="stringliteral">&quot;EPBL_MSTAR_SCHEME selects the method for setting mstar.  Valid values are: \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;                 <span class="stringliteral">&quot;\t CONSTANT   - Use a fixed mstar given by MSTAR \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;                 <span class="stringliteral">&quot;\t OM4        - Use L_Ekman/L_Obukhov in the sabilizing limit, as in OM4 \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;                 <span class="stringliteral">&quot;\t REICHL_H18 - Use the scheme documented in Reichl &amp; Hallberg, 2018.&quot;</span>, &amp;</div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;                 default=constant_string)</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;  tmpstr = uppercase(tmpstr)</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;  <span class="keywordflow">select case</span> (tmpstr)</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;    <span class="keywordflow">case</span> (constant_string)</div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;      cs%mstar_Scheme = use_fixed_mstar</div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;    <span class="keywordflow">case</span> (om4_string)</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;      cs%mstar_Scheme = mstar_from_ekman</div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;    <span class="keywordflow">case</span> (rh18_string)</div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;      cs%mstar_Scheme = mstar_from_rh18</div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;<span class="keywordflow">    case default</span></div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;      <span class="keyword">call </span>mom_mesg(<span class="stringliteral">&#39;energetic_PBL_init: EPBL_MSTAR_SCHEME =&quot;&#39;</span>//trim(tmpstr)//<span class="stringliteral">&#39;&quot;&#39;</span>, 0)</div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;energetic_PBL_init: Unrecognized setting &quot;</span>// &amp;</div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;            <span class="stringliteral">&quot;EPBL_MSTAR_SCHEME = &quot;</span>//trim(tmpstr)//<span class="stringliteral">&quot; found in input file.&quot;</span>)</div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;<span class="keywordflow">  end select</span></div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160; </div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR&quot;</span>, cs%fixed_mstar, &amp;</div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;                 <span class="stringliteral">&quot;The ratio of the friction velocity cubed to the TKE input to the &quot;</span>//&amp;</div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;                 <span class="stringliteral">&quot;mixed layer.  This option is used if EPBL_MSTAR_SCHEME = CONSTANT.&quot;</span>, &amp;</div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.2, do_not_log=(cs%mstar_scheme/=use_fixed_mstar))</div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR_CAP&quot;</span>, cs%mstar_cap, &amp;</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;                 <span class="stringliteral">&quot;If this value is positive, it sets the maximum value of mstar &quot;</span>//&amp;</div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;                 <span class="stringliteral">&quot;allowed in ePBL.  (This is not used if EPBL_MSTAR_SCHEME = CONSTANT).&quot;</span>, &amp;</div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=-1.0, do_not_log=(cs%mstar_scheme==use_fixed_mstar))</div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;  <span class="comment">! mstar_scheme==MStar_from_Ekman options</span></div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR2_COEF1&quot;</span>, cs%MSTAR_COEF, &amp;</div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;                 <span class="stringliteral">&quot;Coefficient in computing mstar when rotation and stabilizing &quot;</span>//&amp;</div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;                 <span class="stringliteral">&quot;effects are both important (used if EPBL_MSTAR_SCHEME = OM4).&quot;</span>, &amp;</div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.3, do_not_log=(cs%mstar_scheme/=mstar_from_ekman))</div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR2_COEF2&quot;</span>, cs%C_EK, &amp;</div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;                 <span class="stringliteral">&quot;Coefficient in computing mstar when only rotation limits &quot;</span>// &amp;</div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;                 <span class="stringliteral">&quot;the total mixing (used if EPBL_MSTAR_SCHEME = OM4)&quot;</span>, &amp;</div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.085, do_not_log=(cs%mstar_scheme/=mstar_from_ekman))</div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;  <span class="comment">! mstar_scheme==MStar_from_RH18 options</span></div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RH18_MSTAR_CN1&quot;</span>, cs%RH18_mstar_cn1,&amp;</div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;                 <span class="stringliteral">&quot;MSTAR_N coefficient 1 (outter-most coefficient for fit). &quot;</span>//&amp;</div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;                 <span class="stringliteral">&quot;The value of 0.275 is given in RH18.  Increasing this &quot;</span>//&amp;</div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;                 <span class="stringliteral">&quot;coefficient increases MSTAR for all values of Hf/ust, but more &quot;</span>//&amp;</div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;                 <span class="stringliteral">&quot;effectively at low values (weakly developed OSBLs).&quot;</span>, &amp;</div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.275, do_not_log=(cs%mstar_scheme/=mstar_from_rh18))</div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RH18_MSTAR_CN2&quot;</span>, cs%RH18_mstar_cn2,&amp;</div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;                 <span class="stringliteral">&quot;MSTAR_N coefficient 2 (coefficient outside of exponential decay). &quot;</span>//&amp;</div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;                 <span class="stringliteral">&quot;The value of 8.0 is given in RH18.  Increasing this coefficient &quot;</span>//&amp;</div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;                 <span class="stringliteral">&quot;increases MSTAR for all values of HF/ust, with a much more even &quot;</span>//&amp;</div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;                 <span class="stringliteral">&quot;effect across a wide range of Hf/ust than CN1.&quot;</span>, &amp;</div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=8.0, do_not_log=(cs%mstar_scheme/=mstar_from_rh18))</div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RH18_MSTAR_CN3&quot;</span>, cs%RH18_mstar_CN3,&amp;</div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;                 <span class="stringliteral">&quot;MSTAR_N coefficient 3 (exponential decay coefficient). &quot;</span>//&amp;</div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;                 <span class="stringliteral">&quot;The value of -5.0 is given in RH18.  Increasing this increases how &quot;</span>//&amp;</div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;                 <span class="stringliteral">&quot;quickly the value of MSTAR decreases as Hf/ust increases.&quot;</span>, &amp;</div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;                  units=<span class="stringliteral">&quot;nondim&quot;</span>, default=-5.0, do_not_log=(cs%mstar_scheme/=mstar_from_rh18))</div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RH18_MSTAR_CS1&quot;</span>, cs%RH18_mstar_cs1,&amp;</div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;                 <span class="stringliteral">&quot;MSTAR_S coefficient for RH18 in stabilizing limit. &quot;</span>//&amp;</div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;                 <span class="stringliteral">&quot;The value of 0.2 is given in RH18 and increasing it increases &quot;</span>//&amp;</div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;                 <span class="stringliteral">&quot;MSTAR in the presence of a stabilizing surface buoyancy flux.&quot;</span>, &amp;</div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.2, do_not_log=(cs%mstar_scheme/=mstar_from_rh18))</div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RH18_MSTAR_CS2&quot;</span>, cs%RH18_mstar_cs2,&amp;</div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;                 <span class="stringliteral">&quot;MSTAR_S exponent for RH18 in stabilizing limit. &quot;</span>//&amp;</div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;                 <span class="stringliteral">&quot;The value of 0.4 is given in RH18 and increasing it increases MSTAR &quot;</span>//&amp;</div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;                 <span class="stringliteral">&quot;exponentially in the presence of a stabilizing surface buoyancy flux.&quot;</span>, &amp;</div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.4, do_not_log=(cs%mstar_scheme/=mstar_from_rh18))</div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160; </div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160; </div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;<span class="comment">!/ Convective turbulence related options</span></div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NSTAR&quot;</span>, cs%nstar, &amp;</div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;                 <span class="stringliteral">&quot;The portion of the buoyant potential energy imparted by &quot;</span>//&amp;</div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;                 <span class="stringliteral">&quot;surface fluxes that is available to drive entrainment &quot;</span>//&amp;</div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;                 <span class="stringliteral">&quot;at the base of mixed layer when that energy is positive.&quot;</span>, &amp;</div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.2)</div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR_CONV_ADJ&quot;</span>, cs%mstar_convect_coef, &amp;</div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;                 <span class="stringliteral">&quot;Coefficient used for reducing mstar during convection &quot;</span>//&amp;</div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;                 <span class="stringliteral">&quot;due to reduction of stable density gradient.&quot;</span>, &amp;</div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160; </div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;<span class="comment">!/ Mixing Length Options</span></div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;  <span class="comment">!### THIS DEFAULT SHOULD BECOME TRUE.</span></div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_MLD_ITERATION&quot;</span>, cs%Use_MLD_iteration, &amp;</div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;                 <span class="stringliteral">&quot;A logical that specifies whether or not to use the &quot;</span>//&amp;</div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;                 <span class="stringliteral">&quot;distance to the bottom of the actively turbulent boundary &quot;</span>//&amp;</div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;                 <span class="stringliteral">&quot;layer to help set the EPBL length scale.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_TRANSITION_SCALE&quot;</span>, cs%transLay_scale, &amp;</div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;                 <span class="stringliteral">&quot;A scale for the mixing length in the transition layer &quot;</span>//&amp;</div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;                 <span class="stringliteral">&quot;at the edge of the boundary layer as a fraction of the &quot;</span>//&amp;</div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;                 <span class="stringliteral">&quot;boundary layer thickness.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.1)</div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;  <span class="keywordflow">if</span> ( cs%Use_MLD_iteration .and. abs(cs%transLay_scale-0.5) &gt;= 0.5) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;If flag USE_MLD_ITERATION is true, then &quot;</span>//&amp;</div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;                 <span class="stringliteral">&quot;EPBL_TRANSITION should be greater than 0 and less than 1.&quot;</span>)</div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160; </div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MLD_ITERATION_GUESS&quot;</span>, cs%MLD_ITERATION_GUESS, &amp;</div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;                 <span class="stringliteral">&quot;A logical that specifies whether or not to use the &quot;</span>//&amp;</div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;                 <span class="stringliteral">&quot;previous timestep MLD as a first guess in the MLD iteration. &quot;</span>//&amp;</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;                 <span class="stringliteral">&quot;The default is false to facilitate reproducibility.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_MLD_TOLERANCE&quot;</span>, cs%MLD_tol, &amp;</div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;                 <span class="stringliteral">&quot;The tolerance for the iteratively determined mixed &quot;</span>//&amp;</div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;                 <span class="stringliteral">&quot;layer depth.  This is only used with USE_MLD_ITERATION.&quot;</span>, &amp;</div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;                 units=<span class="stringliteral">&quot;meter&quot;</span>, default=1.0, scale=us%m_to_Z)</div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_MLD_MAX_ITS&quot;</span>, cs%max_MLD_its, &amp;</div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;                 <span class="stringliteral">&quot;The maximum number of iterations that can be used to find a self-consistent &quot;</span>//&amp;</div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;                 <span class="stringliteral">&quot;mixed layer depth.  For now, due to the use of bisection, the maximum number &quot;</span>//&amp;</div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;                 <span class="stringliteral">&quot;iteractions needed is set by Depth/2^MAX_ITS &lt; EPBL_MLD_TOLERANCE.&quot;</span>, &amp;</div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;                 default=20, do_not_log=.not.cs%Use_MLD_iteration)</div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;  <span class="keywordflow">if</span> (.not.cs%Use_MLD_iteration) cs%Max_MLD_Its = 1</div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_MIN_MIX_LEN&quot;</span>, cs%min_mix_len, &amp;</div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;                 <span class="stringliteral">&quot;The minimum mixing length scale that will be used &quot;</span>//&amp;</div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;                 <span class="stringliteral">&quot;by ePBL.  The default (0) does not set a minimum.&quot;</span>, &amp;</div>
<div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;                 units=<span class="stringliteral">&quot;meter&quot;</span>, default=0.0, scale=us%m_to_Z)</div>
<div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160; </div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MIX_LEN_EXPONENT&quot;</span>, cs%MixLenExponent, &amp;</div>
<div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;                 <span class="stringliteral">&quot;The exponent applied to the ratio of the distance to the MLD &quot;</span>//&amp;</div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;                 <span class="stringliteral">&quot;and the MLD depth which determines the shape of the mixing length. &quot;</span>//&amp;</div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;                 <span class="stringliteral">&quot;This is only used if USE_MLD_ITERATION is True.&quot;</span>, &amp;</div>
<div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=2.0)</div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160; </div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;<span class="comment">!/ Turbulent velocity scale in mixing coefficient</span></div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_VEL_SCALE_SCHEME&quot;</span>, tmpstr, &amp;</div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;                 <span class="stringliteral">&quot;Selects the method for translating TKE into turbulent velocities. &quot;</span>//&amp;</div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;                 <span class="stringliteral">&quot;Valid values are: \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;                 <span class="stringliteral">&quot;\t CUBE_ROOT_TKE  - A constant times the cube root of remaining TKE. \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;                 <span class="stringliteral">&quot;\t REICHL_H18 - Use the scheme based on a combination of w* and v* as \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;                 <span class="stringliteral">&quot;\t              documented in Reichl &amp; Hallberg, 2018.&quot;</span>, &amp;</div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;                 default=root_tke_string, do_not_log=.true.)</div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_VEL_SCALE_MODE&quot;</span>, wt_mode, default=-1)</div>
<div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;  <span class="keywordflow">if</span> (wt_mode == 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;    tmpstr = root_tke_string</div>
<div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;Use EPBL_VEL_SCALE_SCHEME = CUBE_ROOT_TKE instead of the archaic EPBL_VEL_SCALE_MODE = 0.&quot;</span>)</div>
<div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;  <span class="keywordflow">elseif</span> (wt_mode == 1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;    tmpstr = rh18_string</div>
<div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;Use EPBL_VEL_SCALE_SCHEME = REICHL_H18 instead of the archaic EPBL_VEL_SCALE_MODE = 1.&quot;</span>)</div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;  <span class="keywordflow">elseif</span> (wt_mode &gt;= 2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;An unrecognized value of the obsolete parameter EPBL_VEL_SCALE_MODE was specified.&quot;</span>)</div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;  <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_VEL_SCALE_SCHEME&quot;</span>, tmpstr, &amp;</div>
<div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;                 <span class="stringliteral">&quot;Selects the method for translating TKE into turbulent velocities. &quot;</span>//&amp;</div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;                 <span class="stringliteral">&quot;Valid values are: \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;                 <span class="stringliteral">&quot;\t CUBE_ROOT_TKE  - A constant times the cube root of remaining TKE. \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;                 <span class="stringliteral">&quot;\t REICHL_H18 - Use the scheme based on a combination of w* and v* as \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;                 <span class="stringliteral">&quot;\t              documented in Reichl &amp; Hallberg, 2018.&quot;</span>, &amp;</div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;                 default=root_tke_string)</div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;  tmpstr = uppercase(tmpstr)</div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;  <span class="keywordflow">select case</span> (tmpstr)</div>
<div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;    <span class="keywordflow">case</span> (root_tke_string)</div>
<div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;      cs%wT_scheme = wt_from_croot_tke</div>
<div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;    <span class="keywordflow">case</span> (rh18_string)</div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;      cs%wT_scheme = wt_from_rh18</div>
<div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;<span class="keywordflow">    case default</span></div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;      <span class="keyword">call </span>mom_mesg(<span class="stringliteral">&#39;energetic_PBL_init: EPBL_VEL_SCALE_SCHEME =&quot;&#39;</span>//trim(tmpstr)//<span class="stringliteral">&#39;&quot;&#39;</span>, 0)</div>
<div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;energetic_PBL_init: Unrecognized setting &quot;</span>// &amp;</div>
<div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;            <span class="stringliteral">&quot;EPBL_VEL_SCALE_SCHEME = &quot;</span>//trim(tmpstr)//<span class="stringliteral">&quot; found in input file.&quot;</span>)</div>
<div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;<span class="keywordflow">  end select</span></div>
<div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160; </div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;WSTAR_USTAR_COEF&quot;</span>, cs%wstar_ustar_coef, &amp;</div>
<div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;                 <span class="stringliteral">&quot;A ratio relating the efficiency with which convectively &quot;</span>//&amp;</div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;                 <span class="stringliteral">&quot;released energy is converted to a turbulent velocity, &quot;</span>//&amp;</div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;                 <span class="stringliteral">&quot;relative to mechanically forced TKE. Making this larger &quot;</span>//&amp;</div>
<div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;                 <span class="stringliteral">&quot;increases the BL diffusivity&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0)</div>
<div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_VEL_SCALE_FACTOR&quot;</span>, cs%vstar_scale_fac, &amp;</div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;                 <span class="stringliteral">&quot;An overall nondimensional scaling factor for wT. &quot;</span>//&amp;</div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;                 <span class="stringliteral">&quot;Making this larger increases the PBL diffusivity.&quot;</span>, &amp;</div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0)</div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;VSTAR_SURF_FAC&quot;</span>, cs%vstar_surf_fac,&amp;</div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;                 <span class="stringliteral">&quot;The proportionality times ustar to set vstar at the surface.&quot;</span>, &amp;</div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.2)</div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160; </div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;  <span class="comment">!/ Options related to Langmuir turbulence</span></div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_LA_LI2016&quot;</span>, use_la_windsea, &amp;</div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;       <span class="stringliteral">&quot;A logical to use the Li et al. 2016 (submitted) formula to &quot;</span>//&amp;</div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;       <span class="stringliteral">&quot;determine the Langmuir number.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=.false.)</div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;  <span class="comment">! Note this can be activated in other ways, but this preserves the old method.</span></div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;  <span class="keywordflow">if</span> (use_la_windsea) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;    cs%USE_LT = .true.</div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_LT&quot;</span>, cs%USE_LT, &amp;</div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;                 <span class="stringliteral">&quot;A logical to use a LT parameterization.&quot;</span>, &amp;</div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=.false.)</div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;  <span class="keywordflow">if</span> (cs%USE_LT) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_LANGMUIR_SCHEME&quot;</span>, tmpstr, &amp;</div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;                 <span class="stringliteral">&quot;EPBL_LANGMUIR_SCHEME selects the method for including Langmuir turbulence. &quot;</span>//&amp;</div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;                 <span class="stringliteral">&quot;Valid values are: \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;                 <span class="stringliteral">&quot;\t NONE     - Do not do any extra mixing due to Langmuir turbulence \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;                 <span class="stringliteral">&quot;\t RESCALE  - Use a multiplicative rescaling of mstar to account for Langmuir turbulence \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;                 <span class="stringliteral">&quot;\t ADDITIVE - Add a Langmuir turblence contribution to mstar to other contributions&quot;</span>, &amp;</div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;                 default=none_string, do_not_log=.true.)</div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_ENHANCE&quot;</span>, lt_enhance, default=-1)</div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;    <span class="keywordflow">if</span> (lt_enhance == 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;      tmpstr = none_string</div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;      <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;Use EPBL_LANGMUIR_SCHEME = NONE instead of the archaic LT_ENHANCE = 0.&quot;</span>)</div>
<div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;    <span class="keywordflow">elseif</span> (lt_enhance == 1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;You are using a legacy LT_ENHANCE mode in ePBL that has been phased out. &quot;</span>//&amp;</div>
<div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;                            <span class="stringliteral">&quot;If you need to use this setting please report this error.  Also use &quot;</span>//&amp;</div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;                            <span class="stringliteral">&quot;EPBL_LANGMUIR_SCHEME to specify the scheme for mstar.&quot;</span>)</div>
<div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;    <span class="keywordflow">elseif</span> (lt_enhance == 2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;      tmpstr = rescaled_string</div>
<div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;      <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;Use EPBL_LANGMUIR_SCHEME = RESCALE instead of the archaic LT_ENHANCE = 2.&quot;</span>)</div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;    <span class="keywordflow">elseif</span> (lt_enhance == 3) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;      tmpstr = additive_string</div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;      <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;Use EPBL_LANGMUIR_SCHEME = ADDITIVE instead of the archaic LT_ENHANCE = 3.&quot;</span>)</div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;    <span class="keywordflow">elseif</span> (lt_enhance &gt; 3) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;An unrecognized value of the obsolete parameter LT_ENHANCE was specified.&quot;</span>)</div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;    <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_LANGMUIR_SCHEME&quot;</span>, tmpstr, &amp;</div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;                 <span class="stringliteral">&quot;EPBL_LANGMUIR_SCHEME selects the method for including Langmuir turbulence. &quot;</span>//&amp;</div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;                 <span class="stringliteral">&quot;Valid values are: \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;                 <span class="stringliteral">&quot;\t NONE     - Do not do any extra mixing due to Langmuir turbulence \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;                 <span class="stringliteral">&quot;\t RESCALE  - Use a multiplicative rescaling of mstar to account for Langmuir turbulence \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;                 <span class="stringliteral">&quot;\t ADDITIVE - Add a Langmuir turblence contribution to mstar to other contributions&quot;</span>, &amp;</div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;                 default=none_string)</div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;    tmpstr = uppercase(tmpstr)</div>
<div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;    <span class="keywordflow">select case</span> (tmpstr)</div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;      <span class="keywordflow">case</span> (none_string)</div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;        cs%LT_enhance_form = no_langmuir</div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;      <span class="keywordflow">case</span> (rescaled_string)</div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;        cs%LT_enhance_form = langmuir_rescale</div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;      <span class="keywordflow">case</span> (additive_string)</div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;        cs%LT_enhance_form = langmuir_add</div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;<span class="keywordflow">      case default</span></div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;        <span class="keyword">call </span>mom_mesg(<span class="stringliteral">&#39;energetic_PBL_init: EPBL_LANGMUIR_SCHEME =&quot;&#39;</span>//trim(tmpstr)//<span class="stringliteral">&#39;&quot;&#39;</span>, 0)</div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;energetic_PBL_init: Unrecognized setting &quot;</span>// &amp;</div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;              <span class="stringliteral">&quot;EPBL_LANGMUIR_SCHEME = &quot;</span>//trim(tmpstr)//<span class="stringliteral">&quot; found in input file.&quot;</span>)</div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;<span class="keywordflow">    end select</span></div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160; </div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_ENHANCE_COEF&quot;</span>, cs%LT_ENHANCE_COEF, &amp;</div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;                 <span class="stringliteral">&quot;Coefficient for Langmuir enhancement of mstar&quot;</span>, &amp;</div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.447, do_not_log=(cs%LT_enhance_form==no_langmuir))</div>
<div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_ENHANCE_EXP&quot;</span>, cs%LT_ENHANCE_EXP, &amp;</div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;                 <span class="stringliteral">&quot;Exponent for Langmuir enhancementt of mstar&quot;</span>, &amp;</div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=-1.33,  do_not_log=(cs%LT_enhance_form==no_langmuir))</div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_MOD_LAC1&quot;</span>, cs%LaC_MLDoEK, &amp;</div>
<div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;                 <span class="stringliteral">&quot;Coefficient for modification of Langmuir number due to &quot;</span>//&amp;</div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;                 <span class="stringliteral">&quot;MLD approaching Ekman depth.&quot;</span>, &amp;</div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=-0.87,  do_not_log=(cs%LT_enhance_form==no_langmuir))</div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_MOD_LAC2&quot;</span>, cs%LaC_MLDoOB_stab, &amp;</div>
<div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;                 <span class="stringliteral">&quot;Coefficient for modification of Langmuir number due to &quot;</span>//&amp;</div>
<div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;                 <span class="stringliteral">&quot;MLD approaching stable Obukhov depth.&quot;</span>, &amp;</div>
<div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0,  do_not_log=(cs%LT_enhance_form==no_langmuir))</div>
<div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_MOD_LAC3&quot;</span>, cs%LaC_MLDoOB_un, &amp;</div>
<div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;                 <span class="stringliteral">&quot;Coefficient for modification of Langmuir number due to &quot;</span>//&amp;</div>
<div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;                 <span class="stringliteral">&quot;MLD approaching unstable Obukhov depth.&quot;</span>, &amp;</div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0,  do_not_log=(cs%LT_enhance_form==no_langmuir))</div>
<div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_MOD_LAC4&quot;</span>, cs%Lac_EKoOB_stab, &amp;</div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;                 <span class="stringliteral">&quot;Coefficient for modification of Langmuir number due to &quot;</span>//&amp;</div>
<div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;                 <span class="stringliteral">&quot;ratio of Ekman to stable Obukhov depth.&quot;</span>, &amp;</div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.95,  do_not_log=(cs%LT_enhance_form==no_langmuir))</div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LT_MOD_LAC5&quot;</span>, cs%Lac_EKoOB_un, &amp;</div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;                 <span class="stringliteral">&quot;Coefficient for modification of Langmuir number due to &quot;</span>//&amp;</div>
<div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;                 <span class="stringliteral">&quot;ratio of Ekman to unstable Obukhov depth.&quot;</span>, &amp;</div>
<div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.95,  do_not_log=(cs%LT_enhance_form==no_langmuir))</div>
<div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160; </div>
<div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160; </div>
<div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;<span class="comment">!/ Logging parameters</span></div>
<div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;  <span class="comment">! This gives a minimum decay scale that is typically much less than Angstrom.</span></div>
<div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;  cs%ustar_min = 2e-4*cs%omega*(gv%Angstrom_Z + gv%H_to_Z*gv%H_subroundoff)</div>
<div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;  <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;EPBL_USTAR_MIN&quot;</span>, cs%ustar_min*us%Z_to_m*us%s_to_T, &amp;</div>
<div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;                 <span class="stringliteral">&quot;The (tiny) minimum friction velocity used within the &quot;</span>//&amp;</div>
<div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;                 <span class="stringliteral">&quot;ePBL code, derived from OMEGA and ANGSTROM.&quot;</span>, units=<span class="stringliteral">&quot;m s-1&quot;</span>)</div>
<div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160; </div>
<div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160; </div>
<div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;<span class="comment">!/ Checking output flags</span></div>
<div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;  r_z3_t3_to_kg_s3 = us%R_to_kg_m3 * us%Z_to_m**3  * us%s_to_T**3</div>
<div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;  cs%id_ML_depth = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_h_ML&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;      time, <span class="stringliteral">&#39;Surface boundary layer depth&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>, conversion=us%Z_to_m, &amp;</div>
<div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;      cmor_long_name=<span class="stringliteral">&#39;Ocean Mixed Layer Thickness Defined by Mixing Scheme&#39;</span>)</div>
<div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;  cs%id_TKE_wind = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_TKE_wind&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;      time, <span class="stringliteral">&#39;Wind-stirring source of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;m3 s-3&#39;</span>, conversion=r_z3_t3_to_kg_s3)</div>
<div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;  cs%id_TKE_MKE = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_TKE_MKE&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;      time, <span class="stringliteral">&#39;Mean kinetic energy source of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;m3 s-3&#39;</span>, conversion=r_z3_t3_to_kg_s3)</div>
<div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;  cs%id_TKE_conv = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_TKE_conv&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;      time, <span class="stringliteral">&#39;Convective source of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;m3 s-3&#39;</span>, conversion=r_z3_t3_to_kg_s3)</div>
<div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;  cs%id_TKE_forcing = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_TKE_forcing&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;      time, <span class="stringliteral">&#39;TKE consumed by mixing surface forcing or penetrative shortwave radation &#39;</span>//&amp;</div>
<div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;            <span class="stringliteral">&#39;through model layers&#39;</span>, <span class="stringliteral">&#39;m3 s-3&#39;</span>, conversion=r_z3_t3_to_kg_s3)</div>
<div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;  cs%id_TKE_mixing = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_TKE_mixing&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;      time, <span class="stringliteral">&#39;TKE consumed by mixing that deepens the mixed layer&#39;</span>, <span class="stringliteral">&#39;m3 s-3&#39;</span>, conversion=r_z3_t3_to_kg_s3)</div>
<div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;  cs%id_TKE_mech_decay = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_TKE_mech_decay&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;      time, <span class="stringliteral">&#39;Mechanical energy decay sink of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;m3 s-3&#39;</span>, conversion=r_z3_t3_to_kg_s3)</div>
<div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;  cs%id_TKE_conv_decay = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ePBL_TKE_conv_decay&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;      time, <span class="stringliteral">&#39;Convective energy decay sink of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;m3 s-3&#39;</span>, conversion=r_z3_t3_to_kg_s3)</div>
<div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;  cs%id_Mixing_Length = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;Mixing_Length&#39;</span>, diag%axesTi, &amp;</div>
<div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;      time, <span class="stringliteral">&#39;Mixing Length that is used&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>, conversion=us%Z_to_m)</div>
<div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;  cs%id_Velocity_Scale = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;Velocity_Scale&#39;</span>, diag%axesTi, &amp;</div>
<div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;      time, <span class="stringliteral">&#39;Velocity Scale that is used.&#39;</span>, <span class="stringliteral">&#39;m s-1&#39;</span>, conversion=us%Z_to_m*us%s_to_T)</div>
<div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;  cs%id_MSTAR_mix = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MSTAR&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;      time, <span class="stringliteral">&#39;Total mstar that is used.&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div>
<div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160; </div>
<div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;  <span class="keywordflow">if</span> (cs%use_LT) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;    cs%id_LA = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;LA&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;        time, <span class="stringliteral">&#39;Langmuir number.&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div>
<div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;    cs%id_LA_mod = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;LA_MOD&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;        time, <span class="stringliteral">&#39;Modified Langmuir number.&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div>
<div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;    cs%id_MSTAR_LT = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MSTAR_LT&#39;</span>, diag%axesT1, &amp;</div>
<div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;        time, <span class="stringliteral">&#39;Increase in mstar due to Langmuir Turbulence.&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div>
<div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160; </div>
<div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ENABLE_THERMODYNAMICS&quot;</span>, use_temperature, &amp;</div>
<div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;                 <span class="stringliteral">&quot;If true, temperature and salinity are used as state &quot;</span>//&amp;</div>
<div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;                 <span class="stringliteral">&quot;variables.&quot;</span>, default=.true.)</div>
<div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160; </div>
<div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;  <span class="keywordflow">if</span> (max(cs%id_TKE_wind, cs%id_TKE_MKE, cs%id_TKE_conv, &amp;</div>
<div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;          cs%id_TKE_mixing, cs%id_TKE_mech_decay, cs%id_TKE_forcing, &amp;</div>
<div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;          cs%id_TKE_conv_decay) &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_wind, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_MKE, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_conv, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_forcing, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_mixing, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_mech_decay, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_conv_decay, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160; </div>
<div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;    cs%TKE_diagnostics = .true.</div>
<div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;  <span class="keywordflow">if</span> (cs%id_Velocity_Scale&gt;0) <span class="keyword">call </span>safe_alloc_alloc(cs%Velocity_Scale, isd, ied, jsd, jed, gv%ke+1)</div>
<div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;  <span class="keywordflow">if</span> (cs%id_Mixing_Length&gt;0) <span class="keyword">call </span>safe_alloc_alloc(cs%Mixing_Length, isd, ied, jsd, jed, gv%ke+1)</div>
<div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160; </div>
<div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;  <span class="keyword">call </span>safe_alloc_alloc(cs%ML_depth, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;  <span class="keywordflow">if</span> (max(cs%id_mstar_mix, cs%id_LA, cs%id_LA_mod, cs%id_MSTAR_LT ) &gt;0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%Mstar_mix, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%LA, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%LA_MOD, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%MSTAR_LT, isd, ied, jsd, jed)</div>
<div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00217">additive_string</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00211">constant_string</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00204">langmuir_add</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00202">langmuir_rescale</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00053">mom_error_handler::mom_mesg()</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00198">mstar_from_ekman</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00200">mstar_from_rh18</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00201">no_langmuir</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00215">none_string</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00212">om4_string</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00216">rescaled_string</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00213">rh18_string</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00214">root_tke_string</a>, <a class="el" href="MOM__string__functions_8F90_source.html#l00042">mom_string_functions::uppercase()</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00197">use_fixed_mstar</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00206">wt_from_croot_tke</a>, and <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00208">wt_from_rh18</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_ad9fa0dc4ba4e126ec686b44a5829c2e8_cgraph.svg" width="542" height="183"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a01291f3e97cfdcf58866a1e9b0bcfc26"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a01291f3e97cfdcf58866a1e9b0bcfc26">&#9670;&nbsp;</a></span>epbl_column()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_energetic_pbl::epbl_column </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>T0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>S0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>dSV_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>dSV_dS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>TKE_forcing</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>B_flux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>absf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>u_star</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>u_star_mean</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(inout)&#160;</td>
          <td class="paramname"><em>MLD_io</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szk_(gv)+1), intent(out)&#160;</td>
          <td class="paramname"><em>Kd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szk_(gv)+1), intent(out)&#160;</td>
          <td class="paramname"><em>mixvel</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szk_(gv)+1), intent(out)&#160;</td>
          <td class="paramname"><em>mixlen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__energetic__pbl_1_1energetic__pbl__cs.html">energetic_pbl_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__energetic__pbl_1_1epbl__column__diags.html">epbl_column_diags</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>eCD</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>dt_diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(wave_parameters_cs), optional, pointer&#160;</td>
          <td class="paramname"><em>Waves</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout), optional&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in), optional&#160;</td>
          <td class="paramname"><em>i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in), optional&#160;</td>
          <td class="paramname"><em>j</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine determines the diffusivities from the integrated energetics mixed layer model for a single column of water. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u</td><td>Zonal velocities interpolated to h points [L T-1 ~&gt; m s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v</td><td>Zonal velocities interpolated to h points [L T-1 ~&gt; m s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">t0</td><td>The initial layer temperatures [degC]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">s0</td><td>The initial layer salinities [ppt]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dsv_dt</td><td>The partial derivative of in-situ specific volume with potential temperature [R-1 degC-1 ~&gt; m3 kg-1 degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dsv_ds</td><td>The partial derivative of in-situ specific volume with salinity [R-1 ppt-1 ~&gt; m3 kg-1 ppt-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tke_forcing</td><td>The forcing requirements to homogenize the forcing that has been applied to each layer [R Z3 T-2 ~&gt; J m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">b_flux</td><td>The surface buoyancy flux [Z2 T-3 ~&gt; m2 s-3] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">absf</td><td>The absolute value of the Coriolis parameter [T-1 ~&gt; s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u_star</td><td>The surface friction velocity [Z T-1 ~&gt; m s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u_star_mean</td><td>The surface friction velocity without any contribution from unresolved gustiness [Z T-1 ~&gt; m s-1]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">mld_io</td><td>A first guess at the mixed layer depth on input, and the calculated mixed layer depth on output [Z ~&gt; m]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment [T ~&gt; s]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">kd</td><td>The diagnosed diffusivities at interfaces </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">mixvel</td><td>The mixing velocity scale used in Kd </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">mixlen</td><td>The mixing length scale used in Kd [Z ~&gt; m]. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to mixedlayer_init. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ecd</td><td>A container for passing around diagnostics. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_diag</td><td>The diagnostic time step, which may be less than dt if there are two calls to mixedlayer [T ~&gt; s]. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">waves</td><td>Wave CS for Langmuir turbulence </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">i</td><td>The i-index to work on (used for Waves) </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>The i-index to work on (used for Waves) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00538">538</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">     !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>    :: US<span class="comment">     !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>, <span class="keywordtype">intent(in)</span>  :: h<span class="comment">      !&lt; Layer thicknesses [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>, <span class="keywordtype">intent(in)</span>  :: u<span class="comment">      !&lt; Zonal velocities interpolated to h points</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="comment">                                                   !! [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>, <span class="keywordtype">intent(in)</span>  :: v<span class="comment">      !&lt; Zonal velocities interpolated to h points</span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;<span class="comment">                                                   !! [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>, <span class="keywordtype">intent(in)</span>  :: T0<span class="comment">     !&lt; The initial layer temperatures [degC].</span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>, <span class="keywordtype">intent(in)</span>  :: S0<span class="comment">     !&lt; The initial layer salinities [ppt].</span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160; </div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>, <span class="keywordtype">intent(in)</span>  :: dSV_dT<span class="comment"> !&lt; The partial derivative of in-situ specific</span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="comment">                                                   !! volume with potential temperature</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="comment">                                                   !! [R-1 degC-1 ~&gt; m3 kg-1 degC-1].</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>, <span class="keywordtype">intent(in)</span>  :: dSV_dS<span class="comment"> !&lt; The partial derivative of in-situ specific</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="comment">                                                   !! volume with salinity [R-1 ppt-1 ~&gt; m3 kg-1 ppt-1].</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>, <span class="keywordtype">intent(in)</span>  :: TKE_forcing<span class="comment"> !&lt; The forcing requirements to homogenize the</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="comment">                                                   !! forcing that has been applied to each layer</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="comment">                                                   !! [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: B_flux<span class="comment"> !&lt; The surface buoyancy flux [Z2 T-3 ~&gt; m2 s-3]</span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: absf<span class="comment">   !&lt; The absolute value of the Coriolis parameter [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: u_star<span class="comment"> !&lt; The surface friction velocity [Z T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: u_star_mean<span class="comment"> !&lt; The surface friction velocity without any</span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="comment">                                                   !! contribution from unresolved gustiness  [Z T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(inout)</span> :: MLD_io<span class="comment"> !&lt; A first guess at the mixed layer depth on input, and</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="comment">                                                   !! the calculated mixed layer depth on output [Z ~&gt; m].</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">     !&lt; Time increment [T ~&gt; s].</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;                           <span class="keywordtype">intent(out)</span>   :: Kd<span class="comment">     !&lt; The diagnosed diffusivities at interfaces</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="comment">                                                   !! [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                           <span class="keywordtype">intent(out)</span>   :: mixvel<span class="comment"> !&lt; The mixing velocity scale used in Kd</span></div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;<span class="comment">                                                   !! [Z T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                           <span class="keywordtype">intent(out)</span>   :: mixlen<span class="comment"> !&lt; The mixing length scale used in Kd [Z ~&gt; m].</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;  <span class="keywordtype">type</span>(energetic_PBL_CS),  <span class="keywordtype">pointer</span>       :: CS<span class="comment">     !&lt; The control structure returned by a previous</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;<span class="comment">                                                   !! call to mixedlayer_init.</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;  <span class="keywordtype">type</span>(ePBL_column_diags), <span class="keywordtype">intent(inout)</span> :: eCD<span class="comment">    !&lt; A container for passing around diagnostics.</span></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;<span class="keywordtype">  real</span>,          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: dt_diag<span class="comment">   !&lt; The diagnostic time step, which may be less</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;<span class="comment">                                                   !! than dt if there are two calls to mixedlayer [T ~&gt; s].</span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;  <span class="keywordtype">type</span>(wave_parameters_CS), &amp;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">pointer</span>       :: Waves<span class="comment">  !&lt; Wave CS for Langmuir turbulence</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), &amp;</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">intent(inout)</span> :: G<span class="comment">      !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;  <span class="keywordtype">integer</span>,       <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: i<span class="comment">      !&lt; The i-index to work on (used for Waves)</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;  <span class="keywordtype">integer</span>,       <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: j<span class="comment">      !&lt; The i-index to work on (used for Waves)</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160; </div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="comment">!    This subroutine determines the diffusivities in a single column from the integrated energetics</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="comment">!  planetary boundary layer (ePBL) model.  It assumes that heating, cooling and freshwater fluxes</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="comment">!  have already been applied.  All calculations are done implicitly, and there</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;<span class="comment">!  is no stability limit on the time step.</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;<span class="comment">!    For each interior interface, first discard the TKE to account for mixing</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="comment">! of shortwave radiation through the next denser cell.  Next drive mixing based</span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;<span class="comment">! on the local? values of ustar + wstar, subject to available energy.  This</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="comment">! step sets the value of Kd(K).  Any remaining energy is then subject to decay</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="comment">! before being handed off to the next interface.  mech_TKE and conv_PErel are treated</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="comment">! separately for the purposes of decay, but are used proportionately to drive</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;<span class="comment">! mixing.</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160; </div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: &amp;</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    pres_Z, &amp;       <span class="comment">! Interface pressures with a rescaling factor to convert interface height</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                    <span class="comment">! movements into changes in column potential energy [R Z2 T-2 ~&gt; kg m-1 s-2].</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    hb_hs           <span class="comment">! The distance from the bottom over the thickness of the</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                    <span class="comment">! water column [nondim].</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;<span class="keywordtype">  real</span> :: mech_TKE  <span class="comment">!   The mechanically generated turbulent kinetic energy</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                    <span class="comment">! available for mixing over a time step [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="keywordtype">  real</span> :: conv_PErel <span class="comment">! The potential energy that has been convectively released</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                    <span class="comment">! during this timestep [R Z3 T-2 ~&gt; J m-2]. A portion nstar_FC</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;                    <span class="comment">! of conv_PErel is available to drive mixing.</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;<span class="keywordtype">  real</span> :: htot      <span class="comment">!   The total depth of the layers above an interface [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<span class="keywordtype">  real</span> :: uhtot     <span class="comment">!   The depth integrated zonal and meridional velocities in the</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="keywordtype">  real</span> :: vhtot     <span class="comment">! layers above [H L T-1 ~&gt; m2 s-1 or kg m-1 s-1].</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;<span class="keywordtype">  real</span> :: Idecay_len_TKE  <span class="comment">! The inverse of a turbulence decay length scale [H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="keywordtype">  real</span> :: h_sum     <span class="comment">! The total thickness of the water column [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160; </div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: &amp;</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    dT_to_dColHt, &amp; <span class="comment">! Partial derivative of the total column height with the temperature changes</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;                    <span class="comment">! within a layer [Z degC-1 ~&gt; m degC-1].</span></div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    ds_to_dcolht, &amp; <span class="comment">! Partial derivative of the total column height with the salinity changes</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                    <span class="comment">! within a layer  [Z ppt-1 ~&gt; m ppt-1].</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    dt_to_dpe, &amp;    <span class="comment">! Partial derivatives of column potential energy with the temperature</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                    <span class="comment">! changes within a layer, in [R Z3 T-2 degC-1 ~&gt; J m-2 degC-1].</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    ds_to_dpe, &amp;    <span class="comment">! Partial derivatives of column potential energy with the salinity changes</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                    <span class="comment">! within a layer, in [R Z3 T-2 ppt-1 ~&gt; J m-2 ppt-1].</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    dt_to_dcolht_a, &amp; <span class="comment">! Partial derivative of the total column height with the temperature changes</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                    <span class="comment">! within a layer, including the implicit effects  of mixing with layers higher</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                    <span class="comment">! in the water column [Z degC-1 ~&gt; m degC-1].</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    ds_to_dcolht_a, &amp; <span class="comment">! Partial derivative of the total column height with the salinity changes</span></div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                    <span class="comment">! within a layer, including the implicit effects  of mixing with layers higher</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                    <span class="comment">! in the water column [Z ppt-1 ~&gt; m ppt-1].</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    dt_to_dpe_a, &amp;  <span class="comment">! Partial derivatives of column potential energy with the temperature changes</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                    <span class="comment">! within a layer, including the implicit effects of mixing with layers higher</span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;                    <span class="comment">! in the water column [R Z3 T-2 degC-1 ~&gt; J m-2 degC-1].</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    ds_to_dpe_a, &amp;  <span class="comment">! Partial derivative of column potential energy with the salinity changes</span></div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                    <span class="comment">! within a layer, including the implicit effects of mixing with layers higher</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;                    <span class="comment">! in the water column [R Z3 T-2 ppt-1 ~&gt; J m-2 ppt-1].</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    c1, &amp;           <span class="comment">! c1 is used by the tridiagonal solver [nondim].</span></div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    te, &amp;           <span class="comment">! Estimated final values of T in the column [degC].</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    se, &amp;           <span class="comment">! Estimated final values of S in the column [ppt].</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    dte, &amp;          <span class="comment">! Running (1-way) estimates of temperature change [degC].</span></div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    dse, &amp;          <span class="comment">! Running (1-way) estimates of salinity change [ppt].</span></div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;    th_a, &amp;         <span class="comment">! An effective temperature times a thickness in the layer above, including implicit</span></div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                    <span class="comment">! mixing effects with other yet higher layers [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    sh_a, &amp;         <span class="comment">! An effective salinity times a thickness in the layer above, including implicit</span></div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                    <span class="comment">! mixing effects with other yet higher layers [ppt H ~&gt; ppt m or ppt kg m-2].</span></div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    th_b, &amp;         <span class="comment">! An effective temperature times a thickness in the layer below, including implicit</span></div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;                    <span class="comment">! mixing effects with other yet lower layers [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    sh_b            <span class="comment">! An effective salinity times a thickness in the layer below, including implicit</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                    <span class="comment">! mixing effects with other yet lower layers [ppt H ~&gt; ppt m or ppt kg m-2].</span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: &amp;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;    MixLen_shape, &amp; <span class="comment">! A nondimensional shape factor for the mixing length that</span></div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                    <span class="comment">! gives it an appropriate assymptotic value at the bottom of</span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                    <span class="comment">! the boundary layer.</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;    kddt_h          <span class="comment">! The diapycnal diffusivity times a timestep divided by the</span></div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                    <span class="comment">! average thicknesses around a layer [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;<span class="keywordtype">  real</span> :: b1        <span class="comment">! b1 is inverse of the pivot used by the tridiagonal solver [H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;<span class="keywordtype">  real</span> :: hp_a      <span class="comment">! An effective pivot thickness of the layer including the effects</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                    <span class="comment">! of coupling with layers above [H ~&gt; m or kg m-2].  This is the first term</span></div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                    <span class="comment">! in the denominator of b1 in a downward-oriented tridiagonal solver.</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="keywordtype">  real</span> :: h_neglect <span class="comment">! A thickness that is so small it is usually lost</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                    <span class="comment">! in roundoff and can be neglected [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="keywordtype">  real</span> :: dMass     <span class="comment">! The mass per unit area within a layer [Z R ~&gt; kg m-2].</span></div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;<span class="keywordtype">  real</span> :: dPres     <span class="comment">! The hydrostatic pressure change across a layer [R Z2 T-2 ~&gt; kg m-1 s-2 = Pa = J m-3].</span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="keywordtype">  real</span> :: dMKE_max  <span class="comment">! The maximum amount of mean kinetic energy that could be</span></div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;                    <span class="comment">! converted to turbulent kinetic energy if the velocity in</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;                    <span class="comment">! the layer below an interface were homogenized with all of</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                    <span class="comment">! the water above the interface [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;<span class="keywordtype">  real</span> :: MKE2_Hharm <span class="comment">! Twice the inverse of the harmonic mean of the thickness</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                    <span class="comment">! of a layer and the thickness of the water above, used in</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                    <span class="comment">! the MKE conversion equation [H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160; </div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="keywordtype">  real</span> :: dt_h      <span class="comment">! The timestep divided by the averages of the thicknesses around</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                    <span class="comment">! a layer, times a thickness conversion factor [H T m-2 ~&gt; s m-1 or kg s m-4].</span></div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="keywordtype">  real</span> :: h_bot     <span class="comment">! The distance from the bottom [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="keywordtype">  real</span> :: h_rsum    <span class="comment">! The running sum of h from the top [Z ~&gt; m].</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="keywordtype">  real</span> :: I_hs      <span class="comment">! The inverse of h_sum [H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="keywordtype">  real</span> :: I_MLD     <span class="comment">! The inverse of the current value of MLD [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="keywordtype">  real</span> :: h_tt      <span class="comment">! The distance from the surface or up to the next interface</span></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;                    <span class="comment">! that did not exhibit turbulent mixing from this scheme plus</span></div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;                    <span class="comment">! a surface mixing roughness length given by h_tt_min [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;<span class="keywordtype">  real</span> :: h_tt_min  <span class="comment">! A surface roughness length [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160; </div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="keywordtype">  real</span> :: C1_3      <span class="comment">! = 1/3.</span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="keywordtype">  real</span> :: I_dtrho   <span class="comment">! 1.0 / (dt * Rho0) times conversion factors in [m3 Z-3 R-1 T2 s-3 ~&gt; m3 kg-1 s-1].</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;                    <span class="comment">! This is used convert TKE back into ustar^3.</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;<span class="keywordtype">  real</span> :: vstar     <span class="comment">! An in-situ turbulent velocity [Z T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;<span class="keywordtype">  real</span> :: mstar_total <span class="comment">! The value of mstar used in ePBL [nondim]</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="keywordtype">  real</span> :: mstar_LT  <span class="comment">! An addition to mstar due to Langmuir turbulence [nondim] (output for diagnostic)</span></div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;<span class="keywordtype">  real</span> :: MLD_output <span class="comment">! The mixed layer depth output from this routine [Z ~&gt; m].</span></div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="keywordtype">  real</span> :: LA        <span class="comment">! The value of the Langmuir number [nondim]</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;<span class="keywordtype">  real</span> :: LAmod     <span class="comment">! The modified Langmuir number by convection [nondim]</span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="keywordtype">  real</span> :: hbs_here  <span class="comment">! The local minimum of hb_hs and MixLen_shape, times a</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;                    <span class="comment">! conversion factor from H to Z [Z H-1 ~&gt; 1 or m3 kg-1].</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;<span class="keywordtype">  real</span> :: nstar_FC  <span class="comment">! The fraction of conv_PErel that can be converted to mixing [nondim].</span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="keywordtype">  real</span> :: TKE_reduc <span class="comment">! The fraction by which TKE and other energy fields are</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;                    <span class="comment">! reduced to support mixing [nondim]. between 0 and 1.</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;<span class="keywordtype">  real</span> :: tot_TKE   <span class="comment">! The total TKE available to support mixing at interface K [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;<span class="keywordtype">  real</span> :: TKE_here  <span class="comment">! The total TKE at this point in the algorithm [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;<span class="keywordtype">  real</span> :: dT_km1_t2 <span class="comment">! A diffusivity-independent term related to the temperature</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;                    <span class="comment">! change in the layer above the interface [degC].</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="keywordtype">  real</span> :: dS_km1_t2 <span class="comment">! A diffusivity-independent term related to the salinity</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;                    <span class="comment">! change in the layer above the interface [ppt].</span></div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="keywordtype">  real</span> :: dTe_term  <span class="comment">! A diffusivity-independent term related to the temperature</span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;                    <span class="comment">! change in the layer below the interface [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;<span class="keywordtype">  real</span> :: dSe_term  <span class="comment">! A diffusivity-independent term related to the salinity</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;                    <span class="comment">! change in the layer above the interface [ppt H ~&gt; ppt m or ppt kg m-2].</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="keywordtype">  real</span> :: dTe_t2    <span class="comment">! A part of dTe_term [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="keywordtype">  real</span> :: dSe_t2    <span class="comment">! A part of dSe_term [ppt H ~&gt; ppt m or ppt kg m-2].</span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<span class="keywordtype">  real</span> :: dPE_conv  <span class="comment">! The convective change in column potential energy [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;<span class="keywordtype">  real</span> :: MKE_src   <span class="comment">! The mean kinetic energy source of TKE due to Kddt_h(K) [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="keywordtype">  real</span> :: dMKE_src_dK  <span class="comment">! The partial derivative of MKE_src with Kddt_h(K) [R Z3 T-2 H-1 ~&gt; J m-3 or J kg-1].</span></div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;<span class="keywordtype">  real</span> :: Kd_guess0    <span class="comment">! A first guess of the diapycnal diffusivity [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;<span class="keywordtype">  real</span> :: PE_chg_g0    <span class="comment">! The potential energy change when Kd is Kd_guess0 [R Z3 T-2 ~&gt; J m-2]</span></div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;  <span class="comment">!### The following might be unused.</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="keywordtype">  real</span> :: dPEa_dKd_g0  <span class="comment">! The derivative of the change in the potential energy of the column above an interface</span></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                       <span class="comment">! with the diffusivity when the Kd is Kd_guess0 [R Z T-1 ~&gt; J s m-4]</span></div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;<span class="keywordtype">  real</span> :: Kddt_h_g0    <span class="comment">! The first guess diapycnal diffusivity times a timestep divided</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;                       <span class="comment">! by the average thicknesses around a layer [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="keywordtype">  real</span> :: PE_chg_max   <span class="comment">! The maximum PE change for very large values of Kddt_h(K) [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;<span class="keywordtype">  real</span> :: dPEc_dKd_Kd0 <span class="comment">! The partial derivative of PE change with Kddt_h(K)</span></div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;                       <span class="comment">! for very small values of Kddt_h(K) [R Z3 T-2 H-1 ~&gt; J m-3 or J kg-1].</span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="keywordtype">  real</span> :: PE_chg    <span class="comment">! The change in potential energy due to mixing at an</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;                    <span class="comment">! interface [R Z3 T-2 ~&gt; J m-2], positive for the column increasing</span></div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;                    <span class="comment">! in potential energy (i.e., consuming TKE).</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="keywordtype">  real</span> :: TKE_left  <span class="comment">! The amount of turbulent kinetic energy left for the most</span></div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;                    <span class="comment">! recent guess at Kddt_h(K) [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;<span class="keywordtype">  real</span> :: dPEc_dKd  <span class="comment">! The partial derivative of PE_chg with Kddt_h(K) [R Z3 T-2 H-1 ~&gt; J m-3 or J kg-1].</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;<span class="keywordtype">  real</span> :: TKE_left_min, TKE_left_max <span class="comment">! Maximum and minimum values of TKE_left [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;<span class="keywordtype">  real</span> :: Kddt_h_max, Kddt_h_min <span class="comment">! Maximum and minimum values of Kddt_h(K) [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;<span class="keywordtype">  real</span> :: Kddt_h_guess <span class="comment">! A guess at the value of Kddt_h(K) [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;<span class="keywordtype">  real</span> :: Kddt_h_next  <span class="comment">! The next guess at the value of Kddt_h(K) [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;<span class="keywordtype">  real</span> :: dKddt_h      <span class="comment">! The change between guesses at Kddt_h(K) [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;<span class="keywordtype">  real</span> :: dKddt_h_Newt <span class="comment">! The change between guesses at Kddt_h(K) with Newton&#39;s method [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;<span class="keywordtype">  real</span> :: Kddt_h_newt  <span class="comment">! The Newton&#39;s method next guess for Kddt_h(K) [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;<span class="keywordtype">  real</span> :: exp_kh    <span class="comment">! The nondimensional decay of TKE across a layer [nondim].</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;<span class="keywordtype">  real</span> :: vstar_unit_scale <span class="comment">! A unit converion factor for turbulent velocities [Z T-1 s m-1 ~&gt; 1]</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;  <span class="keywordtype">logical</span> :: use_Newt  <span class="comment">! Use Newton&#39;s method for the next guess at Kddt_h(K).</span></div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;  <span class="keywordtype">logical</span> :: convectively_stable <span class="comment">! If true the water column is convectively stable at this interface.</span></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;  <span class="keywordtype">logical</span> :: sfc_connected   <span class="comment">! If true the ocean is actively turbulent from the present</span></div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;                    <span class="comment">! interface all the way up to the surface.</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;  <span class="keywordtype">logical</span> :: sfc_disconnect <span class="comment">! If true, any turbulence has become disconnected</span></div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;                    <span class="comment">! from the surface.</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160; </div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="comment">! The following are only used for diagnostics.</span></div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;<span class="keywordtype">  real</span> :: dt__diag  <span class="comment">! A copy of dt_diag (if present) or dt [T ~&gt; s].</span></div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;<span class="keywordtype">  real</span> :: I_dtdiag  <span class="comment">!  = 1.0 / dt__diag [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160; </div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;  <span class="comment">!----------------------------------------------------------------------</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;  <span class="comment">!/BGR added Aug24,2016 for adding iteration to get boundary layer depth</span></div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;  <span class="comment">!    - needed to compute new mixing length.</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;<span class="keywordtype">  real</span> :: MLD_guess, MLD_found <span class="comment">! Mixing Layer depth guessed/found for iteration [Z ~&gt; m].</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="keywordtype">  real</span> :: min_MLD   <span class="comment">! Iteration bounds [Z ~&gt; m], which are adjusted at each step</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;<span class="keywordtype">  real</span> :: max_MLD   <span class="comment">!  - These are initialized based on surface/bottom</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                    <span class="comment">!  1. The iteration guesses a value (possibly from prev step or neighbor).</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;                    <span class="comment">!  2. The iteration checks if value is converged, too shallow, or too deep.</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                    <span class="comment">!  3. Based on result adjusts the Max/Min and searches through the water column.</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                    <span class="comment">!  - If using an accurate guess the iteration is very quick (e.g. if MLD doesn&#39;t</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;                    <span class="comment">!    change over timestep).  Otherwise it takes 5-10 passes, but has a high</span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;                    <span class="comment">!    convergence rate.  Other iteration may be tried, but this method seems to</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;                    <span class="comment">!    fail very rarely and the added cost is likely not significant.</span></div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                    <span class="comment">!    Additionally, when it fails to converge it does so in a reasonable</span></div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;                    <span class="comment">!    manner giving a usable guess. When it does fail, it is due to convection</span></div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;                    <span class="comment">!    within the boundary layer.  Likely, a new method e.g. surface_disconnect,</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;                    <span class="comment">!    can improve this.</span></div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;  <span class="keywordtype">logical</span> :: FIRST_OBL     <span class="comment">! Flag for computing &quot;found&quot; Mixing layer depth</span></div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;  <span class="keywordtype">logical</span> :: OBL_converged <span class="comment">! Flag for convergence of MLD</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;  <span class="keywordtype">integer</span> :: OBL_it        <span class="comment">! Iteration counter</span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160; </div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;<span class="keywordtype">  real</span> :: Surface_Scale <span class="comment">! Surface decay scale for vstar</span></div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160; </div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;  <span class="keywordtype">logical</span> :: debug=.false.  <span class="comment">! Change this hard-coded value for debugging.</span></div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160; </div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;  <span class="comment">!  The following arrays are used only for debugging purposes.</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;<span class="keywordtype">  real</span> :: dPE_debug, mixing_debug, taux2, tauy2</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(20)</span> :: TKE_left_itt, PE_chg_itt, Kddt_h_itt, dPEa_dKd_itt, MKE_src_itt</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: mech_TKE_k, conv_PErel_k, nstar_k</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: num_itts</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160; </div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;  <span class="keywordtype">integer</span> :: k, nz, itt, max_itt</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160; </div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;  nz = gv%ke</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160; </div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;energetic_PBL: &quot;</span>//&amp;</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;         <span class="stringliteral">&quot;Module must be initialized before it is used.&quot;</span>)</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160; </div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;  debug = .false. ; <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(ecd%dT_expect) .or. <span class="keyword">allocated</span>(ecd%dS_expect)) debug = .true.</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160; </div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;  h_neglect = gv%H_subroundoff</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160; </div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;  c1_3 = 1.0 / 3.0</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;  dt__diag = dt ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_diag)) dt__diag = dt_diag</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;  i_dtdiag = 1.0 / dt__diag</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;  max_itt = 20</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160; </div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;  h_tt_min = 0.0</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;  i_dtrho = 0.0 ; <span class="keywordflow">if</span> (dt*gv%Rho0 &gt; 0.0) i_dtrho = (us%Z_to_m**3*us%s_to_T**3) / (dt*gv%Rho0)</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;  vstar_unit_scale = us%m_to_Z * us%T_to_s</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160; </div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;  mld_guess = mld_io</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160; </div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;<span class="comment">!   Determine the initial mech_TKE and conv_PErel, including the energy required</span></div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;<span class="comment">! to mix surface heating through the topmost cell, the energy released by mixing</span></div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;<span class="comment">! surface cooling &amp; brine rejection down through the topmost cell, and</span></div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;<span class="comment">! homogenizing the shortwave heating within that cell.  This sets the energy</span></div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;<span class="comment">! and ustar and wstar available to drive mixing at the first interior</span></div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;<span class="comment">! interface.</span></div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160; </div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;  <span class="keywordflow">do</span> k=1,nz+1 ; kd(k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160; </div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;  pres_z(1) = 0.0</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;  <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    dmass = gv%H_to_RZ * h(k)</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    dpres = us%L_to_Z**2 * gv%g_Earth * dmass  <span class="comment">! Equivalent to GV%H_to_Pa * h(k) with rescaling</span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    dt_to_dpe(k) = (dmass * (pres_z(k) + 0.5*dpres)) * dsv_dt(k)</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    ds_to_dpe(k) = (dmass * (pres_z(k) + 0.5*dpres)) * dsv_ds(k)</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    dt_to_dcolht(k) = dmass * dsv_dt(k)</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    ds_to_dcolht(k) = dmass * dsv_ds(k)</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160; </div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    pres_z(k+1) = pres_z(k) + dpres</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160; </div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;  <span class="comment">! Determine the total thickness (h_sum) and the fractional distance from the bottom (hb_hs).</span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;  h_sum = h_neglect ; <span class="keywordflow">do</span> k=1,nz ; h_sum = h_sum + h(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;  i_hs = 0.0 ; <span class="keywordflow">if</span> (h_sum &gt; 0.0) i_hs = 1.0 / h_sum</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;  h_bot = 0.0</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;  hb_hs(nz+1) = 0.0</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;  <span class="keywordflow">do</span> k=nz,1,-1</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    h_bot = h_bot + h(k)</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    hb_hs(k) = h_bot * i_hs</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160; </div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;  mld_output = h(1)*gv%H_to_Z</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160; </div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;  <span class="comment">!/The following lines are for the iteration over MLD</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;  <span class="comment">! max_MLD will initialized as ocean bottom depth</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;  max_mld = 0.0 ; <span class="keywordflow">do</span> k=1,nz ; max_mld = max_mld + h(k)*gv%H_to_Z ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;  <span class="comment">!min_MLD will initialize as 0.</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;  min_mld = 0.0</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160; </div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;  <span class="comment">! If no first guess is provided for MLD, try the middle of the water column</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;  <span class="keywordflow">if</span> (mld_guess &lt;= min_mld) mld_guess = 0.5 * (min_mld + max_mld)</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160; </div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;  <span class="comment">! Iterate to determine a converged EPBL depth.</span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;  obl_converged = .false.</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;  <span class="keywordflow">do</span> obl_it=1,cs%Max_MLD_Its</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160; </div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    <span class="keywordflow">if</span> (.not. obl_converged) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;      <span class="comment">! If not using MLD_Iteration flag loop to only execute once.</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;      <span class="keywordflow">if</span> (.not.cs%Use_MLD_iteration) obl_converged = .true.</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160; </div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;      <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span> ; mech_tke_k(:) = 0.0 ; conv_perel_k(:) = 0.0 ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160; </div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;      <span class="comment">! Reset ML_depth</span></div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;      mld_output = h(1)*gv%H_to_Z</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;      sfc_connected = .true.</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160; </div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;      <span class="comment">!/ Here we get MStar, which is the ratio of convective TKE driven mixing to UStar**3</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;      <span class="keywordflow">if</span> (cs%Use_LT) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        <span class="keyword">call </span>get_langmuir_number(la, g, gv, us, abs(mld_guess), u_star_mean, i, j, &amp;</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;                                 h=h, u_h=u, v_h=v, waves=waves)</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;        <span class="keyword">call </span>find_mstar(cs, us, b_flux, u_star, u_star_mean, mld_guess, absf, &amp;</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;                        mstar_total, langmuir_number=la, convect_langmuir_number=lamod,&amp;</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;                        mstar_lt=mstar_lt)</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;        <span class="keyword">call </span>find_mstar(cs, us, b_flux, u_star, u_star_mean, mld_guess, absf, mstar_total)</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160; </div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;      <span class="comment">!/ Apply MStar to get mech_TKE</span></div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;      <span class="keywordflow">if</span> ((cs%answers_2018) .and. (cs%mstar_scheme==use_fixed_mstar)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;        mech_tke = (dt*mstar_total*gv%Rho0) * u_star**3</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;        mech_tke = mstar_total * (dt*gv%Rho0* u_star**3)</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160; </div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;      <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;        ecd%dTKE_conv = 0.0 ; ecd%dTKE_mixing = 0.0</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;        ecd%dTKE_MKE = 0.0 ; ecd%dTKE_mech_decay = 0.0 ; ecd%dTKE_conv_decay = 0.0</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160; </div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;        ecd%dTKE_wind = mech_tke * i_dtdiag</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;        <span class="keywordflow">if</span> (tke_forcing(1) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;          ecd%dTKE_forcing = max(-mech_tke, tke_forcing(1)) * i_dtdiag</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;          <span class="comment">! eCD%dTKE_unbalanced = min(0.0, TKE_forcing(1) + mech_TKE) * I_dtdiag</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;          ecd%dTKE_forcing = cs%nstar*tke_forcing(1) * i_dtdiag</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;          <span class="comment">! eCD%dTKE_unbalanced = 0.0</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160; </div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;      <span class="keywordflow">if</span> (tke_forcing(1) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        mech_tke = mech_tke + tke_forcing(1)</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        <span class="keywordflow">if</span> (mech_tke &lt; 0.0) mech_tke = 0.0</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        conv_perel = 0.0</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;        conv_perel = tke_forcing(1)</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160; </div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160; </div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;      <span class="comment">! Store in 1D arrays for output.</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1 ; mixvel(k) = 0.0 ; mixlen(k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160; </div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;      <span class="comment">! Determine the mixing shape function MixLen_shape.</span></div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;      <span class="keywordflow">if</span> ((.not.cs%Use_MLD_iteration) .or. &amp;</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;          (cs%transLay_scale &gt;= 1.0) .or. (cs%transLay_scale &lt; 0.0) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;        <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;          mixlen_shape(k) = 1.0</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;      <span class="keywordflow">elseif</span> (mld_guess &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;        <span class="keywordflow">if</span> (cs%transLay_scale &gt; 0.0) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;          mixlen_shape(k) = cs%transLay_scale</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;<span class="keywordflow">        enddo</span> ; <span class="keywordflow">else</span> ; <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;          mixlen_shape(k) = 1.0</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;        <span class="comment">! Reduce the mixing length based on MLD, with a quadratic</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;        <span class="comment">! expression that follows KPP.</span></div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;        i_mld = 1.0 / mld_guess</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;        h_rsum = 0.0</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;        mixlen_shape(1) = 1.0</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;        <span class="keywordflow">do</span> k=2,nz+1</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;          h_rsum = h_rsum + h(k-1)*gv%H_to_Z</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;          <span class="keywordflow">if</span> (cs%MixLenExponent==2.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;            mixlen_shape(k) = cs%transLay_scale + (1.0 - cs%transLay_scale) * &amp;</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                 (max(0.0, (mld_guess - h_rsum)*i_mld) )**2 <span class="comment">! CS%MixLenExponent</span></div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;            mixlen_shape(k) = cs%transLay_scale + (1.0 - cs%transLay_scale) * &amp;</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;                 (max(0.0, (mld_guess - h_rsum)*i_mld) )**cs%MixLenExponent</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160; </div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;      kd(1) = 0.0 ; kddt_h(1) = 0.0</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;      hp_a = h(1)</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;      dt_to_dpe_a(1) = dt_to_dpe(1) ; dt_to_dcolht_a(1) = dt_to_dcolht(1)</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;      ds_to_dpe_a(1) = ds_to_dpe(1) ; ds_to_dcolht_a(1) = ds_to_dcolht(1)</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160; </div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;      htot = h(1) ; uhtot = u(1)*h(1) ; vhtot = v(1)*h(1)</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160; </div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;      <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;        mech_tke_k(1) = mech_tke ; conv_perel_k(1) = conv_perel</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;        nstar_k(:) = 0.0 ; nstar_k(1) = cs%nstar ; num_itts(:) = -1</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160; </div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;      <span class="keywordflow">do</span> k=2,nz</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;        <span class="comment">! Apply dissipation to the TKE, here applied as an exponential decay</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;        <span class="comment">! due to 3-d turbulent energy being lost to inefficient rotational modes.</span></div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160; </div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;        <span class="comment">!   There should be several different &quot;flavors&quot; of TKE that decay at</span></div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        <span class="comment">! different rates.  The following form is often used for mechanical</span></div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;        <span class="comment">! stirring from the surface, perhaps due to breaking surface gravity</span></div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;        <span class="comment">! waves and wind-driven turbulence.</span></div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;        idecay_len_tke = (cs%TKE_decay * absf / u_star) * gv%H_to_Z</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;        exp_kh = 1.0</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;        <span class="keywordflow">if</span> (idecay_len_tke &gt; 0.0) exp_kh = exp(-h(k-1)*idecay_len_tke)</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;        <span class="keywordflow">if</span> (cs%TKE_diagnostics) &amp;</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;          ecd%dTKE_mech_decay = ecd%dTKE_mech_decay + (exp_kh-1.0) * mech_tke * i_dtdiag</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;        mech_tke = mech_tke * exp_kh</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160; </div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;        <span class="comment">!   Accumulate any convectively released potential energy to contribute</span></div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        <span class="comment">! to wstar and to drive penetrating convection.</span></div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;        <span class="keywordflow">if</span> (tke_forcing(k) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;          conv_perel = conv_perel + tke_forcing(k)</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;          <span class="keywordflow">if</span> (cs%TKE_diagnostics) &amp;</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;            ecd%dTKE_forcing = ecd%dTKE_forcing + cs%nstar*tke_forcing(k) * i_dtdiag</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160; </div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;          mech_tke_k(k) = mech_tke ; conv_perel_k(k) = conv_perel</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160; </div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;        <span class="comment">!  Determine the total energy</span></div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;        nstar_fc = cs%nstar</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;        <span class="keywordflow">if</span> (cs%nstar * conv_perel &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;          <span class="comment">! Here nstar is a function of the natural Rossby number 0.2/(1+0.2/Ro), based</span></div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;          <span class="comment">! on a curve fit from the data of Wang (GRL, 2003).</span></div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;          <span class="comment">! Note:         Ro = 1.0 / sqrt(0.5 * dt * Rho0 * (absf*htot)**3 / conv_PErel)</span></div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;          nstar_fc = cs%nstar * conv_perel / (conv_perel + 0.2 * &amp;</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;                     sqrt(0.5 * dt * gv%Rho0 * (absf*(htot*gv%H_to_Z))**3 * conv_perel))</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160; </div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;        <span class="keywordflow">if</span> (debug) nstar_k(k) = nstar_fc</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160; </div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        tot_tke = mech_tke + nstar_fc * conv_perel</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160; </div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;        <span class="comment">!   For each interior interface, first discard the TKE to account for</span></div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;        <span class="comment">! mixing of shortwave radiation through the next denser cell.</span></div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;        <span class="keywordflow">if</span> (tke_forcing(k) &lt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;          <span class="keywordflow">if</span> (tke_forcing(k) + tot_tke &lt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;            <span class="comment">! The shortwave requirements deplete all the energy in this layer.</span></div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;            <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;              ecd%dTKE_mixing = ecd%dTKE_mixing + tot_tke * i_dtdiag</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;              ecd%dTKE_forcing = ecd%dTKE_forcing - tot_tke * i_dtdiag</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;              <span class="comment">! eCD%dTKE_unbalanced = eCD%dTKE_unbalanced + (TKE_forcing(k) + tot_TKE) * I_dtdiag</span></div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;              ecd%dTKE_conv_decay = ecd%dTKE_conv_decay + (cs%nstar-nstar_fc) * conv_perel * i_dtdiag</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;            tot_tke = 0.0 ; mech_tke = 0.0 ; conv_perel = 0.0</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;            <span class="comment">! Reduce the mechanical and convective TKE proportionately.</span></div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;            tke_reduc = (tot_tke + tke_forcing(k)) / tot_tke</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;            <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;              ecd%dTKE_mixing = ecd%dTKE_mixing - tke_forcing(k) * i_dtdiag</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;              ecd%dTKE_forcing = ecd%dTKE_forcing + tke_forcing(k) * i_dtdiag</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;              ecd%dTKE_conv_decay = ecd%dTKE_conv_decay + &amp;</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;                  (1.0-tke_reduc)*(cs%nstar-nstar_fc) * conv_perel * i_dtdiag</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;            tot_tke = tke_reduc*tot_tke   <span class="comment">! = tot_TKE + TKE_forcing(k)</span></div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;            mech_tke = tke_reduc*mech_tke</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;            conv_perel = tke_reduc*conv_perel</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160; </div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;        <span class="comment">! Precalculate some temporary expressions that are independent of Kddt_h(K).</span></div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;        <span class="keywordflow">if</span> (cs%orig_PE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;          <span class="keywordflow">if</span> (k==2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;            dte_t2 = 0.0 ; dse_t2 = 0.0</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;            dte_t2 = kddt_h(k-1) * ((t0(k-2) - t0(k-1)) + dte(k-2))</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;            dse_t2 = kddt_h(k-1) * ((s0(k-2) - s0(k-1)) + dse(k-2))</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        dt_h = (gv%Z_to_H**2*dt) / max(0.5*(h(k-1)+h(k)), 1e-15*h_sum)</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160; </div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;        <span class="comment">!   This tests whether the layers above and below this interface are in</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        <span class="comment">! a convetively stable configuration, without considering any effects of</span></div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;        <span class="comment">! mixing at higher interfaces.  It is an approximation to the more</span></div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;        <span class="comment">! complete test dPEc_dKd_Kd0 &gt;= 0.0, that would include the effects of</span></div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;        <span class="comment">! mixing across interface K-1.  The dT_to_dColHt here are effectively</span></div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;        <span class="comment">! mass-weigted estimates of dSV_dT.</span></div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;        convectively_stable = ( 0.0 &lt;= &amp;</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;             ( (dt_to_dcolht(k) + dt_to_dcolht(k-1) ) * (t0(k-1)-t0(k)) + &amp;</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;               (ds_to_dcolht(k) + ds_to_dcolht(k-1) ) * (s0(k-1)-s0(k)) ) )</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160; </div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;        <span class="keywordflow">if</span> ((mech_tke + conv_perel) &lt;= 0.0 .and. convectively_stable) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;          <span class="comment">! Energy is already exhausted, so set Kd = 0 and cycle or exit?</span></div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;          tot_tke = 0.0 ; mech_tke = 0.0 ; conv_perel = 0.0</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;          kd(k) = 0.0 ; kddt_h(k) = 0.0</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;          sfc_disconnect = .true.</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;          <span class="comment">! if (.not.debug) exit</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160; </div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;         <span class="comment">!   The estimated properties for layer k-1 can be calculated, using</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;         <span class="comment">! greatly simplified expressions when Kddt_h = 0.  This enables the</span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;         <span class="comment">! tridiagonal solver for the whole column to be completed for debugging</span></div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;         <span class="comment">! purposes, and also allows for something akin to convective adjustment</span></div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;         <span class="comment">! in unstable interior regions?</span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;          b1 = 1.0 / hp_a</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;          c1(k) = 0.0</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;          <span class="keywordflow">if</span> (cs%orig_PE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;            dte(k-1) = b1 * ( dte_t2 )</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;            dse(k-1) = b1 * ( dse_t2 )</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160; </div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;          hp_a = h(k)</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;          dt_to_dpe_a(k) = dt_to_dpe(k)</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;          ds_to_dpe_a(k) = ds_to_dpe(k)</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;          dt_to_dcolht_a(k) = dt_to_dcolht(k)</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;          ds_to_dcolht_a(k) = ds_to_dcolht(k)</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160; </div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;        <span class="keywordflow">else</span> <span class="comment">! tot_TKE &gt; 0.0 or this is a potentially convectively unstable profile.</span></div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;          sfc_disconnect = .false.</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160; </div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;          <span class="comment">! Precalculate some more temporary expressions that are independent of</span></div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;          <span class="comment">! Kddt_h(K).</span></div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;          <span class="keywordflow">if</span> (cs%orig_PE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;            <span class="keywordflow">if</span> (k==2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;              dt_km1_t2 = (t0(k)-t0(k-1))</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;              ds_km1_t2 = (s0(k)-s0(k-1))</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;              dt_km1_t2 = (t0(k)-t0(k-1)) - &amp;</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;                    (kddt_h(k-1) / hp_a) * ((t0(k-2) - t0(k-1)) + dte(k-2))</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;              ds_km1_t2 = (s0(k)-s0(k-1)) - &amp;</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;                    (kddt_h(k-1) / hp_a) * ((s0(k-2) - s0(k-1)) + dse(k-2))</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;            dte_term = dte_t2 + hp_a * (t0(k-1)-t0(k))</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;            dse_term = dse_t2 + hp_a * (s0(k-1)-s0(k))</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;            <span class="keywordflow">if</span> (k&lt;=2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;              th_a(k-1) = h(k-1) * t0(k-1) ; sh_a(k-1) = h(k-1) * s0(k-1)</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;              th_a(k-1) = h(k-1) * t0(k-1) + kddt_h(k-1) * te(k-2)</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;              sh_a(k-1) = h(k-1) * s0(k-1) + kddt_h(k-1) * se(k-2)</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;            th_b(k) = h(k) * t0(k) ; sh_b(k) = h(k) * s0(k)</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160; </div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;          <span class="comment">!   Using Pr=1 and the diffusivity at the bottom interface (once it is</span></div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;          <span class="comment">! known), determine how much resolved mean kinetic energy (MKE) will be</span></div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;          <span class="comment">! extracted within a timestep and add a fraction CS%MKE_to_TKE_effic of</span></div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;          <span class="comment">! this to the mTKE budget available for mixing in the next layer.</span></div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160; </div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;          <span class="keywordflow">if</span> ((cs%MKE_to_TKE_effic &gt; 0.0) .and. (htot*h(k) &gt; 0.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;            <span class="comment">! This is the energy that would be available from homogenizing the</span></div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;            <span class="comment">! velocities between layer k and the layers above.</span></div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;            dmke_max = (us%L_to_Z**2*gv%H_to_RZ * cs%MKE_to_TKE_effic) * 0.5 * &amp;</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;                (h(k) / ((htot + h(k))*htot)) * &amp;</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;                ((uhtot-u(k)*htot)**2 + (vhtot-v(k)*htot)**2)</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;            <span class="comment">! A fraction (1-exp(Kddt_h*MKE2_Hharm)) of this energy would be</span></div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;            <span class="comment">! extracted by mixing with a finite viscosity.</span></div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;            mke2_hharm = (htot + h(k) + 2.0*h_neglect) / &amp;</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;                         ((htot+h_neglect) * (h(k)+h_neglect))</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;            dmke_max = 0.0</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;            mke2_hharm = 0.0</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160; </div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;          <span class="comment">! At this point, Kddt_h(K) will be unknown because its value may depend</span></div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;          <span class="comment">! on how much energy is available.  mech_TKE might be negative due to</span></div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;          <span class="comment">! contributions from TKE_forced.</span></div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;          h_tt = htot + h_tt_min</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;          tke_here = mech_tke + cs%wstar_ustar_coef*conv_perel</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;          <span class="keywordflow">if</span> (tke_here &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;            <span class="keywordflow">if</span> (cs%wT_scheme==wt_from_croot_tke) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;              vstar = cs%vstar_scale_fac * vstar_unit_scale * (i_dtrho*tke_here)**c1_3</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;            <span class="keywordflow">elseif</span> (cs%wT_scheme==wt_from_rh18) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;              surface_scale = max(0.05, 1.0 - htot/mld_guess)</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;              vstar = cs%vstar_scale_fac * surface_scale * (cs%vstar_surf_fac*u_star + &amp;</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;                        vstar_unit_scale * (cs%wstar_ustar_coef*conv_perel*i_dtrho)**c1_3)</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;            hbs_here = gv%H_to_Z * min(hb_hs(k), mixlen_shape(k))</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;            mixlen(k) = max(cs%min_mix_len, ((h_tt*hbs_here)*vstar) / &amp;</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;                ((cs%Ekman_scale_coef * absf) * (h_tt*hbs_here) + vstar))</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;            <span class="comment">!Note setting Kd_guess0 to vstar * CS%vonKar * mixlen(K) here will</span></div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;            <span class="comment">! change the answers.  Therefore, skipping that.</span></div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;            <span class="keywordflow">if</span> (.not.cs%Use_MLD_iteration) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;              kd_guess0 = vstar * cs%vonKar * ((h_tt*hbs_here)*vstar) / &amp;</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;                ((cs%Ekman_scale_coef * absf) * (h_tt*hbs_here) + vstar)</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;              kd_guess0 = vstar * cs%vonKar * mixlen(k)</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;            vstar = 0.0 ; kd_guess0 = 0.0</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;          mixvel(k) = vstar <span class="comment">! Track vstar</span></div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;          kddt_h_g0 = kd_guess0 * dt_h</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160; </div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;          <span class="keywordflow">if</span> (cs%orig_PE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;            <span class="keyword">call </span>find_pe_chg_orig(kddt_h_g0, h(k), hp_a, dte_term, dse_term, &amp;</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;                     dt_km1_t2, ds_km1_t2, dt_to_dpe(k), ds_to_dpe(k), &amp;</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;                     dt_to_dpe_a(k-1), ds_to_dpe_a(k-1), &amp;</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;                     pres_z(k), dt_to_dcolht(k), ds_to_dcolht(k), &amp;</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;                     dt_to_dcolht_a(k-1), ds_to_dcolht_a(k-1), &amp;</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;                     pe_chg=pe_chg_g0, dpec_dkd=dpea_dkd_g0, dpe_max=pe_chg_max, &amp;</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;                     dpec_dkd_0=dpec_dkd_kd0 )</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;            <span class="keyword">call </span>find_pe_chg(0.0, kddt_h_g0, hp_a, h(k), &amp;</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;                     th_a(k-1), sh_a(k-1), th_b(k), sh_b(k), &amp;</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;                     dt_to_dpe_a(k-1), ds_to_dpe_a(k-1), dt_to_dpe(k), ds_to_dpe(k), &amp;</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;                     pres_z(k), dt_to_dcolht_a(k-1), ds_to_dcolht_a(k-1), &amp;</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;                     dt_to_dcolht(k), ds_to_dcolht(k), &amp;</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;                     pe_chg=pe_chg_g0, dpec_dkd=dpea_dkd_g0, dpe_max=pe_chg_max, &amp;</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;                     dpec_dkd_0=dpec_dkd_kd0 )</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160; </div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;          mke_src = dmke_max*(1.0 - exp(-kddt_h_g0 * mke2_hharm))</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160; </div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;          <span class="comment">! This block checks out different cases to determine Kd at the present interface.</span></div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;          <span class="keywordflow">if</span> ((pe_chg_g0 &lt; 0.0) .or. ((vstar == 0.0) .and. (dpec_dkd_kd0 &lt; 0.0))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;            <span class="comment">! This column is convectively unstable.</span></div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;            <span class="keywordflow">if</span> (pe_chg_max &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;              <span class="comment">! Does MKE_src need to be included in the calculation of vstar here?</span></div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;              tke_here = mech_tke + cs%wstar_ustar_coef*(conv_perel-pe_chg_max)</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;              <span class="keywordflow">if</span> (tke_here &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;                <span class="keywordflow">if</span> (cs%wT_scheme==wt_from_croot_tke) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;                  vstar = cs%vstar_scale_fac * vstar_unit_scale * (i_dtrho*tke_here)**c1_3</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;                <span class="keywordflow">elseif</span> (cs%wT_scheme==wt_from_rh18) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;                  surface_scale = max(0.05, 1. - htot/mld_guess)</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;                  vstar = cs%vstar_scale_fac * surface_scale * (cs%vstar_surf_fac*u_star + &amp;</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;                                  vstar_unit_scale * (cs%wstar_ustar_coef*conv_perel*i_dtrho)**c1_3)</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;                hbs_here = gv%H_to_Z * min(hb_hs(k), mixlen_shape(k))</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;                mixlen(k) = max(cs%min_mix_len, ((h_tt*hbs_here)*vstar) / &amp;</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;                    ((cs%Ekman_scale_coef * absf) * (h_tt*hbs_here) + vstar))</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;                <span class="keywordflow">if</span> (.not.cs%Use_MLD_iteration) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;                <span class="comment">! Note again (as prev) that using mixlen here</span></div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;                <span class="comment">!  instead of redoing the computation will change answers...</span></div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;                  kd(k) = vstar * cs%vonKar *  ((h_tt*hbs_here)*vstar) / &amp;</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;                        ((cs%Ekman_scale_coef * absf) * (h_tt*hbs_here) + vstar)</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;                  kd(k) = vstar * cs%vonKar * mixlen(k)</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;<span class="keywordflow">                endif</span></div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;                vstar = 0.0 ; kd(k) = 0.0</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;              mixvel(k) = vstar</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160; </div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;              <span class="keywordflow">if</span> (cs%orig_PE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;                <span class="keyword">call </span>find_pe_chg_orig(kd(k)*dt_h, h(k), hp_a, dte_term, dse_term, &amp;</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;                         dt_km1_t2, ds_km1_t2, dt_to_dpe(k), ds_to_dpe(k), &amp;</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;                         dt_to_dpe_a(k-1), ds_to_dpe_a(k-1), &amp;</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;                         pres_z(k), dt_to_dcolht(k), ds_to_dcolht(k), &amp;</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;                         dt_to_dcolht_a(k-1), ds_to_dcolht_a(k-1), &amp;</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;                         pe_chg=dpe_conv)</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;                <span class="keyword">call </span>find_pe_chg(0.0, kd(k)*dt_h, hp_a, h(k), &amp;</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;                         th_a(k-1), sh_a(k-1), th_b(k), sh_b(k), &amp;</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;                         dt_to_dpe_a(k-1), ds_to_dpe_a(k-1), dt_to_dpe(k), ds_to_dpe(k), &amp;</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;                         pres_z(k), dt_to_dcolht_a(k-1), ds_to_dcolht_a(k-1), &amp;</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;                         dt_to_dcolht(k), ds_to_dcolht(k), &amp;</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;                         pe_chg=dpe_conv)</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;              <span class="comment">! Should this be iterated to convergence for Kd?</span></div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;              <span class="keywordflow">if</span> (dpe_conv &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;                kd(k) = kd_guess0 ; dpe_conv = pe_chg_g0</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;                mke_src = dmke_max*(1.0 - exp(-(kd(k)*dt_h) * mke2_hharm))</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;              <span class="comment">! The energy change does not vary monotonically with Kddt_h.  Find the maximum?</span></div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;              kd(k) = kd_guess0 ; dpe_conv = pe_chg_g0</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160; </div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;            conv_perel = conv_perel - dpe_conv</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;            mech_tke = mech_tke + mke_src</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;            <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;              ecd%dTKE_conv = ecd%dTKE_conv - cs%nstar*dpe_conv * i_dtdiag</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;              ecd%dTKE_MKE = ecd%dTKE_MKE + mke_src * i_dtdiag</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;            <span class="keywordflow">if</span> (sfc_connected) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;              mld_output = mld_output + gv%H_to_Z * h(k)</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160; </div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;            kddt_h(k) = kd(k) * dt_h</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;          <span class="keywordflow">elseif</span> (tot_tke + (mke_src - pe_chg_g0) &gt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;            <span class="comment">! This column is convctively stable and there is energy to support the suggested</span></div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;            <span class="comment">! mixing.  Keep that estimate.</span></div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;            kd(k) = kd_guess0</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;            kddt_h(k) = kddt_h_g0</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160; </div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;            <span class="comment">! Reduce the mechanical and convective TKE proportionately.</span></div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;            tot_tke = tot_tke + mke_src</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;            tke_reduc = 0.0   <span class="comment">! tot_TKE could be 0 if Convectively_stable is false.</span></div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;            <span class="keywordflow">if</span> (tot_tke &gt; 0.0) tke_reduc = (tot_tke - pe_chg_g0) / tot_tke</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;            <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;              ecd%dTKE_mixing = ecd%dTKE_mixing - pe_chg_g0 * i_dtdiag</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;              ecd%dTKE_MKE = ecd%dTKE_MKE + mke_src * i_dtdiag</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;              ecd%dTKE_conv_decay = ecd%dTKE_conv_decay + &amp;</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;                  (1.0-tke_reduc)*(cs%nstar-nstar_fc) * conv_perel * i_dtdiag</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;            tot_tke = tke_reduc*tot_tke</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;            mech_tke = tke_reduc*(mech_tke + mke_src)</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;            conv_perel = tke_reduc*conv_perel</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;            <span class="keywordflow">if</span> (sfc_connected) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;              mld_output = mld_output + gv%H_to_Z * h(k)</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160; </div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;          <span class="keywordflow">elseif</span> (tot_tke == 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;            <span class="comment">! This can arise if nstar_FC = 0, but it is not common.</span></div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;            kd(k) = 0.0 ; kddt_h(k) = 0.0</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;            tot_tke = 0.0 ; conv_perel = 0.0 ; mech_tke = 0.0</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;            sfc_disconnect = .true.</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;            <span class="comment">! There is not enough energy to support the mixing, so reduce the</span></div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;            <span class="comment">! diffusivity to what can be supported.</span></div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;            kddt_h_max = kddt_h_g0 ; kddt_h_min = 0.0</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;            tke_left_max = tot_tke + (mke_src - pe_chg_g0)</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;            tke_left_min = tot_tke</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160; </div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;            <span class="comment">! As a starting guess, take the minimum of a false position estimate</span></div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;            <span class="comment">! and a Newton&#39;s method estimate starting from Kddt_h = 0.0.</span></div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;            kddt_h_guess = tot_tke * kddt_h_max / max( pe_chg_g0  - mke_src, &amp;</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;                             kddt_h_max * (dpec_dkd_kd0 - dmke_max * mke2_hharm) )</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;            <span class="comment">! The above expression is mathematically the same as the following</span></div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;            <span class="comment">! except it is not susceptible to division by zero when</span></div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;            <span class="comment">!   dPEc_dKd_Kd0 = dMKE_max = 0 .</span></div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;            <span class="comment">!  Kddt_h_guess = tot_TKE * min( Kddt_h_max / (PE_chg_g0 - MKE_src), &amp;</span></div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;            <span class="comment">!                      1.0 / (dPEc_dKd_Kd0 - dMKE_max * MKE2_Hharm) )</span></div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;            <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;              tke_left_itt(:) = 0.0 ; dpea_dkd_itt(:) = 0.0 ; pe_chg_itt(:) = 0.0</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;              mke_src_itt(:) = 0.0 ; kddt_h_itt(:) = 0.0</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;            <span class="keywordflow">do</span> itt=1,max_itt</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;              <span class="keywordflow">if</span> (cs%orig_PE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;                <span class="keyword">call </span>find_pe_chg_orig(kddt_h_guess, h(k), hp_a, dte_term, dse_term, &amp;</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;                         dt_km1_t2, ds_km1_t2, dt_to_dpe(k), ds_to_dpe(k), &amp;</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;                         dt_to_dpe_a(k-1), ds_to_dpe_a(k-1), &amp;</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;                         pres_z(k), dt_to_dcolht(k), ds_to_dcolht(k), &amp;</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;                         dt_to_dcolht_a(k-1), ds_to_dcolht_a(k-1), &amp;</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;                         pe_chg=pe_chg, dpec_dkd=dpec_dkd )</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;                <span class="keyword">call </span>find_pe_chg(0.0, kddt_h_guess, hp_a, h(k), &amp;</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;                         th_a(k-1), sh_a(k-1), th_b(k), sh_b(k), &amp;</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;                         dt_to_dpe_a(k-1), ds_to_dpe_a(k-1), dt_to_dpe(k), ds_to_dpe(k), &amp;</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;                         pres_z(k), dt_to_dcolht_a(k-1), ds_to_dcolht_a(k-1), &amp;</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;                         dt_to_dcolht(k), ds_to_dcolht(k), &amp;</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;                         pe_chg=dpe_conv)</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;              mke_src = dmke_max * (1.0 - exp(-mke2_hharm * kddt_h_guess))</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;              dmke_src_dk = dmke_max * mke2_hharm * exp(-mke2_hharm * kddt_h_guess)</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160; </div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;              tke_left = tot_tke + (mke_src - pe_chg)</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;              <span class="keywordflow">if</span> (debug .and. itt&lt;=20) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;                kddt_h_itt(itt) = kddt_h_guess ; mke_src_itt(itt) = mke_src</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;                pe_chg_itt(itt) = pe_chg ; dpea_dkd_itt(itt) = dpec_dkd</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;                tke_left_itt(itt) = tke_left</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;              <span class="comment">! Store the new bounding values, bearing in mind that min and max</span></div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;              <span class="comment">! here refer to Kddt_h and dTKE_left/dKddt_h &lt; 0:</span></div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;              <span class="keywordflow">if</span> (tke_left &gt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;                kddt_h_min = kddt_h_guess ; tke_left_min = tke_left</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;                kddt_h_max = kddt_h_guess ; tke_left_max = tke_left</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160; </div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;              <span class="comment">! Try to use Newton&#39;s method, but if it would go outside the bracketed</span></div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;              <span class="comment">! values use the false-position method instead.</span></div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;              use_newt = .true.</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;              <span class="keywordflow">if</span> (dpec_dkd - dmke_src_dk &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;                use_newt = .false.</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;                dkddt_h_newt = tke_left / (dpec_dkd - dmke_src_dk)</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;                kddt_h_newt = kddt_h_guess + dkddt_h_newt</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;                <span class="keywordflow">if</span> ((kddt_h_newt &gt; kddt_h_max) .or. (kddt_h_newt &lt; kddt_h_min)) &amp;</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;                  use_newt = .false.</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160; </div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;              <span class="keywordflow">if</span> (use_newt) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;                kddt_h_next = kddt_h_guess + dkddt_h_newt</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;                dkddt_h = dkddt_h_newt</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;                kddt_h_next = (tke_left_max * kddt_h_min - kddt_h_max * tke_left_min) / &amp;</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;                              (tke_left_max - tke_left_min)</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;                dkddt_h = kddt_h_next - kddt_h_guess</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160; </div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;              <span class="keywordflow">if</span> ((abs(dkddt_h) &lt; 1e-9*kddt_h_guess) .or. (itt==max_itt)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;                <span class="comment">! Use the old value so that the energy calculation does not need to be repeated.</span></div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;                <span class="keywordflow">if</span> (debug) num_itts(k) = itt</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;                <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;                kddt_h_guess = kddt_h_next</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;<span class="keywordflow">            enddo</span> <span class="comment">! Inner iteration loop on itt.</span></div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;            kd(k) = kddt_h_guess / dt_h ; kddt_h(k) = kd(k) * dt_h</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160; </div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;            <span class="comment">! All TKE should have been consumed.</span></div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;            <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;              ecd%dTKE_mixing = ecd%dTKE_mixing - (tot_tke + mke_src) * i_dtdiag</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;              ecd%dTKE_MKE = ecd%dTKE_MKE + mke_src * i_dtdiag</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;              ecd%dTKE_conv_decay = ecd%dTKE_conv_decay + &amp;</div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;                  (cs%nstar-nstar_fc) * conv_perel * i_dtdiag</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160; </div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;            <span class="keywordflow">if</span> (sfc_connected) mld_output = mld_output + &amp;</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;                 (pe_chg / (pe_chg_g0)) * gv%H_to_Z * h(k)</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160; </div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;            tot_tke = 0.0 ; mech_tke = 0.0 ; conv_perel = 0.0</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;            sfc_disconnect = .true.</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;<span class="keywordflow">          endif</span> <span class="comment">! End of convective or forced mixing cases to determine Kd.</span></div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160; </div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;          kddt_h(k) = kd(k) * dt_h</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;          <span class="comment">!   At this point, the final value of Kddt_h(K) is known, so the</span></div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;          <span class="comment">! estimated properties for layer k-1 can be calculated.</span></div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;          b1 = 1.0 / (hp_a + kddt_h(k))</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;          c1(k) = kddt_h(k) * b1</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;          <span class="keywordflow">if</span> (cs%orig_PE_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;            dte(k-1) = b1 * ( kddt_h(k)*(t0(k)-t0(k-1)) + dte_t2 )</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;            dse(k-1) = b1 * ( kddt_h(k)*(s0(k)-s0(k-1)) + dse_t2 )</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160; </div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;          hp_a = h(k) + (hp_a * b1) * kddt_h(k)</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;          dt_to_dpe_a(k) = dt_to_dpe(k) + c1(k)*dt_to_dpe_a(k-1)</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;          ds_to_dpe_a(k) = ds_to_dpe(k) + c1(k)*ds_to_dpe_a(k-1)</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;          dt_to_dcolht_a(k) = dt_to_dcolht(k) + c1(k)*dt_to_dcolht_a(k-1)</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;          ds_to_dcolht_a(k) = ds_to_dcolht(k) + c1(k)*ds_to_dcolht_a(k-1)</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160; </div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;<span class="keywordflow">        endif</span>  <span class="comment">! tot_TKT &gt; 0.0 branch.  Kddt_h(K) has been set.</span></div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160; </div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;        <span class="comment">! Store integrated velocities and thicknesses for MKE conversion calculations.</span></div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;        <span class="keywordflow">if</span> (sfc_disconnect) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;          <span class="comment">! There is no turbulence at this interface, so zero out the running sums.</span></div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;          uhtot = u(k)*h(k)</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;          vhtot = v(k)*h(k)</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;          htot  = h(k)</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;          sfc_connected = .false.</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;          uhtot = uhtot + u(k)*h(k)</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;          vhtot = vhtot + v(k)*h(k)</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;          htot  = htot + h(k)</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160; </div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;        <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;          <span class="keywordflow">if</span> (k==2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;            te(1) = b1*(h(1)*t0(1))</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;            se(1) = b1*(h(1)*s0(1))</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;            te(k-1) = b1 * (h(k-1) * t0(k-1) + kddt_h(k-1) * te(k-2))</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;            se(k-1) = b1 * (h(k-1) * s0(k-1) + kddt_h(k-1) * se(k-2))</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;      kd(nz+1) = 0.0</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160; </div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;      <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;        <span class="comment">! Complete the tridiagonal solve for Te.</span></div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;        b1 = 1.0 / hp_a</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;        te(nz) = b1 * (h(nz) * t0(nz) + kddt_h(nz) * te(nz-1))</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;        se(nz) = b1 * (h(nz) * s0(nz) + kddt_h(nz) * se(nz-1))</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;        ecd%dT_expect(nz) = te(nz) - t0(nz) ; ecd%dS_expect(nz) = se(nz) - s0(nz)</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;        <span class="keywordflow">do</span> k=nz-1,1,-1</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;          te(k) = te(k) + c1(k+1)*te(k+1)</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;          se(k) = se(k) + c1(k+1)*se(k+1)</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;          ecd%dT_expect(k) = te(k) - t0(k) ; ecd%dS_expect(k) = se(k) - s0(k)</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160; </div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;        dpe_debug = 0.0</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;          dpe_debug = dpe_debug + (dt_to_dpe(k) * (te(k) - t0(k)) + &amp;</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;                                   ds_to_dpe(k) * (se(k) - s0(k)))</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;        mixing_debug = dpe_debug * i_dtdiag</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;      k = nz <span class="comment">! This is here to allow a breakpoint to be set.</span></div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;      <span class="comment">!/BGR</span></div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;      <span class="comment">! The following lines are used for the iteration</span></div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;      <span class="comment">! note the iteration has been altered to use the value predicted by</span></div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;      <span class="comment">! the TKE threshold (ML_DEPTH).  This is because the MSTAR</span></div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;      <span class="comment">! is now dependent on the ML, and therefore the ML needs to be estimated</span></div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;      <span class="comment">! more precisely than the grid spacing.</span></div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160; </div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;      <span class="comment">!New method uses ML_DEPTH as computed in ePBL routine</span></div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;      mld_found = mld_output</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;      <span class="keywordflow">if</span> (mld_found - cs%MLD_tol &gt; mld_guess) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;        min_mld = mld_guess</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;      <span class="keywordflow">elseif</span> (abs(mld_guess - mld_found) &lt; cs%MLD_tol) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;        obl_converged = .true. <span class="comment">! Break convergence loop</span></div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;        max_mld = mld_guess <span class="comment">! We know this guess was too deep</span></div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160; </div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;      <span class="comment">! For next pass, guess average of minimum and maximum values.</span></div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;      <span class="comment">!### We should try using the false position method instead of simple bisection.</span></div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;      mld_guess = 0.5*(min_mld + max_mld)</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! Iteration loop for converged boundary layer thickness.</span></div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;  <span class="keywordflow">if</span> (cs%Use_LT) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;    ecd%LA = la ; ecd%LAmod = lamod ; ecd%mstar = mstar_total ; ecd%mstar_LT = mstar_lt</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    ecd%LA = 0.0 ; ecd%LAmod = 0.0 ; ecd%mstar = mstar_total ; ecd%mstar_LT = 0.0</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160; </div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;  mld_io = mld_output</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01748">find_mstar()</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01447">find_pe_chg()</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01597">find_pe_chg_orig()</a>, <a class="el" href="MOM__wave__interface_8F90_source.html#l00879">mom_wave_interface::get_langmuir_number()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00197">use_fixed_mstar</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00206">wt_from_croot_tke</a>, and <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00208">wt_from_rh18</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00243">energetic_pbl()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_a01291f3e97cfdcf58866a1e9b0bcfc26_cgraph.svg" width="100%" height="535"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_a01291f3e97cfdcf58866a1e9b0bcfc26_icgraph.svg" width="344" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a7686c6a30a476068859f7a2a30e652df"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7686c6a30a476068859f7a2a30e652df">&#9670;&nbsp;</a></span>find_mstar()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_energetic_pbl::find_mstar </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__energetic__pbl_1_1energetic__pbl__cs.html">energetic_pbl_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Buoyancy_Flux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>UStar</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>UStar_Mean</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>BLD</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Abs_Coriolis</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out)&#160;</td>
          <td class="paramname"><em>MStar</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>Langmuir_Number</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>MStar_LT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>Convect_Langmuir_Number</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine finds the Mstar value for ePBL. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Energetic_PBL control structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ustar</td><td>ustar w/ gustiness [Z T-1 ~&gt; m s-1] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ustar_mean</td><td>ustar w/o gustiness [Z T-1 ~&gt; m s-1] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">abs_coriolis</td><td>abolute value of the Coriolis parameter [T-1 ~&gt; s-1] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">buoyancy_flux</td><td>Buoyancy flux [Z2 T-3 ~&gt; m2 s-3] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">bld</td><td>boundary layer depth [Z ~&gt; m] </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">mstar</td><td>Ouput mstar (Mixing/ustar**3) [nondim] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">langmuir_number</td><td>Langmuir number [nondim] </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">mstar_lt</td><td>Mstar increase due to Langmuir turbulence [nondim] </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">convect_langmuir_number</td><td>Langmuir number including buoyancy flux [nondim] </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01748">1748</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;  <span class="keywordtype">type</span>(energetic_PBL_CS), <span class="keywordtype">pointer</span>    :: CS<span class="comment">    !&lt; Energetic_PBL control structure.</span></div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type), <span class="keywordtype">intent(in)</span>  :: US<span class="comment">    !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>  :: UStar<span class="comment"> !&lt; ustar w/ gustiness [Z T-1 ~&gt; m s-1]</span></div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>  :: UStar_Mean<span class="comment"> !&lt; ustar w/o gustiness [Z T-1 ~&gt; m s-1]</span></div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>  :: Abs_Coriolis<span class="comment"> !&lt; abolute value of the Coriolis parameter [T-1 ~&gt; s-1]</span></div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>  :: Buoyancy_Flux<span class="comment"> !&lt; Buoyancy flux [Z2 T-3 ~&gt; m2 s-3]</span></div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>  :: BLD<span class="comment">   !&lt; boundary layer depth [Z ~&gt; m]</span></div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(out)</span> :: Mstar<span class="comment"> !&lt; Ouput mstar (Mixing/ustar**3) [nondim]</span></div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;<span class="keywordtype">  real</span>,        <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>  :: Langmuir_Number<span class="comment"> !&lt; Langmuir number [nondim]</span></div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;<span class="keywordtype">  real</span>,        <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: MStar_LT<span class="comment"> !&lt; Mstar increase due to Langmuir turbulence [nondim]</span></div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;<span class="keywordtype">  real</span>,        <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: Convect_Langmuir_number<span class="comment"> !&lt; Langmuir number including buoyancy flux [nondim]</span></div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160; </div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;  <span class="comment">!/ Variables used in computing mstar</span></div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;<span class="keywordtype">  real</span> :: MSN_term       <span class="comment">! Temporary terms [nondim]</span></div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;<span class="keywordtype">  real</span> :: MSCR_term1, MSCR_term2 <span class="comment">! Temporary terms [Z3 T-3 ~&gt; m3 s-3]</span></div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;<span class="keywordtype">  real</span> :: MStar_Conv_Red <span class="comment">! Adjustment made to mstar due to convection reducing mechanical mixing [nondim]</span></div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;<span class="keywordtype">  real</span> :: MStar_S, MStar_N <span class="comment">! Mstar in (S)tabilizing/(N)ot-stabilizing buoyancy flux [nondim]</span></div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160; </div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;  <span class="comment">!/  Integer options for how to find mstar</span></div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160; </div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;  <span class="comment">!/</span></div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160; </div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;  <span class="keywordflow">if</span> (cs%mstar_scheme == use_fixed_mstar) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;    mstar = cs%Fixed_MStar</div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;  <span class="comment">!/ 1. Get mstar</span></div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;  <span class="keywordflow">elseif</span> (cs%mstar_scheme == mstar_from_ekman) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160; </div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;    <span class="keywordflow">if</span> (cs%answers_2018) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;      <span class="comment">! The limit for the balance of rotation and stabilizing is f(L_Ekman,L_Obukhov)</span></div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;      mstar_s = cs%MStar_coef*sqrt(max(0.0,buoyancy_flux) / ustar**2 / &amp;</div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;                    (abs_coriolis + 1.e-10*us%T_to_s) )</div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;      <span class="comment">! The limit for rotation (Ekman length) limited mixing</span></div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;      mstar_n =  cs%C_Ek * log( max( 1., ustar / (abs_coriolis + 1.e-10*us%T_to_s) / bld ) )</div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;      <span class="comment">! The limit for the balance of rotation and stabilizing is f(L_Ekman,L_Obukhov)</span></div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;      mstar_s = cs%MSTAR_COEF*sqrt(max(0.0, buoyancy_flux) / (ustar**2 * max(abs_coriolis, 1.e-20*us%T_to_s)))</div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;      <span class="comment">! The limit for rotation (Ekman length) limited mixing</span></div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;      mstar_n = 0.0</div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;      <span class="keywordflow">if</span> (ustar &gt; abs_coriolis * bld) mstar_n = cs%C_EK * log(ustar / (abs_coriolis * bld))</div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160; </div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;    <span class="comment">! Here 1.25 is about .5/von Karman, which gives the Obukhov limit.</span></div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;    mstar = max(mstar_s, min(1.25, mstar_n))</div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;    <span class="keywordflow">if</span> (cs%MStar_Cap &gt; 0.0) mstar = min( cs%MStar_Cap,mstar )</div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;  <span class="keywordflow">elseif</span> ( cs%mstar_scheme == mstar_from_rh18 ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;    <span class="keywordflow">if</span> (cs%answers_2018) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;      mstar_n = cs%RH18_MStar_cn1 * ( 1.0 - 1.0 / ( 1. + cs%RH18_MStar_cn2 * &amp;</div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;                exp( cs%RH18_mstar_CN3 * bld * abs_coriolis / ustar) ) )</div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;      msn_term = cs%RH18_MStar_cn2 * exp( cs%RH18_mstar_CN3 * bld * abs_coriolis / ustar)</div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;      mstar_n = (cs%RH18_MStar_cn1 *  msn_term) / ( 1. + msn_term)</div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;    mstar_s = cs%RH18_MStar_CS1 * ( max(0.0, buoyancy_flux)**2 * bld / &amp;</div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;             ( ustar**5 * max(abs_coriolis,1.e-20*us%T_to_s) ) )**cs%RH18_mstar_cs2</div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;    mstar = mstar_n + mstar_s</div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160; </div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;  <span class="comment">!/ 2. Adjust mstar to account for convective turbulence</span></div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;  <span class="keywordflow">if</span> (cs%answers_2018) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;    mstar_conv_red = 1. - cs%MStar_Convect_coef * (-min(0.0,buoyancy_flux) + 1.e-10*us%T_to_s**3*us%m_to_Z**2) / &amp;</div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;                         ( (-min(0.0,buoyancy_flux) + 1.e-10*us%T_to_s**3*us%m_to_Z**2) + &amp;</div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;                         2.0 *mstar * ustar**3 / bld )</div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;    mscr_term1 = -bld * min(0.0, buoyancy_flux)</div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;    mscr_term2 = 2.0*mstar * ustar**3</div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;    <span class="keywordflow">if</span> ( abs(mscr_term2) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;      mstar_conv_red = ((1.-cs%mstar_convect_coef) * mscr_term1 + mscr_term2) / (mscr_term1 + mscr_term2)</div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;      mstar_conv_red = 1.-cs%mstar_convect_coef</div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160; </div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;  <span class="comment">!/3. Combine various mstar terms to get final value</span></div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;  mstar = mstar * mstar_conv_red</div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160; </div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(langmuir_number)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;    <span class="comment">!### In this call, ustar was previously ustar_mean.  Is this change deliberate?</span></div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;    <span class="keyword">call </span>mstar_langmuir(cs, us, abs_coriolis, buoyancy_flux, ustar, bld, langmuir_number, mstar, &amp;</div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;                        mstar_lt, convect_langmuir_number)</div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00198">mstar_from_ekman</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00200">mstar_from_rh18</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01834">mstar_langmuir()</a>, and <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00197">use_fixed_mstar</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00538">epbl_column()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_a7686c6a30a476068859f7a2a30e652df_cgraph.svg" width="344" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_a7686c6a30a476068859f7a2a30e652df_icgraph.svg" width="535" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a786e4381a925e3c84d0e99be09295627"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a786e4381a925e3c84d0e99be09295627">&#9670;&nbsp;</a></span>find_pe_chg()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_energetic_pbl::find_pe_chg </td>
          <td>(</td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Kddt_h0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dKddt_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>hp_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>hp_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Th_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Sh_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Th_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Sh_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dPE_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dPE_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dPE_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dPE_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>pres_Z</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dColHt_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dColHt_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dColHt_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dColHt_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>PE_chg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>dPEc_dKd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>dPE_max</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>dPEc_dKd_0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>PE_ColHt_cor</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine calculates the change in potential energy and or derivatives for several changes in an interfaces's diapycnal diffusivity times a timestep. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">kddt_h0</td><td>The previously used diffusivity at an interface times the time step and divided by the average of the thicknesses around the interface [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dkddt_h</td><td>The trial change in the diffusivity at an interface times the time step and divided by the average of the thicknesses around the interface [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">hp_a</td><td>The effective pivot thickness of the layer above the interface, given by h_k plus a term that is a fraction (determined from the tridiagonal solver) of Kddt_h for the interface above [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">hp_b</td><td>The effective pivot thickness of the layer below the interface, given by h_k plus a term that is a fraction (determined from the tridiagonal solver) of Kddt_h for the interface above [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">th_a</td><td>An effective temperature times a thickness in the layer above, including implicit mixing effects with other yet higher layers [degC H ~&gt; degC m or degC kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">sh_a</td><td>An effective salinity times a thickness in the layer above, including implicit mixing effects with other yet higher layers [degC H ~&gt; degC m or degC kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">th_b</td><td>An effective temperature times a thickness in the layer below, including implicit mixfing effects with other yet lower layers [degC H ~&gt; degC m or degC kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">sh_b</td><td>An effective salinity times a thickness in the layer below, including implicit mixing effects with other yet lower layers [degC H ~&gt; degC m or degC kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dpe_a</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dT) relating a layer's temperature change to the change in column potential energy, including all implicit diffusive changes in the temperatures of all the layers above [R Z3 T-2 degC-1 ~&gt; J m-2 degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dpe_a</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dS) relating a layer's salinity change to the change in column potential energy, including all implicit diffusive changes in the salinities of all the layers above [R Z3 T-2 ppt-1 ~&gt; J m-2 ppt-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dpe_b</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dT) relating a layer's temperature change to the change in column potential energy, including all implicit diffusive changes in the temperatures of all the layers below [R Z3 T-2 degC-1 ~&gt; J m-2 degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dpe_b</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dS) relating a layer's salinity change to the change in column potential energy, including all implicit diffusive changes in the salinities of all the layers below [R Z3 T-2 ppt-1 ~&gt; J m-2 ppt-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">pres_z</td><td>The rescaled hydrostatic interface pressure, which relates the changes in column thickness to the energy that is radiated as gravity waves and unavailable to drive mixing [R Z2 T-2 ~&gt; J m-3]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dcolht_a</td><td>A factor (mass_lay*dSColHtc_vol/dT) relating a layer's temperature change to the change in column height, including all implicit diffusive changes in the temperatures of all the layers above [Z degC-1 ~&gt; m degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dcolht_a</td><td>A factor (mass_lay*dSColHtc_vol/dS) relating a layer's salinity change to the change in column height, including all implicit diffusive changes in the salinities of all the layers above [Z ppt-1 ~&gt; m ppt-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dcolht_b</td><td>A factor (mass_lay*dSColHtc_vol/dT) relating a layer's temperature change to the change in column height, including all implicit diffusive changes in the temperatures of all the layers below [Z degC-1 ~&gt; m degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dcolht_b</td><td>A factor (mass_lay*dSColHtc_vol/dS) relating a layer's salinity change to the change in column height, including all implicit diffusive changes in the salinities of all the layers below [Z ppt-1 ~&gt; m ppt-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">pe_chg</td><td>The change in column potential energy from applying Kddt_h at the present interface [R Z3 T-2 ~&gt; J m-2]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dpec_dkd</td><td>The partial derivative of PE_chg with Kddt_h [R Z3 T-2 H-1 ~&gt; J m-3 or J kg-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dpe_max</td><td>The maximum change in column potential energy that could be realizedd by applying a huge value of Kddt_h at the present interface [R Z3 T-2 ~&gt; J m-2]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dpec_dkd_0</td><td>The partial derivative of PE_chg with Kddt_h in the limit where Kddt_h = 0 [R Z3 T-2 H-1 ~&gt; J m-3 or J kg-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">pe_colht_cor</td><td>The correction to PE_chg that is made due to a net change in the column height [R Z3 T-2 ~&gt; J m-2]. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01447">1447</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: Kddt_h0<span class="comment">  !&lt; The previously used diffusivity at an interface times</span></div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;<span class="comment">                                !! the time step and  divided by the average of the</span></div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;<span class="comment">                                !! thicknesses around the interface [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dKddt_h<span class="comment">  !&lt; The trial change in the diffusivity at an interface times</span></div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;<span class="comment">                                !! the time step and  divided by the average of the</span></div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;<span class="comment">                                !! thicknesses around the interface [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: hp_a<span class="comment">     !&lt; The effective pivot thickness of the layer above the</span></div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;<span class="comment">                                !! interface, given by h_k plus a term that</span></div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;<span class="comment">                                !! is a fraction (determined from the tridiagonal solver) of</span></div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;<span class="comment">                                !! Kddt_h for the interface above [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: hp_b<span class="comment">     !&lt; The effective pivot thickness of the layer below the</span></div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;<span class="comment">                                !! interface, given by h_k plus a term that</span></div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;<span class="comment">                                !! is a fraction (determined from the tridiagonal solver) of</span></div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;<span class="comment">                                !! Kddt_h for the interface above [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: Th_a<span class="comment">     !&lt; An effective temperature times a thickness in the layer</span></div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;<span class="comment">                                !! above, including implicit mixing effects with other</span></div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;<span class="comment">                                !! yet higher layers [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: Sh_a<span class="comment">     !&lt; An effective salinity times a thickness in the layer</span></div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;<span class="comment">                                !! above, including implicit mixing effects with other</span></div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;<span class="comment">                                !! yet higher layers [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: Th_b<span class="comment">     !&lt; An effective temperature times a thickness in the layer</span></div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;<span class="comment">                                !! below, including implicit mixfing effects with other</span></div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;<span class="comment">                                !! yet lower layers [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: Sh_b<span class="comment">     !&lt; An effective salinity times a thickness in the layer</span></div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;<span class="comment">                                !! below, including implicit mixing effects with other</span></div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;<span class="comment">                                !! yet lower layers [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dPE_a<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dT) relating</span></div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;<span class="comment">                                !! a layer&#39;s temperature change to the change in column potential</span></div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;<span class="comment">                                !! energy, including all implicit diffusive changes in the</span></div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;<span class="comment">                                !! temperatures of all the layers above [R Z3 T-2 degC-1 ~&gt; J m-2 degC-1].</span></div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dPE_a<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dS) relating</span></div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;<span class="comment">                                !! a layer&#39;s salinity change to the change in column potential</span></div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;<span class="comment">                                !! energy, including all implicit diffusive changes in the</span></div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;<span class="comment">                                !! salinities of all the layers above [R Z3 T-2 ppt-1 ~&gt; J m-2 ppt-1].</span></div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dPE_b<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dT) relating</span></div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;<span class="comment">                                !! a layer&#39;s temperature change to the change in column potential</span></div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;<span class="comment">                                !! energy, including all implicit diffusive changes in the</span></div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;<span class="comment">                                !! temperatures of all the layers below [R Z3 T-2 degC-1 ~&gt; J m-2 degC-1].</span></div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dPE_b<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dS) relating</span></div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;<span class="comment">                                !! a layer&#39;s salinity change to the change in column potential</span></div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;<span class="comment">                                !! energy, including all implicit diffusive changes in the</span></div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;<span class="comment">                                !! salinities of all the layers below [R Z3 T-2 ppt-1 ~&gt; J m-2 ppt-1].</span></div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: pres_Z<span class="comment">   !&lt; The rescaled hydrostatic interface pressure, which relates</span></div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;<span class="comment">                                !! the changes in column thickness to the energy that is radiated</span></div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;<span class="comment">                                !! as gravity waves and unavailable to drive mixing [R Z2 T-2 ~&gt; J m-3].</span></div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dColHt_a<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dT) relating</span></div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;<span class="comment">                                !! a layer&#39;s temperature change to the change in column</span></div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;<span class="comment">                                !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;<span class="comment">                                !! in the temperatures of all the layers above [Z degC-1 ~&gt; m degC-1].</span></div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dColHt_a<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dS) relating</span></div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;<span class="comment">                                !! a layer&#39;s salinity change to the change in column</span></div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;<span class="comment">                                !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;<span class="comment">                                !! in the salinities of all the layers above [Z ppt-1 ~&gt; m ppt-1].</span></div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dColHt_b<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dT) relating</span></div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;<span class="comment">                                !! a layer&#39;s temperature change to the change in column</span></div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;<span class="comment">                                !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;<span class="comment">                                !! in the temperatures of all the layers below [Z degC-1 ~&gt; m degC-1].</span></div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dColHt_b<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dS) relating</span></div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;<span class="comment">                                !! a layer&#39;s salinity change to the change in column</span></div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;<span class="comment">                                !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;<span class="comment">                                !! in the salinities of all the layers below [Z ppt-1 ~&gt; m ppt-1].</span></div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160; </div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: PE_chg<span class="comment">   !&lt; The change in column potential energy from applying</span></div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;<span class="comment">                                          !! Kddt_h at the present interface [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: dPEc_dKd<span class="comment"> !&lt; The partial derivative of PE_chg with Kddt_h</span></div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;<span class="comment">                                          !! [R Z3 T-2 H-1 ~&gt; J m-3 or J kg-1].</span></div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: dPE_max<span class="comment">  !&lt; The maximum change in column potential energy that could</span></div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;<span class="comment">                                          !! be realizedd by applying a huge value of Kddt_h at the</span></div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;<span class="comment">                                          !! present interface [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: dPEc_dKd_0<span class="comment"> !&lt; The partial derivative of PE_chg with Kddt_h in the</span></div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;<span class="comment">                                            !! limit where Kddt_h = 0 [R Z3 T-2 H-1 ~&gt; J m-3 or J kg-1].</span></div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: PE_ColHt_cor<span class="comment"> !&lt; The correction to PE_chg that is made due to a net</span></div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;<span class="comment">                                            !! change in the column height [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160; </div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;<span class="keywordtype">  real</span> :: hps <span class="comment">! The sum of the two effective pivot thicknesses [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;<span class="keywordtype">  real</span> :: bdt1 <span class="comment">! A product of the two pivot thicknesses plus a diffusive term [H2 ~&gt; m2 or kg2 m-4].</span></div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;<span class="keywordtype">  real</span> :: dT_c <span class="comment">! The core term in the expressions for the temperature changes [degC H2 ~&gt; degC m2 or degC kg2 m-4].</span></div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;<span class="keywordtype">  real</span> :: dS_c <span class="comment">! The core term in the expressions for the salinity changes [ppt H2 ~&gt; ppt m2 or ppt kg2 m-4].</span></div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;<span class="keywordtype">  real</span> :: PEc_core <span class="comment">! The diffusivity-independent core term in the expressions</span></div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;                   <span class="comment">! for the potential energy changes [R Z2 T-2 ~&gt; J m-3].</span></div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;<span class="keywordtype">  real</span> :: ColHt_core <span class="comment">! The diffusivity-independent core term in the expressions</span></div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;                     <span class="comment">! for the column height changes [H Z ~&gt; m2 or kg m-1].</span></div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;<span class="keywordtype">  real</span> :: ColHt_chg  <span class="comment">! The change in the column height [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;<span class="keywordtype">  real</span> :: y1_3 <span class="comment">! A local temporary term in [H-3 ~&gt; m-3 or m6 kg-3].</span></div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;<span class="keywordtype">  real</span> :: y1_4 <span class="comment">! A local temporary term in [H-4 ~&gt; m-4 or m8 kg-4].</span></div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160; </div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;  <span class="comment">!   The expression for the change in potential energy used here is derived</span></div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;  <span class="comment">! from the expression for the final estimates of the changes in temperature</span></div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;  <span class="comment">! and salinities, and then extensively manipulated to get it into its most</span></div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;  <span class="comment">! succint form. The derivation is not necessarily obvious, but it demonstrably</span></div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;  <span class="comment">! works by comparison with separate calculations of the energy changes after</span></div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;  <span class="comment">! the tridiagonal solver for the final changes in temperature and salinity are</span></div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;  <span class="comment">! applied.</span></div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160; </div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;  hps = hp_a + hp_b</div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;  bdt1 = hp_a * hp_b + kddt_h0 * hps</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;  dt_c = hp_a * th_b - hp_b * th_a</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;  ds_c = hp_a * sh_b - hp_b * sh_a</div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;  pec_core = hp_b * (dt_to_dpe_a * dt_c + ds_to_dpe_a * ds_c) - &amp;</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;             hp_a * (dt_to_dpe_b * dt_c + ds_to_dpe_b * ds_c)</div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;  colht_core = hp_b * (dt_to_dcolht_a * dt_c + ds_to_dcolht_a * ds_c) - &amp;</div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;               hp_a * (dt_to_dcolht_b * dt_c + ds_to_dcolht_b * ds_c)</div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160; </div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(pe_chg)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;    <span class="comment">! Find the change in column potential energy due to the change in the</span></div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;    <span class="comment">! diffusivity at this interface by dKddt_h.</span></div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;    y1_3 = dkddt_h / (bdt1 * (bdt1 + dkddt_h * hps))</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;    pe_chg = pec_core * y1_3</div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;    colht_chg = colht_core * y1_3</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;    <span class="keywordflow">if</span> (colht_chg &lt; 0.0) pe_chg = pe_chg - pres_z * colht_chg</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(pe_colht_cor)) pe_colht_cor = -pres_z * min(colht_chg, 0.0)</div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;  <span class="keywordflow">elseif</span> (<span class="keyword">present</span>(pe_colht_cor)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;    y1_3 = dkddt_h / (bdt1 * (bdt1 + dkddt_h * hps))</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;    pe_colht_cor = -pres_z * min(colht_core * y1_3, 0.0)</div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160; </div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dpec_dkd)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;    <span class="comment">! Find the derivative of the potential energy change with dKddt_h.</span></div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;    y1_4 = 1.0 / (bdt1 + dkddt_h * hps)**2</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;    dpec_dkd = pec_core * y1_4</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;    colht_chg = colht_core * y1_4</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;    <span class="keywordflow">if</span> (colht_chg &lt; 0.0) dpec_dkd = dpec_dkd - pres_z * colht_chg</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160; </div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dpe_max)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;    <span class="comment">! This expression is the limit of PE_chg for infinite dKddt_h.</span></div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;    y1_3 = 1.0 / (bdt1 * hps)</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;    dpe_max = pec_core * y1_3</div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;    colht_chg = colht_core * y1_3</div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;    <span class="keywordflow">if</span> (colht_chg &lt; 0.0) dpe_max = dpe_max - pres_z * colht_chg</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160; </div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dpec_dkd_0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;    <span class="comment">! This expression is the limit of dPEc_dKd for dKddt_h = 0.</span></div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;    y1_4 = 1.0 / bdt1**2</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;    dpec_dkd_0 = pec_core * y1_4</div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;    colht_chg = colht_core * y1_4</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;    <span class="keywordflow">if</span> (colht_chg &lt; 0.0) dpec_dkd_0 = dpec_dkd_0 - pres_z * colht_chg</div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00538">epbl_column()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_a786e4381a925e3c84d0e99be09295627_icgraph.svg" width="535" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a3eb660658d0677c55c6187dcf4a180b5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3eb660658d0677c55c6187dcf4a180b5">&#9670;&nbsp;</a></span>find_pe_chg_orig()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_energetic_pbl::find_pe_chg_orig </td>
          <td>(</td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Kddt_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>h_k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>b_den_1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dTe_term</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dSe_term</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_km1_t2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_km1_t2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dPE_k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dPE_k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dPEa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dPEa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>pres_Z</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dColHt_k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dColHt_k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dT_to_dColHta</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dS_to_dColHta</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>PE_chg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>dPEc_dKd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>dPE_max</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out), optional&#160;</td>
          <td class="paramname"><em>dPEc_dKd_0</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine calculates the change in potential energy and or derivatives for several changes in an interfaces's diapycnal diffusivity times a timestep using the original form used in the first version of ePBL. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">kddt_h</td><td>The diffusivity at an interface times the time step and divided by the average of the thicknesses around the interface [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h_k</td><td>The thickness of the layer below the interface [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">b_den_1</td><td>The first term in the denominator of the pivot for the tridiagonal solver, given by h_k plus a term that is a fraction (determined from the tridiagonal solver) of Kddt_h for the interface above [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dte_term</td><td>A diffusivity-independent term related to the temperature change in the layer below the interface [degC H ~&gt; degC m or degC kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dse_term</td><td>A diffusivity-independent term related to the salinity change in the layer below the interface [ppt H ~&gt; ppt m or ppt kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_km1_t2</td><td>A diffusivity-independent term related to the temperature change in the layer above the interface [degC]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_km1_t2</td><td>A diffusivity-independent term related to the salinity change in the layer above the interface [ppt]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">pres_z</td><td>The rescaled hydrostatic interface pressure, which relates the changes in column thickness to the energy that is radiated as gravity waves and unavailable to drive mixing [R Z2 T-2 ~&gt; J m-3]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dpe_k</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dT) relating a layer's temperature change to the change in column potential energy, including all implicit diffusive changes in the temperatures of all the layers below [R Z3 T-2 degC-1 ~&gt; J m-2 degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dpe_k</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dS) relating a layer's salinity change to the change in column potential energy, including all implicit diffusive changes in the in the salinities of all the layers below [R Z3 T-2 ppt-1 ~&gt; J m-2 ppt-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dpea</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dT) relating a layer's temperature change to the change in column potential energy, including all implicit diffusive changes in the temperatures of all the layers above [R Z3 T-2 degC-1 ~&gt; J m-2 degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dpea</td><td>A factor (pres_lay*mass_lay*dSpec_vol/dS) relating a layer's salinity change to the change in column potential energy, including all implicit diffusive changes in the salinities of all the layers above [R Z3 T-2 ppt-1 ~&gt; J m-2 ppt-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dcolht_k</td><td>A factor (mass_lay*dSColHtc_vol/dT) relating a layer's temperature change to the change in column height, including all implicit diffusive changes in the temperatures of all the layers below [Z degC-1 ~&gt; m degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dcolht_k</td><td>A factor (mass_lay*dSColHtc_vol/dS) relating a layer's salinity change to the change in column height, including all implicit diffusive changes in the salinities of all the layers below [Z ppt-1 ~&gt; m ppt-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_to_dcolhta</td><td>A factor (mass_lay*dSColHtc_vol/dT) relating a layer's temperature change to the change in column height, including all implicit diffusive changes in the temperatures of all the layers above [Z degC-1 ~&gt; m degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ds_to_dcolhta</td><td>A factor (mass_lay*dSColHtc_vol/dS) relating a layer's salinity change to the change in column height, including all implicit diffusive changes in the salinities of all the layers above [Z ppt-1 ~&gt; m ppt-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">pe_chg</td><td>The change in column potential energy from applying Kddt_h at the present interface [R Z3 T-2 ~&gt; J m-2]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dpec_dkd</td><td>The partial derivative of PE_chg with Kddt_h [R Z3 T-2 H-1 ~&gt; J m-3 or J kg-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dpe_max</td><td>The maximum change in column potential energy that could be realizedd by applying a huge value of Kddt_h at the present interface [R Z3 T-2 ~&gt; J m-2]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dpec_dkd_0</td><td>The partial derivative of PE_chg with Kddt_h in the limit where Kddt_h = 0 [R Z3 T-2 H-1 ~&gt; J m-3 or J kg-1]. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01597">1597</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: Kddt_h<span class="comment">   !&lt; The diffusivity at an interface times the time step and</span></div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;<span class="comment">                                !! divided by the average of the thicknesses around the</span></div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;<span class="comment">                                !! interface [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: h_k<span class="comment">      !&lt; The thickness of the layer below the interface [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: b_den_1<span class="comment">  !&lt; The first term in the denominator of the pivot</span></div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;<span class="comment">                                !! for the tridiagonal solver, given by h_k plus a term that</span></div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;<span class="comment">                                !! is a fraction (determined from the tridiagonal solver) of</span></div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;<span class="comment">                                !! Kddt_h for the interface above [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dTe_term<span class="comment"> !&lt; A diffusivity-independent term related to the temperature change</span></div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;<span class="comment">                                !! in the layer below the interface [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dSe_term<span class="comment"> !&lt; A diffusivity-independent term related to the salinity change</span></div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;<span class="comment">                                !! in the layer below the interface [ppt H ~&gt; ppt m or ppt kg m-2].</span></div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_km1_t2<span class="comment"> !&lt; A diffusivity-independent term related to the</span></div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;<span class="comment">                                 !! temperature change in the layer above the interface [degC].</span></div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_km1_t2<span class="comment"> !&lt; A diffusivity-independent term related to the</span></div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;<span class="comment">                                 !! salinity change in the layer above the interface [ppt].</span></div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: pres_Z<span class="comment">    !&lt; The rescaled hydrostatic interface pressure, which relates</span></div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;<span class="comment">                                 !! the changes in column thickness to the energy that is radiated</span></div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;<span class="comment">                                 !! as gravity waves and unavailable to drive mixing [R Z2 T-2 ~&gt; J m-3].</span></div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dPE_k<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dT) relating</span></div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;<span class="comment">                                 !! a layer&#39;s temperature change to the change in column potential</span></div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;<span class="comment">                                 !! energy, including all implicit diffusive changes in the</span></div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;<span class="comment">                                 !! temperatures of all the layers below [R Z3 T-2 degC-1 ~&gt; J m-2 degC-1].</span></div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dPE_k<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dS) relating</span></div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;<span class="comment">                                 !! a layer&#39;s salinity change to the change in column potential</span></div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;<span class="comment">                                 !! energy, including all implicit diffusive changes in the</span></div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;<span class="comment">                                 !! in the salinities of all the layers below [R Z3 T-2 ppt-1 ~&gt; J m-2 ppt-1].</span></div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dPEa<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dT) relating</span></div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;<span class="comment">                                 !! a layer&#39;s temperature change to the change in column potential</span></div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;<span class="comment">                                 !! energy, including all implicit diffusive changes in the</span></div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;<span class="comment">                                 !! temperatures of all the layers above [R Z3 T-2 degC-1 ~&gt; J m-2 degC-1].</span></div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dPEa<span class="comment"> !&lt; A factor (pres_lay*mass_lay*dSpec_vol/dS) relating</span></div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;<span class="comment">                                 !! a layer&#39;s salinity change to the change in column potential</span></div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;<span class="comment">                                 !! energy, including all implicit diffusive changes in the</span></div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;<span class="comment">                                 !! salinities of all the layers above [R Z3 T-2 ppt-1 ~&gt; J m-2 ppt-1].</span></div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dColHt_k<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dT) relating</span></div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;<span class="comment">                                 !! a layer&#39;s temperature change to the change in column</span></div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;<span class="comment">                                 !! height, including all implicit diffusive changes in the</span></div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;<span class="comment">                                 !! temperatures of all the layers below [Z degC-1 ~&gt; m degC-1].</span></div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dColHt_k<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dS) relating</span></div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;<span class="comment">                                 !! a layer&#39;s salinity change to the change in column</span></div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;<span class="comment">                                 !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;<span class="comment">                                 !! in the salinities of all the layers below [Z ppt-1 ~&gt; m ppt-1].</span></div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dT_to_dColHta<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dT) relating</span></div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;<span class="comment">                                 !! a layer&#39;s temperature change to the change in column</span></div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;<span class="comment">                                 !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;<span class="comment">                                 !! in the temperatures of all the layers above [Z degC-1 ~&gt; m degC-1].</span></div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: dS_to_dColHta<span class="comment"> !&lt; A factor (mass_lay*dSColHtc_vol/dS) relating</span></div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;<span class="comment">                                 !! a layer&#39;s salinity change to the change in column</span></div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;<span class="comment">                                 !! height, including all implicit diffusive changes</span></div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;<span class="comment">                                 !! in the salinities of all the layers above [Z ppt-1 ~&gt; m ppt-1].</span></div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160; </div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: PE_chg<span class="comment">   !&lt; The change in column potential energy from applying</span></div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;<span class="comment">                                          !! Kddt_h at the present interface [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: dPEc_dKd<span class="comment"> !&lt; The partial derivative of PE_chg with Kddt_h</span></div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;<span class="comment">                                          !! [R Z3 T-2 H-1 ~&gt; J m-3 or J kg-1].</span></div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: dPE_max<span class="comment">  !&lt; The maximum change in column potential energy that could</span></div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;<span class="comment">                                          !! be realizedd by applying a huge value of Kddt_h at the</span></div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;<span class="comment">                                          !! present interface [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: dPEc_dKd_0<span class="comment"> !&lt; The partial derivative of PE_chg with Kddt_h in the</span></div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;<span class="comment">                                          !! limit where Kddt_h = 0 [R Z3 T-2 H-1 ~&gt; J m-3 or J kg-1].</span></div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160; </div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;<span class="comment">!   This subroutine determines the total potential energy change due to mixing</span></div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;<span class="comment">! at an interface, including all of the implicit effects of the prescribed</span></div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;<span class="comment">! mixing at interfaces above.  Everything here is derived by careful manipulation</span></div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;<span class="comment">! of the robust tridiagonal solvers used for tracers by MOM6.  The results are</span></div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;<span class="comment">! positive for mixing in a stably stratified environment.</span></div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;<span class="comment">!   The comments describing these arguments are for a downward mixing pass, but</span></div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;<span class="comment">! this routine can also be used for an upward pass with the sense of direction</span></div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;<span class="comment">! reversed.</span></div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160; </div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;<span class="keywordtype">  real</span> :: b1            <span class="comment">! b1 is used by the tridiagonal solver [H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;<span class="keywordtype">  real</span> :: b1Kd          <span class="comment">! Temporary array [nondim]</span></div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;<span class="keywordtype">  real</span> :: ColHt_chg     <span class="comment">! The change in column thickness [Z ~&gt; m].</span></div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;<span class="keywordtype">  real</span> :: dColHt_max    <span class="comment">! The change in column thickness for infinite diffusivity [Z ~&gt; m].</span></div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;<span class="keywordtype">  real</span> :: dColHt_dKd    <span class="comment">! The partial derivative of column thickness with diffusivity [s Z-1 ~&gt; s m-1].</span></div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;<span class="keywordtype">  real</span> :: dT_k, dT_km1  <span class="comment">! Temporary arrays [degC].</span></div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;<span class="keywordtype">  real</span> :: dS_k, dS_km1  <span class="comment">! Temporary arrays [ppt].</span></div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;<span class="keywordtype">  real</span> :: I_Kr_denom    <span class="comment">! Temporary array [H-2 ~&gt; m-2 or m4 kg-2]</span></div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;<span class="keywordtype">  real</span> :: dKr_dKd       <span class="comment">! Nondimensional temporary array.</span></div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;<span class="keywordtype">  real</span> :: ddT_k_dKd, ddT_km1_dKd <span class="comment">! Temporary arrays [degC H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;<span class="keywordtype">  real</span> :: ddS_k_dKd, ddS_km1_dKd <span class="comment">! Temporary arrays [ppt H-1 ~&gt; ppt m-1 or ppt m2 kg-1].</span></div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160; </div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;  b1 = 1.0 / (b_den_1 + kddt_h)</div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;  b1kd = kddt_h*b1</div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160; </div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;  <span class="comment">! Start with the temperature change in layer k-1 due to the diffusivity at</span></div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;  <span class="comment">! interface K without considering the effects of changes in layer k.</span></div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160; </div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;  <span class="comment">! Calculate the change in PE due to the diffusion at interface K</span></div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;  <span class="comment">! if Kddt_h(K+1) = 0.</span></div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;  i_kr_denom = 1.0 / (h_k*b_den_1 + (b_den_1 + h_k)*kddt_h)</div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160; </div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;  dt_k = (kddt_h*i_kr_denom) * dte_term</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;  ds_k = (kddt_h*i_kr_denom) * dse_term</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160; </div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(pe_chg)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;    <span class="comment">! Find the change in energy due to diffusion with strength Kddt_h at this interface.</span></div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;    <span class="comment">! Increment the temperature changes in layer k-1 due the changes in layer k.</span></div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;    dt_km1 = b1kd * ( dt_k + dt_km1_t2 )</div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;    ds_km1 = b1kd * ( ds_k + ds_km1_t2 )</div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;    pe_chg = (dt_to_dpe_k * dt_k + dt_to_dpea * dt_km1) + &amp;</div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;             (ds_to_dpe_k * ds_k + ds_to_dpea * ds_km1)</div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;    colht_chg = (dt_to_dcolht_k * dt_k + dt_to_dcolhta * dt_km1) + &amp;</div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;                (ds_to_dcolht_k * ds_k + ds_to_dcolhta * ds_km1)</div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;    <span class="keywordflow">if</span> (colht_chg &lt; 0.0) pe_chg = pe_chg - pres_z * colht_chg</div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160; </div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dpec_dkd)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;    <span class="comment">! Find the derivatives of the temperature and salinity changes with Kddt_h.</span></div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;    dkr_dkd = (h_k*b_den_1) * i_kr_denom**2</div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160; </div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;    ddt_k_dkd = dkr_dkd * dte_term</div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;    dds_k_dkd = dkr_dkd * dse_term</div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;    ddt_km1_dkd = (b1**2 * b_den_1) * ( dt_k + dt_km1_t2 ) + b1kd * ddt_k_dkd</div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;    dds_km1_dkd = (b1**2 * b_den_1) * ( ds_k + ds_km1_t2 ) + b1kd * dds_k_dkd</div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160; </div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;    <span class="comment">! Calculate the partial derivative of Pe_chg with Kddt_h.</span></div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;    dpec_dkd = (dt_to_dpe_k * ddt_k_dkd + dt_to_dpea * ddt_km1_dkd) + &amp;</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;               (ds_to_dpe_k * dds_k_dkd + ds_to_dpea * dds_km1_dkd)</div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;    dcolht_dkd = (dt_to_dcolht_k * ddt_k_dkd + dt_to_dcolhta * ddt_km1_dkd) + &amp;</div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;                 (ds_to_dcolht_k * dds_k_dkd + ds_to_dcolhta * dds_km1_dkd)</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;    <span class="keywordflow">if</span> (dcolht_dkd &lt; 0.0) dpec_dkd = dpec_dkd - pres_z * dcolht_dkd</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160; </div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dpe_max)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;    <span class="comment">! This expression is the limit of PE_chg for infinite Kddt_h.</span></div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;    dpe_max = (dt_to_dpea * dt_km1_t2 + ds_to_dpea * ds_km1_t2) + &amp;</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;              ((dt_to_dpe_k + dt_to_dpea) * dte_term + &amp;</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;               (ds_to_dpe_k + ds_to_dpea) * dse_term) / (b_den_1 + h_k)</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;    dcolht_max = (dt_to_dcolhta * dt_km1_t2 + ds_to_dcolhta * ds_km1_t2) + &amp;</div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;              ((dt_to_dcolht_k + dt_to_dcolhta) * dte_term + &amp;</div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;               (ds_to_dcolht_k + ds_to_dcolhta) * dse_term) / (b_den_1 + h_k)</div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;    <span class="keywordflow">if</span> (dcolht_max &lt; 0.0) dpe_max = dpe_max - pres_z*dcolht_max</div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160; </div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dpec_dkd_0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;    <span class="comment">! This expression is the limit of dPEc_dKd for Kddt_h = 0.</span></div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;    dpec_dkd_0 = (dt_to_dpea * dt_km1_t2 + ds_to_dpea * ds_km1_t2) / (b_den_1) + &amp;</div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;                 (dt_to_dpe_k * dte_term + ds_to_dpe_k * dse_term) / (h_k*b_den_1)</div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;    dcolht_dkd = (dt_to_dcolhta * dt_km1_t2 + ds_to_dcolhta * ds_km1_t2) / (b_den_1) + &amp;</div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;                 (dt_to_dcolht_k * dte_term + ds_to_dcolht_k * dse_term) / (h_k*b_den_1)</div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;    <span class="keywordflow">if</span> (dcolht_dkd &lt; 0.0) dpec_dkd_0 = dpec_dkd_0 - pres_z*dcolht_dkd</div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00538">epbl_column()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_a3eb660658d0677c55c6187dcf4a180b5_icgraph.svg" width="535" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="ac7fd166f015884862a3798882ad1c977"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac7fd166f015884862a3798882ad1c977">&#9670;&nbsp;</a></span>mstar_langmuir()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_energetic_pbl::mstar_langmuir </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__energetic__pbl_1_1energetic__pbl__cs.html">energetic_pbl_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Abs_Coriolis</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Buoyancy_Flux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>UStar</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>BLD</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Langmuir_Number</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(inout)&#160;</td>
          <td class="paramname"><em>Mstar</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out)&#160;</td>
          <td class="paramname"><em>MStar_LT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out)&#160;</td>
          <td class="paramname"><em>Convect_Langmuir_Number</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine modifies the Mstar value if the Langmuir number is present. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Energetic_PBL control structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">abs_coriolis</td><td>Absolute value of the Coriolis parameter [T-1 ~&gt; s-1] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">buoyancy_flux</td><td>Buoyancy flux [Z2 T-3 ~&gt; m2 s-3] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ustar</td><td>Surface friction velocity with? gustiness [Z T-1 ~&gt; m s-1] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">bld</td><td>boundary layer depth [Z ~&gt; m] </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">mstar</td><td>Input/output mstar (Mixing/ustar**3) [nondim] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">langmuir_number</td><td>Langmuir number [nondim] </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">mstar_lt</td><td>Mstar increase due to Langmuir turbulence [nondim] </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">convect_langmuir_number</td><td>Langmuir number including buoyancy flux [nondim] </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01834">1834</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;  <span class="keywordtype">type</span>(energetic_PBL_CS), <span class="keywordtype">pointer</span>    :: CS<span class="comment">    !&lt; Energetic_PBL control structure.</span></div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type), <span class="keywordtype">intent(in)</span>  :: US<span class="comment">    !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>  :: Abs_Coriolis<span class="comment"> !&lt; Absolute value of the Coriolis parameter [T-1 ~&gt; s-1]</span></div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>  :: Buoyancy_Flux<span class="comment"> !&lt; Buoyancy flux [Z2 T-3 ~&gt; m2 s-3]</span></div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>  :: UStar<span class="comment"> !&lt; Surface friction velocity with? gustiness [Z T-1 ~&gt; m s-1]</span></div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>  :: BLD<span class="comment">   !&lt; boundary layer depth [Z ~&gt; m]</span></div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(inout)</span> :: Mstar<span class="comment"> !&lt; Input/output mstar (Mixing/ustar**3) [nondim]</span></div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>  :: Langmuir_Number<span class="comment"> !&lt; Langmuir number [nondim]</span></div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(out)</span> :: MStar_LT<span class="comment"> !&lt; Mstar increase due to Langmuir turbulence [nondim]</span></div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(out)</span> :: Convect_Langmuir_number<span class="comment"> !&lt; Langmuir number including buoyancy flux [nondim]</span></div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160; </div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;  <span class="comment">!/</span></div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: Max_ratio = 1.0e16  <span class="comment">! The maximum value of a nondimensional ratio.</span></div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;<span class="keywordtype">  real</span> :: enhance_mstar <span class="comment">! A multiplicative scaling of mstar due to Langmuir turbulence.</span></div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;<span class="keywordtype">  real</span> :: mstar_LT_add <span class="comment">! A value that is added to mstar due to Langmuir turbulence.</span></div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;<span class="keywordtype">  real</span> :: iL_Ekman    <span class="comment">! Inverse of Ekman length scale [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;<span class="keywordtype">  real</span> :: iL_Obukhov  <span class="comment">! Inverse of Obukhov length scale [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;<span class="keywordtype">  real</span> :: I_ustar     <span class="comment">! The Adcroft reciprocal of ustar [T Z-1 ~&gt; s m-1]</span></div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;<span class="keywordtype">  real</span> :: I_f         <span class="comment">! The Adcroft reciprocal of the Coriolis parameter [T ~&gt; s]</span></div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;<span class="keywordtype">  real</span> :: MLD_Ekman          <span class="comment">! The ratio of the mixed layer depth to the Ekman layer depth [nondim].</span></div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;<span class="keywordtype">  real</span> :: Ekman_Obukhov      <span class="comment">! The Ekman layer thickness divided by the Obukhov depth [nondim].</span></div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;<span class="keywordtype">  real</span> :: MLD_Obukhov        <span class="comment">! The mixed layer depth divided by the Obukhov depth [nondim].</span></div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;<span class="keywordtype">  real</span> :: MLD_Obukhov_stab   <span class="comment">! Ratios of length scales where MLD is boundary layer depth [nondim].</span></div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;<span class="keywordtype">  real</span> :: Ekman_Obukhov_stab <span class="comment">! &gt;</span></div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;<span class="keywordtype">  real</span> :: MLD_Obukhov_un     <span class="comment">! Ratios of length scales where MLD is boundary layer depth</span></div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;<span class="keywordtype">  real</span> :: Ekman_Obukhov_un   <span class="comment">! &gt;</span></div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160; </div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;  <span class="comment">! Set default values for no Langmuir effects.</span></div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;  enhance_mstar = 1.0 ; mstar_lt_add = 0.0</div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160; </div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;  <span class="keywordflow">if</span> (cs%LT_Enhance_Form /= no_langmuir) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;    <span class="comment">! a. Get parameters for modified LA</span></div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;    <span class="keywordflow">if</span> (cs%answers_2018) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;      il_ekman   = abs_coriolis / ustar</div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;      il_obukhov = buoyancy_flux*cs%vonkar / ustar**3</div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;      ekman_obukhov_stab = abs(max(0., il_obukhov / (il_ekman + 1.e-10*us%Z_to_m)))</div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;      ekman_obukhov_un = abs(min(0., il_obukhov / (il_ekman + 1.e-10*us%Z_to_m)))</div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;      mld_obukhov_stab = abs(max(0., bld*il_obukhov))</div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;      mld_obukhov_un = abs(min(0., bld*il_obukhov))</div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;      mld_ekman = abs( bld*il_ekman )</div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;      ekman_obukhov = max_ratio ; mld_obukhov = max_ratio ; mld_ekman = max_ratio</div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;      i_f = 0.0 ; <span class="keywordflow">if</span> (abs(abs_coriolis) &gt; 0.0) i_f = 1.0 / abs_coriolis</div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;      i_ustar = 0.0 ; <span class="keywordflow">if</span> (abs(ustar) &gt; 0.0) i_ustar = 1.0 / ustar</div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;      <span class="keywordflow">if</span> (abs(buoyancy_flux*cs%vonkar) &lt; max_ratio*(abs_coriolis * ustar**2)) &amp;</div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;        ekman_obukhov = abs(buoyancy_flux*cs%vonkar) * (i_f * i_ustar**2)</div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;      <span class="keywordflow">if</span> (abs(bld*buoyancy_flux*cs%vonkar) &lt; max_ratio*ustar**3) &amp;</div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;        mld_obukhov = abs(bld*buoyancy_flux*cs%vonkar) * i_ustar**3</div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;      <span class="keywordflow">if</span> (bld*abs_coriolis &lt; max_ratio*ustar) &amp;</div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;        mld_ekman = bld*abs_coriolis * i_ustar</div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160; </div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;      <span class="keywordflow">if</span> (buoyancy_flux &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;        ekman_obukhov_stab = ekman_obukhov ; ekman_obukhov_un = 0.0</div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;        mld_obukhov_stab = mld_obukhov ; mld_obukhov_un = 0.0</div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;        ekman_obukhov_un = ekman_obukhov ; ekman_obukhov_stab = 0.0</div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;        mld_obukhov_un = mld_obukhov ; mld_obukhov_stab = 0.0</div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160; </div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;    <span class="comment">! b. Adjust LA based on various parameters.</span></div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;    <span class="comment">!    Assumes linear factors based on length scale ratios to adjust LA</span></div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;    <span class="comment">!    Note when these coefficients are set to 0 recovers simple LA.</span></div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;    convect_langmuir_number = langmuir_number * &amp;</div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;                    ( (1.0 + max(-0.5, cs%LaC_MLDoEK * mld_ekman)) + &amp;</div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;                   ((cs%LaC_EKoOB_stab * ekman_obukhov_stab + cs%LaC_EKoOB_un * ekman_obukhov_un) + &amp;</div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;                    (cs%LaC_MLDoOB_stab * mld_obukhov_stab  + cs%LaC_MLDoOB_un * mld_obukhov_un)) )</div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160; </div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;    <span class="keywordflow">if</span> (cs%LT_Enhance_Form == langmuir_rescale) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;      <span class="comment">! Enhancement is multiplied (added mst_lt set to 0)</span></div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;      enhance_mstar = min(cs%Max_Enhance_M, &amp;</div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;                          (1. + cs%LT_ENHANCE_COEF * convect_langmuir_number**cs%LT_ENHANCE_EXP) )</div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;    <span class="keywordflow">elseif</span> (cs%LT_ENHANCE_Form == langmuir_add) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;      <span class="comment">! or Enhancement is additive (multiplied enhance_m set to 1)</span></div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;      mstar_lt_add = cs%LT_ENHANCE_COEF * convect_langmuir_number**cs%LT_ENHANCE_EXP</div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160; </div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;  mstar_lt = (enhance_mstar - 1.0)*mstar + mstar_lt_add  <span class="comment">! Diagnose the full increase in mstar.</span></div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;  mstar = mstar*enhance_mstar + mstar_lt_add</div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00204">langmuir_add</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00202">langmuir_rescale</a>, and <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00201">no_langmuir</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01748">find_mstar()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__energetic__pbl_ac7fd166f015884862a3798882ad1c977_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a54d8529555fee1f2ada7a7107f3c266c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a54d8529555fee1f2ada7a7107f3c266c">&#9670;&nbsp;</a></span>additive_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(20), parameter mom_energetic_pbl::additive_string = &quot;ADDITIVE&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Enumeration values for mstar_Scheme. </p>
<p>The value of mstar_scheme to use a constant mstar </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00217">217</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="comment">character*(20), parameter :: ADDITIVE_STRING = &quot;ADDITIVE&quot;</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>.</p>

</div>
</div>
<a id="a1242b6400e7d01529a3d19b85e0d5b5b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1242b6400e7d01529a3d19b85e0d5b5b">&#9670;&nbsp;</a></span>constant_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(20), parameter mom_energetic_pbl::constant_string = &quot;CONSTANT&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Enumeration values for mstar_Scheme. </p>
<p>The value of mstar_scheme to use a constant mstar </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00211">211</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="comment">character*(20), parameter :: CONSTANT_STRING = &quot;CONSTANT&quot;</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>.</p>

</div>
</div>
<a id="a502b7fb02ebdec866caed1508a103c1d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a502b7fb02ebdec866caed1508a103c1d">&#9670;&nbsp;</a></span>langmuir_add</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_energetic_pbl::langmuir_add = 3</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>The value of LT_ENHANCE_FORM to add a contribution to mstar from Langmuir turblence to other contributions. </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00204">204</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: Langmuir_add = 3<span class="comment">     !&lt; The value of LT_ENHANCE_FORM to add a contribution to</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>, and <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01834">mstar_langmuir()</a>.</p>

</div>
</div>
<a id="af8dec1f8eeb76a7638d11acc279f9bbd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af8dec1f8eeb76a7638d11acc279f9bbd">&#9670;&nbsp;</a></span>langmuir_rescale</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_energetic_pbl::langmuir_rescale = 2</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>The value of LT_ENHANCE_FORM to use a multiplicative rescaling of mstar to account for Langmuir turbulence. </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00202">202</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: Langmuir_rescale = 2<span class="comment"> !&lt; The value of LT_ENHANCE_FORM to use a multiplicative</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>, and <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01834">mstar_langmuir()</a>.</p>

</div>
</div>
<a id="a2f6f5a6f3b88370f8956a16805ff8d93"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2f6f5a6f3b88370f8956a16805ff8d93">&#9670;&nbsp;</a></span>mstar_from_ekman</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_energetic_pbl::mstar_from_ekman = 2</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>The value of mstar_scheme to base mstar on the ratio of the Ekman layer depth to the Obukhov depth. </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00198">198</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: MStar_from_Ekman = 2<span class="comment"> !&lt; The value of mstar_scheme to base mstar on the ratio</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>, and <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01748">find_mstar()</a>.</p>

</div>
</div>
<a id="a5504d7a4935753ac24c43f35a729052e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5504d7a4935753ac24c43f35a729052e">&#9670;&nbsp;</a></span>mstar_from_rh18</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_energetic_pbl::mstar_from_rh18 = 3</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>The value of mstar_scheme to base mstar of of RH18. </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00200">200</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: MStar_from_RH18 = 3<span class="comment">  !&lt; The value of mstar_scheme to base mstar of of RH18</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>, and <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01748">find_mstar()</a>.</p>

</div>
</div>
<a id="a408fc314121efffe70ff08b56b920343"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a408fc314121efffe70ff08b56b920343">&#9670;&nbsp;</a></span>no_langmuir</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_energetic_pbl::no_langmuir = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>The value of LT_ENHANCE_FORM not use Langmuir turbolence. </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00201">201</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: No_Langmuir = 0<span class="comment">      !&lt; The value of LT_ENHANCE_FORM not use Langmuir turbolence.</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>, and <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01834">mstar_langmuir()</a>.</p>

</div>
</div>
<a id="a4299f4ef5bbeabb5d0ca7e6016546ac4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4299f4ef5bbeabb5d0ca7e6016546ac4">&#9670;&nbsp;</a></span>none_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(20), parameter mom_energetic_pbl::none_string = &quot;NONE&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Enumeration values for mstar_Scheme. </p>
<p>The value of mstar_scheme to use a constant mstar </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00215">215</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment">character*(20), parameter :: NONE_STRING = &quot;NONE&quot;</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>.</p>

</div>
</div>
<a id="a193184bbe6bba5bfcb7b077d620cbfe7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a193184bbe6bba5bfcb7b077d620cbfe7">&#9670;&nbsp;</a></span>om4_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(20), parameter mom_energetic_pbl::om4_string = &quot;OM4&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Enumeration values for mstar_Scheme. </p>
<p>The value of mstar_scheme to use a constant mstar </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00212">212</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="comment">character*(20), parameter :: OM4_STRING = &quot;OM4&quot;</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>.</p>

</div>
</div>
<a id="a6e1dc5a516a3ea979f425084c1291139"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6e1dc5a516a3ea979f425084c1291139">&#9670;&nbsp;</a></span>rescaled_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(20), parameter mom_energetic_pbl::rescaled_string = &quot;RESCALE&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Enumeration values for mstar_Scheme. </p>
<p>The value of mstar_scheme to use a constant mstar </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00216">216</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">character*(20), parameter :: RESCALED_STRING = &quot;RESCALE&quot;</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>.</p>

</div>
</div>
<a id="a6fc8bff404f05376f1f3b4c90cb169a0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6fc8bff404f05376f1f3b4c90cb169a0">&#9670;&nbsp;</a></span>rh18_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(20), parameter mom_energetic_pbl::rh18_string = &quot;REICHL_H18&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Enumeration values for mstar_Scheme. </p>
<p>The value of mstar_scheme to use a constant mstar </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00213">213</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="comment">character*(20), parameter :: RH18_STRING = &quot;REICHL_H18&quot;</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>.</p>

</div>
</div>
<a id="a6617f3587ab57c34581cd76bd80b9249"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6617f3587ab57c34581cd76bd80b9249">&#9670;&nbsp;</a></span>root_tke_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(20), parameter mom_energetic_pbl::root_tke_string = &quot;CUBE_ROOT_TKE&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Enumeration values for mstar_Scheme. </p>
<p>The value of mstar_scheme to use a constant mstar </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00214">214</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment">character*(20), parameter :: ROOT_TKE_STRING = &quot;CUBE_ROOT_TKE&quot;</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>.</p>

</div>
</div>
<a id="a62611ee2449d47b4ac347ecc5815c927"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a62611ee2449d47b4ac347ecc5815c927">&#9670;&nbsp;</a></span>use_fixed_mstar</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_energetic_pbl::use_fixed_mstar = 0</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Enumeration values for mstar_Scheme. </p>
<p>The value of mstar_scheme to use a constant mstar </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00197">197</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: Use_Fixed_MStar = 0<span class="comment">  !&lt; The value of mstar_scheme to use a constant mstar</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>, <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00538">epbl_column()</a>, and <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01748">find_mstar()</a>.</p>

</div>
</div>
<a id="a148db2e43fc3bb4cc1f266ec7391a7dd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a148db2e43fc3bb4cc1f266ec7391a7dd">&#9670;&nbsp;</a></span>wt_from_croot_tke</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_energetic_pbl::wt_from_croot_tke = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Use a constant times the cube root of remaining TKE to calculate the turbulent velocity. </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00206">206</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: wT_from_cRoot_TKE = 0<span class="comment"> !&lt; Use a constant times the cube root of remaining TKE</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>, and <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00538">epbl_column()</a>.</p>

</div>
</div>
<a id="a0dc2252a2315d8d99000f9b003b24b00"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0dc2252a2315d8d99000f9b003b24b00">&#9670;&nbsp;</a></span>wt_from_rh18</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_energetic_pbl::wt_from_rh18 = 1</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Use a scheme based on a combination of w* and v* as documented in Reichl &amp; Hallberg (2018) to calculate the turbulent velocity. </p>

<p class="definition">Definition at line <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00208">208</a> of file <a class="el" href="MOM__energetic__PBL_8F90_source.html">MOM_energetic_PBL.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: wT_from_RH18 = 1<span class="comment">     !&lt; Use a scheme based on a combination of w* and v* as</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__energetic__PBL_8F90_source.html#l01941">energetic_pbl_init()</a>, and <a class="el" href="MOM__energetic__PBL_8F90_source.html#l00538">epbl_column()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__energetic__pbl.html">mom_energetic_pbl</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
