<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_full_convection Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('namespacemom__full__convection.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">mom_full_convection Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Does full convective adjustment of unstable regions via a strong diffusivity. </p>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a327a95712c5da253285dd808a178f2b0"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__full__convection.html#a327a95712c5da253285dd808a178f2b0">full_convection</a> (G, GV, h, tv, T_adj, S_adj, p_surf, Kddt_smooth, Kddt_convect, halo)</td></tr>
<tr class="memdesc:a327a95712c5da253285dd808a178f2b0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate new temperatures and salinities that have been subject to full convective mixing.  <a href="namespacemom__full__convection.html#a327a95712c5da253285dd808a178f2b0">More...</a><br /></td></tr>
<tr class="separator:a327a95712c5da253285dd808a178f2b0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2d2d4f8f10e25a0d9dc9bdfbf6729fe0"><td class="memItemLeft" align="right" valign="top">logical function&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__full__convection.html#a2d2d4f8f10e25a0d9dc9bdfbf6729fe0">is_unstable</a> (dRho_dT, dRho_dS, h_a, h_b, mix_A, mix_B, T_a, T_b, S_a, S_b, Te_aa, Te_bb, Se_aa, Se_bb, d_A, d_B)</td></tr>
<tr class="memdesc:a2d2d4f8f10e25a0d9dc9bdfbf6729fe0"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function returns True if the profiles around the given interface will be statically unstable after mixing above below. The arguments are the ocean state above and below, including partial calculations from a tridiagonal solver.  <a href="namespacemom__full__convection.html#a2d2d4f8f10e25a0d9dc9bdfbf6729fe0">More...</a><br /></td></tr>
<tr class="separator:a2d2d4f8f10e25a0d9dc9bdfbf6729fe0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2e24ce95201c7690b82f38ecbdf6620b"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__full__convection.html#a2e24ce95201c7690b82f38ecbdf6620b">smoothed_drdt_drds</a> (h, tv, Kddt, dR_dT, dR_dS, G, GV, j, p_surf, halo)</td></tr>
<tr class="memdesc:a2e24ce95201c7690b82f38ecbdf6620b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Returns the partial derivatives of locally referenced potential density with temperature and salinity after the properties have been smoothed with a small constant diffusivity.  <a href="namespacemom__full__convection.html#a2e24ce95201c7690b82f38ecbdf6620b">More...</a><br /></td></tr>
<tr class="separator:a2e24ce95201c7690b82f38ecbdf6620b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a327a95712c5da253285dd808a178f2b0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a327a95712c5da253285dd808a178f2b0">&#9670;&nbsp;</a></span>full_convection()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_full_convection::full_convection </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(out)&#160;</td>
          <td class="paramname"><em>T_adj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(out)&#160;</td>
          <td class="paramname"><em>S_adj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>p_surf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Kddt_smooth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>Kddt_convect</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in), optional&#160;</td>
          <td class="paramname"><em>halo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate new temperatures and salinities that have been subject to full convective mixing. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>A structure pointing to various thermodynamic variables </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">t_adj</td><td>Adjusted potential temperature [degC]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">s_adj</td><td>Adjusted salinity [ppt]. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">p_surf</td><td>The pressure at the ocean surface [Pa] (or NULL). </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">kddt_smooth</td><td>A smoothing vertical diffusivity times a timestep [H2 ~&gt; m2 or kg2 m-4]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">kddt_convect</td><td>A large convecting vertical diffusivity times a timestep [H2 ~&gt; m2 or kg2 m-4]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">halo</td><td>Halo width over which to compute </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__full__convection_8F90_source.html#l00022">22</a> of file <a class="el" href="MOM__full__convection_8F90_source.html">MOM_full_convection.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">     !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">    !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: h<span class="comment">     !&lt; Layer thicknesses [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),   <span class="keywordtype">intent(in)</span>    :: tv<span class="comment">    !&lt; A structure pointing to various</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">                                                  !! thermodynamic variables</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;                           <span class="keywordtype">intent(out)</span>   :: T_adj<span class="comment"> !&lt; Adjusted potential temperature [degC].</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;                           <span class="keywordtype">intent(out)</span>   :: S_adj<span class="comment"> !&lt; Adjusted salinity [ppt].</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:)</span>,    <span class="keywordtype">pointer</span>       :: p_surf<span class="comment"> !&lt; The pressure at the ocean surface [Pa] (or NULL).</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: Kddt_smooth<span class="comment">  !&lt; A smoothing vertical</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">                                                  !! diffusivity times a timestep [H2 ~&gt; m2 or kg2 m-4].</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keywordtype">  real</span>,          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: Kddt_convect<span class="comment"> !&lt; A large convecting vertical</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">                                                  !! diffusivity times a timestep [H2 ~&gt; m2 or kg2 m-4].</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  <span class="keywordtype">integer</span>,       <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: halo<span class="comment">  !&lt; Halo width over which to compute</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160; </div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span> :: &amp;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    drho_dT, &amp;  <span class="comment">! The derivatives of density with temperature and</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    drho_dS     <span class="comment">! salinity [kg m-3 degC-1] and [kg m-3 ppt-1].</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="keywordtype">  real</span> :: h_neglect, h0 <span class="comment">! A thickness that is so small it is usually lost</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;                        <span class="comment">! in roundoff and can be neglected [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">! logical :: use_EOS    ! If true, density is calculated from T &amp; S using an equation of state.</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(G))</span> :: &amp;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    Te_a, &amp; <span class="comment">! A partially updated temperature estimate including the influnce from</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;            <span class="comment">! mixing with layers above rescaled by a factor of d_a [degC].</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;            <span class="comment">! This array is discreted on tracer cells, but contains an extra</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;            <span class="comment">! layer at the top for algorithmic convenience.</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    se_a    <span class="comment">! A partially updated salinity estimate including the influnce from</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;            <span class="comment">! mixing with layers above rescaled by a factor of d_a [ppt].</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;            <span class="comment">! This array is discreted on tracer cells, but contains an extra</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;            <span class="comment">! layer at the top for algorithmic convenience.</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span> :: &amp;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    Te_b, &amp; <span class="comment">! A partially updated temperature estimate including the influnce from</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;            <span class="comment">! mixing with layers below rescaled by a factor of d_b [degC].</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;            <span class="comment">! This array is discreted on tracer cells, but contains an extra</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;            <span class="comment">! layer at the bottom for algorithmic convenience.</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    se_b    <span class="comment">! A partially updated salinity estimate including the influnce from</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;            <span class="comment">! mixing with layers below rescaled by a factor of d_b [ppt].</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;            <span class="comment">! This array is discreted on tracer cells, but contains an extra</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;            <span class="comment">! layer at the bottom for algorithmic convenience.</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span> :: &amp;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    c_a, &amp;  <span class="comment">! The fractional influence of the properties of the layer below</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;            <span class="comment">! in the final properies with a downward-first solver, nondim.</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    d_a, &amp;  <span class="comment">! The fractional influence of the properties of the layer in question</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;            <span class="comment">! and layers above in the final properies with a downward-first solver, nondim.</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;            <span class="comment">! d_a = 1.0 - c_a</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    c_b, &amp;  <span class="comment">! The fractional influence of the properties of the layer above</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;            <span class="comment">! in the final properies with a upward-first solver, nondim.</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    d_b     <span class="comment">! The fractional influence of the properties of the layer in question</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;            <span class="comment">! and layers below in the final properies with a upward-first solver, nondim.</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;            <span class="comment">! d_b = 1.0 - c_b</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span> :: &amp;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    mix<span class="comment">     !&lt; The amount of mixing across the interface between layers [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="keywordtype">  real</span> :: mix_len  <span class="comment">! The length-scale of mixing, when it is active [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="keywordtype">  real</span> :: h_b, h_a <span class="comment">! The thicknessses of the layers above and below an interface [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="keywordtype">  real</span> :: b_b, b_a <span class="comment">! Inverse pivots used by the tridiagonal solver [H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160; </div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="keywordtype">  real</span> :: kap_dt_x2 <span class="comment">! The product of 2*kappa*dt [H2 ~&gt; m2 or kg2 m-4].</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160; </div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: do_i <span class="comment">! Do more work on this column.</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: last_down <span class="comment">! The last setup pass was downward.</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: change_ct <span class="comment">! The number of interfaces where the</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                         <span class="comment">! mixing has changed this iteration.</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keywordtype">integer</span> :: changed_col <span class="comment">! The number of colums whose mixing changed.</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, nz, itt</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160; </div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(halo)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    is = g%isc-halo ; ie = g%iec+halo ; js = g%jsc-halo ; je = g%jec+halo</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  nz = g%ke</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160; </div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(tv%eqn_of_state)) <span class="keywordflow">return</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160; </div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  h_neglect = gv%H_subroundoff</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  kap_dt_x2 = 0.0</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(kddt_convect)) kap_dt_x2 = 2.0*kddt_convect</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  mix_len = (1.0e20 * nz) * (g%max_depth * gv%Z_to_H)</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  h0 = 1.0e-16*sqrt(kddt_smooth) + h_neglect</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160; </div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  <span class="keywordflow">do</span> j=js,je</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    mix(:,:) = 0.0 ; d_b(:,:) = 1.0</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="comment">! These would be Te_b(:,:) = tv%T(:,j,:), etc., but the values are not used</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    te_b(:,:) = 0.0 ; se_b(:,:) = 0.0</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160; </div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    <span class="keyword">call </span>smoothed_drdt_drds(h, tv, kddt_smooth, drho_dt, drho_ds, g, gv, j, p_surf, halo)</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160; </div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;      do_i(i) = (g%mask2dT(i,j) &gt; 0.0)</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160; </div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;      d_a(i,1) = 1.0</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;      last_down(i) = .true. <span class="comment">! This is set for debuggers.</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;      <span class="comment">! These are extra values are used for convenience in the stability test</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;      te_a(i,0) = 0.0 ; se_a(i,0) = 0.0</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160; </div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="keywordflow">do</span> itt=1,nz <span class="comment">! At least 2 interfaces will change with each full pass, or the</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                <span class="comment">! iterations stop, so the maximum count of nz is very conservative.</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160; </div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; change_ct(i) = 0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;      <span class="comment">! Move down the water column, finding unstable interfaces, and building up the</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;      <span class="comment">! temporary arrays for the tridiagonal solver.</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;      <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160; </div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        h_a = h(i,j,k-1) + h_neglect ; h_b = h(i,j,k) + h_neglect</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        <span class="keywordflow">if</span> (mix(i,k) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;          <span class="keywordflow">if</span> (is_unstable(drho_dt(i,k), drho_ds(i,k), h_a, h_b, mix(i,k-1), mix(i,k+1), &amp;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                          tv%T(i,j,k-1), tv%T(i,j,k), tv%S(i,j,k-1), tv%S(i,j,k), &amp;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                          te_a(i,k-2), te_b(i,k+1), se_a(i,k-2), se_b(i,k+1), &amp;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                          d_a(i,k-1), d_b(i,k+1))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;            mix(i,k) = mix_len</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;            <span class="keywordflow">if</span> (kap_dt_x2 &gt; 0.0) mix(i,k) = kap_dt_x2 / ((h(i,j,k-1)+h(i,j,k)) + h0)</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;            change_ct(i) = change_ct(i) + 1</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160; </div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        b_a = 1.0 / ((h_a + d_a(i,k-1)*mix(i,k-1)) + mix(i,k))</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        <span class="keywordflow">if</span> (mix(i,k) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;          c_a(i,k) = 0.0 ; d_a(i,k) = 1.0</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;          d_a(i,k) = b_a * (h_a + d_a(i,k-1)*mix(i,k-1)) <span class="comment">! = 1.0-c_a(i,K)</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;          c_a(i,k) = 1.0 ; <span class="keywordflow">if</span> (d_a(i,k) &gt; epsilon(b_a)) c_a(i,k) = b_a * mix(i,k)</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160; </div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        <span class="keywordflow">if</span> (k&gt;2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;          te_a(i,k-1) = b_a * (h_a*tv%T(i,j,k-1) + mix(i,k-1)*te_a(i,k-2))</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;          se_a(i,k-1) = b_a * (h_a*tv%S(i,j,k-1) + mix(i,k-1)*se_a(i,k-2))</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;          te_a(i,k-1) = b_a * (h_a*tv%T(i,j,k-1))</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;          se_a(i,k-1) = b_a * (h_a*tv%S(i,j,k-1))</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160; </div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;      <span class="comment">! Determine which columns might have further instabilities.</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;      changed_col = 0</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        <span class="keywordflow">if</span> (change_ct(i) == 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;          last_down(i) = .true. ; do_i(i) = .false.</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;          changed_col = changed_col + 1 ; change_ct(i) = 0</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;      <span class="keywordflow">if</span> (changed_col == 0) <span class="keywordflow">exit</span> <span class="comment">! No more columns are unstable.</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160; </div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;      <span class="comment">! This is the same as above, but with the direction reversed (bottom to top)</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;      <span class="keywordflow">do</span> k=nz,2,-1 ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160; </div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        h_a = h(i,j,k-1) + h_neglect ; h_b = h(i,j,k) + h_neglect</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        <span class="keywordflow">if</span> (mix(i,k) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;          <span class="keywordflow">if</span> (is_unstable(drho_dt(i,k), drho_ds(i,k), h_a, h_b, mix(i,k-1), mix(i,k+1), &amp;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                          tv%T(i,j,k-1), tv%T(i,j,k), tv%S(i,j,k-1), tv%S(i,j,k), &amp;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                          te_a(i,k-2), te_b(i,k+1), se_a(i,k-2), se_b(i,k+1), &amp;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                          d_a(i,k-1), d_b(i,k+1))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;            mix(i,k) = mix_len</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            <span class="keywordflow">if</span> (kap_dt_x2 &gt; 0.0) mix(i,k) = kap_dt_x2 / ((h(i,j,k-1)+h(i,j,k)) + h0)</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;            change_ct(i) = change_ct(i) + 1</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160; </div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        b_b = 1.0 / ((h_b + d_b(i,k+1)*mix(i,k+1)) + mix(i,k))</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        <span class="keywordflow">if</span> (mix(i,k) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;          c_b(i,k) = 0.0 ; d_b(i,k) = 1.0</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;          d_b(i,k) = b_b * (h_b + d_b(i,k+1)*mix(i,k+1)) <span class="comment">! = 1.0-c_b(i,K)</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;          c_b(i,k) = 1.0 ; <span class="keywordflow">if</span> (d_b(i,k) &gt; epsilon(b_b)) c_b(i,k) = b_b * mix(i,k)</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160; </div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        <span class="keywordflow">if</span> (k&lt;nz) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;          te_b(i,k) = b_b * (h_b*tv%T(i,j,k) + mix(i,k+1)*te_b(i,k+1))</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;          se_b(i,k) = b_b * (h_b*tv%S(i,j,k) + mix(i,k+1)*se_b(i,k+1))</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;          te_b(i,k) = b_b * (h_b*tv%T(i,j,k))</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;          se_b(i,k) = b_b * (h_b*tv%S(i,j,k))</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160; </div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;      <span class="comment">! Determine which columns might have further instabilities.</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      changed_col = 0</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        <span class="keywordflow">if</span> (change_ct(i) == 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;          last_down(i) = .false. ; do_i(i) = .false.</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;          changed_col = changed_col + 1 ; change_ct(i) = 0</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;      <span class="keywordflow">if</span> (changed_col == 0) <span class="keywordflow">exit</span> <span class="comment">! No more columns are unstable.</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160; </div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="keywordflow">    enddo</span>  <span class="comment">! End of iterations, all columns are now stable.</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160; </div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="comment">! Do the final return pass on the columns where the penultimate pass was downward.</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; do_i(i) = ((g%mask2dT(i,j) &gt; 0.0) .and. last_down(i)) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;      h_a = h(i,j,nz) + h_neglect</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;      b_a = 1.0 / (h_a + d_a(i,nz)*mix(i,nz))</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;      t_adj(i,j,nz) = b_a * (h_a*tv%T(i,j,nz) + mix(i,nz)*te_a(i,nz-1))</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;      s_adj(i,j,nz) = b_a * (h_a*tv%S(i,j,nz) + mix(i,nz)*se_a(i,nz-1))</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keywordflow">do</span> k=nz-1,1,-1 ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;      t_adj(i,j,k) = te_a(i,k) + c_a(i,k+1)*t_adj(i,j,k+1)</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;      s_adj(i,j,k) = se_a(i,k) + c_a(i,k+1)*s_adj(i,j,k+1)</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160; </div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;      k = 1 <span class="comment">! A hook for debugging.</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160; </div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <span class="comment">! Do the final return pass on the columns where the penultimate pass was upward.</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="comment">! Also do a simple copy of T &amp; S values on land points.</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;      do_i(i) = ((g%mask2dT(i,j) &gt; 0.0) .and. .not.last_down(i))</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;      <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        h_b = h(i,j,1) + h_neglect</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        b_b = 1.0 / (h_b + d_b(i,2)*mix(i,2))</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        t_adj(i,j,1) = b_b * (h_b*tv%T(i,j,1) + mix(i,2)*te_b(i,2))</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        s_adj(i,j,1) = b_b * (h_b*tv%S(i,j,1) + mix(i,2)*se_b(i,2))</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;      <span class="keywordflow">elseif</span> (g%mask2dT(i,j) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        t_adj(i,j,1) = tv%T(i,j,1) ; s_adj(i,j,1) = tv%S(i,j,1)</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;      <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        t_adj(i,j,k) = te_b(i,k) + c_b(i,k)*t_adj(i,j,k-1)</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        s_adj(i,j,k) = se_b(i,k) + c_b(i,k)*s_adj(i,j,k-1)</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;      <span class="keywordflow">elseif</span> (g%mask2dT(i,j) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        t_adj(i,j,k) = tv%T(i,j,k) ; s_adj(i,j,k) = tv%S(i,j,k)</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160; </div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;      k = 1 <span class="comment">! A hook for debugging.</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160; </div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! j-loop</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160; </div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  k = 1 <span class="comment">! A hook for debugging.</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160; </div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;  <span class="comment">! The following set of expressions for the final values are derived from the the partial</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;  <span class="comment">! updates for the estimated temperatures and salinities around an interface, then directly</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;  <span class="comment">! solving for the final temperatures and salinities.  They are here for later reference</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;  <span class="comment">! and to document an intermediate step in the stability calculation.</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="comment">! hp_a = (h_a + d_a(i,K-1)*mix(i,K-1))</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="comment">! hp_b = (h_b + d_b(i,K+1)*mix(i,K+1))</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="comment">! b2_c = 1.0 / (hp_a*hp_b + (hp_a + hp_b) * mix(i,K))</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="comment">! Th_a = h_a*tv%T(i,j,k-1) + mix(i,K-1)*Te_a(i,k-2)</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    <span class="comment">! Th_b = h_b*tv%T(i,j,k)   + mix(i,K+1)*Te_b(i,k+1)</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    <span class="comment">! T_fin(i,k)   = ( (hp_a + mix(i,K)) * Th_b  + Th_a * mix(i,K) ) * b2_c</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="comment">! T_fin(i,k-1) = ( (hp_b + mix(i,K)) * Th_a  + Th_b * mix(i,K) ) * b2_c</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="comment">! Sh_a = h_a*tv%S(i,j,k-1) + mix(i,K-1)*Se_a(i,k-2)</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <span class="comment">! Sh_b = h_b*tv%S(i,j,k)   + mix(i,K+1)*Se_b(i,k+1)</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="comment">! S_fin(i,k)   = ( (hp_a + mix(i,K)) * Sh_b  + Sh_a * mix(i,K) ) * b2_c</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="comment">! S_fin(i,k-1) = ( (hp_b + mix(i,K)) * Sh_a  + Sh_b * mix(i,K) ) * b2_c</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__full__convection_8F90_source.html#l00284">is_unstable()</a>, and <a class="el" href="MOM__full__convection_8F90_source.html#l00321">smoothed_drdt_drds()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00206">mom_set_diffusivity::set_diffusivity()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__full__convection_a327a95712c5da253285dd808a178f2b0_cgraph.svg" width="352" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__full__convection_a327a95712c5da253285dd808a178f2b0_icgraph.svg" width="343" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a2d2d4f8f10e25a0d9dc9bdfbf6729fe0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2d2d4f8f10e25a0d9dc9bdfbf6729fe0">&#9670;&nbsp;</a></span>is_unstable()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">logical function mom_full_convection::is_unstable </td>
          <td>(</td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dRho_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dRho_dS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>h_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>h_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>mix_A</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>mix_B</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>T_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>T_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>S_a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>S_b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Te_aa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Te_bb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Se_aa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Se_bb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>d_A</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>d_B</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This function returns True if the profiles around the given interface will be statically unstable after mixing above below. The arguments are the ocean state above and below, including partial calculations from a tridiagonal solver. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">drho_dt</td><td>The derivative of in situ density with temperature [kg m-3 degC-1] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">drho_ds</td><td>The derivative of in situ density with salinity [kg m-3 ppt-1] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h_a</td><td>The thickness of the layer above [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h_b</td><td>The thickness of the layer below [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">mix_a</td><td>The time integrated mixing rate of the interface above [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">mix_b</td><td>The time integrated mixing rate of the interface below [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">t_a</td><td>The initial temperature of the layer above [degC] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">t_b</td><td>The initial temperature of the layer below [degC] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">s_a</td><td>The initial salinity of the layer below [ppt] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">s_b</td><td>The initial salinity of the layer below [ppt] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">te_aa</td><td>The estimated temperature two layers above rescaled by d_A [degC] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">te_bb</td><td>The estimated temperature two layers below rescaled by d_B [degC] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">se_aa</td><td>The estimated salinity two layers above rescaled by d_A [ppt] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">se_bb</td><td>The estimated salinity two layers below rescaled by d_B [ppt] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">d_a</td><td>The rescaling dependency across the interface above, nondim. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">d_b</td><td>The rescaling dependency across the interface below, nondim. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The return value, true if the profile is statically unstable around the interface in question. </dd></dl>

<p class="definition">Definition at line <a class="el" href="MOM__full__convection_8F90_source.html#l00284">284</a> of file <a class="el" href="MOM__full__convection_8F90_source.html">MOM_full_convection.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: dRho_dT<span class="comment"> !&lt; The derivative of in situ density with temperature [kg m-3 degC-1]</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: dRho_dS<span class="comment"> !&lt; The derivative of in situ density with salinity [kg m-3 ppt-1]</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: h_a<span class="comment">     !&lt; The thickness of the layer above [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: h_b<span class="comment">     !&lt; The thickness of the layer below [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: mix_A<span class="comment">   !&lt; The time integrated mixing rate of the interface above [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: mix_B<span class="comment">   !&lt; The time integrated mixing rate of the interface below [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: T_a<span class="comment">     !&lt; The initial temperature of the layer above [degC]</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: T_b<span class="comment">     !&lt; The initial temperature of the layer below [degC]</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: S_a<span class="comment">     !&lt; The initial salinity of the layer below [ppt]</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: S_b<span class="comment">     !&lt; The initial salinity of the layer below [ppt]</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: Te_aa<span class="comment">   !&lt; The estimated temperature two layers above rescaled by d_A [degC]</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: Te_bb<span class="comment">   !&lt; The estimated temperature two layers below rescaled by d_B [degC]</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: Se_aa<span class="comment">   !&lt; The estimated salinity two layers above rescaled by d_A [ppt]</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: Se_bb<span class="comment">   !&lt; The estimated salinity two layers below rescaled by d_B [ppt]</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: d_A<span class="comment">     !&lt; The rescaling dependency across the interface above, nondim.</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span> :: d_B<span class="comment">     !&lt; The rescaling dependency across the interface below, nondim.</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;  <span class="keywordtype">logical</span> :: is_unstable<span class="comment"> !&lt; The return value, true if the profile is statically unstable</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="comment">                         !! around the interface in question.</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160; </div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;  <span class="comment">! These expressions for the local stability are long, but they have been carefully</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;  <span class="comment">! grouped for accuracy even when the mixing rates are huge or tiny, and common</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;  <span class="comment">! positive definite factors that would appear in the final expression for the</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  <span class="comment">! locally referenced potential density difference across an interface have been omitted.</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;  is_unstable = (drho_dt * ((h_a * h_b * (t_b - t_a) + &amp;</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                             mix_a*mix_b * (d_a*te_bb - d_b*te_aa)) + &amp;</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                            (h_a*mix_b * (te_bb - d_b*t_a) + &amp;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                             h_b*mix_a * (d_a*t_b - te_aa)) ) + &amp;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                 drho_ds * ((h_a * h_b * (s_b - s_a) + &amp;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                             mix_a*mix_b * (d_a*se_bb - d_b*se_aa)) + &amp;</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                            (h_a*mix_b * (se_bb - d_b*s_a) + &amp;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                             h_b*mix_a * (d_a*s_b - se_aa)) ) &lt; 0.0)</div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__full__convection_8F90_source.html#l00022">full_convection()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__full__convection_a2d2d4f8f10e25a0d9dc9bdfbf6729fe0_icgraph.svg" width="536" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a2e24ce95201c7690b82f38ecbdf6620b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2e24ce95201c7690b82f38ecbdf6620b">&#9670;&nbsp;</a></span>smoothed_drdt_drds()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_full_convection::smoothed_drdt_drds </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Kddt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke+1), intent(out)&#160;</td>
          <td class="paramname"><em>dR_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke+1), intent(out)&#160;</td>
          <td class="paramname"><em>dR_dS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>p_surf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in), optional&#160;</td>
          <td class="paramname"><em>halo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Returns the partial derivatives of locally referenced potential density with temperature and salinity after the properties have been smoothed with a small constant diffusivity. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>A structure pointing to various thermodynamic variables </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">kddt</td><td>A diffusivity times a time increment [H2 ~&gt; m2 or kg2 m-4]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dr_dt</td><td>Derivative of locally referenced </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dr_ds</td><td>Derivative of locally referenced </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>The j-point to work on. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">p_surf</td><td>The pressure at the ocean surface [Pa]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">halo</td><td>Halo width over which to compute </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__full__convection_8F90_source.html#l00321">321</a> of file <a class="el" href="MOM__full__convection_8F90_source.html">MOM_full_convection.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>  :: G<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>  :: GV<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                           <span class="keywordtype">intent(in)</span>  :: h<span class="comment">    !&lt; Layer thicknesses [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),   <span class="keywordtype">intent(in)</span>  :: tv<span class="comment">   !&lt; A structure pointing to various</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="comment">                                               !! thermodynamic variables</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>  :: Kddt<span class="comment"> !&lt; A diffusivity times a time increment [H2 ~&gt; m2 or kg2 m-4].</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span>, &amp;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                           <span class="keywordtype">intent(out)</span> :: dR_dT<span class="comment"> !&lt; Derivative of locally referenced</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="comment">                                               !! potential density with temperature [kg m-3 degC-1]</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span>, &amp;</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                           <span class="keywordtype">intent(out)</span> :: dR_dS<span class="comment"> !&lt; Derivative of locally referenced</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="comment">                                               !! potential density with salinity [kg m-3 ppt-1]</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;  <span class="keywordtype">integer</span>,                 <span class="keywordtype">intent(in)</span>  :: j<span class="comment">    !&lt; The j-point to work on.</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:)</span>,    <span class="keywordtype">pointer</span>     :: p_surf<span class="comment"> !&lt; The pressure at the ocean surface [Pa].</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;  <span class="keywordtype">integer</span>,       <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>  :: halo<span class="comment"> !&lt; Halo width over which to compute</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160; </div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="keywordtype">  real</span> :: mix(SZI_(G),SZK_(G)+1)   <span class="comment">! The diffusive mixing length (kappa*dt)/dz</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                                   <span class="comment">! between layers within in a timestep [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="keywordtype">  real</span> :: b1(SZI_(G)), d1(SZI_(G)) <span class="comment">! b1, c1, and d1 are variables used by the</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="keywordtype">  real</span> :: c1(SZI_(G),SZK_(G))      <span class="comment">! tridiagonal solver.</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="keywordtype">  real</span> :: T_f(SZI_(G),SZK_(G))     <span class="comment">! Filtered temperatures [degC]</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="keywordtype">  real</span> :: S_f(SZI_(G),SZK_(G))     <span class="comment">! Filtered salinities [ppt]</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="keywordtype">  real</span> :: pres(SZI_(G))            <span class="comment">! Interface pressures [Pa].</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="keywordtype">  real</span> :: T_EOS(SZI_(G))           <span class="comment">! Filtered and vertically averaged temperatures [degC]</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="keywordtype">  real</span> :: S_EOS(SZI_(G))           <span class="comment">! Filtered and vertically averaged salinities [ppt]</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="keywordtype">  real</span> :: kap_dt_x2                <span class="comment">! The product of 2*kappa*dt [H2 ~&gt; m2 or kg2 m-4].</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="keywordtype">  real</span> :: h_neglect, h0            <span class="comment">! Negligible thicknesses to allow for zero thicknesses,</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                                   <span class="comment">! [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keywordtype">  real</span> :: h_tr                     <span class="comment">! The thickness at tracer points, plus h_neglect [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;  <span class="keywordtype">integer</span> :: i, k, is, ie, nz</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160; </div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(halo)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    is = g%isc-halo ; ie = g%iec+halo</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    is = g%isc ; ie = g%iec</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;  nz = g%ke</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160; </div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;  h_neglect = gv%H_subroundoff</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;  kap_dt_x2 = 2.0*kddt</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160; </div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;  <span class="keywordflow">if</span> (kddt &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;      t_f(i,k) = tv%T(i,j,k) ; s_f(i,k) = tv%S(i,j,k)</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    h0 = 1.0e-16*sqrt(kddt) + h_neglect</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;      mix(i,2) = kap_dt_x2 / ((h(i,j,1)+h(i,j,2)) + h0)</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160; </div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;      h_tr = h(i,j,1) + h_neglect</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;      b1(i) = 1.0 / (h_tr + mix(i,2))</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;      d1(i) = b1(i) * h(i,j,1)</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;      t_f(i,1) = (b1(i)*h_tr)*tv%T(i,j,1)</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;      s_f(i,1) = (b1(i)*h_tr)*tv%S(i,j,1)</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <span class="keywordflow">do</span> k=2,nz-1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;      mix(i,k+1) = kap_dt_x2 / ((h(i,j,k)+h(i,j,k+1)) + h0)</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160; </div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;      c1(i,k) = mix(i,k) * b1(i)</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;      h_tr = h(i,j,k) + h_neglect</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;      b1(i) = 1.0 / ((h_tr + d1(i)*mix(i,k)) + mix(i,k+1))</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;      d1(i) = b1(i) * (h_tr + d1(i)*mix(i,k))</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;      t_f(i,k) = b1(i) * (h_tr*tv%T(i,j,k) + mix(i,k)*t_f(i,k-1))</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;      s_f(i,k) = b1(i) * (h_tr*tv%S(i,j,k) + mix(i,k)*s_f(i,k-1))</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;      c1(i,nz) = mix(i,nz) * b1(i)</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;      h_tr = h(i,j,nz) + h_neglect</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;      b1(i) = 1.0 / (h_tr + d1(i)*mix(i,nz))</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;      t_f(i,nz) = b1(i) * (h_tr*tv%T(i,j,nz) + mix(i,nz)*t_f(i,nz-1))</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;      s_f(i,nz) = b1(i) * (h_tr*tv%S(i,j,nz) + mix(i,nz)*s_f(i,nz-1))</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    <span class="keywordflow">do</span> k=nz-1,1,-1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;      t_f(i,k) = t_f(i,k) + c1(i,k+1)*t_f(i,k+1)</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;      s_f(i,k) = s_f(i,k) + c1(i,k+1)*s_f(i,k+1)</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160; </div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(p_surf)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; pres(i) = p_surf(i,j) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; pres(i) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;  <span class="keyword">call </span>calculate_density_derivs(t_f(:,1), s_f(:,1), pres, dr_dt(:,1), dr_ds(:,1), &amp;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;                                is-g%isd+1, ie-is+1, tv%eqn_of_state)</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; pres(i) = pres(i) + h(i,j,1)*gv%H_to_Pa ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;  <span class="keywordflow">do</span> k=2,nz</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;      t_eos(i) = 0.5*(t_f(i,k-1) + t_f(i,k))</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;      s_eos(i) = 0.5*(s_f(i,k-1) + s_f(i,k))</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="keyword">call </span>calculate_density_derivs(t_eos, s_eos, pres, dr_dt(:,k), dr_ds(:,k), &amp;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                                  is-g%isd+1, ie-is+1, tv%eqn_of_state)</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; pres(i) = pres(i) + h(i,j,k)*gv%H_to_Pa ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  <span class="keyword">call </span>calculate_density_derivs(t_f(:,nz), s_f(:,nz), pres, dr_dt(:,nz+1), dr_ds(:,nz+1), &amp;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                                is-g%isd+1, ie-is+1, tv%eqn_of_state)</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160; </div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__full__convection_8F90_source.html#l00022">full_convection()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__full__convection_a2e24ce95201c7690b82f38ecbdf6620b_icgraph.svg" width="539" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__full__convection.html">mom_full_convection</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
