<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_opacity Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('namespacemom__opacity.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a>  </div>
  <div class="headertitle">
<div class="title">mom_opacity Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Routines used to calculate the opacity of the ocean. </p>
<p>opacity_from_chl: In this routine, the Morel (modified) or Manizza (modified) schemes use the "blue" band in the paramterizations to determine the e-folding depth of the incoming shortwave attenuation. The red portion is lumped into the net heating at the surface.</p>
<p>Morel, A., 1988: Optical modeling of the upper ocean in relation to its biogenous matter content (case-i waters)., J. Geo. Res., 93, 10,749-10,768.</p>
<p>Manizza, M., C. LeQuere, A. J. Watson, and E. T. Buitenhuis, 2005: Bio-optical feedbacks among phytoplankton, upper ocean physics and sea-ice in a global model, Geophys. Res. Let., 32, L05603, doi:10.1029/2004GL020778. </p>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__opacity_1_1opacity__cs.html">opacity_cs</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">The control structure with paramters for the MOM_opacity module.  <a href="structmom__opacity_1_1opacity__cs.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__opacity_1_1optics__type.html">optics_type</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">This type is used to store information about ocean optical properties.  <a href="structmom__opacity_1_1optics__type.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a948b6b8f52bd40409385ee13f68c9626"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#a948b6b8f52bd40409385ee13f68c9626">no_scheme</a> = 0</td></tr>
<tr class="memdesc:a948b6b8f52bd40409385ee13f68c9626"><td class="mdescLeft">&#160;</td><td class="mdescRight">Coded integers to specify the opacity scheme.  <a href="namespacemom__opacity.html#a948b6b8f52bd40409385ee13f68c9626">More...</a><br /></td></tr>
<tr class="separator:a948b6b8f52bd40409385ee13f68c9626"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a28a3fe4f0c5e8c81882449450f6ba785"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#a28a3fe4f0c5e8c81882449450f6ba785">manizza_05</a> = 1</td></tr>
<tr class="memdesc:a28a3fe4f0c5e8c81882449450f6ba785"><td class="mdescLeft">&#160;</td><td class="mdescRight">Coded integers to specify the opacity scheme.  <a href="namespacemom__opacity.html#a28a3fe4f0c5e8c81882449450f6ba785">More...</a><br /></td></tr>
<tr class="separator:a28a3fe4f0c5e8c81882449450f6ba785"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa47b1866014e588f0306199f7ea7e73d"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#aa47b1866014e588f0306199f7ea7e73d">morel_88</a> = 2</td></tr>
<tr class="memdesc:aa47b1866014e588f0306199f7ea7e73d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Coded integers to specify the opacity scheme.  <a href="namespacemom__opacity.html#aa47b1866014e588f0306199f7ea7e73d">More...</a><br /></td></tr>
<tr class="separator:aa47b1866014e588f0306199f7ea7e73d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a77646ea3d3da72b4e00694b7a121a771"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#a77646ea3d3da72b4e00694b7a121a771">single_exp</a> = 3</td></tr>
<tr class="memdesc:a77646ea3d3da72b4e00694b7a121a771"><td class="mdescLeft">&#160;</td><td class="mdescRight">Coded integers to specify the opacity scheme.  <a href="namespacemom__opacity.html#a77646ea3d3da72b4e00694b7a121a771">More...</a><br /></td></tr>
<tr class="separator:a77646ea3d3da72b4e00694b7a121a771"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aba8c34bcba1b2f2d80a48cd7bce261ec"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#aba8c34bcba1b2f2d80a48cd7bce261ec">double_exp</a> = 4</td></tr>
<tr class="memdesc:aba8c34bcba1b2f2d80a48cd7bce261ec"><td class="mdescLeft">&#160;</td><td class="mdescRight">Coded integers to specify the opacity scheme.  <a href="namespacemom__opacity.html#aba8c34bcba1b2f2d80a48cd7bce261ec">More...</a><br /></td></tr>
<tr class="separator:aba8c34bcba1b2f2d80a48cd7bce261ec"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aecb5a81b64d808f474cb4e5c722dc76b"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(10), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#aecb5a81b64d808f474cb4e5c722dc76b">manizza_05_string</a> = &quot;MANIZZA_05&quot;</td></tr>
<tr class="memdesc:aecb5a81b64d808f474cb4e5c722dc76b"><td class="mdescLeft">&#160;</td><td class="mdescRight">String to specify the opacity scheme.  <a href="namespacemom__opacity.html#aecb5a81b64d808f474cb4e5c722dc76b">More...</a><br /></td></tr>
<tr class="separator:aecb5a81b64d808f474cb4e5c722dc76b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5e5e40ad5acbf12058294f2ea17a7368"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(10), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#a5e5e40ad5acbf12058294f2ea17a7368">morel_88_string</a> = &quot;MOREL_88&quot;</td></tr>
<tr class="memdesc:a5e5e40ad5acbf12058294f2ea17a7368"><td class="mdescLeft">&#160;</td><td class="mdescRight">String to specify the opacity scheme.  <a href="namespacemom__opacity.html#a5e5e40ad5acbf12058294f2ea17a7368">More...</a><br /></td></tr>
<tr class="separator:a5e5e40ad5acbf12058294f2ea17a7368"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad430c567c09952e6ecfd07d6c05c8f69"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(10), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#ad430c567c09952e6ecfd07d6c05c8f69">single_exp_string</a> = &quot;SINGLE_EXP&quot;</td></tr>
<tr class="memdesc:ad430c567c09952e6ecfd07d6c05c8f69"><td class="mdescLeft">&#160;</td><td class="mdescRight">String to specify the opacity scheme.  <a href="namespacemom__opacity.html#ad430c567c09952e6ecfd07d6c05c8f69">More...</a><br /></td></tr>
<tr class="separator:ad430c567c09952e6ecfd07d6c05c8f69"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5a3d62dfb71c22ac0b13a312c8d23c70"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(10), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#a5a3d62dfb71c22ac0b13a312c8d23c70">double_exp_string</a> = &quot;DOUBLE_EXP&quot;</td></tr>
<tr class="memdesc:a5a3d62dfb71c22ac0b13a312c8d23c70"><td class="mdescLeft">&#160;</td><td class="mdescRight">String to specify the opacity scheme.  <a href="namespacemom__opacity.html#a5a3d62dfb71c22ac0b13a312c8d23c70">More...</a><br /></td></tr>
<tr class="separator:a5a3d62dfb71c22ac0b13a312c8d23c70"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9e2e33c15dd65f100263da9efc0934a6"><td class="memItemLeft" align="right" valign="top">real, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#a9e2e33c15dd65f100263da9efc0934a6">op_diag_len</a> = 1e-10</td></tr>
<tr class="memdesc:a9e2e33c15dd65f100263da9efc0934a6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Lengthscale L used to remap opacity from op to 1/L * tanh(op * L)  <a href="namespacemom__opacity.html#a9e2e33c15dd65f100263da9efc0934a6">More...</a><br /></td></tr>
<tr class="separator:a9e2e33c15dd65f100263da9efc0934a6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a675243222a55e7091e5e597f9c0a9b24"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#a675243222a55e7091e5e597f9c0a9b24">set_opacity</a> (optics, sw_total, sw_vis_dir, sw_vis_dif, sw_nir_dir, sw_nir_dif, G, GV, CS, chl_2d, chl_3d)</td></tr>
<tr class="memdesc:a675243222a55e7091e5e597f9c0a9b24"><td class="mdescLeft">&#160;</td><td class="mdescRight">This sets the opacity of sea water based based on one of several different schemes.  <a href="namespacemom__opacity.html#a675243222a55e7091e5e597f9c0a9b24">More...</a><br /></td></tr>
<tr class="separator:a675243222a55e7091e5e597f9c0a9b24"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad99a489a9081744a17f88d984f0d128d"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#ad99a489a9081744a17f88d984f0d128d">opacity_from_chl</a> (optics, sw_total, sw_vis_dir, sw_vis_dif, sw_nir_dir, sw_nir_dif, G, GV, CS, chl_2d, chl_3d)</td></tr>
<tr class="memdesc:ad99a489a9081744a17f88d984f0d128d"><td class="mdescLeft">&#160;</td><td class="mdescRight">This sets the "blue" band opacity based on chloophyll A concencentrations The red portion is lumped into the net heating at the surface.  <a href="namespacemom__opacity.html#ad99a489a9081744a17f88d984f0d128d">More...</a><br /></td></tr>
<tr class="separator:ad99a489a9081744a17f88d984f0d128d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4498b4bb6fcf1b7d849f89aa87c0332e"><td class="memItemLeft" align="right" valign="top">real function, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#a4498b4bb6fcf1b7d849f89aa87c0332e">opacity_morel</a> (chl_data)</td></tr>
<tr class="memdesc:a4498b4bb6fcf1b7d849f89aa87c0332e"><td class="mdescLeft">&#160;</td><td class="mdescRight">This sets the blue-wavelength opacity according to the scheme proposed by Morel and Antoine (1994).  <a href="namespacemom__opacity.html#a4498b4bb6fcf1b7d849f89aa87c0332e">More...</a><br /></td></tr>
<tr class="separator:a4498b4bb6fcf1b7d849f89aa87c0332e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0017241c03e4536115674fc5fc9608bf"><td class="memItemLeft" align="right" valign="top">real function&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#a0017241c03e4536115674fc5fc9608bf">sw_pen_frac_morel</a> (chl_data)</td></tr>
<tr class="memdesc:a0017241c03e4536115674fc5fc9608bf"><td class="mdescLeft">&#160;</td><td class="mdescRight">This sets the penetrating shortwave fraction according to the scheme proposed by Morel and Antoine (1994).  <a href="namespacemom__opacity.html#a0017241c03e4536115674fc5fc9608bf">More...</a><br /></td></tr>
<tr class="separator:a0017241c03e4536115674fc5fc9608bf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a27873e3942c2ff7980cf516944f78f03"><td class="memItemLeft" align="right" valign="top">real function, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#a27873e3942c2ff7980cf516944f78f03">opacity_manizza</a> (chl_data)</td></tr>
<tr class="memdesc:a27873e3942c2ff7980cf516944f78f03"><td class="mdescLeft">&#160;</td><td class="mdescRight">This sets the blue-wavelength opacity according to the scheme proposed by Manizza, M. et al, 2005.  <a href="namespacemom__opacity.html#a27873e3942c2ff7980cf516944f78f03">More...</a><br /></td></tr>
<tr class="separator:a27873e3942c2ff7980cf516944f78f03"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4c1942f798619a9ad854d1152ebcab63"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#a4c1942f798619a9ad854d1152ebcab63">extract_optics_slice</a> (optics, j, G, GV, opacity, opacity_scale, penSW_top, penSW_scale)</td></tr>
<tr class="memdesc:a4c1942f798619a9ad854d1152ebcab63"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine returns a 2-d slice at constant j of fields from an <a class="el" href="structmom__opacity_1_1optics__type.html" title="This type is used to store information about ocean optical properties.">optics_type</a>, with the potential for rescaling these fields.  <a href="namespacemom__opacity.html#a4c1942f798619a9ad854d1152ebcab63">More...</a><br /></td></tr>
<tr class="separator:a4c1942f798619a9ad854d1152ebcab63"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aefdfc303272a4f4fc07f84a8aea2b0f1"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#aefdfc303272a4f4fc07f84a8aea2b0f1">extract_optics_fields</a> (optics, nbands)</td></tr>
<tr class="memdesc:aefdfc303272a4f4fc07f84a8aea2b0f1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set arguments to fields from the optics type.  <a href="namespacemom__opacity.html#aefdfc303272a4f4fc07f84a8aea2b0f1">More...</a><br /></td></tr>
<tr class="separator:aefdfc303272a4f4fc07f84a8aea2b0f1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a349c6934f113d238e4e2ef229b931a0c"><td class="memItemLeft" align="right" valign="top">integer function, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#a349c6934f113d238e4e2ef229b931a0c">optics_nbands</a> (optics)</td></tr>
<tr class="memdesc:a349c6934f113d238e4e2ef229b931a0c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return the number of bands of penetrating shortwave radiation.  <a href="namespacemom__opacity.html#a349c6934f113d238e4e2ef229b931a0c">More...</a><br /></td></tr>
<tr class="separator:a349c6934f113d238e4e2ef229b931a0c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a21db9da24cea8b875040ba1e7e8b2e9b"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#a21db9da24cea8b875040ba1e7e8b2e9b">absorbremainingsw</a> (G, GV, US, h, opacity_band, nsw, optics, j, dt, H_limit_fluxes, adjustAbsorptionProfile, absorbAllSW, T, Pen_SW_bnd, eps, ksort, htot, Ttot, TKE, dSV_dT)</td></tr>
<tr class="memdesc:a21db9da24cea8b875040ba1e7e8b2e9b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Apply shortwave heating below the boundary layer (when running with the bulk mixed layer inhereted from GOLD) or throughout the water column.  <a href="namespacemom__opacity.html#a21db9da24cea8b875040ba1e7e8b2e9b">More...</a><br /></td></tr>
<tr class="separator:a21db9da24cea8b875040ba1e7e8b2e9b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad27db4bd0d010d98a3f5a54902c7a05e"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#ad27db4bd0d010d98a3f5a54902c7a05e">sumswoverbands</a> (G, GV, US, h, nsw, optics, j, dt, H_limit_fluxes, absorbAllSW, iPen_SW_bnd, netPen)</td></tr>
<tr class="memdesc:ad27db4bd0d010d98a3f5a54902c7a05e"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine calculates the total shortwave heat flux integrated over bands as a function of depth. This routine is only called for computing buoyancy fluxes for use in KPP. This routine does not updat e the state.  <a href="namespacemom__opacity.html#ad27db4bd0d010d98a3f5a54902c7a05e">More...</a><br /></td></tr>
<tr class="separator:ad27db4bd0d010d98a3f5a54902c7a05e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a39fce7bd33a469e3e9fe7cfeb51825b5"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#a39fce7bd33a469e3e9fe7cfeb51825b5">opacity_init</a> (Time, G, GV, US, param_file, diag, CS, optics)</td></tr>
<tr class="memdesc:a39fce7bd33a469e3e9fe7cfeb51825b5"><td class="mdescLeft">&#160;</td><td class="mdescRight">This routine initalizes the opacity module, including an <a class="el" href="structmom__opacity_1_1optics__type.html" title="This type is used to store information about ocean optical properties.">optics_type</a>.  <a href="namespacemom__opacity.html#a39fce7bd33a469e3e9fe7cfeb51825b5">More...</a><br /></td></tr>
<tr class="separator:a39fce7bd33a469e3e9fe7cfeb51825b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab5c0caabbf8a806a95bcc416da673841"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__opacity.html#ab5c0caabbf8a806a95bcc416da673841">opacity_end</a> (CS, optics)</td></tr>
<tr class="separator:ab5c0caabbf8a806a95bcc416da673841"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a21db9da24cea8b875040ba1e7e8b2e9b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a21db9da24cea8b875040ba1e7e8b2e9b">&#9670;&nbsp;</a></span>absorbremainingsw()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_opacity::absorbremainingsw </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(max(1,nsw), g %isd: g %ied, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>opacity_band</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nsw</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__opacity_1_1optics__type.html">optics_type</a>), intent(in)&#160;</td>
          <td class="paramname"><em>optics</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>H_limit_fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>adjustAbsorptionProfile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>absorbAllSW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, gv %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>T</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(max(1,nsw), g %isd: g %ied), intent(inout)&#160;</td>
          <td class="paramname"><em>Pen_SW_bnd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, gv %ke), intent(in), optional&#160;</td>
          <td class="paramname"><em>eps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension( g %isd: g %ied, gv %ke), intent(in), optional&#160;</td>
          <td class="paramname"><em>ksort</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied), intent(in), optional&#160;</td>
          <td class="paramname"><em>htot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied), intent(inout), optional&#160;</td>
          <td class="paramname"><em>Ttot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, gv %ke), intent(inout), optional&#160;</td>
          <td class="paramname"><em>TKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, gv %ke), intent(in), optional&#160;</td>
          <td class="paramname"><em>dSV_dT</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Apply shortwave heating below the boundary layer (when running with the bulk mixed layer inhereted from GOLD) or throughout the water column. </p>
<p>In addition, it causes all of the remaining SW radiation to be absorbed, provided that the total water column thickness is greater than H_limit_fluxes. For thinner water columns, the heating is scaled down proportionately, the assumption being that the remaining heating (which is left in Pen_SW) should go into an (absent for now) ocean bottom sediment layer. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nsw</td><td>Number of bands of penetrating shortwave radiation. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">opacity_band</td><td>Opacity in each band of penetrating shortwave radiation [H-1 ~&gt; m-1 or m2 kg-1]. The indicies are band, i, k. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">optics</td><td>An optics structure that has values of opacities and shortwave fluxes. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>j-index to work on. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time step [T ~&gt; s]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h_limit_fluxes</td><td>If the total ocean depth is less than this, they are scaled away to avoid numerical instabilities [H ~&gt; m or kg m-2]. This would not be necessary if a finite heat capacity mud-layer were added. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">adjustabsorptionprofile</td><td>If true, apply heating above the layers in which it should have occurred to get the correct mean depth (and potential energy change) of the shortwave that should be absorbed by each layer. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">absorballsw</td><td>If true, apply heating above the layers in which it should have occurred to get the correct mean depth (and potential energy change) of the shortwave that should be absorbed by each layer. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">t</td><td>Layer potential/conservative temperatures [degC] </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">pen_sw_bnd</td><td>Penetrating shortwave heating in each band that hits the bottom and will will be redistributed through the water column [degC H ~&gt; degC m or degC kg m-2], size nsw x G isd: G ied. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">eps</td><td>Small thickness that must remain in each layer, and which will not be subject to heating [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ksort</td><td>Density-sorted k-indicies. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">htot</td><td>Total mixed layer thickness [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ttot</td><td>Depth integrated mixed layer temperature [degC H ~&gt; degC m or degC kg m-2] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dsv_dt</td><td>The partial derivative of specific volume with temperature [R-1 degC-1]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">tke</td><td>The TKE sink from mixing the heating throughout a layer [R Z3 T-2 ~&gt; J m-2]. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00512">512</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160; </div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),             <span class="keywordtype">intent(in)</span>    :: G<span class="comment">    !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type),           <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">   !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),             <span class="keywordtype">intent(in)</span>    :: US<span class="comment">   !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;  <span class="keywordtype">integer</span>,                           <span class="keywordtype">intent(in)</span>    :: nsw<span class="comment">  !&lt; Number of bands of penetrating</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;<span class="comment">                                                           !! shortwave radiation.</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(in)</span>    :: h<span class="comment">    !&lt; Layer thicknesses [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(max(1,nsw),SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(in)</span> :: opacity_band<span class="comment"> !&lt; Opacity in each band of penetrating</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="comment">                                                           !! shortwave radiation [H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="comment">                                                           !! The indicies are band, i, k.</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;  <span class="keywordtype">type</span>(optics_type),                 <span class="keywordtype">intent(in)</span>    :: optics<span class="comment"> !&lt; An optics structure that has values of</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="comment">                                                           !! opacities and shortwave fluxes.</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;  <span class="keywordtype">integer</span>,                           <span class="keywordtype">intent(in)</span>    :: j<span class="comment">    !&lt; j-index to work on.</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="keywordtype">  real</span>,                              <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">   !&lt; Time step [T ~&gt; s].</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="keywordtype">  real</span>,                              <span class="keywordtype">intent(in)</span>    :: H_limit_fluxes<span class="comment"> !&lt; If the total ocean depth is</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;<span class="comment">                                                           !! less than this, they are scaled away</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="comment">                                                           !! to avoid numerical instabilities</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="comment">                                                           !! [H ~&gt; m or kg m-2]. This would</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="comment">                                                           !! not be necessary if a finite heat</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="comment">                                                           !! capacity mud-layer were added.</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;  <span class="keywordtype">logical</span>,                          <span class="keywordtype">intent(in)</span>    :: adjustAbsorptionProfile<span class="comment"> !&lt; If true, apply</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;<span class="comment">                                                           !! heating above the layers in which it</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;<span class="comment">                                                           !! should have occurred to get the</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;<span class="comment">                                                           !! correct mean depth (and potential</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="comment">                                                           !! energy change) of the shortwave that</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="comment">                                                           !! should be absorbed by each layer.</span></div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;  <span class="keywordtype">logical</span>,                          <span class="keywordtype">intent(in)</span>    :: absorbAllSW<span class="comment"> !&lt; If true, apply heating above the</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="comment">                                                           !! layers in which it should have occurred</span></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="comment">                                                           !! to get the correct mean depth (and</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="comment">                                                           !! potential energy change) of the</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="comment">                                                           !! shortwave that should be absorbed by</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="comment">                                                           !! each layer.</span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: T<span class="comment">    !&lt; Layer potential/conservative</span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="comment">                                                           !! temperatures [degC]</span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(max(1,nsw),SZI_(G))</span>, <span class="keywordtype">intent(inout)</span> :: Pen_SW_bnd<span class="comment"> !&lt; Penetrating shortwave heating in</span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="comment">                                                           !! each band that hits the bottom and will</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="comment">                                                           !! will be redistributed through the water</span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="comment">                                                           !! column [degC H ~&gt; degC m or degC kg m-2],</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="comment">                                                           !! size nsw x SZI_(G).</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: eps<span class="comment"> !&lt; Small thickness that must remain in</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="comment">                                                           !! each layer, and which will not be</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="comment">                                                           !! subject to heating [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: ksort<span class="comment"> !&lt; Density-sorted k-indicies.</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: htot<span class="comment"> !&lt; Total mixed layer thickness [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(inout)</span> :: Ttot<span class="comment"> !&lt; Depth integrated mixed layer</span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="comment">                                                           !! temperature [degC H ~&gt; degC m or degC kg m-2]</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: dSV_dT<span class="comment"> !&lt; The partial derivative of specific</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="comment">                                                           !! volume with temperature [R-1 degC-1].</span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(inout)</span> :: TKE<span class="comment"> !&lt; The TKE sink from mixing the heating</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="comment">                                                           !! throughout a layer [R Z3 T-2 ~&gt; J m-2].</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160; </div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span> :: &amp;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    T_chg_above    <span class="comment">! A temperature change that will be applied to all the thick</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                   <span class="comment">! layers above a given layer [degC].  This is only nonzero if</span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                   <span class="comment">! adjustAbsorptionProfile is true, in which case the net</span></div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                   <span class="comment">! change in the temperature of a layer is the sum of the</span></div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;                   <span class="comment">! direct heating of that layer plus T_chg_above from all of</span></div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                   <span class="comment">! the layers below, plus any contribution from absorbing</span></div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                   <span class="comment">! radiation that hits the bottom.</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    h_heat, &amp;      <span class="comment">! The thickness of the water column that will be heated by</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                   <span class="comment">! any remaining shortwave radiation [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    t_chg, &amp;       <span class="comment">! The temperature change of thick layers due to the remaining</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                   <span class="comment">! shortwave radiation and contributions from T_chg_above [degC].</span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    pen_sw_rem     <span class="comment">! The sum across all wavelength bands of the penetrating shortwave</span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                   <span class="comment">! heating that hits the bottom and will be redistributed through</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;                   <span class="comment">! the water column [degC H ~&gt; degC m or degC kg m-2]</span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;<span class="keywordtype">  real</span> :: SW_trans          <span class="comment">! fraction of shortwave radiation that is not</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;                            <span class="comment">! absorbed in a layer [nondim]</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;<span class="keywordtype">  real</span> :: unabsorbed        <span class="comment">! fraction of the shortwave radiation that</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;                            <span class="comment">! is not absorbed because the layers are too thin</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="keywordtype">  real</span> :: Ih_limit          <span class="comment">! inverse of the total depth at which the</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                            <span class="comment">! surface fluxes start to be limited [H-1 ~&gt; m-1 or m2 kg-1]</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="keywordtype">  real</span> :: h_min_heat        <span class="comment">! minimum thickness layer that should get heated [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;<span class="keywordtype">  real</span> :: opt_depth         <span class="comment">! optical depth of a layer [nondim]</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;<span class="keywordtype">  real</span> :: exp_OD            <span class="comment">! exp(-opt_depth) [nondim]</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;<span class="keywordtype">  real</span> :: heat_bnd          <span class="comment">! heating due to absorption in the current</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;                            <span class="comment">! layer by the current band, including any piece that</span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;                            <span class="comment">! is moved upward [degC H ~&gt; degC m or degC kg m-2]</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="keywordtype">  real</span> :: SWa               <span class="comment">! fraction of the absorbed shortwave that is</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                            <span class="comment">! moved to layers above with adjustAbsorptionProfile [nondim]</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="keywordtype">  real</span> :: coSWa_frac        <span class="comment">! The fraction of SWa that is actually moved upward.</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;<span class="keywordtype">  real</span> :: min_SW_heat       <span class="comment">! A minimum remaining shortwave heating within a timestep that will be simply</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                            <span class="comment">! absorbed in the next layer for computational efficiency, instead of</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                            <span class="comment">! continuing to penetrate [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;<span class="keywordtype">  real</span> :: I_Habs            <span class="comment">! The inverse of the absorption length for a minimal flux [H-1 ~&gt; m-1 or m2 kg-1]</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="keywordtype">  real</span> :: epsilon           <span class="comment">! A small thickness that must remain in each</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                            <span class="comment">! layer, and which will not be subject to heating [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;<span class="keywordtype">  real</span> :: g_Hconv2          <span class="comment">! A conversion factor for use in the TKE calculation</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                            <span class="comment">! in units of [Z3 R2 T-2 H-2 ~&gt; kg2 m-5 s-2 or m s-2].</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;  <span class="keywordtype">logical</span> :: SW_Remains     <span class="comment">! If true, some column has shortwave radiation that</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                            <span class="comment">! was not entirely absorbed.</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;  <span class="keywordtype">logical</span> :: TKE_calc       <span class="comment">! If true, calculate the implications to the</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                            <span class="comment">! TKE budget of the shortwave heating.</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;<span class="keywordtype">  real</span> :: C1_6, C1_60</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, nz, i, k, ks, n</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;  sw_remains = .false.</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160; </div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;  min_sw_heat = optics%PenSW_flux_absorb * dt</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;  i_habs = optics%PenSW_absorb_Invlen</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160; </div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;  h_min_heat = 2.0*gv%Angstrom_H + gv%H_subroundoff</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;  is = g%isc ; ie = g%iec ; nz = g%ke</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;  c1_6 = 1.0 / 6.0 ; c1_60 = 1.0 / 60.0</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160; </div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;  tke_calc = (<span class="keyword">present</span>(tke) .and. <span class="keyword">present</span>(dsv_dt))</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160; </div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;  <span class="keywordflow">if</span> (optics%answers_2018) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    g_hconv2 = (us%L_to_Z**2*gv%g_Earth * gv%H_to_RZ) * gv%H_to_RZ</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    g_hconv2 = us%L_to_Z**2*gv%g_Earth * gv%H_to_RZ**2</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160; </div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;  h_heat(:) = 0.0</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(htot)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=is,ie ; h_heat(i) = htot(i) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160; </div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;  <span class="comment">! Apply penetrating SW radiation to remaining parts of layers.</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;  <span class="comment">! Excessively thin layers are not heated to avoid runaway temps.</span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;  <span class="keywordflow">do</span> ks=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    k = ks</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(ksort)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;      <span class="keywordflow">if</span> (ksort(i,ks) &lt;= 0) cycle</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;      k = ksort(i,ks)</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    epsilon = 0.0 ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(eps)) epsilon = eps(i,k)</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160; </div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    t_chg_above(i,k) = 0.0</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160; </div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    <span class="keywordflow">if</span> (h(i,k) &gt; 1.5*epsilon) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;      <span class="keywordflow">do</span> n=1,nsw ; <span class="keywordflow">if</span> (pen_sw_bnd(n,i) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;        <span class="comment">! SW_trans is the SW that is transmitted THROUGH the layer</span></div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;        opt_depth = h(i,k) * opacity_band(n,i,k)</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;        exp_od = exp(-opt_depth)</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;        sw_trans = exp_od</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160; </div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        <span class="comment">! Heating at a very small rate can be absorbed by a sufficiently thick layer or several</span></div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        <span class="comment">! thin layers without further penetration.</span></div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;        <span class="keywordflow">if</span> (optics%answers_2018) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;          <span class="keywordflow">if</span> (nsw*pen_sw_bnd(n,i)*sw_trans &lt; min_sw_heat*min(1.0, i_habs*h(i,k)) ) sw_trans = 0.0</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        <span class="keywordflow">elseif</span> ((nsw*pen_sw_bnd(n,i)*sw_trans &lt; min_sw_heat) .and. (h(i,k) &gt; h_min_heat)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;          <span class="keywordflow">if</span> (nsw*pen_sw_bnd(n,i) &lt;= min_sw_heat * (i_habs*(h(i,k) - h_min_heat))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;            sw_trans = 0.0</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            sw_trans = min(sw_trans, &amp;</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                           1.0 - (min_sw_heat*(i_habs*(h(i,k) - h_min_heat))) / (nsw*pen_sw_bnd(n,i)))</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160; </div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;        heat_bnd = pen_sw_bnd(n,i) * (1.0 - sw_trans)</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;        <span class="keywordflow">if</span> (adjustabsorptionprofile .and. (h_heat(i) &gt; 0.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;          <span class="comment">!   In this case, a fraction of the heating is applied to the</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;          <span class="comment">! overlying water so that the mean pressure at which the shortwave</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;          <span class="comment">! heating occurs is exactly what it would have been with a careful</span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;          <span class="comment">! pressure-weighted averaging of the exponential heating profile,</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;          <span class="comment">! hence there should be no TKE budget requirements due to this</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;          <span class="comment">! layer.  Very clever, but this is also limited so that the</span></div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;          <span class="comment">! water above is not heated at a faster rate than the layer</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;          <span class="comment">! actually being heated, i.e., SWA &lt;= h_heat / (h_heat + h(i,k))</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;          <span class="comment">! and takes the energetics of the rest of the heating into account.</span></div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;          <span class="comment">! (-RWH, ~7 years later.)</span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;          <span class="keywordflow">if</span> (opt_depth &gt; 1e-5) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;            swa = ((opt_depth + (opt_depth + 2.0)*exp_od) - 2.0) / &amp;</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;              ((opt_depth + opacity_band(n,i,k) * h_heat(i)) * &amp;</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;               (1.0 - exp_od))</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;            <span class="comment">! Use Taylor series expansion of the expression above for a</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;            <span class="comment">! more accurate form with very small layer optical depths.</span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;            swa = h(i,k) * (opt_depth * (1.0 - opt_depth)) / &amp;</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;              ((h_heat(i) + h(i,k)) * (6.0 - 3.0*opt_depth))</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;          coswa_frac = 0.0</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;          <span class="keywordflow">if</span> (swa*(h_heat(i) + h(i,k)) &gt; h_heat(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;            coswa_frac = (swa*(h_heat(i) + h(i,k)) - h_heat(i) ) / &amp;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;                         (swa*(h_heat(i) + h(i,k)))</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            swa = h_heat(i) / (h_heat(i) + h(i,k))</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160; </div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;          t_chg_above(i,k) = t_chg_above(i,k) + (swa * heat_bnd) / h_heat(i)</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;          t(i,k) = t(i,k) + ((1.0 - swa) * heat_bnd) / h(i,k)</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;          coswa_frac = 1.0</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;          t(i,k) = t(i,k) + pen_sw_bnd(n,i) * (1.0 - sw_trans) / h(i,k)</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160; </div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        <span class="keywordflow">if</span> (tke_calc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;          <span class="keywordflow">if</span> (opt_depth &gt; 1e-2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;            tke(i,k) = tke(i,k) - coswa_frac*heat_bnd*dsv_dt(i,k)* &amp;</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;               (0.5*h(i,k)*g_hconv2) * &amp;</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;               (opt_depth*(1.0+exp_od) - 2.0*(1.0-exp_od)) / (opt_depth*(1.0-exp_od))</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;            <span class="comment">! Use Taylor series-derived approximation to the above expression</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;            <span class="comment">! that is well behaved and more accurate when opt_depth is small.</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;            tke(i,k) = tke(i,k) - coswa_frac*heat_bnd*dsv_dt(i,k)* &amp;</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;               (0.5*h(i,k)*g_hconv2) * &amp;</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;               (c1_6*opt_depth * (1.0 - c1_60*opt_depth**2))</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160; </div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        pen_sw_bnd(n,i) = pen_sw_bnd(n,i) * sw_trans</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160; </div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    <span class="comment">! Add to the accumulated thickness above that could be heated.</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <span class="comment">! Only layers greater than h_min_heat thick should get heated.</span></div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    <span class="keywordflow">if</span> (h(i,k) &gt;= 2.0*h_min_heat) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;      h_heat(i) = h_heat(i) + h(i,k)</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    <span class="keywordflow">elseif</span> (h(i,k) &gt; h_min_heat) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;      h_heat(i) = h_heat(i) + (2.0*h(i,k) - 2.0*h_min_heat)</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i &amp; k loops</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160; </div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160; </div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;<span class="comment">! if (.not.absorbAllSW .and. .not.adjustAbsorptionProfile) return</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160; </div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;  <span class="comment">! Unless modified, there is no temperature change due to fluxes from the bottom.</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; t_chg(i) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160; </div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;  <span class="keywordflow">if</span> (absorballsw) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    <span class="comment">! If there is still shortwave radiation at this point, it could go into</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;    <span class="comment">! the bottom (with a bottom mud model), or it could be redistributed back</span></div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    <span class="comment">! through the water column.</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;      pen_sw_rem(i) = pen_sw_bnd(1,i)</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;      <span class="keywordflow">do</span> n=2,nsw ; pen_sw_rem(i) = pen_sw_rem(i) + pen_sw_bnd(n,i) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (pen_sw_rem(i) &gt; 0.0) sw_remains = .true. ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160; </div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    ih_limit = 1.0 / h_limit_fluxes</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> ((pen_sw_rem(i) &gt; 0.0) .and. (h_heat(i) &gt; 0.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;      <span class="keywordflow">if</span> (h_heat(i)*ih_limit &gt;= 1.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;        t_chg(i) = pen_sw_rem(i) / h_heat(i) ; unabsorbed = 0.0</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;        t_chg(i) = pen_sw_rem(i) * ih_limit</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;        unabsorbed = 1.0 - h_heat(i)*ih_limit</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;      <span class="keywordflow">do</span> n=1,nsw ; pen_sw_bnd(n,i) = unabsorbed * pen_sw_bnd(n,i) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! absorbAllSW</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160; </div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;  <span class="keywordflow">if</span> (absorballsw .or. adjustabsorptionprofile) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    <span class="keywordflow">do</span> ks=nz,1,-1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;      k = ks</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(ksort)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;        <span class="keywordflow">if</span> (ksort(i,ks) &lt;= 0) cycle</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;        k = ksort(i,ks)</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160; </div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;      <span class="keywordflow">if</span> (t_chg(i) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        <span class="comment">! Only layers greater than h_min_heat thick should get heated.</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        <span class="keywordflow">if</span> (h(i,k) &gt;= 2.0*h_min_heat) <span class="keywordflow">then</span> ; t(i,k) = t(i,k) + t_chg(i)</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;        <span class="keywordflow">elseif</span> (h(i,k) &gt; h_min_heat) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;          t(i,k) = t(i,k) + t_chg(i) * (2.0 - 2.0*h_min_heat/h(i,k))</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;      <span class="comment">! Increase the heating for layers above.</span></div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;      t_chg(i) = t_chg(i) + t_chg_above(i,k)</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(htot) .and. <span class="keyword">present</span>(ttot)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; ttot(i) = ttot(i) + t_chg(i) * htot(i) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! absorbAllSW .or. adjustAbsorptionProfile</span></div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00853">mom_diabatic_aux::applyboundaryfluxesinout()</a>, and <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00189">mom_bulk_mixed_layer::bulkmixedlayer()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__opacity_a21db9da24cea8b875040ba1e7e8b2e9b_icgraph.svg" width="100%" height="378"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="aefdfc303272a4f4fc07f84a8aea2b0f1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aefdfc303272a4f4fc07f84a8aea2b0f1">&#9670;&nbsp;</a></span>extract_optics_fields()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_opacity::extract_optics_fields </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__opacity_1_1optics__type.html">optics_type</a>), intent(in)&#160;</td>
          <td class="paramname"><em>optics</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(out), optional&#160;</td>
          <td class="paramname"><em>nbands</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set arguments to fields from the optics type. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">optics</td><td>An optics structure that has values of opacities and shortwave fluxes. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">nbands</td><td>The number of penetrating bands of SW radiation </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00485">485</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;  <span class="keywordtype">type</span>(optics_type),       <span class="keywordtype">intent(in)</span>  :: optics<span class="comment"> !&lt; An optics structure that has values of opacities</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="comment">                                                 !! and shortwave fluxes.</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">optional</span>,       <span class="keywordtype">intent(out)</span> :: nbands<span class="comment"> !&lt; The number of penetrating bands of SW radiation</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160; </div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(nbands)) nbands = optics%nbands</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160; </div>
</div><!-- fragment -->
</div>
</div>
<a id="a4c1942f798619a9ad854d1152ebcab63"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4c1942f798619a9ad854d1152ebcab63">&#9670;&nbsp;</a></span>extract_optics_slice()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_opacity::extract_optics_slice </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__opacity_1_1optics__type.html">optics_type</a>), intent(in)&#160;</td>
          <td class="paramname"><em>optics</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(max(optics%nbands,1), g %isd: g %ied, gv %ke), intent(out), optional&#160;</td>
          <td class="paramname"><em>opacity</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>opacity_scale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(max(optics%nbands,1), g %isd: g %ied), intent(out), optional&#160;</td>
          <td class="paramname"><em>penSW_top</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>penSW_scale</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine returns a 2-d slice at constant j of fields from an <a class="el" href="structmom__opacity_1_1optics__type.html" title="This type is used to store information about ocean optical properties.">optics_type</a>, with the potential for rescaling these fields. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">optics</td><td>An optics structure that has values of opacities and shortwave fluxes. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>j-index to extract </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">opacity</td><td>The opacity in each band, i-point, and layer </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">opacity_scale</td><td>A factor by which to rescale the opacity. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">pensw_top</td><td>The shortwave radiation [W m-2] at the surface </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">pensw_scale</td><td>A factor by which to rescale the shortwave flux. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00447">447</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;  <span class="keywordtype">type</span>(optics_type),       <span class="keywordtype">intent(in)</span>  :: optics<span class="comment">   !&lt; An optics structure that has values of opacities</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="comment">                                                   !! and shortwave fluxes.</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;  <span class="keywordtype">integer</span>,                 <span class="keywordtype">intent(in)</span>    :: j<span class="comment">      !&lt; j-index to extract</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">      !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">     !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(max(optics%nbands,1),SZI_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: opacity<span class="comment">   !&lt; The opacity in each band, i-point, and layer</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>,         <span class="keywordtype">intent(in)</span>  :: opacity_scale<span class="comment"> !&lt; A factor by which to rescale the opacity.</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(max(optics%nbands,1),SZI_(G))</span>, &amp;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span> :: penSW_top<span class="comment"> !&lt; The shortwave radiation [W m-2] at the surface</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="comment">                                                   !! in each of the nbands bands that penetrates</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;<span class="comment">                                                   !! beyond the surface skin layer.</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">optional</span>,         <span class="keywordtype">intent(in)</span>  :: penSW_scale<span class="comment"> !&lt; A factor by which to rescale the shortwave flux.</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160; </div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="keywordtype">  real</span> :: scale_opacity, scale_penSW <span class="comment">! Rescaling factors</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  <span class="keywordtype">integer</span> :: i, is, ie, k, nz, n</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  is = g%isc ; ie = g%iec ; nz = g%ke</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160; </div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  scale_opacity = 1.0 ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(opacity_scale)) scale_opacity = opacity_scale</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  scale_pensw = 1.0 ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(pensw_scale)) scale_pensw = pensw_scale</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160; </div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(opacity)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keywordflow">do</span> n=1,optics%nbands</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;      opacity(n,i,k) = scale_opacity * optics%opacity_band(n,i,j,k)</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160; </div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(pensw_top)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="keywordflow">do</span> n=1,optics%nbands</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;      pensw_top(n,i) = scale_pensw * optics%SW_pen_band(n,i,j)</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00189">mom_bulk_mixed_layer::bulkmixedlayer()</a>, and <a class="el" href="MOM__forcing__type_8F90_source.html#l00346">mom_forcing_type::extractfluxes1d()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__opacity_a4c1942f798619a9ad854d1152ebcab63_icgraph.svg" width="100%" height="454"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="ab5c0caabbf8a806a95bcc416da673841"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab5c0caabbf8a806a95bcc416da673841">&#9670;&nbsp;</a></span>opacity_end()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_opacity::opacity_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__opacity_1_1opacity__cs.html">opacity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__opacity_1_1optics__type.html">optics_type</a>), optional, pointer&#160;</td>
          <td class="paramname"><em>optics</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">cs</td><td>An opacity control structure that should be deallocated.</td></tr>
    <tr><td class="paramname">optics</td><td>An optics type structure that should be deallocated. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l01121">1121</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;  <span class="keywordtype">type</span>(opacity_CS),  <span class="keywordtype">pointer</span>           :: CS<span class="comment"> !&lt; An opacity control structure that should be deallocated.</span></div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;  <span class="keywordtype">type</span>(optics_type), <span class="keywordtype">optional</span>, <span class="keywordtype">pointer</span> :: optics<span class="comment"> !&lt; An optics type structure that should be deallocated.</span></div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160; </div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs%id_opacity)) <span class="keyword">deallocate</span>(cs%id_opacity)</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keyword">deallocate</span>(cs)</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160; </div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(optics)) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (<span class="keyword">associated</span>(optics)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(optics%opacity_band)) <span class="keyword">deallocate</span>(optics%opacity_band)</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(optics%sw_pen_band)) <span class="keyword">deallocate</span>(optics%sw_pen_band)</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160; </div>
</div><!-- fragment -->
</div>
</div>
<a id="ad99a489a9081744a17f88d984f0d128d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad99a489a9081744a17f88d984f0d128d">&#9670;&nbsp;</a></span>opacity_from_chl()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_opacity::opacity_from_chl </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__opacity_1_1optics__type.html">optics_type</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>optics</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>sw_total</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>sw_vis_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>sw_vis_dif</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>sw_nir_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>sw_nir_dif</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__opacity_1_1opacity__cs.html">opacity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(in), optional&#160;</td>
          <td class="paramname"><em>chl_2d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(in), optional&#160;</td>
          <td class="paramname"><em>chl_3d</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This sets the "blue" band opacity based on chloophyll A concencentrations The red portion is lumped into the net heating at the surface. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">optics</td><td>An optics structure that has values set based on the opacities. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">sw_total</td><td>Total shortwave flux into the ocean [W m-2] </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">sw_vis_dir</td><td>Visible, direct shortwave into the ocean [W m-2] </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">sw_vis_dif</td><td>Visible, diffuse shortwave into the ocean [W m-2] </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">sw_nir_dir</td><td>Near-IR, direct shortwave into the ocean [W m-2] </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">sw_nir_dif</td><td>Near-IR, diffuse shortwave into the ocean [W m-2] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">chl_2d</td><td>Vertically uniform chlorophyll-A concentractions [mg m-3] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">chl_3d</td><td>A 3-d field of chlorophyll-A concentractions [mg m-3] </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00222">222</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;  <span class="keywordtype">type</span>(optics_type),       <span class="keywordtype">intent(inout)</span> :: optics<span class="comment"> !&lt; An optics structure that has values</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="comment">                                                 !! set based on the opacities.</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:)</span>,    <span class="keywordtype">pointer</span>       :: sw_total<span class="comment"> !&lt; Total shortwave flux into the ocean [W m-2]</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:)</span>,    <span class="keywordtype">pointer</span>       :: sw_vis_dir<span class="comment"> !&lt; Visible, direct shortwave into the ocean [W m-2]</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:)</span>,    <span class="keywordtype">pointer</span>       :: sw_vis_dif<span class="comment"> !&lt; Visible, diffuse shortwave into the ocean [W m-2]</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:)</span>,    <span class="keywordtype">pointer</span>       :: sw_nir_dir<span class="comment"> !&lt; Near-IR, direct shortwave into the ocean [W m-2]</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:)</span>,    <span class="keywordtype">pointer</span>       :: sw_nir_dif<span class="comment"> !&lt; Near-IR, diffuse shortwave into the ocean [W m-2]</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">      !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">     !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;  <span class="keywordtype">type</span>(opacity_CS),        <span class="keywordtype">pointer</span>       :: CS<span class="comment">     !&lt; The control structure.</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>, &amp;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: chl_2d<span class="comment"> !&lt; Vertically uniform chlorophyll-A concentractions [mg m-3]</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: chl_3d<span class="comment"> !&lt; A 3-d field of chlorophyll-A concentractions [mg m-3]</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160; </div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="keywordtype">  real</span> :: chl_data(SZI_(G),SZJ_(G)) <span class="comment">! The chlorophyll A concentrations in a layer [mg m-3].</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="keywordtype">  real</span> :: Inv_nbands        <span class="comment">! The inverse of the number of bands of penetrating</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                            <span class="comment">! shortwave radiation.</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="keywordtype">  real</span> :: Inv_nbands_nir    <span class="comment">! The inverse of the number of bands of penetrating</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                            <span class="comment">! near-infrafed radiation.</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="keywordtype">  real</span> :: SW_pen_tot        <span class="comment">! The sum across the bands of the penetrating</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                            <span class="comment">! shortwave radiation [W m-2].</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="keywordtype">  real</span> :: SW_vis_tot        <span class="comment">! The sum across the visible bands of shortwave</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                            <span class="comment">! radiation [W m-2].</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="keywordtype">  real</span> :: SW_nir_tot        <span class="comment">! The sum across the near infrared bands of shortwave</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                            <span class="comment">! radiation [W m-2].</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;  <span class="keywordtype">type</span>(time_type) :: day</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;  <span class="keywordtype">character(len=128)</span> :: mesg</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, n, is, ie, js, je, nz, nbands</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  <span class="keywordtype">logical</span> :: multiband_vis_input, multiband_nir_input</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160; </div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = gv%ke</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160; </div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment">!   In this model, the Morel (modified) and Manizza (modified) schemes</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">! use the &quot;blue&quot; band in the parameterizations to determine the e-folding</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="comment">! depth of the incoming shortwave attenuation. The red portion is lumped</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="comment">! into the net heating at the surface.</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="comment">! Morel, A., Optical modeling of the upper ocean in relation to its biogenous</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment">!   matter content (case-i waters).,J. Geo. Res., {93}, 10,749--10,768, 1988.</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment">! Manizza, M., C.~L. Quere, A.~Watson, and E.~T. Buitenhuis, Bio-optical</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment">!   feedbacks among phytoplankton, upper ocean physics and sea-ice in a</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment">!   global model, Geophys. Res. Let., , L05,603, 2005.</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160; </div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;  nbands = optics%nbands</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160; </div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;  <span class="keywordflow">if</span> (nbands &lt;= 1) <span class="keywordflow">then</span> ; inv_nbands = 1.0</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;  <span class="keywordflow">else</span> ; inv_nbands = 1.0 / real(nbands) ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160; </div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;  <span class="keywordflow">if</span> (nbands &lt;= 2) <span class="keywordflow">then</span> ; inv_nbands_nir = 0.0</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;  <span class="keywordflow">else</span> ; inv_nbands_nir = 1.0 / real(nbands - 2.0) ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160; </div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  multiband_vis_input = (<span class="keyword">associated</span>(sw_vis_dir) .and. &amp;</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                         <span class="keyword">associated</span>(sw_vis_dif))</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;  multiband_nir_input = (<span class="keyword">associated</span>(sw_nir_dir) .and. &amp;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                         <span class="keyword">associated</span>(sw_nir_dif))</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160; </div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;  chl_data(:,:) = 0.0</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(chl_3d)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie ; chl_data(i,j) = chl_3d(i,j,1) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="keywordflow">do</span> k=1,nz; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;      <span class="keywordflow">if</span> ((g%mask2dT(i,j) &gt; 0.5) .and. (chl_3d(i,j,k) &lt; 0.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        <span class="keyword">write</span>(mesg,<span class="stringliteral">&#39;(&quot; Negative chl_3d of &quot;,(1pe12.4),&quot; found at i,j,k = &quot;, &amp;</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                  &amp; 3(1x,i3), &quot; lon/lat = &quot;,(1pe12.4),&quot; E &quot;, (1pe12.4), &quot; N.&quot;)&#39;</span>) &amp;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                   chl_3d(i,j,k), i, j, k, g%geoLonT(i,j), g%geoLatT(i,j)</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_opacity opacity_from_chl: &quot;</span>//trim(mesg))</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  <span class="keywordflow">elseif</span> (<span class="keyword">present</span>(chl_2d)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie ; chl_data(i,j) = chl_2d(i,j) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;      <span class="keywordflow">if</span> ((g%mask2dT(i,j) &gt; 0.5) .and. (chl_2d(i,j) &lt; 0.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <span class="keyword">write</span>(mesg,<span class="stringliteral">&#39;(&quot; Negative chl_2d of &quot;,(1pe12.4),&quot; at i,j = &quot;, &amp;</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                  &amp; 2(i3), &quot;lon/lat = &quot;,(1pe12.4),&quot; E &quot;, (1pe12.4), &quot; N.&quot;)&#39;</span>) &amp;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                   chl_data(i,j), i, j, g%geoLonT(i,j), g%geoLatT(i,j)</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_opacity opacity_from_chl: &quot;</span>//trim(mesg))</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;Either chl_2d or chl_3d must be preesnt in a call to opacity_form_chl.&quot;</span>)</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160; </div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;  <span class="keywordflow">select case</span> (cs%opacity_scheme)</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="keywordflow">case</span> (manizza_05)</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;      <span class="comment">!$OMP parallel do default(shared) private(SW_vis_tot,SW_nir_tot)</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        sw_vis_tot = 0.0 ; sw_nir_tot = 0.0</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        <span class="keywordflow">if</span> (g%mask2dT(i,j) &gt; 0.5) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;          <span class="keywordflow">if</span> (multiband_vis_input) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;            sw_vis_tot = sw_vis_dir(i,j) + sw_vis_dif(i,j)</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;          <span class="keywordflow">else</span>  <span class="comment">! Follow Manizza 05 in assuming that 42% of SW is visible.</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;            sw_vis_tot = 0.42 * sw_total(i,j)</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;          <span class="keywordflow">if</span> (multiband_nir_input) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;            sw_nir_tot = sw_nir_dir(i,j) + sw_nir_dif(i,j)</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;            sw_nir_tot = sw_total(i,j) - sw_vis_tot</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160; </div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        <span class="comment">! Band 1 is Manizza blue.</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        optics%sw_pen_band(1,i,j) = cs%blue_frac*sw_vis_tot</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <span class="comment">! Band 2 (if used) is Manizza red.</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="keywordflow">if</span> (nbands &gt; 1) &amp;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;          optics%sw_pen_band(2,i,j) = (1.0-cs%blue_frac)*sw_vis_tot</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        <span class="comment">! All remaining bands are NIR, for lack of something better to do.</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        <span class="keywordflow">do</span> n=3,nbands</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;          optics%sw_pen_band(n,i,j) = inv_nbands_nir * sw_nir_tot</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <span class="keywordflow">case</span> (morel_88)</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;      <span class="comment">!$OMP parallel do default(shared) private(SW_pen_tot)</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        sw_pen_tot = 0.0</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        <span class="keywordflow">if</span> (g%mask2dT(i,j) &gt; 0.5) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (multiband_vis_input) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;            sw_pen_tot = sw_pen_frac_morel(chl_data(i,j)) * &amp;</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                (sw_vis_dir(i,j) + sw_vis_dif(i,j))</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;            sw_pen_tot = sw_pen_frac_morel(chl_data(i,j)) * &amp;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                0.5*sw_total(i,j)</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160; </div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        <span class="keywordflow">do</span> n=1,nbands</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;          optics%sw_pen_band(n,i,j) = inv_nbands*sw_pen_tot</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="keywordflow">    case default</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;opacity_from_chl: CS%opacity_scheme is not valid.&quot;</span>)</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keywordflow">  end select</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160; </div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;  <span class="comment">!$OMP parallel do default(shared) firstprivate(chl_data)</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;  <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(chl_3d)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie ; chl_data(i,j) = chl_3d(i,j,k) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160; </div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    <span class="keywordflow">select case</span> (cs%opacity_scheme)</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;      <span class="keywordflow">case</span> (manizza_05)</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;          <span class="keywordflow">if</span> (g%mask2dT(i,j) &lt;= 0.5) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;            <span class="keywordflow">do</span> n=1,optics%nbands</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;              optics%opacity_band(n,i,j,k) = cs%opacity_land_value</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="keywordflow">            enddo</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            <span class="comment">! Band 1 is Manizza blue.</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;            optics%opacity_band(1,i,j,k) = 0.0232 + 0.074*chl_data(i,j)**0.674</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;            <span class="keywordflow">if</span> (nbands &gt;= 2) &amp;  <span class="comment">!  Band 2 is Manizza red.</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;              optics%opacity_band(2,i,j,k) = 0.225 + 0.037*chl_data(i,j)**0.629</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;            <span class="comment">! All remaining bands are NIR, for lack of something better to do.</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            <span class="keywordflow">do</span> n=3,nbands ; optics%opacity_band(n,i,j,k) = 2.86 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;      <span class="keywordflow">case</span> (morel_88)</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;          optics%opacity_band(1,i,j,k) = cs%opacity_land_value</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;          <span class="keywordflow">if</span> (g%mask2dT(i,j) &gt; 0.5) &amp;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            optics%opacity_band(1,i,j,k) = opacity_morel(chl_data(i,j))</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160; </div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;          <span class="keywordflow">do</span> n=2,optics%nbands</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            optics%opacity_band(n,i,j,k) = optics%opacity_band(1,i,j,k)</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="keywordflow">          enddo</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160; </div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="keywordflow">      case default</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;opacity_from_chl: CS%opacity_scheme is not valid.&quot;</span>)</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="keywordflow">    end select</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160; </div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__opacity_8F90_source.html#l00077">manizza_05</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__opacity_8F90_source.html#l00077">morel_88</a>, <a class="el" href="MOM__opacity_8F90_source.html#l00397">opacity_morel()</a>, and <a class="el" href="MOM__opacity_8F90_source.html#l00417">sw_pen_frac_morel()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__opacity_8F90_source.html#l00093">set_opacity()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__opacity_ad99a489a9081744a17f88d984f0d128d_cgraph.svg" width="552" height="183"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__opacity_ad99a489a9081744a17f88d984f0d128d_icgraph.svg" width="384" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a39fce7bd33a469e3e9fe7cfeb51825b5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a39fce7bd33a469e3e9fe7cfeb51825b5">&#9670;&nbsp;</a></span>opacity_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_opacity::opacity_init </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in), target&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(inout), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__opacity_1_1opacity__cs.html">opacity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__opacity_1_1optics__type.html">optics_type</a>), pointer&#160;</td>
          <td class="paramname"><em>optics</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This routine initalizes the opacity module, including an <a class="el" href="structmom__opacity_1_1optics__type.html" title="This type is used to store information about ocean optical properties.">optics_type</a>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>The current model time. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>model vertical grid structure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>A structure to parse for run-time parameters. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">diag</td><td>A structure that is used to regulate diagnostic output. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>A pointer that is set to point to the control structure for this module. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">optics</td><td>An optics structure that has parameters set and arrays allocated here. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00922">922</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;  <span class="keywordtype">type</span>(time_type), <span class="keywordtype">target</span>, <span class="keywordtype">intent(in)</span>    :: Time<span class="comment"> !&lt; The current model time.</span></div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">    !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">   !&lt; model vertical grid structure</span></div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>    :: US<span class="comment">   !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;  <span class="keywordtype">type</span>(param_file_type),   <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; A structure to parse for run-time</span></div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="comment">                                                 !! parameters.</span></div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>, <span class="keywordtype">intent(inout)</span> :: diag<span class="comment"> !&lt; A structure that is used to regulate diagnostic</span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;<span class="comment">                                                 !! output.</span></div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;  <span class="keywordtype">type</span>(opacity_CS),        <span class="keywordtype">pointer</span>       :: CS<span class="comment">   !&lt; A pointer that is set to point to the control</span></div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;<span class="comment">                                                 !! structure for this module.</span></div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;  <span class="keywordtype">type</span>(optics_type),       <span class="keywordtype">pointer</span>       :: optics<span class="comment"> !&lt; An optics structure that has parameters</span></div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;<span class="comment">                                                 !! set and arrays allocated here.</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;  <span class="keywordtype">character(len=200)</span> :: tmpstr</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_opacity&quot;</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;  <span class="keywordtype">character(len=40)</span>  :: bandnum, shortname</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;  <span class="keywordtype">character(len=200)</span> :: longname</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;  <span class="keywordtype">character(len=40)</span>  :: scheme_string</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;  <span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="preprocessor"># include &quot;version_variable.h&quot;</span></div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="preprocessor"></span><span class="keywordtype">  real</span> :: PenSW_absorb_minthick <span class="comment">! A thickness that is used to absorb the remaining shortwave heat</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;                                <span class="comment">! flux when that flux drops below PEN_SW_FLUX_ABSORB [m].</span></div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;<span class="keywordtype">  real</span> :: PenSW_minthick_dflt <span class="comment">! The default for PenSW_absorb_minthick [m]</span></div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;  <span class="keywordtype">logical</span> :: default_2018_answers</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;  <span class="keywordtype">logical</span> :: use_scheme</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;  <span class="keywordtype">integer</span> :: isd, ied, jsd, jed, nz, n</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed ; nz = g%ke</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160; </div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;opacity_init called with an associated&quot;</span>// &amp;</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;                             <span class="stringliteral">&quot;associated control structure.&quot;</span>)</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;    <span class="keywordflow">return</span></div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;  <span class="keywordflow">else</span> ; <span class="keyword">allocate</span>(cs) ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160; </div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;  cs%diag =&gt; diag</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160; </div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;  <span class="comment">! Read all relevant parameters and write them to the model log.</span></div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, <span class="stringliteral">&#39;&#39;</span>)</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160; </div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;<span class="comment">! parameters for CHL_A routines</span></div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;VAR_PEN_SW&quot;</span>, cs%var_pen_sw, &amp;</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;                 <span class="stringliteral">&quot;If true, use one of the CHL_A schemes specified by &quot;</span>//&amp;</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;                 <span class="stringliteral">&quot;OPACITY_SCHEME to determine the e-folding depth of &quot;</span>//&amp;</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;                 <span class="stringliteral">&quot;incoming short wave radiation.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160; </div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;  cs%opacity_scheme = no_scheme ; scheme_string = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;  <span class="keywordflow">if</span> (cs%var_pen_sw) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OPACITY_SCHEME&quot;</span>, tmpstr, &amp;</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;                 <span class="stringliteral">&quot;This character string specifies how chlorophyll &quot;</span>//&amp;</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;                 <span class="stringliteral">&quot;concentrations are translated into opacities. Currently &quot;</span>//&amp;</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;                 <span class="stringliteral">&quot;valid options include:\n&quot;</span>//&amp;</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;                 <span class="stringliteral">&quot; \t\t  MANIZZA_05 - Use Manizza et al., GRL, 2005. \n&quot;</span>//&amp;</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;                 <span class="stringliteral">&quot; \t\t  MOREL_88 - Use Morel, JGR, 1988.&quot;</span>, &amp;</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;                 default=manizza_05_string)</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    <span class="keywordflow">if</span> (len_trim(tmpstr) &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;      tmpstr = uppercase(tmpstr)</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;      <span class="keywordflow">select case</span> (tmpstr)</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;        <span class="keywordflow">case</span> (manizza_05_string)</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;          cs%opacity_scheme = manizza_05 ; scheme_string = manizza_05_string</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;        <span class="keywordflow">case</span> (morel_88_string)</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;          cs%opacity_scheme = morel_88 ; scheme_string = morel_88_string</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;<span class="keywordflow">        case default</span></div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;          <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;opacity_init: #DEFINE OPACITY_SCHEME &quot;</span>//&amp;</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;                                  trim(tmpstr) // <span class="stringliteral">&quot;in input file is invalid.&quot;</span>)</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;<span class="keywordflow">      end select</span></div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;      <span class="keyword">call </span>mom_mesg(<span class="stringliteral">&#39;opacity_init: opacity scheme set to &quot;&#39;</span>//trim(tmpstr)//<span class="stringliteral">&#39;&quot;.&#39;</span>, 5)</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;    <span class="keywordflow">if</span> (cs%opacity_scheme == no_scheme) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;      <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;opacity_init: No scheme has successfully &quot;</span>//&amp;</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;               <span class="stringliteral">&quot;been specified for the opacity.  Using the default MANIZZA_05.&quot;</span>)</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;      cs%opacity_scheme = manizza_05 ; scheme_string = manizza_05_string</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160; </div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BLUE_FRAC_SW&quot;</span>, cs%blue_frac, &amp;</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;                 <span class="stringliteral">&quot;The fraction of the penetrating shortwave radiation &quot;</span>//&amp;</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;                 <span class="stringliteral">&quot;that is in the blue band.&quot;</span>, default=0.5, units=<span class="stringliteral">&quot;nondim&quot;</span>)</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;EXP_OPACITY_SCHEME&quot;</span>, tmpstr, &amp;</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;                 <span class="stringliteral">&quot;This character string specifies which exponential &quot;</span>//&amp;</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;                 <span class="stringliteral">&quot;opacity scheme to utilize. Currently &quot;</span>//&amp;</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;                 <span class="stringliteral">&quot;valid options include:\n&quot;</span>//&amp;</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;                 <span class="stringliteral">&quot; \t\t  SINGLE_EXP - Single Exponent decay. \n&quot;</span>//&amp;</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;                 <span class="stringliteral">&quot; \t\t  DOUBLE_EXP - Double Exponent decay.&quot;</span>, &amp;</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                 default=single_exp_string)<span class="comment">!New default for &quot;else&quot; above (non-Chl scheme)</span></div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    <span class="keywordflow">if</span> (len_trim(tmpstr) &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;      tmpstr = uppercase(tmpstr)</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;      <span class="keywordflow">select case</span> (tmpstr)</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;        <span class="keywordflow">case</span> (single_exp_string)</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;          cs%opacity_scheme = single_exp ; scheme_string = single_exp_string</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;        <span class="keywordflow">case</span> (double_exp_string)</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;          cs%opacity_scheme = double_exp ; scheme_string = double_exp_string</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;<span class="keywordflow">      end select</span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;      <span class="keyword">call </span>mom_mesg(<span class="stringliteral">&#39;opacity_init: opacity scheme set to &quot;&#39;</span>//trim(tmpstr)//<span class="stringliteral">&#39;&quot;.&#39;</span>, 5)</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;PEN_SW_SCALE&quot;</span>, cs%pen_sw_scale, &amp;</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;                 <span class="stringliteral">&quot;The vertical absorption e-folding depth of the &quot;</span>//&amp;</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;                 <span class="stringliteral">&quot;penetrating shortwave radiation.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, default=0.0)</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;    <span class="comment">!BGR/ Added for opacity_scheme==double_exp read in 2nd exp-decay and fraction</span></div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    <span class="keywordflow">if</span> (cs%Opacity_scheme == double_exp ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;PEN_SW_SCALE_2ND&quot;</span>, cs%pen_sw_scale_2nd, &amp;</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;                 <span class="stringliteral">&quot;The (2nd) vertical absorption e-folding depth of the &quot;</span>//&amp;</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;                 <span class="stringliteral">&quot;penetrating shortwave radiation &quot;</span>//&amp;</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;                 <span class="stringliteral">&quot;(use if SW_EXP_MODE==double.)&quot;</span>,&amp;</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;                 units=<span class="stringliteral">&quot;m&quot;</span>, default=0.0)</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SW_1ST_EXP_RATIO&quot;</span>, cs%sw_1st_exp_ratio, &amp;</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;                 <span class="stringliteral">&quot;The fraction of 1st vertical absorption e-folding depth &quot;</span>//&amp;</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;                 <span class="stringliteral">&quot;penetrating shortwave radiation if SW_EXP_MODE==double.&quot;</span>,&amp;</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;                  units=<span class="stringliteral">&quot;m&quot;</span>, default=0.0)</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    <span class="keywordflow">elseif</span> (cs%OPACITY_SCHEME == single_exp) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;      <span class="comment">!/Else disable 2nd_exp scheme</span></div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;      cs%pen_sw_scale_2nd = 0.0</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;      cs%sw_1st_exp_ratio = 1.0</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;PEN_SW_FRAC&quot;</span>, cs%pen_sw_frac, &amp;</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;                 <span class="stringliteral">&quot;The fraction of the shortwave radiation that penetrates &quot;</span>//&amp;</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;                 <span class="stringliteral">&quot;below the surface.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160; </div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;PEN_SW_NBANDS&quot;</span>, optics%nbands, &amp;</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;                 <span class="stringliteral">&quot;The number of bands of penetrating shortwave radiation.&quot;</span>, &amp;</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;                 default=1)</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;  <span class="keywordflow">if</span> (cs%Opacity_scheme == double_exp ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;    <span class="keywordflow">if</span> (optics%nbands /= 2) <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;        <span class="stringliteral">&quot;set_opacity: \Cannot use a double_exp opacity scheme with nbands!=2.&quot;</span>)</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;  <span class="keywordflow">elseif</span> (cs%Opacity_scheme == single_exp ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    <span class="keywordflow">if</span> (optics%nbands /= 1) <span class="keyword">call </span>mom_error(fatal, &amp;</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;        <span class="stringliteral">&quot;set_opacity: \Cannot use a single_exp opacity scheme with nbands!=1.&quot;</span>)</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160; </div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DEFAULT_2018_ANSWERS&quot;</span>, default_2018_answers, &amp;</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;                 <span class="stringliteral">&quot;This sets the default value for the various _2018_ANSWERS parameters.&quot;</span>, &amp;</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;                 default=.true.)</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OPTICS_2018_ANSWERS&quot;</span>, optics%answers_2018, &amp;</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;                 <span class="stringliteral">&quot;If true, use the order of arithmetic and expressions that recover the &quot;</span>//&amp;</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;                 <span class="stringliteral">&quot;answers from the end of 2018.  Otherwise, use updated expressions for &quot;</span>//&amp;</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;                 <span class="stringliteral">&quot;handling the absorption of small remaining shortwave fluxes.&quot;</span>, &amp;</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;                 default=default_2018_answers)</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160; </div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;PEN_SW_FLUX_ABSORB&quot;</span>, optics%PenSW_flux_absorb, &amp;</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;                 <span class="stringliteral">&quot;A minimum remaining shortwave heating rate that will be simply absorbed in &quot;</span>//&amp;</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;                 <span class="stringliteral">&quot;the next sufficiently thick layers for computational efficiency, instead of &quot;</span>//&amp;</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;                 <span class="stringliteral">&quot;continuing to penetrate.  The default, 2.5e-11 degC m s-1, is about 1e-4 W m-2 &quot;</span>//&amp;</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;                 <span class="stringliteral">&quot;or 0.08 degC m century-1, but 0 is also a valid value.&quot;</span>, &amp;</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;                 default=2.5e-11, units=<span class="stringliteral">&quot;degC m s-1&quot;</span>, scale=gv%m_to_H*us%T_to_s)</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160; </div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;  <span class="keywordflow">if</span> (optics%answers_2018) <span class="keywordflow">then</span> ; pensw_minthick_dflt = 0.001 ; <span class="keywordflow">else</span> ; pensw_minthick_dflt = 1.0 ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;PEN_SW_ABSORB_MINTHICK&quot;</span>, pensw_absorb_minthick, &amp;</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;                 <span class="stringliteral">&quot;A thickness that is used to absorb the remaining penetrating shortwave heat &quot;</span>//&amp;</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;                 <span class="stringliteral">&quot;flux when it drops below PEN_SW_FLUX_ABSORB.&quot;</span>, &amp;</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;                 default=pensw_minthick_dflt, units=<span class="stringliteral">&quot;m&quot;</span>, scale=gv%m_to_H)</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;  optics%PenSW_absorb_Invlen = 1.0 / (pensw_absorb_minthick + gv%H_subroundoff)</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160; </div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(optics%min_wavelength_band)) &amp;</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;    <span class="keyword">allocate</span>(optics%min_wavelength_band(optics%nbands))</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(optics%max_wavelength_band)) &amp;</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;    <span class="keyword">allocate</span>(optics%max_wavelength_band(optics%nbands))</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160; </div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;  <span class="keywordflow">if</span> (cs%opacity_scheme == manizza_05) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;    optics%min_wavelength_band(1) =0</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    optics%max_wavelength_band(1) =550</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;    <span class="keywordflow">if</span> (optics%nbands &gt;= 2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;      optics%min_wavelength_band(2)=550</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;      optics%max_wavelength_band(2)=700</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;    <span class="keywordflow">if</span> (optics%nbands &gt; 2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;      <span class="keywordflow">do</span> n=3,optics%nbands</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;        optics%min_wavelength_band(n) =700</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;        optics%max_wavelength_band(n) =2800</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160; </div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OPACITY_LAND_VALUE&quot;</span>, cs%opacity_land_value, &amp;</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;                 <span class="stringliteral">&quot;The value to use for opacity over land. The default is &quot;</span>//&amp;</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;                 <span class="stringliteral">&quot;10 m-1 - a value for muddy water.&quot;</span>, units=<span class="stringliteral">&quot;m-1&quot;</span>, default=10.0)</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160; </div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(optics%opacity_band)) &amp;</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    <span class="keyword">allocate</span>(optics%opacity_band(optics%nbands,isd:ied,jsd:jed,nz))</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(optics%sw_pen_band)) &amp;</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    <span class="keyword">allocate</span>(optics%sw_pen_band(optics%nbands,isd:ied,jsd:jed))</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;  <span class="keyword">allocate</span>(cs%id_opacity(optics%nbands)) ; cs%id_opacity(:) = -1</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160; </div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;  cs%id_sw_pen = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;SW_pen&#39;</span>, diag%axesT1, time, &amp;</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;      <span class="stringliteral">&#39;Penetrating shortwave radiation flux into ocean&#39;</span>, <span class="stringliteral">&#39;W m-2&#39;</span>)</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;  cs%id_sw_vis_pen = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;SW_vis_pen&#39;</span>, diag%axesT1, time, &amp;</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;      <span class="stringliteral">&#39;Visible penetrating shortwave radiation flux into ocean&#39;</span>, <span class="stringliteral">&#39;W m-2&#39;</span>)</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;  <span class="keywordflow">do</span> n=1,optics%nbands</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;    <span class="keyword">write</span>(bandnum,<span class="stringliteral">&#39;(i3)&#39;</span>) n</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;    shortname = <span class="stringliteral">&#39;opac_&#39;</span>//trim(adjustl(bandnum))</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;    longname = <span class="stringliteral">&#39;Opacity for shortwave radiation in band &#39;</span>//trim(adjustl(bandnum)) &amp;</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;      // <span class="stringliteral">&#39;, saved as L^-1 tanh(Opacity * L) for L = 10^-10 m&#39;</span></div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;    cs%id_opacity(n) = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, shortname, diag%axesTL, time, &amp;</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;      longname, <span class="stringliteral">&#39;m-1&#39;</span>)</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__opacity_8F90_source.html#l00077">double_exp</a>, <a class="el" href="MOM__opacity_8F90_source.html#l00083">double_exp_string</a>, <a class="el" href="MOM__opacity_8F90_source.html#l00077">manizza_05</a>, <a class="el" href="MOM__opacity_8F90_source.html#l00080">manizza_05_string</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00053">mom_error_handler::mom_mesg()</a>, <a class="el" href="MOM__opacity_8F90_source.html#l00077">morel_88</a>, <a class="el" href="MOM__opacity_8F90_source.html#l00081">morel_88_string</a>, <a class="el" href="MOM__opacity_8F90_source.html#l00077">no_scheme</a>, <a class="el" href="MOM__diag__mediator_8F90_source.html#l01878">mom_diag_mediator::register_diag_field()</a>, <a class="el" href="MOM__opacity_8F90_source.html#l00077">single_exp</a>, <a class="el" href="MOM__opacity_8F90_source.html#l00082">single_exp_string</a>, and <a class="el" href="MOM__string__functions_8F90_source.html#l00042">mom_string_functions::uppercase()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__opacity_a39fce7bd33a469e3e9fe7cfeb51825b5_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a27873e3942c2ff7980cf516944f78f03"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a27873e3942c2ff7980cf516944f78f03">&#9670;&nbsp;</a></span>opacity_manizza()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">real function, public mom_opacity::opacity_manizza </td>
          <td>(</td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>chl_data</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This sets the blue-wavelength opacity according to the scheme proposed by Manizza, M. et al, 2005. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">chl_data</td><td>The chlorophyll-A concentration in mg m-3. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The returned opacity [m-1] </dd></dl>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00437">437</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: chl_data<span class="comment"> !&lt; The chlorophyll-A concentration in mg m-3.</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="keywordtype">  real</span> :: opacity_manizza<span class="comment"> !&lt; The returned opacity [m-1]</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="comment">!   This sets the blue-wavelength opacity according to the scheme proposed by Manizza, M. et al, 2005.</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160; </div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;  opacity_manizza = 0.0232 + 0.074*chl_data**0.674</div>
</div><!-- fragment -->
</div>
</div>
<a id="a4498b4bb6fcf1b7d849f89aa87c0332e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4498b4bb6fcf1b7d849f89aa87c0332e">&#9670;&nbsp;</a></span>opacity_morel()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">real function, public mom_opacity::opacity_morel </td>
          <td>(</td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>chl_data</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This sets the blue-wavelength opacity according to the scheme proposed by Morel and Antoine (1994). </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">chl_data</td><td>The chlorophyll-A concentration in mg m-3. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The returned opacity [m-1] </dd></dl>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00397">397</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: chl_data<span class="comment"> !&lt; The chlorophyll-A concentration in mg m-3.</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="keywordtype">  real</span> :: opacity_morel<span class="comment"> !&lt; The returned opacity [m-1]</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160; </div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;  <span class="comment">!   The following are coefficients for the optical model taken from Morel and</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  <span class="comment">! Antoine (1994). These coeficients represent a non uniform distribution of</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  <span class="comment">! chlorophyll-a through the water column.  Other approaches may be more</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;  <span class="comment">! appropriate when using an interactive ecosystem model that predicts</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;  <span class="comment">! three-dimensional chl-a values.</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(6)</span>, <span class="keywordtype">parameter</span> :: &amp;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;       Z2_coef=(/7.925, -6.644, 3.662, -1.815, -0.218,  0.502/)</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="keywordtype">  real</span> :: Chl, Chl2 <span class="comment">! The log10 of chl_data (in mg m-3), and Chl^2.</span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160; </div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;  chl = log10(min(max(chl_data,0.02),60.0)) ; chl2 = chl*chl</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;  opacity_morel = 1.0 / ( (z2_coef(1) + z2_coef(2)*chl) + chl2 * &amp;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;      ((z2_coef(3) + chl*z2_coef(4)) + chl2*(z2_coef(5) + chl*z2_coef(6))) )</div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__opacity_8F90_source.html#l00222">opacity_from_chl()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__opacity_a4498b4bb6fcf1b7d849f89aa87c0332e_icgraph.svg" width="583" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a349c6934f113d238e4e2ef229b931a0c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a349c6934f113d238e4e2ef229b931a0c">&#9670;&nbsp;</a></span>optics_nbands()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">integer function, public mom_opacity::optics_nbands </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__opacity_1_1optics__type.html">optics_type</a>), intent(in)&#160;</td>
          <td class="paramname"><em>optics</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Return the number of bands of penetrating shortwave radiation. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">optics</td><td>An optics structure that has values of opacities and shortwave fluxes. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The number of penetrating bands of SW radiation </dd></dl>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00495">495</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;  <span class="keywordtype">type</span>(optics_type),       <span class="keywordtype">intent(in)</span>  :: optics<span class="comment"> !&lt; An optics structure that has values of opacities</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="comment">                                                 !! and shortwave fluxes.</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;  <span class="keywordtype">integer</span> :: optics_nbands<span class="comment"> !&lt; The number of penetrating bands of SW radiation</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160; </div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;  optics_nbands = optics%nbands</div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__forcing__type_8F90_source.html#l00879">mom_forcing_type::calculatebuoyancyflux1d()</a>, <a class="el" href="MOM__forcing__type_8F90_source.html#l00976">mom_forcing_type::calculatebuoyancyflux2d()</a>, <a class="el" href="MOM__diabatic__driver_8F90_source.html#l01229">mom_diabatic_driver::diabatic_ale()</a>, <a class="el" href="MOM__diabatic__driver_8F90_source.html#l00446">mom_diabatic_driver::diabatic_ale_legacy()</a>, and <a class="el" href="MOM__forcing__type_8F90_source.html#l00346">mom_forcing_type::extractfluxes1d()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__opacity_a349c6934f113d238e4e2ef229b931a0c_icgraph.svg" width="100%" height="543"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a675243222a55e7091e5e597f9c0a9b24"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a675243222a55e7091e5e597f9c0a9b24">&#9670;&nbsp;</a></span>set_opacity()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_opacity::set_opacity </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__opacity_1_1optics__type.html">optics_type</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>optics</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>sw_total</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>sw_vis_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>sw_vis_dif</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>sw_nir_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>sw_nir_dif</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__opacity_1_1opacity__cs.html">opacity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(in), optional&#160;</td>
          <td class="paramname"><em>chl_2d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(in), optional&#160;</td>
          <td class="paramname"><em>chl_3d</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This sets the opacity of sea water based based on one of several different schemes. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">optics</td><td>An optics structure that has values set based on the opacities. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">sw_total</td><td>Total shortwave flux into the ocean [W m-2] </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">sw_vis_dir</td><td>Visible, direct shortwave into the ocean [W m-2] </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">sw_vis_dif</td><td>Visible, diffuse shortwave into the ocean [W m-2] </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">sw_nir_dir</td><td>Near-IR, direct shortwave into the ocean [W m-2] </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">sw_nir_dif</td><td>Near-IR, diffuse shortwave into the ocean [W m-2] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure earlier set up by opacity_init. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">chl_2d</td><td>Vertically uniform chlorophyll-A concentractions[mg m-3] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">chl_3d</td><td>The chlorophyll-A concentractions of each layer [mg m-3] </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00093">93</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="keywordtype">type</span>(optics_type),       <span class="keywordtype">intent(inout)</span> :: optics<span class="comment"> !&lt; An optics structure that has values</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment">                                                   !! set based on the opacities.</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:)</span>,    <span class="keywordtype">pointer</span>       :: sw_total<span class="comment"> !&lt; Total shortwave flux into the ocean [W m-2]</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:)</span>,    <span class="keywordtype">pointer</span>       :: sw_vis_dir<span class="comment"> !&lt; Visible, direct shortwave into the ocean [W m-2]</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:)</span>,    <span class="keywordtype">pointer</span>       :: sw_vis_dif<span class="comment"> !&lt; Visible, diffuse shortwave into the ocean [W m-2]</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:)</span>,    <span class="keywordtype">pointer</span>       :: sw_nir_dir<span class="comment"> !&lt; Near-IR, direct shortwave into the ocean [W m-2]</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:)</span>,    <span class="keywordtype">pointer</span>       :: sw_nir_dif<span class="comment"> !&lt; Near-IR, diffuse shortwave into the ocean [W m-2]</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">      !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">     !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <span class="keywordtype">type</span>(opacity_CS),        <span class="keywordtype">pointer</span>       :: CS<span class="comment">     !&lt; The control structure earlier set up by</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment">                                                   !! opacity_init.</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>, &amp;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: chl_2d<span class="comment"> !&lt; Vertically uniform chlorophyll-A concentractions[mg m-3]</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                 <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: chl_3d<span class="comment"> !&lt; The chlorophyll-A concentractions of each layer [mg m-3]</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160; </div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, n, is, ie, js, je, nz</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="keywordtype">  real</span> :: inv_sw_pen_scale  <span class="comment">! The inverse of the e-folding scale [m-1].</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="keywordtype">  real</span> :: Inv_nbands        <span class="comment">! The inverse of the number of bands of penetrating</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                            <span class="comment">! shortwave radiation.</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  <span class="keywordtype">logical</span> :: call_for_surface  <span class="comment">! if horizontal slice is the surface layer</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="keywordtype">  real</span> :: tmp(SZI_(G),SZJ_(G),SZK_(GV)) <span class="comment">! A 3-d temporary array.</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="keywordtype">  real</span> :: chl(SZI_(G),SZJ_(G),SZK_(GV)) <span class="comment">! The concentration of chlorophyll-A [mg m-3].</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="keywordtype">  real</span> :: Pen_SW_tot(SZI_(G),SZJ_(G))   <span class="comment">! The penetrating shortwave radiation</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                                        <span class="comment">! summed across all bands [W m-2].</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = gv%ke</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160; </div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;set_opacity: &quot;</span>// &amp;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;         <span class="stringliteral">&quot;Module must be initialized via opacity_init before it is used.&quot;</span>)</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160; </div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(chl_2d) .or. <span class="keyword">present</span>(chl_3d)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="comment">! The optical properties are based on cholophyll concentrations.</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keyword">call </span>opacity_from_chl(optics, sw_total, sw_vis_dir, sw_vis_dif, sw_nir_dir, sw_nir_dif, &amp;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;                          g, gv, cs, chl_2d, chl_3d)</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  <span class="keywordflow">else</span> <span class="comment">! Use sw e-folding scale set by MOM_input</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="keywordflow">if</span> (optics%nbands &lt;= 1) <span class="keywordflow">then</span> ; inv_nbands = 1.0</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="keywordflow">else</span> ; inv_nbands = 1.0 / real(optics%nbands) ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160; </div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    <span class="comment">! Make sure there is no division by 0.</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    inv_sw_pen_scale = 1.0 / max(cs%pen_sw_scale, 0.1*gv%Angstrom_m, &amp;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                                 gv%H_to_m*gv%H_subroundoff)</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="keywordflow">if</span> ( cs%Opacity_scheme == double_exp ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;      <span class="comment">!$OMP parallel do default(shared)</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        optics%opacity_band(1,i,j,k) = inv_sw_pen_scale</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        optics%opacity_band(2,i,j,k) = 1.0 / max(cs%pen_sw_scale_2nd, &amp;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;             0.1*gv%Angstrom_m,gv%H_to_m*gv%H_subroundoff)</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;      <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(sw_total) .or. (cs%pen_SW_scale &lt;= 0.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="comment">!$OMP parallel do default(shared)</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">do</span> n=1,optics%nbands</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;          optics%sw_pen_band(n,i,j) = 0.0</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="comment">!$OMP parallel do default(shared)</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;          optics%sw_pen_band(1,i,j) = (cs%SW_1st_EXP_RATIO) * sw_total(i,j)</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;          optics%sw_pen_band(2,i,j) = (1.-cs%SW_1st_EXP_RATIO) * sw_total(i,j)</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie  ; <span class="keywordflow">do</span> n=1,optics%nbands</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        optics%opacity_band(n,i,j,k) = inv_sw_pen_scale</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;      <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(sw_total) .or. (cs%pen_SW_scale &lt;= 0.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="comment">!$OMP parallel do default(shared)</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">do</span> n=1,optics%nbands</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;          optics%sw_pen_band(n,i,j) = 0.0</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="comment">!$OMP parallel do default(shared)</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">do</span> n=1,optics%nbands</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;          optics%sw_pen_band(n,i,j) = cs%pen_SW_frac * inv_nbands * sw_total(i,j)</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160; </div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  <span class="keywordflow">if</span> (query_averaging_enabled(cs%diag)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keywordflow">if</span> (cs%id_sw_pen &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;      <span class="comment">!$OMP parallel do default(shared)</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        pen_sw_tot(i,j) = 0.0</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="keywordflow">do</span> n=1,optics%nbands</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;          pen_sw_tot(i,j) = pen_sw_tot(i,j) + optics%sw_pen_band(n,i,j)</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;      <span class="keyword">call </span>post_data(cs%id_sw_pen, pen_sw_tot, cs%diag)</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <span class="keywordflow">if</span> (cs%id_sw_vis_pen &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;      <span class="keywordflow">if</span> (cs%opacity_scheme == manizza_05) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        <span class="comment">!$OMP parallel do default(shared)</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;          pen_sw_tot(i,j) = 0.0</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;          <span class="keywordflow">do</span> n=1,min(optics%nbands,2)</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;            pen_sw_tot(i,j) = pen_sw_tot(i,j) + optics%sw_pen_band(n,i,j)</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="keywordflow">          enddo</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        <span class="comment">!$OMP parallel do default(shared)</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;          pen_sw_tot(i,j) = 0.0</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;          <span class="keywordflow">do</span> n=1,optics%nbands</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;            pen_sw_tot(i,j) = pen_sw_tot(i,j) + optics%sw_pen_band(n,i,j)</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="keywordflow">          enddo</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;      <span class="keyword">call </span>post_data(cs%id_sw_vis_pen, pen_sw_tot, cs%diag)</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <span class="keywordflow">do</span> n=1,optics%nbands ; <span class="keywordflow">if</span> (cs%id_opacity(n) &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;      <span class="comment">!$OMP parallel do default(shared)</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="comment">! Remap opacity (op) to 1/L * tanh(op * L) where L is one Angstrom.</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        <span class="comment">! This gives a nearly identical value when op &lt;&lt; 1/L but allows one to</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <span class="comment">! store the values when opacity is divergent (i.e. opaque).</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        tmp(i,j,k) = tanh(op_diag_len * optics%opacity_band(n,i,j,k)) / op_diag_len</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;      <span class="keyword">call </span>post_data(cs%id_opacity(n), tmp, cs%diag)</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__opacity_8F90_source.html#l00077">double_exp</a>, <a class="el" href="MOM__opacity_8F90_source.html#l00077">manizza_05</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__opacity_8F90_source.html#l00085">op_diag_len</a>, <a class="el" href="MOM__opacity_8F90_source.html#l00222">opacity_from_chl()</a>, and <a class="el" href="MOM__diag__mediator_8F90_source.html#l01850">mom_diag_mediator::query_averaging_enabled()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__opacity_a675243222a55e7091e5e597f9c0a9b24_cgraph.svg" width="100%" height="437"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="ad27db4bd0d010d98a3f5a54902c7a05e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad27db4bd0d010d98a3f5a54902c7a05e">&#9670;&nbsp;</a></span>sumswoverbands()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_opacity::sumswoverbands </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nsw</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__opacity_1_1optics__type.html">optics_type</a>), intent(in)&#160;</td>
          <td class="paramname"><em>optics</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>H_limit_fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>absorbAllSW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(max(nsw,1), g %isd: g %ied), intent(in)&#160;</td>
          <td class="paramname"><em>iPen_SW_bnd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, gv %ke+1), intent(inout)&#160;</td>
          <td class="paramname"><em>netPen</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine calculates the total shortwave heat flux integrated over bands as a function of depth. This routine is only called for computing buoyancy fluxes for use in KPP. This routine does not updat e the state. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nsw</td><td>The number of bands of penetrating shortwave radiation, perhaps from optics_nbands(optics), </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">optics</td><td>An optics structure that has values set based on the opacities. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>j-index to work on. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time step [T ~&gt; s]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h_limit_fluxes</td><td>the total depth at which the surface fluxes start to be limited to avoid excessive heating of a thin ocean [H ~&gt; m or kg m-2] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">absorballsw</td><td>If true, ensure that all shortwave radiation is absorbed in the ocean water column. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ipen_sw_bnd</td><td>The incident penetrating shortwave heating in each band that hits the bottom and will be redistributed through the water column [degC H ~&gt; degC m or degC kg m-2]; size nsw x G isd: G ied. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">netpen</td><td>Net penetrating shortwave heat flux at each </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00783">783</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),    <span class="keywordtype">intent(in)</span>    :: G<span class="comment">   !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type),  <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">  !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),    <span class="keywordtype">intent(in)</span>    :: US<span class="comment">    !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;                            <span class="keywordtype">intent(in)</span>    :: h<span class="comment">   !&lt; Layer thicknesses [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;  <span class="keywordtype">integer</span>,                  <span class="keywordtype">intent(in)</span>    :: nsw<span class="comment"> !&lt; The number of bands of penetrating shortwave</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;<span class="comment">                                                 !! radiation, perhaps from optics_nbands(optics),</span></div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;  <span class="keywordtype">type</span>(optics_type),        <span class="keywordtype">intent(in)</span>    :: optics<span class="comment"> !&lt; An optics structure that has values</span></div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="comment">                                                   !! set based on the opacities.</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;  <span class="keywordtype">integer</span>,                  <span class="keywordtype">intent(in)</span>    :: j<span class="comment">   !&lt; j-index to work on.</span></div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="keywordtype">  real</span>,                     <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">  !&lt; Time step [T ~&gt; s].</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;<span class="keywordtype">  real</span>,                     <span class="keywordtype">intent(in)</span>    :: H_limit_fluxes<span class="comment"> !&lt; the total depth at which the</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="comment">                                                 !! surface fluxes start to be limited to avoid</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;<span class="comment">                                                 !! excessive heating of a thin ocean [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;  <span class="keywordtype">logical</span>,                  <span class="keywordtype">intent(in)</span>    :: absorbAllSW<span class="comment"> !&lt; If true, ensure that all shortwave</span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;<span class="comment">                                                 !! radiation is absorbed in the ocean water column.</span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(max(nsw,1),SZI_(G))</span>, <span class="keywordtype">intent(in)</span> :: iPen_SW_bnd<span class="comment"> !&lt; The incident penetrating shortwave</span></div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;<span class="comment">                                                 !! heating in each band that hits the bottom and</span></div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;<span class="comment">                                                 !! will be redistributed through the water column</span></div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;<span class="comment">                                                 !! [degC H ~&gt; degC m or degC kg m-2]; size nsw x SZI_(G).</span></div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;                             <span class="keywordtype">intent(inout)</span> :: netPen<span class="comment"> !&lt; Net penetrating shortwave heat flux at each</span></div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;<span class="comment">                                                 !! interface, summed across all bands</span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="comment">                                                 !! [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;<span class="keywordtype">  real</span> :: h_heat(SZI_(G))     <span class="comment">! thickness of the water column that receives</span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;                              <span class="comment">! remaining shortwave radiation [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="keywordtype">  real</span> :: Pen_SW_rem(SZI_(G)) <span class="comment">! sum across all wavelength bands of the</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                              <span class="comment">! penetrating shortwave heating that hits the bottom</span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;                              <span class="comment">! and will be redistributed through the water column</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;                              <span class="comment">! [degC H ~&gt; degC m or degC kg m-2]</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160; </div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(max(nsw,1),SZI_(G))</span> :: Pen_SW_bnd <span class="comment">! The remaining penetrating shortwave radiation</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;                          <span class="comment">! in each band, initially iPen_SW_bnd [degC H ~&gt; degC m or degC kg m-2]</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;<span class="keywordtype">  real</span> :: SW_trans        <span class="comment">! fraction of shortwave radiation not</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;                          <span class="comment">! absorbed in a layer [nondim]</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="keywordtype">  real</span> :: unabsorbed      <span class="comment">! fraction of the shortwave radiation</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                          <span class="comment">! not absorbed because the layers are too thin.</span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;<span class="keywordtype">  real</span> :: Ih_limit        <span class="comment">! inverse of the total depth at which the</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;                          <span class="comment">! surface fluxes start to be limited [H-1 ~&gt; m-1 or m2 kg-1]</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;<span class="keywordtype">  real</span> :: min_SW_heat     <span class="comment">! A minimum remaining shortwave heating within a timestep that will be simply</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;                          <span class="comment">! absorbed in the next layer for computational efficiency, instead of</span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;                          <span class="comment">! continuing to penetrate [degC H ~&gt; degC m or degC kg m-2].</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;<span class="keywordtype">  real</span> :: I_Habs            <span class="comment">! The inverse of the absorption length for a minimal flux [H-1 ~&gt; m-1 or m2 kg-1]</span></div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;<span class="keywordtype">  real</span> :: h_min_heat      <span class="comment">! minimum thickness layer that should get heated [H ~&gt; m or kg m-2]</span></div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;<span class="keywordtype">  real</span> :: opt_depth       <span class="comment">! optical depth of a layer [nondim]</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;<span class="keywordtype">  real</span> :: exp_OD          <span class="comment">! exp(-opt_depth) [nondim]</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;  <span class="keywordtype">logical</span> :: SW_Remains   <span class="comment">! If true, some column has shortwave radiation that</span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;                          <span class="comment">! was not entirely absorbed.</span></div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160; </div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, nz, i, k, ks, n</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;  sw_remains = .false.</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160; </div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;  min_sw_heat = optics%PenSW_flux_absorb*dt <span class="comment">! Default of 2.5e-11*US%T_to_s*GV%m_to_H</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;  i_habs = 1e3*gv%H_to_m <span class="comment">! optics%PenSW_absorb_Invlen</span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160; </div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;  h_min_heat = 2.0*gv%Angstrom_H + gv%H_subroundoff</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;  is = g%isc ; ie = g%iec ; nz = g%ke</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160; </div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;  pen_sw_bnd(:,:) = ipen_sw_bnd(:,:)</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; h_heat(i) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    netpen(i,1) = 0.</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    <span class="keywordflow">do</span> n=1,max(nsw,1)</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;      netpen(i,1) = netpen(i,1) + pen_sw_bnd(n,i)   <span class="comment">! Surface interface</span></div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160; </div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;  <span class="comment">! Apply penetrating SW radiation to remaining parts of layers.</span></div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;  <span class="comment">! Excessively thin layers are not heated to avoid runaway temps.</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;  <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160; </div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;      netpen(i,k+1) = 0.</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160; </div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;      <span class="keywordflow">if</span> (h(i,k) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;        <span class="keywordflow">do</span> n=1,nsw ; <span class="keywordflow">if</span> (pen_sw_bnd(n,i) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;          <span class="comment">! SW_trans is the SW that is transmitted THROUGH the layer</span></div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;          opt_depth = h(i,k)*gv%H_to_m * optics%opacity_band(n,i,j,k)</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;          exp_od = exp(-opt_depth)</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;          sw_trans = exp_od</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160; </div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;          <span class="comment">! Heating at a very small rate can be absorbed by a sufficiently thick layer or several</span></div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;          <span class="comment">! thin layers without further penetration.</span></div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;          <span class="keywordflow">if</span> (optics%answers_2018) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;            <span class="keywordflow">if</span> (nsw*pen_sw_bnd(n,i)*sw_trans &lt; min_sw_heat*min(1.0, i_habs*h(i,k)) ) sw_trans = 0.0</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;          <span class="keywordflow">elseif</span> ((nsw*pen_sw_bnd(n,i)*sw_trans &lt; min_sw_heat) .and. (h(i,k) &gt; h_min_heat)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;            <span class="keywordflow">if</span> (nsw*pen_sw_bnd(n,i) &lt;= min_sw_heat * (i_habs*(h(i,k) - h_min_heat))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;              sw_trans = 0.0</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;              sw_trans = min(sw_trans, &amp;</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;                             1.0 - (min_sw_heat*(i_habs*(h(i,k) - h_min_heat))) / (nsw*pen_sw_bnd(n,i)))</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160; </div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;          pen_sw_bnd(n,i) = pen_sw_bnd(n,i) * sw_trans</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;          netpen(i,k+1)   = netpen(i,k+1) + pen_sw_bnd(n,i)</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! h(i,k) &gt; 0.0</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160; </div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;      <span class="comment">! Add to the accumulated thickness above that could be heated.</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;      <span class="comment">! Only layers greater than h_min_heat thick should get heated.</span></div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;      <span class="keywordflow">if</span> (h(i,k) &gt;= 2.0*h_min_heat) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;        h_heat(i) = h_heat(i) + h(i,k)</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;      <span class="keywordflow">elseif</span> (h(i,k) &gt; h_min_heat) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        h_heat(i) = h_heat(i) + (2.0*h(i,k) - 2.0*h_min_heat)</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! i loop</span></div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! k loop</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160; </div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;  <span class="keywordflow">if</span> (absorballsw) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160; </div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    <span class="comment">! If there is still shortwave radiation at this point, it could go into</span></div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    <span class="comment">! the bottom (with a bottom mud model), or it could be redistributed back</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    <span class="comment">! through the water column.</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;      pen_sw_rem(i) = pen_sw_bnd(1,i)</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;      <span class="keywordflow">do</span> n=2,nsw ; pen_sw_rem(i) = pen_sw_rem(i) + pen_sw_bnd(n,i) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (pen_sw_rem(i) &gt; 0.0) sw_remains = .true. ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160; </div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    ih_limit = 1.0 / h_limit_fluxes</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> ((pen_sw_rem(i) &gt; 0.0) .and. (h_heat(i) &gt; 0.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;      <span class="keywordflow">if</span> (h_heat(i)*ih_limit &lt; 1.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;        unabsorbed = 1.0 - h_heat(i)*ih_limit</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        unabsorbed = 0.0</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;      <span class="keywordflow">do</span> n=1,nsw ; pen_sw_bnd(n,i) = unabsorbed * pen_sw_bnd(n,i) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160; </div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! absorbAllSW</span></div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__forcing__type_8F90_source.html#l00879">mom_forcing_type::calculatebuoyancyflux1d()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__opacity_ad27db4bd0d010d98a3f5a54902c7a05e_icgraph.svg" width="100%" height="437"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a0017241c03e4536115674fc5fc9608bf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0017241c03e4536115674fc5fc9608bf">&#9670;&nbsp;</a></span>sw_pen_frac_morel()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">real function mom_opacity::sw_pen_frac_morel </td>
          <td>(</td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>chl_data</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This sets the penetrating shortwave fraction according to the scheme proposed by Morel and Antoine (1994). </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">chl_data</td><td>The chlorophyll-A concentration in mg m-3. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The returned penetrating shortwave fraction [nondim] </dd></dl>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00417">417</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">intent(in)</span>  :: chl_data<span class="comment"> !&lt; The chlorophyll-A concentration in mg m-3.</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="keywordtype">  real</span> :: SW_pen_frac_morel<span class="comment">     !&lt; The returned penetrating shortwave fraction [nondim]</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160; </div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  <span class="comment">!   The following are coefficients for the optical model taken from Morel and</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  <span class="comment">! Antoine (1994). These coeficients represent a non uniform distribution of</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;  <span class="comment">! chlorophyll-a through the water column.  Other approaches may be more</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;  <span class="comment">! appropriate when using an interactive ecosystem model that predicts</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;  <span class="comment">! three-dimensional chl-a values.</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="keywordtype">  real</span> :: Chl, Chl2         <span class="comment">! The log10 of chl_data in mg m-3, and Chl^2.</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(6)</span>, <span class="keywordtype">parameter</span> :: &amp;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;       V1_coef=(/0.321,  0.008, 0.132,  0.038, -0.017, -0.007/)</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160; </div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;  chl = log10(min(max(chl_data,0.02),60.0)) ; chl2 = chl*chl</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  sw_pen_frac_morel = 1.0 - ( (v1_coef(1) + v1_coef(2)*chl) + chl2 * &amp;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;       ((v1_coef(3) + chl*v1_coef(4)) + chl2*(v1_coef(5) + chl*v1_coef(6))) )</div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__opacity_8F90_source.html#l00222">opacity_from_chl()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__opacity_a0017241c03e4536115674fc5fc9608bf_icgraph.svg" width="586" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="aba8c34bcba1b2f2d80a48cd7bce261ec"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aba8c34bcba1b2f2d80a48cd7bce261ec">&#9670;&nbsp;</a></span>double_exp</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_opacity::double_exp = 4</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Coded integers to specify the opacity scheme. </p>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00077">77</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__opacity_8F90_source.html#l00922">opacity_init()</a>, and <a class="el" href="MOM__opacity_8F90_source.html#l00093">set_opacity()</a>.</p>

</div>
</div>
<a id="a5a3d62dfb71c22ac0b13a312c8d23c70"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5a3d62dfb71c22ac0b13a312c8d23c70">&#9670;&nbsp;</a></span>double_exp_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(10), parameter mom_opacity::double_exp_string = &quot;DOUBLE_EXP&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>String to specify the opacity scheme. </p>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00083">83</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment">character*(10), parameter :: DOUBLE_EXP_STRING = &quot;DOUBLE_EXP&quot; !&lt; String to specify the opacity scheme</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__opacity_8F90_source.html#l00922">opacity_init()</a>.</p>

</div>
</div>
<a id="a28a3fe4f0c5e8c81882449450f6ba785"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a28a3fe4f0c5e8c81882449450f6ba785">&#9670;&nbsp;</a></span>manizza_05</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_opacity::manizza_05 = 1</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Coded integers to specify the opacity scheme. </p>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00077">77</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__opacity_8F90_source.html#l00222">opacity_from_chl()</a>, <a class="el" href="MOM__opacity_8F90_source.html#l00922">opacity_init()</a>, and <a class="el" href="MOM__opacity_8F90_source.html#l00093">set_opacity()</a>.</p>

</div>
</div>
<a id="aecb5a81b64d808f474cb4e5c722dc76b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aecb5a81b64d808f474cb4e5c722dc76b">&#9670;&nbsp;</a></span>manizza_05_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(10), parameter mom_opacity::manizza_05_string = &quot;MANIZZA_05&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>String to specify the opacity scheme. </p>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00080">80</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment">character*(10), parameter :: MANIZZA_05_STRING = &quot;MANIZZA_05&quot; !&lt; String to specify the opacity scheme</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__opacity_8F90_source.html#l00922">opacity_init()</a>.</p>

</div>
</div>
<a id="aa47b1866014e588f0306199f7ea7e73d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa47b1866014e588f0306199f7ea7e73d">&#9670;&nbsp;</a></span>morel_88</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_opacity::morel_88 = 2</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Coded integers to specify the opacity scheme. </p>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00077">77</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__opacity_8F90_source.html#l00222">opacity_from_chl()</a>, and <a class="el" href="MOM__opacity_8F90_source.html#l00922">opacity_init()</a>.</p>

</div>
</div>
<a id="a5e5e40ad5acbf12058294f2ea17a7368"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5e5e40ad5acbf12058294f2ea17a7368">&#9670;&nbsp;</a></span>morel_88_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(10), parameter mom_opacity::morel_88_string = &quot;MOREL_88&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>String to specify the opacity scheme. </p>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00081">81</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">character*(10), parameter :: MOREL_88_STRING   = &quot;MOREL_88&quot;   !&lt; String to specify the opacity scheme</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__opacity_8F90_source.html#l00922">opacity_init()</a>.</p>

</div>
</div>
<a id="a948b6b8f52bd40409385ee13f68c9626"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a948b6b8f52bd40409385ee13f68c9626">&#9670;&nbsp;</a></span>no_scheme</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_opacity::no_scheme = 0</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Coded integers to specify the opacity scheme. </p>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00077">77</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: NO_SCHEME = 0, manizza_05 = 1, morel_88 = 2, single_exp = 3, double_exp = 4</div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__opacity_8F90_source.html#l00922">opacity_init()</a>.</p>

</div>
</div>
<a id="a9e2e33c15dd65f100263da9efc0934a6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9e2e33c15dd65f100263da9efc0934a6">&#9670;&nbsp;</a></span>op_diag_len</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">real, parameter mom_opacity::op_diag_len = 1e-10</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Lengthscale L used to remap opacity from op to 1/L * tanh(op * L) </p>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00085">85</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="keywordtype">real</span>, <span class="keywordtype">parameter</span> :: op_diag_len = 1e-10  <span class="comment">!&lt; Lengthscale L used to remap opacity</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__opacity_8F90_source.html#l00093">set_opacity()</a>.</p>

</div>
</div>
<a id="a77646ea3d3da72b4e00694b7a121a771"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a77646ea3d3da72b4e00694b7a121a771">&#9670;&nbsp;</a></span>single_exp</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_opacity::single_exp = 3</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Coded integers to specify the opacity scheme. </p>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00077">77</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__opacity_8F90_source.html#l00922">opacity_init()</a>.</p>

</div>
</div>
<a id="ad430c567c09952e6ecfd07d6c05c8f69"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad430c567c09952e6ecfd07d6c05c8f69">&#9670;&nbsp;</a></span>single_exp_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(10), parameter mom_opacity::single_exp_string = &quot;SINGLE_EXP&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>String to specify the opacity scheme. </p>

<p class="definition">Definition at line <a class="el" href="MOM__opacity_8F90_source.html#l00082">82</a> of file <a class="el" href="MOM__opacity_8F90_source.html">MOM_opacity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment">character*(10), parameter :: SINGLE_EXP_STRING = &quot;SINGLE_EXP&quot; !&lt; String to specify the opacity scheme</span></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__opacity_8F90_source.html#l00922">opacity_init()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__opacity.html">mom_opacity</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
