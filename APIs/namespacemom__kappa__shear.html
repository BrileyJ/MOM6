<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_kappa_shear Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('namespacemom__kappa__shear.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a>  </div>
  <div class="headertitle">
<div class="title">mom_kappa_shear Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Shear-dependent mixing following Jackson et al. 2008. </p>
<p>By Laura Jackson and Robert Hallberg, 2006-2008</p>
<p>This file contains the subroutines that determine the diapycnal diffusivity driven by resolved shears, as specified by the parameterizations described in Jackson and Hallberg (JPO, 2008).</p>
<p>The technique by which the 6 equations (for kappa, TKE, u, v, T, and S) are solved simultaneously has been dramatically revised from the previous version. The previous version was not converging in some cases, especially near the surface mixed layer, while the revised version does. The revised version solves for kappa and TKE with shear and stratification fixed, then marches the density and velocities forward with an adaptive (and aggressive) time step in a predictor-corrector-corrector emulation of a trapezoidal scheme. Run-time-settable parameters determine the tolerence to which the kappa and TKE equations are solved and the minimum time step that can be taken. </p>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__kappa__shear_1_1kappa__shear__cs.html">kappa_shear_cs</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">This control structure holds the parameters that regulate shear mixing.  <a href="structmom__kappa__shear_1_1kappa__shear__cs.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr><td colspan="2"><div class="groupHeader"></div></td></tr>
<tr class="memitem:a3f00b08e1174690d40c0c2065fa9a8b1"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kappa__shear.html#a3f00b08e1174690d40c0c2065fa9a8b1">calculate_kappa_shear</a> (u_in, v_in, h, tv, p_surf, kappa_io, tke_io, kv_io, dt, G, GV, US, CS, initialize_all)</td></tr>
<tr class="memdesc:a3f00b08e1174690d40c0c2065fa9a8b1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Subroutine for calculating shear-driven diffusivity and TKE in tracer columns.  <a href="namespacemom__kappa__shear.html#a3f00b08e1174690d40c0c2065fa9a8b1">More...</a><br /></td></tr>
<tr class="separator:a3f00b08e1174690d40c0c2065fa9a8b1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2d8e291656bab5f83179523c4bea4d85"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kappa__shear.html#a2d8e291656bab5f83179523c4bea4d85">calc_kappa_shear_vertex</a> (u_in, v_in, h, T_in, S_in, tv, p_surf, kappa_io, tke_io, kv_io, dt, G, GV, US, CS, initialize_all)</td></tr>
<tr class="memdesc:a2d8e291656bab5f83179523c4bea4d85"><td class="mdescLeft">&#160;</td><td class="mdescRight">Subroutine for calculating shear-driven diffusivity and TKE in corner columns.  <a href="namespacemom__kappa__shear.html#a2d8e291656bab5f83179523c4bea4d85">More...</a><br /></td></tr>
<tr class="separator:a2d8e291656bab5f83179523c4bea4d85"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a26cc5bb15545f04cfaf07e53410e09ec"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kappa__shear.html#a26cc5bb15545f04cfaf07e53410e09ec">kappa_shear_column</a> (kappa, tke, dt, nzc, f2, surface_pres, dz, u0xdz, v0xdz, T0xdz, S0xdz, kappa_avg, tke_avg, tv, CS, GV, US, I_Ld2_1d, dz_Int_1d)</td></tr>
<tr class="memdesc:a26cc5bb15545f04cfaf07e53410e09ec"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine calculates shear-driven diffusivity and TKE in a single column.  <a href="namespacemom__kappa__shear.html#a26cc5bb15545f04cfaf07e53410e09ec">More...</a><br /></td></tr>
<tr class="separator:a26cc5bb15545f04cfaf07e53410e09ec"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0b931b0b834d887e321eb6eb1924fa9a"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kappa__shear.html#a0b931b0b834d887e321eb6eb1924fa9a">calculate_projected_state</a> (kappa, u0, v0, T0, S0, dt, nz, dz, I_dz_int, dbuoy_dT, dbuoy_dS, u, v, T, Sal, GV, US, N2, S2, ks_int, ke_int, vel_underflow)</td></tr>
<tr class="memdesc:a0b931b0b834d887e321eb6eb1924fa9a"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine calculates the velocities, temperature and salinity that the water column will have after mixing for dt with diffusivities kappa. It may also calculate the projected buoyancy frequency and shear.  <a href="namespacemom__kappa__shear.html#a0b931b0b834d887e321eb6eb1924fa9a">More...</a><br /></td></tr>
<tr class="separator:a0b931b0b834d887e321eb6eb1924fa9a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a351d44e4fe5cfb5852d019a0c1e66100"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kappa__shear.html#a351d44e4fe5cfb5852d019a0c1e66100">find_kappa_tke</a> (N2, S2, kappa_in, Idz, dz_Int, I_L2_bdry, f2, nz, CS, GV, US, K_Q, tke, kappa, kappa_src, local_src)</td></tr>
<tr class="memdesc:a351d44e4fe5cfb5852d019a0c1e66100"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine calculates new, consistent estimates of TKE and kappa.  <a href="namespacemom__kappa__shear.html#a351d44e4fe5cfb5852d019a0c1e66100">More...</a><br /></td></tr>
<tr class="separator:a351d44e4fe5cfb5852d019a0c1e66100"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a82428168ba463cf7276ae96d3e32475c"><td class="memItemLeft" align="right" valign="top">logical function, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kappa__shear.html#a82428168ba463cf7276ae96d3e32475c">kappa_shear_init</a> (Time, G, GV, US, param_file, diag, CS)</td></tr>
<tr class="memdesc:a82428168ba463cf7276ae96d3e32475c"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutineinitializesthe parameters that regulate shear-driven mixing.  <a href="namespacemom__kappa__shear.html#a82428168ba463cf7276ae96d3e32475c">More...</a><br /></td></tr>
<tr class="separator:a82428168ba463cf7276ae96d3e32475c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac7859c609e462000ca8fd763d68d141e"><td class="memItemLeft" align="right" valign="top">logical function, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kappa__shear.html#ac7859c609e462000ca8fd763d68d141e">kappa_shear_is_used</a> (param_file)</td></tr>
<tr class="memdesc:ac7859c609e462000ca8fd763d68d141e"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function indicates to other modules whether the Jackson et al shear mixing parameterization will be used without needing to duplicate the log entry.  <a href="namespacemom__kappa__shear.html#ac7859c609e462000ca8fd763d68d141e">More...</a><br /></td></tr>
<tr class="separator:ac7859c609e462000ca8fd763d68d141e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad4d87b0928aea195213e682b493eb555"><td class="memItemLeft" align="right" valign="top">logical function, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kappa__shear.html#ad4d87b0928aea195213e682b493eb555">kappa_shear_at_vertex</a> (param_file)</td></tr>
<tr class="memdesc:ad4d87b0928aea195213e682b493eb555"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function indicates to other modules whether the Jackson et al shear mixing parameterization will be used without needing to duplicate the log entry.  <a href="namespacemom__kappa__shear.html#ad4d87b0928aea195213e682b493eb555">More...</a><br /></td></tr>
<tr class="separator:ad4d87b0928aea195213e682b493eb555"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a2d8e291656bab5f83179523c4bea4d85"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2d8e291656bab5f83179523c4bea4d85">&#9670;&nbsp;</a></span>calc_kappa_shear_vertex()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_kappa_shear::calc_kappa_shear_vertex </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>u_in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>v_in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>T_in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>S_in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>p_surf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)+1), intent(out)&#160;</td>
          <td class="paramname"><em>kappa_io</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(g),szjb_(g),szk_(gv)+1), intent(out)&#160;</td>
          <td class="paramname"><em>tke_io</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(g),szjb_(g),szk_(gv)+1), intent(inout)&#160;</td>
          <td class="paramname"><em>kv_io</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__kappa__shear_1_1kappa__shear__cs.html">kappa_shear_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>initialize_all</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Subroutine for calculating shear-driven diffusivity and TKE in corner columns. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u_in</td><td>Initial zonal velocity [L T-1 ~&gt; m s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v_in</td><td>Initial meridional velocity [L T-1 ~&gt; m s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">t_in</td><td>Layer potential temperatures [degC] </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">s_in</td><td>Layer salinities in ppt. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>A structure containing pointers to any available thermodynamic fields. Absent fields have NULL ptrs. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">p_surf</td><td>The pressure at the ocean surface [Pa] (or NULL). </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">kappa_io</td><td>The diapycnal diffusivity at each interface </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">tke_io</td><td>The turbulent kinetic energy per unit mass at </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">kv_io</td><td>The vertical viscosity at each interface [Z2 T-1 ~&gt; m2 s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment [T ~&gt; s]. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to kappa_shear_init. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">initialize_all</td><td>If present and false, the previous value of kappa is used to start the iterations </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__kappa__shear_8F90_source.html#l00364">364</a> of file <a class="el" href="MOM__kappa__shear_8F90_source.html">MOM_kappa_shear.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">      !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">     !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),    <span class="keywordtype">intent(in)</span>   :: US<span class="comment">     !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(GV))</span>,   &amp;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: u_in<span class="comment">   !&lt; Initial zonal velocity [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(GV))</span>,   &amp;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: v_in<span class="comment">   !&lt; Initial meridional velocity [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>,   &amp;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: h<span class="comment">      !&lt; Layer thicknesses [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>,   &amp;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: T_in<span class="comment">   !&lt; Layer potential temperatures [degC]</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>,   &amp;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: S_in<span class="comment">   !&lt; Layer salinities in ppt.</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),   <span class="keywordtype">intent(in)</span>    :: tv<span class="comment">     !&lt; A structure containing pointers to any</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="comment">                                                   !! available thermodynamic fields. Absent fields</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="comment">                                                   !! have NULL ptrs.</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:)</span>,    <span class="keywordtype">pointer</span>       :: p_surf<span class="comment"> !&lt; The pressure at the ocean surface [Pa]</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="comment">                                                   !! (or NULL).</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                           <span class="keywordtype">intent(out)</span>   :: kappa_io<span class="comment"> !&lt; The diapycnal diffusivity at each interface</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="comment">                                                   !! (not layer!) [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJB_(G),SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                           <span class="keywordtype">intent(out)</span>   :: tke_io<span class="comment"> !&lt; The turbulent kinetic energy per unit mass at</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="comment">                                                   !! each interface (not layer!) [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJB_(G),SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                           <span class="keywordtype">intent(inout)</span> :: kv_io<span class="comment">  !&lt; The vertical viscosity at each interface [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="comment">                                                   !! The previous value is used to initialize kappa</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="comment">                                                   !! in the vertex columes as Kappa = Kv/Prandtl</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="comment">                                                   !! to accelerate the iteration toward covergence.</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">     !&lt; Time increment [T ~&gt; s].</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;  <span class="keywordtype">type</span>(Kappa_shear_CS),    <span class="keywordtype">pointer</span>       :: CS<span class="comment">     !&lt; The control structure returned by a previous</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="comment">                                                   !! call to kappa_shear_init.</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;  <span class="keywordtype">logical</span>,       <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: initialize_all<span class="comment"> !&lt; If present and false, the previous</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="comment">                                                   !! value of kappa is used to start the iterations</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160; </div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZIB_(G),SZK_(GV))</span> :: &amp;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    h_2d, &amp;             <span class="comment">! A 2-D version of h, but converted to [Z ~&gt; m].</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    u_2d, v_2d, &amp;       <span class="comment">! 2-D versions of u_in and v_in, converted to [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    T_2d, S_2d, rho_2d  <span class="comment">! 2-D versions of T [degC], S [ppt], and rho [R ~&gt; kg m-3].</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZIB_(G),SZK_(GV)+1,2)</span> :: &amp;</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    kappa_2d    <span class="comment">! Quasi 2-D versions of kappa_io [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZIB_(G),SZK_(GV)+1)</span> :: &amp;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    tke_2d      <span class="comment">! 2-D version tke_io [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: &amp;</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    Idz, &amp;      <span class="comment">! The inverse of the distance between TKE points [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    dz, &amp;       <span class="comment">! The layer thickness [Z ~&gt; m].</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    u0xdz, &amp;    <span class="comment">! The initial zonal velocity times dz [L Z T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    v0xdz, &amp;    <span class="comment">! The initial meridional velocity times dz [L Z T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    T0xdz, &amp;    <span class="comment">! The initial temperature times dz [degC Z ~&gt; degC m].</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    S0xdz       <span class="comment">! The initial salinity times dz [ppt Z ~&gt; ppt m].</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: &amp;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    kappa, &amp;    <span class="comment">! The shear-driven diapycnal diffusivity at an interface [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    tke, &amp;      <span class="comment">! The Turbulent Kinetic Energy per unit mass at an interface [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    kappa_avg, &amp; <span class="comment">! The time-weighted average of kappa [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    tke_avg     <span class="comment">! The time-weighted average of TKE [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="keywordtype">  real</span> :: f2   <span class="comment">! The squared Coriolis parameter of each column [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;<span class="keywordtype">  real</span> :: surface_pres  <span class="comment">! The top surface pressure [Pa].</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160; </div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;<span class="keywordtype">  real</span> :: dz_in_lay     <span class="comment">!   The running sum of the thickness in a layer [Z ~&gt; m].</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="keywordtype">  real</span> :: k0dt          <span class="comment">! The background diffusivity times the timestep [Z2 ~&gt; m2].</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="keywordtype">  real</span> :: dz_massless   <span class="comment">! A layer thickness that is considered massless [Z ~&gt; m].</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="keywordtype">  real</span> :: I_hwt <span class="comment">! The inverse of the masked thickness weights [H-1 ~&gt; m-1 or m2 kg-1].</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="keywordtype">  real</span> :: I_Prandtl</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  <span class="keywordtype">logical</span> :: use_temperature  <span class="comment">!  If true, temperature and salinity have been</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                        <span class="comment">! allocated and are being used as state variables.</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  <span class="keywordtype">logical</span> :: new_kappa = .true. <span class="comment">! If true, ignore the value of kappa from the</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                        <span class="comment">! last call to this subroutine.</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;  <span class="keywordtype">logical</span> :: do_i       <span class="comment">! If true, work on this column.</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160; </div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: kc <span class="comment">! The index map between the original</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                        <span class="comment">! interfaces and the interfaces with massless layers</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                        <span class="comment">! merged into nearby massive layers.</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: kf <span class="comment">! The fractional weight of interface kc+1 for</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                        <span class="comment">! interpolating back to the original index space [nondim].</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;  <span class="keywordtype">integer</span> :: IsB, IeB, JsB, JeB, i, j, k, nz, nzc, J2, J2m1</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160; </div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;  <span class="comment">! Diagnostics that should be deleted?</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;<span class="preprocessor"></span><span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: &amp;  <span class="comment">! Additional diagnostics.</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    I_Ld2_1d, dz_Int_1d</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV)+1)</span> :: &amp; <span class="comment">! 2-D versions of diagnostics.</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    I_Ld2_2d, dz_Int_2d</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV)+1)</span> :: &amp; <span class="comment">! 3-D versions of diagnostics.</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    I_Ld2_3d, dz_Int_3d</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;<span class="preprocessor"></span>  isb = g%isc-1 ; ieb = g%iecB ; jsb = g%jsc-1 ; jeb = g%jecB ; nz = gv%ke</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160; </div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  use_temperature = .false. ; <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tv%T)) use_temperature = .true.</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;  new_kappa = .true. ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(initialize_all)) new_kappa = initialize_all</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160; </div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  k0dt =  dt*cs%kappa_0</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;  dz_massless = 0.1*sqrt(k0dt)</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;  i_prandtl = 0.0 ; <span class="keywordflow">if</span> (cs%Prandtl_turb &gt; 0.0) i_prandtl = 1.0 / cs%Prandtl_turb</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160; </div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  <span class="comment">!$OMP parallel do default(private) shared(jsB,jeB,isB,ieB,nz,h,u_in,v_in,use_temperature,new_kappa, &amp;</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="preprocessor"></span>  <span class="comment">!$OMP                                I_Ld2_3d,dz_Int_3d, &amp;</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="preprocessor"></span>  <span class="comment">!$OMP                                tv,G,GV,US,CS,kappa_io,dz_massless,k0dt,p_surf,dt,tke_io,kv_io)</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  <span class="keywordflow">do</span> j=jsb,jeb</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    j2 = mod(j,2)+1 ; j2m1 = 3-j2 <span class="comment">! = mod(J-1,2)+1</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160; </div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    <span class="comment">! Interpolate the various quantities to the corners, using masks.</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isb,ieb</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;      u_2d(i,k) = (u_in(i,j,k)   * (g%mask2dCu(i,j)   * (h(i,j,k)   + h(i+1,j,k))) + &amp;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                   u_in(i,j+1,k) * (g%mask2dCu(i,j+1) * (h(i,j+1,k) + h(i+1,j+1,k))) ) / &amp;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                  ((g%mask2dCu(i,j)   * (h(i,j,k)   + h(i+1,j,k)) + &amp;</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                    g%mask2dCu(i,j+1) * (h(i,j+1,k) + h(i+1,j+1,k))) + gv%H_subroundoff)</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;      v_2d(i,k) = (v_in(i,j,k)   * (g%mask2dCv(i,j)   * (h(i,j,k)   + h(i,j+1,k))) + &amp;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                   v_in(i+1,j,k) * (g%mask2dCv(i+1,j) * (h(i+1,j,k) + h(i+1,j+1,k))) ) / &amp;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                  ((g%mask2dCv(i,j)   * (h(i,j,k)   + h(i,j+1,k)) + &amp;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                    g%mask2dCv(i+1,j) * (h(i+1,j,k) + h(i+1,j+1,k))) + gv%H_subroundoff)</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;      i_hwt = 1.0 / (((g%mask2dT(i,j) * h(i,j,k) + g%mask2dT(i+1,j+1) * h(i+1,j+1,k)) + &amp;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                      (g%mask2dT(i+1,j) * h(i+1,j,k) + g%mask2dT(i,j+1) * h(i,j+1,k))) + &amp;</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                     gv%H_subroundoff)</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;      <span class="keywordflow">if</span> (use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;        t_2d(i,k) = ( ((g%mask2dT(i,j) * h(i,j,k)) * t_in(i,j,k) + &amp;</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                       (g%mask2dT(i+1,j+1) * h(i+1,j+1,k)) * t_in(i+1,j+1,k)) + &amp;</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                      ((g%mask2dT(i+1,j) * h(i+1,j,k)) * t_in(i+1,j,k) + &amp;</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                       (g%mask2dT(i,j+1) * h(i,j+1,k)) * t_in(i,j+1,k)) ) * i_hwt</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        s_2d(i,k) = ( ((g%mask2dT(i,j) * h(i,j,k)) * s_in(i,j,k) + &amp;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                       (g%mask2dT(i+1,j+1) * h(i+1,j+1,k)) * s_in(i+1,j+1,k)) + &amp;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                      ((g%mask2dT(i+1,j) * h(i+1,j,k)) * s_in(i+1,j,k) + &amp;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                       (g%mask2dT(i,j+1) * h(i,j+1,k)) * s_in(i,j+1,k)) ) * i_hwt</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;      h_2d(i,k) = gv%H_to_Z * ((g%mask2dT(i,j) * h(i,j,k) + g%mask2dT(i+1,j+1) * h(i+1,j+1,k)) + &amp;</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                               (g%mask2dT(i+1,j) * h(i+1,j,k) + g%mask2dT(i,j+1) * h(i,j+1,k)) ) / &amp;</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                              ((g%mask2dT(i,j) + g%mask2dT(i+1,j+1)) + &amp;</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                               (g%mask2dT(i+1,j) + g%mask2dT(i,j+1)) + 1.0e-36 )</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="comment">!      h_2d(I,k) = 0.25*((h(i,j,k) + h(i+1,j+1,k)) + (h(i+1,j,k) + h(i,j+1,k)))*GV%H_to_Z</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="comment">!      h_2d(I,k) = ((h(i,j,k)**2 + h(i+1,j+1,k)**2) + &amp;</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="comment">!                   (h(i+1,j,k)**2 + h(i,j+1,k)**2))*GV%H_to_Z * I_hwt</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="keywordflow">if</span> (.not.use_temperature) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isb,ieb</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;      rho_2d(i,k) = gv%Rlay(k)</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="keywordflow">if</span> (.not.new_kappa) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=isb,ieb</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;      kappa_2d(i,k,j2) = kv_io(i,j,k) * i_prandtl</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160; </div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="comment">!---------------------------------------</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="comment">! Work on each column.</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;<span class="comment">!---------------------------------------</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    <span class="keywordflow">do</span> i=isb,ieb ; <span class="keywordflow">if</span> ((g%mask2dCu(i,j) + g%mask2dCu(i,j+1)) + &amp;</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                       (g%mask2dCv(i,j) + g%mask2dCv(i+1,j)) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    <span class="comment">! call cpu_clock_begin(Id_clock_setup)</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;      <span class="comment">! Store a transposed version of the initial arrays.</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;      <span class="comment">! Any elimination of massless layers would occur here.</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;      <span class="keywordflow">if</span> (cs%eliminate_massless) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;        nzc = 1</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;          <span class="comment">! Zero out the thicknesses of all layers, even if they are unused.</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;          dz(k) = 0.0 ; u0xdz(k) = 0.0 ; v0xdz(k) = 0.0</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;          t0xdz(k) = 0.0 ; s0xdz(k) = 0.0</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160; </div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;          <span class="comment">! Add a new layer if this one has mass.</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="comment">!          if ((dz(nzc) &gt; 0.0) .and. (h_2d(I,k) &gt; dz_massless)) nzc = nzc+1</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;          <span class="keywordflow">if</span> ((k&gt;cs%nkml) .and. (dz(nzc) &gt; 0.0) .and. &amp;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;              (h_2d(i,k) &gt; dz_massless)) nzc = nzc+1</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160; </div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;          <span class="comment">! Only merge clusters of massless layers.</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="comment">!         if ((dz(nzc) &gt; dz_massless) .or. &amp;</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;<span class="comment">!             ((dz(nzc) &gt; 0.0) .and. (h_2d(I,k) &gt; dz_massless))) nzc = nzc+1</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160; </div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;          kc(k) = nzc</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;          dz(nzc) = dz(nzc) + h_2d(i,k)</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;          u0xdz(nzc) = u0xdz(nzc) + u_2d(i,k)*h_2d(i,k)</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;          v0xdz(nzc) = v0xdz(nzc) + v_2d(i,k)*h_2d(i,k)</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;          <span class="keywordflow">if</span> (use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;            t0xdz(nzc) = t0xdz(nzc) + t_2d(i,k)*h_2d(i,k)</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;            s0xdz(nzc) = s0xdz(nzc) + s_2d(i,k)*h_2d(i,k)</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;            t0xdz(nzc) = t0xdz(nzc) + rho_2d(i,k)*h_2d(i,k)</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;            s0xdz(nzc) = s0xdz(nzc) + rho_2d(i,k)*h_2d(i,k)</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        kc(nz+1) = nzc+1</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160; </div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        <span class="comment">! Set up Idz as the inverse of layer thicknesses.</span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        <span class="keywordflow">do</span> k=1,nzc ; idz(k) = 1.0 / dz(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160; </div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        <span class="comment">!   Now determine kf, the fractional weight of interface kc when</span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        <span class="comment">! interpolating between interfaces kc and kc+1.</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        kf(1) = 0.0 ; dz_in_lay = h_2d(i,1)</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        <span class="keywordflow">do</span> k=2,nz</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;          <span class="keywordflow">if</span> (kc(k) &gt; kc(k-1)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;            kf(k) = 0.0 ; dz_in_lay = h_2d(i,k)</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;            kf(k) = dz_in_lay*idz(kc(k)) ; dz_in_lay = dz_in_lay + h_2d(i,k)</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        kf(nz+1) = 0.0</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;          dz(k) = h_2d(i,k)</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;          u0xdz(k) = u_2d(i,k)*dz(k) ; v0xdz(k) = v_2d(i,k)*dz(k)</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;        <span class="keywordflow">if</span> (use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;          <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;            t0xdz(k) = t_2d(i,k)*dz(k) ; s0xdz(k) = s_2d(i,k)*dz(k)</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="keywordflow">          enddo</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;          <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;            t0xdz(k) = rho_2d(i,k)*dz(k) ; s0xdz(k) = rho_2d(i,k)*dz(k)</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;<span class="keywordflow">          enddo</span></div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        nzc = nz</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        <span class="keywordflow">do</span> k=1,nzc+1 ; kc(k) = k ; kf(k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;      f2 = g%CoriolisBu(i,j)**2</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;      surface_pres = 0.0 ; <span class="keywordflow">if</span> (<span class="keyword">associated</span>(p_surf)) &amp;</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        surface_pres = 0.25 * ((p_surf(i,j) + p_surf(i+1,j+1)) + &amp;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                               (p_surf(i+1,j) + p_surf(i,j+1)))</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160; </div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    <span class="comment">! ----------------------------------------------------</span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    <span class="comment">! Set the initial guess for kappa, here defined at interfaces.</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    <span class="comment">! ----------------------------------------------------</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;      <span class="keywordflow">if</span> (new_kappa) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;        <span class="keywordflow">do</span> k=1,nzc+1 ; kappa(k) = us%m2_s_to_Z2_T*1.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        <span class="keywordflow">do</span> k=1,nzc+1 ; kappa(k) = kappa_2d(i,k,j2) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160; </div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;<span class="preprocessor"></span>      <span class="keyword">call </span>kappa_shear_column(kappa, tke, dt, nzc, f2, surface_pres, &amp;</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;                              dz, u0xdz, v0xdz, t0xdz, s0xdz, kappa_avg, &amp;</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;                              tke_avg, tv, cs, gv, us, i_ld2_1d, dz_int_1d)</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="preprocessor"></span>      <span class="keyword">call </span>kappa_shear_column(kappa, tke, dt, nzc, f2, surface_pres, &amp;</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                              dz, u0xdz, v0xdz, t0xdz, s0xdz, kappa_avg, &amp;</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                              tke_avg, tv, cs, gv, us)</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;<span class="preprocessor"></span>    <span class="comment">! call cpu_clock_begin(Id_clock_setup)</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    <span class="comment">! Extrapolate from the vertically reduced grid back to the original layers.</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;      <span class="keywordflow">if</span> (nz == nzc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;          kappa_2d(i,k,j2) = kappa_avg(k)</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;          <span class="comment">!### Should this be tke_avg?</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;          tke_2d(i,k) = tke(k)</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;          <span class="keywordflow">if</span> (kf(k) == 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;            kappa_2d(i,k,j2) = kappa_avg(kc(k))</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;            tke_2d(i,k) = tke_avg(kc(k))</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;            kappa_2d(i,k,j2) = (1.0-kf(k)) * kappa_avg(kc(k)) + kf(k) * kappa_avg(kc(k)+1)</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;            tke_2d(i,k) = (1.0-kf(k)) * tke_avg(kc(k)) + kf(k) * tke_avg(kc(k)+1)</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        i_ld2_2d(i,k) = i_ld2_1d(k) ; dz_int_2d(i,k) = dz_int_1d(k)</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;<span class="preprocessor"></span>    <span class="comment">! call cpu_clock_end(Id_clock_setup)</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    <span class="keywordflow">else</span>  <span class="comment">! Land points, still inside the i-loop.</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        kappa_2d(i,k,j2) = 0.0 ; tke_2d(i,k) = 0.0</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="preprocessor"></span>        i_ld2_2d(i,k) = 0.0 ; dz_int_2d(i,k) = 0.0</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="preprocessor"></span><span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i-loop</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160; </div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=isb,ieb</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;      tke_io(i,j,k) = g%mask2dBu(i,j) * tke_2d(i,k)</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;      kv_io(i,j,k) = ( g%mask2dBu(i,j) * kappa_2d(i,k,j2) ) * cs%Prandtl_turb</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;<span class="preprocessor"></span>      i_ld2_3d(i,j,k) = i_ld2_2d(i,k) ; dz_int_3d(i,j,k) = dz_int_2d(i,k)</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;<span class="preprocessor"></span><span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <span class="keywordflow">if</span> (j&gt;=g%jsc) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=g%isc,g%iec</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;      <span class="comment">! Set the diffusivities in tracer columns from the values at vertices.</span></div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;      kappa_io(i,j,k) = g%mask2dT(i,j) * 0.25 * &amp;</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                        ((kappa_2d(i-1,k,j2m1) + kappa_2d(i,k,j2)) + &amp;</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                         (kappa_2d(i-1,k,j2)   + kappa_2d(i,k,j2m1)))</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160; </div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! end of J-loop</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160; </div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;    <span class="keyword">call </span>hchksum(kappa_io, <span class="stringliteral">&quot;kappa&quot;</span>, g%HI, scale=us%Z2_T_to_m2_s)</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;    <span class="keyword">call </span>bchksum(tke_io, <span class="stringliteral">&quot;tke&quot;</span>, g%HI)</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160; </div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kd_shear &gt; 0) <span class="keyword">call </span>post_data(cs%id_Kd_shear, kappa_io, cs%diag)</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;  <span class="keywordflow">if</span> (cs%id_TKE &gt; 0) <span class="keyword">call </span>post_data(cs%id_TKE, tke_io, cs%diag)</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span> (cs%id_ILd2 &gt; 0) <span class="keyword">call </span>post_data(cs%id_ILd2, i_ld2_3d, cs%diag)</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;  <span class="keywordflow">if</span> (cs%id_dz_Int &gt; 0) <span class="keyword">call </span>post_data(cs%id_dz_Int, dz_int_3d, cs%diag)</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="preprocessor"></span> </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__kappa__shear_8F90_source.html#l00666">kappa_shear_column()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00206">mom_set_diffusivity::set_diffusivity()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__kappa__shear_a2d8e291656bab5f83179523c4bea4d85_cgraph.svg" width="638" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__kappa__shear_a2d8e291656bab5f83179523c4bea4d85_icgraph.svg" width="362" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a3f00b08e1174690d40c0c2065fa9a8b1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3f00b08e1174690d40c0c2065fa9a8b1">&#9670;&nbsp;</a></span>calculate_kappa_shear()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_kappa_shear::calculate_kappa_shear </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>u_in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>v_in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>p_surf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)+1), intent(inout)&#160;</td>
          <td class="paramname"><em>kappa_io</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)+1), intent(out)&#160;</td>
          <td class="paramname"><em>tke_io</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)+1), intent(inout)&#160;</td>
          <td class="paramname"><em>kv_io</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__kappa__shear_1_1kappa__shear__cs.html">kappa_shear_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>initialize_all</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Subroutine for calculating shear-driven diffusivity and TKE in tracer columns. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u_in</td><td>Initial zonal velocity [L T-1 ~&gt; m s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v_in</td><td>Initial meridional velocity [L T-1 ~&gt; m s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses [H ~&gt; m or kg m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>A structure containing pointers to any available thermodynamic fields. Absent fields have NULL ptrs. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">p_surf</td><td>The pressure at the ocean surface [Pa] (or NULL). </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">kappa_io</td><td>The diapycnal diffusivity at each interface </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">tke_io</td><td>The turbulent kinetic energy per unit mass at </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">kv_io</td><td>The vertical viscosity at each interface </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment [T ~&gt; s]. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to kappa_shear_init. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">initialize_all</td><td>If present and false, the previous value of kappa is used to start the iterations </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__kappa__shear_8F90_source.html#l00101">101</a> of file <a class="el" href="MOM__kappa__shear_8F90_source.html">MOM_kappa_shear.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">      !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">     !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>    :: US<span class="comment">     !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>,   &amp;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: u_in<span class="comment">   !&lt; Initial zonal velocity [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>,   &amp;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: v_in<span class="comment">   !&lt; Initial meridional velocity [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>,   &amp;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;                           <span class="keywordtype">intent(in)</span>    :: h<span class="comment">      !&lt; Layer thicknesses [H ~&gt; m or kg m-2].</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),   <span class="keywordtype">intent(in)</span>    :: tv<span class="comment">     !&lt; A structure containing pointers to any</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment">                                                   !! available thermodynamic fields. Absent fields</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">                                                   !! have NULL ptrs.</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(:,:)</span>,    <span class="keywordtype">pointer</span>       :: p_surf<span class="comment"> !&lt; The pressure at the ocean surface [Pa] (or NULL).</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                           <span class="keywordtype">intent(inout)</span> :: kappa_io<span class="comment"> !&lt; The diapycnal diffusivity at each interface</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment">                                                   !! (not layer!) [Z2 T-1 ~&gt; m2 s-1].  Initially this is the</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="comment">                                                   !! value from the previous timestep, which may</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment">                                                   !! accelerate the iteration toward convergence.</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;                           <span class="keywordtype">intent(out)</span> :: tke_io<span class="comment">   !&lt; The turbulent kinetic energy per unit mass at</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">                                                   !! each interface (not layer!) [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                           <span class="keywordtype">intent(inout)</span> :: kv_io<span class="comment">  !&lt; The vertical viscosity at each interface</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment">                                                   !! (not layer!) [Z2 T-1 ~&gt; m2 s-1]. This discards any</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment">                                                   !! previous value (i.e. it is intent out) and</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">                                                   !! simply sets Kv = Prandtl * Kd_shear</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">     !&lt; Time increment [T ~&gt; s].</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  <span class="keywordtype">type</span>(Kappa_shear_CS),    <span class="keywordtype">pointer</span>       :: CS<span class="comment">     !&lt; The control structure returned by a previous</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">                                                   !! call to kappa_shear_init.</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  <span class="keywordtype">logical</span>,       <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: initialize_all<span class="comment"> !&lt; If present and false, the previous</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment">                                                   !! value of kappa is used to start the iterations</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160; </div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span> :: &amp;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    h_2d, &amp;             <span class="comment">! A 2-D version of h, but converted to [Z ~&gt; m].</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    u_2d, v_2d, &amp;       <span class="comment">! 2-D versions of u_in and v_in, converted to [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    T_2d, S_2d, rho_2d  <span class="comment">! 2-D versions of T [degC], S [ppt], and rho [R ~&gt; kg m-3].</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV)+1)</span> :: &amp;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    kappa_2d, &amp; <span class="comment">! 2-D version of kappa_io [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    tke_2d      <span class="comment">! 2-D version tke_io [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: &amp;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    Idz, &amp;      <span class="comment">! The inverse of the distance between TKE points [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    dz, &amp;       <span class="comment">! The layer thickness [Z ~&gt; m].</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    u0xdz, &amp;    <span class="comment">! The initial zonal velocity times dz [Z L T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    v0xdz, &amp;    <span class="comment">! The initial meridional velocity times dz [Z L T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    T0xdz, &amp;    <span class="comment">! The initial temperature times dz [degC Z ~&gt; degC m].</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    S0xdz       <span class="comment">! The initial salinity times dz [ppt Z ~&gt; ppt m].</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: &amp;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    kappa, &amp;    <span class="comment">! The shear-driven diapycnal diffusivity at an interface [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    tke, &amp;      <span class="comment">! The Turbulent Kinetic Energy per unit mass at an interface [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    kappa_avg, &amp; <span class="comment">! The time-weighted average of kappa [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    tke_avg     <span class="comment">! The time-weighted average of TKE [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="keywordtype">  real</span> :: f2   <span class="comment">! The squared Coriolis parameter of each column [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="keywordtype">  real</span> :: surface_pres  <span class="comment">! The top surface pressure [Pa].</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160; </div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="keywordtype">  real</span> :: dz_in_lay     <span class="comment">!   The running sum of the thickness in a layer [Z ~&gt; m].</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="keywordtype">  real</span> :: k0dt          <span class="comment">! The background diffusivity times the timestep [Z2 ~&gt; m2].</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="keywordtype">  real</span> :: dz_massless   <span class="comment">! A layer thickness that is considered massless [Z ~&gt; m].</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  <span class="keywordtype">logical</span> :: use_temperature  <span class="comment">!  If true, temperature and salinity have been</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                        <span class="comment">! allocated and are being used as state variables.</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  <span class="keywordtype">logical</span> :: new_kappa = .true. <span class="comment">! If true, ignore the value of kappa from the</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                        <span class="comment">! last call to this subroutine.</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160; </div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: kc <span class="comment">! The index map between the original</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                        <span class="comment">! interfaces and the interfaces with massless layers</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                        <span class="comment">! merged into nearby massive layers.</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: kf <span class="comment">! The fractional weight of interface kc+1 for</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                        <span class="comment">! interpolating back to the original index space [nondim].</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, js, je, i, j, k, nz, nzc</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160; </div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  <span class="comment">! Diagnostics that should be deleted?</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="preprocessor"></span><span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: &amp;  <span class="comment">! Additional diagnostics.</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    I_Ld2_1d, dz_Int_1d</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV)+1)</span> :: &amp; <span class="comment">! 2-D versions of diagnostics.</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    I_Ld2_2d, dz_Int_2d</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV)+1)</span> :: &amp; <span class="comment">! 3-D versions of diagnostics.</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    I_Ld2_3d, dz_Int_3d</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="preprocessor"></span>  is = g%isc ; ie = g%iec; js = g%jsc ; je = g%jec ; nz = gv%ke</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160; </div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;  use_temperature = .false. ; <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tv%T)) use_temperature = .true.</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  new_kappa = .true. ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(initialize_all)) new_kappa = initialize_all</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160; </div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  k0dt = dt*cs%kappa_0</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;  dz_massless = 0.1*sqrt(k0dt)</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160; </div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;  <span class="comment">!$OMP parallel do default(private) shared(js,je,is,ie,nz,h,u_in,v_in,use_temperature,new_kappa, &amp;</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="preprocessor"></span>  <span class="comment">!$OMP                                I_Ld2_3d,dz_Int_3d, &amp;</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="preprocessor"></span>  <span class="comment">!$OMP                                tv,G,GV,US,CS,kappa_io,dz_massless,k0dt,p_surf,dt,tke_io,kv_io)</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;  <span class="keywordflow">do</span> j=js,je</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;      h_2d(i,k) = h(i,j,k)*gv%H_to_Z</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;      u_2d(i,k) = u_in(i,j,k) ; v_2d(i,k) = v_in(i,j,k)</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="keywordflow">if</span> (use_temperature) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;      t_2d(i,k) = tv%T(i,j,k) ; s_2d(i,k) = tv%S(i,j,k)</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ; <span class="keywordflow">else</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;      rho_2d(i,k) = gv%Rlay(k) <span class="comment">! Could be tv%Rho(i,j,k) ?</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <span class="keywordflow">if</span> (.not.new_kappa) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;      kappa_2d(i,k) = kappa_io(i,j,k)</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160; </div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="comment">!---------------------------------------</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="comment">! Work on each column.</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="comment">!---------------------------------------</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (g%mask2dT(i,j) &gt; 0.5) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="comment">! call cpu_clock_begin(id_clock_setup)</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;      <span class="comment">! Store a transposed version of the initial arrays.</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;      <span class="comment">! Any elimination of massless layers would occur here.</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;      <span class="keywordflow">if</span> (cs%eliminate_massless) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        nzc = 1</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;          <span class="comment">! Zero out the thicknesses of all layers, even if they are unused.</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;          dz(k) = 0.0 ; u0xdz(k) = 0.0 ; v0xdz(k) = 0.0</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;          t0xdz(k) = 0.0 ; s0xdz(k) = 0.0</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160; </div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;          <span class="comment">! Add a new layer if this one has mass.</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment">!          if ((dz(nzc) &gt; 0.0) .and. (h_2d(i,k) &gt; dz_massless)) nzc = nzc+1</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;          <span class="keywordflow">if</span> ((k&gt;cs%nkml) .and. (dz(nzc) &gt; 0.0) .and. &amp;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;              (h_2d(i,k) &gt; dz_massless)) nzc = nzc+1</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160; </div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;          <span class="comment">! Only merge clusters of massless layers.</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment">!         if ((dz(nzc) &gt; dz_massless) .or. &amp;</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="comment">!             ((dz(nzc) &gt; 0.0) .and. (h_2d(i,k) &gt; dz_massless))) nzc = nzc+1</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160; </div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;          kc(k) = nzc</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;          dz(nzc) = dz(nzc) + h_2d(i,k)</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;          u0xdz(nzc) = u0xdz(nzc) + u_2d(i,k)*h_2d(i,k)</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;          v0xdz(nzc) = v0xdz(nzc) + v_2d(i,k)*h_2d(i,k)</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;          <span class="keywordflow">if</span> (use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;            t0xdz(nzc) = t0xdz(nzc) + t_2d(i,k)*h_2d(i,k)</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;            s0xdz(nzc) = s0xdz(nzc) + s_2d(i,k)*h_2d(i,k)</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;            t0xdz(nzc) = t0xdz(nzc) + rho_2d(i,k)*h_2d(i,k)</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;            s0xdz(nzc) = s0xdz(nzc) + rho_2d(i,k)*h_2d(i,k)</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        kc(nz+1) = nzc+1</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; </div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        <span class="comment">! Set up Idz as the inverse of layer thicknesses.</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="keywordflow">do</span> k=1,nzc ; idz(k) = 1.0 / dz(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160; </div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        <span class="comment">!   Now determine kf, the fractional weight of interface kc when</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        <span class="comment">! interpolating between interfaces kc and kc+1.</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        kf(1) = 0.0 ; dz_in_lay = h_2d(i,1)</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        <span class="keywordflow">do</span> k=2,nz</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;          <span class="keywordflow">if</span> (kc(k) &gt; kc(k-1)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;            kf(k) = 0.0 ; dz_in_lay = h_2d(i,k)</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;            kf(k) = dz_in_lay*idz(kc(k)) ; dz_in_lay = dz_in_lay + h_2d(i,k)</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        kf(nz+1) = 0.0</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;          dz(k) = h_2d(i,k)</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;          u0xdz(k) = u_2d(i,k)*dz(k) ; v0xdz(k) = v_2d(i,k)*dz(k)</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        <span class="keywordflow">if</span> (use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;          <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;            t0xdz(k) = t_2d(i,k)*dz(k) ; s0xdz(k) = s_2d(i,k)*dz(k)</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="keywordflow">          enddo</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;          <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;            t0xdz(k) = rho_2d(i,k)*dz(k) ; s0xdz(k) = rho_2d(i,k)*dz(k)</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="keywordflow">          enddo</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        nzc = nz</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        <span class="keywordflow">do</span> k=1,nzc+1 ; kc(k) = k ; kf(k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;      f2 = 0.25 * ((g%CoriolisBu(i,j)**2 + g%CoriolisBu(i-1,j-1)**2) + &amp;</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                   (g%CoriolisBu(i,j-1)**2 + g%CoriolisBu(i-1,j)**2))</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;      surface_pres = 0.0 ; <span class="keywordflow">if</span> (<span class="keyword">associated</span>(p_surf)) surface_pres = p_surf(i,j)</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160; </div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="comment">! ----------------------------------------------------    I_Ld2_1d, dz_Int_1d</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160; </div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <span class="comment">! Set the initial guess for kappa, here defined at interfaces.</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    <span class="comment">! ----------------------------------------------------</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;      <span class="keywordflow">if</span> (new_kappa) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <span class="keywordflow">do</span> k=1,nzc+1 ; kappa(k) = us%m2_s_to_Z2_T*1.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        <span class="keywordflow">do</span> k=1,nzc+1 ; kappa(k) = kappa_2d(i,k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160; </div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="preprocessor"></span>      <span class="keyword">call </span>kappa_shear_column(kappa, tke, dt, nzc, f2, surface_pres, &amp;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                              dz, u0xdz, v0xdz, t0xdz, s0xdz, kappa_avg, &amp;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                              tke_avg, tv, cs, gv, us, i_ld2_1d, dz_int_1d)</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="preprocessor"></span>      <span class="keyword">call </span>kappa_shear_column(kappa, tke, dt, nzc, f2, surface_pres, &amp;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                              dz, u0xdz, v0xdz, t0xdz, s0xdz, kappa_avg, &amp;</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                              tke_avg, tv, cs, gv, us)</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <span class="comment">! call cpu_clock_begin(id_clock_setup)</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="comment">! Extrapolate from the vertically reduced grid back to the original layers.</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;      <span class="keywordflow">if</span> (nz == nzc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;          kappa_2d(i,k) = kappa_avg(k)</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;          <span class="comment">!### Should this be tke_avg?</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;          tke_2d(i,k) = tke(k)</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;          <span class="keywordflow">if</span> (kf(k) == 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;            kappa_2d(i,k) = kappa_avg(kc(k))</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;            tke_2d(i,k) = tke_avg(kc(k))</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;            kappa_2d(i,k) = (1.0-kf(k)) * kappa_avg(kc(k)) + &amp;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                             kf(k) * kappa_avg(kc(k)+1)</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;            tke_2d(i,k) = (1.0-kf(k)) * tke_avg(kc(k)) + &amp;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                           kf(k) * tke_avg(kc(k)+1)</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        i_ld2_2d(i,k) = i_ld2_1d(k) ; dz_int_2d(i,k) = dz_int_1d(k)</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="preprocessor"></span>    <span class="comment">! call cpu_clock_end(id_clock_setup)</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    <span class="keywordflow">else</span>  <span class="comment">! Land points, still inside the i-loop.</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        kappa_2d(i,k) = 0.0 ; tke_2d(i,k) = 0.0</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="preprocessor"></span>        i_ld2_2d(i,k) = 0.0  ; dz_int_2d(i,k) = 0.0</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="preprocessor"></span><span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i-loop</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160; </div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=is,ie</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;      kappa_io(i,j,k) = g%mask2dT(i,j) * kappa_2d(i,k)</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;      tke_io(i,j,k) = g%mask2dT(i,j) * tke_2d(i,k)</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;      kv_io(i,j,k) = ( g%mask2dT(i,j) * kappa_2d(i,k) ) * cs%Prandtl_turb</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="preprocessor"></span>      i_ld2_3d(i,j,k) = i_ld2_2d(i,k) ; dz_int_3d(i,j,k) = dz_int_2d(i,k)</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="preprocessor"></span><span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160; </div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! end of j-loop</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160; </div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    <span class="keyword">call </span>hchksum(kappa_io, <span class="stringliteral">&quot;kappa&quot;</span>, g%HI, scale=us%Z2_T_to_m2_s)</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    <span class="keyword">call </span>hchksum(tke_io, <span class="stringliteral">&quot;tke&quot;</span>, g%HI, scale=us%Z_to_m**2*us%s_to_T**2)</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160; </div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kd_shear &gt; 0) <span class="keyword">call </span>post_data(cs%id_Kd_shear, kappa_io, cs%diag)</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;  <span class="keywordflow">if</span> (cs%id_TKE &gt; 0) <span class="keyword">call </span>post_data(cs%id_TKE, tke_io, cs%diag)</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span> (cs%id_ILd2 &gt; 0) <span class="keyword">call </span>post_data(cs%id_ILd2, i_ld2_3d, cs%diag)</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;  <span class="keywordflow">if</span> (cs%id_dz_Int &gt; 0) <span class="keyword">call </span>post_data(cs%id_dz_Int, dz_int_3d, cs%diag)</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="preprocessor"></span> </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__kappa__shear_8F90_source.html#l00666">kappa_shear_column()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__kappa__shear_a3f00b08e1174690d40c0c2065fa9a8b1_cgraph.svg" width="666" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a0b931b0b834d887e321eb6eb1924fa9a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0b931b0b834d887e321eb6eb1924fa9a">&#9670;&nbsp;</a></span>calculate_projected_state()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_kappa_shear::calculate_projected_state </td>
          <td>(</td>
          <td class="paramtype">real, dimension(nz+1), intent(in)&#160;</td>
          <td class="paramname"><em>kappa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz), intent(in)&#160;</td>
          <td class="paramname"><em>u0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz), intent(in)&#160;</td>
          <td class="paramname"><em>v0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz), intent(in)&#160;</td>
          <td class="paramname"><em>T0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz), intent(in)&#160;</td>
          <td class="paramname"><em>S0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz), intent(in)&#160;</td>
          <td class="paramname"><em>dz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(in)&#160;</td>
          <td class="paramname"><em>I_dz_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(in)&#160;</td>
          <td class="paramname"><em>dbuoy_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(in)&#160;</td>
          <td class="paramname"><em>dbuoy_dS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz), intent(inout)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz), intent(inout)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz), intent(inout)&#160;</td>
          <td class="paramname"><em>T</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz), intent(inout)&#160;</td>
          <td class="paramname"><em>Sal</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(inout), optional&#160;</td>
          <td class="paramname"><em>N2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(inout), optional&#160;</td>
          <td class="paramname"><em>S2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in), optional&#160;</td>
          <td class="paramname"><em>ks_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in), optional&#160;</td>
          <td class="paramname"><em>ke_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>vel_underflow</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine calculates the velocities, temperature and salinity that the water column will have after mixing for dt with diffusivities kappa. It may also calculate the projected buoyancy frequency and shear. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">nz</td><td>The number of layers (after eliminating massless layers?). </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">kappa</td><td>The diapycnal diffusivity at interfaces, [Z2 T-1 ~&gt; m2 s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u0</td><td>The initial zonal velocity [L T-1 ~&gt; m s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v0</td><td>The initial meridional velocity [L T-1 ~&gt; m s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">t0</td><td>The initial temperature [degC]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">s0</td><td>The initial salinity [ppt]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dz</td><td>The grid spacing of layers [Z ~&gt; m]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">i_dz_int</td><td>The inverse of the layer's thicknesses [Z-1 ~&gt; m-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dbuoy_dt</td><td>The partial derivative of buoyancy with temperature [Z T-2 degC-1 ~&gt; m s-2 degC-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dbuoy_ds</td><td>The partial derivative of buoyancy with salinity [Z T-2 ppt-1 ~&gt; m s-2 ppt-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>The time step [T ~&gt; s]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">u</td><td>The zonal velocity after dt [L T-1 ~&gt; m s-1]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">v</td><td>The meridional velocity after dt [L T-1 ~&gt; m s-1]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">t</td><td>The temperature after dt [degC]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">sal</td><td>The salinity after dt [ppt]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">n2</td><td>The buoyancy frequency squared at interfaces [T-2 ~&gt; s-2]. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">s2</td><td>The squared shear at interfaces [T-2 ~&gt; s-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ks_int</td><td>The topmost k-index with a non-zero diffusivity. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ke_int</td><td>The bottommost k-index with a non-zero diffusivity. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">vel_underflow</td><td>If present and true, any velocities that are smaller in magnitude than this value are set to 0 [L T-1 ~&gt; m s-1]. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__kappa__shear_8F90_source.html#l01216">1216</a> of file <a class="el" href="MOM__kappa__shear_8F90_source.html">MOM_kappa_shear.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;  <span class="keywordtype">integer</span>,               <span class="keywordtype">intent(in)</span>    :: nz<span class="comment">  !&lt; The number of layers (after eliminating massless</span></div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;<span class="comment">                                              !! layers?).</span></div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(in)</span>    :: kappa<span class="comment"> !&lt; The diapycnal diffusivity at interfaces,</span></div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;<span class="comment">                                              !! [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz)</span>,   <span class="keywordtype">intent(in)</span>    :: u0<span class="comment">  !&lt; The initial zonal velocity [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz)</span>,   <span class="keywordtype">intent(in)</span>    :: v0<span class="comment">  !&lt; The initial meridional velocity [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz)</span>,   <span class="keywordtype">intent(in)</span>    :: T0<span class="comment">  !&lt; The initial temperature [degC].</span></div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz)</span>,   <span class="keywordtype">intent(in)</span>    :: S0<span class="comment">  !&lt; The initial salinity [ppt].</span></div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz)</span>,   <span class="keywordtype">intent(in)</span>    :: dz<span class="comment">  !&lt; The grid spacing of layers [Z ~&gt; m].</span></div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(in)</span>    :: I_dz_int<span class="comment"> !&lt; The inverse of the layer&#39;s thicknesses</span></div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;<span class="comment">                                              !! [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(in)</span>    :: dbuoy_dT<span class="comment"> !&lt; The partial derivative of buoyancy with</span></div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;<span class="comment">                                              !! temperature [Z T-2 degC-1 ~&gt; m s-2 degC-1].</span></div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(in)</span>    :: dbuoy_dS<span class="comment"> !&lt; The partial derivative of buoyancy with</span></div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;<span class="comment">                                              !! salinity [Z T-2 ppt-1 ~&gt; m s-2 ppt-1].</span></div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">  !&lt; The time step [T ~&gt; s].</span></div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz)</span>,   <span class="keywordtype">intent(inout)</span> :: u<span class="comment">   !&lt; The zonal velocity after dt [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz)</span>,   <span class="keywordtype">intent(inout)</span> :: v<span class="comment">   !&lt; The meridional velocity after dt [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz)</span>,   <span class="keywordtype">intent(inout)</span> :: T<span class="comment">   !&lt; The temperature after dt [degC].</span></div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz)</span>,   <span class="keywordtype">intent(inout)</span> :: Sal<span class="comment"> !&lt; The salinity after dt [ppt].</span></div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>  :: GV<span class="comment">  !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type), <span class="keywordtype">intent(in)</span>    :: US<span class="comment">  !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">optional</span>, &amp;</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;                         <span class="keywordtype">intent(inout)</span> :: N2<span class="comment">  !&lt; The buoyancy frequency squared at interfaces [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">optional</span>, &amp;</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;                         <span class="keywordtype">intent(inout)</span> :: S2<span class="comment">  !&lt; The squared shear at interfaces [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">optional</span>,     <span class="keywordtype">intent(in)</span>    :: ks_int<span class="comment"> !&lt; The topmost k-index with a non-zero diffusivity.</span></div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">optional</span>,     <span class="keywordtype">intent(in)</span>    :: ke_int<span class="comment"> !&lt; The bottommost k-index with a non-zero</span></div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;<span class="comment">                                              !! diffusivity.</span></div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;<span class="keywordtype">  real</span>,    <span class="keywordtype">optional</span>,     <span class="keywordtype">intent(in)</span>    :: vel_underflow<span class="comment"> !&lt; If present and true, any velocities that</span></div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;<span class="comment">                                              !! are smaller in magnitude than this value are</span></div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;<span class="comment">                                              !! set to 0 [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160; </div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span> :: c1</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;<span class="keywordtype">  real</span> :: L2_to_Z2       <span class="comment">! A conversion factor from horizontal length units to vertical depth</span></div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;                         <span class="comment">! units squared [Z2 s2 T-2 m-2 ~&gt; 1].</span></div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;<span class="keywordtype">  real</span> :: underflow_vel  <span class="comment">! Velocities smaller in magnitude than underflow_vel are set to 0 [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;<span class="keywordtype">  real</span> :: a_a, a_b, b1, d1, bd1, b1nz_0</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;  <span class="keywordtype">integer</span> :: k, ks, ke</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160; </div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;  ks = 1 ; ke = nz</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(ks_int)) ks = max(ks_int-1,1)</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(ke_int)) ke = min(ke_int,nz)</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;  underflow_vel = 0.0 ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(vel_underflow)) underflow_vel = vel_underflow</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160; </div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;  <span class="keywordflow">if</span> (ks &gt; ke) <span class="keywordflow">return</span></div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160; </div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;  <span class="keywordflow">if</span> (dt &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;    a_b = dt*(kappa(ks+1)*i_dz_int(ks+1))</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;    b1 = 1.0 / (dz(ks) + a_b)</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;    c1(ks+1) = a_b * b1 ; d1 = dz(ks) * b1 <span class="comment">! = 1 - c1</span></div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160; </div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;    u(ks) = (b1 * dz(ks))*u0(ks) ; v(ks) = (b1 * dz(ks))*v0(ks)</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;    t(ks) = (b1 * dz(ks))*t0(ks) ; sal(ks) = (b1 * dz(ks))*s0(ks)</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;    <span class="keywordflow">do</span> k=ks+1,ke-1</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;      a_a = a_b</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;      a_b = dt*(kappa(k+1)*i_dz_int(k+1))</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;      bd1 = dz(k) + d1*a_a</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;      b1 = 1.0 / (bd1 + a_b)</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;      c1(k+1) = a_b * b1 ; d1 = bd1 * b1 <span class="comment">! d1 = 1 - c1</span></div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160; </div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;      u(k) = b1 * (dz(k)*u0(k) + a_a*u(k-1))</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;      v(k) = b1 * (dz(k)*v0(k) + a_a*v(k-1))</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;      t(k) = b1 * (dz(k)*t0(k) + a_a*t(k-1))</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;      sal(k) = b1 * (dz(k)*s0(k) + a_a*sal(k-1))</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    <span class="comment">!   T and S have insulating boundary conditions, u &amp; v use no-slip</span></div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    <span class="comment">! bottom boundary conditions at the solid bottom.</span></div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160; </div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;    <span class="comment">! For insulating boundary conditions or mixing simply stopping, use...</span></div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    a_a = a_b</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;    b1 = 1.0 / (dz(ke) + d1*a_a)</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    t(ke) = b1 * (dz(ke)*t0(ke) + a_a*t(ke-1))</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    sal(ke) = b1 * (dz(ke)*s0(ke) + a_a*sal(ke-1))</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160; </div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    <span class="comment">!   There is no distinction between the effective boundary conditions for</span></div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;    <span class="comment">! tracers and velocities if the mixing is separated from the bottom, but if</span></div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;    <span class="comment">! the mixing goes all the way to the bottom, use no-slip BCs for velocities.</span></div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;    <span class="keywordflow">if</span> (ke == nz) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;      a_b = dt*(kappa(nz+1)*i_dz_int(nz+1))</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;      b1nz_0 = 1.0 / ((dz(nz) + d1*a_a) + a_b)</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;      b1nz_0 = b1</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;    u(ke) = b1nz_0 * (dz(ke)*u0(ke) + a_a*u(ke-1))</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;    v(ke) = b1nz_0 * (dz(ke)*v0(ke) + a_a*v(ke-1))</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;    <span class="keywordflow">if</span> (abs(u(ke)) &lt; underflow_vel) u(ke) = 0.0</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;    <span class="keywordflow">if</span> (abs(v(ke)) &lt; underflow_vel) v(ke) = 0.0</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160; </div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;    <span class="keywordflow">do</span> k=ke-1,ks,-1</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;      u(k) = u(k) + c1(k+1)*u(k+1)</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;      v(k) = v(k) + c1(k+1)*v(k+1)</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;      <span class="keywordflow">if</span> (abs(u(k)) &lt; underflow_vel) u(k) = 0.0</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;      <span class="keywordflow">if</span> (abs(v(k)) &lt; underflow_vel) v(k) = 0.0</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;      t(k) = t(k) + c1(k+1)*t(k+1)</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;      sal(k) = sal(k) + c1(k+1)*sal(k+1)</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;  <span class="keywordflow">else</span> <span class="comment">! dt &lt;= 0.0</span></div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;    <span class="keywordflow">do</span> k=1,nz</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;      u(k) = u0(k) ; v(k) = v0(k) ; t(k) = t0(k) ; sal(k) = s0(k)</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;      <span class="keywordflow">if</span> (abs(u(k)) &lt; underflow_vel) u(k) = 0.0</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;      <span class="keywordflow">if</span> (abs(v(k)) &lt; underflow_vel) v(k) = 0.0</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160; </div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(s2)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;    <span class="comment">! L2_to_Z2 = US%m_to_Z**2 * US%T_to_s**2</span></div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;    l2_to_z2 = us%L_to_Z**2</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;    s2(1) = 0.0 ; s2(nz+1) = 0.0</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;    <span class="keywordflow">if</span> (ks &gt; 1) &amp;</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;      s2(ks) = ((u(ks)-u0(ks-1))**2 + (v(ks)-v0(ks-1))**2) * (l2_to_z2*i_dz_int(ks)**2)</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;    <span class="keywordflow">do</span> k=ks+1,ke</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;      s2(k) = ((u(k)-u(k-1))**2 + (v(k)-v(k-1))**2) * (l2_to_z2*i_dz_int(k)**2)</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;    <span class="keywordflow">if</span> (ke&lt;nz) &amp;</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;      s2(ke+1) = ((u0(ke+1)-u(ke))**2 + (v0(ke+1)-v(ke))**2) * (l2_to_z2*i_dz_int(ke+1)**2)</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160; </div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(n2)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;    n2(1) = 0.0 ; n2(nz+1) = 0.0</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;    <span class="keywordflow">if</span> (ks &gt; 1) &amp;</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;      n2(ks) = max(0.0, i_dz_int(ks) * &amp;</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;        (dbuoy_dt(ks) * (t0(ks-1)-t(ks)) + dbuoy_ds(ks) * (s0(ks-1)-sal(ks))))</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;    <span class="keywordflow">do</span> k=ks+1,ke</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;      n2(k) = max(0.0, i_dz_int(k) * &amp;</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;        (dbuoy_dt(k) * (t(k-1)-t(k)) + dbuoy_ds(k) * (sal(k-1)-sal(k))))</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;    <span class="keywordflow">if</span> (ke&lt;nz) &amp;</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;      n2(ke+1) = max(0.0, i_dz_int(ke+1) * &amp;</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;        (dbuoy_dt(ke+1) * (t(ke)-t0(ke+1)) + dbuoy_ds(ke+1) * (sal(ke)-s0(ke+1))))</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__kappa__shear_8F90_source.html#l00666">kappa_shear_column()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__kappa__shear_a0b931b0b834d887e321eb6eb1924fa9a_icgraph.svg" width="100%" height="388"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a351d44e4fe5cfb5852d019a0c1e66100"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a351d44e4fe5cfb5852d019a0c1e66100">&#9670;&nbsp;</a></span>find_kappa_tke()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_kappa_shear::find_kappa_tke </td>
          <td>(</td>
          <td class="paramtype">real, dimension(nz+1), intent(in)&#160;</td>
          <td class="paramname"><em>N2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(in)&#160;</td>
          <td class="paramname"><em>S2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(in)&#160;</td>
          <td class="paramname"><em>kappa_in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz), intent(in)&#160;</td>
          <td class="paramname"><em>Idz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(in)&#160;</td>
          <td class="paramname"><em>dz_Int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(in)&#160;</td>
          <td class="paramname"><em>I_L2_bdry</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>f2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__kappa__shear_1_1kappa__shear__cs.html">kappa_shear_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(inout)&#160;</td>
          <td class="paramname"><em>K_Q</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(out)&#160;</td>
          <td class="paramname"><em>tke</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(out)&#160;</td>
          <td class="paramname"><em>kappa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(out), optional&#160;</td>
          <td class="paramname"><em>kappa_src</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(out), optional&#160;</td>
          <td class="paramname"><em>local_src</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine calculates new, consistent estimates of TKE and kappa. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">nz</td><td>The number of layers to work on. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n2</td><td>The buoyancy frequency squared at interfaces [T-2 ~&gt; s-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">s2</td><td>The squared shear at interfaces [T-2 ~&gt; s-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">kappa_in</td><td>The initial guess at the diffusivity [Z2 T-1 ~&gt; m2 s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dz_int</td><td>The thicknesses associated with interfaces [Z-1 ~&gt; m-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">i_l2_bdry</td><td>The inverse of the squared distance to boundaries [Z-2 ~&gt; m-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">idz</td><td>The inverse grid spacing of layers [Z-1 ~&gt; m-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">f2</td><td>The squared Coriolis parameter [T-2 ~&gt; s-2]. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>A pointer to this module's control structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">k_q</td><td>The shear-driven diapycnal diffusivity divided by the turbulent kinetic energy per unit mass at interfaces [Z2 m-2 s2 T-1 ~&gt; s]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">tke</td><td>The turbulent kinetic energy per unit mass at interfaces [Z2 T-2 ~&gt; m2 s-2]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">kappa</td><td>The diapycnal diffusivity at interfaces [Z2 T-1 ~&gt; m2 s-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">kappa_src</td><td>The source term for kappa [T-1 ~&gt; s-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">local_src</td><td>The sum of all local sources for kappa, </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__kappa__shear_8F90_source.html#l01354">1354</a> of file <a class="el" href="MOM__kappa__shear_8F90_source.html">MOM_kappa_shear.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;  <span class="keywordtype">integer</span>,               <span class="keywordtype">intent(in)</span>    :: nz<span class="comment">  !&lt; The number of layers to work on.</span></div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(in)</span>    :: N2<span class="comment">  !&lt; The buoyancy frequency squared at interfaces [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(in)</span>    :: S2<span class="comment">  !&lt; The squared shear at interfaces [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(in)</span>    :: kappa_in<span class="comment">  !&lt; The initial guess at the diffusivity</span></div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;<span class="comment">                                              !! [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(in)</span>    :: dz_Int<span class="comment"> !&lt; The thicknesses associated with interfaces</span></div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;<span class="comment">                                              !! [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(in)</span>    :: I_L2_bdry<span class="comment"> !&lt; The inverse of the squared distance to</span></div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;<span class="comment">                                              !! boundaries [Z-2 ~&gt; m-2].</span></div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz)</span>,   <span class="keywordtype">intent(in)</span>    :: Idz<span class="comment"> !&lt; The inverse grid spacing of layers [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;<span class="keywordtype">  real</span>,                  <span class="keywordtype">intent(in)</span>    :: f2<span class="comment">  !&lt; The squared Coriolis parameter [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;  <span class="keywordtype">type</span>(Kappa_shear_CS),  <span class="keywordtype">pointer</span>       :: CS<span class="comment">  !&lt; A pointer to this module&#39;s control structure.</span></div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>  :: GV<span class="comment">  !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type), <span class="keywordtype">intent(in)</span>    :: US<span class="comment">  !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(inout)</span> :: K_Q<span class="comment"> !&lt; The shear-driven diapycnal diffusivity divided by</span></div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;<span class="comment">                                              !! the turbulent kinetic energy per unit mass at</span></div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;<span class="comment">                                              !! interfaces [Z2 m-2 s2 T-1 ~&gt; s].</span></div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(out)</span>   :: tke<span class="comment"> !&lt; The turbulent kinetic energy per unit mass at</span></div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;<span class="comment">                                              !! interfaces [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(out)</span>   :: kappa<span class="comment">  !&lt; The diapycnal diffusivity at interfaces</span></div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;<span class="comment">                                              !! [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">optional</span>, &amp;</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;                         <span class="keywordtype">intent(out)</span>   :: kappa_src<span class="comment"> !&lt; The source term for kappa [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">optional</span>, &amp;</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;                         <span class="keywordtype">intent(out)</span>   :: local_src<span class="comment"> !&lt; The sum of all local sources for kappa,</span></div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;<span class="comment">                                              !! [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;<span class="comment">!   This subroutine calculates new, consistent estimates of TKE and kappa.</span></div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160; </div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz)</span> :: &amp;</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;    aQ, &amp;       <span class="comment">! aQ is the coupling between adjacent interfaces in the TKE equations [Z T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    dQdz        <span class="comment">! Half the partial derivative of TKE with depth [Z T-2 ~&gt; m s-2].</span></div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span> :: &amp;</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    dK, &amp;         <span class="comment">! The change in kappa [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;    dQ, &amp;         <span class="comment">! The change in TKE [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;    cQ, cK, &amp;     <span class="comment">! cQ and cK are the upward influences in the tridiagonal and</span></div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;                  <span class="comment">! hexadiagonal solvers for the TKE and kappa equations [nondim].</span></div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;    i_ld2, &amp;      <span class="comment">! 1/Ld^2, where Ld is the effective decay length scale for kappa [Z-2 ~&gt; m-2].</span></div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;    tke_decay, &amp;  <span class="comment">! The local TKE decay rate [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;    k_src, &amp;      <span class="comment">! The source term in the kappa equation [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;    dqmdk, &amp;      <span class="comment">! With Newton&#39;s method the change in dQ(k-1) due to dK(k) [T ~&gt; s].</span></div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;    dkdq, &amp;       <span class="comment">! With Newton&#39;s method the change in dK(k) due to dQ(k) [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;    e1            <span class="comment">! The fractional change in a layer TKE due to a change in the</span></div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;                  <span class="comment">! TKE of the layer above when all the kappas below are 0.</span></div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;                  <span class="comment">! e1 is nondimensional, and 0 &lt; e1 &lt; 1.</span></div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;<span class="keywordtype">  real</span> :: tke_src       <span class="comment">! The net source of TKE due to mixing against the shear</span></div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;                        <span class="comment">! and stratification [Z2 T-3 ~&gt; m2 s-3].  (For convenience,</span></div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;                        <span class="comment">! a term involving the non-dissipation of q0 is also</span></div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;                        <span class="comment">! included here.)</span></div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;<span class="keywordtype">  real</span> :: bQ            <span class="comment">! The inverse of the pivot in the tridiagonal equations [T Z-1 ~&gt; s m-1].</span></div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;<span class="keywordtype">  real</span> :: bK            <span class="comment">! The inverse of the pivot in the tridiagonal equations [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;<span class="keywordtype">  real</span> :: bQd1          <span class="comment">! A term in the denominator of bQ [Z T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;<span class="keywordtype">  real</span> :: bKd1          <span class="comment">! A term in the denominator of bK [Z ~&gt; m].</span></div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;<span class="keywordtype">  real</span> :: cQcomp, cKcomp <span class="comment">! 1 - cQ or 1 - cK in the tridiagonal equations.</span></div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;<span class="keywordtype">  real</span> :: c_s2          <span class="comment">!   The coefficient for the decay of TKE due to</span></div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;                        <span class="comment">! shear (i.e. proportional to |S|*tke), nondimensional.</span></div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;<span class="keywordtype">  real</span> :: c_n2          <span class="comment">!   The coefficient for the decay of TKE due to</span></div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;                        <span class="comment">! stratification (i.e. proportional to N*tke) [nondim].</span></div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;<span class="keywordtype">  real</span> :: Ri_crit       <span class="comment">!   The critical shear Richardson number for shear-</span></div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;                        <span class="comment">! driven mixing. The theoretical value is 0.25.</span></div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;<span class="keywordtype">  real</span> :: q0            <span class="comment">!   The background level of TKE [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;<span class="keywordtype">  real</span> :: Ilambda2      <span class="comment">! 1.0 / CS%lambda**2 [nondim]</span></div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;<span class="keywordtype">  real</span> :: TKE_min       <span class="comment">!   The minimum value of shear-driven TKE that can be</span></div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;                        <span class="comment">! solved for [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;<span class="keywordtype">  real</span> :: kappa0        <span class="comment">! The background diapycnal diffusivity [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;<span class="keywordtype">  real</span> :: kappa_trunc   <span class="comment">! Diffusivities smaller than this are rounded to 0 [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160; </div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;<span class="keywordtype">  real</span> :: eden1, eden2, I_eden, ome  <span class="comment">! Variables used in calculating e1.</span></div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;<span class="keywordtype">  real</span> :: diffusive_src <span class="comment">! The diffusive source in the kappa equation [Z T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;<span class="keywordtype">  real</span> :: chg_by_k0     <span class="comment">! The value of k_src that leads to an increase of</span></div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;                        <span class="comment">! kappa_0 if only the diffusive term is a sink [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160; </div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;<span class="keywordtype">  real</span> :: kappa_mean    <span class="comment">! A mean value of kappa [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;<span class="keywordtype">  real</span> :: Newton_test   <span class="comment">! The value of relative error that will cause the next</span></div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;                        <span class="comment">! iteration to use Newton&#39;s method.</span></div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;  <span class="comment">! Temporary variables used in the Newton&#39;s method iterations.</span></div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;<span class="keywordtype">  real</span> :: decay_term_k  <span class="comment">! The decay term in the diffusivity equation</span></div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;<span class="keywordtype">  real</span> :: decay_term_Q  <span class="comment">! The decay term in the TKE equation - proportional to [T-1 ~&gt; s-1]</span></div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;<span class="keywordtype">  real</span> :: I_Q           <span class="comment">! The inverse of TKE [T2 Z-2 ~&gt; s2 m-2]</span></div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;<span class="keywordtype">  real</span> :: kap_src</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;<span class="keywordtype">  real</span> :: v1            <span class="comment">! A temporary variable proportional to [T-1 ~&gt; s-1]</span></div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;<span class="keywordtype">  real</span> :: v2</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;<span class="keywordtype">  real</span> :: tol_err        <span class="comment">! The tolerance for max_err that determines when to</span></div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;                         <span class="comment">! stop iterating.</span></div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;<span class="keywordtype">  real</span> :: Newton_err     <span class="comment">! The tolerance for max_err that determines when to</span></div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;                         <span class="comment">! start using Newton&#39;s method.  Empirically, an initial</span></div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;                         <span class="comment">! value of about 0.2 seems to be most efficient.</span></div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">parameter</span> :: roundoff = 1.0e-16 <span class="comment">! A negligible fractional change in TKE.</span></div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;                         <span class="comment">! This could be larger but performance gains are small.</span></div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160; </div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;  <span class="keywordtype">logical</span> :: tke_noflux_bottom_BC = .false. <span class="comment">! Specify the boundary conditions</span></div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;  <span class="keywordtype">logical</span> :: tke_noflux_top_BC = .false.    <span class="comment">! that are applied to the TKE eqns.</span></div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;  <span class="keywordtype">logical</span> :: do_Newton    <span class="comment">! If .true., use Newton&#39;s method for the next iteration.</span></div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;  <span class="keywordtype">logical</span> :: abort_Newton <span class="comment">! If .true., an Newton&#39;s method has encountered a 0</span></div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;                          <span class="comment">! pivot, and should not have been used.</span></div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;  <span class="keywordtype">logical</span> :: was_Newton   <span class="comment">! The value of do_Newton before checking convergence.</span></div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;  <span class="keywordtype">logical</span> :: within_tolerance <span class="comment">! If .true., all points are within tolerance to</span></div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;                          <span class="comment">! enable this subroutine to return.</span></div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;  <span class="keywordtype">integer</span> :: ks_src, ke_src <span class="comment">! The range indices that have nonzero k_src.</span></div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;  <span class="keywordtype">integer</span> :: ks_kappa, ke_kappa, ke_tke   <span class="comment">! The ranges of k-indices that are or</span></div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;  <span class="keywordtype">integer</span> :: ks_kappa_prev, ke_kappa_prev <span class="comment">! were being worked on.</span></div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;  <span class="keywordtype">integer</span> :: itt, k, k2</div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">integer</span> :: max_debug_itt ; <span class="keywordtype">parameter</span>(max_debug_itt=20)</div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;<span class="keywordtype">  real</span> :: K_err_lin, Q_err_lin, TKE_src_norm</div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1)</span> :: &amp;</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;    I_Ld2_debug, &amp; <span class="comment">! A separate version of I_Ld2 for debugging [Z-2 ~&gt; m-2].</span></div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;    kappa_prev, &amp; <span class="comment">! The value of kappa at the start of the current iteration [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;    TKE_prev   <span class="comment">! The value of TKE at the start of the current iteration [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nz+1,1:max_debug_itt)</span> :: &amp;</div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;    tke_it1, kappa_it1, kprev_it1, &amp;  <span class="comment">! Various values from each iteration.</span></div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;    dkappa_it1, K_Q_it1, d_dkappa_it1, dkappa_norm_it1</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;  <span class="keywordtype">integer</span> :: it2</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;  c_n2 = cs%C_N**2 ; c_s2 = cs%C_S**2</div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;  q0 = cs%TKE_bg ; kappa0 = cs%kappa_0</div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;  tke_min = max(cs%TKE_bg, 1.0e-20*us%m_to_Z**2*us%T_to_s**2)</div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;  ri_crit = cs%Rino_crit</div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;  ilambda2 = 1.0 / cs%lambda**2</div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;  kappa_trunc = cs%kappa_trunc</div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;  do_newton = .false. ; abort_newton = .false.</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;  tol_err = cs%kappa_tol_err</div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;  newton_err = 0.2     <span class="comment">! This initial value may be automatically reduced later.</span></div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160; </div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;  ks_kappa = 2 ; ke_kappa = nz ; ks_kappa_prev = 2 ; ke_kappa_prev = nz</div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160; </div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;  ke_src = 0 ; ks_src = nz+1</div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;  <span class="keywordflow">do</span> k=2,nz</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;    <span class="keywordflow">if</span> (n2(k) &lt; ri_crit * s2(k)) <span class="keywordflow">then</span> <span class="comment">! Equivalent to Ri &lt; Ri_crit.</span></div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;<span class="comment">!       Ri = N2(K) / S2(K)</span></div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;<span class="comment">!       k_src(K) = (2.0 * CS%Shearmix_rate * sqrt(S2(K))) * &amp;</span></div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;<span class="comment">!                  ((Ri_crit - Ri) / (Ri_crit + CS%FRi_curvature*Ri))</span></div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;      k_src(k) = (2.0 * cs%Shearmix_rate * sqrt(s2(k))) * &amp;</div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;                 ((ri_crit*s2(k) - n2(k)) / (ri_crit*s2(k) + cs%FRi_curvature*n2(k)))</div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;      ke_src = k</div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;      <span class="keywordflow">if</span> (ks_src &gt; k) ks_src = k</div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;      k_src(k) = 0.0</div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160; </div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;  <span class="comment">! If there is no source anywhere, return kappa(K) = 0.</span></div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;  <span class="keywordflow">if</span> (ks_src &gt; ke_src) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;    <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;      kappa(k) = 0.0 ; k_q(k) = 0.0 ; tke(k) = tke_min</div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(kappa_src)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz+1 ; kappa_src(k) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(local_src)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz+1 ; local_src(k) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;    <span class="keywordflow">return</span></div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160; </div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;  <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;    kappa(k) = kappa_in(k)</div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;<span class="comment">!     TKE_decay(K) = c_n*sqrt(N2(K)) + c_s*sqrt(S2(K)) ! The expression in JHL.</span></div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;    tke_decay(k) = sqrt(c_n2*n2(k) + c_s2*s2(k))</div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;    <span class="keywordflow">if</span> ((kappa(k) &gt; 0.0) .and. (k_q(k) &gt; 0.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;      tke(k) = kappa(k) / k_q(k)</div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;      tke(k) = tke_min</div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;  <span class="comment">! Apply boundary conditions to kappa.</span></div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;  kappa(1) = 0.0 ; kappa(nz+1) = 0.0</div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160; </div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;  <span class="comment">! Calculate the term (e1) that allows changes in TKE to be calculated quickly</span></div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;  <span class="comment">! below the deepest nonzero value of kappa.  If kappa = 0, below interface</span></div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;  <span class="comment">! k-1, the final changes in TKE are related by dQ(K+1) = e1(K+1)*dQ(K).</span></div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;  eden2 = kappa0 * idz(nz)</div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;  <span class="keywordflow">if</span> (tke_noflux_bottom_bc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;    eden1 = dz_int(nz+1)*tke_decay(nz+1)</div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;    i_eden = 1.0 / (eden2 + eden1)</div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;    e1(nz+1) = eden2 * i_eden ; ome = eden1 * i_eden</div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;    e1(nz+1) = 0.0 ; ome = 1.0</div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;  <span class="keywordflow">do</span> k=nz,2,-1</div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;    eden1 = dz_int(k)*tke_decay(k) + ome * eden2</div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;    eden2 = kappa0 * idz(k-1)</div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;    i_eden = 1.0 / (eden2 + eden1)</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;    e1(k) = eden2 * i_eden ; ome = eden1 * i_eden <span class="comment">! = 1-e1</span></div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;  e1(1) = 0.0</div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160; </div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160; </div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;  <span class="comment">! Iterate here to convergence to within some tolerance of order tol_err.</span></div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;  <span class="keywordflow">do</span> itt=1,cs%max_RiNo_it</div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160; </div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;  <span class="comment">! ----------------------------------------------------</span></div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;  <span class="comment">! Calculate TKE</span></div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;  <span class="comment">! ----------------------------------------------------</span></div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160; </div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">do</span> k=1,nz+1 ; kappa_prev(k) = kappa(k) ; tke_prev(k) = tke(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;    <span class="keywordflow">if</span> (.not.do_newton) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;      <span class="comment">!   Use separate steps of the TKE and kappa equations, that are</span></div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;      <span class="comment">! explicit in the nonlinear source terms, implicit in a linearized</span></div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;      <span class="comment">! version of the nonlinear sink terms, and implicit in the linear</span></div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;      <span class="comment">! terms.</span></div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160; </div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;      ke_tke = max(ke_kappa,ke_kappa_prev)+1</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;      <span class="comment">! aQ is the coupling between adjacent interfaces [Z T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;      <span class="keywordflow">do</span> k=1,min(ke_tke,nz)</div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;        aq(k) = (0.5*(kappa(k)+kappa(k+1)) + kappa0) * idz(k)</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;      dq(1) = -tke(1)</div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;      <span class="keywordflow">if</span> (tke_noflux_top_bc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;        tke_src = kappa0*s2(1) + q0 * tke_decay(1) <span class="comment">! Uses that kappa(1) = 0</span></div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;        bqd1 = dz_int(1) * tke_decay(1)</div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;        bq = 1.0 / (bqd1 +  aq(1))</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;        tke(1) = bq * (dz_int(1)*tke_src)</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;        cq(2) = aq(1) * bq ; cqcomp = bqd1 * bq <span class="comment">! = 1 - cQ</span></div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;        tke(1) = q0 ; cq(2) = 0.0 ; cqcomp = 1.0</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;      <span class="keywordflow">do</span> k=2,ke_tke-1</div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;        dq(k) = -tke(k)</div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;        tke_src = (kappa(k) + kappa0)*s2(k) + q0*tke_decay(k)</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;        bqd1 = dz_int(k)*(tke_decay(k) + n2(k)*k_q(k)) + cqcomp*aq(k-1)</div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;        bq = 1.0 / (bqd1 + aq(k))</div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;        tke(k) = bq * (dz_int(k)*tke_src + aq(k-1)*tke(k-1))</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;        cq(k+1) = aq(k) * bq ; cqcomp = bqd1 * bq <span class="comment">! = 1 - cQ</span></div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;      <span class="keywordflow">if</span> ((ke_tke == nz+1) .and. .not.(tke_noflux_bottom_bc)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;        tke(nz+1) = tke_min</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;        dq(nz+1) = 0.0</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;        k = ke_tke</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;        tke_src = kappa0*s2(k) + q0*tke_decay(k) <span class="comment">! Uses that kappa(ke_tke) = 0</span></div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;        <span class="keywordflow">if</span> (k == nz+1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;          dq(k) = -tke(k)</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;          bq = 1.0 / (dz_int(k)*tke_decay(k) + cqcomp*aq(k-1))</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;          tke(k) = max(tke_min, bq * (dz_int(k)*tke_src + aq(k-1)*tke(k-1)))</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;          dq(k) = tke(k) + dq(k)</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;          bq = 1.0 / ((dz_int(k)*tke_decay(k) + cqcomp*aq(k-1)) + aq(k))</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;          cq(k+1) = aq(k) * bq</div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;          <span class="comment">! Account for all changes deeper in the water column.</span></div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;          dq(k) = -tke(k)</div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;          tke(k) = max((bq * (dz_int(k)*tke_src + aq(k-1)*tke(k-1)) + &amp;</div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;                        cq(k+1)*(tke(k+1) - e1(k+1)*tke(k))) / (1.0 - cq(k+1)*e1(k+1)), tke_min)</div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;          dq(k) = tke(k) + dq(k)</div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160; </div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;          <span class="comment">! Adjust TKE deeper in the water column in case ke_tke increases.</span></div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;          <span class="comment">! This might not be strictly necessary?</span></div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;          <span class="keywordflow">do</span> k=ke_tke+1,nz+1</div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;            dq(k) = e1(k)*dq(k-1)</div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;            tke(k) = max(tke(k) + dq(k), tke_min)</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;            <span class="keywordflow">if</span> (abs(dq(k)) &lt; roundoff*tke(k)) <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;<span class="keywordflow">          enddo</span></div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;          <span class="keywordflow">do</span> k2=k+1,nz</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;            <span class="keywordflow">if</span> (dq(k2) == 0.0) <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;            dq(k2) = 0.0</div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;<span class="keywordflow">          enddo</span></div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;      <span class="keywordflow">do</span> k=ke_tke-1,1,-1</div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;        tke(k) = max(tke(k) + cq(k+1)*tke(k+1), tke_min)</div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;        dq(k) = tke(k) + dq(k)</div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160; </div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;  <span class="comment">! ----------------------------------------------------</span></div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;  <span class="comment">! Calculate kappa, here defined at interfaces.</span></div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;  <span class="comment">! ----------------------------------------------------</span></div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160; </div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;      ke_kappa_prev = ke_kappa ; ks_kappa_prev = ks_kappa</div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160; </div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;      dk(1) = 0.0 <span class="comment">! kappa takes boundary values of 0.</span></div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;      ck(2) = 0.0 ; ckcomp = 1.0</div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;      <span class="keywordflow">if</span> (itt == 1) <span class="keywordflow">then</span> ; <span class="keywordflow">dO</span> k=2,nz</div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;        i_ld2(k) = (n2(k)*ilambda2 + f2) / tke(k) + i_l2_bdry(k)</div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;      <span class="keywordflow">do</span> k=2,nz</div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;        dk(k) = -kappa(k)</div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;        <span class="keywordflow">if</span> (itt&gt;1) &amp;</div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;          i_ld2(k) = (n2(k)*ilambda2 + f2) / tke(k) + i_l2_bdry(k)</div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;        bkd1 = dz_int(k)*i_ld2(k) + ckcomp*idz(k-1)</div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;        bk = 1.0 / (bkd1 + idz(k))</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160; </div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;        kappa(k) = bk * (idz(k-1)*kappa(k-1) + dz_int(k) * k_src(k))</div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;        ck(k+1) = idz(k) * bk ; ckcomp = bkd1 * bk <span class="comment">! = 1 - cK(K+1)</span></div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160; </div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;        <span class="comment">! Neglect values that are smaller than kappa_trunc.</span></div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;        <span class="keywordflow">if</span> (kappa(k) &lt; ckcomp*kappa_trunc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;          kappa(k) = 0.0</div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;          <span class="keywordflow">if</span> (k &gt; ke_src) <span class="keywordflow">then</span> ; ke_kappa = k-1 ; k_q(k) = 0.0 ; <span class="keywordflow">exit</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;        <span class="keywordflow">elseif</span> (kappa(k) &lt; 2.0*ckcomp*kappa_trunc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;          kappa(k) = 2.0 * (kappa(k) - ckcomp*kappa_trunc)</div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;      k_q(ke_kappa) = kappa(ke_kappa) / tke(ke_kappa)</div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;      dk(ke_kappa) = dk(ke_kappa) + kappa(ke_kappa)</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;      <span class="keywordflow">do</span> k=ke_kappa+2,ke_kappa_prev</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;        dk(k) = -kappa(k) ; kappa(k) = 0.0 ; k_q(k) = 0.0</div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;      <span class="keywordflow">do</span> k=ke_kappa-1,2,-1</div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;        kappa(k) = kappa(k) + ck(k+1)*kappa(k+1)</div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;        <span class="comment">! Neglect values that are smaller than kappa_trunc.</span></div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;        <span class="keywordflow">if</span> (kappa(k) &lt;= kappa_trunc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;          kappa(k) = 0.0</div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;          <span class="keywordflow">if</span> (k &lt; ks_src) <span class="keywordflow">then</span> ; ks_kappa = k+1 ; k_q(k) = 0.0 ; <span class="keywordflow">exit</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;        <span class="keywordflow">elseif</span> (kappa(k) &lt; 2.0*kappa_trunc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;          kappa(k) = 2.0 * (kappa(k) - kappa_trunc)</div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160; </div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;        dk(k) = dk(k) + kappa(k)</div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;        k_q(k) = kappa(k) / tke(k)</div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;      <span class="keywordflow">do</span> k=ks_kappa_prev,ks_kappa-2 ; kappa(k) = 0.0 ; k_q(k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160; </div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;    <span class="keywordflow">else</span> <span class="comment">! do_Newton is .true.</span></div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;<span class="comment">!   Once the solutions are close enough, use a Newton&#39;s method solver of the</span></div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;<span class="comment">!  whole system to accelerate convergence.</span></div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;      ks_kappa_prev = ks_kappa ; ke_kappa_prev = ke_kappa ; ke_kappa = nz</div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;      ks_kappa = 2</div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;      dk(1) = 0.0 ; ck(2) = 0.0 ; ckcomp = 1.0 ; dkdq(1) = 0.0</div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;      aq(1) = (0.5*(kappa(1)+kappa(2))+kappa0) * idz(1)</div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;      dqdz(1) = 0.5*(tke(1) - tke(2))*idz(1)</div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;      <span class="keywordflow">if</span> (tke_noflux_top_bc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;        tke_src = dz_int(1) * (kappa0*s2(1) - (tke(1) - q0)*tke_decay(1)) - &amp;</div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;                  aq(1) * (tke(1) - tke(2))</div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160; </div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;        bq = 1.0 / (aq(1) + dz_int(1)*tke_decay(1))</div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;        cq(2) = aq(1) * bq</div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;        cqcomp = (dz_int(1)*tke_decay(1)) * bq <span class="comment">! = 1 - cQ(2)</span></div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;        dqmdk(2) = -dqdz(1) * bq</div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;        dq(1) = bq * tke_src</div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;        dq(1) = 0.0 ; cq(2) = 0.0 ; cqcomp = 1.0 ; dqmdk(2) = 0.0</div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;      <span class="keywordflow">do</span> k=2,nz</div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;        i_q = 1.0 / tke(k)</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;        i_ld2(k) = (n2(k)*ilambda2 + f2) * i_q + i_l2_bdry(k)</div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160; </div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;        kap_src = dz_int(k) * (k_src(k) - i_ld2(k)*kappa(k)) + &amp;</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;                            idz(k-1)*(kappa(k-1)-kappa(k)) - idz(k)*(kappa(k)-kappa(k+1))</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160; </div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;        <span class="comment">! Ensure that the pivot is always positive, and that 0 &lt;= cK &lt;= 1.</span></div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;        <span class="comment">! Otherwise do not use Newton&#39;s method.</span></div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;        decay_term_k = -idz(k-1)*dqmdk(k)*dkdq(k-1) + dz_int(k)*i_ld2(k)</div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;        <span class="keywordflow">if</span> (decay_term_k &lt; 0.0) <span class="keywordflow">then</span> ; abort_newton = .true. ; <span class="keywordflow">exit</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;        bk = 1.0 / (idz(k) + idz(k-1)*ckcomp + decay_term_k)</div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160; </div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;        ck(k+1) = bk * idz(k)</div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;        ckcomp = bk * (idz(k-1)*ckcomp + decay_term_k) <span class="comment">! = 1-cK(K+1)</span></div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;        <span class="keywordflow">if</span> (cs%dKdQ_iteration_bug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;          dkdq(k) = bk * (idz(k-1)*dkdq(k-1)*cq(k) + &amp;</div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;                      us%m_to_Z*(n2(k)*ilambda2 + f2) * i_q**2 * kappa(k) )</div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;          dkdq(k) = bk * (idz(k-1)*dkdq(k-1)*cq(k) + &amp;</div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;                      dz_int(k)*(n2(k)*ilambda2 + f2) * i_q**2 * kappa(k) )</div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;        dk(k) = bk * (kap_src + idz(k-1)*dk(k-1) + idz(k-1)*dkdq(k-1)*dq(k-1))</div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160; </div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;        <span class="comment">! Truncate away negligibly small values of kappa.</span></div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;        <span class="keywordflow">if</span> (dk(k) &lt;= ckcomp*(kappa_trunc - kappa(k))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;          dk(k) = -ckcomp*kappa(k)</div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;<span class="comment">!         if (K &gt; ke_src) then ; ke_kappa = k-1 ; K_Q(K) = 0.0 ; exit ; endif</span></div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;        <span class="keywordflow">elseif</span> (dk(k) &lt; ckcomp*(2.0*kappa_trunc - kappa(k))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;          dk(k) = 2.0 * dk(k) - ckcomp*(2.0*kappa_trunc - kappa(k))</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160; </div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;        <span class="comment">! Solve for dQ(K)...</span></div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;        aq(k) = (0.5*(kappa(k)+kappa(k+1))+kappa0) * idz(k)</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;        dqdz(k) = 0.5*(tke(k) - tke(k+1))*idz(k)</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;        tke_src = dz_int(k) * (((kappa(k) + kappa0)*s2(k) - kappa(k)*n2(k)) - &amp;</div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;                                  (tke(k) - q0)*tke_decay(k)) - &amp;</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;                  (aq(k) * (tke(k) - tke(k+1)) - aq(k-1) * (tke(k-1) - tke(k)))</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;        v1 = aq(k-1) + dqdz(k-1)*dkdq(k-1)</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;        v2 = (v1*dqmdk(k) + dqdz(k-1)*ck(k)) + &amp;</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;             ((dqdz(k-1) - dqdz(k)) + dz_int(k)*(s2(k) - n2(k)))</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160; </div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;        <span class="comment">! Ensure that the pivot is always positive, and that 0 &lt;= cQ &lt;= 1.</span></div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;        <span class="comment">! Otherwise do not use Newton&#39;s method.</span></div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;        decay_term_q = dz_int(k)*tke_decay(k) - dqdz(k-1)*dkdq(k-1)*cq(k) - v2*dkdq(k)</div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;        <span class="keywordflow">if</span> (decay_term_q &lt; 0.0) <span class="keywordflow">then</span> ; abort_newton = .true. ; <span class="keywordflow">exit</span> ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;        bq = 1.0 / (aq(k) + (cqcomp*aq(k-1) + decay_term_q))</div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160; </div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;        cq(k+1) = aq(k) * bq</div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;        cqcomp = (cqcomp*aq(k-1) + decay_term_q) * bq</div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;        dqmdk(k+1) = (v2 * ck(k+1) - dqdz(k)) * bq</div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160; </div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;        <span class="comment">! Ensure that TKE+dQ will not drop below 0.5*TKE.</span></div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;        dq(k) = max(bq * ((v1 * dq(k-1) + dqdz(k-1)*dk(k-1)) + &amp;</div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;                          (v2 * dk(k) + tke_src)), cqcomp*(-0.5*tke(k)))</div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160; </div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;        <span class="comment">! Check whether the next layer will be affected by any nonzero kappas.</span></div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;        <span class="keywordflow">if</span> ((itt &gt; 1) .and. (k &gt; ke_src) .and. (dk(k) == 0.0) .and. &amp;</div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;            ((kappa(k) + kappa(k+1)) == 0.0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;        <span class="comment">! Could also do  .and. (bQ*abs(tke_src) &lt; roundoff*TKE(K)) then</span></div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;          ke_kappa = k-1 ; <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;      <span class="keywordflow">if</span> ((ke_kappa == nz) .and. (.not. abort_newton)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;        dk(nz+1) = 0.0 ; dkdq(nz+1) = 0.0</div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;        <span class="keywordflow">if</span> (tke_noflux_bottom_bc) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;          k = nz+1</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;          tke_src = dz_int(k) * (kappa0*s2(k) - (tke(k) - q0)*tke_decay(k)) + &amp;</div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;                    aq(k-1) * (tke(k-1) - tke(k))</div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160; </div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;          v1 = aq(k-1) + dqdz(k-1)*dkdq(k-1)</div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;          decay_term_q = max(0.0, dz_int(k)*tke_decay(k) - dqdz(k-1)*dkdq(k-1)*cq(k))</div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;          <span class="keywordflow">if</span> (decay_term_q &lt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;            abort_newton = .true.</div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;            bq = 1.0 / (aq(k) + (cqcomp*aq(k-1) + decay_term_q))</div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;          <span class="comment">! Ensure that TKE+dQ will not drop below 0.5*TKE.</span></div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;            dq(k) = max(bq * ((v1 * dq(k-1) + dqdz(k-1)*dk(k-1)) + tke_src), -0.5*tke(k))</div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;            tke(k) = max(tke(k) + dq(k), tke_min)</div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;          dq(nz+1) = 0.0</div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;      <span class="keywordflow">elseif</span> (.not. abort_newton) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;        <span class="comment">! Alter the first-guess determination of dQ(K).</span></div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;        dq(ke_kappa+1) = dq(ke_kappa+1) / (1.0 - cq(ke_kappa+2)*e1(ke_kappa+2))</div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;        tke(ke_kappa+1) = max(tke(ke_kappa+1) + dq(ke_kappa+1), tke_min)</div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;        <span class="keywordflow">do</span> k=ke_kappa+2,nz+1</div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;<span class="preprocessor"></span>          <span class="keywordflow">if</span> (k &lt; nz+1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;          <span class="comment">! Ignore this source?</span></div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;            aq(k) = (0.5*(kappa(k)+kappa(k+1))+kappa0) * idz(k)</div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;            tke_src_norm = (dz_int(k) * (kappa0*s2(k) - (tke(k)-q0)*tke_decay(k)) - &amp;</div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;                           (aq(k) * (tke(k) - tke(k+1)) - aq(k-1) * (tke(k-1) - tke(k))) ) / &amp;</div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;                           (aq(k) + (aq(k-1) + dz_int(k)*tke_decay(k)))</div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;<span class="preprocessor"></span>          dk(k) = 0.0</div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;        <span class="comment">! Ensure that TKE+dQ will not drop below 0.5*TKE.</span></div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;          dq(k) = max(e1(k)*dq(k-1),-0.5*tke(k))</div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;          tke(k) = max(tke(k) + dq(k), tke_min)</div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;          <span class="keywordflow">if</span> (abs(dq(k)) &lt; roundoff*tke(k)) <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">do</span> k2=k+1,ke_kappa_prev+1 ; dq(k2) = 0.0 ; dk(k2) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;        <span class="keywordflow">do</span> k=k2,nz+1 ; <span class="keywordflow">if</span> (dq(k) == 0.0) <span class="keywordflow">exit</span> ; dq(k) = 0.0 ; dk(k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;<span class="preprocessor"></span><span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;      <span class="keywordflow">if</span> (.not. abort_newton) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;        <span class="keywordflow">do</span> k=ke_kappa,2,-1</div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;          <span class="comment">! Ensure that TKE+dQ will not drop below 0.5*TKE.</span></div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;          dq(k) = max(dq(k) + (cq(k+1)*dq(k+1) + dqmdk(k+1) * dk(k+1)), -0.5*tke(k))</div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;          tke(k) = max(tke(k) + dq(k), tke_min)</div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;          dk(k) = dk(k) + (ck(k+1)*dk(k+1) + dkdq(k) * dq(k))</div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;          <span class="comment">! Truncate away negligibly small values of kappa.</span></div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;          <span class="keywordflow">if</span> (dk(k) &lt;= kappa_trunc - kappa(k)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;            dk(k) = -kappa(k)</div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;            kappa(k) = 0.0</div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;            <span class="keywordflow">if</span> ((k &lt; ks_src) .and. (k+1 &gt; ks_kappa)) ks_kappa = k+1</div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;          <span class="keywordflow">elseif</span> (dk(k) &lt; 2.0*kappa_trunc - kappa(k)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;            dk(k) =  2.0*dk(k) - (2.0*kappa_trunc - kappa(k))</div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;            kappa(k) = max(kappa(k) + dk(k), 0.0) <span class="comment">! The max is for paranoia.</span></div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;            <span class="keywordflow">if</span> (k&lt;=ks_kappa) ks_kappa = 2</div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;            kappa(k) = kappa(k) + dk(k)</div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;            <span class="keywordflow">if</span> (k&lt;=ks_kappa) ks_kappa = 2</div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;        dq(1) = max(dq(1) + cq(2)*dq(2) + dqmdk(2) * dk(2), tke_min - tke(1))</div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;        tke(1) = max(tke(1) + dq(1), tke_min)</div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;        dk(1) = 0.0</div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160; </div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;<span class="preprocessor"></span>      <span class="comment">! Check these solutions for consistency.</span></div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;      <span class="comment">!  The unit conversions here have not been carefully tested.</span></div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;      <span class="keywordflow">do</span> k=2,nz</div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;        <span class="comment">! In these equations, K_err_lin and Q_err_lin should be at round-off levels</span></div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;        <span class="comment">! compared with the dominant terms, perhaps, dz_Int*I_Ld2*kappa and</span></div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;        <span class="comment">! dz_Int*TKE_decay*TKE.  The exception is where, either 1) the decay term has been</span></div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;        <span class="comment">! been increased to ensure a positive pivot, or 2) negative TKEs have been</span></div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;        <span class="comment">! truncated, or 3) small or negative kappas have been rounded toward 0.</span></div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;        i_q = 1.0 / tke(k)</div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;        i_ld2_debug(k) = (n2(k)*ilambda2 + f2) * i_q + i_l2_bdry(k)</div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160; </div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;        kap_src = dz_int(k) * (k_src(k) - i_ld2(k)*kappa_prev(k)) + &amp;</div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;                            (idz(k-1)*(kappa_prev(k-1)-kappa_prev(k)) - &amp;</div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;                             idz(k)*(kappa_prev(k)-kappa_prev(k+1)))</div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;        k_err_lin = -idz(k-1)*(dk(k-1)-dk(k)) + idz(k)*(dk(k)-dk(k+1)) + &amp;</div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;                     dz_int(k)*i_ld2_debug(k)*dk(k) - kap_src - &amp;</div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;                     dz_int(k)*(n2(k)*ilambda2 + f2)*i_q**2*kappa_prev(k) * dq(k)</div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160; </div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;        tke_src = dz_int(k) * ((kappa_prev(k) + kappa0)*s2(k) - &amp;</div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;                     kappa_prev(k)*n2(k) - (tke_prev(k) - q0)*tke_decay(k)) - &amp;</div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;                  (aq(k) * (tke_prev(k) - tke_prev(k+1)) -  aq(k-1) * (tke_prev(k-1) - tke_prev(k)))</div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;        q_err_lin = tke_src + (aq(k-1) * (dq(k-1)-dq(k)) - aq(k) * (dq(k)-dq(k+1))) - &amp;</div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;                    0.5*(tke_prev(k)-tke_prev(k+1))*idz(k)  * (dk(k) + dk(k+1)) - &amp;</div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;                    0.5*(tke_prev(k)-tke_prev(k-1))*idz(k-1)* (dk(k-1) + dk(k)) + &amp;</div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;                    dz_int(k) * (dk(k) * (s2(k) - n2(k)) - dq(k)*tke_decay(k))</div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;<span class="preprocessor"></span><span class="keywordflow">    endif</span>  <span class="comment">! End of the Newton&#39;s method solver.</span></div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160; </div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;    <span class="comment">! Test kappa for convergence...</span></div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;    <span class="keywordflow">if</span> ((tol_err &lt; newton_err) .and. (.not.abort_newton)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;      <span class="comment">!  A lower tolerance is used to switch to Newton&#39;s method than to switch back.</span></div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;      newton_test = newton_err ; <span class="keywordflow">if</span> (do_newton) newton_test = 2.0*newton_err</div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;      was_newton = do_newton</div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;      within_tolerance = .true. ; do_newton = .true.</div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;      <span class="keywordflow">do</span> k=min(ks_kappa,ks_kappa_prev),max(ke_kappa,ke_kappa_prev)</div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;        kappa_mean = kappa0 + (kappa(k) - 0.5*dk(k))</div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;        <span class="keywordflow">if</span> (abs(dk(k)) &gt; newton_test * kappa_mean) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;          <span class="keywordflow">if</span> (do_newton) abort_newton = .true.</div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;          within_tolerance = .false. ; do_newton = .false. ; <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;        <span class="keywordflow">elseif</span> (abs(dk(k)) &gt; tol_err * kappa_mean) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;          within_tolerance = .false. ; <span class="keywordflow">if</span> (.not.do_newton) <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;        <span class="keywordflow">if</span> (abs(dq(k)) &gt; newton_test*(tke(k) - 0.5*dq(k))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;          <span class="keywordflow">if</span> (do_newton) abort_newton = .true.</div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;          do_newton = .false. ; <span class="keywordflow">if</span> (.not.within_tolerance) <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160; </div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;    <span class="keywordflow">else</span>  <span class="comment">! Newton&#39;s method will not be used again, so no need to check.</span></div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;      within_tolerance = .true.</div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;      <span class="keywordflow">do</span> k=min(ks_kappa,ks_kappa_prev),max(ke_kappa,ke_kappa_prev)</div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;        <span class="keywordflow">if</span> (abs(dk(k)) &gt; tol_err * (kappa0 + (kappa(k) - 0.5*dk(k)))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;          within_tolerance = .false. ;  <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160; </div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;    <span class="keywordflow">if</span> (abort_newton) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;      do_newton = .false. ; abort_newton = .false.</div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;      <span class="comment">! We went to Newton too quickly last time, so restrict the tolerance.</span></div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;      newton_err = 0.5*newton_err</div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;      ke_kappa_prev = nz</div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;      <span class="keywordflow">do</span> k=2,nz ; k_q(k) = kappa(k) / max(tke(k), tke_min) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160; </div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span> (itt &lt;= max_debug_itt) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;        kprev_it1(k,itt) = kappa_prev(k)</div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;        kappa_it1(k,itt) = kappa(k) ; tke_it1(k,itt) = tke(k)</div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;        dkappa_it1(k,itt) = kappa(k) - kappa_prev(k)</div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;        dkappa_norm_it1(k,itt) = (kappa(k) - kappa_prev(k)) / &amp;</div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;            (kappa0 + 0.5*(kappa(k) + kappa_prev(k)))</div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;        k_q_it1(k,itt) = kappa(k) / max(tke(k),tke_min)</div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;        d_dkappa_it1(k,itt) = 0.0</div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;        <span class="keywordflow">if</span> (itt &gt; 1) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (abs(dkappa_it1(k,itt-1)) &gt; 1e-20*us%m2_s_to_Z2_T) &amp;</div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;            d_dkappa_it1(k,itt) = dkappa_it1(k,itt) / dkappa_it1(k,itt-1)</div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;    <span class="keywordflow">if</span> (within_tolerance) <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160; </div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160; </div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">do</span> it2=itt+1,max_debug_itt ; <span class="keywordflow">do</span> k=1,nz+1</div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;    kprev_it1(k,it2) = 0.0 ; kappa_it1(k,it2) = 0.0 ; tke_it1(k,it2) = 0.0</div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;    dkappa_it1(k,it2) = 0.0 ; k_q_it1(k,it2) = 0.0 ; d_dkappa_it1(k,it2) = 0.0</div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;  <span class="keywordflow">if</span> (do_newton) <span class="keywordflow">then</span>  <span class="comment">! K_Q needs to be calculated.</span></div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;    <span class="keywordflow">do</span> k=1,ks_kappa-1 ;  k_q(k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;    <span class="keywordflow">do</span> k=ks_kappa,ke_kappa ; k_q(k) = kappa(k) / tke(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;    <span class="keywordflow">do</span> k=ke_kappa+1,nz+1 ; k_q(k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160; </div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(local_src)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;    local_src(1) = 0.0 ; local_src(nz+1) = 0.0</div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;    <span class="keywordflow">do</span> k=2,nz</div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;      diffusive_src = idz(k-1)*(kappa(k-1)-kappa(k)) + idz(k)*(kappa(k+1)-kappa(k))</div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;      chg_by_k0 = kappa0 * ((idz(k-1)+idz(k)) / dz_int(k) + i_ld2(k))</div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;      <span class="keywordflow">if</span> (diffusive_src &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;        local_src(k) = k_src(k) + chg_by_k0</div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;        local_src(k) = (k_src(k) + chg_by_k0) + diffusive_src / dz_int(k)</div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(kappa_src)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;    kappa_src(1) = 0.0 ; kappa_src(nz+1) = 0.0</div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;    <span class="keywordflow">do</span> k=2,nz</div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;      kappa_src(k) = k_src(k)</div>
<div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__kappa__shear_8F90_source.html#l00666">kappa_shear_column()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__kappa__shear_a351d44e4fe5cfb5852d019a0c1e66100_icgraph.svg" width="100%" height="388"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="ad4d87b0928aea195213e682b493eb555"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad4d87b0928aea195213e682b493eb555">&#9670;&nbsp;</a></span>kappa_shear_at_vertex()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">logical function, public mom_kappa_shear::kappa_shear_at_vertex </td>
          <td>(</td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function indicates to other modules whether the Jackson et al shear mixing parameterization will be used without needing to duplicate the log entry. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>A structure to parse for run-time parameters </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__kappa__shear_8F90_source.html#l02120">2120</a> of file <a class="el" href="MOM__kappa__shear_8F90_source.html">MOM_kappa_shear.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;  <span class="keywordtype">type</span>(param_file_type), <span class="keywordtype">intent(in)</span> :: param_file<span class="comment"> !&lt; A structure to parse for run-time parameters</span></div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;<span class="comment">! Reads the parameter &quot;USE_JACKSON_PARAM&quot; and returns state.</span></div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_kappa_shear&quot;</span>  <span class="comment">! This module&#39;s name.</span></div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160; </div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;  <span class="keywordtype">logical</span> :: do_kappa_shear</div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160; </div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_JACKSON_PARAM&quot;</span>, do_kappa_shear, &amp;</div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;                 default=.false., do_not_log=.true.)</div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;  kappa_shear_at_vertex = .false.</div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;  <span class="keywordflow">if</span> (do_kappa_shear) &amp;</div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;VERTEX_SHEAR&quot;</span>, kappa_shear_at_vertex, &amp;</div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;                 <span class="stringliteral">&quot;If true, do the calculations of the shear-driven mixing &quot;</span>//&amp;</div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;                 <span class="stringliteral">&quot;at the cell vertices (i.e., the vorticity points).&quot;</span>, &amp;</div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;                 default=.false., do_not_log=.true.)</div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160; </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01878">mom_set_diffusivity::set_diffusivity_init()</a>, <a class="el" href="MOM__set__viscosity_8F90_source.html#l01782">mom_set_visc::set_visc_init()</a>, and <a class="el" href="MOM__set__viscosity_8F90_source.html#l01696">mom_set_visc::set_visc_register_restarts()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__kappa__shear_ad4d87b0928aea195213e682b493eb555_icgraph.svg" width="100%" height="427"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a26cc5bb15545f04cfaf07e53410e09ec"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a26cc5bb15545f04cfaf07e53410e09ec">&#9670;&nbsp;</a></span>kappa_shear_column()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_kappa_shear::kappa_shear_column </td>
          <td>(</td>
          <td class="paramtype">real, dimension( gv %ke+1), intent(inout)&#160;</td>
          <td class="paramname"><em>kappa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( gv %ke+1), intent(out)&#160;</td>
          <td class="paramname"><em>tke</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nzc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>f2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>surface_pres</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>dz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>u0xdz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>v0xdz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>T0xdz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>S0xdz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( gv %ke+1), intent(out)&#160;</td>
          <td class="paramname"><em>kappa_avg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( gv %ke+1), intent(out)&#160;</td>
          <td class="paramname"><em>tke_avg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__kappa__shear_1_1kappa__shear__cs.html">kappa_shear_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( gv %ke+1), intent(out), optional&#160;</td>
          <td class="paramname"><em>I_Ld2_1d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( gv %ke+1), intent(out), optional&#160;</td>
          <td class="paramname"><em>dz_Int_1d</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine calculates shear-driven diffusivity and TKE in a single column. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">kappa</td><td>The time-weighted average of kappa [Z2 T-1 ~&gt; m2 s-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">tke</td><td>The Turbulent Kinetic Energy per unit mass at </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nzc</td><td>The number of active layers in the column. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">f2</td><td>The square of the Coriolis parameter [T-2 ~&gt; s-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">surface_pres</td><td>The surface pressure [Pa]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dz</td><td>The layer thickness [Z ~&gt; m]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u0xdz</td><td>The initial zonal velocity times dz [Z L T-1 ~&gt; m2 s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v0xdz</td><td>The initial meridional velocity times dz [Z L T-1 ~&gt; m2 s-1]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">t0xdz</td><td>The initial temperature times dz [degC Z ~&gt; degC m]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">s0xdz</td><td>The initial salinity times dz [ppt Z ~&gt; ppt m]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">kappa_avg</td><td>The time-weighted average of kappa [Z2 T-1 ~&gt; m2 s-1]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">tke_avg</td><td>The time-weighted average of TKE [Z2 T-2 ~&gt; m2 s-2]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment [T ~&gt; s]. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>A structure containing pointers to any available thermodynamic fields. Absent fields have NULL ptrs. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to kappa_shear_init. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">i_ld2_1d</td><td>The inverse of the squared mixing length [Z-2 ~&gt; m-2]. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dz_int_1d</td><td>The extent of a finite-volume space surrounding an interface, </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__kappa__shear_8F90_source.html#l00666">666</a> of file <a class="el" href="MOM__kappa__shear_8F90_source.html">MOM_kappa_shear.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment"> !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>    :: US<span class="comment"> !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                     <span class="keywordtype">intent(inout)</span> :: kappa<span class="comment"> !&lt; The time-weighted average of kappa [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                     <span class="keywordtype">intent(out)</span>   :: tke<span class="comment">  !&lt; The Turbulent Kinetic Energy per unit mass at</span></div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="comment">                                           !! an interface [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;  <span class="keywordtype">integer</span>,           <span class="keywordtype">intent(in)</span>    :: nzc<span class="comment">  !&lt; The number of active layers in the column.</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="keywordtype">  real</span>,              <span class="keywordtype">intent(in)</span>    :: f2<span class="comment">   !&lt; The square of the Coriolis parameter [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="keywordtype">  real</span>,              <span class="keywordtype">intent(in)</span>    :: surface_pres<span class="comment">  !&lt; The surface pressure [Pa].</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;                     <span class="keywordtype">intent(in)</span>    :: dz<span class="comment">   !&lt; The layer thickness [Z ~&gt; m].</span></div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;                     <span class="keywordtype">intent(in)</span>    :: u0xdz<span class="comment"> !&lt; The initial zonal velocity times dz [Z L T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                     <span class="keywordtype">intent(in)</span>    :: v0xdz<span class="comment"> !&lt; The initial meridional velocity times dz [Z L T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;                     <span class="keywordtype">intent(in)</span>    :: T0xdz<span class="comment"> !&lt; The initial temperature times dz [degC Z ~&gt; degC m].</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>, &amp;</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;                     <span class="keywordtype">intent(in)</span>    :: S0xdz<span class="comment"> !&lt; The initial salinity times dz [ppt Z ~&gt; ppt m].</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;                     <span class="keywordtype">intent(out)</span>   :: kappa_avg<span class="comment"> !&lt; The time-weighted average of kappa [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;                     <span class="keywordtype">intent(out)</span>   :: tke_avg<span class="comment">  !&lt; The time-weighted average of TKE [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="keywordtype">  real</span>,                    <span class="keywordtype">intent(in)</span>    :: dt<span class="comment"> !&lt; Time increment [T ~&gt; s].</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),   <span class="keywordtype">intent(in)</span>    :: tv<span class="comment"> !&lt; A structure containing pointers to any</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;<span class="comment">                                               !! available thermodynamic fields. Absent fields</span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="comment">                                               !! have NULL ptrs.</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;  <span class="keywordtype">type</span>(Kappa_shear_CS),    <span class="keywordtype">pointer</span>       :: CS<span class="comment"> !&lt; The control structure returned by a previous</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;<span class="comment">                                               !! call to kappa_shear_init.</span></div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;<span class="keywordtype">  real</span>,  <span class="keywordtype">dimension(SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;           <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span>   :: I_Ld2_1d<span class="comment"> !&lt; The inverse of the squared mixing length [Z-2 ~&gt; m-2].</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;<span class="keywordtype">  real</span>,  <span class="keywordtype">dimension(SZK_(GV)+1)</span>, &amp;</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;           <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span>   :: dz_Int_1d<span class="comment"> !&lt; The extent of a finite-volume space surrounding an interface,</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;<span class="comment">                                               !! as used in calculating kappa and TKE [Z ~&gt; m].</span></div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160; </div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nzc)</span> :: &amp;</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    u, &amp;        <span class="comment">! The zonal velocity after a timestep of mixing [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    v, &amp;        <span class="comment">! The meridional velocity after a timestep of mixing [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    Idz, &amp;      <span class="comment">! The inverse of the distance between TKE points [Z-1 ~&gt; m-1].</span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    T, &amp;        <span class="comment">! The potential temperature after a timestep of mixing [degC].</span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    Sal, &amp;      <span class="comment">! The salinity after a timestep of mixing [ppt].</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    u_test, v_test, &amp; <span class="comment">! Temporary velocities [L T-1 ~&gt; m s-1].</span></div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    T_test, S_test <span class="comment">! Temporary temperatures [degC] and salinities [ppt].</span></div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160; </div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(nzc+1)</span> :: &amp;</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    N2, &amp;       <span class="comment">! The squared buoyancy frequency at an interface [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    dz_Int, &amp;   <span class="comment">! The extent of a finite-volume space surrounding an interface,</span></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                <span class="comment">! as used in calculating kappa and TKE [Z ~&gt; m].</span></div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    i_dz_int, &amp; <span class="comment">! The inverse of the distance between velocity &amp; density points</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;                <span class="comment">! above and below an interface [Z-1 ~&gt; m-1].  This is used to</span></div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;                <span class="comment">! calculate N2, shear, and fluxes, and it might differ from</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;                <span class="comment">! 1/dz_Int, as they have different uses.</span></div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    s2, &amp;       <span class="comment">! The squared shear at an interface [T-2 ~&gt; s-2].</span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    a1, &amp;       <span class="comment">! a1 is the coupling between adjacent interfaces in the TKE,</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;                <span class="comment">! velocity, and density equations [Z s-1 ~&gt; m s-1] or [Z ~&gt; m]</span></div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    c1, &amp;       <span class="comment">! c1 is used in the tridiagonal (and similar) solvers.</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    k_src, &amp;    <span class="comment">! The shear-dependent source term in the kappa equation [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    kappa_src, &amp; <span class="comment">! The shear-dependent source term in the kappa equation [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    kappa_out, &amp; <span class="comment">! The kappa that results from the kappa equation [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    kappa_mid, &amp; <span class="comment">! The average of the initial and predictor estimates of kappa [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    tke_pred, &amp; <span class="comment">! The value of TKE from a predictor step [Z2 T-2 ~&gt; m2 s-2].</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    kappa_pred, &amp; <span class="comment">! The value of kappa from a predictor step [Z2 T-1 ~&gt; m2 s-1].</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    pressure, &amp; <span class="comment">! The pressure at an interface [Pa].</span></div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    t_int, &amp;    <span class="comment">! The temperature interpolated to an interface [degC].</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    sal_int, &amp;  <span class="comment">! The salinity interpolated to an interface [ppt].</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;    dbuoy_dt, &amp; <span class="comment">! The partial derivatives of buoyancy with changes in temperature</span></div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    dbuoy_ds, &amp; <span class="comment">! and salinity, [Z T-2 degC-1 ~&gt; m s-2 degC-1] and [Z T-2 ppt-1 ~&gt; m s-2 ppt-1].</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    i_l2_bdry, &amp;   <span class="comment">! The inverse of the square of twice the harmonic mean</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;                   <span class="comment">! distance to the top and bottom boundaries [Z-2 ~&gt; m-2].</span></div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    k_q, &amp;         <span class="comment">! Diffusivity divided by TKE [Z2 m-2 s2 T-1 ~&gt; s].</span></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;    k_q_tmp, &amp;     <span class="comment">! A temporary copy of diffusivity divided by TKE [Z2 m-2 s2 T-1 ~&gt; s].</span></div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    local_src_avg, &amp; <span class="comment">! The time-integral of the local source [nondim].</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    tol_min, &amp; <span class="comment">! Minimum tolerated ksrc for the corrector step [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    tol_max, &amp; <span class="comment">! Maximum tolerated ksrc for the corrector step [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    tol_chg, &amp; <span class="comment">! The tolerated kappa change integrated over a timestep [nondim].</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    dist_from_top, &amp;  <span class="comment">! The distance from the top surface [Z ~&gt; m].</span></div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;    local_src     <span class="comment">! The sum of all sources of kappa, including kappa_src and</span></div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;                  <span class="comment">! sources from the elliptic term [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160; </div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="keywordtype">  real</span> :: dist_from_bot <span class="comment">! The distance from the bottom surface [Z ~&gt; m].</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;<span class="keywordtype">  real</span> :: b1            <span class="comment">! The inverse of the pivot in the tridiagonal equations.</span></div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="keywordtype">  real</span> :: bd1           <span class="comment">! A term in the denominator of b1.</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;<span class="keywordtype">  real</span> :: d1            <span class="comment">! 1 - c1 in the tridiagonal equations.</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="keywordtype">  real</span> :: gR0           <span class="comment">! A conversion factor from Z to Pa equal to Rho_0 times g</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;                        <span class="comment">! [Pa Z-1 = kg m-1 s-2 Z-1 ~&gt; kg m-2 s-2].</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="keywordtype">  real</span> :: g_R0          <span class="comment">! g_R0 is a rescaled version of g/Rho [Z R-1 T-2 ~&gt; m4 kg-1 s-2].</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="keywordtype">  real</span> :: Norm          <span class="comment">! A factor that normalizes two weights to 1 [Z-2 ~&gt; m-2].</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="keywordtype">  real</span> :: tol_dksrc     <span class="comment">! Tolerance for the change in the kappa source within an iteration</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                        <span class="comment">! relative to the local source [nondim].</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;<span class="keywordtype">  real</span> :: tol2          <span class="comment">! The tolerance for the change in the kappa source within an iteration</span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;                        <span class="comment">! relative to the average local source over previous iterations [nondim].</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;<span class="keywordtype">  real</span> :: tol_dksrc_low <span class="comment">! The tolerance for the fractional decrease in ksrc</span></div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                        <span class="comment">! within an iteration [nondim].  0 &lt; tol_dksrc_low &lt; 1.</span></div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;<span class="keywordtype">  real</span> :: Ri_crit       <span class="comment">!   The critical shear Richardson number for shear-</span></div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;                        <span class="comment">! driven mixing [nondim]. The theoretical value is 0.25.</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;<span class="keywordtype">  real</span> :: dt_rem        <span class="comment">!   The remaining time to advance the solution [T ~&gt; s].</span></div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;<span class="keywordtype">  real</span> :: dt_now        <span class="comment">!   The time step used in the current iteration [T ~&gt; s].</span></div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;<span class="keywordtype">  real</span> :: dt_wt         <span class="comment">!   The fractional weight of the current iteration [nondim].</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;<span class="keywordtype">  real</span> :: dt_test       <span class="comment">!   A time-step that is being tested for whether it</span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;                        <span class="comment">! gives acceptably small changes in k_src [T ~&gt; s].</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;<span class="keywordtype">  real</span> :: Idtt          <span class="comment">!   Idtt = 1 / dt_test [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;<span class="keywordtype">  real</span> :: dt_inc        <span class="comment">!   An increment to dt_test that is being tested [T ~&gt; s].</span></div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160; </div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;<span class="keywordtype">  real</span> :: k0dt          <span class="comment">! The background diffusivity times the timestep [Z2 ~&gt; m2].</span></div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;  <span class="keywordtype">logical</span> :: valid_dt   <span class="comment">! If true, all levels so far exhibit acceptably small changes in k_src.</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;  <span class="keywordtype">logical</span> :: use_temperature  <span class="comment">!  If true, temperature and salinity have been</span></div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;                        <span class="comment">! allocated and are being used as state variables.</span></div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;  <span class="keywordtype">integer</span> :: ks_kappa, ke_kappa  <span class="comment">! The k-range with nonzero kappas.</span></div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;  <span class="keywordtype">integer</span> :: dt_halvings   <span class="comment">! The number of times that the time-step is halved</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;                           <span class="comment">! in seeking an acceptable timestep.  If none is</span></div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;                           <span class="comment">! found, dt_rem*0.5^dt_halvings is used.</span></div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;  <span class="keywordtype">integer</span> :: dt_refinements <span class="comment">! The number of 2-fold refinements that will be used</span></div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;                           <span class="comment">! to estimate the maximum permitted time step.  I.e.,</span></div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;                           <span class="comment">! the resolution is 1/2^dt_refinements.</span></div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;  <span class="keywordtype">integer</span> :: k, itt, itt_dt</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">integer</span> :: max_debug_itt ; <span class="keywordtype">parameter</span>(max_debug_itt=20)</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;<span class="keywordtype">  real</span> :: wt(SZK_(GV)+1), wt_tot, I_wt_tot, wt_itt</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: &amp;</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    Ri_k, tke_prev, dtke, dkappa, dtke_norm, &amp;</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    N2_debug, &amp; <span class="comment">! A version of N2 for debugging [T-2 ~&gt; s-2]</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    ksrc_av     <span class="comment">! The average through the iterations of k_src [T-1 ~&gt; s-1].</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1,0:max_debug_itt)</span> :: &amp;</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    tke_it1, N2_it1, Sh2_it1, ksrc_it1, kappa_it1, kprev_it1</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV)+1,1:max_debug_itt)</span> :: &amp;</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    dkappa_it1, wt_it1, K_Q_it1, d_dkappa_it1, dkappa_norm</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(SZK_(GV),0:max_debug_itt)</span> :: &amp;</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    u_it1, v_it1, rho_it1, T_it1, S_it1</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(0:max_debug_itt)</span> :: &amp;</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    dk_wt_it1, dkpos_wt_it1, dkneg_wt_it1, k_mag</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;<span class="keywordtype">  real</span>, <span class="keywordtype">dimension(max_debug_itt)</span> ::  dt_it1</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;  ri_crit = cs%Rino_crit</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;  gr0 = gv%z_to_H*gv%H_to_Pa</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;  g_r0 = (us%L_to_Z**2 * gv%g_Earth) / (gv%Rho0)</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;  k0dt = dt*cs%kappa_0</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;  <span class="comment">!### These 3 tolerances are hard-coded and fixed for now.  Perhaps these could be made dynamic later?</span></div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;  <span class="comment">! tol_dksrc = 0.5*tol_ksrc_chg ; tol_dksrc_low = 1.0 - 1.0/tol_ksrc_chg ?</span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;  tol_dksrc = 10.0 ; tol_dksrc_low = 0.95 ; tol2 = 2.0*cs%kappa_tol_err</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;  dt_refinements = 5 <span class="comment">! Selected so that 1/2^dt_refinements &lt; 1-tol_dksrc_low</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;  use_temperature = .false. ; <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tv%T)) use_temperature = .true.</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160; </div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160; </div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;  <span class="comment">! Set up Idz as the inverse of layer thicknesses.</span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;  <span class="keywordflow">do</span> k=1,nzc ; idz(k) = 1.0 / dz(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;  <span class="comment">!   Set up I_dz_int as the inverse of the distance between</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;  <span class="comment">! adjacent layer centers.</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;  i_dz_int(1) = 2.0 / dz(1)</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;  dist_from_top(1) = 0.0</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;  <span class="keywordflow">do</span> k=2,nzc</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    i_dz_int(k) = 2.0 / (dz(k-1) + dz(k))</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    dist_from_top(k) = dist_from_top(k-1) + dz(k-1)</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;  i_dz_int(nzc+1) = 2.0 / dz(nzc)</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160; </div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;  <span class="comment">!   Determine the velocities and thicknesses after eliminating massless</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;  <span class="comment">! layers and applying a time-step of background diffusion.</span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;  <span class="keywordflow">if</span> (nzc &gt; 1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    a1(2) = k0dt*i_dz_int(2)</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    b1 = 1.0 / (dz(1) + a1(2))</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    u(1) = b1 * u0xdz(1) ; v(1) = b1 * v0xdz(1)</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    t(1) = b1 * t0xdz(1) ; sal(1) = b1 * s0xdz(1)</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    c1(2) = a1(2) * b1 ; d1 = dz(1) * b1 <span class="comment">! = 1 - c1</span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <span class="keywordflow">do</span> k=2,nzc-1</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;      bd1 = dz(k) + d1*a1(k)</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;      a1(k+1) = k0dt*i_dz_int(k+1)</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;      b1 = 1.0 / (bd1 + a1(k+1))</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;      u(k) = b1 * (u0xdz(k) + a1(k)*u(k-1))</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;      v(k) = b1 * (v0xdz(k) + a1(k)*v(k-1))</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;      t(k) = b1 * (t0xdz(k) + a1(k)*t(k-1))</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;      sal(k) = b1 * (s0xdz(k) + a1(k)*sal(k-1))</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;      c1(k+1) = a1(k+1) * b1 ; d1 = bd1 * b1 <span class="comment">! d1 = 1 - c1</span></div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    <span class="comment">! rho or T and S have insulating boundary conditions, u &amp; v use no-slip</span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="comment">! bottom boundary conditions (if kappa0 &gt; 0).</span></div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <span class="comment">! For no-slip bottom boundary conditions</span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    b1 = 1.0 / ((dz(nzc) + d1*a1(nzc)) + k0dt*i_dz_int(nzc+1))</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    u(nzc) = b1 * (u0xdz(nzc) + a1(nzc)*u(nzc-1))</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    v(nzc) = b1 * (v0xdz(nzc) + a1(nzc)*v(nzc-1))</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    <span class="comment">! For insulating boundary conditions</span></div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    b1 = 1.0 / (dz(nzc) + d1*a1(nzc))</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    t(nzc) = b1 * (t0xdz(nzc) + a1(nzc)*t(nzc-1))</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;    sal(nzc) = b1 * (s0xdz(nzc) + a1(nzc)*sal(nzc-1))</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    <span class="keywordflow">do</span> k=nzc-1,1,-1</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;      u(k) = u(k) + c1(k+1)*u(k+1) ; v(k) = v(k) + c1(k+1)*v(k+1)</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;      t(k) = t(k) + c1(k+1)*t(k+1) ; sal(k) = sal(k) + c1(k+1)*sal(k+1)</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;    <span class="comment">! This is correct, but probably unnecessary.</span></div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;    b1 = 1.0 / (dz(1) + k0dt*i_dz_int(2))</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    u(1) = b1 * u0xdz(1) ; v(1) = b1 * v0xdz(1)</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    b1 = 1.0 / dz(1)</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    t(1) = b1 * t0xdz(1) ; sal(1) = b1 * s0xdz(1)</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160; </div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;  <span class="comment">! This uses half the harmonic mean of thicknesses to provide two estimates</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;  <span class="comment">! of the boundary between cells, and the inverse of the harmonic mean to</span></div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;  <span class="comment">! weight the two estimates.  The net effect is that interfaces around thin</span></div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;  <span class="comment">! layers have thin cells, and the total thickness adds up properly.</span></div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;  <span class="comment">! The top- and bottom- interfaces have zero thickness, consistent with</span></div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;  <span class="comment">! adding additional zero thickness layers.</span></div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;  dz_int(1) = 0.0 ; dz_int(2) = dz(1)</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;  <span class="keywordflow">do</span> k=2,nzc-1</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;    norm = 1.0 / (dz(k)*(dz(k-1)+dz(k+1)) + 2.0*dz(k-1)*dz(k+1))</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    dz_int(k) = dz_int(k) + dz(k) * ( ((dz(k)+dz(k+1)) * dz(k-1)) * norm)</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    dz_int(k+1) = dz(k) * ( ((dz(k-1)+dz(k)) * dz(k+1)) * norm)</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;  dz_int(nzc) = dz_int(nzc) + dz(nzc) ; dz_int(nzc+1) = 0.0</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160; </div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;  dist_from_bot = 0.0</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;  <span class="keywordflow">do</span> k=nzc,2,-1</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    dist_from_bot = dist_from_bot + dz(k)</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    i_l2_bdry(k) = (dist_from_top(k) + dist_from_bot)**2 / &amp;</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;                   (dist_from_top(k) * dist_from_bot)**2</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160; </div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;  <span class="comment">! Calculate thermodynamic coefficients and an initial estimate of N2.</span></div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;  <span class="keywordflow">if</span> (use_temperature) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    pressure(1) = surface_pres</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    <span class="keywordflow">do</span> k=2,nzc</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;      pressure(k) = pressure(k-1) + gr0*dz(k-1)</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;      t_int(k) = 0.5*(t(k-1) + t(k))</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;      sal_int(k) = 0.5*(sal(k-1) + sal(k))</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    <span class="keyword">call </span>calculate_density_derivs(t_int, sal_int, pressure, dbuoy_dt, &amp;</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;                                  dbuoy_ds, 2, nzc-1, tv%eqn_of_state, scale=-g_r0*us%kg_m3_to_R)</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    <span class="keywordflow">do</span> k=1,nzc+1 ; dbuoy_dt(k) = -g_r0 ; dbuoy_ds(k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160; </div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;<span class="preprocessor"></span>  n2_debug(1) = 0.0 ; n2_debug(nzc+1) = 0.0</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;  <span class="keywordflow">do</span> k=2,nzc</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;    n2_debug(k) = max((dbuoy_dt(k) * (t0xdz(k-1)*idz(k-1) - t0xdz(k)*idz(k)) + &amp;</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;                       dbuoy_ds(k) * (s0xdz(k-1)*idz(k-1) - s0xdz(k)*idz(k))) * &amp;</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                       i_dz_int(k), 0.0)</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;  <span class="keywordflow">do</span> k=1,nzc</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    u_it1(k,0) = u0xdz(k)*idz(k) ; v_it1(k,0) = v0xdz(k)*idz(k)</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    t_it1(k,0) = t0xdz(k)*idz(k) ; s_it1(k,0) = s0xdz(k)*idz(k)</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;  <span class="keywordflow">do</span> k=1,nzc+1</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    kprev_it1(k,0) = kappa(k) ; kappa_it1(k,0) = kappa(k)</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;    tke_it1(k,0) = 0.0</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;    n2_it1(k,0) = n2_debug(k) ; sh2_it1(k,0) = s2(k) ; ksrc_it1(k,0) = k_src(k)</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;  <span class="keywordflow">do</span> k=nzc+1,gv%ke</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;    u_it1(k,0) = 0.0 ; v_it1(k,0) = 0.0</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    t_it1(k,0) = 0.0 ; s_it1(k,0) = 0.0</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;    kprev_it1(k+1,0) = 0.0 ; kappa_it1(k+1,0) = 0.0 ; tke_it1(k+1,0) = 0.0</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;    n2_it1(k+1,0) = 0.0 ; sh2_it1(k+1,0) = 0.0 ; ksrc_it1(k+1,0) = 0.0</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;  <span class="keywordflow">do</span> itt=1,max_debug_itt</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    dt_it1(itt) = 0.0</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    <span class="keywordflow">do</span> k=1,gv%ke</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;      u_it1(k,itt) = 0.0 ; v_it1(k,itt) = 0.0</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;      t_it1(k,itt) = 0.0 ; s_it1(k,itt) = 0.0</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;      rho_it1(k,itt) = 0.0</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    <span class="keywordflow">do</span> k=1,gv%ke+1</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;      kprev_it1(k,itt) = 0.0 ; kappa_it1(k,itt) = 0.0 ; tke_it1(k,itt) = 0.0</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;      n2_it1(k,itt) = 0.0 ; sh2_it1(k,itt) = 0.0</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;      ksrc_it1(k,itt) = 0.0</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;      dkappa_it1(k,itt) = 0.0 ; wt_it1(k,itt) = 0.0</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;      k_q_it1(k,itt) = 0.0 ; d_dkappa_it1(k,itt) = 0.0</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;  <span class="keywordflow">do</span> k=1,gv%ke+1 ; ksrc_av(k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;  <span class="comment">! This call just calculates N2 and S2.</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;  <span class="keyword">call </span>calculate_projected_state(kappa, u, v, t, sal, 0.0, nzc, dz, i_dz_int, &amp;</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;                                 dbuoy_dt, dbuoy_ds, u, v, t, sal, gv, us, &amp;</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;                                 n2=n2, s2=s2, vel_underflow=cs%vel_underflow)</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="comment">! ----------------------------------------------------</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;<span class="comment">! Iterate</span></div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;<span class="comment">! ----------------------------------------------------</span></div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;  dt_rem = dt</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;  <span class="keywordflow">do</span> k=1,nzc+1</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;    k_q(k) = 0.0</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;    kappa_avg(k) = 0.0 ; tke_avg(k) = 0.0</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    local_src_avg(k) = 0.0</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;    <span class="comment">! Use the grid spacings to scale errors in the source.</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    <span class="keywordflow">if</span> ( dz_int(k) &gt; 0.0 ) &amp;</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;      local_src_avg(k) = 0.1 * k0dt * i_dz_int(k) / dz_int(k)</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;<span class="keywordflow">  enddo</span></div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160; </div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;<span class="comment">! call cpu_clock_end(id_clock_setup)</span></div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160; </div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;<span class="comment">! do itt=1,CS%max_RiNo_it</span></div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;  <span class="keywordflow">do</span> itt=1,cs%max_KS_it</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160; </div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;<span class="comment">! ----------------------------------------------------</span></div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;<span class="comment">! Calculate new values of u, v, rho, N^2 and S.</span></div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;<span class="comment">! ----------------------------------------------------</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">do</span> k=1,nzc+1</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;      ri_k(k) = 1e3 ; <span class="keywordflow">if</span> (s2(k) &gt; 1e-3*n2(k)) ri_k(k) = n2(k) / s2(k)</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;      <span class="keywordflow">if</span> (itt &gt; 1) <span class="keywordflow">then</span> ; tke_prev(k) = tke(k) ; <span class="keywordflow">else</span> ; tke_prev(k) = 0.0 ;<span class="keywordflow"> endif</span></div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;  <span class="comment">! call cpu_clock_begin(id_clock_KQ)</span></div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;    <span class="keyword">call </span>find_kappa_tke(n2, s2, kappa, idz, dz_int, i_l2_bdry, f2, &amp;</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;                        nzc, cs, gv, us, k_q, tke, kappa_out, kappa_src, local_src)</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;  <span class="comment">! call cpu_clock_end(id_clock_KQ)</span></div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160; </div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;  <span class="comment">! call cpu_clock_begin(id_clock_avg)</span></div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    <span class="comment">! Determine the range of non-zero values of kappa_out.</span></div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;    ks_kappa = gv%ke+1 ; ke_kappa = 0</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;    <span class="keywordflow">do</span> k=2,nzc ; <span class="keywordflow">if</span> (kappa_out(k) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;      ks_kappa = k ; <span class="keywordflow">exit</span></div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;    <span class="keywordflow">do</span> k=nzc,ks_kappa,-1 ; <span class="keywordflow">if</span> (kappa_out(k) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;      ke_kappa = k ; <span class="keywordflow">exit</span></div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;    <span class="keywordflow">if</span> (ke_kappa == nzc) kappa_out(nzc+1) = 0.0</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;  <span class="comment">! call cpu_clock_end(id_clock_avg)</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160; </div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;    <span class="comment">! Determine how long to use this value of kappa (dt_now).</span></div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160; </div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;  <span class="comment">! call cpu_clock_begin(id_clock_project)</span></div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;    <span class="keywordflow">if</span> ((ke_kappa &lt; ks_kappa) .or. (itt==cs%max_RiNo_it)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;      dt_now = dt_rem</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;      <span class="comment">! Limit dt_now so that |k_src(k)-kappa_src(k)| &lt; tol * local_src(k)</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;      dt_test = dt_rem</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;      <span class="keywordflow">do</span> k=2,nzc</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;        tol_max(k) = kappa_src(k) + tol_dksrc * local_src(k)</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;        tol_min(k) = kappa_src(k) - tol_dksrc_low * local_src(k)</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;        tol_chg(k) = tol2 * local_src_avg(k)</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160; </div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;      <span class="keywordflow">do</span> itt_dt=1,(cs%max_KS_it+1-itt)/2</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;        <span class="comment">!   The maximum number of times that the time-step is halved in</span></div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;        <span class="comment">! seeking an acceptable timestep is reduced with each iteration,</span></div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;        <span class="comment">! so that as the maximum number of iterations is approached, the</span></div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;        <span class="comment">! whole remaining timestep is used.  Typically, an acceptable</span></div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;        <span class="comment">! timestep is found long before the minimum is reached, so the</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;        <span class="comment">! value of max_KS_it may be unimportant, especially if it is large</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;        <span class="comment">! enough.</span></div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;        <span class="keyword">call </span>calculate_projected_state(kappa_out, u, v, t, sal, 0.5*dt_test, nzc, dz, i_dz_int, &amp;</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;                                       dbuoy_dt, dbuoy_ds, u_test, v_test, t_test, s_test, &amp;</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;                                       gv, us, n2, s2, ks_int=ks_kappa, ke_int=ke_kappa, &amp;</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;                                       vel_underflow=cs%vel_underflow)</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;        valid_dt = .true.</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;        idtt = 1.0 / dt_test</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;        <span class="keywordflow">do</span> k=max(ks_kappa-1,2),min(ke_kappa+1,nzc)</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;          <span class="keywordflow">if</span> (n2(k) &lt; ri_crit * s2(k)) <span class="keywordflow">then</span> <span class="comment">! Equivalent to Ri &lt; Ri_crit.</span></div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;            k_src(k) = (2.0 * cs%Shearmix_rate * sqrt(s2(k))) * &amp;</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;                       ((ri_crit*s2(k) - n2(k)) / (ri_crit*s2(k) + cs%FRi_curvature*n2(k)))</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;            <span class="keywordflow">if</span> ((k_src(k) &gt; max(tol_max(k), kappa_src(k) + idtt*tol_chg(k))) .or. &amp;</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;                (k_src(k) &lt; min(tol_min(k), kappa_src(k) - idtt*tol_chg(k)))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;              valid_dt = .false. ; <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;            <span class="keywordflow">if</span> (0.0 &lt; min(tol_min(k), kappa_src(k) - idtt*tol_chg(k))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;              valid_dt = .false. ; k_src(k) = 0.0 ; <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;<span class="keywordflow">          endif</span></div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160; </div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;        <span class="keywordflow">if</span> (valid_dt) <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;        dt_test = 0.5*dt_test</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;      <span class="keywordflow">if</span> ((dt_test &lt; dt_rem) .and. valid_dt) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;        dt_inc = 0.5*dt_test</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;        <span class="keywordflow">do</span> itt_dt=1,dt_refinements</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;          <span class="keyword">call </span>calculate_projected_state(kappa_out, u, v, t, sal, 0.5*(dt_test+dt_inc), &amp;</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;                   nzc, dz, i_dz_int, dbuoy_dt, dbuoy_ds, u_test, v_test, t_test, s_test, &amp;</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;                   gv, us, n2, s2, ks_int=ks_kappa, ke_int=ke_kappa, vel_underflow=cs%vel_underflow)</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;          valid_dt = .true.</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;          idtt = 1.0 / (dt_test+dt_inc)</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;          <span class="keywordflow">do</span> k=max(ks_kappa-1,2),min(ke_kappa+1,nzc)</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;            <span class="keywordflow">if</span> (n2(k) &lt; ri_crit * s2(k)) <span class="keywordflow">then</span> <span class="comment">! Equivalent to Ri &lt; Ri_crit.</span></div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;              k_src(k) = (2.0 * cs%Shearmix_rate * sqrt(s2(k))) * &amp;</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;                         ((ri_crit*s2(k) - n2(k)) / (ri_crit*s2(k) + cs%FRi_curvature*n2(k)))</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;              <span class="keywordflow">if</span> ((k_src(k) &gt; max(tol_max(k), kappa_src(k) + idtt*tol_chg(k))) .or. &amp;</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;                  (k_src(k) &lt; min(tol_min(k), kappa_src(k) - idtt*tol_chg(k)))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;                valid_dt = .false. ; <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;              <span class="keywordflow">if</span> (0.0 &lt; min(tol_min(k), kappa_src(k) - idtt*tol_chg(k))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;                valid_dt = .false. ; k_src(k) = 0.0 ; <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="keywordflow">              endif</span></div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;<span class="keywordflow">            endif</span></div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;<span class="keywordflow">          enddo</span></div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160; </div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;          <span class="keywordflow">if</span> (valid_dt) dt_test = dt_test + dt_inc</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;          dt_inc = 0.5*dt_inc</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;<span class="keywordflow">        enddo</span></div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;        dt_inc = 0.0</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160; </div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;      dt_now = min(dt_test*(1.0+cs%kappa_tol_err)+dt_inc, dt_rem)</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;      <span class="keywordflow">do</span> k=2,nzc</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;        local_src_avg(k) = local_src_avg(k) + dt_now * local_src(k)</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;<span class="keywordflow">    endif</span>  <span class="comment">! Are all the values of kappa_out 0?</span></div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;  <span class="comment">! call cpu_clock_end(id_clock_project)</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160; </div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;    <span class="comment">! The state has already been projected forward. Now find new values of kappa.</span></div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160; </div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;    <span class="keywordflow">if</span> (ke_kappa &lt; ks_kappa) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;      <span class="comment">! There is no mixing now, and will not be again.</span></div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;    <span class="comment">! call cpu_clock_begin(id_clock_avg)</span></div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;      dt_wt = dt_rem / dt ; dt_rem = 0.0</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;      <span class="keywordflow">do</span> k=1,nzc+1</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;        kappa_mid(k) = 0.0</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;        <span class="comment">! This would be here but does nothing.</span></div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;        <span class="comment">! kappa_avg(K) = kappa_avg(K) + kappa_mid(K)*dt_wt</span></div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;        tke_avg(k) = tke_avg(k) + dt_wt*tke(k)</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;<span class="preprocessor"></span>        tke_pred(k) = tke(k) ; kappa_pred(k) = 0.0 ; kappa(k) = 0.0</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="preprocessor"></span><span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;    <span class="comment">! call cpu_clock_end(id_clock_avg)</span></div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;    <span class="comment">! call cpu_clock_begin(id_clock_project)</span></div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;      <span class="keyword">call </span>calculate_projected_state(kappa_out, u, v, t, sal, dt_now, nzc, dz, i_dz_int, &amp;</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;                                     dbuoy_dt, dbuoy_ds, u_test, v_test, t_test, s_test, &amp;</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;                                     gv, us, n2=n2, s2=s2, ks_int=ks_kappa, ke_int=ke_kappa, &amp;</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;                                     vel_underflow=cs%vel_underflow)</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;    <span class="comment">! call cpu_clock_end(id_clock_project)</span></div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160; </div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    <span class="comment">! call cpu_clock_begin(id_clock_KQ)</span></div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;      <span class="keywordflow">do</span> k=1,nzc+1 ; k_q_tmp(k) = k_q(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;      <span class="keyword">call </span>find_kappa_tke(n2, s2, kappa_out, idz, dz_int, i_l2_bdry, f2, &amp;</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;                          nzc, cs, gv, us, k_q_tmp, tke_pred, kappa_pred)</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    <span class="comment">! call cpu_clock_end(id_clock_KQ)</span></div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160; </div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;      ks_kappa = gv%ke+1 ; ke_kappa = 0</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;      <span class="keywordflow">do</span> k=1,nzc+1</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;        kappa_mid(k) = 0.5*(kappa_out(k) + kappa_pred(k))</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;        <span class="keywordflow">if</span> ((kappa_mid(k) &gt; 0.0) .and. (k&lt;ks_kappa)) ks_kappa = k</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;        <span class="keywordflow">if</span> (kappa_mid(k) &gt; 0.0) ke_kappa = k</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160; </div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;    <span class="comment">! call cpu_clock_begin(id_clock_project)</span></div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;      <span class="keyword">call </span>calculate_projected_state(kappa_mid, u, v, t, sal, dt_now, nzc, dz, i_dz_int, &amp;</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;                                     dbuoy_dt, dbuoy_ds, u_test, v_test, t_test, s_test, &amp;</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;                                     gv, us, n2=n2, s2=s2, ks_int=ks_kappa, ke_int=ke_kappa, &amp;</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;                                     vel_underflow=cs%vel_underflow)</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;    <span class="comment">! call cpu_clock_end(id_clock_project)</span></div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160; </div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;    <span class="comment">! call cpu_clock_begin(id_clock_KQ)</span></div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;      <span class="keyword">call </span>find_kappa_tke(n2, s2, kappa_out, idz, dz_int, i_l2_bdry, f2, &amp;</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;                          nzc, cs, gv, us, k_q, tke_pred, kappa_pred)</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;    <span class="comment">! call cpu_clock_end(id_clock_KQ)</span></div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160; </div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;    <span class="comment">! call cpu_clock_begin(id_clock_avg)</span></div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;      dt_wt = dt_now / dt ; dt_rem = dt_rem - dt_now</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;      <span class="keywordflow">do</span> k=1,nzc+1</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;        kappa_mid(k) = 0.5*(kappa_out(k) + kappa_pred(k))</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;        kappa_avg(k) = kappa_avg(k) + kappa_mid(k)*dt_wt</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;        tke_avg(k) = tke_avg(k) + dt_wt*0.5*(tke_pred(k) + tke(k))</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        kappa(k) = kappa_pred(k) <span class="comment">! First guess for the next iteration.</span></div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;    <span class="comment">! call cpu_clock_end(id_clock_avg)</span></div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160; </div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;    <span class="keywordflow">if</span> (dt_rem &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;      <span class="comment">! Update the values of u, v, T, Sal, N2, and S2 for the next iteration.</span></div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    <span class="comment">! call cpu_clock_begin(id_clock_project)</span></div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;      <span class="keyword">call </span>calculate_projected_state(kappa_mid, u, v, t, sal, dt_now, nzc, &amp;</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;                                     dz, i_dz_int, dbuoy_dt, dbuoy_ds, u, v, t, sal, &amp;</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;                                     gv, us, n2, s2, vel_underflow=cs%vel_underflow)</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    <span class="comment">! call cpu_clock_end(id_clock_project)</span></div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160; </div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">if</span> (itt &lt;= max_debug_itt) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;      dt_it1(itt) = dt_now</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;      dk_wt_it1(itt) = 0.0 ; dkpos_wt_it1(itt) = 0.0 ;  dkneg_wt_it1(itt) = 0.0</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;      k_mag(itt) = 0.0</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;      wt_itt = 1.0/real(itt) ; wt_tot = 0.0</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;      <span class="keywordflow">do</span> k=1,nzc+1</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;        ksrc_av(k) = (1.0-wt_itt)*ksrc_av(k) + wt_itt*k_src(k)</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;        wt_tot = wt_tot + dz_int(k) * ksrc_av(k)</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;      <span class="comment">! Use the 1/0=0 convention.</span></div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;      i_wt_tot = 0.0 ; <span class="keywordflow">if</span> (wt_tot &gt; 0.0) i_wt_tot = 1.0/wt_tot</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160; </div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;      <span class="keywordflow">do</span> k=1,nzc+1</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;        wt(k) = (dz_int(k)*ksrc_av(k)) * i_wt_tot</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;        k_mag(itt) = k_mag(itt) + wt(k)*kappa_mid(k)</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;        dkappa_it1(k,itt) = kappa_pred(k) - kappa_out(k)</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;        dk_wt_it1(itt) = dk_wt_it1(itt) + wt(k)*dkappa_it1(k,itt)</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;        <span class="keywordflow">if</span> (dkappa_it1(k,itt) &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;          dkpos_wt_it1(itt) = dkpos_wt_it1(itt) + wt(k)*dkappa_it1(k,itt)</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;          dkneg_wt_it1(itt) = dkneg_wt_it1(itt) + wt(k)*dkappa_it1(k,itt)</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;        wt_it1(k,itt) = wt(k)</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;    <span class="keywordflow">do</span> k=1,nzc+1</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;      ri_k(k) = 1e3 ; <span class="keywordflow">if</span> (n2(k) &lt; 1e3 * s2(k)) ri_k(k) = n2(k) / s2(k)</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;      dtke(k) = tke_pred(k) - tke(k)</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;      dtke_norm(k) = dtke(k) / (0.5*(tke(k) + tke_pred(k)))</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;      dkappa(k) = kappa_pred(k) - kappa_out(k)</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;    <span class="keywordflow">if</span> (itt &lt;= max_debug_itt) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;      <span class="keywordflow">do</span> k=1,nzc</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;        u_it1(k,itt) = u(k) ; v_it1(k,itt) = v(k)</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;        t_it1(k,itt) = t(k) ; s_it1(k,itt) = sal(k)</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;      <span class="keywordflow">do</span> k=1,nzc+1</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;        kprev_it1(k,itt) = kappa_out(k)</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;        kappa_it1(k,itt) = kappa_mid(k) ; tke_it1(k,itt) = 0.5*(tke(k)+tke_pred(k))</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;        n2_it1(k,itt)=n2(k) ; sh2_it1(k,itt)=s2(k)</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;        ksrc_it1(k,itt) = kappa_src(k)</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;        k_q_it1(k,itt) = kappa_out(k) / (tke(k))</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;        <span class="keywordflow">if</span> (itt &gt; 1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;          <span class="keywordflow">if</span> (abs(dkappa_it1(k,itt-1)) &gt; 1e-20) &amp;</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;            d_dkappa_it1(k,itt) = dkappa_it1(k,itt) / dkappa_it1(k,itt-1)</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;<span class="keywordflow">        endif</span></div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;        dkappa_norm(k,itt) = dkappa(k) / max(0.5*(kappa_pred(k) + kappa_out(k)), us%m2_s_to_Z2_T*1e-100)</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;<span class="keywordflow">      enddo</span></div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;    <span class="keywordflow">if</span> (dt_rem &lt;= 0.0) <span class="keywordflow">exit</span></div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160; </div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! end itt loop</span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160; </div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span> (<span class="keyword">present</span>(i_ld2_1d)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;    <span class="keywordflow">do</span> k=1,gv%ke+1 ; i_ld2_1d(k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;    <span class="keywordflow">do</span> k=2,nzc ; <span class="keywordflow">if</span> (tke(k) &gt; 0.0) &amp;</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;      i_ld2_1d(k) = i_l2_bdry(k) + (n2(k) / cs%lambda**2 + f2) / tke(k)</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;<span class="keywordflow">    enddo</span></div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dz_int_1d)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;    <span class="keywordflow">do</span> k=1,nzc+1 ; dz_int_1d(k) = dz_int(k) ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    <span class="keywordflow">do</span> k=nzc+2,gv%ke ; dz_int_1d(k) = 0.0 ;<span class="keywordflow"> enddo</span></div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;<span class="preprocessor"></span> </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__kappa__shear_8F90_source.html#l01216">calculate_projected_state()</a>, and <a class="el" href="MOM__kappa__shear_8F90_source.html#l01354">find_kappa_tke()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__kappa__shear_8F90_source.html#l00364">calc_kappa_shear_vertex()</a>, and <a class="el" href="MOM__kappa__shear_8F90_source.html#l00101">calculate_kappa_shear()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__kappa__shear_a26cc5bb15545f04cfaf07e53410e09ec_cgraph.svg" width="426" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__kappa__shear_a26cc5bb15545f04cfaf07e53410e09ec_icgraph.svg" width="612" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a82428168ba463cf7276ae96d3e32475c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a82428168ba463cf7276ae96d3e32475c">&#9670;&nbsp;</a></span>kappa_shear_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">logical function, public mom_kappa_shear::kappa_shear_init </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(unit_scale_type), intent(in)&#160;</td>
          <td class="paramname"><em>US</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(inout), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__kappa__shear_1_1kappa__shear__cs.html">kappa_shear_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutineinitializesthe parameters that regulate shear-driven mixing. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>The current model time. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">us</td><td>A dimensional unit scaling type </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>A structure to parse for run-time parameters. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">diag</td><td>A structure that is used to regulate diagnostic output. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>A pointer that is set to point to the control structure for this module </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>True if module is to be used, False otherwise </dd></dl>

<p class="definition">Definition at line <a class="el" href="MOM__kappa__shear_8F90_source.html#l01943">1943</a> of file <a class="el" href="MOM__kappa__shear_8F90_source.html">MOM_kappa_shear.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;  <span class="keywordtype">type</span>(time_type),         <span class="keywordtype">intent(in)</span>    :: Time<span class="comment"> !&lt; The current model time.</span></div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: G<span class="comment">    !&lt; The ocean&#39;s grid structure.</span></div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;  <span class="keywordtype">type</span>(verticalGrid_type), <span class="keywordtype">intent(in)</span>    :: GV<span class="comment">   !&lt; The ocean&#39;s vertical grid structure.</span></div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;  <span class="keywordtype">type</span>(unit_scale_type),   <span class="keywordtype">intent(in)</span>    :: US<span class="comment">   !&lt; A dimensional unit scaling type</span></div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;  <span class="keywordtype">type</span>(param_file_type),   <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; A structure to parse for run-time</span></div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;<span class="comment">                                                 !! parameters.</span></div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>, <span class="keywordtype">intent(inout)</span> :: diag<span class="comment"> !&lt; A structure that is used to regulate diagnostic</span></div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;<span class="comment">                                                 !! output.</span></div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;  <span class="keywordtype">type</span>(Kappa_shear_CS),    <span class="keywordtype">pointer</span>       :: CS<span class="comment">   !&lt; A pointer that is set to point to the control</span></div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;<span class="comment">                                                 !! structure for this module</span></div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;  <span class="keywordtype">logical</span> :: kappa_shear_init<span class="comment"> !&lt; True if module is to be used, False otherwise</span></div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160; </div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;  <span class="comment">! Local variables</span></div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;  <span class="keywordtype">logical</span> :: merge_mixedlayer</div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;<span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_kappa_shear&quot;</span>  <span class="comment">! This module&#39;s name.</span></div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;<span class="keywordtype">  real</span> :: kappa_0_unscaled  <span class="comment">! The value of kappa_0 in MKS units [m2 s-1]</span></div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;<span class="keywordtype">  real</span> :: KD_normal <span class="comment">! The KD of the main model, read here only as a parameter</span></div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;                    <span class="comment">! for setting the default of KD_SMOOTH in MKS units [m2 s-1]</span></div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160; </div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;kappa_shear_init called with an associated &quot;</span>// &amp;</div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;                            <span class="stringliteral">&quot;control structure.&quot;</span>)</div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;    <span class="keywordflow">return</span></div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;  <span class="keyword">allocate</span>(cs)</div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160; </div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;  <span class="comment">!   The Jackson-Hallberg-Legg shear mixing parameterization uses the following</span></div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;  <span class="comment">! 6 nondimensional coefficients.  That paper gives 3 best fit parameter sets.</span></div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;  <span class="comment">!    Ri_Crit  Rate    FRi_Curv  K_buoy  TKE_N  TKE_Shear</span></div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;  <span class="comment">! p1: 0.25    0.089    -0.97     0.82    0.24    0.14</span></div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;  <span class="comment">! p2: 0.30    0.085    -0.94     0.86    0.26    0.13</span></div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;  <span class="comment">! p3: 0.35    0.088    -0.89     0.81    0.28    0.12</span></div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;  <span class="comment">!   Future research will reveal how these should be modified to take</span></div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;  <span class="comment">! subgridscale inhomogeneity into account.</span></div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160; </div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;<span class="comment">! Set default, read and log parameters</span></div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, &amp;</div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;    <span class="stringliteral">&quot;Parameterization of shear-driven turbulence following Jackson, Hallberg and Legg, JPO 2008&quot;</span>)</div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_JACKSON_PARAM&quot;</span>, kappa_shear_init, &amp;</div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;                 <span class="stringliteral">&quot;If true, use the Jackson-Hallberg-Legg (JPO 2008) &quot;</span>//&amp;</div>
<div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;                 <span class="stringliteral">&quot;shear mixing parameterization.&quot;</span>, default=.false.)</div>
<div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;VERTEX_SHEAR&quot;</span>, cs%KS_at_vertex, &amp;</div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;                 <span class="stringliteral">&quot;If true, do the calculations of the shear-driven mixing &quot;</span>//&amp;</div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;                 <span class="stringliteral">&quot;at the cell vertices (i.e., the vorticity points).&quot;</span>, &amp;</div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;                 default=.false.)</div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RINO_CRIT&quot;</span>, cs%RiNo_crit, &amp;</div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;                 <span class="stringliteral">&quot;The critical Richardson number for shear mixing.&quot;</span>, &amp;</div>
<div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.25)</div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SHEARMIX_RATE&quot;</span>, cs%Shearmix_rate, &amp;</div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;                 <span class="stringliteral">&quot;A nondimensional rate scale for shear-driven entrainment. &quot;</span>//&amp;</div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;                 <span class="stringliteral">&quot;Jackson et al find values in the range of 0.085-0.089.&quot;</span>, &amp;</div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.089)</div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MAX_RINO_IT&quot;</span>, cs%max_RiNo_it, &amp;</div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;                 <span class="stringliteral">&quot;The maximum number of iterations that may be used to &quot;</span>//&amp;</div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;                 <span class="stringliteral">&quot;estimate the Richardson number driven mixing.&quot;</span>, &amp;</div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=50)</div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KD&quot;</span>, kd_normal, default=1.0e-7, do_not_log=.true.)</div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KD_KAPPA_SHEAR_0&quot;</span>, cs%kappa_0, &amp;</div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;                 <span class="stringliteral">&quot;The background diffusivity that is used to smooth the &quot;</span>//&amp;</div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;                 <span class="stringliteral">&quot;density and shear profiles before solving for the &quot;</span>//&amp;</div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;                 <span class="stringliteral">&quot;diffusivities. Defaults to value of KD.&quot;</span>, &amp;</div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=kd_normal, scale=us%m2_s_to_Z2_T, unscaled=kappa_0_unscaled)</div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KD_TRUNC_KAPPA_SHEAR&quot;</span>, cs%kappa_trunc, &amp;</div>
<div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;                 <span class="stringliteral">&quot;The value of shear-driven diffusivity that is considered negligible &quot;</span>//&amp;</div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;                 <span class="stringliteral">&quot;and is rounded down to 0. The default is 1% of KD_KAPPA_SHEAR_0.&quot;</span>, &amp;</div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=0.01*kappa_0_unscaled, scale=us%m2_s_to_Z2_T)</div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;FRI_CURVATURE&quot;</span>, cs%FRi_curvature, &amp;</div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;                 <span class="stringliteral">&quot;The nondimensional curvature of the function of the &quot;</span>//&amp;</div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;                 <span class="stringliteral">&quot;Richardson number in the kappa source term in the &quot;</span>//&amp;</div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;                 <span class="stringliteral">&quot;Jackson et al. scheme.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=-0.97)</div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TKE_N_DECAY_CONST&quot;</span>, cs%C_N, &amp;</div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;                 <span class="stringliteral">&quot;The coefficient for the decay of TKE due to &quot;</span>//&amp;</div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;                 <span class="stringliteral">&quot;stratification (i.e. proportional to N*tke). &quot;</span>//&amp;</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;                 <span class="stringliteral">&quot;The values found by Jackson et al. are 0.24-0.28.&quot;</span>, &amp;</div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.24)</div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;<span class="comment">!  call get_param(param_file, mdl, &quot;LAYER_KAPPA_STAGGER&quot;, CS%layer_stagger, &amp;</span></div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;<span class="comment">!                 default=.false.)</span></div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TKE_SHEAR_DECAY_CONST&quot;</span>, cs%C_S, &amp;</div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;                 <span class="stringliteral">&quot;The coefficient for the decay of TKE due to shear (i.e. &quot;</span>//&amp;</div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;                 <span class="stringliteral">&quot;proportional to |S|*tke). The values found by Jackson &quot;</span>//&amp;</div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;                 <span class="stringliteral">&quot;et al. are 0.14-0.12.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.14)</div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KAPPA_BUOY_SCALE_COEF&quot;</span>, cs%lambda, &amp;</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;                 <span class="stringliteral">&quot;The coefficient for the buoyancy length scale in the &quot;</span>//&amp;</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;                 <span class="stringliteral">&quot;kappa equation.  The values found by Jackson et al. are &quot;</span>//&amp;</div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;                 <span class="stringliteral">&quot;in the range of 0.81-0.86.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.82)</div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KAPPA_N_OVER_S_SCALE_COEF2&quot;</span>, cs%lambda2_N_S, &amp;</div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;                 <span class="stringliteral">&quot;The square of the ratio of the coefficients of the &quot;</span>//&amp;</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;                 <span class="stringliteral">&quot;buoyancy and shear scales in the diffusivity equation, &quot;</span>//&amp;</div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;                 <span class="stringliteral">&quot;Set this to 0 (the default) to eliminate the shear scale. &quot;</span>//&amp;</div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;                 <span class="stringliteral">&quot;This is only used if USE_JACKSON_PARAM is true.&quot;</span>, &amp;</div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KAPPA_SHEAR_TOL_ERR&quot;</span>, cs%kappa_tol_err, &amp;</div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;                 <span class="stringliteral">&quot;The fractional error in kappa that is tolerated. &quot;</span>//&amp;</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;                 <span class="stringliteral">&quot;Iteration stops when changes between subsequent &quot;</span>//&amp;</div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;                 <span class="stringliteral">&quot;iterations are smaller than this everywhere in a &quot;</span>//&amp;</div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;                 <span class="stringliteral">&quot;column.  The peak diffusivities usually converge most &quot;</span>//&amp;</div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;                 <span class="stringliteral">&quot;rapidly, and have much smaller errors than this.&quot;</span>, &amp;</div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.1)</div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TKE_BACKGROUND&quot;</span>, cs%TKE_bg, &amp;</div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;                 <span class="stringliteral">&quot;A background level of TKE used in the first iteration &quot;</span>//&amp;</div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;                 <span class="stringliteral">&quot;of the kappa equation.  TKE_BACKGROUND could be 0.&quot;</span>, &amp;</div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-2&quot;</span>, default=0.0, scale=us%m_to_Z**2*us%T_to_s**2)</div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KAPPA_SHEAR_ELIM_MASSLESS&quot;</span>, cs%eliminate_massless, &amp;</div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;                 <span class="stringliteral">&quot;If true, massless layers are merged with neighboring &quot;</span>//&amp;</div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;                 <span class="stringliteral">&quot;massive layers in this calculation.  The default is &quot;</span>//&amp;</div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;                 <span class="stringliteral">&quot;true and I can think of no good reason why it should &quot;</span>//&amp;</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;                 <span class="stringliteral">&quot;be false. This is only used if USE_JACKSON_PARAM is true.&quot;</span>, &amp;</div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;                 default=.true.)</div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MAX_KAPPA_SHEAR_IT&quot;</span>, cs%max_KS_it, &amp;</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;                 <span class="stringliteral">&quot;The maximum number of iterations that may be used to &quot;</span>//&amp;</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;                 <span class="stringliteral">&quot;estimate the time-averaged diffusivity.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, &amp;</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;                 default=13)</div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;PRANDTL_TURB&quot;</span>, cs%Prandtl_turb, &amp;</div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;                 <span class="stringliteral">&quot;The turbulent Prandtl number applied to shear &quot;</span>//&amp;</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;                 <span class="stringliteral">&quot;instability.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0, do_not_log=.true.)</div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;VEL_UNDERFLOW&quot;</span>, cs%vel_underflow, &amp;</div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;                 <span class="stringliteral">&quot;A negligibly small velocity magnitude below which velocity &quot;</span>//&amp;</div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;                 <span class="stringliteral">&quot;components are set to 0.  A reasonable value might be &quot;</span>//&amp;</div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;                 <span class="stringliteral">&quot;1e-30 m/s, which is less than an Angstrom divided by &quot;</span>//&amp;</div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;                 <span class="stringliteral">&quot;the age of the universe.&quot;</span>, units=<span class="stringliteral">&quot;m s-1&quot;</span>, default=0.0, scale=us%m_s_to_L_T)</div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160; </div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DEBUG_KAPPA_SHEAR&quot;</span>, cs%debug, &amp;</div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;                 <span class="stringliteral">&quot;If true, write debugging data for the kappa-shear code. \n&quot;</span>//&amp;</div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;                 <span class="stringliteral">&quot;Caution: this option is _very_ verbose and should only &quot;</span>//&amp;</div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;                 <span class="stringliteral">&quot;be used in single-column mode!&quot;</span>, &amp;</div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;                 default=.false., debuggingparam=.true.)</div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KAPPA_SHEAR_ITER_BUG&quot;</span>, cs%dKdQ_iteration_bug, &amp;</div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;                 <span class="stringliteral">&quot;If true. use an older, dimensionally inconsistent estimate of the &quot;</span>//&amp;</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;                 <span class="stringliteral">&quot;derivative of diffusivity with energy in the Newton&#39;s method iteration.  &quot;</span>//&amp;</div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;                 <span class="stringliteral">&quot;The bug causes undercorrections when dz &gt; 1m.&quot;</span>, default=.true.)</div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;<span class="comment">!    id_clock_KQ = cpu_clock_id(&#39;Ocean KS kappa_shear&#39;, grain=CLOCK_ROUTINE)</span></div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;<span class="comment">!    id_clock_avg = cpu_clock_id(&#39;Ocean KS avg&#39;, grain=CLOCK_ROUTINE)</span></div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;<span class="comment">!    id_clock_project = cpu_clock_id(&#39;Ocean KS project&#39;, grain=CLOCK_ROUTINE)</span></div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;<span class="comment">!    id_clock_setup = cpu_clock_id(&#39;Ocean KS setup&#39;, grain=CLOCK_ROUTINE)</span></div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160; </div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;  cs%nkml = 1</div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;  <span class="keywordflow">if</span> (gv%nkml&gt;0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KAPPA_SHEAR_MERGE_ML&quot;</span>,merge_mixedlayer, &amp;</div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;                 <span class="stringliteral">&quot;If true, combine the mixed layers together before &quot;</span>//&amp;</div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;                 <span class="stringliteral">&quot;solving the kappa-shear equations.&quot;</span>, default=.true.)</div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;    <span class="keywordflow">if</span> (merge_mixedlayer) cs%nkml = gv%nkml</div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;<span class="keywordflow">  endif</span></div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160; </div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;<span class="comment">! Forego remainder of initialization if not using this scheme</span></div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;  <span class="keywordflow">if</span> (.not. kappa_shear_init) <span class="keywordflow">return</span></div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160; </div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;  cs%diag =&gt; diag</div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160; </div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;  cs%id_Kd_shear = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_shear&#39;</span>,diag%axesTi,time, &amp;</div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;      <span class="stringliteral">&#39;Shear-driven Diapycnal Diffusivity&#39;</span>, <span class="stringliteral">&#39;m2 s-1&#39;</span>, conversion=us%Z2_T_to_m2_s)</div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;  cs%id_TKE = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;TKE_shear&#39;</span>,diag%axesTi,time, &amp;</div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;      <span class="stringliteral">&#39;Shear-driven Turbulent Kinetic Energy&#39;</span>, <span class="stringliteral">&#39;m2 s-2&#39;</span>, conversion=us%Z_to_m**2*us%s_to_T**2)</div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;<span class="preprocessor">#ifdef ADD_DIAGNOSTICS</span></div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;<span class="preprocessor"></span>  cs%id_ILd2 = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;ILd2_shear&#39;</span>,diag%axesTi,time, &amp;</div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;      <span class="stringliteral">&#39;Inverse kappa decay scale at interfaces&#39;</span>, <span class="stringliteral">&#39;m-2&#39;</span>, conversion=us%m_to_Z**2)</div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;  cs%id_dz_Int = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;dz_Int_shear&#39;</span>,diag%axesTi,time, &amp;</div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;      <span class="stringliteral">&#39;Finite volume thickness of interfaces&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>, conversion=us%Z_to_m)</div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;<span class="preprocessor"></span> </div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__kappa__shear_a82428168ba463cf7276ae96d3e32475c_cgraph.svg" width="564" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="ac7859c609e462000ca8fd763d68d141e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac7859c609e462000ca8fd763d68d141e">&#9670;&nbsp;</a></span>kappa_shear_is_used()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">logical function, public mom_kappa_shear::kappa_shear_is_used </td>
          <td>(</td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function indicates to other modules whether the Jackson et al shear mixing parameterization will be used without needing to duplicate the log entry. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>A structure to parse for run-time parameters </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__kappa__shear_8F90_source.html#l02109">2109</a> of file <a class="el" href="MOM__kappa__shear_8F90_source.html">MOM_kappa_shear.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;  <span class="keywordtype">type</span>(param_file_type), <span class="keywordtype">intent(in)</span> :: param_file<span class="comment"> !&lt; A structure to parse for run-time parameters</span></div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;<span class="comment">! Reads the parameter &quot;USE_JACKSON_PARAM&quot; and returns state.</span></div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_kappa_shear&quot;</span>  <span class="comment">! This module&#39;s name.</span></div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160; </div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_JACKSON_PARAM&quot;</span>, kappa_shear_is_used, &amp;</div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;                 default=.false., do_not_log=.true.)</div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="MOM__CVMix__shear_8F90_source.html#l00193">mom_cvmix_shear::cvmix_shear_init()</a>, <a class="el" href="MOM__diabatic__driver_8F90_source.html#l03187">mom_diabatic_driver::diabatic_driver_init()</a>, <a class="el" href="MOM__set__viscosity_8F90_source.html#l01782">mom_set_visc::set_visc_init()</a>, and <a class="el" href="MOM__set__viscosity_8F90_source.html#l01696">mom_set_visc::set_visc_register_restarts()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__kappa__shear_ac7859c609e462000ca8fd763d68d141e_icgraph.svg" width="100%" height="476"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__kappa__shear.html">mom_kappa_shear</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
